# 第5阶段：AI服务gRPC对接优化 - 实施计划

> **创建日期**: 2026-02-27
> **状态**: 待执行
> **预计总时长**: 20小时 (1周)

---

## 任务概述

优化AI服务gRPC对接，统一客户端调用，完善错误处理和监控。

> **说明**: 大部分AI功能由FastAPI AI服务(Qingyu-Ai-Service)实现，后端仅通过gRPC对接调用。

---

## 当前状态分析

### 现有gRPC客户端

```
service/ai/
├── grpc_client.go      # 通用AI服务gRPC客户端 (GRPCClient)
├── phase3_client.go    # Phase3创作服务gRPC客户端 (Phase3Client)
└── ai_service.go       # AI服务主入口
```

### 客户端功能对比

| 客户端 | 功能 | 状态 |
|--------|------|------|
| GRPCClient | ExecuteAgent, ExecuteAgentWithRetry, HealthCheck | 使用中 |
| Phase3Client | GenerateOutline, GenerateCharacters, GeneratePlot, ExecuteCreativeWorkflow | 使用中 |

### 发现的问题

1. **客户端分散** - 有两个独立的gRPC客户端，可以合并
2. **错误处理不一致** - 两个客户端的错误处理方式不同
3. **缺少统一监控** - 没有统一的调用统计和性能监控
4. **文档不完整** - gRPC对接文档缺失

---

## Part 1: 统一gRPC客户端 (6小时)

### Task 1.1: 创建统一客户端结构 (2小时)

**目标**: 合并gRPC客户端，提供统一接口

**具体要求**:
1. 创建 `service/ai/unified_client.go`
2. 整合 GRPCClient 和 Phase3Client 的功能
3. 保留原有方法以保证向后兼容
4. 添加统一的方法前缀区分不同服务

**检查点**:
- [ ] 统一客户端创建完成
- [ ] 所有原有功能保留
- [ ] 向后兼容

**预计时间**: 2小时

---

### Task 1.2: 统一错误处理 (2小时)

**目标**: 创建统一的gRPC错误处理

**具体要求**:
1. 创建 `service/ai/grpc_errors.go`
2. 定义gRPC专用错误类型
3. 统一错误转换逻辑
4. 添加错误码映射

**检查点**:
- [ ] 错误处理统一完成
- [ ] 错误信息清晰
- [ ] 错误码完整

**预计时间**: 2小时

---

### Task 1.3: 更新API层引用 (2小时)

**目标**: 更新API层使用统一客户端

**具体要求**:
1. 更新 creative_api.go
2. 检查其他使用Phase3Client的地方
3. 确保所有引用正确
4. 更新依赖注入

**检查点**:
- [ ] 所有API更新完成
- [ ] 编译无错误
- [ ] 测试通过

**预计时间**: 2小时

---

## Part 2: 添加监控与日志 (6小时)

### Task 2.1: 添加调用统计 (2小时)

**目标**: 记录gRPC调用统计

**具体要求**:
1. 创建 `service/ai/grpc_metrics.go`
2. 记录调用次数、成功率、失败率
3. 按服务类型(ExecuteAgent, GenerateOutline等)分组
4. 按模型分组统计

**检查点**:
- [ ] 调用统计功能完成
- [ ] 统计数据可查询

**预计时间**: 2小时

---

### Task 2.2: 添加性能监控 (2小时)

**目标**: 监控gRPC调用性能

**具体要求**:
1. 记录每个请求的响应时间
2. 记录超时次数
3. 记录重试次数
4. 生成性能报告

**检查点**:
- [ ] 性能监控功能完成
- [ ] 性能指标可查询

**预计时间**: 2小时

---

### Task 2.3: 添加请求追踪 (2小时)

**目标**: 添加请求链路追踪

**具体要求**:
1. 为每个请求生成唯一trace_id
2. 记录请求完整生命周期
3. 支持按trace_id查询请求详情
4. 添加请求日志

**检查点**:
- [ ] 请求追踪功能完成
- [ ] 日志清晰可查

**预计时间**: 2小时

---

## Part 3: 配额集成优化 (4小时)

### Task 3.1: 检查配额扣除流程 (1小时)

**目标**: 确认gRPC调用后的配额扣除

**具体要求**:
1. 检查当前配额扣除逻辑
2. 确认token统计正确
3. 验证配额服务集成

**检查点**:
- [ ] 配额流程确认完成
- [ ] 问题记录清晰

**预计时间**: 1小时

---

### Task 3.2: 优化配额扣除 (2小时)

**目标**: 统一配额扣除逻辑

**具体要求**:
1. 在统一客户端中集成配额扣除
2. 自动从响应中获取token使用量
3. 调用配额服务进行扣除
4. 记录配额消费日志

**检查点**:
- [ ] 配额扣除自动化完成
- [ ] 测试通过

**预计时间**: 2小时

---

### Task 3.3: 添加配额监控 (1小时)

**目标**: 监控配额使用情况

**具体要求**:
1. 记录每次调用的配额消耗
2. 统计按服务/模型的配额使用
3. 生成配额使用报告

**检查点**:
- [ ] 配额监控完成
- [ ] 报告可生成

**预计时间**: 1小时

---

## Part 4: 文档更新 (2小时)

### Task 4.1: 创建gRPC对接文档 (1小时)

**目标**: 完整的gRPC对接文档

**具体要求**:
1. 创建 `docs/architecture/ai_grpc_integration.md`
2. 记录所有gRPC接口
3. 添加请求/响应示例
4. 添加错误处理说明

**检查点**:
- [ ] 文档完整
- [ ] 示例可用

**预计时间**: 1小时

---

### Task 4.2: 更新架构文档 (1小时)

**目标**: 更新AI模块架构图

**具体要求**:
1. 更新 `architecture/api_architecture.md` AI部分
2. 添加gRPC调用流程图
3. 添加监控架构图

**检查点**:
- [ ] 架构文档更新完成
- [ ] 流程图清晰

**预计时间**: 1小时

---

## Part 5: 测试验证 (2小时)

### Task 5.1: 运行gRPC集成测试 (1小时)

**目标**: 验证gRPC对接正常

**具体要求**:
1. 运行AI模块测试
2. 验证gRPC连接
3. 验证健康检查
4. 修复发现的问题

**检查点**:
- [ ] 所有测试通过
- [ ] gRPC连接正常

**预计时间**: 1小时

---

### Task 5.2: 性能测试 (1小时)

**目标**: 验证gRPC调用性能

**具体要求**:
1. 运行性能基准测试
2. 测试并发调用
3. 验证超时处理
4. 验证重试机制

**检查点**:
- [ ] 性能测试完成
- [ ] 性能符合预期

**预计时间**: 1小时

---

## 执行顺序

```
Part 1: 统一gRPC客户端 (6h)
  ├─ Task 1.1: 创建统一客户端结构 (2h)
  ├─ Task 1.2: 统一错误处理 (2h)
  └─ Task 1.3: 更新API层引用 (2h)
  ↓
Part 2: 添加监控与日志 (6h)
  ├─ Task 2.1: 调用统计 (2h)
  ├─ Task 2.2: 性能监控 (2h)
  └─ Task 2.3: 请求追踪 (2h)
  ↓
Part 3: 配额集成优化 (4h)
  ├─ Task 3.1: 检查配额扣除流程 (1h)
  ├─ Task 3.2: 优化配额扣除 (2h)
  └─ Task 3.3: 添加配额监控 (1h)
  ↓
Part 4: 文档更新 (2h)
  ├─ Task 4.1: 创建gRPC对接文档 (1h)
  └─ Task 4.2: 更新架构文档 (1h)
  ↓
Part 5: 测试验证 (2h)
  ├─ Task 5.1: 运行gRPC集成测试 (1h)
  └─ Task 5.2: 性能测试 (1h)
```

---

## 完成标准

### Part 1 完成标准
- [ ] 统一gRPC客户端创建完成
- [ ] 错误处理统一
- [ ] API层更新完成

### Part 2 完成标准
- [ ] 调用统计功能完成
- [ ] 性能监控完成
- [ ] 请求追踪完成

### Part 3 完成标准
- [ ] 配额扣除自动化
- [ ] 配额监控完成

### Part 4 完成标准
- [ ] gRPC对接文档完成
- [ ] 架构文档更新完成

### Part 5 完成标准
- [ ] 集成测试通过
- [ ] 性能测试通过

---

## 参考资料

- [API重构总计划](./api_refactor_plan.md)
- [gRPC协议文档](../../pkg/grpc/pb/ai_service.proto)
- [AI服务文档](../../Qingyu-Ai-Service/README.md)

---

**文档状态**: ✅ 计划完成
**下一步**: 创建worktree并派遣女仆执行
