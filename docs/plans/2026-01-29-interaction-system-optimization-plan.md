# å†…å®¹äº’åŠ¨ç³»ç»Ÿä¼˜åŒ–æ–¹æ¡ˆ

**æ–‡æ¡£æ—¥æœŸ**: 2026-01-29
**é¡¹ç›®**: Qingyuå†…å®¹äº’åŠ¨ç³»ç»Ÿä¼˜åŒ–
**æ–¹æ³•è®º**: æ¸è¿›å¼ä¼˜åŒ– + APIè§„èŒƒç»Ÿä¸€
**çŠ¶æ€**: è®¾è®¡é˜¶æ®µ

---

## æ‰§è¡Œæ‘˜è¦

æœ¬æ–¹æ¡ˆæ—¨åœ¨ä¼˜åŒ–Qingyuåç«¯çš„å†…å®¹äº’åŠ¨ç³»ç»Ÿï¼Œé€šè¿‡APIè§„èŒƒç»Ÿä¸€å’Œè¯„åˆ†ç³»ç»Ÿæ•´åˆï¼Œæå‡ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§

**æ ¸å¿ƒç›®æ ‡**ï¼š
- âœ… ç»Ÿä¸€æ‰€æœ‰äº’åŠ¨APIç¬¦åˆBlock 7è§„èŒƒ
- âœ… å»ºç«‹ç»Ÿä¸€çš„è¯„åˆ†æœåŠ¡
- â¸ï¸ æ®µè½è¯„è®ºåŠŸèƒ½ï¼ˆå·²æç½®ï¼Œå› ç« èŠ‚contentæ•°æ®æ¨¡å‹æœªå®ç°åˆ†æ®µï¼‰

---

## ç°çŠ¶è¯„ä¼°

### å·²å­˜åœ¨çš„äº’åŠ¨åŠŸèƒ½

#### âœ… è¯„è®ºç³»ç»Ÿï¼ˆéå¸¸å®Œå–„ï¼‰
- **Socialè¯„è®º** (`models/social/comment.go`)
  - æ”¯æŒä¹¦ç±è¯„è®ºã€ç« èŠ‚è¯„è®ºã€æ–‡ç« è¯„è®ºã€å…¬å‘Šè¯„è®ºã€é¡¹ç›®è¯„è®º
  - æ”¯æŒåµŒå¥—å›å¤ï¼ˆthreadedç»“æ„ï¼Œæœ‰parent_idå’Œroot_idï¼‰
  - æ”¯æŒè¯„åˆ†ï¼ˆ0-5æ˜Ÿï¼‰
  - æ”¯æŒç½®é¡¶ã€ç²¾é€‰ã€ä½œè€…å›å¤æ ‡è®°
  - è¯„è®ºçŠ¶æ€ç®¡ç†ï¼ˆnormal/hidden/deleted/rejectedï¼‰
  - ç”¨æˆ·å¿«ç…§ï¼ˆé¿å…è”è¡¨æŸ¥è¯¢ï¼‰

- **Readerç« èŠ‚è¯„è®º** (`models/reader/chapter_comment.go`)
  - æ”¯æŒåµŒå¥—å›å¤ï¼ˆparent_id, root_idï¼‰
  - æ”¯æŒè¯„åˆ†

#### âœ… ç‚¹èµåŠŸèƒ½
- `models/social/like.go`
- `api/v1/social/like_api.go`
- `service/social/like_service.go`
- æ”¯æŒå¯¹ä¹¦ç±ã€è¯„è®ºã€ç« èŠ‚ç‚¹èµ

#### âœ… æ”¶è—åŠŸèƒ½
- `models/social/collection.go`
- `api/v1/social/collection_api.go`
- `service/social/collection_service.go`
- æ”¯æŒæ”¶è—å¤¹ï¼ˆCollectionFolderï¼‰
- æ”¯æŒæ ‡ç­¾ã€å¤‡æ³¨ã€å…¬å¼€/ç§å¯†è®¾ç½®

#### âœ… ä¹¦è¯„åŠŸèƒ½
- `models/social/review.go`
- `api/v1/social/review_api.go`
- `service/social/review_service.go`
- æ”¯æŒé•¿è¯„ã€æ ‡é¢˜ã€è¯„åˆ†ã€å‰§é€æ ‡è®°
- æ”¯æŒå¯¹ä¹¦è¯„ç‚¹èµ

#### âœ… å…³æ³¨åŠŸèƒ½
- `models/social/follow.go`
- `api/v1/social/follow_api.go`
- `service/social/follow_service.go`

### âš ï¸ éœ€è¦ä¼˜åŒ–çš„åœ°æ–¹

#### 1. APIè§„èŒƒä¸ç»Ÿä¸€
- éƒ¨åˆ†APIè¿˜åœ¨ç”¨æ—§çš„å“åº”æ–¹å¼ï¼ˆå¦‚`shared.Success`è€Œé`response.Success`ï¼‰
- é”™è¯¯ç æœªç»Ÿä¸€ä½¿ç”¨4ä½ä¸šåŠ¡é”™è¯¯ç 

#### 2. è¯„åˆ†ç³»ç»Ÿåˆ†æ•£
- è¯„è®ºè¯„åˆ†ï¼š`models/social/comment.go`ä¸­çš„`Rating`å­—æ®µ
- ä¹¦ç±è¯„åˆ†ï¼š`models/bookstore/book_rating.go`
- ä¹¦è¯„è¯„åˆ†ï¼š`models/social/review.go`ä¸­çš„`Rating`å­—æ®µ
- ç« èŠ‚è¯„è®ºè¯„åˆ†ï¼š`models/reader/chapter_comment.go`ä¸­çš„`Rating`å­—æ®µ

**é—®é¢˜**ï¼š
- è¯„åˆ†é€»è¾‘åˆ†æ•£åœ¨å¤šä¸ªæ¨¡å—
- æ²¡æœ‰ç»Ÿä¸€çš„è¯„åˆ†è®¡ç®—è§„åˆ™ï¼ˆå¹³å‡åˆ†ã€åŠ æƒè¯„åˆ†ç­‰ï¼‰
- ç¼ºå°‘è¯„åˆ†ç»Ÿè®¡å’Œæ±‡æ€»åŠŸèƒ½
- æ— æ³•è¿½è¸ªç”¨æˆ·çš„è¯„åˆ†å†å²

#### 3. æ®µè½è¯„è®ºåŠŸèƒ½ï¼ˆå·²æç½®ï¼‰
- APIæ¥å£å·²å®šä¹‰ä½†æœªè¿æ¥Serviceå±‚
- **æç½®åŸå› **ï¼šç« èŠ‚contentæ•°æ®æ¨¡å‹æœªå®ç°åˆ†æ®µåŠŸèƒ½
- æ— æ³•å‡†ç¡®å®šä½å’Œå…³è”æ®µè½è¯„è®º

---

## å®æ–½æ–¹æ¡ˆï¼šæ–¹æ¡ˆA - åˆ†æ­¥æ¸è¿›

### å®æ–½é¡ºåº
1. **é˜¶æ®µ1**ï¼šç»Ÿä¸€æ‰€æœ‰äº’åŠ¨APIä½¿ç”¨Block 7è§„èŒƒï¼ˆ1-2å¤©ï¼‰
2. **é˜¶æ®µ2**ï¼šå»ºç«‹ç»Ÿä¸€çš„è¯„åˆ†æœåŠ¡ï¼ˆ2-3å¤©ï¼‰

### æ€»å·¥æœŸï¼šçº¦3-5å¤©

---

## é˜¶æ®µ1ï¼šAPIè§„èŒƒç»Ÿä¸€

### ç›®æ ‡
ç¡®ä¿æ‰€æœ‰äº’åŠ¨ç³»ç»ŸAPIï¼ˆè¯„è®ºã€ç‚¹èµã€æ”¶è—ã€å…³æ³¨ã€ä¹¦è¯„ï¼‰å®Œå…¨ç¬¦åˆBlock 7è§„èŒƒå–µ~

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

**1. Socialæ¨¡å—API**
- `api/v1/social/comment_api.go` - éœ€è¦æ£€æŸ¥
- `api/v1/social/like_api.go` - âœ… å·²ç”¨pkg/response
- `api/v1/social/collection_api.go` - âœ… å·²ç”¨pkg/response
- `api/v1/social/follow_api.go` - éœ€è¦æ£€æŸ¥
- `api/v1/social/review_api.go` - âœ… å·²ç”¨pkg/response

**2. Readeræ¨¡å—API**
- `api/v1/reader/chapter_comment_api.go` - âš ï¸ æ··ç”¨äº†shared.Successå’Œresponse.Success

### ç»Ÿä¸€è°ƒæ•´ç‚¹

#### å“åº”æ ¼å¼ç»Ÿä¸€
- ä½¿ç”¨`response.Success()`è€Œä¸æ˜¯`shared.Success()`
- ä½¿ç”¨`response.Error()`è€Œä¸æ˜¯`shared.Error()`
- å“åº”æ ¼å¼ï¼š`{code, message, data, request_id, timestamp}`

#### é”™è¯¯ç ç»Ÿä¸€
- ä½¿ç”¨4ä½ä¸šåŠ¡é”™è¯¯ç ï¼ˆpkg/response/codes.goï¼‰
- è¯„è®ºç›¸å…³é”™è¯¯ç ï¼š2xxxç³»åˆ—
- è¯„åˆ†ç›¸å…³é”™è¯¯ç ï¼š2xxxç³»åˆ—

#### HTTPçŠ¶æ€ç è§„èŒƒ
- ç¡®ä¿HTTPçŠ¶æ€ç ä¸ä¸šåŠ¡åœºæ™¯åŒ¹é…
- å‚æ•°é”™è¯¯ï¼š400
- æœªæˆæƒï¼š401
- èµ„æºä¸å­˜åœ¨ï¼š404
- ä¸šåŠ¡é”™è¯¯ï¼š200ï¼ˆå¸¦é”™è¯¯ç ï¼‰
- æœåŠ¡å™¨é”™è¯¯ï¼š500

### æ›¿æ¢ç­–ç•¥
**å®Œå…¨æ›¿æ¢**ï¼šå°†æ‰€æœ‰`shared.Success/Error`æ›¿æ¢ä¸º`response.Success/Error`

---

## é˜¶æ®µ2ï¼šç»Ÿä¸€è¯„åˆ†ç³»ç»Ÿ

### ç›®æ ‡
å°†åˆ†æ•£çš„è¯„åˆ†é€»è¾‘ç»Ÿä¸€ï¼Œå»ºç«‹ç‹¬ç«‹çš„è¯„åˆ†æœåŠ¡ï¼Œæ”¯æŒä¹¦ç±è¯„åˆ†ã€ç« èŠ‚è¯„åˆ†ã€ä¹¦è¯„è¯„åˆ†ç­‰

### è¯„åˆ†ç³»ç»Ÿå®æ–½ç­–ç•¥å†³ç­– ğŸ¯

#### èƒŒæ™¯ï¼šç°æœ‰è¯„åˆ†å­—æ®µåˆ†å¸ƒ
- `Comment.Rating` - è¯„è®ºè¯„åˆ†ï¼ˆmodels/social/comment.goï¼‰
- `Review.Rating` - ä¹¦è¯„è¯„åˆ†ï¼ˆmodels/social/review.goï¼‰
- `ChapterComment.Rating` - ç« èŠ‚è¯„è®ºè¯„åˆ†ï¼ˆmodels/reader/chapter_comment.goï¼‰
- `BookRating` - ä¹¦ç±è¯„åˆ†ï¼ˆmodels/bookstore/book_rating.goï¼‰

#### å†³ç­–ï¼šä¿ç•™ç°æœ‰å­—æ®µ + æ–°å¢RatingService â­

**é‡‡ç”¨ç­–ç•¥è¯´æ˜**ï¼š

**æ–¹æ¡ˆAï¼šå®Œå…¨è¿ç§»åˆ°ç»Ÿä¸€Ratingè¡¨** âŒ æœªé‡‡ç”¨
- ä¼˜ç‚¹ï¼šæ•°æ®ç»Ÿä¸€ï¼Œæ˜“äºç®¡ç†
- ç¼ºç‚¹ï¼šéœ€è¦æ•°æ®è¿ç§»ï¼Œé£é™©è¾ƒé«˜ï¼Œå¯èƒ½å½±å“ç°æœ‰åŠŸèƒ½

**æ–¹æ¡ˆBï¼šä¿ç•™ç°æœ‰å­—æ®µ + æ–°å¢RatingService** âœ… æ¨è
- ä¼˜ç‚¹ï¼šå‘åå…¼å®¹ï¼Œé£é™©ä½ï¼Œæ¸è¿›å¼æ¼”è¿›
- ç¼ºç‚¹ï¼šæ•°æ®å†—ä½™ï¼Œéœ€è¦åŒæ­¥ç­–ç•¥

**å®æ–½æ–¹æ¡ˆ**ï¼š
1. **ä¿ç•™ç°æœ‰ratingå­—æ®µ** - Commentã€Reviewç­‰æ¨¡å‹çš„ratingå­—æ®µç»§ç»­ä½¿ç”¨ï¼Œæ ‡è®°æ•°æ®ç»Ÿä¸€TODO
2. **æ–°å¢RatingService** - ä½œä¸ºç»Ÿä¸€çš„è¯„åˆ†æŸ¥è¯¢å’Œç»Ÿè®¡æœåŠ¡
3. **RatingServiceèšåˆæ‰€æœ‰è¯„åˆ†æ•°æ®** - ä»å„ä¸ªæ¨¡å‹çš„ratingå­—æ®µèšåˆ
4. **æ¸è¿›å¼è¿ç§»** - é€æ­¥å°†æ–°åŠŸèƒ½çš„è¯„åˆ†é€»è¾‘è¿ç§»åˆ°RatingService
5. **åŒå†™ç­–ç•¥ï¼ˆå¯é€‰ï¼‰** - æ–°åŠŸèƒ½åŒæ—¶å†™å…¥ratingå­—æ®µå’ŒRatingService

#### æ•°æ®æµå‘
```
ç”¨æˆ·è¯„åˆ† â†’ ç°æœ‰ç³»ç»Ÿï¼ˆComment.ratingç­‰ï¼‰
           â†“
       RatingServiceï¼ˆèšåˆã€ç»Ÿè®¡ã€ç¼“å­˜ï¼‰
           â†“
       ç»Ÿä¸€çš„è¯„åˆ†æŸ¥è¯¢API
```

#### å‘åå…¼å®¹æ€§ä¿è¯

**ä¿ç•™çš„APIå’Œå­—æ®µ**ï¼š
- âœ… `Comment.rating` - ä¿ç•™ï¼Œæ ‡è®°ä¸ºlegacy
- âœ… `Review.rating` - ä¿ç•™ï¼Œæ ‡è®°ä¸ºlegacy
- âœ… `ChapterComment.rating` - ä¿ç•™ï¼Œæ ‡è®°ä¸ºlegacy

**æ–°å¢çš„APIå’ŒåŠŸèƒ½**ï¼š
- ğŸ†• `GET /api/v1/social/ratings/{targetType}/{targetId}/stats` - è¯„åˆ†ç»Ÿè®¡
- ğŸ†• `POST /api/v1/social/ratings/batch-stats` - æ‰¹é‡è¯„åˆ†ç»Ÿè®¡
- ğŸ†• RatingService - ç»Ÿä¸€è¯„åˆ†æŸ¥è¯¢æœåŠ¡

**å…¼å®¹æ€§è¯´æ˜**ï¼š
- ç°æœ‰APIç»§ç»­å·¥ä½œï¼Œä¸å½±å“å‰ç«¯
- æ–°åŠŸèƒ½ä¼˜å…ˆä½¿ç”¨RatingService
- é€æ­¥å°†ç°æœ‰åŠŸèƒ½è¿ç§»åˆ°RatingService

### ç»Ÿä¸€è¯„åˆ†ç³»ç»Ÿæ¶æ„

**æ–°å»ºRatingService**ï¼ˆ`service/social/rating_service.go`ï¼‰

### æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

#### 1. è¯„åˆ†ç®¡ç†
```go
// åˆ›å»ºæˆ–æ›´æ–°è¯„åˆ†
UpsertRating(ctx, userID, targetType, targetID, rating) error

// åˆ é™¤è¯„åˆ†
DeleteRating(ctx, userID, targetType, targetID) error

// è·å–ç”¨æˆ·å¯¹æŒ‡å®šå¯¹è±¡çš„è¯„åˆ†
GetUserRating(ctx, userID, targetType, targetID) (*Rating, error)

// æ‰¹é‡è·å–ç”¨æˆ·è¯„åˆ†åˆ—è¡¨
GetUserRatings(ctx, userID, targetType, page, pageSize) ([]*Rating, int64, error)
```

#### 2. è¯„åˆ†ç»Ÿè®¡
```go
// è·å–æŒ‡å®šå¯¹è±¡çš„è¯„åˆ†ç»Ÿè®¡ï¼ˆå¹³å‡åˆ†ã€è¯„åˆ†äººæ•°ã€åˆ†å¸ƒç­‰ï¼‰
GetRatingStats(ctx, targetType, targetID) (*RatingStats, error)

// æ‰¹é‡è·å–å¤šä¸ªå¯¹è±¡çš„è¯„åˆ†ç»Ÿè®¡
GetBatchRatingStats(ctx, targetType, targetIDs) ([]*RatingStats, error)

// è®¡ç®—å¹³å‡åˆ†
CalculateAverageRating(ctx, targetType, targetID) (float64, error)
```

#### 3. è¯„åˆ†æŸ¥è¯¢
```go
// è·å–æŒ‡å®šå¯¹è±¡çš„æ‰€æœ‰è¯„åˆ†ï¼ˆåˆ†é¡µï¼‰
GetRatingsByTarget(ctx, targetType, targetID, page, pageSize) ([]*Rating, int64, error)

// è·å–è¯„åˆ†æ’è¡Œæ¦œï¼ˆçƒ­é—¨è¯„åˆ†ã€æœ€é«˜è¯„åˆ†ç­‰ï¼‰
GetTopRatedTargets(ctx, targetType, limit) ([]*RatedTarget, error)
```

### æ•°æ®æ¨¡å‹è®¾è®¡

**ç»Ÿä¸€Ratingæ¨¡å‹**ï¼ˆ`models/social/rating.go`ï¼‰
```go
type Rating struct {
    ID         string    `json:"id" bson:"_id,omitempty"`
    UserID     string    `json:"userId" bson:"user_id"`
    TargetType string    `json:"targetType" bson:"target_type"` // book, chapter, review
    TargetID   string    `json:"targetId" bson:"target_id"`
    Rating     int       `json:"rating" bson:"rating"`     // 1-5
    CreatedAt  time.Time `json:"createdAt" bson:"created_at"`
    UpdatedAt  time.Time `json:"updatedAt" bson:"updated_at"`
}

type RatingStats struct {
    TargetID      string         `json:"targetId" bson:"target_id"`
    AverageRating float64        `json:"averageRating" bson:"average_rating"`
    TotalRatings  int64          `json:"totalRatings" bson:"total_ratings"`
    Distribution  map[int]int64  `json:"distribution" bson:"distribution"` // {1: count, 2: count, ...}
}

type RatedTarget struct {
    TargetID      string  `json:"targetId"`
    TargetType    string  `json:"targetType"`
    Title         string  `json:"title,omitempty"`
    AverageRating float64 `json:"averageRating"`
    TotalRatings  int64   `json:"totalRatings"`
}
```

### APIæ¥å£è®¾è®¡

**åˆ›å»º/æ›´æ–°è¯„åˆ†**
```
POST /api/v1/social/ratings
Body: {
  "targetType": "book",
  "targetId": "xxx",
  "rating": 5
}
```

**åˆ é™¤è¯„åˆ†**
```
DELETE /api/v1/social/ratings/{targetType}/{targetId}
```

**è·å–è¯„åˆ†ç»Ÿè®¡**
```
GET /api/v1/social/ratings/{targetType}/{targetId}/stats
Response: {
  "code": 0,
  "message": "success",
  "data": {
    "targetId": "xxx",
    "averageRating": 4.5,
    "totalRatings": 100,
    "distribution": {
      "1": 5,
      "2": 10,
      "3": 15,
      "4": 30,
      "5": 40
    }
  },
  "request_id": "req_xxx",
  "timestamp": 1706352000000
}
```

**æ‰¹é‡è·å–è¯„åˆ†ç»Ÿè®¡**
```
POST /api/v1/social/ratings/batch-stats
Body: {
  "targetType": "book",
  "targetIds": ["id1", "id2", "id3"]
}
```

---

## è¯¦ç»†å®æ–½æ­¥éª¤å’Œæ—¶é—´çº¿

### é˜¶æ®µ1ï¼šAPIè§„èŒƒç»Ÿä¸€ï¼ˆé¢„è®¡1-2å¤©ï¼‰

#### Task 1.1ï¼šæ£€æŸ¥å’Œæ›´æ–°Socialæ¨¡å—API
- [ ] æ£€æŸ¥`api/v1/social/comment_api.go`
- [ ] æ£€æŸ¥`api/v1/social/follow_api.go`
- [ ] æ›¿æ¢æ‰€æœ‰`shared.Success/Error`ä¸º`response.Success/Error`
- [ ] ç¡®ä¿ä½¿ç”¨4ä½é”™è¯¯ç 
- [ ] éªŒè¯HTTPçŠ¶æ€ç æ­£ç¡®æ€§
- [ ] ç¡®ä¿ä½¿ç”¨swaggeræ³¨é‡Š

#### Task 1.2ï¼šæ›´æ–°Readeræ¨¡å—API
- [ ] æ›´æ–°`api/v1/reader/chapter_comment_api.go`
- [ ] ç§»é™¤æ®µè½è¯„è®ºç›¸å…³ä»£ç ï¼ˆæˆ–ä¿ç•™ä½†æ ‡è®°ä¸ºTODOï¼‰
- [ ] ç»Ÿä¸€å“åº”æ ¼å¼

#### Task 1.3ï¼šç¼–è¯‘éªŒè¯å’Œæµ‹è¯•
- [ ] è¿è¡Œ`go build`ç¡®ä¿ç¼–è¯‘é€šè¿‡
- [ ] è¿è¡Œç›¸å…³æµ‹è¯•ç¡®ä¿åŠŸèƒ½æ­£å¸¸
- [ ] éªŒè¯å“åº”æ ¼å¼ç¬¦åˆBlock 7è§„èŒƒ

### é˜¶æ®µ2ï¼šç»Ÿä¸€è¯„åˆ†ç³»ç»Ÿï¼ˆé¢„è®¡2-3å¤©ï¼‰

#### Task 2.1ï¼šåˆ›å»ºRatingæ¨¡å‹å’Œæ¥å£
- [ ] åˆ›å»º`models/social/rating.go`
- [ ] å®šä¹‰Ratingç»“æ„ä½“
- [ ] å®šä¹‰RatingStatsç»“æ„ä½“
- [ ] åˆ›å»º`service/interfaces/rating_service_interface.go`

#### Task 2.2ï¼šå®ç°RatingService
- [ ] åˆ›å»º`service/social/rating_service.go`
- [ ] å®ç°è¯„åˆ†CRUDæ–¹æ³•
- [ ] å®ç°è¯„åˆ†ç»Ÿè®¡æ–¹æ³•
- [ ] å®ç°ç¼“å­˜é€»è¾‘ï¼ˆRedisï¼‰

#### Task 2.3ï¼šåˆ›å»ºRepositoryå®ç°
- [ ] åˆ›å»º`repository/interfaces/social/rating_repository.go`
- [ ] åˆ›å»º`repository/mongodb/social/rating_repository_mongo.go`
- [ ] å®ç°æ•°æ®è®¿é—®æ–¹æ³•

#### Task 2.4ï¼šåˆ›å»ºRatingAPI
- [ ] åˆ›å»º`api/v1/social/rating_api.go`
- [ ] å®ç°è¯„åˆ†CRUDæ¥å£
- [ ] å®ç°è¯„åˆ†æŸ¥è¯¢æ¥å£
- [ ] ç¬¦åˆBlock 7è§„èŒƒ

#### Task 2.5ï¼šæ•°æ®è¿ç§»è¯„ä¼°

**ç°æœ‰è¯„åˆ†æ•°æ®ä½ç½®åˆ†æ**ï¼š
```
comments.collection:          ratingå­—æ®µï¼ˆ0-5æ˜Ÿï¼‰
reviews.collection:           ratingå­—æ®µï¼ˆ1-5æ˜Ÿï¼‰
chapter_comments.collection:   ratingå­—æ®µï¼ˆ0-5æ˜Ÿï¼‰
book_ratings.collection:        ä¸“é—¨çš„è¯„åˆ†è¡¨
```

**æ•°æ®è¿ç§»è¯„ä¼°ç»“è®º**ï¼šâœ… **æ— éœ€è¿ç§»**

**åŸå› **ï¼š
- é‡‡ç”¨"ä¿ç•™ç°æœ‰å­—æ®µ + æ–°å¢RatingService"ç­–ç•¥
- RatingServiceä»ç°æœ‰ratingå­—æ®µèšåˆæ•°æ®
- ä¸éœ€è¦åˆ›å»ºæ–°çš„ratingsè¡¨
- ç°æœ‰æ•°æ®ç»“æ„ä¿æŒä¸å˜

**RatingServiceæ•°æ®èšåˆç­–ç•¥**ï¼š
```go
// ä»Commentè¡¨èšåˆè¯„åˆ†
func (s *RatingService) GetCommentRatings(ctx, targetID string) (*RatingStats, error) {
    pipeline := []bson.M{
        {"$match": bson.M{"target_id": targetID, "target_type": "comment", "rating": bson.M{"$gt": 0}}},
        {"$group": bson.M{
            "_id": "$target_id",
            "avg_rating": bson.M{"$avg": "$rating"},
            "total_ratings": bson.M{"$sum": 1},
            "distribution": bson.M{
                "$push": "$rating",
            },
        }},
    }
    // æ‰§è¡ŒèšåˆæŸ¥è¯¢...
}
```

**éœ€è¦æ³¨æ„çš„äº‹é¡¹**ï¼š
- ç¡®ä¿ç°æœ‰ratingå­—æ®µçš„æ•°æ®è´¨é‡ï¼ˆæ˜¯å¦æœ‰å¼‚å¸¸å€¼ï¼‰
- è¯„åˆ†ç»Ÿè®¡çš„å®æ—¶æ€§ï¼ˆèšåˆæŸ¥è¯¢å¯èƒ½æœ‰å»¶è¿Ÿï¼‰
- è€ƒè™‘æ·»åŠ ç´¢å¼•ä¼˜åŒ–èšåˆæŸ¥è¯¢æ€§èƒ½

#### Task 2.6ï¼šé›†æˆæµ‹è¯•
- [ ] ç¼–å†™RatingServiceå•å…ƒæµ‹è¯•
- [ ] ç¼–å†™RatingAPIé›†æˆæµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•ï¼ˆè¯„åˆ†ç»Ÿè®¡æŸ¥è¯¢ï¼‰

---

## è¡¥å……çš„é£é™©è¯„ä¼° âš ï¸

### é£é™©1ï¼šAPIè§„èŒƒç»Ÿä¸€å¯èƒ½å½±å“ç°æœ‰åŠŸèƒ½ ğŸŸ¡
**å½±å“èŒƒå›´**: ä¸­ç­‰
**é—®é¢˜æè¿°**ï¼š
- æ›¿æ¢shared.Success/Errorå¯èƒ½å½±å“ç°æœ‰åŠŸèƒ½
- æŸäº›APIå¯èƒ½ä¾èµ–æ—§çš„å“åº”æ ¼å¼

**ç¼“è§£æªæ–½**:
- âœ… é€ä¸ªæ–‡ä»¶ä¿®æ”¹ï¼Œæ¯æ¬¡ä¿®æ”¹åç«‹å³æµ‹è¯•
- âœ… ä¿ç•™æ—§APIçš„å…¼å®¹æœŸï¼ˆå¦‚æœéœ€è¦ï¼‰
- âœ… å®Œæ•´çš„å›å½’æµ‹è¯•
- âœ… ä»£ç å®¡æŸ¥
- ğŸ†• ä¸å‰ç«¯å›¢é˜Ÿç¡®è®¤APIå˜æ›´
- ğŸ†• ç°åº¦å‘å¸ƒéªŒè¯

### é£é™©2ï¼šè¯„åˆ†ç»Ÿè®¡æ€§èƒ½é—®é¢˜ ğŸ”´
**å½±å“èŒƒå›´**: é«˜
**é—®é¢˜æè¿°**ï¼š
- è¯„åˆ†ç»Ÿè®¡æŸ¥è¯¢å¯èƒ½å¾ˆæ…¢ï¼ˆå¤§é‡è¯„åˆ†æ•°æ®èšåˆï¼‰
- MongoDBèšåˆæŸ¥è¯¢å¯èƒ½äº§ç”Ÿæ€§èƒ½ç“¶é¢ˆ
- é«˜å¹¶å‘æ—¶ç¼“å­˜å¤±æ•ˆå¯èƒ½å¯¼è‡´æ•°æ®åº“å‹åŠ›

**ç¼“è§£æªæ–½**:
- âœ… ä½¿ç”¨Redisç¼“å­˜çƒ­ç‚¹æ•°æ®
- âœ… è®¾ç½®åˆç†çš„TTLï¼ˆ5åˆ†é’Ÿï¼‰
- âœ… æ·»åŠ MongoDBç´¢å¼•ä¼˜åŒ–èšåˆæŸ¥è¯¢
- âœ… ä½¿ç”¨èšåˆç®¡é“ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- âœ… å¼‚æ­¥æ›´æ–°ç»Ÿè®¡æ•°æ®
- âœ… æ€§èƒ½æµ‹è¯•éªŒè¯ï¼ˆè¯„åˆ†ç»Ÿè®¡æŸ¥è¯¢ < 100msï¼‰
- ğŸ†• å®æ–½ç¼“å­˜é¢„çƒ­ç­–ç•¥
- ğŸ†• æ·»åŠ ç¼“å­˜å¹¶å‘é˜²æŠ¤ï¼ˆåˆ†å¸ƒå¼é”ï¼‰
- ğŸ†• æ·»åŠ ç¼“å­˜ç›‘æ§ï¼ˆå‘½ä¸­ç‡ã€å“åº”æ—¶é—´ï¼‰

### é£é™©3ï¼šæ•°æ®ä¸€è‡´æ€§é£é™© ğŸŸ¡
**å½±å“èŒƒå›´**: ä¸­ç­‰
**é—®é¢˜æè¿°**ï¼š
- RatingServiceèšåˆå¤šä¸ªæ•°æ®æºçš„è¯„åˆ†
- æ•°æ®æ›´æ–°æ—¶å¯èƒ½å‡ºç°ä¸ä¸€è‡´
- ç¼“å­˜æ•°æ®ä¸æ•°æ®åº“æ•°æ®å¯èƒ½ä¸åŒæ­¥

**ç¼“è§£æªæ–½**:
- ğŸ†• æ˜ç¡®æ•°æ®æºä¼˜å…ˆçº§ï¼ˆæ•°æ®åº“ä¸ºå‡†ï¼‰
- ğŸ†• å®ç°ç¼“å­˜ä¸€è‡´æ€§æ ¡éªŒ
- ğŸ†• å®šæœŸæ ¡éªŒç¼“å­˜ä¸æ•°æ®åº“çš„ä¸€è‡´æ€§
- ğŸ†• æ·»åŠ æ•°æ®ç›‘æ§å‘Šè­¦
- ğŸ†• ä½¿ç”¨ä¹è§‚é”æˆ–ç‰ˆæœ¬å·æ§åˆ¶å¹¶å‘æ›´æ–°

### é£é™©4ï¼šå›æ»šé£é™© ğŸŸ¢
**å½±å“èŒƒå›´**: ä½
**é—®é¢˜æè¿°**ï¼š
- å¦‚æœæ–°ç³»ç»Ÿå‡ºç°é—®é¢˜ï¼Œéœ€è¦å›æ»š
- éƒ¨åˆ†åŠŸèƒ½å¯èƒ½å·²åˆ‡æ¢åˆ°æ–°ç³»ç»Ÿ

**ç¼“è§£æªæ–½**:
- ğŸ†• ä¿ç•™æ—§ä»£ç å’ŒAPI
- ğŸ†• ä½¿ç”¨ç‰¹æ€§å¼€å…³æ§åˆ¶æ–°åŠŸèƒ½
- ğŸ†• åˆ¶å®šè¯¦ç»†çš„å›æ»šè®¡åˆ’
- ğŸ†• å›æ»šæµ‹è¯•éªŒè¯
- ğŸ†• æ•°æ®å¤‡ä»½ï¼ˆå›æ»šå‰ï¼‰

### é£é™©5ï¼šå‰ç«¯å…¼å®¹æ€§ ğŸŸ¢
**å½±å“èŒƒå›´**: ä½
**é—®é¢˜æè¿°**ï¼š
- æ–°å¢APIå¯èƒ½éœ€è¦å‰ç«¯åŒæ­¥ä¿®æ”¹
- å“åº”æ ¼å¼å˜åŒ–å¯èƒ½å½±å“å‰ç«¯è§£æ

**ç¼“è§£æªæ–½**:
- ğŸ†• ä¸å‰ç«¯å›¢é˜Ÿç¡®è®¤APIå˜æ›´
- ğŸ†• ä¿æŒAPIå‘åå…¼å®¹
- ğŸ†• æä¾›APIå˜æ›´æ–‡æ¡£
- ğŸ†• åè°ƒå‘å¸ƒæ—¶é—´çª—å£
- ğŸ†• å‰ç«¯ç°åº¦éªŒè¯

---

## æ€§èƒ½åŸºå‡†å’Œç›‘æ§ ğŸ“Š

### æ€§èƒ½åŸºå‡†

**å½“å‰æ€§èƒ½**ï¼ˆéœ€è¦æµ‹è¯•ï¼‰ï¼š
- ä¹¦ç±è¯„åˆ†æŸ¥è¯¢ï¼š? msï¼ˆå¾…æµ‹è¯•ï¼‰
- è¯„è®ºè¯„åˆ†æŸ¥è¯¢ï¼š? msï¼ˆå¾…æµ‹è¯•ï¼‰
- è¯„åˆ†ç»Ÿè®¡æŸ¥è¯¢ï¼š? msï¼ˆå¾…æµ‹è¯•ï¼‰

**ç›®æ ‡æ€§èƒ½**ï¼š
- è¯„åˆ†ç»Ÿè®¡æŸ¥è¯¢ï¼š< 100ms (P95)
- æ‰¹é‡è¯„åˆ†ç»Ÿè®¡ï¼š< 200ms (P95)
- ç¼“å­˜å‘½ä¸­ç‡ï¼š> 80%
- ç¼“å­˜å“åº”æ—¶é—´ï¼š< 10ms (P95)

### éœ€è¦ç›‘æ§çš„æŒ‡æ ‡

**ç¼“å­˜æŒ‡æ ‡**ï¼š
- ç¼“å­˜å‘½ä¸­ç‡ï¼ˆç›®æ ‡ > 80%ï¼‰
- ç¼“å­˜å“åº”æ—¶é—´ï¼ˆç›®æ ‡ < 10msï¼‰
- ç¼“å­˜å¤±æ•ˆæ¬¡æ•°
- ç¼“å­˜é‡å»ºæ¬¡æ•°

**æ•°æ®åº“æŒ‡æ ‡**ï¼š
- è¯„åˆ†ç»Ÿè®¡æŸ¥è¯¢è€—æ—¶ï¼ˆç›®æ ‡ < 100msï¼‰
- MongoDBèšåˆæŸ¥è¯¢è€—æ—¶
- æ•°æ®åº“è¿æ¥æ•°
- æ…¢æŸ¥è¯¢æ—¥å¿—

**ä¸šåŠ¡æŒ‡æ ‡**ï¼š
- è¯„åˆ†APIè°ƒç”¨é‡
- è¯„åˆ†æˆåŠŸç‡
- è¯„åˆ†åˆ†å¸ƒç»Ÿè®¡

### æ€§èƒ½æµ‹è¯•è®¡åˆ’

**æµ‹è¯•åœºæ™¯**ï¼š
1. å•ä¸ªè¯„åˆ†ç»Ÿè®¡æŸ¥è¯¢æ€§èƒ½æµ‹è¯•
2. æ‰¹é‡è¯„åˆ†ç»Ÿè®¡æŸ¥è¯¢æ€§èƒ½æµ‹è¯•
3. é«˜å¹¶å‘è¯„åˆ†åˆ›å»º/æ›´æ–°æµ‹è¯•
4. ç¼“å­˜å‘½ä¸­ç‡æµ‹è¯•
5. ç¼“å­˜å¤±æ•ˆåçš„æ€§èƒ½æµ‹è¯•

**æµ‹è¯•å·¥å…·**ï¼š
- Apache Bench (ab)
- k6 æ€§èƒ½æµ‹è¯•
- MongoDB Profiler
- Redis Monitor

---

## éªŒæ”¶æ ‡å‡†

### APIè§„èŒƒç»Ÿä¸€éªŒæ”¶æ ‡å‡†
- [ ] æ‰€æœ‰äº’åŠ¨APIä½¿ç”¨`pkg/response`åŒ…
- [ ] å“åº”æ ¼å¼ç¬¦åˆï¼š`{code, message, data, request_id, timestamp}`
- [ ] é”™è¯¯å“åº”ä½¿ç”¨4ä½ä¸šåŠ¡é”™è¯¯ç 
- [ ] HTTPçŠ¶æ€ç ä¸ä¸šåŠ¡åœºæ™¯åŒ¹é…
- [ ] ç¼–è¯‘é€šè¿‡ï¼Œæ— è­¦å‘Š
- [ ] ç°æœ‰æµ‹è¯•å…¨éƒ¨é€šè¿‡

### è¯„åˆ†ç³»ç»ŸéªŒæ”¶æ ‡å‡†
- [ ] RatingServiceå®ç°æ‰€æœ‰æ ¸å¿ƒæ–¹æ³•
- [ ] æ”¯æŒä¹¦ç±ã€ç« èŠ‚ã€ä¹¦è¯„è¯„åˆ†
- [ ] è¯„åˆ†ç»Ÿè®¡å‡†ç¡®ï¼ˆå¹³å‡åˆ†ã€æ€»æ•°ã€åˆ†å¸ƒï¼‰
- [ ] ç¼“å­˜æ­£å¸¸å·¥ä½œï¼ˆRedisï¼‰
- [ ] APIæ¥å£ç¬¦åˆBlock 7è§„èŒƒ
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•ï¼šè¯„åˆ†ç»Ÿè®¡æŸ¥è¯¢ < 100ms

---

**æ–‡æ¡£å®Œæˆæ—¥æœŸ**: 2026-01-29
**æ–‡æ¡£ä½œè€…**: Kore (glm-4.7)
**çŠ¶æ€**: âœ… å·²æ›´æ–°ï¼ˆæ ¹æ®è®¾è®¡å®¡æŸ¥å»ºè®®ä¼˜åŒ–ï¼‰
**æ›´æ–°å†…å®¹**ï¼š
- âœ… æ·»åŠ è¯„åˆ†ç³»ç»Ÿå®æ–½ç­–ç•¥å†³ç­–ï¼ˆä¿ç•™ç°æœ‰å­—æ®µ + æ–°å¢RatingServiceï¼‰
- âœ… æ˜ç¡®å‘åå…¼å®¹æ€§ä¿è¯
- âœ… æ·»åŠ æ•°æ®è¿ç§»è¯„ä¼°ï¼ˆæ— éœ€è¿ç§»ï¼‰
- âœ… æ·»åŠ è¯¦ç»†ç¼“å­˜ç­–ç•¥è®¾è®¡ï¼ˆå¤±æ•ˆã€ç©¿é€ã€é›ªå´©é˜²æŠ¤ï¼‰
- âœ… è¡¥å……é£é™©è¯„ä¼°ï¼ˆ5ä¸ªä¸»è¦é£é™© + ç¼“è§£æªæ–½ï¼‰
- âœ… æ·»åŠ æ€§èƒ½åŸºå‡†å’Œç›‘æ§æŒ‡æ ‡
- âœ… æ·»åŠ æ€§èƒ½æµ‹è¯•è®¡åˆ’

**å®¡æŸ¥è€…**: Yukin371
**å®¡æŸ¥æ—¥æœŸ**: 2026-01-29
**å®¡æŸ¥ç»“æœ**: âœ… é€šè¿‡
**å¤‡æ³¨**: åœ¨æ—§æ¨¡å‹ä¸­æ·»åŠ å»¶è¿Ÿè¿ç§»è¯´æ˜ï¼Œapiå±‚ç¡®ä¿ä½¿ç”¨swaggeræ³¨é‡Š
