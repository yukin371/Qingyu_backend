# æ€§èƒ½æµ‹è¯•è§„èŒƒ

**ç‰ˆæœ¬**: 1.0  
**æ›´æ–°æ—¥æœŸ**: 2025-10-17  
**ç»´æŠ¤è€…**: é’ç¾½åç«¯å›¢é˜Ÿ

---

## ğŸ“– æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰é’ç¾½åç«¯æ€§èƒ½æµ‹è¯•çš„æ ‡å‡†å’Œæœ€ä½³å®è·µï¼ŒåŒ…æ‹¬åŸºå‡†æµ‹è¯•ã€å‹åŠ›æµ‹è¯•ã€è´Ÿè½½æµ‹è¯•çš„è§„èŒƒã€‚

---

## ğŸ¯ æ€§èƒ½æµ‹è¯•ç›®æ ‡

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è­¦å‘Šå€¼ | å…³é”®å€¼ |
|------|-------|-------|-------|
| **APIå“åº”æ—¶é—´** | < 100ms | < 500ms | < 1s |
| **æ•°æ®åº“æŸ¥è¯¢** | < 50ms | < 200ms | < 500ms |
| **å¹¶å‘ç”¨æˆ·æ•°** | 1000+ | 500+ | 100+ |
| **ååé‡** | 1000 req/s | 500 req/s | 100 req/s |
| **é”™è¯¯ç‡** | < 0.1% | < 1% | < 5% |
| **CPUä½¿ç”¨ç‡** | < 70% | < 85% | < 95% |
| **å†…å­˜ä½¿ç”¨ç‡** | < 70% | < 85% | < 95% |

---

## 1. GoåŸºå‡†æµ‹è¯•

### 1.1 åŸºæœ¬åŸºå‡†æµ‹è¯•

**ä½ç½®**: `test/performance/xxx_benchmark_test.go`

```go
// test/performance/bookstore_benchmark_test.go
package performance_test

import (
    "context"
    "testing"
    
    "Qingyu_backend/service/bookstore"
    "Qingyu_backend/test/fixtures"
)

func BenchmarkBookstoreService_ListBooks(b *testing.B) {
    // Setup
    service := setupBookstoreService()
    ctx := context.Background()
    
    // Reset timer to exclude setup time
    b.ResetTimer()
    
    // Run benchmark
    for i := 0; i < b.N; i++ {
        _, err := service.ListBooks(ctx, 20, 0)
        if err != nil {
            b.Fatal(err)
        }
    }
}

func BenchmarkBookstoreService_GetBookByID(b *testing.B) {
    service := setupBookstoreService()
    ctx := context.Background()
    bookID := "test-book-id"
    
    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        _, err := service.GetBookByID(ctx, bookID)
        if err != nil {
            b.Fatal(err)
        }
    }
}
```

### 1.2 å¹¶è¡ŒåŸºå‡†æµ‹è¯•

```go
func BenchmarkBookstoreService_ListBooks_Parallel(b *testing.B) {
    service := setupBookstoreService()
    
    b.RunParallel(func(pb *testing.PB) {
        ctx := context.Background()
        for pb.Next() {
            _, err := service.ListBooks(ctx, 20, 0)
            if err != nil {
                b.Fatal(err)
            }
        }
    })
}
```

### 1.3 å­åŸºå‡†æµ‹è¯•

```go
func BenchmarkBookstoreService_Search(b *testing.B) {
    service := setupBookstoreService()
    ctx := context.Background()
    
    benchmarks := []struct {
        name     string
        keyword  string
        pageSize int
    }{
        {"Small", "test", 10},
        {"Medium", "test", 50},
        {"Large", "test", 100},
    }
    
    for _, bm := range benchmarks {
        b.Run(bm.name, func(b *testing.B) {
            b.ResetTimer()
            for i := 0; i < b.N; i++ {
                service.SearchBooks(ctx, bm.keyword, bm.pageSize, 0)
            }
        })
    }
}
```

### 1.4 è¿è¡ŒåŸºå‡†æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰åŸºå‡†æµ‹è¯•
go test -bench=. ./test/performance/...

# è¿è¡Œç‰¹å®šåŸºå‡†æµ‹è¯•
go test -bench=BenchmarkBookstore ./test/performance/...

# è¿è¡Œå¤šæ¬¡å–å¹³å‡å€¼
go test -bench=. -benchtime=10s ./test/performance/...

# æŒ‡å®šè¿­ä»£æ¬¡æ•°
go test -bench=. -benchtime=100x ./test/performance/...

# æ˜¾ç¤ºå†…å­˜åˆ†é…
go test -bench=. -benchmem ./test/performance/...

# ç”ŸæˆCPUåˆ†æ
go test -bench=. -cpuprofile=cpu.prof ./test/performance/...

# ç”Ÿæˆå†…å­˜åˆ†æ
go test -bench=. -memprofile=mem.prof ./test/performance/...
```

---

## 2. æ€§èƒ½åˆ†æï¼ˆProfilingï¼‰

### 2.1 CPUåˆ†æ

```bash
# ç”ŸæˆCPU profile
go test -bench=BenchmarkBookstore -cpuprofile=cpu.prof ./test/performance/

# åˆ†æprofile
go tool pprof cpu.prof

# å¸¸ç”¨å‘½ä»¤
(pprof) top          # æŸ¥çœ‹æœ€è€—CPUçš„å‡½æ•°
(pprof) list <func>  # æŸ¥çœ‹å‡½æ•°è¯¦ç»†ä¿¡æ¯
(pprof) web          # ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨ï¼ˆéœ€è¦graphvizï¼‰
(pprof) pdf          # å¯¼å‡ºPDFæŠ¥å‘Š
```

### 2.2 å†…å­˜åˆ†æ

```bash
# ç”Ÿæˆå†…å­˜profile
go test -bench=. -memprofile=mem.prof ./test/performance/

# åˆ†æå†…å­˜åˆ†é…
go tool pprof -alloc_space mem.prof

# åˆ†æå†…å­˜ä½¿ç”¨
go tool pprof -inuse_space mem.prof
```

### 2.3 Traceåˆ†æ

```bash
# ç”Ÿæˆtrace
go test -bench=. -trace=trace.out ./test/performance/

# æŸ¥çœ‹trace
go tool trace trace.out
```

### 2.4 å®æ—¶æ€§èƒ½ç›‘æ§

```go
// åœ¨æœåŠ¡ä¸­å¯ç”¨pprof
import _ "net/http/pprof"

func main() {
    // å¯åŠ¨pprofæœåŠ¡å™¨
    go func() {
        log.Println(http.ListenAndServe("localhost:6060", nil))
    }()
    
    // å¯åŠ¨ä¸»æœåŠ¡
    // ...
}
```

è®¿é—®æ€§èƒ½æ•°æ®ï¼š
```bash
# CPU profile
go tool pprof http://localhost:6060/debug/pprof/profile

# Heap profile
go tool pprof http://localhost:6060/debug/pprof/heap

# Goroutine profile
go tool pprof http://localhost:6060/debug/pprof/goroutine
```

---

## 3. å‹åŠ›æµ‹è¯•

### 3.1 ä½¿ç”¨wrk

```bash
# å®‰è£…wrk
# Ubuntu/Debian
sudo apt-get install wrk

# macOS
brew install wrk

# åŸºæœ¬å‹åŠ›æµ‹è¯•
wrk -t12 -c400 -d30s http://localhost:8080/api/v1/books

# å‚æ•°è¯´æ˜
# -t12: 12ä¸ªçº¿ç¨‹
# -c400: 400ä¸ªå¹¶å‘è¿æ¥
# -d30s: æŒç»­30ç§’

# ä½¿ç”¨Luaè„šæœ¬
wrk -t12 -c400 -d30s -s post.lua http://localhost:8080/api/v1/books
```

**Luaè„šæœ¬ç¤ºä¾‹** (`post.lua`):
```lua
wrk.method = "POST"
wrk.body   = '{"title":"Test Book","author":"Test Author"}'
wrk.headers["Content-Type"] = "application/json"
wrk.headers["Authorization"] = "Bearer your-token"
```

### 3.2 ä½¿ç”¨Apache Bench (ab)

```bash
# å®‰è£…ab
# Ubuntu/Debian
sudo apt-get install apache2-utils

# macOS (è‡ªå¸¦)

# åŸºæœ¬æµ‹è¯•
ab -n 10000 -c 100 http://localhost:8080/api/v1/books

# POSTè¯·æ±‚
ab -n 1000 -c 100 -p post.json -T application/json http://localhost:8080/api/v1/books

# å¸¦è®¤è¯
ab -n 1000 -c 100 -H "Authorization: Bearer token" http://localhost:8080/api/v1/books
```

### 3.3 ä½¿ç”¨Hey

```bash
# å®‰è£…hey
go install github.com/rakyll/hey@latest

# åŸºæœ¬æµ‹è¯•
hey -n 10000 -c 100 http://localhost:8080/api/v1/books

# POSTè¯·æ±‚
hey -n 1000 -c 100 -m POST -H "Content-Type: application/json" \
    -d '{"title":"Test"}' http://localhost:8080/api/v1/books

# ç”ŸæˆæŠ¥å‘Š
hey -n 10000 -c 100 -o csv http://localhost:8080/api/v1/books > results.csv
```

---

## 4. è´Ÿè½½æµ‹è¯•

### 4.1 ä½¿ç”¨k6

```bash
# å®‰è£…k6
# Ubuntu/Debian
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update
sudo apt-get install k6

# macOS
brew install k6
```

**k6æµ‹è¯•è„šæœ¬**:
```javascript
// test/performance/load_test.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export let options = {
    stages: [
        { duration: '2m', target: 100 },  // Ramp up to 100 users
        { duration: '5m', target: 100 },  // Stay at 100 users
        { duration: '2m', target: 200 },  // Ramp up to 200 users
        { duration: '5m', target: 200 },  // Stay at 200 users
        { duration: '2m', target: 0 },    // Ramp down to 0 users
    ],
    thresholds: {
        http_req_duration: ['p(95)<500'], // 95% of requests must complete below 500ms
        http_req_failed: ['rate<0.01'],   // Error rate must be less than 1%
    },
};

export default function () {
    // æµ‹è¯•ä¹¦åº—åˆ—è¡¨API
    let response = http.get('http://localhost:8080/api/v1/books');
    
    check(response, {
        'status is 200': (r) => r.status === 200,
        'response time < 500ms': (r) => r.timings.duration < 500,
    });
    
    sleep(1);
    
    // æµ‹è¯•ä¹¦ç±è¯¦æƒ…API
    response = http.get('http://localhost:8080/api/v1/books/1');
    
    check(response, {
        'status is 200': (r) => r.status === 200,
    });
    
    sleep(1);
}
```

è¿è¡Œk6æµ‹è¯•ï¼š
```bash
# è¿è¡Œè´Ÿè½½æµ‹è¯•
k6 run test/performance/load_test.js

# ç”ŸæˆHTMLæŠ¥å‘Š
k6 run --out json=results.json test/performance/load_test.js
```

---

## 5. æ•°æ®åº“æ€§èƒ½æµ‹è¯•

### 5.1 MongoDBåŸºå‡†æµ‹è¯•

```go
func BenchmarkMongoDB_Insert(b *testing.B) {
    collection := getTestCollection()
    ctx := context.Background()
    
    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        doc := bson.M{
            "title":  fmt.Sprintf("Book %d", i),
            "author": "Test Author",
            "price":  99.99,
        }
        _, err := collection.InsertOne(ctx, doc)
        if err != nil {
            b.Fatal(err)
        }
    }
}

func BenchmarkMongoDB_Find(b *testing.B) {
    collection := getTestCollection()
    ctx := context.Background()
    
    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        var result bson.M
        err := collection.FindOne(ctx, bson.M{"title": "Test Book"}).Decode(&result)
        if err != nil && err != mongo.ErrNoDocuments {
            b.Fatal(err)
        }
    }
}

func BenchmarkMongoDB_Aggregate(b *testing.B) {
    collection := getTestCollection()
    ctx := context.Background()
    
    pipeline := mongo.Pipeline{
        bson.D{{"$match", bson.D{{"price", bson.D{{"$gte", 50}}}}}},
        bson.D{{"$group", bson.D{
            {"_id", "$author"},
            {"count", bson.D{{"$sum", 1}}},
        }}},
    }
    
    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        cursor, err := collection.Aggregate(ctx, pipeline)
        if err != nil {
            b.Fatal(err)
        }
        cursor.Close(ctx)
    }
}
```

---

## 6. æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 6.1 ä»£ç å±‚é¢

âœ… **ä½¿ç”¨è¿æ¥æ± **:
```go
// MongoDBè¿æ¥æ± é…ç½®
clientOptions := options.Client().
    ApplyURI(mongoURI).
    SetMaxPoolSize(100).
    SetMinPoolSize(10)
```

âœ… **ä½¿ç”¨ç¼“å­˜**:
```go
// Redisç¼“å­˜
func (s *BookService) GetBook(id string) (*Book, error) {
    // å…ˆä»ç¼“å­˜è·å–
    book, err := s.cache.Get(id)
    if err == nil {
        return book, nil
    }
    
    // ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“è·å–
    book, err = s.repo.GetByID(id)
    if err != nil {
        return nil, err
    }
    
    // å†™å…¥ç¼“å­˜
    s.cache.Set(id, book, 5*time.Minute)
    return book, nil
}
```

âœ… **æ‰¹é‡æ“ä½œ**:
```go
// æ‰¹é‡æ’å…¥è€Œéå¾ªç¯æ’å…¥
docs := make([]interface{}, 1000)
for i := 0; i < 1000; i++ {
    docs[i] = Book{Title: fmt.Sprintf("Book %d", i)}
}
collection.InsertMany(ctx, docs)
```

### 6.2 æ•°æ®åº“å±‚é¢

âœ… **åˆ›å»ºç´¢å¼•**:
```go
// ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•
indexModel := mongo.IndexModel{
    Keys: bson.D{
        {"title", 1},
        {"author", 1},
    },
}
collection.Indexes().CreateOne(ctx, indexModel)
```

âœ… **æŸ¥è¯¢ä¼˜åŒ–**:
```go
// åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
opts := options.Find().SetProjection(bson.D{
    {"title", 1},
    {"author", 1},
    {"price", 1},
})
cursor, _ := collection.Find(ctx, filter, opts)
```

### 6.3 æ¶æ„å±‚é¢

âœ… **æ°´å¹³æ‰©å±•**: æ·»åŠ æ›´å¤šæœåŠ¡å®ä¾‹  
âœ… **è´Ÿè½½å‡è¡¡**: ä½¿ç”¨Nginx/HAProxy  
âœ… **æ•°æ®åº“åˆ†ç‰‡**: MongoDB Sharding  
âœ… **è¯»å†™åˆ†ç¦»**: ä¸»ä»å¤åˆ¶  
âœ… **CDNåŠ é€Ÿ**: é™æ€èµ„æºä½¿ç”¨CDN  

---

## 7. æ€§èƒ½ç›‘æ§

### 7.1 Prometheus + Grafana

```go
// é›†æˆPrometheus metrics
import (
    "github.com/prometheus/client_golang/prometheus"
    "github.com/prometheus/client_golang/prometheus/promauto"
    "github.com/prometheus/client_golang/prometheus/promhttp"
)

var (
    httpRequestsTotal = promauto.NewCounterVec(
        prometheus.CounterOpts{
            Name: "http_requests_total",
            Help: "Total number of HTTP requests",
        },
        []string{"method", "endpoint", "status"},
    )
    
    httpRequestDuration = promauto.NewHistogramVec(
        prometheus.HistogramOpts{
            Name:    "http_request_duration_seconds",
            Help:    "HTTP request duration in seconds",
            Buckets: prometheus.DefBuckets,
        },
        []string{"method", "endpoint"},
    )
)

// åœ¨è·¯ç”±ä¸­å¯ç”¨metrics
r.GET("/metrics", gin.WrapH(promhttp.Handler()))
```

---

## 8. æ€§èƒ½æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿

### 8.1 æµ‹è¯•ç¯å¢ƒ

```markdown
## æµ‹è¯•ç¯å¢ƒ

- **æœåŠ¡å™¨é…ç½®**: 4æ ¸8GB
- **æ•°æ®åº“**: MongoDB 5.0
- **Goç‰ˆæœ¬**: 1.21
- **å¹¶å‘æ•°**: 100/500/1000
- **æµ‹è¯•æ—¶é—´**: 2024-10-17
```

### 8.2 æµ‹è¯•ç»“æœ

```markdown
## æµ‹è¯•ç»“æœ

### APIå“åº”æ—¶é—´

| API | å¹³å‡å“åº”æ—¶é—´ | P95 | P99 | QPS |
|-----|------------|-----|-----|-----|
| GET /books | 45ms | 120ms | 250ms | 1200 |
| GET /books/:id | 20ms | 50ms | 100ms | 2500 |
| POST /books | 80ms | 200ms | 400ms | 800 |

### å¹¶å‘æµ‹è¯•

| å¹¶å‘æ•° | æˆåŠŸç‡ | å¹³å‡å“åº”æ—¶é—´ | é”™è¯¯ç‡ |
|-------|-------|------------|--------|
| 100 | 100% | 50ms | 0% |
| 500 | 99.8% | 180ms | 0.2% |
| 1000 | 98.5% | 450ms | 1.5% |
```

---

## ğŸ“š ç›¸å…³èµ„æº

- [æµ‹è¯•ç»„ç»‡è§„èŒƒ](./æµ‹è¯•ç»„ç»‡è§„èŒƒ.md)
- [APIæµ‹è¯•æŒ‡å—](./APIæµ‹è¯•æŒ‡å—.md)
- [æµ‹è¯•æœ€ä½³å®è·µ](./æµ‹è¯•æœ€ä½³å®è·µ.md)
- [Goæ€§èƒ½ä¼˜åŒ–æ–‡æ¡£](https://golang.org/doc/diagnostics.html)

---

**æœ€åæ›´æ–°**: 2025-10-17  
**ç»´æŠ¤è€…**: é’ç¾½åç«¯å›¢é˜Ÿ

