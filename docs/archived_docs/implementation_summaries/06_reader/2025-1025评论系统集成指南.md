# è¯„è®ºç³»ç»Ÿé›†æˆæŒ‡å—

**ç‰ˆæœ¬**: v1.0  
**æ—¥æœŸ**: 2025-10-25  
**çŠ¶æ€**: å¾…é›†æˆ

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

è¯„è®ºç³»ç»Ÿçš„æ ¸å¿ƒä»£ç å·²ç»å®ç°å®Œæˆï¼š

1. âœ… **æ•°æ®æ¨¡å‹**: `models/reader/comment.go`
2. âœ… **Repositoryæ¥å£**: `repository/interfaces/reading/comment_repository.go`
3. âœ… **Repositoryå®ç°**: `repository/mongodb/reading/comment_repository_mongo.go`
4. âœ… **Serviceæ¥å£**: `service/interfaces/comment_service.go`
5. âœ… **Serviceå®ç°**: `service/reading/comment_service.go`
6. âœ… **APIå®ç°**: `api/v1/reader/comment_api.go`
7. âœ… **è·¯ç”±é…ç½®**: `router/reader/reader_router.go`ï¼ˆå·²ä¿®æ”¹ï¼‰

---

## ğŸ”§ å¾…å®Œæˆçš„é›†æˆå·¥ä½œ

### æ­¥éª¤1ï¼šæ³¨å†ŒCommentServiceåˆ°æœåŠ¡å®¹å™¨

**æ–‡ä»¶**: `service/container/service_container.go`

#### 1.1 æ·»åŠ commentServiceå­—æ®µ

åœ¨ServiceContainerç»“æ„ä½“ä¸­æ·»åŠ ï¼š

```go
// ServiceContainer æœåŠ¡å®¹å™¨
type ServiceContainer struct {
    // ... ç°æœ‰å­—æ®µ ...
    
    // ä¸šåŠ¡æœåŠ¡
    userService      userInterface.UserService
    aiService        *aiService.Service
    bookstoreService bookstoreService.BookstoreService
    readerService    *readingService.ReaderService
    commentService   *readingService.CommentService  // æ–°å¢
    
    // ... å…¶ä»–å­—æ®µ ...
}
```

#### 1.2 æ·»åŠ æ³¨å†Œæ–¹æ³•

åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ä»¥ä¸‹æ–¹æ³•ï¼š

```go
// RegisterCommentService æ³¨å†Œè¯„è®ºæœåŠ¡
func (c *ServiceContainer) RegisterCommentService(commentService *readingService.CommentService) {
    c.mu.Lock()
    defer c.mu.Unlock()
    c.commentService = commentService
    c.services["CommentService"] = commentService
}

// GetCommentService è·å–è¯„è®ºæœåŠ¡
func (c *ServiceContainer) GetCommentService() (*readingService.CommentService, error) {
    if c.commentService == nil {
        return nil, fmt.Errorf("CommentServiceæœªåˆå§‹åŒ–")
    }
    return c.commentService, nil
}
```

#### 1.3 åœ¨Initializeæ–¹æ³•ä¸­åˆ›å»ºå¹¶æ³¨å†ŒCommentService

æ‰¾åˆ°Initializeæ–¹æ³•ä¸­åˆ›å»ºreaderServiceçš„éƒ¨åˆ†ï¼Œåœ¨å…¶åæ·»åŠ ï¼š

```go
// åˆ›å»ºCommentService
commentRepo := c.repositoryFactory.GetCommentRepository()
sensitiveWordRepo := c.repositoryFactory.GetSensitiveWordRepository()

commentSvc := readingService.NewCommentService(
    commentRepo,
    sensitiveWordRepo,
    c.eventBus,
)
c.RegisterCommentService(commentSvc)
```

**æ³¨æ„**: éœ€è¦ç¡®ä¿RepositoryFactoryå·²ç»å®ç°äº†GetCommentRepositoryå’ŒGetSensitiveWordRepositoryæ–¹æ³•ã€‚

---

### æ­¥éª¤2ï¼šæ›´æ–°RepositoryFactory

**æ–‡ä»¶**: `repository/interfaces/repository_factory.go`

#### 2.1 æ·»åŠ æ¥å£æ–¹æ³•

```go
type RepositoryFactory interface {
    // ... ç°æœ‰æ–¹æ³• ...
    
    // é˜…è¯»ç›¸å…³Repository
    GetCommentRepository() reading.CommentRepository
    
    // ... å…¶ä»–æ–¹æ³• ...
}
```

**æ–‡ä»¶**: `repository/mongodb/repository_factory.go`

#### 2.2 æ·»åŠ å®ç°æ–¹æ³•

```go
// GetCommentRepository è·å–è¯„è®ºRepository
func (f *MongoRepositoryFactory) GetCommentRepository() readingRepo.CommentRepository {
    if f.commentRepo == nil {
        f.commentRepo = readingMongo.NewMongoCommentRepository(f.db)
    }
    return f.commentRepo
}
```

#### 2.3 åœ¨ç»“æ„ä½“ä¸­æ·»åŠ å­—æ®µ

```go
type MongoRepositoryFactory struct {
    db *mongo.Database
    
    // ... ç°æœ‰å­—æ®µ ...
    commentRepo readingRepo.CommentRepository
    // ... å…¶ä»–å­—æ®µ ...
}
```

---

### æ­¥éª¤3ï¼šæ›´æ–°è·¯ç”±å…¥å£

**æ–‡ä»¶**: `router/enter.go`

#### 3.1 è·å–CommentServiceå¹¶ä¼ é€’ç»™InitReaderRouter

æ‰¾åˆ°æ³¨å†Œé˜…è¯»å™¨è·¯ç”±çš„éƒ¨åˆ†ï¼š

```go
// ============ æ³¨å†Œé˜…è¯»å™¨è·¯ç”± ============
readerSvc, err := serviceContainer.GetReaderService()
if err != nil {
    logger.Warn("è·å–é˜…è¯»å™¨æœåŠ¡å¤±è´¥", zap.Error(err))
    logger.Info("é˜…è¯»å™¨è·¯ç”±æœªæ³¨å†Œ")
} else {
    // è·å–è¯„è®ºæœåŠ¡ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    commentSvc, commentErr := serviceContainer.GetCommentService()
    if commentErr != nil {
        logger.Warn("è¯„è®ºæœåŠ¡æœªé…ç½®", zap.Error(commentErr))
        commentSvc = nil
    }
    
    readerRouter.InitReaderRouter(v1, readerSvc, commentSvc)

    logger.Info("âœ“ é˜…è¯»å™¨è·¯ç”±å·²æ³¨å†Œåˆ°: /api/v1/reader/")
    logger.Info("  - /api/v1/reader/books/* (ä¹¦æ¶ç®¡ç†)")
    logger.Info("  - /api/v1/reader/chapters/* (ç« èŠ‚å†…å®¹)")
    logger.Info("  - /api/v1/reader/progress/* (é˜…è¯»è¿›åº¦)")
    logger.Info("  - /api/v1/reader/annotations/* (æ ‡æ³¨ç®¡ç†)")
    logger.Info("  - /api/v1/reader/settings/* (é˜…è¯»è®¾ç½®)")
    if commentSvc != nil {
        logger.Info("  - /api/v1/reader/comments/* (è¯„è®ºç³»ç»Ÿ)")
    }
}
```

---

### æ­¥éª¤4ï¼šéªŒè¯è¯„è®ºç³»ç»Ÿ

#### 4.1 ç¼–è¯‘æ£€æŸ¥

```bash
go build ./...
```

å¦‚æœæœ‰ç¼–è¯‘é”™è¯¯ï¼Œæ ¹æ®é”™è¯¯ä¿¡æ¯ä¿®å¤ã€‚

#### 4.2 å¯åŠ¨æœåŠ¡å™¨

```bash
go run cmd/server/main.go
```

æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰ï¼š
- âœ“ CommentServiceå·²æ³¨å†Œ
- âœ“ è¯„è®ºè·¯ç”±å·²æ³¨å†Œåˆ°: /api/v1/reader/comments/

#### 4.3 æµ‹è¯•è¯„è®ºAPI

ä½¿ç”¨Postmanæˆ–curlæµ‹è¯•ï¼š

**1. å‘è¡¨è¯„è®º**

```bash
curl -X POST http://localhost:8080/api/v1/reader/comments \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "book_id": "BOOK_ID",
    "content": "è¿™æ˜¯ä¸€æ¡æµ‹è¯•è¯„è®ºï¼Œå†…å®¹è‡³å°‘éœ€è¦10ä¸ªå­—ã€‚",
    "rating": 5
  }'
```

**2. è·å–è¯„è®ºåˆ—è¡¨**

```bash
curl http://localhost:8080/api/v1/reader/comments?bookId=BOOK_ID&page=1&size=20
```

---

## ğŸ“‹ é›†æˆæ£€æŸ¥æ¸…å•

- [ ] ServiceContaineræ·»åŠ commentServiceå­—æ®µ
- [ ] å®ç°RegisterCommentServiceå’ŒGetCommentServiceæ–¹æ³•
- [ ] åœ¨Initializeæ–¹æ³•ä¸­åˆ›å»ºå¹¶æ³¨å†ŒCommentService
- [ ] RepositoryFactoryæ·»åŠ GetCommentRepositoryæ–¹æ³•
- [ ] MongoRepositoryFactoryå®ç°GetCommentRepository
- [ ] æ›´æ–°router/enter.goä»¥ä¼ é€’commentService
- [ ] ç¼–è¯‘é€šè¿‡ï¼ˆgo buildï¼‰
- [ ] æœåŠ¡å¯åŠ¨æˆåŠŸ
- [ ] æ—¥å¿—æ˜¾ç¤ºè¯„è®ºæœåŠ¡å’Œè·¯ç”±å·²æ³¨å†Œ
- [ ] APIæµ‹è¯•é€šè¿‡ï¼ˆå‘è¡¨è¯„è®ºã€è·å–åˆ—è¡¨ï¼‰

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•

åˆ›å»º `test/service/comment_service_test.go`:

```go
package service_test

import (
    "context"
    "testing"
    
    "Qingyu_backend/models/reader"
    "Qingyu_backend/service/reading"
    // Mock repositories...
)

func TestCommentService_PublishComment(t *testing.T) {
    // TODO: å®ç°æµ‹è¯•
}

func TestCommentService_ReplyComment(t *testing.T) {
    // TODO: å®ç°æµ‹è¯•
}

// ... æ›´å¤šæµ‹è¯•ç”¨ä¾‹
```

### é›†æˆæµ‹è¯•

ä¿®å¤ `test/integration/scenario_interaction_test.go` ä¸­çš„æµ‹è¯•4ã€5ï¼š

```go
t.Run("4.è¯„è®º_å‘è¡¨ä¹¦ç±è¯„è®º", func(t *testing.T) {
    // ç§»é™¤ t.Skip()
    // å®ç°å®Œæ•´çš„æµ‹è¯•é€»è¾‘
})

t.Run("5.è¯„è®º_è·å–ä¹¦ç±è¯„è®ºåˆ—è¡¨", func(t *testing.T) {
    // ç§»é™¤ t.Skip()
    // å®ç°å®Œæ•´çš„æµ‹è¯•é€»è¾‘
})
```

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: ç¼–è¯‘æ—¶æ‰¾ä¸åˆ°CommentRepository

**A**: ç¡®ä¿å·²ç»åœ¨RepositoryFactoryæ¥å£ä¸­æ·»åŠ äº†GetCommentRepositoryæ–¹æ³•ï¼Œå¹¶åœ¨MongoRepositoryFactoryä¸­å®ç°ã€‚

### Q2: æœåŠ¡å¯åŠ¨æ—¶è¯„è®ºè·¯ç”±æœªæ³¨å†Œ

**A**: æ£€æŸ¥ï¼š
1. CommentServiceæ˜¯å¦æˆåŠŸåˆ›å»ºå’Œæ³¨å†Œ
2. router/enter.goæ˜¯å¦æ­£ç¡®è·å–å¹¶ä¼ é€’commentService
3. router/reader/reader_router.goä¸­çš„æ¡ä»¶åˆ¤æ–­æ˜¯å¦æ­£ç¡®

### Q3: è¯„è®ºå®¡æ ¸æ€»æ˜¯è¿”å›rejected

**A**: æ£€æŸ¥sensitiveWordRepoæ˜¯å¦æ­£ç¡®åˆå§‹åŒ–ã€‚å¦‚æœsensitiveWordRepoä¸ºnilï¼Œåº”è¯¥é»˜è®¤é€šè¿‡å®¡æ ¸ã€‚

---

## ğŸ“ ä¸‹ä¸€æ­¥è®¡åˆ’

å®Œæˆè¯„è®ºç³»ç»Ÿé›†æˆåï¼š

1. **å®ç°ç‚¹èµç³»ç»Ÿ**ï¼ˆé˜¶æ®µ2ï¼‰
   - åˆ›å»ºLikeæ¨¡å‹
   - å®ç°LikeRepositoryå’ŒLikeService
   - é›†æˆRedisç¼“å­˜
   - ä¸CommentServiceé›†æˆ

2. **å®ç°æ”¶è—ç³»ç»Ÿ**ï¼ˆé˜¶æ®µ3ï¼‰
   - ç‹¬ç«‹çš„æ”¶è—åŠŸèƒ½
   - æ”¶è—å¤¹ç®¡ç†
   - åˆ†äº«åŠŸèƒ½

3. **å®ç°é˜…è¯»å†å²ç³»ç»Ÿ**ï¼ˆé˜¶æ®µ4ï¼‰
   - ç‹¬ç«‹çš„å†å²è®°å½•
   - é˜…è¯»ç»Ÿè®¡
   - è‡ªåŠ¨æ¸…ç†

4. **é›†æˆæµ‹è¯•ä¸ä¼˜åŒ–**ï¼ˆé˜¶æ®µ5ï¼‰
   - è¿è¡Œæ‰€æœ‰é›†æˆæµ‹è¯•
   - æ€§èƒ½ä¼˜åŒ–
   - ç¼–å†™å®æ–½æ–‡æ¡£

---

**é›†æˆæŒ‡å—ç¼–å†™æ—¶é—´**: 2025-10-25  
**é¢„è®¡é›†æˆæ—¶é—´**: 1-2å°æ—¶  
**ä¸‹æ¬¡æ›´æ–°**: å®Œæˆé›†æˆå

