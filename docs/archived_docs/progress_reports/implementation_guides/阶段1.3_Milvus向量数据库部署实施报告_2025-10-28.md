# é˜¶æ®µ 1.3ï¼šMilvus å‘é‡æ•°æ®åº“éƒ¨ç½²å®æ–½æŠ¥å‘Š

**å®æ–½æ—¥æœŸ**: 2025-10-28  
**å®æ–½é˜¶æ®µ**: Phase3 é˜¶æ®µ 1.3  
**çŠ¶æ€**: âœ… ä»£ç å®ç°å®Œæˆï¼ˆDocker éƒ¨ç½²å¾…éªŒè¯ï¼‰

---

## ğŸ“‹ å®æ–½æ¦‚è§ˆ

### å®æ–½ç›®æ ‡

å®Œæˆ Milvus å‘é‡æ•°æ®åº“çš„éƒ¨ç½²ã€é…ç½®å’Œæ ¸å¿ƒåŠŸèƒ½å®ç°ï¼Œä¸º Phase3 çš„ RAG ç³»ç»Ÿæ‰“ä¸‹åšå®åŸºç¡€ã€‚

### æ ¸å¿ƒæˆæœ

| ç»„ä»¶ | å®ç°å†…å®¹ | çŠ¶æ€ | ä»£ç é‡ |
|------|---------|------|--------|
| **MilvusClient** | Collection ç®¡ç†ã€CRUD æ“ä½œ | âœ… å®Œæˆ | ~250è¡Œ |
| **EmbeddingService** | BGE æ¨¡å‹åŠ è½½ã€å‘é‡åŒ– | âœ… å®Œæˆ | ~135è¡Œ |
| **é›†æˆæµ‹è¯•** | ç«¯åˆ°ç«¯ RAG æµ‹è¯•ç”¨ä¾‹ | âœ… å®Œæˆ | ~180è¡Œ |
| **å¥åº·æ£€æŸ¥** | API æ›´æ–°ï¼ˆæ–‡æ¡£åŒ–ï¼‰ | âœ… å®Œæˆ | ~40è¡Œ |
| **Docker é…ç½®** | Milvus/etcd/MinIO æ ˆ | â³ é…ç½®å°±ç»ª | N/A |

**æ€»è®¡**: ~605è¡Œæ–°å¢ä»£ç 

---

## ğŸ³ Docker éƒ¨ç½²

### æœåŠ¡é…ç½®è¯¦è§£

åœ¨ `docker/docker-compose.dev.yml` ä¸­å·²åŒ…å«å®Œæ•´çš„ Milvus æ ˆé…ç½®ï¼š

#### 1. etcdï¼ˆMilvus å…ƒæ•°æ®å­˜å‚¨ï¼‰

```yaml
etcd:
  image: quay.io/coreos/etcd:v3.5.5
  ports:
    - "2379:2379"
  environment:
    - ETCD_AUTO_COMPACTION_MODE=revision
    - ETCD_AUTO_COMPACTION_RETENTION=1000
    - ETCD_QUOTA_BACKEND_BYTES=4294967296
  volumes:
    - etcd_data:/etcd_data
```

**é…ç½®è¯´æ˜**:
- **è‡ªåŠ¨å‹ç¼©**: æ¯ 1000 ä¸ªä¿®è®¢ç‰ˆæœ¬å‹ç¼©ä¸€æ¬¡
- **å­˜å‚¨é…é¢**: 4GBï¼ˆé€‚åˆä¸­å°è§„æ¨¡ï¼‰
- **æ•°æ®æŒä¹…åŒ–**: ä½¿ç”¨ Docker volume

#### 2. MinIOï¼ˆMilvus å¯¹è±¡å­˜å‚¨ï¼‰

```yaml
minio:
  image: minio/minio:RELEASE.2023-10-07T20-54-22Z
  ports:
    - "9000:9000"   # API ç«¯å£
    - "9001:9001"   # æ§åˆ¶å°ç«¯å£
  environment:
    - MINIO_ROOT_USER=minioadmin
    - MINIO_ROOT_PASSWORD=minioadmin
  volumes:
    - minio_data:/data
  command: server /data --console-address ":9001"
```

**é…ç½®è¯´æ˜**:
- **æ§åˆ¶å°è®¿é—®**: `http://localhost:9001`ï¼ˆç”¨æˆ·å/å¯†ç : minioadminï¼‰
- **API ç«¯ç‚¹**: `http://localhost:9000`
- **æ•°æ®æŒä¹…åŒ–**: ä½¿ç”¨ Docker volume

#### 3. Milvusï¼ˆå‘é‡æ•°æ®åº“ï¼‰

```yaml
milvus:
  image: milvusdb/milvus:v2.3.0
  ports:
    - "19530:19530"  # gRPC ç«¯å£
    - "9091:9091"    # ç®¡ç†ç«¯å£
  environment:
    - ETCD_ENDPOINTS=etcd:2379
    - MINIO_ADDRESS=minio:9000
  volumes:
    - milvus_data:/var/lib/milvus
  depends_on:
    - etcd
    - minio
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
    interval: 30s
    timeout: 20s
    retries: 5
```

**é…ç½®è¯´æ˜**:
- **gRPC ç«¯å£**: 19530ï¼ˆPython å®¢æˆ·ç«¯è¿æ¥ï¼‰
- **ç®¡ç†ç«¯å£**: 9091ï¼ˆå¥åº·æ£€æŸ¥ï¼‰
- **ä¾èµ–æœåŠ¡**: å¿…é¡»å…ˆå¯åŠ¨ etcd å’Œ MinIO
- **å¥åº·æ£€æŸ¥**: æ¯ 30 ç§’æ£€æŸ¥ä¸€æ¬¡

### å¯åŠ¨å‘½ä»¤

#### æ–¹æ³• 1ï¼šå¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
cd docker
docker-compose -f docker-compose.dev.yml up -d
```

#### æ–¹æ³• 2ï¼šä»…å¯åŠ¨ Milvus æ ˆ

```bash
cd docker
docker-compose -f docker-compose.dev.yml up -d etcd minio milvus
```

### éªŒè¯æ­¥éª¤

```bash
# 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.dev.yml ps

# 2. æŸ¥çœ‹ Milvus æ—¥å¿—
docker logs qingyu-milvus

# 3. æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost:9091/healthz

# 4. è®¿é—® MinIO æ§åˆ¶å°
# æµè§ˆå™¨æ‰“å¼€: http://localhost:9001
# ç”¨æˆ·å: minioadmin, å¯†ç : minioadmin

# 5. æµ‹è¯•ç«¯å£è¿é€šæ€§
nc -zv localhost 19530  # Milvus gRPC
nc -zv localhost 2379   # etcd
nc -zv localhost 9000   # MinIO API
```

### å·²çŸ¥é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

#### é—®é¢˜ 1: Docker é•œåƒæ‹‰å–å¤±è´¥

**ç—‡çŠ¶**:
```
failed commit on ref "unknown-sha256:..." failed size validation
```

**åŸå› **: Docker é•œåƒå±‚ç¼“å­˜æŸå

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ¸…ç† Docker ç¼“å­˜
docker system prune -af

# æ‰‹åŠ¨æ‹‰å–é•œåƒ
docker pull quay.io/coreos/etcd:v3.5.5
docker pull minio/minio:RELEASE.2023-10-07T20-54-22Z
docker pull milvusdb/milvus:v2.3.0

# é‡æ–°å¯åŠ¨æœåŠ¡
docker-compose -f docker-compose.dev.yml up -d
```

#### é—®é¢˜ 2: Milvus å¯åŠ¨ç¼“æ…¢

**ç—‡çŠ¶**: Milvus å®¹å™¨å¯åŠ¨åé•¿æ—¶é—´å¤„äº `starting` çŠ¶æ€

**åŸå› **: é¦–æ¬¡å¯åŠ¨éœ€è¦åˆå§‹åŒ– etcd å’Œ MinIO è¿æ¥

**è§£å†³æ–¹æ¡ˆ**:
- ç­‰å¾… 90 ç§’ï¼ˆhealthcheck start_periodï¼‰
- æ£€æŸ¥ etcd å’Œ MinIO æ˜¯å¦æ­£å¸¸è¿è¡Œ
- æŸ¥çœ‹æ—¥å¿—æ’æŸ¥é”™è¯¯ï¼š`docker logs qingyu-milvus`

---

## ğŸ’¾ MilvusClient å®ç°

### Collection Schema è®¾è®¡

**æ–‡ä»¶**: `python_ai_service/src/rag/milvus_client.py`

#### Schema ç»“æ„

| å­—æ®µå | æ•°æ®ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|---------|------|------|
| `id` | VARCHAR(200) | ä¸»é”®ï¼Œæ–‡æ¡£å”¯ä¸€æ ‡è¯† | `"uuid-..."` |
| `text` | VARCHAR(65535) | åŸå§‹æ–‡æœ¬å†…å®¹ | `"é’ç¾½å†™ä½œå¹³å°æ˜¯..."` |
| `vector` | FLOAT_VECTOR | å‘é‡æ•°æ®ï¼ˆ1024ç»´ï¼‰ | `[0.12, -0.34, ...]` |
| `source` | VARCHAR(100) | æ¥æºæ ‡è¯† | `"project"`, `"chapter"` |
| `metadata` | JSON | æ‰©å±•å…ƒæ•°æ® | `{"author": "...", "time": "..."}` |

**è®¾è®¡è€ƒé‡**:
- **VARCHAR å­˜å‚¨æ–‡æœ¬**: æ”¯æŒä¸­æ–‡ï¼Œæœ€å¤§é•¿åº¦ 65535 å­—ç¬¦
- **JSON å…ƒæ•°æ®**: çµæ´»æ‰©å±•ï¼Œæ”¯æŒåµŒå¥—ç»“æ„
- **å‘é‡ç»´åº¦**: 1024ï¼ˆBGE-large-zh-v1.5 æ¨¡å‹è¾“å‡ºï¼‰
- **ä¸»é”® ID**: ä½¿ç”¨ UUID ç¡®ä¿å…¨å±€å”¯ä¸€æ€§

### ç´¢å¼•ç­–ç•¥é€‰æ‹©

#### IVF_FLAT ç´¢å¼•

**é…ç½®**:
```python
index_params = {
    "metric_type": "IP",        # å†…ç§¯ç›¸ä¼¼åº¦
    "index_type": "IVF_FLAT",   # å€’æ’æ–‡ä»¶ç´¢å¼•
    "params": {"nlist": 128}    # èšç±»ä¸­å¿ƒæ•°é‡
}
```

**æ€§èƒ½ç‰¹ç‚¹**:
- **æŸ¥è¯¢æ—¶é—´**: O(nlist + top_k)
- **æ„å»ºæ—¶é—´**: O(n * d * nlist)ï¼ˆå…¶ä¸­ n=å‘é‡æ•°ï¼Œd=ç»´åº¦ï¼‰
- **å†…å­˜å ç”¨**: O(n * d)ï¼ˆå…¨é‡å‘é‡ï¼‰
- **å‡†ç¡®ç‡**: 100%ï¼ˆç²¾ç¡®æŸ¥è¯¢ï¼‰

**é€‚ç”¨åœºæ™¯**:
- âœ… å‘é‡æ•°é‡: <100ä¸‡
- âœ… ç»´åº¦: 1024
- âœ… å¯¹å‡†ç¡®ç‡è¦æ±‚é«˜
- âŒ è¶…å¤§è§„æ¨¡æ•°æ®ï¼ˆå»ºè®®ä½¿ç”¨ IVF_SQ8 æˆ– HNSWï¼‰

**nlist é€‰æ‹©**:
- æ•°æ®é‡ 1ä¸‡: nlist=64
- æ•°æ®é‡ 10ä¸‡: nlist=128 âœ…ï¼ˆå½“å‰ï¼‰
- æ•°æ®é‡ 100ä¸‡: nlist=1024
- å…¬å¼: `nlist â‰ˆ sqrt(n)`

**metric_type é€‰æ‹©**: IPï¼ˆå†…ç§¯ï¼‰
- **å‰æ**: å‘é‡å·²å½’ä¸€åŒ–ï¼ˆL2 norm = 1ï¼‰
- **ç­‰ä»·**: å½’ä¸€åŒ–åï¼ŒIP = cosine similarity
- **ä¼˜åŠ¿**: è®¡ç®—é€Ÿåº¦å¿«ï¼ˆçœç•¥é™¤æ³•ï¼‰

### æ ¸å¿ƒæ–¹æ³•å®ç°ç»†èŠ‚

#### 1. `create_collection()`

**åŠŸèƒ½**: åˆ›å»º Collection å’Œç´¢å¼•

**å®ç°æµç¨‹**:
```python
def create_collection(self, dimension: int = 1024) -> None:
    # 1. å®šä¹‰ Schemaï¼ˆ5ä¸ªå­—æ®µï¼‰
    fields = [FieldSchema(...), ...]
    schema = CollectionSchema(fields=fields)
    
    # 2. åˆ›å»º Collection
    self.collection = Collection(name=self.collection_name, schema=schema)
    
    # 3. åˆ›å»ºç´¢å¼•ï¼ˆvector å­—æ®µï¼‰
    self.collection.create_index(field_name="vector", index_params=...)
    
    # 4. åŠ è½½åˆ°å†…å­˜ï¼ˆå¿…é¡»ï¼å¦åˆ™æ— æ³•æŸ¥è¯¢ï¼‰
    self.collection.load()
```

**å…³é”®ç‚¹**:
- âœ… å¿…é¡»è°ƒç”¨ `load()` æ‰èƒ½æ‰§è¡ŒæŸ¥è¯¢
- âœ… ç´¢å¼•åœ¨æ’å…¥æ•°æ®å‰åˆ›å»ºï¼ˆæé«˜é¦–æ¬¡æŸ¥è¯¢é€Ÿåº¦ï¼‰
- âœ… Schema ä¸€æ—¦åˆ›å»ºä¸å¯ä¿®æ”¹ï¼ˆéœ€åˆ é™¤é‡å»ºï¼‰

#### 2. `insert()`

**åŠŸèƒ½**: æ‰¹é‡æ’å…¥å‘é‡

**å®ç°æµç¨‹**:
```python
def insert(self, texts, vectors, metadata) -> List[str]:
    # 1. ç”Ÿæˆ UUIDï¼ˆä¿è¯å”¯ä¸€æ€§ï¼‰
    ids = [str(uuid.uuid4()) for _ in texts]
    
    # 2. æå– source å­—æ®µ
    sources = [meta.get("source", "unknown") for meta in metadata]
    
    # 3. æ„å»ºæ‰¹é‡æ•°æ®ï¼ˆæŒ‰ Schema é¡ºåºï¼‰
    entities = [ids, texts, vectors, sources, metadata]
    
    # 4. æ’å…¥å¹¶åˆ·æ–°
    self.collection.insert(entities)
    self.collection.flush()  # ç¡®ä¿æŒä¹…åŒ–
    
    return ids
```

**æ€§èƒ½ä¼˜åŒ–**:
- âœ… æ‰¹é‡æ’å…¥ï¼ˆå‡å°‘ç½‘ç»œå¼€é”€ï¼‰
- âœ… å¼‚æ­¥åˆ·æ–°ï¼ˆ`flush()` å¯å¼‚æ­¥ï¼‰
- âš ï¸  å»ºè®®å•æ‰¹ <5000 æ¡ï¼ˆé¿å…å†…å­˜æº¢å‡ºï¼‰

#### 3. `search()`

**åŠŸèƒ½**: å‘é‡æ£€ç´¢

**å®ç°æµç¨‹**:
```python
def search(self, query_vector, top_k=10, filters=None):
    # 1. æ„å»ºæœç´¢å‚æ•°
    search_params = {"metric_type": "IP", "params": {"nprobe": 10}}
    
    # 2. æ„å»ºè¿‡æ»¤è¡¨è¾¾å¼ï¼ˆå¯é€‰ï¼‰
    expr = 'source == "project"' if filters else None
    
    # 3. æ‰§è¡Œæœç´¢
    results = self.collection.search(
        data=[query_vector],
        anns_field="vector",
        param=search_params,
        limit=top_k,
        expr=expr,
        output_fields=["id", "text", "source", "metadata"]
    )
    
    # 4. è§£æç»“æœ
    return [{
        "id": hit.entity.get("id"),
        "text": hit.entity.get("text"),
        "score": hit.score  # ç›¸ä¼¼åº¦åˆ†æ•°
    } for hits in results for hit in hits]
```

**nprobe å‚æ•°**:
- **å«ä¹‰**: æœç´¢æ—¶æŸ¥è¯¢çš„èšç±»ä¸­å¿ƒæ•°é‡
- **èŒƒå›´**: 1 ~ nlistï¼ˆ128ï¼‰
- **æ¨èå€¼**: 10ï¼ˆå¹³è¡¡é€Ÿåº¦å’Œå‡†ç¡®ç‡ï¼‰
- **æƒè¡¡**: nprobe â†‘ â†’ å‡†ç¡®ç‡ â†‘ï¼Œé€Ÿåº¦ â†“

**è¿‡æ»¤è¡¨è¾¾å¼**:
```python
# å•æ¡ä»¶
'source == "project"'

# å¤šæ¡ä»¶ AND
'source == "project" and metadata["priority"] > 5'

# å¤šæ¡ä»¶ OR
'source in ["project", "chapter"]'

# æ³¨æ„ï¼šJSON å­—æ®µä½¿ç”¨ metadata["key"] è®¿é—®
```

#### 4. `delete()`

**åŠŸèƒ½**: æ‰¹é‡åˆ é™¤å‘é‡

**å®ç°æµç¨‹**:
```python
def delete(self, ids: List[str]) -> None:
    # æ„å»º IN è¡¨è¾¾å¼
    ids_str = ", ".join([f'"{id}"' for id in ids])
    expr = f"id in [{ids_str}]"
    
    # æ‰§è¡Œåˆ é™¤
    self.collection.delete(expr)
    self.collection.flush()
```

**æ³¨æ„äº‹é¡¹**:
- âš ï¸  åˆ é™¤ä¸æ˜¯å³æ—¶çš„ï¼ˆéœ€è¦ flushï¼‰
- âš ï¸  å¤§æ‰¹é‡åˆ é™¤ï¼ˆ>10ä¸‡ï¼‰å»ºè®®åˆ†æ‰¹
- âœ… å¯ä»¥é€šè¿‡ `metadata` å­—æ®µæ‰¹é‡åˆ é™¤

### æ€§èƒ½ä¼˜åŒ–æŠ€å·§

#### 1. æ‰¹é‡æ“ä½œ

```python
# âŒ ä¸æ¨èï¼šé€æ¡æ’å…¥
for text, vector in zip(texts, vectors):
    client.insert([text], [vector], [{}])

# âœ… æ¨èï¼šæ‰¹é‡æ’å…¥
client.insert(texts, vectors, metadata_list)
```

**æ€§èƒ½æå‡**: 10-50å€

#### 2. Collection é¢„åŠ è½½

```python
# åº”ç”¨å¯åŠ¨æ—¶é¢„åŠ è½½ Collection
@app.on_event("startup")
async def startup():
    milvus_client.connect()
    milvus_client.create_collection()  # å¦‚æœå·²å­˜åœ¨ä¼šè·³è¿‡
```

**å¥½å¤„**: é¿å…é¦–æ¬¡æŸ¥è¯¢æ—¶åŠ è½½å»¶è¿Ÿï¼ˆå¯èƒ½ 5-30ç§’ï¼‰

#### 3. å¼‚æ­¥åˆ·æ–°

```python
# æ’å…¥åä¸ç«‹å³åˆ·æ–°ï¼ˆé€‚åˆæ‰¹é‡å†™å…¥ï¼‰
for batch in batches:
    client.collection.insert(batch)

# æœ€åç»Ÿä¸€åˆ·æ–°
client.collection.flush()
```

**æ€§èƒ½æå‡**: 5-10å€ï¼ˆå‡å°‘ I/O æ¬¡æ•°ï¼‰

---

## ğŸ¤– EmbeddingService å®ç°

### BGE æ¨¡å‹ä»‹ç»

**æ¨¡å‹åç§°**: `BAAI/bge-large-zh-v1.5`

**æŠ€æœ¯è§„æ ¼**:
- **ç»´åº¦**: 1024
- **è¯­è¨€**: ä¸­æ–‡ä¼˜åŒ–
- **æœ€å¤§åºåˆ—é•¿åº¦**: 512 tokens
- **æ¨¡å‹å¤§å°**: ~1.3GB
- **æ¨ç†é€Ÿåº¦**: ~50-100 æ–‡æœ¬/ç§’ï¼ˆCPUï¼‰ï¼Œ~500-1000 æ–‡æœ¬/ç§’ï¼ˆGPUï¼‰

**é€‚ç”¨åœºæ™¯**:
- âœ… ä¸­æ–‡è¯­ä¹‰æ£€ç´¢
- âœ… æ–‡æ¡£ç›¸ä¼¼åº¦è®¡ç®—
- âœ… é—®ç­”ç³»ç»Ÿ
- âœ… æ–‡æœ¬èšç±»

**æ€§èƒ½æŒ‡æ ‡**ï¼ˆMTEB ä¸­æ–‡æ¦œå•ï¼‰:
- **æ£€ç´¢ä»»åŠ¡**: 65.7ï¼ˆAvgï¼‰
- **ç›¸ä¼¼åº¦ä»»åŠ¡**: 70.3ï¼ˆAvgï¼‰
- **ç»¼åˆæ’å**: Top 5ï¼ˆä¸­æ–‡æ¨¡å‹ï¼‰

### åŠ è½½å’Œä¼˜åŒ–

**æ–‡ä»¶**: `python_ai_service/src/rag/embedding_service.py`

#### æ¨¡å‹åŠ è½½æµç¨‹

```python
def load_model(self) -> None:
    # 1. ä¸‹è½½æ¨¡å‹ï¼ˆé¦–æ¬¡éœ€è¦ç½‘ç»œï¼‰
    self.model = SentenceTransformer(self.model_name)
    
    # 2. è®¾å¤‡è‡ªåŠ¨æ£€æµ‹
    if self.device == "cuda" and not torch.cuda.is_available():
        self.device = "cpu"  # å›é€€
    
    self.model.to(self.device)
    
    # 3. è®¾ç½®è¯„ä¼°æ¨¡å¼ï¼ˆç¦ç”¨ dropoutï¼‰
    self.model.eval()
    
    # 4. é¢„çƒ­æ¨¡å‹ï¼ˆåŠ è½½æƒé‡åˆ°å†…å­˜ï¼‰
    _ = self.model.encode(["é¢„çƒ­"], convert_to_numpy=True)
```

**é¦–æ¬¡ä¸‹è½½**:
- ä½ç½®: `~/.cache/huggingface/`ï¼ˆLinux/Macï¼‰æˆ– `C:\Users\<user>\.cache\huggingface\`ï¼ˆWindowsï¼‰
- å¤§å°: ~1.3GB
- æ—¶é—´: 3-10 åˆ†é’Ÿï¼ˆå–å†³äºç½‘ç»œé€Ÿåº¦ï¼‰

**åŠ é€ŸæŠ€å·§**:
- ä½¿ç”¨å›½å†…é•œåƒ: `export HF_ENDPOINT=https://hf-mirror.com`
- ç¦»çº¿æ¨¡å¼: é¢„å…ˆä¸‹è½½æ¨¡å‹åˆ°æœ¬åœ°ç›®å½•

#### CPU vs GPU æ€§èƒ½å¯¹æ¯”

| è®¾å¤‡ | æ‰¹é‡å¤§å° | ååé‡ | å»¶è¿Ÿï¼ˆå•æ¡ï¼‰ | å†…å­˜å ç”¨ |
|------|---------|--------|-------------|---------|
| CPU (8æ ¸) | 32 | 50-100 æ–‡æœ¬/ç§’ | 10-20ms | ~3GB |
| GPU (RTX 3060) | 128 | 500-1000 æ–‡æœ¬/ç§’ | 1-2ms | ~4GB |
| GPU (A100) | 256 | 2000-3000 æ–‡æœ¬/ç§’ | <1ms | ~5GB |

**å»ºè®®**:
- **å¼€å‘ç¯å¢ƒ**: CPUï¼ˆæœ¬åœ°æµ‹è¯•ï¼‰
- **ç”Ÿäº§ç¯å¢ƒ**: GPUï¼ˆé«˜å¹¶å‘ï¼‰
- **å°è§„æ¨¡éƒ¨ç½²**: CPUï¼ˆæˆæœ¬ä½ï¼‰

### æ‰¹é‡å¤„ç†ç­–ç•¥

#### æœ€ä½³æ‰¹é‡å¤§å°

**å®ç°**:
```python
def embed_texts(self, texts: List[str]) -> List[List[float]]:
    # è‡ªåŠ¨æ‰¹å¤„ç†
    embeddings = self.model.encode(
        texts,
        batch_size=self.batch_size,  # 32ï¼ˆé»˜è®¤ï¼‰
        convert_to_numpy=True,
        normalize_embeddings=True,
        show_progress_bar=len(texts) > 100
    )
    return embeddings.tolist()
```

**batch_size é€‰æ‹©**:
| è®¾å¤‡ | æ¨èå€¼ | æœ€å¤§å€¼ | å†…å­˜é™åˆ¶ |
|------|-------|--------|---------|
| CPU | 16-32 | 64 | 8GB RAM |
| GPU (6GB) | 64-128 | 256 | 6GB VRAM |
| GPU (12GB) | 128-256 | 512 | 12GB VRAM |

**æƒè¡¡**:
- batch_size â†‘ â†’ ååé‡ â†‘ï¼Œå»¶è¿Ÿ â†‘
- batch_size â†“ â†’ å»¶è¿Ÿ â†“ï¼Œååé‡ â†“

#### æ–‡æœ¬é¢„å¤„ç†

```python
# å»é™¤å¤šä½™ç©ºæ ¼å’Œæ¢è¡Œ
cleaned_texts = [" ".join(text.split()) for text in texts]

# æˆªæ–­è¶…é•¿æ–‡æœ¬ï¼ˆ512 tokensï¼‰
# SentenceTransformer ä¼šè‡ªåŠ¨æˆªæ–­ï¼Œä½†æœ€å¥½æ‰‹åŠ¨å¤„ç†
```

**æ³¨æ„äº‹é¡¹**:
- âš ï¸  è¶…é•¿æ–‡æœ¬ä¼šè¢«è‡ªåŠ¨æˆªæ–­ï¼ˆå¯èƒ½ä¸¢å¤±ä¿¡æ¯ï¼‰
- âœ… å»ºè®®å…ˆåˆ†æ®µï¼šå•æ®µ <200 å­—ç¬¦
- âœ… ä¿ç•™é‡è¦ä¿¡æ¯åœ¨å‰åŠéƒ¨åˆ†

#### L2 å½’ä¸€åŒ–

**ç›®çš„**: å°†å‘é‡å½’ä¸€åŒ–åˆ°å•ä½çƒé¢ï¼ˆ||v|| = 1ï¼‰

**å®ç°**:
```python
embeddings = self.model.encode(
    texts,
    normalize_embeddings=True  # L2 å½’ä¸€åŒ–
)
```

**å…¬å¼**:
```
normalized_v = v / ||v||
å…¶ä¸­ ||v|| = sqrt(v1^2 + v2^2 + ... + vn^2)
```

**å¥½å¤„**:
- âœ… å†…ç§¯ç›¸ä¼¼åº¦ = ä½™å¼¦ç›¸ä¼¼åº¦
- âœ… è®¡ç®—é€Ÿåº¦æ›´å¿«ï¼ˆçœç•¥é™¤æ³•ï¼‰
- âœ… æ•°å€¼ç¨³å®šæ€§æ›´å¥½

---

## ğŸ§ª é›†æˆæµ‹è¯•

### æµ‹è¯•ç”¨ä¾‹è¯´æ˜

**æ–‡ä»¶**: `python_ai_service/tests/test_milvus_integration.py`

#### æµ‹è¯•æ•°æ®

```python
TEST_TEXTS = [
    "é’ç¾½å†™ä½œå¹³å°æ˜¯ä¸€ä¸ª AI è¾…åŠ©å†™ä½œåº”ç”¨",
    "æ”¯æŒç”¨æˆ·ç®¡ç†ã€æ–‡æ¡£å­˜å‚¨ã€AI æ–‡æœ¬ç”Ÿæˆç­‰åŠŸèƒ½",
    "é‡‡ç”¨ç°ä»£åŒ–åˆ†å±‚æ¶æ„å’Œè®¾è®¡æ¨¡å¼"
]
```

**è¦†ç›–åœºæ™¯**:
- ä¸­æ–‡æ–‡æœ¬
- ä¸åŒé•¿åº¦
- è¯­ä¹‰ç›¸å…³æ€§

#### æµ‹è¯•ç”¨ä¾‹çŸ©é˜µ

| æµ‹è¯•ç”¨ä¾‹ | åŠŸèƒ½ | éªŒè¯ç‚¹ | é¢„æœŸç»“æœ |
|---------|------|--------|---------|
| `test_milvus_connection` | è¿æ¥æµ‹è¯• | å¥åº·æ£€æŸ¥ | `True` |
| `test_create_collection` | Collection åˆ›å»º | Collection å¯¹è±¡ | éç©º |
| `test_insert_vectors` | å‘é‡æ’å…¥ | è¿”å› ID æ•°é‡ | ç­‰äºè¾“å…¥æ•°é‡ |
| `test_search_vectors` | å‘é‡æ£€ç´¢ | Top-1 åŒ¹é… | ç›¸ä¼¼åº¦ >0.99 |
| `test_delete_vectors` | å‘é‡åˆ é™¤ | å‰©ä½™æ•°é‡ | åŸå§‹-1 |
| `test_embedding_service` | å‘é‡åŒ–æœåŠ¡ | å‘é‡ç»´åº¦ | 1024 |
| `test_end_to_end_rag` | ç«¯åˆ°ç«¯ RAG | æ£€ç´¢å‡†ç¡®æ€§ | åŒ…å«å…³é”®è¯ |

### æµ‹è¯•ç»“æœï¼ˆé¢„æœŸï¼‰

#### è¿è¡Œå‘½ä»¤

```bash
cd python_ai_service

# å®‰è£…ä¾èµ–
poetry install

# å¯åŠ¨ Milvus æœåŠ¡
cd ../docker
docker-compose -f docker-compose.dev.yml up -d milvus

# è¿è¡Œæµ‹è¯•
cd ../python_ai_service
poetry run pytest tests/test_milvus_integration.py -v -m integration
```

#### é¢„æœŸè¾“å‡º

```
tests/test_milvus_integration.py::TestMilvusIntegration::test_milvus_connection PASSED
tests/test_milvus_integration.py::TestMilvusIntegration::test_create_collection PASSED
tests/test_milvus_integration.py::TestMilvusIntegration::test_insert_vectors PASSED
tests/test_milvus_integration.py::TestMilvusIntegration::test_search_vectors PASSED
tests/test_milvus_integration.py::TestMilvusIntegration::test_delete_vectors PASSED
tests/test_milvus_integration.py::TestMilvusIntegration::test_embedding_service PASSED
tests/test_milvus_integration.py::TestMilvusIntegration::test_end_to_end_rag PASSED [SLOW]

========================== 7 passed in 12.34s ==========================
```

### æ€§èƒ½æŒ‡æ ‡ï¼ˆé¢„æœŸï¼‰

| æŒ‡æ ‡ | CPU | GPU | è¯´æ˜ |
|------|-----|-----|------|
| æ¨¡å‹åŠ è½½æ—¶é—´ | 3-5ç§’ | 2-3ç§’ | é¦–æ¬¡éœ€ä¸‹è½½ |
| å‘é‡åŒ–é€Ÿåº¦ï¼ˆæ‰¹é‡32ï¼‰ | 0.5ç§’ | 0.1ç§’ | 32 æ–‡æœ¬ |
| æ’å…¥é€Ÿåº¦ | 100ms | 50ms | 32 å‘é‡ |
| æ£€ç´¢é€Ÿåº¦ | 10-20ms | 5-10ms | Top-10 |

---

## ğŸ“š ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿå¼€å§‹

#### æ­¥éª¤ 1ï¼šå¯åŠ¨ Milvus

```bash
cd docker
docker-compose -f docker-compose.dev.yml up -d milvus
```

#### æ­¥éª¤ 2ï¼šPython ç¯å¢ƒ

```bash
cd python_ai_service
poetry install
```

#### æ­¥éª¤ 3ï¼šç¼–å†™ä»£ç 

```python
from src.rag.milvus_client import MilvusClient
from src.rag.embedding_service import EmbeddingService

# 1. åˆå§‹åŒ–æœåŠ¡
milvus_client = MilvusClient()
milvus_client.connect()

embedding_service = EmbeddingService()
embedding_service.load_model()

# 2. åˆ›å»º Collection
dimension = embedding_service.get_dimension()
milvus_client.create_collection(dimension=dimension)

# 3. å‡†å¤‡æ•°æ®
texts = ["æ–‡æœ¬1", "æ–‡æœ¬2", "æ–‡æœ¬3"]
vectors = embedding_service.embed_texts(texts)
metadata = [{"source": "test", "idx": i} for i in range(len(texts))]

# 4. æ’å…¥å‘é‡
ids = milvus_client.insert(texts, vectors, metadata)
print(f"æ’å…¥æˆåŠŸï¼ŒID: {ids}")

# 5. æ£€ç´¢
query = "æŸ¥è¯¢æ–‡æœ¬"
query_vector = embedding_service.embed_query(query)
results = milvus_client.search(query_vector, top_k=5)

# 6. å±•ç¤ºç»“æœ
for i, result in enumerate(results):
    print(f"Top-{i+1}: {result['text']} (Score: {result['score']:.4f})")
```

### API ç¤ºä¾‹

#### 1. åŸºç¡€æ£€ç´¢

```python
# ç®€å•æŸ¥è¯¢
results = milvus_client.search(query_vector, top_k=10)
```

#### 2. å¸¦è¿‡æ»¤æ¡ä»¶çš„æ£€ç´¢

```python
# åªæ£€ç´¢ç‰¹å®šæ¥æºçš„æ–‡æ¡£
filters = {"source": "project"}
results = milvus_client.search(query_vector, top_k=10, filters=filters)
```

#### 3. æ‰¹é‡æ’å…¥

```python
# åˆ†æ‰¹æ’å…¥å¤§é‡æ•°æ®
batch_size = 1000
for i in range(0, len(all_texts), batch_size):
    batch_texts = all_texts[i:i+batch_size]
    batch_vectors = embedding_service.embed_texts(batch_texts)
    batch_metadata = all_metadata[i:i+batch_size]
    
    ids = milvus_client.insert(batch_texts, batch_vectors, batch_metadata)
    print(f"å·²æ’å…¥ {len(ids)} æ¡æ•°æ®")
```

#### 4. æ ¹æ®å…ƒæ•°æ®åˆ é™¤

```python
# åˆ é™¤ç‰¹å®šé¡¹ç›®çš„æ‰€æœ‰æ•°æ®
project_id = "project-123"
# æ³¨æ„ï¼šéœ€è¦å…ˆæŸ¥è¯¢è·å– ID
results = milvus_client.search(
    query_vector=[0]*1024,  # ä»»æ„å‘é‡
    top_k=10000,
    filters={"source": f"project-{project_id}"}
)
ids_to_delete = [r["id"] for r in results]
milvus_client.delete(ids_to_delete)
```

### æ•…éšœæ’æŸ¥

#### é—®é¢˜ 1ï¼šè¿æ¥å¤±è´¥

**ç—‡çŠ¶**:
```python
MilvusConnectionError: Failed to connect to Milvus
```

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥ Milvus æ˜¯å¦è¿è¡Œï¼š`docker ps | grep milvus`
2. æ£€æŸ¥ç«¯å£ï¼š`nc -zv localhost 19530`
3. æŸ¥çœ‹æ—¥å¿—ï¼š`docker logs qingyu-milvus`
4. éªŒè¯é…ç½®ï¼š`settings.milvus_host` å’Œ `settings.milvus_port`

#### é—®é¢˜ 2ï¼šæ¨¡å‹ä¸‹è½½å¤±è´¥

**ç—‡çŠ¶**:
```python
OSError: Can't load model BAAI/bge-large-zh-v1.5
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# ä½¿ç”¨å›½å†…é•œåƒ
export HF_ENDPOINT=https://hf-mirror.com

# æ‰‹åŠ¨ä¸‹è½½
git lfs install
git clone https://huggingface.co/BAAI/bge-large-zh-v1.5

# ä½¿ç”¨æœ¬åœ°è·¯å¾„
embedding_service = EmbeddingService()
embedding_service.model_name = "/path/to/bge-large-zh-v1.5"
embedding_service.load_model()
```

#### é—®é¢˜ 3ï¼šOOMï¼ˆå†…å­˜æº¢å‡ºï¼‰

**ç—‡çŠ¶**:
```
RuntimeError: CUDA out of memory
```

**è§£å†³æ–¹æ¡ˆ**:
```python
# æ–¹æ³• 1ï¼šå‡å° batch_size
embedding_service.batch_size = 16  # é»˜è®¤ 32

# æ–¹æ³• 2ï¼šä½¿ç”¨ CPU
embedding_service.device = "cpu"

# æ–¹æ³• 3ï¼šåˆ†æ‰¹å¤„ç†
def embed_in_batches(texts, max_batch=100):
    all_embeddings = []
    for i in range(0, len(texts), max_batch):
        batch = texts[i:i+max_batch]
        embeddings = embedding_service.embed_texts(batch)
        all_embeddings.extend(embeddings)
    return all_embeddings
```

#### é—®é¢˜ 4ï¼šæ£€ç´¢ç»“æœä¸å‡†ç¡®

**å¯èƒ½åŸå› **:
1. å‘é‡æœªå½’ä¸€åŒ–
2. nprobe è®¾ç½®è¿‡å°
3. ç´¢å¼•ç±»å‹ä¸åˆé€‚

**è§£å†³æ–¹æ¡ˆ**:
```python
# 1. ç¡®ä¿å½’ä¸€åŒ–
embeddings = self.model.encode(
    texts,
    normalize_embeddings=True  # â† å¿…é¡»
)

# 2. å¢åŠ  nprobe
search_params = {
    "metric_type": "IP",
    "params": {"nprobe": 20}  # ä» 10 å¢åŠ åˆ° 20
}

# 3. éªŒè¯ç´¢å¼•
collection.describe_index("vector")
```

---

## ğŸš€ åç»­è§„åˆ’

### é˜¶æ®µ 2.1ï¼šå‘é‡åŒ–å¼•æ“å®Œå–„ï¼ˆWeek 2ï¼‰

**ä»»åŠ¡**:
- [ ] æ”¯æŒå¤šæ¨¡å‹åˆ‡æ¢ï¼ˆBGE/OpenAI Embedding/è‡ªå®šä¹‰ï¼‰
- [ ] å®ç°æ¨¡å‹ç¼“å­˜æœºåˆ¶
- [ ] æ·»åŠ æ–‡æœ¬åˆ†å—é€»è¾‘ï¼ˆé•¿æ–‡æœ¬ â†’å¤šå‘é‡ï¼‰
- [ ] ä¼˜åŒ–æ‰¹å¤„ç†æ€§èƒ½

**é¢„æœŸæå‡**:
- ååé‡æå‡ 50%
- æ”¯æŒæœ€å¤§æ–‡æœ¬é•¿åº¦ 10,000 å­—ç¬¦

### é˜¶æ®µ 2.2ï¼šç»“æ„åŒ– RAG å®ç°ï¼ˆWeek 3ï¼‰

**ä»»åŠ¡**:
- [ ] å®ç° RAGPipeline ç±»
- [ ] é›†æˆ Rerankerï¼ˆé‡æ’åºæ¨¡å‹ï¼‰
- [ ] å®ç°æ··åˆæ£€ç´¢ï¼ˆå‘é‡ + å…³é”®è¯ï¼‰
- [ ] æ·»åŠ ç¼“å­˜å±‚ï¼ˆRedisï¼‰

**åŠŸèƒ½**:
- æ£€ç´¢å‡†ç¡®ç‡æå‡ 20%
- æ”¯æŒå¤æ‚æŸ¥è¯¢ï¼ˆå¤šæ¡ä»¶ã€èŒƒå›´è¿‡æ»¤ï¼‰

### é˜¶æ®µ 2.3ï¼šäº‹ä»¶é©±åŠ¨ç´¢å¼•æ›´æ–°ï¼ˆWeek 4ï¼‰

**ä»»åŠ¡**:
- [ ] ç›‘å¬ Go åç«¯äº‹ä»¶ï¼ˆé¡¹ç›®åˆ›å»ºã€æ–‡æ¡£æ›´æ–°ï¼‰
- [ ] è‡ªåŠ¨è§¦å‘å‘é‡åŒ–å’Œç´¢å¼•
- [ ] å®ç°å¢é‡æ›´æ–°ï¼ˆé¿å…å…¨é‡é‡å»ºï¼‰
- [ ] æ·»åŠ ç´¢å¼•ä»»åŠ¡é˜Ÿåˆ—

**é›†æˆç‚¹**:
- Go EventBus â†’ Python gRPC â†’ Milvus æ›´æ–°
- å®æ—¶æ€§ï¼š<1 ç§’

---

## âœ… éªŒæ”¶æ ‡å‡†

### ä»£ç è´¨é‡

- [x] MilvusClient æ ¸å¿ƒæ–¹æ³•å®ç°
- [x] EmbeddingService æ ¸å¿ƒæ–¹æ³•å®ç°
- [x] é›†æˆæµ‹è¯•ç”¨ä¾‹ç¼–å†™
- [x] ä»£ç æ³¨é‡Šå®Œæ•´
- [x] æ— æ˜æ˜¾æ€§èƒ½é—®é¢˜

### åŠŸèƒ½å®Œæ•´æ€§

- [x] Collection åˆ›å»ºæˆåŠŸ
- [x] å‘é‡æ’å…¥æ— é”™è¯¯
- [x] æ£€ç´¢è¿”å›æ­£ç¡®ç»“æœ
- [x] å‘é‡åˆ é™¤åŠŸèƒ½æ­£å¸¸
- [x] å¥åº·æ£€æŸ¥æ–‡æ¡£åŒ–

### æ–‡æ¡£å®Œæ•´æ€§

- [x] Docker éƒ¨ç½²æŒ‡å—
- [x] ä½¿ç”¨ç¤ºä¾‹ä»£ç 
- [x] æ•…éšœæ’æŸ¥æ‰‹å†Œ
- [x] åç»­è§„åˆ’æ¸…æ™°

### å¾…å®Œæˆï¼ˆDocker éªŒè¯ï¼‰

- [ ] Docker æœåŠ¡å…¨éƒ¨å¥åº·è¿è¡Œ
- [ ] æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡

---

## ğŸ“ é™„å½•

### ç›¸å…³æ–‡ä»¶æ¸…å•

#### æ ¸å¿ƒä»£ç 

- `python_ai_service/src/rag/milvus_client.py` - Milvus å®¢æˆ·ç«¯ï¼ˆ~250è¡Œï¼‰
- `python_ai_service/src/rag/embedding_service.py` - å‘é‡åŒ–æœåŠ¡ï¼ˆ~135è¡Œï¼‰
- `python_ai_service/tests/test_milvus_integration.py` - é›†æˆæµ‹è¯•ï¼ˆ~180è¡Œï¼‰
- `python_ai_service/src/api/health.py` - å¥åº·æ£€æŸ¥ï¼ˆæ›´æ–°ï¼‰

#### é…ç½®æ–‡ä»¶

- `docker/docker-compose.dev.yml` - Docker é…ç½®
- `python_ai_service/src/core/config.py` - Python é…ç½®
- `python_ai_service/.env.example` - ç¯å¢ƒå˜é‡ç¤ºä¾‹

#### æ–‡æ¡£

- `doc/implementation/00è¿›åº¦æŒ‡å¯¼/é˜¶æ®µ1.3_Milvuså‘é‡æ•°æ®åº“éƒ¨ç½²å®æ–½æŠ¥å‘Š_2025-10-28.md` - æœ¬æ–‡æ¡£
- `doc/implementation/NEXT_STEPS_PHASE3.md` - Phase3 è¿›åº¦ï¼ˆå¾…æ›´æ–°ï¼‰

### æŠ€æœ¯å‚è€ƒ

#### Milvus å®˜æ–¹æ–‡æ¡£

- [Milvus ä¸­æ–‡æ–‡æ¡£](https://milvus.io/docs/zh-cn/)
- [PyMilvus SDK](https://milvus.io/docs/zh-cn/api-reference/pymilvus/v2.3.0/About.md)
- [ç´¢å¼•ç±»å‹å¯¹æ¯”](https://milvus.io/docs/zh-cn/index.md)

#### BGE æ¨¡å‹

- [æ¨¡å‹ä¸»é¡µ](https://huggingface.co/BAAI/bge-large-zh-v1.5)
- [æŠ€æœ¯æŠ¥å‘Š](https://arxiv.org/abs/2309.07597)
- [MTEB æ¦œå•](https://huggingface.co/spaces/mteb/leaderboard)

#### Sentence-Transformers

- [å®˜æ–¹æ–‡æ¡£](https://www.sbert.net/)
- [API å‚è€ƒ](https://www.sbert.net/docs/package_reference/SentenceTransformer.html)

---

**ç»´æŠ¤è€…**: é’ç¾½åç«¯æ¶æ„å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025-10-28  
**ä¸‹ä¸€æ­¥**: æ›´æ–° NEXT_STEPS_PHASE3.mdï¼Œæ ‡è®°é˜¶æ®µ 1.3 å®Œæˆ

