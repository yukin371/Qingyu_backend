# é˜¶æ®µ 2.3ï¼šäº‹ä»¶é©±åŠ¨ç´¢å¼•æ›´æ–° - å®æ–½è®¡åˆ’

**æ—¥æœŸ**: 2025-10-28  
**çŠ¶æ€**: ğŸš§ è¿›è¡Œä¸­  
**é¢„è®¡æ—¶é—´**: Week 4ï¼ˆ2-3å°æ—¶ï¼‰

---

## ğŸ¯ ç›®æ ‡

å®ç°äº‹ä»¶é©±åŠ¨çš„å‘é‡ç´¢å¼•è‡ªåŠ¨æ›´æ–°æœºåˆ¶ï¼Œå½“æ–‡æ¡£å‘ç”Ÿå˜æ›´æ—¶è‡ªåŠ¨æ›´æ–°Milvuså‘é‡æ•°æ®åº“ï¼Œä¿æŒç´¢å¼•ä¸æ•°æ®æºçš„åŒæ­¥ã€‚

---

## ğŸ“‹ æ ¸å¿ƒä»»åŠ¡

### ä»»åŠ¡ 1: EventBusé›†æˆï¼ˆ30åˆ†é’Ÿï¼‰

#### 1.1 åˆ›å»ºäº‹ä»¶å®šä¹‰
**æ–‡ä»¶**: `python_ai_service/src/events/document_events.py`ï¼ˆæ–°å»ºï¼‰

**äº‹ä»¶ç±»å‹**:
```python
@dataclass
class DocumentEvent:
    """æ–‡æ¡£äº‹ä»¶åŸºç±»"""
    event_id: str
    event_type: str  # created, updated, deleted
    document_id: str
    timestamp: datetime
    user_id: Optional[str] = None
    metadata: Dict[str, Any] = field(default_factory=dict)

@dataclass
class DocumentCreatedEvent(DocumentEvent):
    """æ–‡æ¡£åˆ›å»ºäº‹ä»¶"""
    content: str
    source: str
    
@dataclass
class DocumentUpdatedEvent(DocumentEvent):
    """æ–‡æ¡£æ›´æ–°äº‹ä»¶"""
    content: str
    old_content: Optional[str] = None
    
@dataclass
class DocumentDeletedEvent(DocumentEvent):
    """æ–‡æ¡£åˆ é™¤äº‹ä»¶"""
    pass
```

#### 1.2 åˆ›å»ºäº‹ä»¶å¤„ç†å™¨æ¥å£
**æ–‡ä»¶**: `python_ai_service/src/events/handlers.py`ï¼ˆæ–°å»ºï¼‰

```python
class EventHandler(ABC):
    """äº‹ä»¶å¤„ç†å™¨åŸºç±»"""
    
    @abstractmethod
    async def handle(self, event: DocumentEvent) -> None:
        """å¤„ç†äº‹ä»¶"""
        pass
    
    @abstractmethod
    def can_handle(self, event: DocumentEvent) -> bool:
        """æ˜¯å¦èƒ½å¤„ç†æ­¤äº‹ä»¶"""
        pass
```

---

### ä»»åŠ¡ 2: å‘é‡ç´¢å¼•æ›´æ–°å™¨ï¼ˆ45åˆ†é’Ÿï¼‰

#### 2.1 åˆ›å»ºç´¢å¼•æ›´æ–°å™¨
**æ–‡ä»¶**: `python_ai_service/src/rag/index_updater.py`ï¼ˆæ–°å»ºï¼‰

**æ ¸å¿ƒåŠŸèƒ½**:
- ç›‘å¬æ–‡æ¡£äº‹ä»¶
- è‡ªåŠ¨å‘é‡åŒ–
- å¢é‡æ›´æ–°Milvus
- é”™è¯¯é‡è¯•æœºåˆ¶

**æ ¸å¿ƒæ–¹æ³•**:
```python
class VectorIndexUpdater:
    """å‘é‡ç´¢å¼•æ›´æ–°å™¨"""
    
    def __init__(
        self,
        embedding_manager: EmbeddingManager,
        milvus_client: MilvusClient,
        text_splitter: RecursiveCharacterTextSplitter
    ):
        """åˆå§‹åŒ–"""
        
    async def handle_document_created(
        self, 
        event: DocumentCreatedEvent
    ) -> None:
        """å¤„ç†æ–‡æ¡£åˆ›å»º"""
        # 1. æ–‡æœ¬åˆ†å—
        # 2. å‘é‡åŒ–
        # 3. æ’å…¥Milvus
        
    async def handle_document_updated(
        self, 
        event: DocumentUpdatedEvent
    ) -> None:
        """å¤„ç†æ–‡æ¡£æ›´æ–°"""
        # 1. åˆ é™¤æ—§å‘é‡
        # 2. é‡æ–°åˆ†å—å’Œå‘é‡åŒ–
        # 3. æ’å…¥æ–°å‘é‡
        
    async def handle_document_deleted(
        self, 
        event: DocumentDeletedEvent
    ) -> None:
        """å¤„ç†æ–‡æ¡£åˆ é™¤"""
        # åˆ é™¤æ‰€æœ‰ç›¸å…³å‘é‡
```

#### 2.2 å®ç°æ‰¹é‡æ›´æ–°
**æ–¹æ³•**: `batch_update()`

**åŠŸèƒ½**:
- æ‰¹é‡å¤„ç†å¤šä¸ªäº‹ä»¶
- å‡å°‘Milvusæ“ä½œæ¬¡æ•°
- æé«˜æ€§èƒ½

---

### ä»»åŠ¡ 3: ç´¢å¼•è°ƒåº¦å™¨ï¼ˆ40åˆ†é’Ÿï¼‰

#### 3.1 åˆ›å»ºè°ƒåº¦å™¨
**æ–‡ä»¶**: `python_ai_service/src/rag/index_scheduler.py`ï¼ˆæ–°å»ºï¼‰

**åŠŸèƒ½**:
- ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†
- å¹¶å‘æ§åˆ¶
- ä¼˜å…ˆçº§æ’åº
- é‡è¯•æœºåˆ¶

**æ ¸å¿ƒæ–¹æ³•**:
```python
class IndexScheduler:
    """ç´¢å¼•è°ƒåº¦å™¨"""
    
    def __init__(self, max_workers: int = 3):
        self.queue: asyncio.Queue = asyncio.Queue()
        self.workers: List[asyncio.Task] = []
        self.max_workers = max_workers
        
    async def enqueue(
        self, 
        event: DocumentEvent, 
        priority: int = 0
    ) -> None:
        """æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—"""
        
    async def start(self) -> None:
        """å¯åŠ¨è°ƒåº¦å™¨"""
        
    async def stop(self) -> None:
        """åœæ­¢è°ƒåº¦å™¨"""
        
    async def _worker(self) -> None:
        """å·¥ä½œåç¨‹"""
```

#### 3.2 å®ç°ä¼˜å…ˆçº§é˜Ÿåˆ—
- åˆ›å»º>æ›´æ–°>åˆ é™¤
- VIPæ–‡æ¡£ä¼˜å…ˆ
- æ‰¹é‡ä»»åŠ¡å»¶è¿Ÿå¤„ç†

---

### ä»»åŠ¡ 4: ç‰ˆæœ¬æ§åˆ¶ï¼ˆ30åˆ†é’Ÿï¼‰

#### 4.1 åˆ›å»ºç‰ˆæœ¬ç®¡ç†å™¨
**æ–‡ä»¶**: `python_ai_service/src/rag/version_manager.py`ï¼ˆæ–°å»ºï¼‰

**åŠŸèƒ½**:
- æ–‡æ¡£ç‰ˆæœ¬è¿½è¸ª
- å‘é‡ç‰ˆæœ¬æ˜ å°„
- ä¸€è‡´æ€§æ ¡éªŒ

**æ•°æ®ç»“æ„**:
```python
@dataclass
class DocumentVersion:
    """æ–‡æ¡£ç‰ˆæœ¬ä¿¡æ¯"""
    document_id: str
    version: int
    content_hash: str
    vector_ids: List[str]
    created_at: datetime
    updated_at: datetime
```

#### 4.2 å®ç°ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥
**æ–¹æ³•**: `check_consistency()`

**æ£€æŸ¥å†…å®¹**:
- æ–‡æ¡£ç‰ˆæœ¬ vs å‘é‡ç‰ˆæœ¬
- ç¼ºå¤±çš„ç´¢å¼•
- å­¤ç«‹çš„å‘é‡

---

### ä»»åŠ¡ 5: Redisç¼“å­˜é›†æˆï¼ˆ25åˆ†é’Ÿï¼‰

#### 5.1 ç¼“å­˜ç´¢å¼•ä»»åŠ¡
**åŠŸèƒ½**:
- ç¼“å­˜å¾…å¤„ç†äº‹ä»¶
- æŒä¹…åŒ–é˜Ÿåˆ—
- æ•…éšœæ¢å¤

**Redisæ•°æ®ç»“æ„**:
```
# å¾…å¤„ç†é˜Ÿåˆ—
index_queue:pending -> List[event_json]

# å¤„ç†ä¸­ä»»åŠ¡
index_queue:processing:{task_id} -> event_json + TTL

# å¤±è´¥ä»»åŠ¡
index_queue:failed -> List[event_json + error]

# ç‰ˆæœ¬ä¿¡æ¯
doc_version:{document_id} -> version_json
```

#### 5.2 å®ç°æ•…éšœæ¢å¤
- æœåŠ¡é‡å¯æ—¶æ¢å¤æœªå®Œæˆä»»åŠ¡
- å¤„ç†è¶…æ—¶ä»»åŠ¡
- å¤±è´¥é‡è¯•æœºåˆ¶

---

### ä»»åŠ¡ 6: ç›‘æ§å’Œæ—¥å¿—ï¼ˆ20åˆ†é’Ÿï¼‰

#### 6.1 æ·»åŠ PrometheusæŒ‡æ ‡
**æ–‡ä»¶**: æ›´æ–° `python_ai_service/src/core/metrics.py`

**æ–°å¢æŒ‡æ ‡**:
```python
# ç´¢å¼•ä»»åŠ¡è®¡æ•°
index_tasks_total = Counter(
    'index_tasks_total',
    'Total index tasks',
    ['event_type', 'status']
)

# ç´¢å¼•å»¶è¿Ÿ
index_latency_seconds = Histogram(
    'index_latency_seconds',
    'Index task latency',
    ['event_type']
)

# é˜Ÿåˆ—é•¿åº¦
index_queue_length = Gauge(
    'index_queue_length',
    'Index queue length'
)
```

#### 6.2 ç»“æ„åŒ–æ—¥å¿—
- äº‹ä»¶å¤„ç†æ—¥å¿—
- æ€§èƒ½æŒ‡æ ‡æ—¥å¿—
- é”™è¯¯æ—¥å¿—ï¼ˆå«å †æ ˆï¼‰

---

### ä»»åŠ¡ 7: é…ç½®ç®¡ç†ï¼ˆ10åˆ†é’Ÿï¼‰

#### 7.1 æ›´æ–°é…ç½®
**æ–‡ä»¶**: `python_ai_service/src/core/config.py`

**æ–°å¢é…ç½®é¡¹**:
```python
class Settings(BaseSettings):
    # ç´¢å¼•æ›´æ–°é…ç½®
    index_auto_update: bool = True
    index_batch_size: int = 10
    index_batch_interval: int = 60  # ç§’
    index_max_workers: int = 3
    index_retry_times: int = 3
    index_retry_delay: int = 5  # ç§’
    
    # é˜Ÿåˆ—é…ç½®
    index_queue_max_size: int = 1000
    index_queue_timeout: int = 300  # ç§’
    
    # ç‰ˆæœ¬æ§åˆ¶
    index_version_enabled: bool = True
    index_version_ttl: int = 86400 * 30  # 30å¤©
```

---

### ä»»åŠ¡ 8: APIç«¯ç‚¹ï¼ˆ15åˆ†é’Ÿï¼‰

#### 8.1 åˆ›å»ºç´¢å¼•ç®¡ç†API
**æ–‡ä»¶**: `python_ai_service/src/api/index.py`ï¼ˆæ–°å»ºï¼‰

**ç«¯ç‚¹**:
```python
@router.post("/index/reindex")
async def reindex_document(document_id: str):
    """æ‰‹åŠ¨é‡å»ºæ–‡æ¡£ç´¢å¼•"""

@router.get("/index/status")
async def get_index_status():
    """è·å–ç´¢å¼•çŠ¶æ€"""
    
@router.get("/index/queue")
async def get_queue_status():
    """è·å–é˜Ÿåˆ—çŠ¶æ€"""
    
@router.post("/index/pause")
async def pause_indexing():
    """æš‚åœç´¢å¼•"""
    
@router.post("/index/resume")
async def resume_indexing():
    """æ¢å¤ç´¢å¼•"""
```

---

### ä»»åŠ¡ 9: æµ‹è¯•ä¸æ–‡æ¡£ï¼ˆ30åˆ†é’Ÿï¼‰

#### 9.1 å•å…ƒæµ‹è¯•
**æ–‡ä»¶**: `python_ai_service/tests/test_index_updater.py`ï¼ˆæ–°å»ºï¼‰

**æµ‹è¯•ç”¨ä¾‹**:
- æµ‹è¯•æ–‡æ¡£åˆ›å»ºäº‹ä»¶å¤„ç†
- æµ‹è¯•æ–‡æ¡£æ›´æ–°äº‹ä»¶å¤„ç†
- æµ‹è¯•æ–‡æ¡£åˆ é™¤äº‹ä»¶å¤„ç†
- æµ‹è¯•æ‰¹é‡æ›´æ–°
- æµ‹è¯•é”™è¯¯é‡è¯•

#### 9.2 é›†æˆæµ‹è¯•
**æ–‡ä»¶**: `python_ai_service/tests/test_event_flow.py`ï¼ˆæ–°å»ºï¼‰

**æµ‹è¯•åœºæ™¯**:
- ç«¯åˆ°ç«¯äº‹ä»¶æµ
- å¹¶å‘äº‹ä»¶å¤„ç†
- æ•…éšœæ¢å¤æµ‹è¯•

#### 9.3 ä¸­æ–‡æ–‡æ¡£
**æ–‡ä»¶**: `doc/implementation/00è¿›åº¦æŒ‡å¯¼/é˜¶æ®µ2.3_äº‹ä»¶é©±åŠ¨ç´¢å¼•æ›´æ–°_å®æ–½æŠ¥å‘Š.md`ï¼ˆæ–°å»ºï¼‰

**æ–‡æ¡£ç»“æ„**:
```markdown
# é˜¶æ®µ 2.3ï¼šäº‹ä»¶é©±åŠ¨ç´¢å¼•æ›´æ–°å®æ–½æŠ¥å‘Š

## å®æ–½æ¦‚è§ˆ
## äº‹ä»¶ç³»ç»Ÿè®¾è®¡
## ç´¢å¼•æ›´æ–°å™¨å®ç°
## è°ƒåº¦å™¨è®¾è®¡
## ç‰ˆæœ¬æ§åˆ¶
## Redisé›†æˆ
## ç›‘æ§å’Œæ—¥å¿—
## ä½¿ç”¨æŒ‡å—
## æ€§èƒ½æµ‹è¯•ç»“æœ
## åç»­è§„åˆ’
```

---

## ğŸ—‚ï¸ æ–‡ä»¶æ¸…å•

### æ–°å»ºæ–‡ä»¶ï¼ˆ11ä¸ªï¼‰
1. `python_ai_service/src/events/document_events.py` - äº‹ä»¶å®šä¹‰
2. `python_ai_service/src/events/handlers.py` - äº‹ä»¶å¤„ç†å™¨
3. `python_ai_service/src/rag/index_updater.py` - ç´¢å¼•æ›´æ–°å™¨
4. `python_ai_service/src/rag/index_scheduler.py` - è°ƒåº¦å™¨
5. `python_ai_service/src/rag/version_manager.py` - ç‰ˆæœ¬ç®¡ç†
6. `python_ai_service/src/api/index.py` - ç´¢å¼•ç®¡ç†API
7. `python_ai_service/tests/test_index_updater.py` - å•å…ƒæµ‹è¯•
8. `python_ai_service/tests/test_event_flow.py` - é›†æˆæµ‹è¯•
9. `doc/implementation/00è¿›åº¦æŒ‡å¯¼/é˜¶æ®µ2.3_äº‹ä»¶é©±åŠ¨ç´¢å¼•æ›´æ–°_å®æ–½æŠ¥å‘Š.md`

### æ›´æ–°æ–‡ä»¶ï¼ˆ2ä¸ªï¼‰
10. `python_ai_service/src/core/config.py` - é…ç½®æ›´æ–°
11. `python_ai_service/src/core/metrics.py` - ç›‘æ§æŒ‡æ ‡

---

## â±ï¸ æ—¶é—´åˆ†é…

| ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | ä¼˜å…ˆçº§ |
|------|---------|-------|
| 1. EventBusé›†æˆ | 30åˆ†é’Ÿ | P0 |
| 2. ç´¢å¼•æ›´æ–°å™¨ | 45åˆ†é’Ÿ | P0 |
| 3. ç´¢å¼•è°ƒåº¦å™¨ | 40åˆ†é’Ÿ | P0 |
| 4. ç‰ˆæœ¬æ§åˆ¶ | 30åˆ†é’Ÿ | P1 |
| 5. Redisç¼“å­˜ | 25åˆ†é’Ÿ | P1 |
| 6. ç›‘æ§å’Œæ—¥å¿— | 20åˆ†é’Ÿ | P1 |
| 7. é…ç½®ç®¡ç† | 10åˆ†é’Ÿ | P0 |
| 8. APIç«¯ç‚¹ | 15åˆ†é’Ÿ | P1 |
| 9. æµ‹è¯•ä¸æ–‡æ¡£ | 30åˆ†é’Ÿ | P0 |
| **æ€»è®¡** | **3å°æ—¶15åˆ†** | |

---

## âœ… éªŒæ”¶æ ‡å‡†

- [ ] æ–‡æ¡£åˆ›å»ºäº‹ä»¶è‡ªåŠ¨è§¦å‘ç´¢å¼•
- [ ] æ–‡æ¡£æ›´æ–°äº‹ä»¶æ­£ç¡®æ›´æ–°å‘é‡
- [ ] æ–‡æ¡£åˆ é™¤äº‹ä»¶æ¸…ç†å‘é‡
- [ ] æ‰¹é‡æ“ä½œæ€§èƒ½è‰¯å¥½ï¼ˆ>10æ¡/ç§’ï¼‰
- [ ] å¹¶å‘å¤„ç†æ— å†²çª
- [ ] å¤±è´¥ä»»åŠ¡æ­£ç¡®é‡è¯•
- [ ] ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡
- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] APIç«¯ç‚¹æ­£å¸¸å·¥ä½œ
- [ ] ä¸­æ–‡æ–‡æ¡£å®Œæ•´æ¸…æ™°

---

## ğŸ”§ æŠ€æœ¯è¦ç‚¹

### äº‹ä»¶é©±åŠ¨æ¶æ„

```
Go Backend (æ–‡æ¡£å˜æ›´)
   â†“ å‘å¸ƒäº‹ä»¶
EventBus (Redis/å†…å­˜)
   â†“ è®¢é˜…
Python AI Service
   â†“ å¤„ç†
IndexUpdater
   â†“ æ›´æ–°
Milvus
```

### æ‰¹é‡æ›´æ–°ç­–ç•¥

```python
# æ”¶é›†60ç§’å†…çš„äº‹ä»¶
events = collect_events(interval=60)

# æŒ‰æ–‡æ¡£IDåˆ†ç»„
groups = group_by_document_id(events)

# æ‰¹é‡å¤„ç†
for doc_id, doc_events in groups:
    # åªå¤„ç†æœ€æ–°äº‹ä»¶ï¼ˆå»é‡ï¼‰
    latest = get_latest_event(doc_events)
    process(latest)
```

### ç‰ˆæœ¬ä¸€è‡´æ€§

```python
# æ£€æŸ¥æ–‡æ¡£ç‰ˆæœ¬
doc_version = get_document_version(doc_id)
vector_version = get_vector_version(doc_id)

if doc_version != vector_version:
    # é‡å»ºç´¢å¼•
    reindex_document(doc_id)
```

---

## ğŸ“Š é¢„æœŸæˆæœ

**ä»£ç é‡**: ~1200è¡Œ
- äº‹ä»¶ç³»ç»Ÿ: ~200è¡Œ
- ç´¢å¼•æ›´æ–°å™¨: ~300è¡Œ
- è°ƒåº¦å™¨: ~250è¡Œ
- ç‰ˆæœ¬ç®¡ç†: ~200è¡Œ
- APIç«¯ç‚¹: ~150è¡Œ
- æµ‹è¯•: ~100è¡Œ

**æ€§èƒ½æŒ‡æ ‡**:
- ç´¢å¼•å»¶è¿Ÿ: <5ç§’ï¼ˆP95ï¼‰
- ååé‡: >10æ–‡æ¡£/ç§’
- é˜Ÿåˆ—ç§¯å‹: <100ï¼ˆæ­£å¸¸æƒ…å†µï¼‰

**å¯é æ€§**:
- äº‹ä»¶ä¸ä¸¢å¤±ï¼ˆRedisæŒä¹…åŒ–ï¼‰
- å¤±è´¥é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- ç‰ˆæœ¬ä¸€è‡´æ€§ï¼ˆå®šæ—¶æ£€æŸ¥ï¼‰

---

## ğŸš€ å®æ–½ä¼˜å…ˆçº§

### æ ¸å¿ƒåŠŸèƒ½ï¼ˆå¿…é¡»ï¼‰
1. âœ… äº‹ä»¶å®šä¹‰å’Œå¤„ç†å™¨æ¥å£
2. âœ… ç´¢å¼•æ›´æ–°å™¨æ ¸å¿ƒé€»è¾‘
3. âœ… åŸºç¡€è°ƒåº¦å™¨
4. âœ… é…ç½®ç®¡ç†

### æ‰©å±•åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
5. â³ ç‰ˆæœ¬æ§åˆ¶ï¼ˆå¦‚æœæ—¶é—´å…è®¸ï¼‰
6. â³ RedisæŒä¹…åŒ–ï¼ˆå¦‚æœæ—¶é—´å…è®¸ï¼‰
7. â³ ç›‘æ§æŒ‡æ ‡ï¼ˆå¦‚æœæ—¶é—´å…è®¸ï¼‰
8. â³ APIç«¯ç‚¹ï¼ˆå¦‚æœæ—¶é—´å…è®¸ï¼‰

---

## ä¸‹ä¸€æ­¥

å®Œæˆé˜¶æ®µ2.3åï¼ŒPhase3çš„RAGæ ¸å¿ƒåŠŸèƒ½å°†åŸºæœ¬å®Œæˆï¼Œå¯ä»¥è¿›å…¥ï¼š

**é˜¶æ®µ 3.xï¼šAgentå’Œå·¥å…·å±‚**
- WorkspaceContextTool
- å®¡æ ¸Agent
- LangGraphå·¥ä½œæµ

æˆ–

**æ€§èƒ½ä¼˜åŒ–é˜¶æ®µ**
- å®æ–½é˜¶æ®µ2.2æç½®åŠŸèƒ½
- æ€§èƒ½è°ƒä¼˜
- å‹åŠ›æµ‹è¯•

---

**åˆ›å»ºæ—¥æœŸ**: 2025-10-28  
**é¢„è®¡å®Œæˆ**: 2025-10-28  
**ç»´æŠ¤è€…**: é’ç¾½åç«¯æ¶æ„å›¢é˜Ÿ

