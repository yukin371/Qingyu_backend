# é˜¶æ®µ 2.1ï¼šå‘é‡åŒ–å¼•æ“å®Œå–„ - å®æ–½è®¡åˆ’

**æ—¥æœŸ**: 2025-10-28  
**çŠ¶æ€**: ğŸš§ è¿›è¡Œä¸­  
**é¢„è®¡æ—¶é—´**: Week 2ï¼ˆ2-3å°æ—¶ï¼‰

---

## ğŸ¯ ç›®æ ‡

åœ¨é˜¶æ®µ1.3çš„åŸºç¡€ä¸Šï¼Œå®Œå–„å‘é‡åŒ–å¼•æ“ï¼Œæ”¯æŒå¤šæ¨¡å‹ã€æ–‡æœ¬åˆ†å—å’Œæ€§èƒ½ä¼˜åŒ–ï¼Œä¸ºRAGç³»ç»Ÿæä¾›å¼ºå¤§çš„å‘é‡åŒ–èƒ½åŠ›ã€‚

---

## ğŸ“‹ æ ¸å¿ƒä»»åŠ¡

### ä»»åŠ¡ 1: å¤šæ¨¡å‹æ”¯æŒï¼ˆ40åˆ†é’Ÿï¼‰

#### 1.1 åˆ›å»ºæ¨¡å‹ç®¡ç†å™¨
**æ–‡ä»¶**: `python_ai_service/src/rag/embedding_manager.py`ï¼ˆæ–°å»ºï¼‰

**å®ç°å†…å®¹**:
- `EmbeddingManager` ç±» - ç»Ÿä¸€çš„æ¨¡å‹ç®¡ç†æ¥å£
- æ”¯æŒçš„æ¨¡å‹ç±»å‹:
  - `local` - æœ¬åœ°æ¨¡å‹ï¼ˆBGEç­‰ï¼‰
  - `openai` - OpenAI Embedding API
  - `custom` - è‡ªå®šä¹‰æ¨¡å‹

**æ ¸å¿ƒæ–¹æ³•**:
```python
class EmbeddingManager:
    def __init__(self, model_type: str, config: Dict):
        """åˆå§‹åŒ–æ¨¡å‹ç®¡ç†å™¨"""
        
    async def embed_texts(self, texts: List[str]) -> List[List[float]]:
        """ç»Ÿä¸€çš„æ–‡æœ¬å‘é‡åŒ–æ¥å£"""
        
    async def embed_query(self, query: str) -> List[float]:
        """ç»Ÿä¸€çš„æŸ¥è¯¢å‘é‡åŒ–æ¥å£"""
        
    def get_dimension(self) -> int:
        """è·å–å‘é‡ç»´åº¦"""
```

#### 1.2 å®ç° OpenAI Embedding
**æ–‡ä»¶**: `python_ai_service/src/rag/openai_embedding.py`ï¼ˆæ–°å»ºï¼‰

**å®ç°å†…å®¹**:
- ä½¿ç”¨ OpenAI SDK
- æ¨¡å‹: `text-embedding-3-small` (1536ç»´) æˆ– `text-embedding-3-large` (3072ç»´)
- æ‰¹é‡å¤„ç†ï¼ˆæœ€å¤§2048ä¸ªtoken/è¯·æ±‚ï¼‰
- é‡è¯•æœºåˆ¶
- é€Ÿç‡é™åˆ¶å¤„ç†

---

### ä»»åŠ¡ 2: æ–‡æœ¬åˆ†å—ç­–ç•¥ï¼ˆ45åˆ†é’Ÿï¼‰

#### 2.1 åˆ›å»ºæ–‡æœ¬åˆ†å—å™¨
**æ–‡ä»¶**: `python_ai_service/src/rag/text_splitter.py`ï¼ˆæ–°å»ºï¼‰

**å®ç°å†…å®¹**:
- `RecursiveCharacterTextSplitter` - é€’å½’å­—ç¬¦åˆ†å—
  - æŒ‰æ®µè½ã€å¥å­ã€å­—ç¬¦åˆ†å‰²
  - æ”¯æŒä¸­æ–‡åˆ†è¯
  - æ™ºèƒ½é‡å ï¼ˆoverlapï¼‰
  
- `SemanticTextSplitter` - è¯­ä¹‰åˆ†å—ï¼ˆå¯é€‰ï¼‰
  - åŸºäºembeddingç›¸ä¼¼åº¦åˆ†å‰²
  - ä¿æŒè¯­ä¹‰å®Œæ•´æ€§

**æ ¸å¿ƒå‚æ•°**:
```python
class TextSplitter:
    def __init__(
        self,
        chunk_size: int = 500,          # å—å¤§å°
        chunk_overlap: int = 50,        # é‡å å¤§å°
        separators: List[str] = None,   # åˆ†éš”ç¬¦ä¼˜å…ˆçº§
        length_function: Callable = len # é•¿åº¦è®¡ç®—å‡½æ•°
    ):
        ...
        
    def split_text(self, text: str) -> List[str]:
        """åˆ†å‰²æ–‡æœ¬"""
        
    def split_documents(
        self, 
        documents: List[Dict]
    ) -> List[Dict]:
        """åˆ†å‰²æ–‡æ¡£ï¼ˆä¿ç•™å…ƒæ•°æ®ï¼‰"""
```

#### 2.2 æ›´æ–° MilvusClient
**æ–‡ä»¶**: `python_ai_service/src/rag/milvus_client.py`

**ä¿®æ”¹å†…å®¹**:
- æ”¯æŒæ–‡æ¡£çº§åˆ«æ’å…¥ï¼ˆè‡ªåŠ¨åˆ†å—ï¼‰
- æ·»åŠ  `chunk_id` å’Œ `document_id` å­—æ®µ
- æ”¯æŒæŒ‰æ–‡æ¡£IDæŸ¥è¯¢æ‰€æœ‰chunk
- æ”¯æŒæŒ‰æ–‡æ¡£IDåˆ é™¤æ‰€æœ‰chunk

---

### ä»»åŠ¡ 3: æ¨¡å‹ç¼“å­˜æœºåˆ¶ï¼ˆ30åˆ†é’Ÿï¼‰

#### 3.1 å®ç°æ¨¡å‹ç¼“å­˜
**æ–‡ä»¶**: `python_ai_service/src/rag/embedding_cache.py`ï¼ˆæ–°å»ºï¼‰

**å®ç°å†…å®¹**:
- Redisç¼“å­˜å±‚
  - Key: `embed:{model}:{text_hash}`
  - Value: å‘é‡JSON
  - TTL: 7å¤©ï¼ˆå¯é…ç½®ï¼‰
  
- å†…å­˜LRUç¼“å­˜
  - å¤§å°: 1000æ¡ï¼ˆå¯é…ç½®ï¼‰
  - å¿«é€Ÿè®¿é—®å¸¸ç”¨å‘é‡

**æ ¸å¿ƒæ–¹æ³•**:
```python
class EmbeddingCache:
    def __init__(self, redis_client=None, lru_size: int = 1000):
        """åˆå§‹åŒ–ç¼“å­˜"""
        
    async def get(self, text: str, model: str) -> Optional[List[float]]:
        """è·å–ç¼“å­˜çš„å‘é‡"""
        
    async def set(
        self, 
        text: str, 
        model: str, 
        embedding: List[float],
        ttl: int = 604800  # 7å¤©
    ):
        """è®¾ç½®ç¼“å­˜"""
        
    async def get_batch(
        self, 
        texts: List[str], 
        model: str
    ) -> Dict[str, List[float]]:
        """æ‰¹é‡è·å–"""
```

#### 3.2 é›†æˆåˆ° EmbeddingManager
**ä¿®æ”¹**: `python_ai_service/src/rag/embedding_manager.py`

- åœ¨ `embed_texts()` ä¸­æ·»åŠ ç¼“å­˜æŸ¥è¯¢
- ç¼“å­˜æœªå‘½ä¸­æ—¶è°ƒç”¨æ¨¡å‹
- ç¼“å­˜æ–°ç”Ÿæˆçš„å‘é‡

---

### ä»»åŠ¡ 4: æ€§èƒ½ä¼˜åŒ–ï¼ˆ25åˆ†é’Ÿï¼‰

#### 4.1 å¼‚æ­¥å¤„ç†
**å®ç°å†…å®¹**:
- æ‰€æœ‰ç½‘ç»œè°ƒç”¨æ”¹ä¸ºå¼‚æ­¥ï¼ˆOpenAI APIã€Redisï¼‰
- ä½¿ç”¨ `asyncio.gather()` å¹¶å‘å¤„ç†
- æ‰¹é‡æ“ä½œä¼˜åŒ–

#### 4.2 æ‰¹é‡å¤„ç†ä¼˜åŒ–
**å®ç°å†…å®¹**:
- åŠ¨æ€batch sizeï¼ˆæ ¹æ®æ–‡æœ¬é•¿åº¦ï¼‰
- è¿›åº¦å›è°ƒï¼ˆå¤§æ‰¹é‡å¤„ç†ï¼‰
- å†…å­˜ç®¡ç†ï¼ˆé¿å…OOMï¼‰

#### 4.3 æ€§èƒ½ç›‘æ§
**æ–‡ä»¶**: `python_ai_service/src/core/metrics.py`ï¼ˆæ›´æ–°ï¼‰

**æ·»åŠ æŒ‡æ ‡**:
- `embedding_duration_seconds` - å‘é‡åŒ–è€—æ—¶
- `embedding_cache_hit_rate` - ç¼“å­˜å‘½ä¸­ç‡
- `embedding_batch_size` - æ‰¹é‡å¤§å°
- `embedding_token_count` - Tokenæ•°é‡

---

### ä»»åŠ¡ 5: é…ç½®ç®¡ç†ï¼ˆ10åˆ†é’Ÿï¼‰

#### 5.1 æ›´æ–°é…ç½®
**æ–‡ä»¶**: `python_ai_service/src/core/config.py`

**æ·»åŠ é…ç½®é¡¹**:
```python
class Settings(BaseSettings):
    # å‘é‡åŒ–é…ç½®
    embedding_provider: str = "local"  # local, openai, custom
    embedding_model_name: str = "BAAI/bge-large-zh-v1.5"
    embedding_cache_enabled: bool = True
    embedding_cache_ttl: int = 604800  # 7å¤©
    
    # OpenAIé…ç½®
    openai_embedding_model: str = "text-embedding-3-small"
    openai_embedding_batch_size: int = 100
    openai_embedding_max_retries: int = 3
    
    # æ–‡æœ¬åˆ†å—é…ç½®
    text_chunk_size: int = 500
    text_chunk_overlap: int = 50
    text_splitter_type: str = "recursive"  # recursive, semantic
```

---

### ä»»åŠ¡ 6: æµ‹è¯•ä¸æ–‡æ¡£ï¼ˆ40åˆ†é’Ÿï¼‰

#### 6.1 å•å…ƒæµ‹è¯•
**æ–‡ä»¶**: `python_ai_service/tests/test_embedding_manager.py`ï¼ˆæ–°å»ºï¼‰

**æµ‹è¯•ç”¨ä¾‹**:
- æµ‹è¯•æœ¬åœ°æ¨¡å‹åŠ è½½
- æµ‹è¯•OpenAIæ¨¡å‹è°ƒç”¨ï¼ˆMockï¼‰
- æµ‹è¯•æ¨¡å‹åˆ‡æ¢
- æµ‹è¯•é”™è¯¯å¤„ç†

#### 6.2 é›†æˆæµ‹è¯•
**æ–‡ä»¶**: `python_ai_service/tests/test_text_splitter.py`ï¼ˆæ–°å»ºï¼‰

**æµ‹è¯•ç”¨ä¾‹**:
- æµ‹è¯•ä¸­æ–‡æ–‡æœ¬åˆ†å—
- æµ‹è¯•é‡å ç­–ç•¥
- æµ‹è¯•å…ƒæ•°æ®ä¿ç•™

#### 6.3 æ€§èƒ½æµ‹è¯•
**æ–‡ä»¶**: `python_ai_service/tests/test_embedding_performance.py`ï¼ˆæ–°å»ºï¼‰

**æµ‹è¯•åœºæ™¯**:
- 100æ¡æ–‡æœ¬æ‰¹é‡å‘é‡åŒ–ï¼ˆè€—æ—¶ï¼‰
- ç¼“å­˜å‘½ä¸­ç‡æµ‹è¯•
- å¹¶å‘å¤„ç†æµ‹è¯•

#### 6.4 ä¸­æ–‡æ–‡æ¡£
**æ–‡ä»¶**: `doc/implementation/00è¿›åº¦æŒ‡å¯¼/é˜¶æ®µ2.1_å‘é‡åŒ–å¼•æ“å®Œå–„_å®æ–½æŠ¥å‘Š.md`ï¼ˆæ–°å»ºï¼‰

**æ–‡æ¡£ç»“æ„**:
```markdown
# é˜¶æ®µ 2.1ï¼šå‘é‡åŒ–å¼•æ“å®Œå–„å®æ–½æŠ¥å‘Š

## å®æ–½æ¦‚è§ˆ
- å®æ–½æ—¥æœŸ
- æ ¸å¿ƒæˆæœ
- æŠ€æœ¯äº®ç‚¹

## å¤šæ¨¡å‹æ”¯æŒ
- æ¨¡å‹ç®¡ç†å™¨è®¾è®¡
- OpenAI Embedding é›†æˆ
- æ¨¡å‹åˆ‡æ¢æœºåˆ¶

## æ–‡æœ¬åˆ†å—ç­–ç•¥
- åˆ†å—ç®—æ³•è¯´æ˜
- æœ€ä½³å®è·µ
- ä½¿ç”¨ç¤ºä¾‹

## ç¼“å­˜æœºåˆ¶
- Redis ç¼“å­˜å±‚
- LRU å†…å­˜ç¼“å­˜
- æ€§èƒ½æå‡

## æ€§èƒ½ä¼˜åŒ–
- å¼‚æ­¥å¤„ç†
- æ‰¹é‡ä¼˜åŒ–
- ç›‘æ§æŒ‡æ ‡

## ä½¿ç”¨æŒ‡å—
- é…ç½®è¯´æ˜
- API ç¤ºä¾‹
- æ•…éšœæ’æŸ¥

## æ€§èƒ½æµ‹è¯•ç»“æœ
- å‘é‡åŒ–é€Ÿåº¦
- ç¼“å­˜å‘½ä¸­ç‡
- èµ„æºæ¶ˆè€—

## åç»­è§„åˆ’
- é˜¶æ®µ 2.2ï¼šç»“æ„åŒ– RAG
```

---

## ğŸ—‚ï¸ æ–‡ä»¶æ¸…å•

### æ–°å»ºæ–‡ä»¶ï¼ˆ7ä¸ªï¼‰
1. `python_ai_service/src/rag/embedding_manager.py` - æ¨¡å‹ç®¡ç†å™¨
2. `python_ai_service/src/rag/openai_embedding.py` - OpenAIé›†æˆ
3. `python_ai_service/src/rag/text_splitter.py` - æ–‡æœ¬åˆ†å—å™¨
4. `python_ai_service/src/rag/embedding_cache.py` - ç¼“å­˜ç®¡ç†
5. `python_ai_service/tests/test_embedding_manager.py` - å•å…ƒæµ‹è¯•
6. `python_ai_service/tests/test_text_splitter.py` - åˆ†å—æµ‹è¯•
7. `python_ai_service/tests/test_embedding_performance.py` - æ€§èƒ½æµ‹è¯•

### æ›´æ–°æ–‡ä»¶ï¼ˆ3ä¸ªï¼‰
8. `python_ai_service/src/rag/milvus_client.py` - æ·»åŠ æ–‡æ¡£çº§æ“ä½œ
9. `python_ai_service/src/core/config.py` - æ·»åŠ é…ç½®é¡¹
10. `python_ai_service/src/core/metrics.py` - æ·»åŠ ç›‘æ§æŒ‡æ ‡

### æ–‡æ¡£æ–‡ä»¶ï¼ˆ1ä¸ªï¼‰
11. `doc/implementation/00è¿›åº¦æŒ‡å¯¼/é˜¶æ®µ2.1_å‘é‡åŒ–å¼•æ“å®Œå–„_å®æ–½æŠ¥å‘Š.md`

---

## â±ï¸ æ—¶é—´åˆ†é…

| ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | ä¼˜å…ˆçº§ |
|------|---------|-------|
| 1. å¤šæ¨¡å‹æ”¯æŒ | 40åˆ†é’Ÿ | P0 |
| 2. æ–‡æœ¬åˆ†å—ç­–ç•¥ | 45åˆ†é’Ÿ | P0 |
| 3. æ¨¡å‹ç¼“å­˜æœºåˆ¶ | 30åˆ†é’Ÿ | P1 |
| 4. æ€§èƒ½ä¼˜åŒ– | 25åˆ†é’Ÿ | P1 |
| 5. é…ç½®ç®¡ç† | 10åˆ†é’Ÿ | P0 |
| 6. æµ‹è¯•ä¸æ–‡æ¡£ | 40åˆ†é’Ÿ | P0 |
| **æ€»è®¡** | **2.5å°æ—¶** | |

---

## âœ… éªŒæ”¶æ ‡å‡†

- [ ] EmbeddingManager æ”¯æŒè‡³å°‘2ç§æ¨¡å‹ï¼ˆlocal + openaiï¼‰
- [ ] æ–‡æœ¬åˆ†å—å™¨æ­£ç¡®å¤„ç†ä¸­æ–‡
- [ ] ç¼“å­˜æœºåˆ¶å·¥ä½œæ­£å¸¸ï¼ˆRedis + LRUï¼‰
- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•è¾¾æ ‡ï¼š
  - 100æ¡æ–‡æœ¬å‘é‡åŒ– < 10ç§’ï¼ˆæœ¬åœ°æ¨¡å‹ï¼‰
  - ç¼“å­˜å‘½ä¸­ç‡ > 80%ï¼ˆé‡å¤æŸ¥è¯¢åœºæ™¯ï¼‰
- [ ] ä¸­æ–‡æ–‡æ¡£å®Œæ•´æ¸…æ™°
- [ ] ä»£ç æ—  lint é”™è¯¯

---

## ğŸ”§ æŠ€æœ¯è¦ç‚¹

### å¤šæ¨¡å‹æŠ½è±¡

```python
# ç»Ÿä¸€æ¥å£ï¼Œå±è”½åº•å±‚å·®å¼‚
manager = EmbeddingManager("openai", config)
embeddings = await manager.embed_texts(texts)

# åˆ‡æ¢æ¨¡å‹åªéœ€ä¿®æ”¹é…ç½®
manager = EmbeddingManager("local", config)
```

### æ™ºèƒ½åˆ†å—

```python
# é€’å½’åˆ†å—ï¼šæ®µè½ â†’ å¥å­ â†’ å­—ç¬¦
splitter = RecursiveCharacterTextSplitter(
    chunk_size=500,
    chunk_overlap=50,
    separators=["\n\n", "\n", "ã€‚", "ï¼", "ï¼Ÿ", " "]
)
chunks = splitter.split_text(long_text)
```

### å¤šçº§ç¼“å­˜

```text
æŸ¥è¯¢æµç¨‹ï¼š
1. æ£€æŸ¥å†…å­˜LRUç¼“å­˜ï¼ˆæ¯«ç§’çº§ï¼‰
2. æ£€æŸ¥Redisç¼“å­˜ï¼ˆæ¯«ç§’çº§ï¼‰
3. è°ƒç”¨æ¨¡å‹ï¼ˆç§’çº§ï¼‰
4. æ›´æ–°ç¼“å­˜
```

---

## ğŸ“Š é¢„æœŸæˆæœ

**ä»£ç é‡**: ~800è¡Œ
- EmbeddingManager: ~200è¡Œ
- OpenAI Embedding: ~150è¡Œ
- TextSplitter: ~200è¡Œ
- EmbeddingCache: ~150è¡Œ
- Tests: ~100è¡Œ

**æ€§èƒ½æå‡**:
- ç¼“å­˜å‘½ä¸­æ—¶ï¼š10x-100x åŠ é€Ÿ
- æ‰¹é‡å¤„ç†ï¼š5x åŠ é€Ÿ
- å¼‚æ­¥å¹¶å‘ï¼š3x åŠ é€Ÿ

**åŠŸèƒ½å®Œå–„åº¦**:
- æ¨¡å‹æ”¯æŒï¼š2+ ç§
- åˆ†å—ç­–ç•¥ï¼šé€’å½’åˆ†å—
- ç¼“å­˜å±‚çº§ï¼š2 å±‚ï¼ˆå†…å­˜+Redisï¼‰

---

## ğŸš€ ä¸‹ä¸€æ­¥

å®Œæˆé˜¶æ®µ2.1åï¼Œå°†è¿›å…¥ï¼š

**é˜¶æ®µ 2.2ï¼šç»“æ„åŒ– RAG å®ç°**ï¼ˆWeek 3ï¼‰
- RAGPipeline ç±»
- Reranker é›†æˆ
- æ··åˆæ£€ç´¢ï¼ˆå‘é‡+å…³é”®è¯ï¼‰
- ä¸Šä¸‹æ–‡ç»„è£…

---

**åˆ›å»ºæ—¥æœŸ**: 2025-10-28  
**é¢„è®¡å®Œæˆ**: 2025-10-28  
**ç»´æŠ¤è€…**: é’ç¾½åç«¯æ¶æ„å›¢é˜Ÿ

