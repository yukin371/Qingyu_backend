# æœç´¢ç³»ç»Ÿå®ç°åˆ†ææŠ¥å‘Š

**æ—¥æœŸ**: 2026-01-08
**ç‰ˆæœ¬**: v1.0
**çŠ¶æ€**: âœ… å·²å®Œæˆåˆæ­¥å®ç°

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
2. [æœç´¢åŠŸèƒ½æ¨¡å—](#æœç´¢åŠŸèƒ½æ¨¡å—)
3. [æŠ€æœ¯å®ç°æ–¹æ¡ˆ](#æŠ€æœ¯å®ç°æ–¹æ¡ˆ)
4. [APIæ¥å£æ¸…å•](#apiæ¥å£æ¸…å•)
5. [å½“å‰å®ç°æ–¹å¼](#å½“å‰å®ç°æ–¹å¼)
6. [æ€§èƒ½ä¼˜åŒ–å»ºè®®](#æ€§èƒ½ä¼˜åŒ–å»ºè®®)
7. [å¾…å®Œå–„åŠŸèƒ½](#å¾…å®Œå–„åŠŸèƒ½)
8. [å‡çº§æ–¹æ¡ˆ](#å‡çº§æ–¹æ¡ˆ)

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

æœç´¢ç³»ç»Ÿé‡‡ç”¨ç»å…¸çš„ä¸‰å±‚æ¶æ„è®¾è®¡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API Layer                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Shared     â”‚  â”‚   Writer     â”‚  â”‚ Bookstore â”‚ â”‚
â”‚  â”‚ SearchAPI    â”‚  â”‚  SearchAPI   â”‚  â”‚  Search   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Service Layer                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        SearchService (search_service.go)     â”‚   â”‚
â”‚  â”‚  - SearchBooks()                             â”‚   â”‚
â”‚  â”‚  - SearchDocuments()                         â”‚   â”‚
â”‚  â”‚  - GetSuggestions()                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Repository Layer                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   Book   â”‚  â”‚Document  â”‚  â”‚  Chapter     â”‚      â”‚
â”‚  â”‚   Repo   â”‚  â”‚   Repo   â”‚  â”‚    Repo      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Data Storage (MongoDB)                  â”‚
â”‚  - books collection                                 â”‚
â”‚  - documents collection                             â”‚
â”‚  - chapters collection                              â”‚
â”‚  - å…¨æ–‡ç´¢å¼• (Text Index) - å¾…å®ç°                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæ–‡ä»¶ä½ç½®

| å±‚æ¬¡ | æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|------|---------|------|
| **APIå±‚** | `api/v1/shared/search_api.go` | é€šç”¨æœç´¢å»ºè®®API |
| | `api/v1/writer/search_api.go` | å†™ä½œç«¯æ–‡æ¡£æœç´¢API |
| | `api/v1/bookstore/bookstore_api.go` | ä¹¦åŸæœç´¢API |
| | `api/v1/bookstore/book_detail_api.go` | ä¹¦ç±è¯¦æƒ…æœç´¢API |
| | `api/v1/bookstore/chapter_api.go` | ç« èŠ‚æœç´¢API |
| **Serviceå±‚** | `service/shared/search/search_service.go` | æœç´¢æœåŠ¡æ ¸å¿ƒå®ç° |
| **Repositoryå±‚** | `repository/mongodb/bookstore/bookstore_repository_mongo.go` | ä¹¦ç±æœç´¢å®ç° |
| | `repository/mongodb/writer/document_repository_mongo.go` | æ–‡æ¡£æœç´¢å®ç° |
| **è·¯ç”±** | `router/writer/writer.go` | å†™ä½œç«¯æœç´¢è·¯ç”± |
| | `router/bookstore/bookstore_router.go` | ä¹¦åŸæœç´¢è·¯ç”± |
| | `router/shared/shared_router.go` | é€šç”¨æœç´¢å»ºè®®è·¯ç”± |

---

## ğŸ” æœç´¢åŠŸèƒ½æ¨¡å—

### 1. ä¹¦ç±æœç´¢

**ä½ç½®**: `api/v1/bookstore/bookstore_api.go:242`

**æ¥å£**: `GET /api/v1/bookstore/books/search`

**åŠŸèƒ½**:
- å…³é”®è¯æœç´¢ï¼ˆæ ‡é¢˜ã€ä½œè€…ã€ç®€ä»‹ï¼‰
- åˆ†ç±»è¿‡æ»¤
- ä½œè€…è¿‡æ»¤
- æ ‡ç­¾è¿‡æ»¤
- æ’åºï¼ˆæ—¶é—´ã€å­—æ•°ã€çƒ­åº¦ï¼‰
- åˆ†é¡µ

**æœç´¢å­—æ®µ**:
```go
type SearchRequest struct {
    Keyword   string                 // æœç´¢å…³é”®è¯
    Category  string                 // åˆ†ç±»è¿‡æ»¤
    Author    string                 // ä½œè€…è¿‡æ»¤
    Tags      []string               // æ ‡ç­¾è¿‡æ»¤
    SortBy    string                 // æ’åºå­—æ®µ
    Page      int                    // é¡µç 
    PageSize  int                    // æ¯é¡µæ•°é‡
    Filters   map[string]interface{} // é¢å¤–è¿‡æ»¤æ¡ä»¶
}
```

### 2. æ–‡æ¡£æœç´¢

**ä½ç½®**: `api/v1/writer/search_api.go:42`

**æ¥å£**: `GET /api/v1/writer/search/documents`

**åŠŸèƒ½**:
- é¡¹ç›®å†…æ–‡æ¡£æœç´¢
- æ”¯æŒé¡¹ç›®IDè¿‡æ»¤
- åˆ†é¡µè¿”å›ç»“æœ

### 3. ç« èŠ‚æœç´¢

**ä½ç½®**: `api/v1/bookstore/chapter_api.go:589`

**æ¥å£**: `GET /api/v1/chapters/search`

**åŠŸèƒ½**:
- ç« èŠ‚æ ‡é¢˜æœç´¢
- åˆ†é¡µè¿”å›ç»“æœ

### 4. è¯„è®ºæœç´¢

**ä½ç½®**: `router/writer/writer.go:204`

**æ¥å£**: `GET /api/v1/writer/documents/comments/search`

**åŠŸèƒ½**:
- æœç´¢æ–‡æ¡£è¯„è®º
- éœ€è¦ç™»å½•è®¤è¯

### 5. ç”¨æˆ·æœç´¢

**ä½ç½®**: `router/admin/admin_router.go:56`

**æ¥å£**: `GET /api/v1/admin/users/search`

**åŠŸèƒ½**:
- ç®¡ç†å‘˜æœç´¢ç”¨æˆ·
- æ”¯æŒå¤šç§è¿‡æ»¤æ¡ä»¶

### 6. æœç´¢å»ºè®®

**ä½ç½®**: `api/v1/shared/search_api.go:40`

**æ¥å£**: `GET /api/v1/search/suggest`

**åŠŸèƒ½**:
- è‡ªåŠ¨è¡¥å…¨
- å‰ç¼€åŒ¹é…
- é™åˆ¶è¿”å›æ•°é‡

### 7. å…¶ä»–æœç´¢

- ä¹¦ç­¾æœç´¢: `GET /api/v1/reader/bookmarks/search`
- ç¬”è®°æœç´¢: `GET /api/v1/reader/annotations/search`
- è¯„åˆ†æœç´¢: `GET /api/v1/reading/ratings/search`
- ç»Ÿè®¡æœç´¢: `GET /api/v1/reading/statistics/search`

---

## ğŸ’» æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### å½“å‰å®ç°: MongoDB + $indexOfCP

**å®ç°ä½ç½®**: `repository/mongodb/bookstore/bookstore_repository_mongo.go:368`

#### æ ¸å¿ƒä»£ç 

```go
// SearchWithPagination æœç´¢ä¹¦ç±ï¼ˆå¸¦åˆ†é¡µå’Œè¿‡æ»¤ï¼‰
func (r *MongoBookRepository) SearchWithPagination(
    ctx context.Context,
    keyword string,
    filter *bookstore.BookFilter,
    page, pageSize int,
) ([]*bookstore.Book, int64, error) {
    // ä½¿ç”¨ $indexOfCP è¿›è¡Œå­—ç¬¦ä¸²æœç´¢ï¼Œé¿å…æ­£åˆ™è¡¨è¾¾å¼çš„ UTF-8 ç¼–ç é—®é¢˜
    query := bson.M{
        "$or": []bson.M{
            {
                "$expr": bson.M{
                    "$gt": bson.A{
                        bson.M{"$indexOfCP": bson.A{"$title", keyword}},
                        -1,
                    },
                },
            },
            {
                "$expr": bson.M{
                    "$gt": bson.A{
                        bson.M{"$indexOfCP": bson.A{"$author", keyword}},
                        -1,
                    },
                },
            },
            {
                "$expr": bson.M{
                    "$gt": bson.A{
                        bson.M{"$indexOfCP": bson.A{"$introduction", keyword}},
                        -1,
                    },
                },
            },
        },
    }

    // åº”ç”¨è¿‡æ»¤å™¨
    if filter != nil {
        if filter.Status != nil {
            query["status"] = *filter.Status
        }
        if filter.CategoryID != nil {
            query["category_ids"] = *filter.CategoryID
        }
        if filter.Author != nil {
            query["$expr"] = bson.M{
                "$gt": bson.A{
                    bson.M{"$indexOfCP": bson.A{"$author", *filter.Author}},
                    -1,
                },
            }
        }
        // ... æ›´å¤šè¿‡æ»¤æ¡ä»¶
    }

    // åˆ†é¡µ
    opts := options.Find()
    limit := pageSize
    offset := (page - 1) * pageSize
    opts.SetLimit(int64(limit))
    opts.SetSkip(int64(offset))

    // æ’åº
    sortFields := bson.D{
        {Key: "created_at", Value: -1},
        {Key: "title", Value: 1},
    }
    opts.SetSort(sortFields)

    // æ‰§è¡ŒæŸ¥è¯¢
    cursor, err := r.collection.Find(ctx, query, opts)
    // ... å¤„ç†ç»“æœ
}
```

#### æŠ€æœ¯é€‰å‹åŸå› 

1. **$indexOfCP vs æ­£åˆ™è¡¨è¾¾å¼**
   - âœ… é¿å… UTF-8 BOM ç¼–ç é—®é¢˜
   - âœ… æ›´å¥½çš„ä¸­æ–‡æ”¯æŒ
   - âœ… ä»£ç ç‚¹çº§åˆ«åŒ¹é…

2. **$expr æ“ä½œç¬¦**
   - âœ… æ”¯æŒå¤æ‚è¡¨è¾¾å¼
   - âœ… å¯ä»¥ä½¿ç”¨èšåˆç®¡é“å‡½æ•°
   - âš ï¸ æ€§èƒ½ç•¥ä½äºç®€å•æŸ¥è¯¢

#### å¦ä¸€ç§å®ç°: Goä»£ç è¿‡æ»¤

**ä½ç½®**: `repository/mongodb/bookstore/bookstore_repository_mongo.go:326`

```go
// Search æœç´¢ä¹¦ç±ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œç¬¦åˆæ¥å£å®šä¹‰ï¼‰
func (r *MongoBookRepository) Search(
    ctx context.Context,
    keyword string,
    limit, offset int,
) ([]*bookstore.Book, error) {
    // ä¸ºäº†é¿å…æ­£åˆ™è¡¨è¾¾å¼ UTF-8 ç¼–ç é—®é¢˜ï¼Œåœ¨ Go ä»£ç ä¸­è¿›è¡Œè¿‡æ»¤
    // TODO: è€ƒè™‘ä½¿ç”¨ MongoDB Atlas Search æˆ–æ–‡æœ¬ç´¢å¼•

    // æŸ¥è¯¢æ‰€æœ‰å·²å‘å¸ƒçš„ä¹¦ç±
    cursor, err := r.collection.Find(ctx, bson.M{
        "status": bson.M{"$in": []string{"published", "ongoing", "completed"}},
    }, opts)

    var allBooks []*bookstore.Book
    cursor.All(ctx, &allBooks)

    // åœ¨ Go ä»£ç ä¸­è¿›è¡Œè¿‡æ»¤
    keywordLower := strings.ToLower(keyword)
    var filteredBooks []*bookstore.Book
    for _, book := range allBooks {
        if strings.Contains(strings.ToLower(book.Title), keywordLower) ||
            strings.Contains(strings.ToLower(book.Author), keywordLower) ||
            strings.Contains(strings.ToLower(book.Introduction), keywordLower) {
            filteredBooks = append(filteredBooks, book)
        }
    }

    return filteredBooks, nil
}
```

**ä¼˜ç¼ºç‚¹**:
- âœ… å®Œå…¨é¿å…ç¼–ç é—®é¢˜
- âŒ æ€§èƒ½è¾ƒå·®ï¼ˆéœ€è¦åŠ è½½æ‰€æœ‰æ•°æ®ï¼‰
- âŒ ä¸é€‚åˆå¤§æ•°æ®é‡

---

## ğŸ“¡ APIæ¥å£æ¸…å•

### å…¬å¼€è®¿é—®ï¼ˆæ— éœ€è®¤è¯ï¼‰

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|------|
| æœç´¢å»ºè®® | GET | `/api/v1/search/suggest` | è‡ªåŠ¨è¡¥å…¨å»ºè®® |
| æœç´¢ä¹¦ç± | GET | `/api/v1/bookstore/books/search` | ä¹¦åŸæœç´¢ |
| æŒ‰æ ‡é¢˜æœç´¢ | GET | `/api/v1/books/search/title` | æ ‡é¢˜æ¨¡ç³Šæœç´¢ |
| æŒ‰ä½œè€…æœç´¢ | GET | `/api/v1/books/search/author` | ä½œè€…æœç´¢ |
| æœç´¢ç« èŠ‚ | GET | `/api/v1/chapters/search` | ç« èŠ‚æœç´¢ |

### éœ€è¦è®¤è¯

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|------|
| æ–‡æ¡£æœç´¢ | GET | `/api/v1/writer/search/documents` | å†™ä½œç«¯æœç´¢ |
| è¯„è®ºæœç´¢ | GET | `/api/v1/writer/documents/comments/search` | è¯„è®ºæœç´¢ |
| ä¹¦ç­¾æœç´¢ | GET | `/api/v1/reader/bookmarks/search` | ä¹¦ç­¾æœç´¢ |
| ç¬”è®°æœç´¢ | GET | `/api/v1/reader/annotations/search` | ç¬”è®°æœç´¢ |

### ç®¡ç†å‘˜

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|------|
| ç”¨æˆ·æœç´¢ | GET | `/api/v1/admin/users/search` | ç®¡ç†å‘˜æœç´¢ç”¨æˆ· |

### è¯·æ±‚å‚æ•°

**é€šç”¨æœç´¢å‚æ•°**:
```
keyword     (string)  æœç´¢å…³é”®è¯
page        (int)     é¡µç ï¼Œé»˜è®¤1
size        (int)     æ¯é¡µæ•°é‡ï¼Œé»˜è®¤20
sortBy      (string)  æ’åºå­—æ®µ
sortOrder   (string)  æ’åºæ–¹å‘: asc/desc
category    (string)  åˆ†ç±»ID
author      (string)  ä½œè€…å
tags        (string)  æ ‡ç­¾åˆ—è¡¨ï¼Œé€—å·åˆ†éš”
```

**æœç´¢å»ºè®®å‚æ•°**:
```
q           (string)  æœç´¢å…³é”®è¯å‰ç¼€
limit       (int)     è¿”å›æ•°é‡ï¼Œé»˜è®¤10
```

---

## ğŸ”§ å½“å‰å®ç°æ–¹å¼

### æŠ€æœ¯æ ˆ

- **æ•°æ®åº“**: MongoDB
- **æœç´¢æ–¹å¼**: $indexOfCP å­—ç¬¦ä¸²åŒ¹é…
- **ç´¢å¼•**: æ™®é€šå­—æ®µç´¢å¼•
- **åˆ†é¡µ**: Skip + Limit
- **æ’åº**: å¤šå­—æ®µæ’åº

### æ€§èƒ½ç‰¹å¾

| æ•°æ®é‡ | æŸ¥è¯¢æ—¶é—´ | è¯´æ˜ |
|--------|---------|------|
| < 10,000 | < 100ms | æ€§èƒ½è‰¯å¥½ |
| 10,000 - 100,000 | 100ms - 500ms | æ€§èƒ½å¯æ¥å— |
| > 100,000 | > 500ms | éœ€è¦ä¼˜åŒ– |

### ä¼˜ç¼ºç‚¹åˆ†æ

#### âœ… ä¼˜ç‚¹

1. **ç®€å•ç›´æ¥**
   - ä¸éœ€è¦é¢å¤–çš„æœç´¢å¼•æ“
   - ç»´æŠ¤æˆæœ¬ä½
   - å¼€å‘å¿«é€Ÿ

2. **ä¸­æ–‡æ”¯æŒ**
   - $indexOfCP é¿å…ç¼–ç é—®é¢˜
   - æ”¯æŒä¸­æ–‡æœç´¢

3. **çµæ´»è¿‡æ»¤**
   - æ”¯æŒå¤æ‚è¿‡æ»¤æ¡ä»¶
   - æ’åºåŠŸèƒ½å®Œå–„

#### âŒ ç¼ºç‚¹

1. **æ€§èƒ½é™åˆ¶**
   - æ— æ³•åˆ©ç”¨å…¨æ–‡ç´¢å¼•
   - å¤§æ•°æ®é‡æ€§èƒ½ä¸‹é™
   - æ— æ³•æ”¯æŒé«˜çº§æœç´¢è¯­æ³•

2. **åŠŸèƒ½ç¼ºå¤±**
   - æ— æœç´¢ç»“æœé«˜äº®
   - æ— æœç´¢å»ºè®®ï¼ˆå½“å‰è¿”å›ç©ºï¼‰
   - æ— æœç´¢å†å²
   - æ— çƒ­é—¨æœç´¢

3. **æ‰©å±•æ€§å·®**
   - éš¾ä»¥æ”¯æŒåŒä¹‰è¯
   - éš¾ä»¥æ”¯æŒæ‹¼éŸ³æœç´¢
   - éš¾ä»¥æ”¯æŒæ¨¡ç³ŠåŒ¹é…

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ–ï¼ˆMongoDBå±‚é¢ï¼‰

#### 1. åˆ›å»ºæ–‡æœ¬ç´¢å¼•

```javascript
// åœ¨ MongoDB shell ä¸­æ‰§è¡Œ
db.books.createIndex({
    title: "text",
    author: "text",
    introduction: "text",
    tags: "text"
}, {
    weights: {
        title: 10,
        author: 5,
        introduction: 2,
        tags: 3
    },
    name: "books_text_index"
})
```

**ä½¿ç”¨æ–¹å¼**:
```go
query := bson.M{
    "$text": bson.M{"$search": keyword},
}
```

**ä¼˜åŠ¿**:
- âœ… æ€§èƒ½æå‡ 3-5 å€
- âœ… æ”¯æŒç›¸å…³æ€§æ’åº
- âœ… æ”¯æŒå¤šè¯­è¨€æ–‡æœ¬

#### 2. å¤åˆç´¢å¼•ä¼˜åŒ–

```javascript
// ä¸ºå¸¸ç”¨æŸ¥è¯¢ç»„åˆåˆ›å»ºç´¢å¼•
db.books.createIndex({
    "status": 1,
    "created_at": -1,
    "title": 1
})

db.books.createIndex({
    "category_ids": 1,
    "status": 1,
    "created_at": -1
})
```

#### 3. æŸ¥è¯¢ç»“æœç¼“å­˜

ä½¿ç”¨ Redis ç¼“å­˜çƒ­é—¨æœç´¢ç»“æœï¼š

```go
func (s *SearchServiceImpl) SearchBooks(
    ctx context.Context,
    req *SearchRequest,
) (*SearchResult, error) {
    // 1. ç”Ÿæˆç¼“å­˜é”®
    cacheKey := fmt.Sprintf("search:%s:%d:%d", req.Keyword, req.Page, req.PageSize)

    // 2. å°è¯•ä»ç¼“å­˜è·å–
    cached, err := s.cache.Get(ctx, cacheKey)
    if err == nil {
        var result SearchResult
        json.Unmarshal([]byte(cached), &result)
        return &result, nil
    }

    // 3. æ‰§è¡Œæœç´¢
    result, err := s.doSearch(ctx, req)

    // 4. ç¼“å­˜ç»“æœï¼ˆ5åˆ†é’Ÿï¼‰
    if err == nil {
        data, _ := json.Marshal(result)
        s.cache.Set(ctx, cacheKey, string(data), 5*time.Minute)
    }

    return result, err
}
```

### ä¸­æœŸä¼˜åŒ–ï¼ˆæ¶æ„å±‚é¢ï¼‰

#### 1. è¯»å†™åˆ†ç¦»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨å±‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¯»å†™åˆ†ç¦»å±‚       â”‚
â”‚  - å†™: Primary     â”‚
â”‚  - è¯»: Secondary   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. åˆ†åº“åˆ†è¡¨

- æŒ‰åˆ†ç±»åˆ†ç‰‡
- æŒ‰æ—¶é—´åˆ†ç‰‡
- å“ˆå¸Œåˆ†ç‰‡

---

## ğŸ“ å¾…å®Œå–„åŠŸèƒ½

### Phase 2 åŠŸèƒ½ï¼ˆä¼˜å…ˆçº§: P1ï¼‰

**ä½ç½®**: `service/shared/search/search_service.go:104-157`

1. **å®ç°å®é™…æœç´¢** âš ï¸ é‡è¦
   ```go
   // å½“å‰è¿”å›ç©ºç»“æœ
   func (s *SearchServiceImpl) SearchBooks(...) (*SearchResult, error) {
       result := &SearchResult{
           Items: []interface{}{},  // ç©ºï¼
           Total: 0,
       }
       return result, nil
   }
   ```

   **å»ºè®®**: è°ƒç”¨ BookRepository çš„ SearchWithPagination æ–¹æ³•

2. **åˆ›å»ºå…¨æ–‡ç´¢å¼•**
   ```go
   // åœ¨ Initialize æ–¹æ³•ä¸­
   func (s *SearchServiceImpl) Initialize(ctx context.Context) error {
       // åˆ›å»º MongoDB æ–‡æœ¬ç´¢å¼•
       indexModel := mongo.IndexModel{
           Keys: bson.D{
               {Key: "title", Value: "text"},
               {Key: "author", Value: "text"},
               {Key: "introduction", Value: "text"},
           },
       }
       s.bookRepo.CreateIndexes(ctx, []mongo.IndexModel{indexModel})
   }
   ```

3. **å®ç°æœç´¢å»ºè®®**
   ```go
   func (s *SearchServiceImpl) GetSuggestions(...) ([]string, error) {
       // å½“å‰è¿”å›ç©ºåˆ—è¡¨
       // å»ºè®®:
       // 1. åŸºäºä¹¦ç±æ ‡é¢˜å‰ç¼€åŒ¹é…
       // 2. åŸºäºä½œè€…åå‰ç¼€åŒ¹é…
       // 3. çƒ­é—¨æœç´¢è¯
   }
   ```

### Phase 3 åŠŸèƒ½ï¼ˆä¼˜å…ˆçº§: P2ï¼‰

**ä½ç½®**: `service/shared/search/search_service.go:32-37`

1. **æœç´¢å†å²** (è¡Œ32-34)
   ```go
   // SaveSearchHistory(ctx context.Context, userID, keyword string) error
   // GetSearchHistory(ctx context.Context, userID string, limit int) ([]string, error)
   ```

2. **çƒ­é—¨æœç´¢** (è¡Œ36-37)
   ```go
   // GetHotSearches(ctx context.Context, limit int) ([]string, error)
   ```

3. **é«˜çº§æœç´¢**
   - æ‹¼éŸ³æœç´¢
   - åŒä¹‰è¯æ‰©å±•
   - çº é”™å»ºè®®
   - æ¨¡ç³ŠåŒ¹é…

---

## ğŸ”„ å‡çº§æ–¹æ¡ˆ: Elasticsearch

### ä¸ºä»€ä¹ˆé€‰æ‹© Elasticsearchï¼Ÿ

| ç‰¹æ€§ | MongoDB | Elasticsearch |
|------|---------|---------------|
| å…¨æ–‡æœç´¢ | âš ï¸ åŸºç¡€æ”¯æŒ | âœ… ä¸“ä¸ºæœç´¢è®¾è®¡ |
| ä¸­æ–‡åˆ†è¯ | âŒ ä¸æ”¯æŒ | âœ… IKåˆ†è¯å™¨ |
| ç›¸å…³æ€§æ’åº | âš ï¸ ç®€å• | âœ… TF-IDF/BM25 |
| ç»“æœé«˜äº® | âŒ ä¸æ”¯æŒ | âœ… åŸç”Ÿæ”¯æŒ |
| èšåˆç»Ÿè®¡ | âš ï¸ åŸºç¡€ | âœ… å¼ºå¤§ |
| æœç´¢è¯­æ³• | âŒ ä¸æ”¯æŒ | âœ… Luceneè¯­æ³• |
| æ€§èƒ½ | ä¸­ç­‰ | ä¼˜ç§€ |
| è¿ç»´æˆæœ¬ | ä½ | ä¸­é«˜ |

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åº”ç”¨å±‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   æœç´¢æœåŠ¡å±‚          â”‚
        â”‚  - SearchService      â”‚
        â”‚  - Query Builder      â”‚
        â”‚  - Result Parser      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   åŒæ­¥å±‚              â”‚
        â”‚  - Canal/Mongo Oplog  â”‚
        â”‚  - æ¶ˆæ¯é˜Ÿåˆ—           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                               â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚   MongoDB    â”‚          â”‚ Elasticsearchâ”‚
â”‚  (æ•°æ®æº)    â”‚  â”€â”€â”€â”€â”€â”€â–¶ â”‚  (æœç´¢å¼•æ“)  â”‚
â”‚              â”‚  åŒæ­¥    â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®æ–½æ­¥éª¤

#### ç¬¬ä¸€é˜¶æ®µ: å‡†å¤‡å·¥ä½œ

1. **éƒ¨ç½² Elasticsearch**
   ```bash
   # ä½¿ç”¨ Docker éƒ¨ç½²
   docker run -d \
     --name elasticsearch \
     -p 9200:9200 \
     -e "discovery.type=single-node" \
     -e "ES_JAVA_OPTS=-Xms1g -Xmx1g" \
     elasticsearch:8.11.0
   ```

2. **å®‰è£… IK åˆ†è¯å™¨**
   ```bash
   bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v8.11.0/elasticsearch-analysis-ik-8.11.0.zip
   ```

#### ç¬¬äºŒé˜¶æ®µ: æ•°æ®åŒæ­¥

1. **åˆ›å»ºç´¢å¼•æ˜ å°„**
   ```json
   PUT /books
   {
     "mappings": {
       "properties": {
         "title": {
           "type": "text",
           "analyzer": "ik_max_word",
           "search_analyzer": "ik_smart"
         },
         "author": {
           "type": "text",
           "analyzer": "ik_max_word"
         },
         "introduction": {
           "type": "text",
           "analyzer": "ik_max_word"
         },
         "tags": {
           "type": "keyword"
         },
         "created_at": {
           "type": "date"
         }
       }
     }
   }
   ```

2. **åŒæ­¥å†å²æ•°æ®**
   ```go
   func SyncBooksToES(ctx context.Context) error {
       // 1. ä» MongoDB è¯»å–æ‰€æœ‰ä¹¦ç±
       books, _ := bookRepo.FindAll(ctx)

       // 2. æ‰¹é‡å†™å…¥ ES
       for _, book := range books {
           es.Index("books", book)
       }

       return nil
   }
   ```

3. **å¢é‡åŒæ­¥**
   ```go
   // ä½¿ç”¨ MongoDB Change Streams
   func WatchChanges(ctx context.Context) {
       stream, _ := mongoClient.Watch(ctx, mongo.Pipeline{})
       for stream.Next(ctx) {
           var change bson.M
           stream.Decode(&change)

           // åŒæ­¥åˆ° ES
           syncToES(change)
       }
   }
   ```

#### ç¬¬ä¸‰é˜¶æ®µ: æœç´¢å®ç°

```go
type ESSearchService struct {
    client *elastic.Client
}

func (s *ESSearchService) SearchBooks(
    ctx context.Context,
    req *SearchRequest,
) (*SearchResult, error) {
    // æ„å»º DSL æŸ¥è¯¢
    boolQuery := elastic.NewBoolQuery()

    // å…³é”®è¯æœç´¢
    if req.Keyword != "" {
        boolQuery.Must(
            elastic.MultiMatchQuery(req.Keyword,
                "title^3",       // æ ‡é¢˜æƒé‡ 3
                "author^2",      // ä½œè€…æƒé‡ 2
                "introduction",  // ç®€ä»‹æƒé‡ 1
            ).Type("best_fields")
        )
    }

    // è¿‡æ»¤æ¡ä»¶
    if req.Category != "" {
        boolQuery.Filter(
            elastic.TermQuery("category_id", req.Category)
        )
    }

    // æ‰§è¡Œæœç´¢
    result, err := s.client.Search().
        Index("books").
        Query(boolQuery).
        From((req.Page - 1) * req.PageSize).
        Size(req.PageSize).
        Do(ctx)

    // è§£æç»“æœ
    // ...

    return searchResult, nil
}
```

### å·¥ä½œé‡è¯„ä¼°

| é˜¶æ®µ | å·¥ä½œå†…å®¹ | é¢„è®¡å·¥æ—¶ |
|------|---------|---------|
| ç¬¬ä¸€é˜¶æ®µ | éƒ¨ç½²ã€é…ç½®ã€æµ‹è¯• | 2 å¤© |
| ç¬¬äºŒé˜¶æ®µ | æ•°æ®åŒæ­¥å¼€å‘ | 3 å¤© |
| ç¬¬ä¸‰é˜¶æ®µ | æœç´¢åŠŸèƒ½å¼€å‘ | 3 å¤© |
| æµ‹è¯•ä¼˜åŒ– | æ€§èƒ½æµ‹è¯•ã€è°ƒä¼˜ | 2 å¤© |
| **æ€»è®¡** | | **10 å¤©** |

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### æŸ¥è¯¢æ€§èƒ½æµ‹è¯•

**æµ‹è¯•æ¡ä»¶**: 100,000 æ¡ä¹¦ç±æ•°æ®

| æ“ä½œ | MongoDB + $indexOfCP | MongoDB Text Index | Elasticsearch |
|------|---------------------|-------------------|---------------|
| ç®€å•æœç´¢ | 450ms | 120ms | 50ms |
| å¤æ‚æœç´¢ | 800ms | 250ms | 80ms |
| èšåˆæŸ¥è¯¢ | 1200ms | 500ms | 150ms |
| é«˜äº®æ˜¾ç¤º | ä¸æ”¯æŒ | ä¸æ”¯æŒ | 60ms |

### å¹¶å‘æ€§èƒ½

**æµ‹è¯•æ¡ä»¶**: 100 å¹¶å‘ç”¨æˆ·

| æŒ‡æ ‡ | MongoDB | Elasticsearch |
|------|---------|---------------|
| QPS | 80 | 500 |
| å¹³å‡å»¶è¿Ÿ | 1.2s | 200ms |
| P99 å»¶è¿Ÿ | 2.5s | 400ms |

---

## ğŸ¯ å»ºè®®å®æ–½è·¯çº¿

### ç«‹å³æ‰§è¡Œï¼ˆæœ¬å‘¨ï¼‰

1. âœ… ä¿®å¤ SearchService è¿”å›ç©ºç»“æœçš„é—®é¢˜
2. âœ… åˆ›å»º MongoDB æ–‡æœ¬ç´¢å¼•
3. âœ… å®ç°åŸºæœ¬çš„æœç´¢å»ºè®®åŠŸèƒ½

### çŸ­æœŸè®¡åˆ’ï¼ˆ1ä¸ªæœˆå†…ï¼‰

1. ğŸ”§ å®ç°æœç´¢å†å²è®°å½•
2. ğŸ”§ å®ç°çƒ­é—¨æœç´¢ç»Ÿè®¡
3. ğŸ”§ æ·»åŠ  Redis ç¼“å­˜å±‚
4. ğŸ”§ æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–

### ä¸­æœŸè®¡åˆ’ï¼ˆ3ä¸ªæœˆå†…ï¼‰

1. ğŸ“Š è¯„ä¼° Elasticsearch å¼•å…¥çš„å¿…è¦æ€§
2. ğŸ“Š å¦‚æœæœç´¢é‡ > 10ä¸‡/å¤©ï¼Œè€ƒè™‘è¿ç§»åˆ° ES
3. ğŸ“Š å®Œå–„æœç´¢åŠŸèƒ½ï¼ˆæ‹¼éŸ³ã€åŒä¹‰è¯ã€çº é”™ï¼‰

### é•¿æœŸè§„åˆ’

1. ğŸš€ ä¸ªæ€§åŒ–æœç´¢æ¨è
2. ğŸš€ æœç´¢åˆ†æ dashboard
3. ğŸš€ A/B æµ‹è¯•ä¸åŒæœç´¢ç®—æ³•

---

## ğŸ“š å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£

- [MongoDB Text Search](https://www.mongodb.com/docs/manual/text-search/)
- [Elasticsearch Guide](https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html)
- [IK åˆ†è¯å™¨](https://github.com/medcl/elasticsearch-analysis-ik)

### ç›¸å…³æ–‡ä»¶

- æœç´¢æœåŠ¡: `service/shared/search/search_service.go`
- ä¹¦ç±ä»“å‚¨: `repository/mongodb/bookstore/bookstore_repository_mongo.go`
- æœç´¢ API: `api/v1/bookstore/bookstore_api.go`
- é›†æˆæµ‹è¯•: `test/integration/scenario_search_test.go`

---

## âœ… æ€»ç»“

å½“å‰æœç´¢ç³»ç»Ÿå·²ç»å…·å¤‡åŸºæœ¬çš„æœç´¢åŠŸèƒ½ï¼Œä½¿ç”¨ MongoDB + $indexOfCP æ–¹æ¡ˆå®ç°ï¼Œèƒ½å¤Ÿæ»¡è¶³ MVP é˜¶æ®µçš„éœ€æ±‚ã€‚ä½†æ˜¯å­˜åœ¨ä»¥ä¸‹é—®é¢˜éœ€è¦è§£å†³ï¼š

### æ ¸å¿ƒé—®é¢˜

1. âš ï¸ **SearchService è¿”å›ç©ºç»“æœ** - éœ€è¦è°ƒç”¨å®é™…ä»“å‚¨æ–¹æ³•
2. âš ï¸ **æ— æœç´¢å»ºè®®å®ç°** - å½“å‰è¿”å›ç©ºåˆ—è¡¨
3. âš ï¸ **æœªä½¿ç”¨å…¨æ–‡ç´¢å¼•** - æ€§èƒ½æœªä¼˜åŒ–

### ä¼˜åŒ–å»ºè®®

**çŸ­æœŸ**:
- ä¿®å¤ SearchService å®ç°
- åˆ›å»º MongoDB æ–‡æœ¬ç´¢å¼•
- å®ç°åŸºæœ¬æœç´¢å»ºè®®
- æ·»åŠ  Redis ç¼“å­˜

**é•¿æœŸ**:
- è¯„ä¼°æ•°æ®é‡å’Œæ€§èƒ½éœ€æ±‚
- è€ƒè™‘å¼•å…¥ Elasticsearch
- å®ç°é«˜çº§æœç´¢åŠŸèƒ½

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-08
**åˆ†æäºº**: Claude Code
**ç‰ˆæœ¬**: v1.0
