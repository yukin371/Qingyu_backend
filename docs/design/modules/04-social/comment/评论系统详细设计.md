# 评论系统详细设计

> **模块**: 04 - 社交互动
> **功能**: 评论系统
> **完成度**: 🟢 90%

## 📋 概述

评论系统允许用户对书籍、章节、书评等内容进行评论和回复，支持嵌套评论、评论点赞、评论举报等功能。

## 🎯 核心功能

### 1. 基础评论功能

- **发布评论**: 发布文本评论（支持富文本）
- **回复评论**: 支持对评论进行嵌套回复（最多3层）
- **编辑评论**: 作者可编辑自己的评论（发布后5分钟内）
- **删除评论**: 作者可删除自己的评论

### 2. 评论展示

- **评论列表**: 分页展示评论列表
- **热门评论**: 按点赞数排序
- **最新评论**: 按时间排序
- **嵌套展示**: 树形结构展示评论回复

### 3. 评论互动

- **评论点赞**: 对评论进行点赞
- **评论举报**: 举报违规评论

### 4. 内容安全

- **敏感词过滤**: 自动过滤敏感词
- **长度限制**: 评论内容长度限制（1-1000字）
- **频率限制**: 用户发布评论频率限制

## 📊 数据模型

### Comment (评论实体)

```go
type Comment struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    UserID          primitive.ObjectID   `bson:"user_id" json:"userId"`
    TargetType      TargetType          `bson:"target_type" json:"targetType"`
    TargetID        primitive.ObjectID   `bson:"target_id" json:"targetId"`
    RootID          *primitive.ObjectID  `bson:"root_id,omitempty" json:"rootId,omitempty"`     // 根评论ID
    ParentID        *primitive.ObjectID  `bson:"parent_id,omitempty" json:"parentId,omitempty"` // 父评论ID

    // 评论内容
    Content         string               `bson:"content" json:"content"`         // 纯文本内容
    RichContent     string               `bson:"rich_content,omitempty" json:"richContent,omitempty"` // 富文本内容
    Images          []string             `bson:"images,omitempty" json:"images,omitempty"` // 图片URLs

    // 统计信息
    LikeCount       int                  `bson:"like_count" json:"likeCount"`     // 点赞数
    ReplyCount      int                  `bson:"reply_count" json:"replyCount"`   // 回复数

    // 层级信息
    Level           int                  `bson:"level" json:"level"`               // 层级（0-2）
    Path            string               `bson:"path" json:"path"`                 // 层级路径（便于查询）

    // 状态
    Status          CommentStatus        `bson:"status" json:"status"`             // 状态
    IsTop           bool                 `bson:"is_top" json:"isTop"`              // 是否置顶
    IsHot           bool                 `bson:"is_hot" json:"isHot"`              // 是否热门

    // 审核信息
    ReviewStatus    ReviewStatus         `bson:"review_status" json:"reviewStatus"`
    ReviewedAt      *time.Time           `bson:"reviewed_at,omitempty" json:"reviewedAt,omitempty"`
    ReviewedBy      *primitive.ObjectID  `bson:"reviewed_by,omitempty" json:"reviewedBy,omitempty"`

    // 时间戳
    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`
    UpdatedAt       time.Time            `bson:"updated_at" json:"updatedAt"`
    DeletedAt       *time.Time           `bson:"deleted_at,omitempty" json:"deletedAt,omitempty"`
}

type TargetType string
const (
    TargetTypeBook      TargetType = "book"
    TargetTypeChapter   TargetType = "chapter"
    TargetTypeReview    TargetType = "review"
    TargetTypeComment   TargetType = "comment" // 用于回复评论
)

type CommentStatus string
const (
    CommentStatusNormal   CommentStatus = "normal"
    CommentStatusHidden   CommentStatus = "hidden"    // 隐藏（用户删除或违规）
    CommentStatusDeleted  CommentStatus = "deleted"
)

type ReviewStatus string
const (
    ReviewStatusPending   ReviewStatus = "pending"
    ReviewStatusApproved  ReviewStatus = "approved"
    ReviewStatusRejected  ReviewStatus = "rejected"
)
```

### CommentLike (评论点赞)

```go
type CommentLike struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    UserID          primitive.ObjectID   `bson:"user_id" json:"userId"`
    CommentID       primitive.ObjectID   `bson:"comment_id" json:"commentId"`
    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`
}
```

### CommentReport (评论举报)

```go
type CommentReport struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    ReporterID      primitive.ObjectID   `bson:"reporter_id" json:"reporterId"`
    CommentID       primitive.ObjectID   `bson:"comment_id" json:"commentId"`
    Reason          ReportReason         `bson:"reason" json:"reason"`
    Description     string               `bson:"description,omitempty" json:"description,omitempty"`

    // 处理信息
    Status          ReportStatus         `bson:"status" json:"status"`
    HandlerID       *primitive.ObjectID  `bson:"handler_id,omitempty" json:"handlerId,omitempty"`
    HandleResult    string               `bson:"handle_result,omitempty" json:"handleResult,omitempty"`
    HandledAt       *time.Time           `bson:"handled_at,omitempty" json:"handledAt,omitempty"`

    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`
    UpdatedAt       time.Time            `bson:"updated_at" json:"updatedAt"`
}

type ReportReason string
const (
    ReportReasonSpam       ReportReason = "spam"
    ReportReasonPorn       ReportReason = "porn"
    ReportReasonViolence   ReportReason = "violence"
    ReportReasonPolitics   ReportReason = "politics"
    ReportReasonAbuse      ReportReason = "abuse"
    ReportReasonOther      ReportReason = "other"
)

type ReportStatus string
const (
    ReportStatusPending   ReportStatus = "pending"
    ReportStatusProcessing ReportStatus = "processing"
    ReportStatusResolved  ReportStatus = "resolved"
    ReportStatusRejected  ReportStatus = "rejected"
)
```

## 🌐 API端点

### 评论CRUD

| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| POST | /api/v1/social/comments | 发布评论 | 是 |
| GET | /api/v1/social/comments/:targetType/:targetId | 获取评论列表 | 否 |
| GET | /api/v1/social/comments/:id | 获取评论详情 | 否 |
| PUT | /api/v1/social/comments/:id | 更新评论 | 是 |
| DELETE | /api/v1/social/comments/:id | 删除评论 | 是 |

### 评论互动

| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| POST | /api/v1/social/comments/:id/like | 点赞评论 | 是 |
| DELETE | /api/v1/social/comments/:id/like | 取消点赞 | 是 |
| POST | /api/v1/social/comments/:id/report | 举报评论 | 是 |

### 评论管理

| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| PUT | /api/v1/social/admin/comments/:id/status | 更新评论状态 | 是(管理员) |
| PUT | /api/v1/social/admin/comments/:id/top | 设置评论置顶 | 是(管理员) |
| GET | /api/v1/social/admin/comments/pending | 获取待审核评论 | 是(管理员) |
| PUT | /api/v1/social/admin/comments/:id/review | 审核评论 | 是(管理员) |

## 🔄 核心流程

### 发布评论流程

```
1. 用户输入评论内容
   ↓
2. 前端验证（长度、格式）
   ↓
3. 后端接收请求
   ↓
4. 敏感词过滤
   ↓
5. 频率限制检查
   ↓
6. 创建评论记录
   ↓
7. 更新目标对象的评论数
   ↓
8. 发送通知（给目标对象作者）
   ↓
9. 返回评论信息
```

### 回复评论流程

```
1. 用户点击回复
   ↓
2. 获取父评论信息
   ↓
3. 检查层级（最多3层）
   ↓
4. 创建回复评论
   ↓
5. 更新父评论的回复数
   ↓
6. 发送通知（给被回复用户）
   ↓
7. 返回评论信息
```

### 评论审核流程

```
1. 评论提交时自动审核
   ↓
2. 敏感词检测
   ↓
3. 如果通过敏感词检测，状态为approved
   ↓
4. 如果未通过，状态为pending，进入人工审核队列
   ↓
5. 管理员审核
   ↓
6. 更新审核状态
   ↓
7. 如果通过，显示评论；如果不通过，隐藏评论
```

## 🔧 业务规则

### 评论层级限制

- **0级**: 根评论（对书籍/章节/书评的评论）
- **1级**: 对根评论的回复
- **2级**: 对1级评论的回复
- **最多3层**: 不允许对2级评论再回复

### 评论编辑规则

- 发布后5分钟内可编辑
- 只能编辑内容，不能修改目标对象
- 编辑后重新进行敏感词检测
- 编辑次数限制（最多3次）

### 评论删除规则

- 作者可删除自己的评论
- 删除评论时，子评论同时删除
- 管理员可删除任何评论

### 热门评论规则

- 点赞数 >= 10
- 发布时间在7天内
- 按点赞数排序

## 🔐 安全考虑

### 防刷机制

- 同一用户对同一评论5分钟内只能点赞一次
- 用户发布评论频率限制：每分钟最多3条
- IP级别频率限制：每分钟最多10条

### 内容安全

- 敏感词库管理
- 违规内容自动隐藏
- 累计3次违规，禁言7天

### XSS防护

- 富文本内容使用白名单标签
- 转义特殊字符
- 禁止JavaScript

## 📈 性能优化

### 缓存策略

- Redis缓存热门评论列表
- 缓存用户评论数
- 缓存评论点赞状态

### 数据库优化

- 评论表索引：targetType+targetID, userID, createdAt
- 点赞表索引：commentID+userID
- 分页查询优化

### 异步处理

- 评论通知异步发送
- 点赞数异步更新
- 统计数据异步计算

## 📊 监控指标

- 评论发布量（日/周/月）
- 评论平均字数
- 评论审核通过率
- 评论举报率
- 评论删除率

---

**文档维护**: 青羽后端架构团队
**最后更新**: 2025-01-06
