# æ€§èƒ½æµ‹è¯•æ¨¡å‹ä¸k6è„šæœ¬ï¼ˆç®€åŒ–ç‰ˆï¼‰

> é€‚ç”¨äºé’ç¾½å†™ä½œåç«¯é¡¹ç›®çš„è½»é‡çº§æ€§èƒ½æµ‹è¯•æ–¹æ¡ˆ

## 1. ä»€ä¹ˆæ—¶å€™éœ€è¦æ€§èƒ½æµ‹è¯•ï¼Ÿ

### å½“å‰é˜¶æ®µå»ºè®®ï¼šâ¸ï¸ **æš‚ä¸å®æ–½**

**ç†ç”±ï¼š**
- é¡¹ç›®å¤„äºåŠŸèƒ½å¼€å‘é˜¶æ®µ
- ç”¨æˆ·è§„æ¨¡è¾ƒå°
- åŠŸèƒ½ç¨³å®šæ€§ä¼˜å…ˆäºæ€§èƒ½ä¼˜åŒ–
- æ€§èƒ½æµ‹è¯•æŠ•å…¥äº§å‡ºæ¯”ä½

### æ¨èå®æ–½æ—¶æœºï¼š

âœ… **ä»¥ä¸‹æƒ…å†µå‡ºç°æ—¶å†è€ƒè™‘ï¼š**
1. æ ¸å¿ƒåŠŸèƒ½å¼€å‘å®Œæˆï¼ˆåŠŸèƒ½ç¨³å®šï¼‰
2. å‡†å¤‡æ­£å¼ä¸Šçº¿
3. ç”¨æˆ·åé¦ˆæ€§èƒ½é—®é¢˜
4. é¢„æœŸç”¨æˆ·é‡å¿«é€Ÿå¢é•¿
5. è¿›è¡Œé‡å¤§æ¶æ„è°ƒæ•´å‰

## 2. ç®€åŒ–ç‰ˆæ€§èƒ½æµ‹è¯•æ–¹æ¡ˆ

### 2.1 å…³é”®æ€§èƒ½æŒ‡æ ‡

```
å“åº”æ—¶é—´ï¼š
- P95 < 200ms  (95%çš„è¯·æ±‚åœ¨200mså†…å®Œæˆ)
- P99 < 500ms  (99%çš„è¯·æ±‚åœ¨500mså†…å®Œæˆ)

ååé‡ï¼š
- QPS > 100 (æ¯ç§’å¤„ç†100ä¸ªè¯·æ±‚)

æˆåŠŸç‡ï¼š
- æˆåŠŸç‡ > 99%

å¹¶å‘èƒ½åŠ›ï¼š
- æ”¯æŒ100å¹¶å‘ç”¨æˆ·
```

### 2.2 æµ‹è¯•åœºæ™¯ï¼ˆä»…æµ‹è¯•æ ¸å¿ƒåŠŸèƒ½ï¼‰

```
åœºæ™¯1: ç”¨æˆ·è®¤è¯
- ç”¨æˆ·æ³¨å†Œ
- ç”¨æˆ·ç™»å½•
- TokenéªŒè¯

åœºæ™¯2: æ–‡æ¡£æ“ä½œ
- åˆ›å»ºæ–‡æ¡£
- ä¿å­˜æ–‡æ¡£
- è¯»å–æ–‡æ¡£åˆ—è¡¨

åœºæ™¯3: AIåŠŸèƒ½ï¼ˆæœ€é‡è¦ï¼‰
- AIæ–‡æœ¬ç”Ÿæˆ
- æµå¼å“åº”
```

## 3. k6è„šæœ¬ç¤ºä¾‹

### 3.1 å®‰è£…k6

```bash
# Windows (ä½¿ç”¨Chocolatey)
choco install k6

# æˆ–è€…ä¸‹è½½å®‰è£…åŒ…
# https://k6.io/docs/getting-started/installation/
```

### 3.2 åŸºç¡€æµ‹è¯•è„šæœ¬

```javascript
// test/performance/user_login_test.js
import http from 'k6/http';
import { check, sleep } from 'k6';

// æµ‹è¯•é…ç½®
export const options = {
  stages: [
    { duration: '30s', target: 10 },  // é¢„çƒ­ï¼š30ç§’åˆ°è¾¾10ç”¨æˆ·
    { duration: '1m', target: 50 },   // è´Ÿè½½ï¼š1åˆ†é’Ÿåˆ°è¾¾50ç”¨æˆ·
    { duration: '30s', target: 0 },   // é™å‹ï¼š30ç§’é™åˆ°0ç”¨æˆ·
  ],
  thresholds: {
    http_req_duration: ['p(95)<200'],  // 95%è¯·æ±‚å°äº200ms
    http_req_failed: ['rate<0.01'],    // å¤±è´¥ç‡å°äº1%
  },
};

const BASE_URL = 'http://localhost:8080';

// æµ‹è¯•åœºæ™¯
export default function () {
  // 1. ç”¨æˆ·ç™»å½•
  const loginPayload = JSON.stringify({
    email: 'test@example.com',
    password: 'password123',
  });

  const loginRes = http.post(`${BASE_URL}/api/v1/user/login`, loginPayload, {
    headers: { 'Content-Type': 'application/json' },
  });

  // éªŒè¯å“åº”
  check(loginRes, {
    'login status is 200': (r) => r.status === 200,
    'login returns token': (r) => r.json('token') !== undefined,
  });

  // æ¨¡æ‹Ÿç”¨æˆ·æ€è€ƒæ—¶é—´
  sleep(1);

  // 2. è·å–æ–‡æ¡£åˆ—è¡¨ï¼ˆä½¿ç”¨ç™»å½•tokenï¼‰
  const token = loginRes.json('token');
  const headers = {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`,
  };

  const docsRes = http.get(`${BASE_URL}/api/v1/documents`, { headers });

  check(docsRes, {
    'docs status is 200': (r) => r.status === 200,
  });

  sleep(1);
}
```

### 3.3 å‹åŠ›æµ‹è¯•è„šæœ¬

```javascript
// test/performance/stress_test.js
import http from 'k6/http';
import { check } from 'k6';

export const options = {
  stages: [
    { duration: '2m', target: 100 },   // 2åˆ†é’Ÿåˆ°è¾¾100ç”¨æˆ·
    { duration: '5m', target: 100 },   // ç»´æŒ100ç”¨æˆ·5åˆ†é’Ÿ
    { duration: '2m', target: 200 },   // 2åˆ†é’Ÿåˆ°è¾¾200ç”¨æˆ·
    { duration: '5m', target: 200 },   // ç»´æŒ200ç”¨æˆ·5åˆ†é’Ÿ
    { duration: '2m', target: 0 },     // é™å‹
  ],
};

const BASE_URL = 'http://localhost:8080';

export default function () {
  const res = http.get(`${BASE_URL}/api/v1/health`);
  check(res, { 'status is 200': (r) => r.status === 200 });
}
```

### 3.4 AIåŠŸèƒ½æµ‹è¯•è„šæœ¬

```javascript
// test/performance/ai_generation_test.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  stages: [
    { duration: '1m', target: 10 },   // AIæ¥å£å¹¶å‘ä¸å®œè¿‡é«˜
    { duration: '3m', target: 10 },
    { duration: '1m', target: 0 },
  ],
  thresholds: {
    http_req_duration: ['p(95)<5000'], // AIè¯·æ±‚å…è®¸è¾ƒé•¿å“åº”æ—¶é—´
  },
};

const BASE_URL = 'http://localhost:8080';
const TOKEN = 'your_test_token_here';

export default function () {
  const payload = JSON.stringify({
    prompt: 'å†™ä¸€æ®µå…³äºæ˜¥å¤©çš„æè¿°',
    model: 'gpt-3.5-turbo',
  });

  const res = http.post(`${BASE_URL}/api/v1/ai/generate`, payload, {
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${TOKEN}`,
    },
    timeout: '30s', // AIè¯·æ±‚è®¾ç½®è¾ƒé•¿è¶…æ—¶
  });

  check(res, {
    'status is 200': (r) => r.status === 200,
    'has content': (r) => r.json('content') !== undefined,
  });

  sleep(3); // AIè¯·æ±‚é—´éš”è¾ƒé•¿
}
```

## 4. è¿è¡Œæµ‹è¯•

### 4.1 åŸºæœ¬å‘½ä»¤

```bash
# è¿è¡Œæµ‹è¯•
k6 run test/performance/user_login_test.js

# æŸ¥çœ‹è¯¦ç»†è¾“å‡º
k6 run --out json=results.json test/performance/user_login_test.js

# ä½¿ç”¨ç¯å¢ƒå˜é‡
k6 run -e BASE_URL=http://localhost:8080 test/performance/user_login_test.js
```

### 4.2 æŸ¥çœ‹ç»“æœ

```bash
# k6è¿è¡Œåä¼šæ˜¾ç¤ºæ‘˜è¦ï¼š
     âœ“ login status is 200
     âœ“ login returns token

     http_req_duration..............: avg=150ms min=100ms med=145ms max=250ms p(95)=180ms
     http_req_failed................: 0.00%
     http_reqs......................: 5000
     iterations.....................: 5000
     vus............................: 50
     vus_max........................: 50
```

## 5. æ€§èƒ½åŸºçº¿è®°å½•

### 5.1 å»ºç«‹åŸºçº¿

å½“é¦–æ¬¡è¿è¡Œæ€§èƒ½æµ‹è¯•æ—¶ï¼Œè®°å½•å…³é”®æŒ‡æ ‡ä½œä¸ºåŸºçº¿ï¼š

```markdown
# æ€§èƒ½åŸºçº¿è®°å½•è¡¨

| æµ‹è¯•æ—¥æœŸ | åœºæ™¯ | å¹¶å‘æ•° | P95å“åº”æ—¶é—´ | QPS | æˆåŠŸç‡ | å¤‡æ³¨ |
|---------|------|--------|------------|-----|--------|------|
| 2025-10-01 | ç”¨æˆ·ç™»å½• | 50 | 180ms | 120 | 99.9% | åˆå§‹åŸºçº¿ |
| 2025-10-01 | æ–‡æ¡£åˆ›å»º | 50 | 220ms | 100 | 99.5% | åˆå§‹åŸºçº¿ |
| 2025-10-01 | AIç”Ÿæˆ | 10 | 3500ms | 8 | 98% | åˆå§‹åŸºçº¿ |
```

### 5.2 æ€§èƒ½ç›‘æ§

åœ¨è¿è¡Œæ€§èƒ½æµ‹è¯•æ—¶ï¼ŒåŒæ—¶ç›‘æ§æœåŠ¡å™¨æŒ‡æ ‡ï¼š

```bash
# CPUä½¿ç”¨ç‡
# å†…å­˜ä½¿ç”¨ç‡
# æ•°æ®åº“è¿æ¥æ•°
# MongoDBå“åº”æ—¶é—´
# Rediså‘½ä¸­ç‡
```

## 6. ä½•æ—¶è§¦å‘æ€§èƒ½ä¼˜åŒ–ï¼Ÿ

### 6.1 æ€§èƒ½åŠ£åŒ–æŒ‡æ ‡

```
âš ï¸ è­¦å‘Šï¼šä»¥ä¸‹æƒ…å†µéœ€è¦å…³æ³¨æ€§èƒ½
- P95å“åº”æ—¶é—´ > 300ms
- æˆåŠŸç‡ < 99%
- CPUä½¿ç”¨ç‡æŒç»­ > 70%
- å†…å­˜ä½¿ç”¨æŒç»­å¢é•¿

ğŸš¨ ä¸¥é‡ï¼šä»¥ä¸‹æƒ…å†µéœ€è¦ç«‹å³ä¼˜åŒ–
- P95å“åº”æ—¶é—´ > 1s
- æˆåŠŸç‡ < 95%
- ç³»ç»Ÿå‡ºç°é”™è¯¯æˆ–è¶…æ—¶
```

## 7. å¿«é€Ÿæ€§èƒ½è¯Šæ–­

### 7.1 å¸¸è§æ€§èƒ½é—®é¢˜

```
é—®é¢˜ï¼šå“åº”æ—¶é—´æ…¢
å¯èƒ½åŸå› ï¼š
â–¡ æ•°æ®åº“æŸ¥è¯¢æ…¢ï¼ˆç¼ºå°‘ç´¢å¼•ï¼‰
â–¡ N+1æŸ¥è¯¢é—®é¢˜
â–¡ å¤–éƒ¨APIè°ƒç”¨æ…¢
â–¡ æœªä½¿ç”¨ç¼“å­˜

é—®é¢˜ï¼šååé‡ä½
å¯èƒ½åŸå› ï¼š
â–¡ æ•°æ®åº“è¿æ¥æ± å¤ªå°
â–¡ å¹¶å‘å¤„ç†èƒ½åŠ›ä¸è¶³
â–¡ èµ„æºç«äº‰ï¼ˆé”ï¼‰

é—®é¢˜ï¼šæˆåŠŸç‡ä½
å¯èƒ½åŸå› ï¼š
â–¡ è¶…æ—¶è®¾ç½®ä¸åˆç†
â–¡ èµ„æºä¸è¶³ï¼ˆå†…å­˜ã€è¿æ¥ï¼‰
â–¡ é”™è¯¯å¤„ç†ä¸å½“
```

### 7.2 å¿«é€Ÿä¼˜åŒ–æ£€æŸ¥æ¸…å•

```
â–¡ æ•°æ®åº“ç´¢å¼•æ˜¯å¦åˆç†ï¼Ÿ
â–¡ æ˜¯å¦ä½¿ç”¨äº†ç¼“å­˜ï¼ˆRedisï¼‰ï¼Ÿ
â–¡ æ•°æ®åº“è¿æ¥æ± é…ç½®æ˜¯å¦åˆç†ï¼Ÿ
â–¡ æ˜¯å¦æœ‰æ…¢æŸ¥è¯¢ï¼Ÿ
â–¡ å¤–éƒ¨APIæ˜¯å¦æœ‰è¶…æ—¶å’Œé‡è¯•æœºåˆ¶ï¼Ÿ
â–¡ æ˜¯å¦æœ‰å†…å­˜æ³„æ¼ï¼Ÿ
```

## 8. å®æ–½è®¡åˆ’å»ºè®®

### é˜¶æ®µ0: å½“å‰é˜¶æ®µï¼ˆä¸å®æ–½ï¼‰
```
âœ“ ä¸“æ³¨äºåŠŸèƒ½å¼€å‘
âœ“ ç¡®ä¿ä»£ç è´¨é‡
âœ“ å»ºç«‹å•å…ƒæµ‹è¯•
```

### é˜¶æ®µ1: å‡†å¤‡ä¸Šçº¿å‰ï¼ˆ1å‘¨ï¼‰
```
â–¡ å®‰è£…k6å·¥å…·
â–¡ ç¼–å†™æ ¸å¿ƒåœºæ™¯æµ‹è¯•è„šæœ¬
â–¡ è¿è¡ŒåŸºç¡€æ€§èƒ½æµ‹è¯•
â–¡ è®°å½•æ€§èƒ½åŸºçº¿
```

### é˜¶æ®µ2: ä¸Šçº¿åï¼ˆæŒç»­ï¼‰
```
â–¡ å®šæœŸè¿è¡Œæ€§èƒ½æµ‹è¯•ï¼ˆæ¯æ¬¡é‡å¤§æ›´æ–°å‰ï¼‰
â–¡ ç›‘æ§ç”Ÿäº§ç¯å¢ƒæ€§èƒ½æŒ‡æ ‡
â–¡ å¯¹æ¯”æ€§èƒ½åŸºçº¿ï¼Œå‘ç°åŠ£åŒ–
```

### é˜¶æ®µ3: æ€§èƒ½ä¼˜åŒ–ï¼ˆæŒ‰éœ€ï¼‰
```
â–¡ åˆ†ææ€§èƒ½ç“¶é¢ˆ
â–¡ å®æ–½ä¼˜åŒ–æªæ–½
â–¡ éªŒè¯ä¼˜åŒ–æ•ˆæœ
â–¡ æ›´æ–°æ€§èƒ½åŸºçº¿
```

## 9. æœ€å°åŒ–æ€§èƒ½æµ‹è¯•æ–¹æ¡ˆ

**å¦‚æœæ—¶é—´ç´§å¼ ï¼Œæœ€å°‘åšè¿™äº›ï¼š**

```javascript
// minimal_test.js - æœ€ç®€æ€§èƒ½æµ‹è¯•
import http from 'k6/http';
import { check } from 'k6';

export const options = {
  vus: 50,              // 50ä¸ªè™šæ‹Ÿç”¨æˆ·
  duration: '2m',       // æŒç»­2åˆ†é’Ÿ
};

export default function () {
  // æµ‹è¯•æœ€å…³é”®çš„API
  const res = http.get('http://localhost:8080/api/v1/documents');
  check(res, {
    'is status 200': (r) => r.status === 200,
    'response time < 200ms': (r) => r.timings.duration < 200,
  });
}
```

```bash
# è¿è¡Œæœ€å°åŒ–æµ‹è¯•
k6 run minimal_test.js

# åªè¦çœ‹åˆ°ï¼š
# âœ“ is status 200
# âœ“ response time < 200ms
# http_req_failed: 0.00%
# å°±è¯´æ˜åŸºæœ¬æ€§èƒ½OK
```

## 10. å‚è€ƒèµ„æº

- [k6å®˜æ–¹æ–‡æ¡£](https://k6.io/docs/)
- [k6æµ‹è¯•ç±»å‹](https://k6.io/docs/test-types/introduction/)
- [k6ç¤ºä¾‹è„šæœ¬](https://k6.io/docs/examples/)

---

## æ€»ç»“

**å¯¹äºé’ç¾½é¡¹ç›®ï¼š**

âŒ **ç°åœ¨ä¸éœ€è¦ï¼š**
- è¯¦ç»†çš„æ€§èƒ½æµ‹è¯•è®¡åˆ’
- å¤æ‚çš„æµ‹è¯•åœºæ™¯
- æŒç»­çš„æ€§èƒ½ç›‘æ§

âœ… **ä¸Šçº¿å‰éœ€è¦ï¼š**
- ç®€å•çš„k6è„šæœ¬ï¼ˆä¸Šé¢çš„ç¤ºä¾‹è¶³å¤Ÿï¼‰
- åŸºæœ¬æ€§èƒ½æŒ‡æ ‡éªŒè¯
- è®°å½•æ€§èƒ½åŸºçº¿

â° **é‡åˆ°é—®é¢˜æ—¶ï¼š**
- ç”¨æ€§èƒ½æµ‹è¯•å®šä½ç“¶é¢ˆ
- éªŒè¯ä¼˜åŒ–æ•ˆæœ
- é˜²æ­¢æ€§èƒ½åŠ£åŒ–

**æ ¸å¿ƒåŸåˆ™ï¼š** å¤Ÿç”¨å°±å¥½ï¼Œä¸è¦è¿‡åº¦è®¾è®¡ ğŸ¯
