# 测试基线文档

**文档版本**: v1.0
**创建日期**: 2026-02-09
**目的**: 建立测试基线，确保架构重构不破坏现有功能

---

## 概述

本文档定义了在架构迁移前必须建立的测试基线，用于：
1. 验证当前架构的正确性
2. 为重构提供回归测试基础
3. 建立性能基线用于对比

## 测试层次

```
┌─────────────────────────────────────────────────────┐
│              E2E Tests (端到端测试)                   │
│         关键业务流程的完整验证                        │
└────────────────────┬────────────────────────────────┘
                     │
┌────────────────────┴────────────────────────────────┐
│           Integration Tests (集成测试)               │
│       模块间交互的验证，测试Port/Adapter接口          │
└────────────────────┬────────────────────────────────┘
                     │
┌────────────────────┴────────────────────────────────┐
│            Unit Tests (单元测试)                    │
│            现有单元测试，确保不退化                   │
└─────────────────────────────────────────────────────┘
```

---

## 关键业务功能测试

### 1. 认证功能 (Auth)

#### 1.1 用户注册
- **测试场景**:
  - 正常注册（用户名、邮箱、密码）
  - 用户名已存在
  - 邮箱已存在
  - 密码强度不足
  - 参数验证失败

#### 1.2 用户登录
- **测试场景**:
  - 正常登录
  - 用户名不存在
  - 密码错误
  - 账号已禁用
  - 多次失败后锁定

#### 1.3 令牌管理
- **测试场景**:
  - 生成访问令牌
  - 刷新令牌
  - 验证令牌
  - 令牌过期
  - 撤销令牌

#### 1.4 OAuth认证
- **测试场景**:
  - 获取授权URL
  - 交换授权码
  - 获取用户信息
  - 绑定账号
  - 解绑账号

#### 1.5 权限控制
- **测试场景**:
  - 检查用户权限
  - 检查用户角色
  - 角色权限管理
  - 资源访问控制

### 2. 存储功能 (Storage)

#### 2.1 文件上传
- **测试场景**:
  - 上传普通文件
  - 上传大文件（>10MB）
  - 上传头像图片
  - 上传书籍封面
  - 文件类型验证
  - 文件大小限制

#### 2.2 文件下载
- **测试场景**:
  - 下载自有文件
  - 下载公共文件
  - 下载不存在的文件
  - 权限不足

#### 2.3 文件管理
- **测试场景**:
  - 删除文件
  - 获取文件信息
  - 列出用户文件
  - 生成下载URL

### 3. 缓存功能 (Cache)

#### 3.1 基础操作
- **测试场景**:
  - 设置缓存值
  - 获取缓存值
  - 删除缓存值
  - 检查键存在性

#### 3.2 过期管理
- **测试场景**:
  - 设置TTL
  - 获取TTL
  - 过期后自动清理

#### 3.3 批量操作
- **测试场景**:
  - 批量获取
  - 批量设置
  - 批量删除

---

## 性能基线

> **基线建立日期**: 2026-02-09
> **测试环境**: Windows, AMD Ryzen 7 4800H, Go 1.x
> **测试数据来源**: `test/baseline/` 基准测试

### Mock性能指标（接口层基准）

这些是Port接口层通过Mock实现的性能基线，用于验证接口设计的效率：

#### Auth模块

| 操作 | 平均耗时 (ns/op) | 内存分配 | 目标 | 状态 |
|------|-----------------|---------|------|------|
| ValidateToken | 2.04 ns | 0 B/op, 0 allocs/op | <10 ns | ✅ 达标 |
| CheckPermission | 3.67 ns | 0 B/op, 0 allocs/op | <5 ns | ✅ 达标 |

#### Storage模块

| 操作 | 平均耗时 (ns/op) | 内存分配 | 目标 | 状态 |
|------|-----------------|---------|------|------|
| UploadSmallFile | 4.42 ns | 0 B/op, 0 allocs/op | <100 ns | ✅ 达标 |
| UploadLargeFile | 4.04 ns | 0 B/op, 0 allocs/op | <100 ns | ✅ 达标 |
| DownloadFile | 16.44 ns | 4 B/op, 1 allocs/op | <100 ns | ✅ 达标 |

### 实际服务性能指标（待建立）

以下是需要通过集成测试建立的实际服务性能基线：

#### Auth模块

| 操作 | P50 (ms) | P95 (ms) | P99 (ms) | 目标 |
|------|---------|---------|---------|------|
| 用户登录 | - | - | - | <100 |
| OAuth登录 | - | - | - | <500 |

#### Storage模块

| 操作 | P50 (ms) | P95 (ms) | P99 (ms) | 目标 |
|------|---------|---------|---------|------|
| 上传文件(1MB) | - | - | - | <500 |
| 下载文件(10MB) | - | - | - | <1000 |
| 删除文件 | - | - | - | <100 |
| 列出文件 | - | - | - | <200 |

### Cache模块性能指标

| 操作 | P50 (ms) | P95 (ms) | P99 (ms) | 目标 |
|------|---------|---------|---------|------|
| 设置缓存 | - | - | - | <5 |
| 获取缓存 | - | - | - | <2 |
| 批量获取(100) | - | - | - | <50 |

---

## 测试数据管理

### 测试数据策略

1. **使用Mock数据** - 单元测试
2. **使用测试数据库** - 集成测试
3. **使用临时文件** - 存储测试
4. **使用测试Redis** - 缓存测试

### 测试数据清理

```bash
# 清理测试数据
make test-clean
```

---

## 测试执行顺序

### 1. 单元测试基线

```bash
# 运行所有单元测试
make test-unit

# 预期：所有测试通过
# 记录测试数量和覆盖率
```

### 2. 集成测试基线

```bash
# 运行集成测试
make test-integration

# 预期：所有集成测试通过
# 记录关键操作的耗时
```

### 3. 性能测试基线

```bash
# 运行性能测试
make benchmark

# 记录P50/P95/P99数据
# 保存到docs/test/baseline.json
```

---

## 回归测试策略

### 重构前基线

- [ ] 记录当前所有测试结果
- [ ] 记录性能基线数据
- [ ] 保存测试报告

### 重构中验证

- [ ] 每次提交后运行测试
- [ ] 对比性能数据
- [ ] 确保无功能退化

### 重构后对比

- [ ] 对比测试结果
- [ ] 对比性能数据
- [ ] 验证目标达成

---

## 风险评估

### 测试覆盖不足

| 模块 | 当前覆盖率 | 目标覆盖率 | 风险 |
|------|-----------|-----------|------|
| auth | 待测 | 80% | 中 |
| storage | 待测 | 70% | 中 |
| cache | 待测 | 60% | 低 |

### 缓解措施

1. **优先测试关键路径**
   - 用户登录流程
   - 文件上传下载
   - 权限检查

2. **建立测试数据管理**
   - 可重复的测试数据
   - 自动化数据清理

3. **持续监控**
   - CI中运行测试
   - 性能监控告警

---

## 下一步

### 立即执行

1. [ ] 创建auth模块集成测试
2. [ ] 创建storage模块集成测试
3. [ ] 创建cache模块集成测试
4. [ ] 运行性能测试建立基线

### 验证标准

- [ ] 关键功能有测试覆盖
- [ ] 测试可以重复执行
- [ ] 性能基线数据记录
- [ ] CI集成完成

---

## 附录：测试工具

### 推荐工具

- **testing**: Go标准测试框架
- **testify/suite**: 测试套件
- **testify/mock**: Mock对象
- **testcontainers**: 集成测试容器

### 测试命令

```bash
# 运行所有测试
make test

# 运行特定测试
go test -v ./service/shared/auth/...

# 运行基准测试
go test -bench=. -benchmem ./...
```

---

**维护**: 测试基线随架构演进持续更新
**审查**: 每次架构变更前审查测试基线
