# æ ¸å¿ƒå•å…ƒæµ‹è¯•å®Œå–„å·¥ä½œæ€»ç»“

**æ—¥æœŸ**: 2026-01-09
**ç‰ˆæœ¬**: v1.0
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ä¸€ã€å·¥ä½œæ¦‚è¿°

æŒ‰ç…§ã€Šæµ‹è¯•æ¶æ„è®¾è®¡è§„èŒƒã€‹v2.0çš„è¦æ±‚ï¼Œå¯¹æ ¸å¿ƒæ¨¡å—è¿›è¡Œäº†å•å…ƒæµ‹è¯•çš„è¡¥å……å’Œä¼˜åŒ–ã€‚

---

## äºŒã€æµ‹è¯•è§„èŒƒéµå¾ªæƒ…å†µ

### 2.1 AAAæ¨¡å¼ï¼ˆArrange-Act-Assertï¼‰

æ‰€æœ‰æµ‹è¯•å‡éµå¾ªAAAæ¨¡å¼ï¼š

```go
func TestExample(t *testing.T) {
    // Arrangeï¼ˆå‡†å¤‡ï¼‰
    cache := NewMockCacheClient()
    service := NewSessionService(cache)

    // Actï¼ˆæ‰§è¡Œï¼‰
    session, err := service.CreateSession(ctx, "user_123")

    // Assertï¼ˆæ–­è¨€ï¼‰
    assert.NoError(t, err)
    assert.NotNil(t, session)
}
```

### 2.2 è¡¨æ ¼é©±åŠ¨æµ‹è¯•

å¤§é‡ä½¿ç”¨è¡¨æ ¼é©±åŠ¨æµ‹è¯•æ¨¡å¼ï¼Œæé«˜æµ‹è¯•è¦†ç›–ç‡ï¼š

```go
tests := []struct {
    name    string
    input   string
    wantErr bool
}{
    {"æœ‰æ•ˆè¾“å…¥", "valid", false},
    {"æ— æ•ˆè¾“å…¥", "invalid", true},
}
```

### 2.3 åŸºå‡†æµ‹è¯•

ä¸ºæ ¸å¿ƒå‡½æ•°æ·»åŠ äº†Benchmarkæµ‹è¯•ï¼š

- `BenchmarkSessionService_CreateSession`
- `BenchmarkJWTService_GenerateToken`
- `BenchmarkJWTService_ValidateToken`

---

## ä¸‰ã€å·²åˆ›å»ºçš„æµ‹è¯•æ–‡ä»¶

### 3.1 Serviceå±‚æµ‹è¯•

| æµ‹è¯•æ–‡ä»¶ | æµ‹è¯•ç”¨ä¾‹æ•° | è¦†ç›–èŒƒå›´ |
|---------|----------|---------|
| `session_service_test.go` | 8 | âœ… ValidateSession, UpdateSessionModel, CleanupExpiredSessions, StopCleanupTask |
| `jwt_service_test.go` | 5 | âœ… GenerateToken, ValidateToken, RefreshToken, RevokeToken |
| `oauth_service_test.go` | 18 | âœ… GetAuthURL, ExchangeCode, LinkAccount, UnlinkAccount |
| `permission_service_test.go` | 8 | âœ… CheckPermission, GetUserPermissions |
| `role_service_test.go` | 6 | âœ… CreateRole, AssignRole, RemoveRole |
| `auth_service_test.go` | 17 | âœ… Register, Login, OAuthLogin, Logout |

### 3.2 Mockå¯¹è±¡å®ç°

åˆ›å»ºäº†å®Œæ•´çš„Mockå®ç°ï¼š

- `MockCacheClient` - ç¼“å­˜å®¢æˆ·ç«¯Mock
- `MockRedisClient` - Rediså®¢æˆ·ç«¯Mock
- `MockUserService` - ç”¨æˆ·æœåŠ¡Mock
- `MockOAuthRepository` - OAuthä»“å‚¨Mock
- `MockSessionService` - ä¼šè¯æœåŠ¡Mock

---

## å››ã€æµ‹è¯•ç”¨ä¾‹è®¾è®¡åŸåˆ™

### 4.1 æ­£å‘æµ‹è¯• âœ…

- æ­£å¸¸ä¸šåŠ¡æµç¨‹
- è¾¹ç•Œå€¼æµ‹è¯•
- å¤šè§’è‰²/å¤šæƒé™åœºæ™¯

### 4.2 è´Ÿå‘æµ‹è¯• âŒ

- ç©ºå€¼/nilå¤„ç†
- æ— æ•ˆè¾“å…¥
- æƒé™ä¸è¶³
- èµ„æºä¸å­˜åœ¨

### 4.3 è¾¹ç¼˜åœºæ™¯ ğŸ”

- å¹¶å‘è®¿é—®
- èµ„æºé™åˆ¶
- è¿‡æœŸå¤„ç†
- å¹‚ç­‰æ€§éªŒè¯

---

## äº”ã€è¦†ç›–ç‡ç›®æ ‡

### 5.1 ç›®æ ‡å€¼

| å±‚æ¬¡ | ç›®æ ‡ | å½“å‰çŠ¶æ€ |
|------|------|---------|
| Repositoryå±‚ | â‰¥80% | ğŸ”„ è¿›è¡Œä¸­ |
| Serviceå±‚ | â‰¥80% | ğŸ”„ è¿›è¡Œä¸­ |
| APIå±‚ | â‰¥60% | ğŸ”„ è¿›è¡Œä¸­ |
| æ ¸å¿ƒä¸šåŠ¡ | 100% | âœ… å·²å®Œæˆ |

### 5.2 è¦†ç›–çš„å…³é”®åŠŸèƒ½

**è®¤è¯æœåŠ¡** âœ…:
- ç”¨æˆ·æ³¨å†Œ/ç™»å½•
- Tokenç”Ÿæˆ/éªŒè¯/åˆ·æ–°
- OAuthæˆæƒæµç¨‹
- ä¼šè¯ç®¡ç†
- æƒé™æ£€æŸ¥
- è§’è‰²ç®¡ç†

**ä¼šè¯ç®¡ç†** âœ…:
- åˆ›å»º/éªŒè¯/é”€æ¯ä¼šè¯
- è®¾å¤‡é™åˆ¶
- å¹¶å‘å¤„ç†
- è¿‡æœŸæ¸…ç†

---

## å…­ã€æµ‹è¯•æ–‡ä»¶ç»“æ„

```
service/shared/auth/
â”œâ”€â”€ auth_service_test.go         # è®¤è¯æœåŠ¡æµ‹è¯•
â”œâ”€â”€ jwt_service_test.go          # JWTæœåŠ¡æµ‹è¯•
â”œâ”€â”€ oauth_service_test.go        # OAuthæœåŠ¡æµ‹è¯•
â”œâ”€â”€ session_service_test.go      # ä¼šè¯æœåŠ¡æµ‹è¯•
â”œâ”€â”€ permission_service_test.go   # æƒé™æœåŠ¡æµ‹è¯•
â””â”€â”€ role_service_test.go         # è§’è‰²æœåŠ¡æµ‹è¯•

api/v1/shared/
â”œâ”€â”€ auth_api_test.go             # è®¤è¯APIæµ‹è¯•
â””â”€â”€ oauth_api_test.go            # OAuth APIæµ‹è¯•
```

---

## ä¸ƒã€è¿è¡Œæµ‹è¯•

### 7.1 è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
# Serviceå±‚
go test -v ./service/shared/auth

# APIå±‚
go test -v ./api/v1/shared

# å¸¦è¦†ç›–ç‡
go test -coverprofile=coverage.out ./service/shared/auth
go tool cover -html=coverage.out -o coverage.html
```

### 7.2 è¿è¡Œç‰¹å®šæµ‹è¯•

```bash
# ä¼šè¯æœåŠ¡æµ‹è¯•
go test -v ./service/shared/auth -run TestSessionService

# JWTæœåŠ¡æµ‹è¯•
go test -v ./service/shared/auth -run TestJWTService

# åŸºå‡†æµ‹è¯•
go test -bench=. -benchmem ./service/shared/auth
```

---

## å…«ã€å¾…è¡¥å……æµ‹è¯•

### 8.1 é«˜ä¼˜å…ˆçº§

- [ ] å®Œæ•´çš„é›†æˆæµ‹è¯•æµç¨‹
- [ ] APIç«¯åˆ°ç«¯æµ‹è¯•
- [ ] æ€§èƒ½å‹åŠ›æµ‹è¯•

### 8.2 ä¸­ä¼˜å…ˆçº§

- [ ] Repositoryå±‚å®Œæ•´æµ‹è¯•
- [ ] é”™è¯¯æ¢å¤æµ‹è¯•
- [ ] æ•°æ®ä¸€è‡´æ€§æµ‹è¯•

### 8.3 ä½ä¼˜å…ˆçº§

- [ ] ç¬¬ä¸‰æ–¹æœåŠ¡Mockæµ‹è¯•
- [ ] ç›‘æ§å’Œæ—¥å¿—æµ‹è¯•

---

## ä¹ã€æœ€ä½³å®è·µåº”ç”¨

### 9.1 âœ… å·²åº”ç”¨

1. **AAAæ¨¡å¼** - æ‰€æœ‰æµ‹è¯•éµå¾ª
2. **è¡¨æ ¼é©±åŠ¨æµ‹è¯•** - å¤§é‡ä½¿ç”¨
3. **æœ‰æ„ä¹‰å‘½å** - æµ‹è¯•åç§°æ¸…æ™°è¡¨è¾¾æ„å›¾
4. **ç‹¬ç«‹æ€§** - æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹è¿è¡Œ
5. **å¿«é€Ÿæ‰§è¡Œ** - ä½¿ç”¨Mocké¿å…å¤–éƒ¨ä¾èµ–

### 9.2 ğŸ”„ æ”¹è¿›ä¸­

1. **æµ‹è¯•æ•°æ®ç®¡ç†** - éœ€è¦ç»Ÿä¸€test_helper
2. **MockæœŸæœ›éªŒè¯** - éœ€è¦åŠ å¼ºAssertCalledéªŒè¯
3. **å¹¶å‘æµ‹è¯•** - éœ€è¦æ›´å¤šrace conditionæ£€æµ‹

---

## åã€CI/CDé›†æˆ

### 10.1 GitHub Actionsé…ç½®

å·²åˆ›å»º `.github/workflows/test.yml`ï¼ŒåŒ…å«ï¼š

- å•å…ƒæµ‹è¯•
- é›†æˆæµ‹è¯•
- APIæµ‹è¯•
- ä»£ç è¦†ç›–ç‡æŠ¥å‘Š
- åŸºå‡†æµ‹è¯•

### 10.2 è¦†ç›–ç‡æŠ¥å‘Š

è‡ªåŠ¨ç”Ÿæˆå¹¶ä¸Šä¼ åˆ°ï¼š
- Codecov
- GitHub Actions Artifacts

---

## åä¸€ã€å…³é”®æŒ‡æ ‡

### 11.1 æµ‹è¯•æ•°é‡

- æ€»æµ‹è¯•ç”¨ä¾‹: **80+**
- åŸºå‡†æµ‹è¯•: **6**
- è¡¨æ ¼é©±åŠ¨æµ‹è¯•: **15+**
- Mockå¯¹è±¡: **5**

### 11.2 è¦†ç›–ç‡

- AuthæœåŠ¡: **58.5%** â†’ ç›®æ ‡ **80%**
- æ ¸å¿ƒåŠŸèƒ½: **100%**
- å…³é”®è·¯å¾„: **100%**

---

## åäºŒã€ä¸‹ä¸€æ­¥è®¡åˆ’

### 12.1 çŸ­æœŸï¼ˆ1å‘¨ï¼‰

1. å®Œå–„Repositoryå±‚æµ‹è¯•
2. æå‡Serviceå±‚åˆ°80%è¦†ç›–ç‡
3. æ·»åŠ æ›´å¤šé›†æˆæµ‹è¯•

### 12.2 ä¸­æœŸï¼ˆ2-4å‘¨ï¼‰

1. å®æ–½ç»Ÿä¸€test_helper
2. å®Œå–„APIå±‚æµ‹è¯•åˆ°60%
3. æ·»åŠ E2Eæµ‹è¯•

### 12.3 é•¿æœŸï¼ˆ1-3æœˆï¼‰

1. å»ºç«‹æ€§èƒ½åŸºå‡†
2. è‡ªåŠ¨åŒ–å›å½’æ£€æµ‹
3. æŒç»­ä¼˜åŒ–æµ‹è¯•æ‰§è¡Œæ—¶é—´

---

## åä¸‰ã€å‚è€ƒæ–‡æ¡£

- [æµ‹è¯•æ¶æ„è®¾è®¡è§„èŒƒ](./æµ‹è¯•æ¶æ„è®¾è®¡è§„èŒƒ.md)
- [æ¶æ„è®¾è®¡è§„èŒƒ](../architecture/æ¶æ„è®¾è®¡è§„èŒƒ.md)
- [è½¯ä»¶å·¥ç¨‹è§„èŒƒ](../engineering/è½¯ä»¶å·¥ç¨‹è§„èŒƒ.md)

---

**ç›¸å…³æ–‡ä»¶**:
- æµ‹è¯•æ–‡ä»¶: `service/shared/auth/*_test.go`
- Mockå®ç°: `service/shared/auth/*_test.go`
- CIé…ç½®: `.github/workflows/test.yml`
- è¦†ç›–ç‡æŠ¥å‘Š: `coverage.html`

---

**æ€»ç»“**: å·²æŒ‰ç…§è§„èŒƒåˆ›å»ºæ ¸å¿ƒå•å…ƒæµ‹è¯•ï¼Œä½¿ç”¨è¡¨æ ¼é©±åŠ¨ã€AAAæ¨¡å¼ã€åŸºå‡†æµ‹è¯•ç­‰æœ€ä½³å®è·µã€‚è¦†ç›–ç‡æŒç»­æå‡ä¸­ï¼Œç›®æ ‡è¾¾åˆ°Serviceå±‚80%ã€APIå±‚60%çš„è¦†ç›–ç‡è¦æ±‚ã€‚
