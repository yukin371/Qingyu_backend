# æµ‹è¯•å¿«é€Ÿå¼€å§‹æŒ‡å—

## ä¸€ã€å¿«é€Ÿè¿è¡Œæµ‹è¯•

### 1.1 è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
# è¿›å…¥åç«¯ç›®å½•
cd Qingyu_backend

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
go test ./...

# è¿è¡Œæµ‹è¯•å¹¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
go test -v ./...
```

### 1.2 è¿è¡Œç‰¹å®šæ¨¡å—æµ‹è¯•

```bash
# AuthæœåŠ¡æµ‹è¯•
go test -v ./service/shared/auth

# APIæµ‹è¯•
go test -v ./api/v1/shared

# Repositoryæµ‹è¯•
go test -v ./repository/mongodb/auth
```

### 1.3 è¿è¡Œç‰¹å®šæµ‹è¯•å‡½æ•°

```bash
# ä¼šè¯æœåŠ¡æµ‹è¯•
go test -v ./service/shared/auth -run TestSessionService

# JWTæœåŠ¡æµ‹è¯•
go test -v ./service/shared/auth -run TestJWTService

# OAuthæœåŠ¡æµ‹è¯•
go test -v ./service/shared/auth -run TestOAuthService
```

---

## äºŒã€ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

### 2.1 ç”Ÿæˆè¦†ç›–ç‡

```bash
# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
go test -coverprofile=coverage.out ./service/shared/auth

# ç”ŸæˆHTMLæŠ¥å‘Š
go tool cover -html=coverage.out -o coverage.html

# æŸ¥çœ‹è¦†ç›–ç‡
go tool cover -func=coverage.out | tail -20
```

### 2.2 æŸ¥çœ‹ç‰¹å®šæ¨¡å—è¦†ç›–ç‡

```bash
# AuthæœåŠ¡è¦†ç›–ç‡
go test -cover ./service/shared/auth

# JWTæœåŠ¡è¦†ç›–ç‡
go test -cover ./service/shared/auth -run TestJWT
```

---

## ä¸‰ã€è¿è¡ŒåŸºå‡†æµ‹è¯•

### 3.1 è¿è¡Œæ‰€æœ‰åŸºå‡†æµ‹è¯•

```bash
# è¿è¡ŒåŸºå‡†æµ‹è¯•
go test -bench=. -benchmem ./service/shared/auth

# è¿è¡Œç‰¹å®šåŸºå‡†æµ‹è¯•
go test -bench=BenchmarkSessionService -benchmem ./service/shared/auth
go test -bench=BenchmarkJWTService -benchmem ./service/shared/auth
```

### 3.2 åŸºå‡†æµ‹è¯•ç»“æœè§£è¯»

```
BenchmarkSessionService_CreateSession-8     1000000    1023 ns/op    512 B/op    8 allocs/op
```

- `1000000`: æ‰§è¡Œæ¬¡æ•°
- `1023 ns/op`: æ¯æ¬¡æ“ä½œè€—æ—¶ï¼ˆçº³ç§’ï¼‰
- `512 B/op`: æ¯æ¬¡æ“ä½œå†…å­˜åˆ†é…ï¼ˆå­—èŠ‚ï¼‰
- `8 allocs/op`: æ¯æ¬¡æ“ä½œåˆ†é…æ¬¡æ•°

---

## å››ã€æµ‹è¯•æœ€ä½³å®è·µ

### 4.1 è¡¨æ ¼é©±åŠ¨æµ‹è¯•ç¤ºä¾‹

```go
func TestValidateEmail(t *testing.T) {
    tests := []struct {
        name    string
        email   string
        wantErr bool
    }{
        {"æœ‰æ•ˆé‚®ç®±", "test@example.com", false},
        {"æ— æ•ˆé‚®ç®±", "invalid", true},
        {"ç©ºé‚®ç®±", "", true},
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            err := ValidateEmail(tt.email)
            if tt.wantErr {
                assert.Error(t, err)
            } else {
                assert.NoError(t, err)
            }
        })
    }
}
```

### 4.2 AAAæ¨¡å¼ç¤ºä¾‹

```go
func TestUserService_CreateUser(t *testing.T) {
    // Arrangeï¼ˆå‡†å¤‡ï¼‰
    mockRepo := new(MockUserRepository)
    service := NewUserService(mockRepo)
    user := &User{Name: "Test", Email: "test@example.com"}

    // Actï¼ˆæ‰§è¡Œï¼‰
    err := service.CreateUser(context.Background(), user)

    // Assertï¼ˆæ–­è¨€ï¼‰
    assert.NoError(t, err)
    assert.NotEmpty(t, user.ID)
    mockRepo.AssertCalled(t, "Create", mock.Anything, user)
}
```

### 4.3 Mockä½¿ç”¨ç¤ºä¾‹

```go
// è®¾ç½®MockæœŸæœ›
mockRepo.On("GetByID", mock.Anything, "user123").Return(user, nil)

// è®¾ç½®å¤šæ¬¡è°ƒç”¨
mockRepo.On("GetByID", mock.Anything, "user456").Return(user, nil).Times(3)

// è®¾ç½®å‚æ•°åŒ¹é…
mockRepo.On("Create", mock.Anything, mock.MatchedBy(func(u *User) bool {
    return u.Email != ""
})).Return(nil)

// éªŒè¯è°ƒç”¨
mockRepo.AssertCalled(t, "GetByID", mock.Anything, "user123")
mockRepo.AssertNumberOfCalls(t, "GetByID", 1)
mockRepo.AssertExpectations(t)
```

---

## äº”ã€å¸¸è§é—®é¢˜

### 5.1 æµ‹è¯•å¤±è´¥

**é—®é¢˜**: æµ‹è¯•ç¼–è¯‘å¤±è´¥
```
undefined: NewMockCacheClient
```

**è§£å†³**: ç¡®ä¿Mockå¯¹è±¡å·²å®šä¹‰åœ¨æµ‹è¯•æ–‡ä»¶ä¸­ï¼Œæˆ–å¯¼å…¥æ­£ç¡®çš„MockåŒ…ã€‚

### 5.2 è¦†ç›–ç‡ä¸å‡†ç¡®

**é—®é¢˜**: è¦†ç›–ç‡æ˜¾ç¤ºä¸º0%

**è§£å†³**:
- ç¡®ä¿æµ‹è¯•æ–‡ä»¶å‘½åæ­£ç¡®ï¼š`xxx_test.go`
- ç¡®ä¿æµ‹è¯•å‡½æ•°ä»¥`Test`å¼€å¤´
- ç¡®ä¿åŒ…åä¸è¢«æµ‹æ–‡ä»¶ä¸€è‡´

### 5.3 å¹¶å‘æµ‹è¯•å¤±è´¥

**é—®é¢˜**: å¹¶å‘æµ‹è¯•å‡ºç°ç«æ€æ¡ä»¶

**è§£å†³**:
```go
// ä½¿ç”¨ -race æ ‡å¿—æ£€æµ‹ç«æ€
go test -race ./service/shared/auth

// åœ¨æµ‹è¯•ä¸­æ·»åŠ åŒæ­¥æœºåˆ¶
var wg sync.WaitGroup
for i := 0; i < 10; i++ {
    wg.Add(1)
    go func() {
        defer wg.Done()
        // æµ‹è¯•ä»£ç 
    }()
}
wg.Wait()
```

---

## å…­ã€æŒç»­é›†æˆæµ‹è¯•

### 6.1 GitHub Actions

æµ‹è¯•ä¼šåœ¨ä»¥ä¸‹æƒ…å†µè‡ªåŠ¨è¿è¡Œï¼š
- Pushåˆ°mainåˆ†æ”¯
- åˆ›å»ºPull Request
- æ‰‹åŠ¨è§¦å‘

### 6.2 æœ¬åœ°é¢„æ£€æŸ¥

åœ¨æäº¤å‰è¿è¡Œï¼š

```bash
# å®Œæ•´æµ‹è¯•æ£€æŸ¥
go test ./...
go test -race ./...
go vet ./...

# æ ¼å¼æ£€æŸ¥
go fmt ./...
gofmt -l .

# é™æ€æ£€æŸ¥
staticcheck ./...
```

---

## ä¸ƒã€æµ‹è¯•å‘½ä»¤é€ŸæŸ¥

```bash
# ==================== åŸºç¡€æµ‹è¯• ====================
go test -v ./...                                    # è¿è¡Œæ‰€æœ‰æµ‹è¯•
go test -v ./service/shared/auth                   # è¿è¡ŒauthæœåŠ¡æµ‹è¯•
go test -v -run TestSessionService ./...          # è¿è¡Œç‰¹å®šæµ‹è¯•

# ==================== è¦†ç›–ç‡ ====================
go test -cover ./...                               # æŸ¥çœ‹è¦†ç›–ç‡
go test -coverprofile=coverage.out ./...           # ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
go tool cover -html=coverage.out -o cov.html       # ç”ŸæˆHTMLæŠ¥å‘Š
go tool cover -func=coverage.out | tail -20        # æŸ¥çœ‹å‡½æ•°è¦†ç›–ç‡

# ==================== åŸºå‡†æµ‹è¯• ====================
go test -bench=. ./...                             # è¿è¡Œæ‰€æœ‰åŸºå‡†æµ‹è¯•
go test -bench=. -benchmem ./...                   # åŒ…å«å†…å­˜åˆ†é…
go test -bench=BenchmarkJWT -benchmem ./auth       # è¿è¡Œç‰¹å®šåŸºå‡†æµ‹è¯•

# ==================== ç«æ€æ£€æµ‹ ====================
go test -race ./...                                # æ£€æµ‹ç«æ€æ¡ä»¶

# ==================== å…¶ä»– ====================
go test -count=1 ./...                              # ç¦ç”¨ç¼“å­˜
go test -timeout 30s ./...                         # è®¾ç½®è¶…æ—¶
go test -v -run "TestA|TestB" ./...                # è¿è¡Œå¤šä¸ªåŒ¹é…çš„æµ‹è¯•
```

---

## å…«ã€æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| æ¨¡å— | å½“å‰ | ç›®æ ‡ | çŠ¶æ€ |
|-----|-----|------|------|
| AuthæœåŠ¡ | 58.5% | 80% | ğŸ”„ è¿›è¡Œä¸­ |
| Repositoryå±‚ | - | 80% | ğŸ“ å¾…å¼€å§‹ |
| APIå±‚ | - | 60% | ğŸ“ å¾…å¼€å§‹ |
| æ ¸å¿ƒä¸šåŠ¡ | 100% | 100% | âœ… å·²å®Œæˆ |

---

## ä¹ã€ç›¸å…³æ–‡æ¡£

- [æµ‹è¯•æ¶æ„è®¾è®¡è§„èŒƒ](./æµ‹è¯•æ¶æ„è®¾è®¡è§„èŒƒ.md)
- [æ ¸å¿ƒå•å…ƒæµ‹è¯•å®Œå–„æ€»ç»“](./æ ¸å¿ƒå•å…ƒæµ‹è¯•å®Œå–„æ€»ç»“.md)
- [å·¥ç¨‹è§„èŒƒ](../engineering/è½¯ä»¶å·¥ç¨‹è§„èŒƒ.md)

---

**å¿«é€Ÿå¼€å§‹**: è¿è¡Œ `go test -v ./service/shared/auth` å¼€å§‹æµ‹è¯•ï¼
