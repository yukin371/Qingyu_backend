# 管理模块结构分析

## 模块概述

管理模块为平台管理员提供系统管理功能，包括用户管理、内容审核、系统配置、数据统计等。

## 目录结构

```
管理模块/
├── api/v1/admin/                 # 管理API
│   ├── admin_api.go            # 管理员API
│   ├── quota_admin_api.go      # 配额管理API
│   ├── audit_admin_api.go      # 审核API
│   ├── config_api.go           # 配置API
│   ├── system_admin_api.go     # 系统管理API
│   └── announcement_api.go     # 公告管理API
├── service/admin/              # 管理服务层
│   ├── admin_service.go        # 管理员服务
│   ├── quota_service.go        # 配额服务
│   ├── audit_service.go        # 审核服务
│   └── config_service.go       # 配置服务
├── repository/interfaces/admin/ # 仓储接口
├── repository/mongodb/admin/    # MongoDB仓储实现
└── models/admin/               # 数据模型
    ├── admin.go                # 管理员
    ├── audit.go                # 审核记录
    ├── config.go               # 系统配置
    └── statistics.go           # 统计数据
```

## 核心组件

### 1. 用户管理 API

```go
type AdminUserAPI struct {
    service admin.AdminService
}

// 主要接口：
- ListUsers(ctx)               // 获取用户列表
- GetUser(ctx)                 // 获取用户详情
- UpdateUser(ctx)              // 更新用户信息
- DeleteUser(ctx)              // 删除用户
- BanUser(ctx)                 // 封禁用户
- UnbanUser(ctx)               // 解封用户
- GetUserStats(ctx)            // 获取用户统计
```

### 2. 内容审核 API

```go
type AuditAdminAPI struct {
    service admin.AuditService
}

// 主要接口：
- GetPendingAudits(ctx)       // 获取待审核列表
- GetHighRiskAudits(ctx)       // 获取高风险审核
- GetAuditStatistics(ctx)     // 获取审核统计
- ReviewAudit(ctx)             // 审核内容
- ReviewAppeal(ctx)           // 处理申诉
```

### 3. 配额管理 API

```go
type QuotaAdminAPI struct {
    service admin.QuotaService
}

// 主要接口：
- GetUserQuotaDetails(ctx)   // 获取用户配额详情
- UpdateUserQuota(ctx)        // 更新用户配额
- SuspendUserQuota(ctx)       // 暂停用户配额
- ActivateUserQuota(ctx)      // 激活用户配额
- GetAllQuotas(ctx)           // 获取所有配额
- GetQuotaStatistics(ctx)     // 获取配额统计
```

### 4. 系统配置 API

```go
type ConfigAPI struct {
    service admin.ConfigService
}

// 主要接口：
- GetAllConfigs(ctx)          // 获取所有配置
- GetConfigByKey(ctx)          // 获取配置项
- UpdateConfig(ctx)           // 更新配置
- BatchUpdateConfig(ctx)      // 批量更新配置
- ValidateConfig(ctx)         // 验证配置
- GetConfigBackups(ctx)       // 获取配置备份
- RestoreConfigBackup(ctx)    // 恢复配置备份
```

### 5. 系统管理 API

```go
type SystemAdminAPI struct {
    service admin.SystemService
}

// 主要接口：
- GetSystemStats(ctx)          // 获取系统统计
- GetOperationLogs(ctx)       // 获取操作日志
- GetSystemConfig(ctx)         // 获取系统配置
- UpdateSystemConfig(ctx)      // 更新系统配置
- ReviewWithdraw(ctx)          // 审核提现
```

## 数据模型

### 1. 管理员 (`models/admin/admin.go`)

```go
type Admin struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    UserID          primitive.ObjectID   `bson:"user_id" json:"userId"`
    Permissions     []Permission         `bson:"permissions" json:"permissions"`

    // 管理员信息
    Level           AdminLevel          `bson:"level" json:"level"`                  // 超级管理员/普通管理员
    Department      string               `bson:"department,omitempty" json:"department,omitempty"`
    Notes           string               `bson:"notes,omitempty" json:"notes,omitempty"`

    // 状态
    IsActive        bool                 `bson:"is_active" json:"isActive"`

    // 时间戳
    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`
    UpdatedAt       time.Time            `bson:"updated_at" json:"updatedAt"`
}

type AdminLevel string

const (
    AdminLevelSuper   AdminLevel = "super"   // 超级管理员
    AdminLevelNormal  AdminLevel = "normal"  // 普通管理员
)

type Permission struct {
    Resource    string `bson:"resource" json:"resource"`    // 资源
    Action      string `bson:"action" json:"action"`       // 操作
    Scope       string `bson:"scope" json:"scope"`         // 范围
}
```

### 2. 审核记录 (`models/admin/audit.go`)

```go
type AuditRecord struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    Type            AuditType            `bson:"type" json:"type"`
    TargetType      TargetType           `bson:"target_type" json:"targetType"`
    TargetID        primitive.ObjectID   `bson:"target_id" json:"targetId"`
    TargetTitle     string               `bson:"target_title" json:"targetTitle"`

    // 审核信息
    Status          AuditStatus          `bson:"status" json:"status"`
    Priority        AuditPriority        `bson:"priority" json:"priority"`
    RiskLevel       RiskLevel            `bson:"risk_level" json:"riskLevel"`

    // 内容
    Content         string               `bson:"content" json:"content"`
    Reason          string               `bson:"reason,omitempty" json:"reason,omitempty"`
    ReviewerID      *primitive.ObjectID  `bson:"reviewer_id,omitempty" json:"reviewerId,omitempty"`
    ReviewerName    string               `bson:"reviewer_name,omitempty" json:"reviewerName,omitempty"`
    ReviewNote      string               `bson:"review_note,omitempty" json:"reviewNote,omitempty"`
    ReviewedAt      *time.Time           `bson:"reviewed_at,omitempty" json:"reviewedAt,omitempty"`

    // 申诉
    AppealCount     int                  `bson:"appeal_count" json:"appealCount"`
    AppealReason    string               `bson:"appeal_reason,omitempty" json:"appealReason,omitempty"`

    // 时间戳
    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`
    UpdatedAt       time.Time            `bson:"updated_at" json:"updatedAt"`
}

type AuditType string

const (
    AuditTypeContent      AuditType = "content"      // 内容审核
    AuditTypeComment      AuditType = "comment"      // 评论审核
    AuditTypeUser         AuditType = "user"         // 用户举报
    AuditTypeAppeal       AuditType = "appeal"       // 申诉
)

type AuditStatus string

const (
    AuditStatusPending    AuditStatus = "pending"    // 待审核
    AuditStatusApproved   AuditStatus = "approved"   // 已通过
    AuditStatusRejected   AuditStatus = "rejected"   // 已拒绝
    AuditStatusAppealed    AuditStatus = "appealed"    // 申诉中
)

type AuditPriority string

const (
    PriorityLow      AuditPriority = "low"      // 低优先级
    PriorityNormal   AuditPriority = "normal"   // 普通优先级
    PriorityHigh     AuditPriority = "high"     // 高优先级
    PriorityUrgent   AuditPriority = "urgent"   // 紧急
)

type RiskLevel string

const (
    RiskLevelSafe      RiskLevel = "safe"      // 安全
    RiskLevelLow       RiskLevel = "low"       // 低风险
    RiskLevelMedium    RiskLevel = "medium"    // 中风险
    RiskLevelHigh      RiskLevel = "high"      // 高风险
)
```

### 3. 系统配置 (`models/admin/config.go`)

```go
type SystemConfig struct {
    Key             string               `bson:"key" json:"key"`
    Value           interface{}          `bson:"value" json:"value"`
    Type            ConfigType           `bson:"type" json:"type"`
    Category        string               `bson:"category" json:"category"`
    Description     string               `bson:"description" json:"description"`
    DefaultValue   interface{}          `bson:"default_value" json:"defaultValue"`
    IsRequired      bool                 `bson:"is_required" json:"isRequired"`
    IsPublic        bool                 `bson:"is_public" json:"isPublic"`
    Validation      string               `bson:"validation,omitempty" json:"validation,omitempty"`
    Options         []ConfigOption       `bson:"options,omitempty" json:"options,omitempty"`

    // 安全设置
    IsSensitive     bool                 `bson:"is_sensitive" json:"isSensitive"`
    Encrypted       bool                 `bson:"encrypted" json:"encrypted"`

    // 元数据
    UpdatedBy       primitive.ObjectID   `bson:"updated_by" json:"updatedBy"`
    UpdatedAt       time.Time            `bson:"updated_at" json:"updatedAt"`
    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`
}

type ConfigType string

const (
    ConfigTypeString   ConfigType = "string"   // 字符串
    ConfigTypeNumber   ConfigType = "number"   // 数字
    ConfigTypeBoolean  ConfigType = "boolean"  // 布尔值
    ConfigTypeJSON     ConfigType = "json"     // JSON对象
    ConfigTypeArray    ConfigType = "array"    // 数组
)

type ConfigOption struct {
    Label    string      `bson:"label" json:"label"`
    Value    interface{} `bson:"value" json:"value"`
}
```

### 4. 统计数据 (`models/admin/statistics.go`)

```go
type SystemStatistics struct {
    // 用户统计
    TotalUsers      int64     `json:"totalUsers"`
    ActiveUsers     int64     `json:"activeUsers"`
    NewUsersToday   int64     `json:"newUsersToday"`
    NewUsersWeek    int64     `json:"newUsersWeek"`
    BannedUsers     int64     `json:"bannedUsers"`

    // 内容统计
    TotalBooks      int64     `json:"totalBooks"`
    PublishedBooks int64     `json:"publishedBooks"`
    DraftBooks      int64     `json:"draftBooks"`
    TotalWords      int64     `json:"totalWords"`
    TotalChapters   int64     `json:"totalChapters"`

    // 互动统计
    TotalComments   int64     `json:"totalComments"`
    TotalLikes      int64     `json:"totalLikes"`
    TotalViews      int64     `json:"totalViews"`

    // 财务统计
    TotalRevenue    float64   `json:"totalRevenue"`
    TodayRevenue    float64   `json:"todayRevenue"`
    PendingWithdrawals float64 `json:"pendingWithdrawals"`

    // 系统状态
    ServerStatus    string    `json:"serverStatus"`
    DatabaseStatus  string    `json:"databaseStatus"`
    CacheStatus     string    `json:"cacheStatus"`

    UpdatedAt       time.Time `json:"updatedAt"`
}

type OperationLog struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    AdminID         primitive.ObjectID   `bson:"admin_id" json:"adminId"`
    AdminName       string               `bson:"admin_name" json:"adminName"`
    Action          string               `bson:"action" json:"action"`
    ResourceType    string               `bson:"resource_type" json:"resourceType"`
    ResourceID      string               `bson:"resource_id" json:"resourceId"`
    Details         map[string]interface{} `bson:"details,omitempty" json:"details,omitempty"`
    IPAddress       string               `bson:"ip_address" json:"ipAddress"`
    UserAgent       string               `bson:"user_agent" json:"userAgent"`
    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`
}
```

## API端点列表

| 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|
| GET | /api/v1/admin/users | 获取用户列表 | 管理员 |
| GET | /api/v1/admin/users/:id | 获取用户详情 | 管理员 |
| PUT | /api/v1/admin/users/:id | 更新用户信息 | 管理员 |
| DELETE | /api/v1/admin/users/:id | 删除用户 | 超级管理员 |
| POST | /api/v1/admin/users/:id/ban | 封禁用户 | 管理员 |
| POST | /api/v1/admin/users/:id/unban | 解封用户 | 管理员 |
| GET | /api/v1/admin/audit/pending | 获取待审核列表 | 管理员 |
| GET | /api/v1/admin/audit/high-risk | 获取高风险审核 | 管理员 |
| GET | /api/v1/admin/audit/statistics | 获取审核统计 | 管理员 |
| POST | /api/v1/admin/audit/:id/review | 审核内容 | 管理员 |
| POST | /api/v1/admin/audit/:id/appeal/review | 处理申诉 | 管理员 |
| GET | /api/v1/admin/quota/:userId | 获取用户配额详情 | 管理员 |
| PUT | /api/v1/admin/quota/:userId | 更新用户配额 | 管理员 |
| POST | /api/v1/admin/quota/:userId/suspend | 暂停用户配额 | 管理员 |
| POST | /api/v1/admin/quota/:userId/activate | 激活用户配额 | 管理员 |
| GET | /api/v1/admin/quota/all | 获取所有配额 | 管理员 |
| GET | /api/v1/admin/quota/statistics | 获取配额统计 | 管理员 |
| GET | /api/v1/admin/stats | 获取系统统计 | 管理员 |
| GET | /api/v1/admin/operation-logs | 获取操作日志 | 管理员 |
| GET | /api/v1/admin/config | 获取所有配置 | 管理员 |
| GET | /api/v1/admin/config/:key | 获取配置项 | 管理员 |
| PUT | /api/v1/admin/config | 更新配置 | 管理员 |
| PUT | /api/v1/admin/config/batch | 批量更新配置 | 管理员 |
| POST | /api/v1/admin/config/validate | 验证配置 | 管理员 |
| GET | /api/v1/admin/config/backups | 获取配置备份 | 管理员 |
| POST | /api/v1/admin/config/restore | 恢复配置备份 | 管理员 |
| POST | /api/v1/admin/withdraw/review | 审核提现 | 管理员 |
| GET | /api/v1/admin/announcements | 获取公告列表 | 管理员 |
| POST | /api/v1/admin/announcements | 创建公告 | 管理员 |
| GET | /api/v1/admin/announcements/:id | 获取公告详情 | 管理员 |
| PUT | /api/v1/admin/announcements/:id | 更新公告 | 管理员 |
| DELETE | /api/v1/admin/announcements/:id | 删除公告 | 管理员 |
| PUT | /api/v1/admin/announcements/batch-status | 批量更新状态 | 管理员 |
| DELETE | /api/v1/admin/announcements/batch-delete | 批量删除 | 管理员 |

## 权限管理

### 管理员权限分级

| 权限 | 超级管理员 | 普通管理员 |
|------|-----------|-----------|
| 用户管理 | ✓ | ✓ |
| 封禁/解封用户 | ✓ | ✓ |
| 删除用户 | ✓ | ✗ |
| 内容审核 | ✓ | ✓ |
| 系统配置 | ✓ | ✓ |
| 敏感配置 | ✓ | ✗ |
| 财务管理 | ✓ | ✗ |
| 配额管理 | ✓ | ✓ |

### 权限检查中间件

```go
func RequirePermission(resource, action string) gin.HandlerFunc {
    return func(c *gin.Context) {
        // 检查管理员是否有权限
        // 允许或拒绝访问
    }
}
```

## 审核流程

### 内容审核流程
```
1. 用户提交内容
   ↓
2. 系统自动检测（敏感词、规则）
   ↓
3. 评估风险等级
   ↓
4a. 低风险 → 自动通过
   ↓
4b. 中风险 → 人工审核
   ↓
4c. 高风险 → 拒绝并记录
   ↓
5. 审核结果通知
   ↓
6. 申诉处理（如需要）
```

### 申诉处理
```
1. 用户提交申诉
   ↓
2. 管理员审核申诉
   ↓
3. 维持原判或撤销原判
   ↓
4. 更新审核记录
   ↓
5. 通知用户结果
```

## 系统配置分类

### 1. 内容配置
```go
const (
    ConfigContentModerationEnabled = "content.moderation.enabled"
    ConfigContentAutoApprove      = "content.auto_approve"
    ConfigSensitiveWordsEnabled   = "sensitive_words.enabled"
    ConfigContentMinLength        = "content.min_length"
)
```

### 2. 用户配置
```go
const (
    ConfigUserDefaultStatus     = "user.default_status"
    ConfigUserEmailVerified     = "user.email_verified_required"
    ConfigUserPhoneVerified     = "user.phone_verified_required"
)
```

### 3. 支付配置
```go
const (
    ConfigPaymentEnabled        = "payment.enabled"
    ConfigPaymentMinWithdraw   = "payment.min_withdraw"
    ConfigPaymentWithdrawRate   = "payment.withdraw_rate"
)
```

### 4. 系统配置
```go
const (
    ConfigSystemMaintenanceMode  = "system.maintenance_mode"
    ConfigSystemAllowRegistration = "system.allow_registration"
    ConfigSystemMaxUploadSize    = "system.max_upload_size"
)
```

## 数据安全

1. **敏感信息加密**
   - 数据库字段加密
   - 配置项加密存储

2. **操作日志**
   - 记录所有管理操作
   - 不可篡改的日志

3. **备份机制**
   - 配置自动备份
   - 数据定期备份

## 性能优化

1. **统计计算**
   - 定时任务异步计算
   - 缓存统计结果

2. **日志管理**
   - 日志轮转
   - 归档历史日志
