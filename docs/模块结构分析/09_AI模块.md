# AI模块结构分析

## 模块概述

AI模块为平台提供智能写作辅助和对话功能，包括AI聊天、创意写作、配额管理等核心能力。该模块采用Go与Python混合架构，Go服务负责API和配额管理，Python服务（基于LangChain）负责复杂的AI任务处理。

## 目录结构

```
AI模块/
├── api/v1/ai/                    # AI API层
│   ├── chat_api.go              # 聊天API
│   ├── creative_api.go          # 创意写作API
│   ├── quota_api.go             # 配额管理API
│   ├── writing_api.go           # AI写作辅助API
│   └── system_api.go            # 系统操作API
├── service/ai/                   # AI服务层
│   ├── ai_service.go            # 核心AI服务
│   ├── chat_service.go          # 聊天服务
│   ├── quota_service.go         # 配额服务（带Redis缓存）
│   ├── context_service.go       # 上下文管理服务
│   └── phase3_client.go         # Python AI服务的gRPC客户端
├── repository/
│   ├── interfaces/ai/           # 仓储接口
│   └── mongodb/ai/              # MongoDB仓储实现
│       └── quota_repository_mongo.go
├── models/ai/                    # 数据模型
│   ├── chat_session.go          # 聊天会话模型
│   ├── user_quota.go            # 配额管理模型
│   ├── context.go               # AI上下文模型
│   ├── context_dto.go           # 上下文DTO
│   └── novel_context.go         # 小说专用上下文
└── python_ai_service/            # Python AI服务
    ├── src/
    │   ├── agents/              # LangChain代理
    │   ├── api/                 # API定义
    │   ├── grpc_service/        # gRPC服务实现
    │   ├── workflows/           # 创意工作流
    │   └── infrastructure/      # 外部集成
    └── requirements.txt
```

## 核心组件

### 1. 聊天API (`api/v1/ai/chat_api.go`)

```go
type ChatAPI struct {
    chatService    ai.ChatService
    quotaService   ai.QuotaService
}

// 主要接口：
- SendMessage(ctx)                // 发送消息
- SendMessageStream(ctx)          // 流式发送消息（SSE）
- GetChatSessions(ctx)            // 获取会话列表
- GetChatHistory(ctx)             // 获取聊天历史
- DeleteChatSession(ctx)          // 删除会话
- ClearChatHistory(ctx)           // 清空历史
```

### 2. 创意写作API (`api/v1/ai/creative_api.go`)

```go
type CreativeAPI struct {
    phase3Client  *phase3client.Phase3Client
    quotaService  ai.QuotaService
}

// 主要接口：
- GenerateOutline(ctx)            // 生成故事大纲
- GenerateCharacters(ctx)         // 生成角色设定
- GeneratePlot(ctx)               // 生成情节元素
- ExecuteWorkflow(ctx)            // 执行完整创意工作流
- GetWorkflowStatus(ctx)          // 获取工作流状态
```

### 3. 配额管理API (`api/v1/ai/quota_api.go`)

```go
type QuotaAPI struct {
    quotaService  ai.QuotaService
}

// 主要接口：
- GetUserQuota(ctx)               // 获取用户配额
- GetAllQuotas(ctx)               // 获取所有配额类型
- GetQuotaStatistics(ctx)         // 获取配额统计
- GetQuotaTransactions(ctx)       // 获取交易历史
- RechargeQuota(ctx)              // 充值配额
```

### 4. 聊天服务 (`service/ai/chat_service.go`)

```go
type ChatService interface {
    // 会话管理
    CreateSession(ctx, userID, projectID) (*ChatSession, error)
    GetSession(ctx, sessionID) (*ChatSession, error)
    ListSessions(ctx, userID) ([]*ChatSession, error)
    DeleteSession(ctx, sessionID) error

    // 消息处理
    SendMessage(ctx, sessionID, content) (*ChatMessage, error)
    SendMessageStream(ctx, sessionID, content) (<-chan StreamChunk, error)
    GetMessages(ctx, sessionID) ([]*ChatMessage, error)

    // 上下文构建
    BuildContext(ctx, sessionID) (*AIContext, error)
}
```

### 5. 配额服务 (`service/ai/quota_service.go`)

```go
type QuotaService interface {
    // 配额查询
    GetUserQuota(ctx, userID, quotaType) (*UserQuota, error)
    GetAllQuotas(ctx, userID) (map[QuotaType]*UserQuota, error)

    // 配额消耗
    ConsumeQuota(ctx, userID, quotaType, amount, serviceType) error
    ConsumeQuotaAsync(ctx, userID, quotaType, amount, serviceType) // 异步消耗（流式）

    // 配额管理
    InitializeQuota(ctx, userID, role) error
    ResetQuota(ctx, userID, quotaType) error
    SuspendQuota(ctx, userID) error
    ActivateQuota(ctx, userID) error

    // 统计查询
    GetQuotaStatistics(ctx, userID) (*QuotaStatistics, error)
    GetQuotaTransactions(ctx, userID, req) ([]*QuotaTransaction, error)

    // 健康检查
    Health(ctx) error
}

// 配额阈值
const (
    WarningThreshold  = 0.20  // 20% 警告
    CriticalThreshold = 0.10  // 10% 严重警告
)
```

### 6. Phase3 gRPC客户端 (`service/ai/phase3_client.go`)

```go
type Phase3Client struct {
    client phase3.Phase3ServiceClient
    conn   *grpc.ClientConn
}

// 主要方法：
- GenerateOutline(ctx, req)        // 生成大纲
- GenerateCharacters(ctx, req)     // 生成角色
- GeneratePlot(ctx, req)           // 生成情节
- ExecuteWorkflow(ctx, req)        // 执行工作流

// 连接配置
const (
    DefaultAddress = "localhost:50051"
    DefaultTimeout = 30 * time.Second
)
```

## 数据模型

### 1. 聊天会话 (`models/ai/chat_session.go`)

```go
type ChatSession struct {
    ID            string           `bson:"_id,omitempty" json:"id"`
    UserID        string           `bson:"user_id" json:"userId"`
    ProjectID     string           `bson:"project_id,omitempty" json:"projectId,omitempty"`
    Title         string           `bson:"title" json:"title"`
    Status        SessionStatus    `bson:"status" json:"status"`
    Settings      ChatSettings     `bson:"settings" json:"settings"`
    Metadata      ChatMetadata     `bson:"metadata" json:"metadata"`
    Messages      []ChatMessage    `bson:"messages,omitempty" json:"messages,omitempty"`
    CreatedAt     time.Time        `bson:"created_at" json:"createdAt"`
    UpdatedAt     time.Time        `bson:"updated_at" json:"updatedAt"`
}

type SessionStatus string

const (
    SessionStatusActive   SessionStatus = "active"    // 活跃
    SessionStatusArchived SessionStatus = "archived"  // 已归档
    SessionStatusDeleted  SessionStatus = "deleted"   // 已删除
)

type ChatSettings struct {
    Model         string  `bson:"model" json:"model"`                     // gpt-4, gpt-3.5-turbo
    Temperature   float64 `bson:"temperature" json:"temperature"`          // 0.0-2.0
    MaxTokens     int     `bson:"max_tokens" json:"maxTokens"`
    TopP          float64 `bson:"top_p,omitempty" json:"topP,omitempty"`
    FrequencyPenalty float64 `bson:"frequency_penalty,omitempty" json:"frequencyPenalty,omitempty"`
    PresencePenalty  float64 `bson:"presence_penalty,omitempty" json:"presencePenalty,omitempty"`
    SystemPrompt  string  `bson:"system_prompt,omitempty" json:"systemPrompt,omitempty"`
}

type ChatMetadata struct {
    MessageCount   int       `bson:"message_count" json:"messageCount"`
    TokenCount     int       `bson:"token_count" json:"tokenCount"`
    Tags           []string  `bson:"tags,omitempty" json:"tags,omitempty"`
    LastActivityAt time.Time `bson:"last_activity_at" json:"lastActivityAt"`
}
```

### 2. 聊天消息 (`models/ai/chat_session.go`)

```go
type ChatMessage struct {
    ID        string       `bson:"id" json:"id"`
    Role      MessageRole  `bson:"role" json:"role"`
    Content   string       `bson:"content" json:"content"`
    TokenUsed int          `bson:"token_used" json:"tokenUsed"`
    Metadata  MessageMeta  `bson:"metadata,omitempty" json:"metadata,omitempty"`
    CreatedAt time.Time    `bson:"created_at" json:"createdAt"`
}

type MessageRole string

const (
    RoleSystem    MessageRole = "system"
    RoleUser      MessageRole = "user"
    RoleAssistant MessageRole = "assistant"
)

type MessageMeta struct {
    Sentiment string                 `json:"sentiment,omitempty"` // positive/neutral/negative
    Intent    string                 `json:"intent,omitempty"`
    Entities  map[string]interface{} `json:"entities,omitempty"`
}
```

### 3. AI上下文 (`models/ai/context.go`)

```go
type AIContext struct {
    // 项目信息
    ProjectID    string          `bson:"project_id,omitempty" json:"projectId,omitempty"`
    ProjectType  string          `bson:"project_type,omitempty" json:"projectType,omitempty"`

    // 世界观设定
    WorldSettings WorldSettings  `bson:"world_settings,omitempty" json:"worldSettings,omitempty"`

    // 角色信息
    Characters []CharacterInfo   `bson:"characters,omitempty" json:"characters,omitempty"`

    // 情节线
    PlotThreads []PlotThread     `bson:"plot_threads,omitempty" json:"plotThreads,omitempty"`

    // 章节大纲
    ChapterOutline []ChapterOutline `bson:"chapter_outline,omitempty" json:"chapterOutline,omitempty"`

    // 写作风格
    WritingStyle WritingStyle    `bson:"writing_style,omitempty" json:"writingStyle,omitempty"`

    // 自定义指令
    CustomInstructions string     `bson:"custom_instructions,omitempty" json:"customInstructions,omitempty"`
}

type WorldSettings struct {
    Genre          string   `bson:"genre,omitempty" json:"genre,omitempty"`
    Theme          string   `bson:"theme,omitempty" json:"theme,omitempty"`
    TimePeriod     string   `bson:"time_period,omitempty" json:"timePeriod,omitempty"`
    Location       string   `bson:"location,omitempty" json:"location,omitempty"`
    MagicSystem    string   `bson:"magic_system,omitempty" json:"magicSystem,omitempty"`
    PowerLevels    []string `bson:"power_levels,omitempty" json:"powerLevels,omitempty"`
    Rules          []string `bson:"rules,omitempty" json:"rules,omitempty"`
}

type CharacterInfo struct {
    Name         string   `bson:"name" json:"name"`
    Role         string   `bson:"role" json:"role"`           // protagonist/antagonist/supporting
    Personality  []string `bson:"personality,omitempty" json:"personality,omitempty"`
    Background   string   `bson:"background,omitempty" json:"background,omitempty"`
    Goals        []string `bson:"goals,omitempty" json:"goals,omitempty"`
    Conflicts    []string `bson:"conflicts,omitempty" json:"conflicts,omitempty"`
    Relationships map[string]string `bson:"relationships,omitempty" json:"relationships,omitempty"`
}

type PlotThread struct {
    ID          string   `bson:"id" json:"id"`
    Name        string   `bson:"name" json:"name"`
    Description string   `bson:"description,omitempty" json:"description,omitempty"`
    Status      string   `bson:"status,omitempty" json:"status,omitempty"` // active/resolved/abandoned
    Events      []string `bson:"events,omitempty" json:"events,omitempty"`
}

type ChapterOutline struct {
    ChapterNumber  int      `bson:"chapter_number" json:"chapterNumber"`
    Title          string   `bson:"title" json:"title"`
    Summary        string   `bson:"summary" json:"summary"`
    KeyEvents      []string `bson:"key_events,omitempty" json:"keyEvents,omitempty"`
    Characters     []string `bson:"characters,omitempty" json:"characters,omitempty"`
    WordCountTarget int     `bson:"word_count_target,omitempty" json:"wordCountTarget,omitempty"`
}

type WritingStyle struct {
    Tone          string   `bson:"tone,omitempty" json:"tone,omitempty"`
    Voice         string   `bson:"voice,omitempty" json:"voice,omitempty"`
    Pov           string   `bson:"pov,omitempty" json:"pov,omitempty"`  // first/third/omniscient
    Tense         string   `bson:"tense,omitempty" json:"tense,omitempty"` // past/present
    DescriptionStyle string `bson:"description_style,omitempty" json:"descriptionStyle,omitempty"`
    DialogueStyle   string `bson:"dialogue_style,omitempty" json:"dialogueStyle,omitempty"`
}
```

## 核心功能

### 1. AI聊天系统

**功能描述**：
- 持久化会话管理
- 上下文感知对话
- 流式响应支持（SSE）
- 多模型切换
- 自定义系统提示

**聊天流程**：
```
1. 创建会话或获取现有会话
   ↓
2. 用户发送消息
   ↓
3. 检查配额
   ↓
4. 构建上下文（系统提示 + 历史消息）
   ↓
5. 调用AI模型
   ↓
6. 流式返回响应
   ↓
7. 消耗配额
   ↓
8. 保存消息记录
```

**主要API**：
```
POST   /api/v1/ai/chat                    // 发送消息
POST   /api/v1/ai/chat/stream             // 流式发送消息
GET    /api/v1/ai/chat/sessions           // 获取会话列表
GET    /api/v1/ai/chat/sessions/:id       // 获取会话详情
DELETE /api/v1/ai/chat/sessions/:id       // 删除会话
```

### 2. 创意写作工作流

**工作流阶段**：

**阶段1：大纲生成**
```
用户输入：故事类型、主题、角色数量
  ↓
AI生成：故事大纲、主要情节线、章节规划
  ↓
人工审核：确认或修改大纲
```

**阶段2：角色设定**
```
用户输入：角色名称、角色定位
  ↓
AI生成：详细角色档案（性格、背景、目标、冲突）
  ↓
人工审核：确认或修改角色设定
```

**阶段3：情节细化**
```
用户输入：章节范围、具体要求
  ↓
AI生成：详细情节安排、事件序列、对话建议
  ↓
人工审核：确认或修改情节
```

**完整工作流API**：
```
POST /api/v1/ai/creative/workflow
{
  "project_id": "xxx",
  "workflow_type": "full_novel",
  "params": {
    "genre": "玄幻",
    "theme": "成长",
    "chapter_count": 100,
    "main_character_count": 3
  }
}
```

**响应**：
```json
{
  "workflow_id": "xxx",
  "status": "in_progress",
  "stages": [
    {"name": "outline", "status": "completed", "result": {...}},
    {"name": "characters", "status": "in_progress"},
    {"name": "plot", "status": "pending"}
  ]
}
```

### 3. AI写作辅助

**功能列表**：
- 内容续写
- 润色改写
- 风格迁移
- 情节建议
- 对话生成
- 场景描写

**主要API**：
```
POST /api/v1/ai/writing/continue      // 续写内容
POST /api/v1/ai/writing/polish        // 润色文本
POST /api/v1/ai/writing/rewrite       // 改写内容
POST /api/v1/ai/writing/suggest       // 获取建议
POST /api/v1/ai/writing/dialogue      // 生成对话
POST /api/v1/ai/writing/scene         // 生成场景描写
```

### 4. 配额管理系统

**配额类型**：
```go
type QuotaType string

const (
    QuotaTypeDaily   QuotaType = "daily"   // 每日配额（每天重置）
    QuotaTypeMonthly QuotaType = "monthly" // 每月配额（每月重置）
    QuotaTypeTotal   QuotaType = "total"   // 总配额（永久有效）
)
```

**配额分配策略**：
```go
// 基于用户角色的配额分配
type QuotaConfig struct {
    Role           QuotaRole
    DailyQuota     int64
    MonthlyQuota   int64
    TotalQuota     int64
}

type QuotaRole string

const (
    RoleReader  QuotaRole = "reader"   // 普通读者
    RoleWriter  QuotaRole = "writer"   // 认证作者
    RoleVIP     QuotaRole = "vip"      // VIP用户
    RoleAdmin   QuotaRole = "admin"    // 管理员
)

// 默认配额（单位：tokens）
var DefaultQuotas = map[QuotaRole]QuotaConfig{
    RoleReader: {Daily: 10000, Monthly: 200000, Total: 5000000},
    RoleWriter: {Daily: 50000, Monthly: 1000000, Total: 20000000},
    RoleVIP:    {Daily: 100000, Monthly: 2000000, Total: 50000000},
    RoleAdmin:  {Daily: 0, Monthly: 0, Total: 0}, // 无限制
}
```

**配额消耗规则**：
```go
type QuotaCost struct {
    Service    string  // 服务类型
    Model      string  // 模型名称
    InputCost  float64 // 输入单价（每1K tokens）
    OutputCost float64 // 输出单价（每1K tokens）
}

// 服务定价
var QuotaPricing = map[string]QuotaCost{
    "chat": {
        "gpt-4":         {InputCost: 30, OutputCost: 60},
        "gpt-3.5-turbo": {InputCost: 1.5, OutputCost: 2},
    },
    "writing": {
        "gpt-4":         {InputCost: 30, OutputCost: 60},
        "gpt-3.5-turbo": {InputCost: 1.5, OutputCost: 2},
    },
}

// 计算公式
TotalCost = (InputTokens / 1000 * InputCost) + (OutputTokens / 1000 * OutputCost)
```

**阈值警告**：
- 20% 剩余配额 → 发送警告通知
- 10% 剩余配额 → 发送严重警告
- 0% 剩余配额 → 暂停服务

## API端点列表

### 聊天相关
| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| POST | /api/v1/ai/chat | 发送消息 | 是 |
| POST | /api/v1/ai/chat/stream | 流式发送消息 | 是 |
| GET | /api/v1/ai/chat/sessions | 获取会话列表 | 是 |
| GET | /api/v1/ai/chat/sessions/:id | 获取会话详情 | 是 |
| DELETE | /api/v1/ai/chat/sessions/:id | 删除会话 | 是 |
| PUT | /api/v1/ai/chat/sessions/:id | 更新会话设置 | 是 |

### 创意写作相关
| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| POST | /api/v1/ai/creative/outline | 生成大纲 | 是 |
| POST | /api/v1/ai/creative/characters | 生成角色 | 是 |
| POST | /api/v1/ai/creative/plot | 生成情节 | 是 |
| POST | /api/v1/ai/creative/workflow | 执行工作流 | 是 |
| GET | /api/v1/ai/creative/workflow/:id | 获取工作流状态 | 是 |

### 写作辅助相关
| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| POST | /api/v1/ai/writing/continue | 续写内容 | 是 |
| POST | /api/v1/ai/writing/polish | 润色文本 | 是 |
| POST | /api/v1/ai/writing/rewrite | 改写内容 | 是 |
| POST | /api/v1/ai/writing/suggest | 获取建议 | 是 |
| POST | /api/v1/ai/writing/dialogue | 生成对话 | 是 |
| POST | /api/v1/ai/writing/scene | 生成场景 | 是 |

### 配额管理相关
| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| GET | /api/v1/ai/quota | 获取配额信息 | 是 |
| GET | /api/v1/ai/quota/all | 获取所有配额类型 | 是 |
| GET | /api/v1/ai/quota/statistics | 获取配额统计 | 是 |
| GET | /api/v1/ai/quota/transactions | 获取交易历史 | 是 |
| POST | /api/v1/ai/quota/recharge | 充值配额 | 是 |

### 系统管理相关
| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| GET | /api/v1/ai/health | 健康检查 | 否 |
| GET | /api/v1/ai/models | 获取可用模型列表 | 是 |
| GET | /api/v1/ai/usage | 获取使用情况 | 是 |

## Python AI服务

### 服务架构

```
python_ai_service/
├── src/
│   ├── agents/                 # LangChain智能体
│   │   ├── creative_agent.py  # 创意写作智能体
│   │   ├── chat_agent.py      # 聊天智能体
│   │   └── writing_agent.py   # 写作辅助智能体
│   ├── workflows/              # 工作流
│   │   ├── novel_workflow.py  # 小说创作工作流
│   │   └── article_workflow.py # 文章写作工作流
│   ├── grpc_service/           # gRPC服务
│   │   ├── service.proto      # Protocol Buffers定义
│   │   └── server.py          # gRPC服务器
│   └── infrastructure/         # 基础设施
│       ├── llm_providers.py   # LLM提供商集成
│       └── vector_store.py    # 向量存储
└── requirements.txt
```

### LangChain实现

```python
from langchain.agents import AgentExecutor, create_openai_functions_agent
from langchain.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain.tools import Tool
from langchain_openai import ChatOpenAI

class CreativeAgent:
    def __init__(self, model: str = "gpt-4"):
        self.llm = ChatOpenAI(model=model, temperature=0.7)
        self.tools = self._create_tools()
        self.agent = self._create_agent()

    def _create_tools(self):
        return [
            Tool(
                name="generate_outline",
                func=self.generate_outline,
                description="生成故事大纲"
            ),
            Tool(
                name="create_character",
                func=self.create_character,
                description="创建角色档案"
            ),
            Tool(
                name="develop_plot",
                func=self.develop_plot,
                description="发展情节线"
            )
        ]

    def _create_agent(self):
        prompt = ChatPromptTemplate.from_messages([
            ("system", "你是一个专业的创意写作助手"),
            MessagesPlaceholder(variable_name="chat_history"),
            ("human", "{input}"),
            MessagesPlaceholder(variable_name="agent_scratchpad")
        ])

        return create_openai_functions_agent(self.llm, self.tools, prompt)

    async def run(self, input_text: str, context: dict):
        executor = AgentExecutor(
            agent=self.agent,
            tools=self.tools,
            verbose=True,
            handle_parsing_errors=True
        )

        result = await executor.ainvoke({
            "input": input_text,
            "chat_history": context.get("history", []),
            "context": context
        })

        return result
```

### gRPC服务定义

```protobuf
// service.proto
syntax = "proto3";

package phase3;

service Phase3Service {
    rpc GenerateOutline(OutlineRequest) returns (OutlineResponse);
    rpc GenerateCharacters(CharacterRequest) returns (CharacterResponse);
    rpc GeneratePlot(PlotRequest) returns (PlotResponse);
    rpc ExecuteWorkflow(WorkflowRequest) returns (WorkflowResponse);
}

message OutlineRequest {
    string project_id = 1;
    string genre = 2;
    string theme = 3;
    int32 chapter_count = 4;
    map<string, string> context = 5;
}

message OutlineResponse {
    string outline_id = 1;
    string content = 2;
    repeated Chapter chapters = 3;
    map<string, string> metadata = 4;
}
```

## 数据库集合

### ai_chat_sessions 集合
```javascript
{
  _id: ObjectId,
  user_id: String,
  project_id: String,
  title: String,
  status: String,              // active/archived/deleted
  settings: {
    model: String,
    temperature: Number,
    max_tokens: Number,
    system_prompt: String
  },
  metadata: {
    message_count: Number,
    token_count: Number,
    tags: [String],
    last_activity_at: ISODate
  },
  messages: [{
    id: String,
    role: String,             // system/user/assistant
    content: String,
    token_used: Number,
    metadata: {
      sentiment: String,
      intent: String,
      entities: Object
    },
    created_at: ISODate
  }],
  created_at: ISODate,
  updated_at: ISODate
}
```

### ai_contexts 集合
```javascript
{
  _id: ObjectId,
  project_id: String,
  project_type: String,
  world_settings: {
    genre: String,
    theme: String,
    time_period: String,
    location: String,
    magic_system: String,
    rules: [String]
  },
  characters: [{
    name: String,
    role: String,
    personality: [String],
    background: String,
    goals: [String],
    conflicts: [String],
    relationships: Object
  }],
  plot_threads: [{
    id: String,
    name: String,
    description: String,
    status: String,
    events: [String]
  }],
  chapter_outline: [{
    chapter_number: Number,
    title: String,
    summary: String,
    key_events: [String],
    characters: [String],
    word_count_target: Number
  }],
  writing_style: {
    tone: String,
    voice: String,
    pov: String,
    tense: String
  },
  custom_instructions: String,
  updated_at: ISODate
}
```

## 性能优化

### 1. 配额缓存

```go
// Redis缓存配额信息
type CachedQuota struct {
    UserID         string
    QuotaType      QuotaType
    TotalQuota     int64
    UsedQuota      int64
    RemainingQuota int64
    Status         QuotaStatus
    ExpiresAt      time.Time
}

// 缓存策略
func (s *quotaService) GetUserQuota(ctx context.Context, userID string, quotaType QuotaType) (*UserQuota, error) {
    // 1. 尝试从Redis获取
    cached, err := s.redis.Get(ctx, cacheKey(userID, quotaType))
    if err == nil {
        return cached, nil
    }

    // 2. 从数据库获取
    quota, err := s.repo.GetByUserAndType(ctx, userID, quotaType)
    if err != nil {
        return nil, err
    }

    // 3. 写入Redis缓存
    s.redis.Set(ctx, cacheKey(userID, quotaType), quota, 5*time.Minute)

    return quota, nil
}
```

### 2. 流式响应

```go
// Server-Sent Events (SSE) 流式响应
func (api *ChatAPI) SendMessageStream(c *gin.Context) {
    ctx := c.Request.Context()
    userID := c.GetString("userId")

    // 设置SSE响应头
    c.Writer.Header().Set("Content-Type", "text/event-stream")
    c.Writer.Header().Set("Cache-Control", "no-cache")
    c.Writer.Header().Set("Connection", "keep-alive")

    // 创建流式通道
    stream, err := api.chatService.SendMessageStream(ctx, sessionID, content)
    if err != nil {
        c.SSErr("Error", err.Error())
        return
    }

    // 发送流式数据
    for chunk := range stream {
        if chunk.Error != nil {
            c.SSErr("Error", chunk.Error.Error())
            break
        }

        c.SSEvent("message", chunk.Data)
        c.Writer.Flush()
    }
}
```

### 3. 异步配额消耗

```go
// 流式响应时的异步配额消耗
func (s *chatService) SendMessageStream(ctx context.Context, sessionID, content string) (<-chan StreamChunk, error) {
    stream := make(chan StreamChunk)

    go func() {
        defer close(stream)

        // 1. 发送消息到AI
        respChan, err := s.aiClient.ChatStream(ctx, content)
        if err != nil {
            stream <- StreamChunk{Error: err}
            return
        }

        var totalTokens int

        // 2. 流式接收响应
        for chunk := range respChan {
            totalTokens += chunk.Tokens
            stream <- StreamChunk{Data: chunk.Content}
        }

        // 3. 异步消耗配额
        go func() {
            s.quotaService.ConsumeQuotaAsync(
                context.Background(),
                userID,
                QuotaTypeDaily,
                int64(totalTokens),
                "chat",
            )
        }()
    }()

    return stream, nil
}
```

## 安全考虑

### 1. 内容安全

- 敏感词过滤
- 违规内容检测
- 输出内容审核

### 2. 配额保护

- 防刷机制
- 异常使用检测
- 配额盗用防护

### 3. API安全

- 速率限制
- 请求签名验证
- 敏感信息脱敏

## 扩展功能

### 1. 多模态支持

- 图片生成（DALL-E）
- 图像理解（GPT-4V）
- 语音交互（Whisper/TTS）

### 2. 知识库集成

- RAG（检索增强生成）
- 向量数据库
- 文档索引

### 3. 协作功能

- 多人协作写作
- 版本对比
- 评论反馈
