# 写作创作模块结构分析

## 模块概述

写作创作模块是平台的核心创作工具，为作者提供项目管理、文档编辑、版本控制、AI辅助写作等功能。该模块支持多用户协作、内容审核、统计分析等企业级特性。

## 目录结构

```
写作创作模块/
├── api/v1/
│   ├── writer/                   # 写作API
│   │   ├── project_api.go       # 项目管理
│   │   ├── document_api.go      # 文档管理
│   │   ├── version_api.go       # 版本控制
│   │   └── editor_api.go        # 编辑器功能
│   └── projects/                 # 项目API（兼容路由）
├── service/writer/               # 写作服务层
│   ├── project_service.go       # 项目服务
│   ├── document_service.go      # 文档服务
│   ├── version_service.go       # 版本服务
│   └── editor_service.go        # 编辑器服务
├── repository/interfaces/writer/ # 仓储接口
├── repository/mongodb/writer/    # MongoDB仓储实现
│   ├── project_repository_mongo.go
│   ├── document_repository_mongo.go
│   └── version_repository_mongo.go
└── models/writer/                # 数据模型
    ├── project.go                # 项目实体
    ├── document.go               # 文档实体
    ├── version.go                # 版本实体
    ├── editor.go                 # 编辑器状态
    └── statistics.go             # 统计数据
```

## 核心组件

### 1. 项目管理 API (`api/v1/writer/project_api.go`)

```go
type ProjectAPI struct {
    service writer.ProjectService
}

// 主要接口：
- CreateProject(ctx)         // 创建项目
- ListProjects(ctx)           // 获取项目列表
- GetProject(ctx)             // 获取项目详情
- UpdateProject(ctx)          // 更新项目信息
- DeleteProject(ctx)          // 删除项目
- UpdateProjectStatistics(ctx) // 更新项目统计
- ExportProject(ctx)          // 导出项目
```

**功能特性**：
- 支持个人项目和协作项目
- 项目分类管理（小说、散文、诗歌等）
- 项目状态管理（草稿、连载、完结）
- 协作者权限管理
- 项目统计信息（字数、章节数、更新时间）

### 2. 文档管理 API (`api/v1/writer/document_api.go`)

```go
type DocumentAPI struct {
    service writer.DocumentService
}

// 主要接口：
- CreateDocument(ctx)         // 创建文档
- ListDocuments(ctx)          // 获取文档列表
- GetDocument(ctx)            // 获取文档详情
- UpdateDocument(ctx)         // 更新文档
- DeleteDocument(ctx)         // 删除文档
- MoveDocument(ctx)           // 移动文档
- ReorderDocuments(ctx)       // 重新排序
- GetDocumentTree(ctx)        // 获取文档树
```

**功能特性**：
- 支持层级结构（卷/章节）
- 文档类型（章节、前言、后记等）
- 文档状态（草稿、审核中、已发布）
- 文档锁定机制（防止并发编辑冲突）
- 自动保存功能

### 3. 版本控制 API (`api/v1/writer/version_api.go`)

```go
type VersionAPI struct {
    service writer.VersionService
}

// 主要接口：
- GetVersionHistory(ctx)      // 获取版本历史
- GetVersion(ctx)             // 获取特定版本
- CompareVersions(ctx)        // 版本对比
- RestoreVersion(ctx)         // 恢复到指定版本
```

**功能特性**：
- 自动版本记录（每次保存创建新版本）
- 版本对比（Diff功能）
- 版本回滚
- 版本标签（重要版本标记）

### 4. 编辑器服务 API (`api/v1/writer/editor_api.go`)

```go
type EditorAPI struct {
    service writer.EditorService
}

// 主要接口：
- AutoSaveDocument(ctx)       // 自动保存
- GetSaveStatus(ctx)          // 获取保存状态
- GetDocumentContent(ctx)     // 获取文档内容
- UpdateDocumentContent(ctx)  // 更新文档内容
- CalculateWordCount(ctx)     // 计算字数
- LockDocument(ctx)           // 锁定文档
- UnlockDocument(ctx)         // 解锁文档
```

**功能特性**：
- 实时自动保存（每30秒或手动保存）
- 文档锁定（防止多人同时编辑）
- 字数统计
- 敏感词检测
- 快捷键管理

### 5. 项目服务 (`service/writer/project_service.go`)

```go
type ProjectService interface {
    // 项目管理
    Create(ctx, project) (*Project, error)
    GetByID(ctx, id) (*Project, error)
    Update(ctx, id, updates) (*Project, error)
    Delete(ctx, id) error
    List(ctx, userID, filter) ([]*Project, error)

    // 协作管理
    AddCollaborator(ctx, projectID, userID, role) error
    RemoveCollaborator(ctx, projectID, userID) error
    UpdateCollaboratorRole(ctx, projectID, userID, role) error

    // 统计信息
    GetStatistics(ctx, projectID) (*ProjectStatistics, error)
    UpdateStatistics(ctx, projectID) error

    // 搜索
    SearchProjects(ctx, keyword, filters) ([]*Project, error)
}
```

### 6. 文档服务 (`service/writer/document_service.go`)

```go
type DocumentService interface {
    // 文档管理
    Create(ctx, doc) (*Document, error)
    GetByID(ctx, id) (*Document, error)
    Update(ctx, id, updates) (*Document, error)
    Delete(ctx, id) error
    List(ctx, projectID) ([]*Document, error)
    GetTree(ctx, projectID) (*DocumentTree, error)

    // 内容管理
    GetContent(ctx, id) (*DocumentContent, error)
    UpdateContent(ctx, id, content) error
    AutoSave(ctx, id, content) (*AutoSaveResult, error)

    // 文档操作
    Move(ctx, id, parentID, position) error
    Reorder(ctx, projectID, orders) error

    // 版本管理
    CreateVersion(ctx, docID) (*Version, error)
    GetVersions(ctx, docID) ([]*Version, error)
    RestoreVersion(ctx, docID, versionID) error
}
```

### 7. 编辑器服务 (`service/writer/editor_service.go`)

```go
type EditorService interface {
    // 自动保存
    StartAutoSave(ctx, docID) error
    StopAutoSave(docID) error
    GetSaveStatus(docID) (*SaveStatus, error)

    // 文档锁定
    LockDocument(ctx, docID, userID) error
    UnlockDocument(ctx, docID, userID) error
    GetLockStatus(docID) (*LockStatus, error)

    // 编辑功能
    CalculateWordCount(content) int
    DetectSensitiveWords(content) ([]string, error)
    CheckSpelling(content) ([]SpellingError, error)

    // 快捷键
    GetUserShortcuts(userID) ([]Shortcut, error)
    UpdateUserShortcuts(userID, shortcuts) error
    ResetUserShortcuts(userID) error
}
```

## 数据模型层

### 1. 项目实体 (`models/writer/project.go`)

```go
type Project struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    UserID          primitive.ObjectID   `bson:"user_id" json:"userId"`
    Title           string               `bson:"title" json:"title" validate:"required,max=100"`
    Description     string               `bson:"description" json:"description" validate:"max=500"`
    Cover           string               `bson:"cover" json:"cover"`
    Category        ProjectCategory      `bson:"category" json:"category"`
    Status          ProjectStatus        `bson:"status" json:"status"`
    Tags            []string             `bson:"tags" json:"tags"`
    IsPublic        bool                 `bson:"is_public" json:"isPublic"`
    IsCompleted     bool                 `bson:"is_completed" json:"isCompleted"`

    // 协作信息
    Collaborators   []Collaborator       `bson:"collaborators" json:"collaborators"`

    // 统计信息
    WordCount       int64                `bson:"word_count" json:"wordCount"`
    ChapterCount    int                  `bson:"chapter_count" json:"chapterCount"`
    ReadingCount    int64                `bson:"reading_count" json:"readingCount"`
    CommentCount    int                  `bson:"comment_count" json:"commentCount"`

    // 时间戳
    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`
    UpdatedAt       time.Time            `bson:"updated_at" json:"updatedAt"`
    PublishedAt     *time.Time           `bson:"published_at,omitempty" json:"publishedAt,omitempty"`
    CompletedAt     *time.Time           `bson:"completed_at,omitempty" json:"completedAt,omitempty"`
}

type ProjectCategory string

const (
    CategoryNovel     ProjectCategory = "novel"      // 长篇小说
    CategoryShort     ProjectCategory = "short"      // 短篇小说
    CategoryProse     ProjectCategory = "prose"      // 散文
    CategoryPoetry    ProjectCategory = "poetry"     // 诗歌
    CategoryScript    ProjectCategory = "script"     // 剧本
    CategoryOther     ProjectCategory = "other"      // 其他
)

type ProjectStatus string

const (
    StatusDraft      ProjectStatus = "draft"       // 草稿
    StatusOngoing    ProjectStatus = "ongoing"     // 连载中
    StatusCompleted  ProjectStatus = "completed"   // 已完结
    StatusPaused     ProjectStatus = "paused"      // 暂停更新
)

type Collaborator struct {
    UserID      primitive.ObjectID `bson:"user_id" json:"userId"`
    Role        CollaboratorRole   `bson:"role" json:"role"`
    JoinedAt    time.Time          `bson:"joined_at" json:"joinedAt"`
}

type CollaboratorRole string

const (
    RoleOwner   CollaboratorRole = "owner"    // 所有者
    RoleEditor  CollaboratorRole = "editor"   // 编辑者
    RoleViewer  CollaboratorRole = "viewer"   // 查看者
)
```

### 2. 文档实体 (`models/writer/document.go`)

```go
type Document struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    ProjectID       primitive.ObjectID   `bson:"project_id" json:"projectId"`
    ParentID        *primitive.ObjectID  `bson:"parent_id,omitempty" json:"parentId,omitempty"`
    Title           string               `bson:"title" json:"title" validate:"required,max=100"`
    Content         string               `bson:"content" json:"content"`
    ContentType     ContentType          `bson:"content_type" json:"contentType"`
    DocumentType    DocumentType         `bson:"document_type" json:"documentType"`
    Order           int                  `bson:"order" json:"order"`
    Depth           int                  `bson:"depth" json:"depth"`
    Status          DocumentStatus       `bson:"status" json:"status"`

    // 权限控制
    IsLocked        bool                 `bson:"is_locked" json:"isLocked"`
    LockedBy        *primitive.ObjectID  `bson:"locked_by,omitempty" json:"lockedBy,omitempty"`
    LockedAt        *time.Time           `bson:"locked_at,omitempty" json:"lockedAt,omitempty"`

    // 版本控制
    CurrentVersion  int                  `bson:"current_version" json:"currentVersion"`

    // 统计信息
    WordCount       int                  `bson:"word_count" json:"wordCount"`
    CharCount       int                  `bson:"char_count" json:"charCount"`
    ReadingTime     int                  `bson:"reading_time" json:"readingTime"` // 预估阅读时间（分钟）

    // 发布信息
    IsPublished     bool                 `bson:"is_published" json:"isPublished"`
    PublishedAt     *time.Time           `bson:"published_at,omitempty" json:"publishedAt,omitempty"`

    // 时间戳
    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`
    UpdatedAt       time.Time            `bson:"updated_at" json:"updatedAt"`
    DeletedAt       *time.Time           `bson:"deleted_at,omitempty" json:"deletedAt,omitempty"`
}

type ContentType string

const (
    ContentTypeText      ContentType = "text"       // 纯文本
    ContentTypeMarkdown  ContentType = "markdown"   // Markdown
    ContentTypeHTML      ContentType = "html"       // HTML
    ContentTypeRichText  ContentType = "richtext"   // 富文本
)

type DocumentType string

const (
    DocTypeVolume     DocumentType = "volume"      // 卷
    DocTypeChapter    DocumentType = "chapter"     // 章节
    DocTypePrologue   DocumentType = "prologue"    // 前言
    DocTypeEpilogue   DocumentType = "epilogue"    // 后记
    DocTypeSideStory  DocumentType = "sidestory"   // 番外
)

type DocumentStatus string

const (
    DocStatusDraft        DocumentStatus = "draft"       // 草稿
    DocStatusReviewing    DocumentStatus = "reviewing"   // 审核中
    DocStatusApproved     DocumentStatus = "approved"    // 已通过
    DocStatusRejected     DocumentStatus = "rejected"    // 已拒绝
    DocStatusPublished    DocumentStatus = "published"   // 已发布
)
```

### 3. 版本实体 (`models/writer/version.go`)

```go
type Version struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    DocumentID      primitive.ObjectID   `bson:"document_id" json:"documentId"`
    VersionNumber   int                  `bson:"version_number" json:"versionNumber"`
    Content         string               `bson:"content" json:"content"`
    WordCount       int                  `bson:"word_count" json:"wordCount"`
    CharCount       int                  `bson:"char_count" json:"charCount"`
    ChangeSummary   string               `bson:"change_summary" json:"changeSummary"`
    IsTagged        bool                 `bson:"is_tagged" json:"isTagged"`
    Tag             string               `bson:"tag,omitempty" json:"tag,omitempty"`
    CreatedBy       primitive.ObjectID   `bson:"created_by" json:"createdBy"`
    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`
}

type VersionDiff struct {
    VersionID1     primitive.ObjectID   `bson:"version_id_1" json:"versionId1"`
    VersionID2     primitive.ObjectID   `bson:"version_id_2" json:"versionId2"`
    DiffType       DiffType             `bson:"diff_type" json:"diffType"`
    Changes        []Change             `bson:"changes" json:"changes"`
    CreatedAt      time.Time            `bson:"created_at" json:"createdAt"`
}

type DiffType string

const (
    DiffTypeWord     DiffType = "word"      // 单词级别
    DiffTypeLine     DiffType = "line"      // 行级别
    DiffTypeChar     DiffType = "char"      // 字符级别
)

type Change struct {
    Type       ChangeType  `bson:"type" json:"type"`
    OldContent string      `bson:"old_content,omitempty" json:"oldContent,omitempty"`
    NewContent string      `bson:"new_content,omitempty" json:"newContent,omitempty"`
    Position   int         `bson:"position" json:"position"`
}

type ChangeType string

const (
    ChangeAdded    ChangeType = "added"      // 新增
    ChangeDeleted  ChangeType = "deleted"    // 删除
    ChangeModified ChangeType = "modified"   // 修改
)
```

## 数据库集合

### projects 集合
```javascript
{
  _id: ObjectId,
  user_id: ObjectId,
  title: String,
  description: String,
  cover: String,
  category: String,  // novel/short/prose/poetry/script/other
  status: String,    // draft/ongoing/completed/paused
  tags: [String],
  is_public: Boolean,
  is_completed: Boolean,
  collaborators: [{
    user_id: ObjectId,
    role: String,    // owner/editor/viewer
    joined_at: ISODate
  }],
  word_count: Number,
  chapter_count: Number,
  reading_count: Number,
  comment_count: Number,
  created_at: ISODate,
  updated_at: ISODate,
  published_at: ISODate,
  completed_at: ISODate
}
```

### documents 集合
```javascript
{
  _id: ObjectId,
  project_id: ObjectId,
  parent_id: ObjectId,
  title: String,
  content: String,
  content_type: String,  // text/markdown/html/richtext
  document_type: String, // volume/chapter/prologue/epilogue/sidestory
  order: Number,
  depth: Number,
  status: String,        // draft/reviewing/approved/rejected/published
  is_locked: Boolean,
  locked_by: ObjectId,
  locked_at: ISODate,
  current_version: Number,
  word_count: Number,
  char_count: Number,
  reading_time: Number,
  is_published: Boolean,
  published_at: ISODate,
  created_at: ISODate,
  updated_at: ISODate,
  deleted_at: ISODate
}
```

### document_versions 集合
```javascript
{
  _id: ObjectId,
  document_id: ObjectId,
  version_number: Number,
  content: String,
  word_count: Number,
  char_count: Number,
  change_summary: String,
  is_tagged: Boolean,
  tag: String,
  created_by: ObjectId,
  created_at: ISODate
}
```

### document_locks 集合
```javascript
{
  _id: ObjectId,
  document_id: ObjectId,
  user_id: ObjectId,
  locked_at: ISODate,
  expires_at: ISODate,
  session_id: String
}
```

## 核心功能流程

### 项目创建流程
```
1. 作者点击"创建项目"
   ↓
2. 填写项目信息（标题、描述、分类等）
   ↓
3. 选择协作设置（公开/私有）
   ↓
4. 后端验证并创建项目
   ↓
5. 初始化项目文档结构（创建默认卷/章节）
   ↓
6. 返回项目ID
```

### 文档编辑流程
```
1. 用户打开文档
   ↓
2. 后端检查文档锁定状态
   ↓
3. 如果未锁定，锁定文档（锁定时间：30分钟）
   ↓
4. 返回文档内容
   ↓
5. 用户编辑
   ↓
6. 自动保存机制触发（每30秒）
   ↓
7. 保存新版本
   ↓
8. 更新字数统计
   ↓
9. 用户关闭文档，释放锁定
```

### 版本控制流程
```
1. 用户修改文档并保存
   ↓
2. 系统创建新版本
   ↓
3. 版本号递增
   ↓
4. 保存版本快照
   ↓
5. 用户可查看版本历史
   ↓
6. 用户可选择版本对比
   ↓
7. 用户可恢复到任意版本
```

## 协作功能

### 协作者角色权限

| 角色 | 读取 | 编辑 | 删除 | 管理 |
|------|------|------|------|------|
| Owner | ✓ | ✓ | ✓ | ✓ |
| Editor | ✓ | ✓ | ✗ | ✗ |
| Viewer | ✓ | ✗ | ✗ | ✗ |

### 实时协作机制
```
1. 文档锁定机制
   - 防止多人同时编辑同一文档
   - 锁定超时自动释放（30分钟）

2. 变更通知
   - 协作者更新通知
   - 评论和批注通知

3. 权限管理
   - 动态添加/移除协作者
   - 角色权限调整
```

## AI集成

### AI写作辅助
```go
type AIWritingService interface {
    // 续写
    ContinueWriting(ctx, prompt, style) (string, error)

    // 改写
    RewriteText(ctx, text, style) (string, error)

    // 扩写
    ExpandText(ctx, text) (string, error)

    // 润色
    PolishText(ctx, text) (string, error)

    // 生成大纲
    GenerateOutline(ctx, topic, category) (*Outline, error)
}
```

### AI配额管理
- 每日免费AI调用次数限制
- 不同用户等级不同配额
- 超出配额需购买

## 敏感词检测

系统内置敏感词库，自动检测文档内容：
- 政治、暴力、色情等敏感内容
- 可配置敏感词库
- 检测结果可标记或自动过滤

## 统计分析

### 项目统计
- 总字数
- 章节数量
- 阅读量
- 评论数
- 收藏数
- 收入统计

### 作者统计
- 作品数量
- 总字数
- 粉丝数
- 收入排行
- 写作活跃度

## API端点列表

| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| POST | /api/v1/writer/projects | 创建项目 | 是 |
| GET | /api/v1/writer/projects | 获取项目列表 | 是 |
| GET | /api/v1/writer/projects/:id | 获取项目详情 | 是 |
| PUT | /api/v1/writer/projects/:id | 更新项目 | 是 |
| DELETE | /api/v1/writer/projects/:id | 删除项目 | 是 |
| POST | /api/v1/writer/project/:projectId/documents | 创建文档 | 是 |
| GET | /api/v1/writer/project/:projectId/documents | 获取文档列表 | 是 |
| GET | /api/v1/writer/documents/:id | 获取文档详情 | 是 |
| PUT | /api/v1/writer/documents/:id | 更新文档 | 是 |
| DELETE | /api/v1/writer/documents/:id | 删除文档 | 是 |
| PUT | /api/v1/writer/documents/:id/move | 移动文档 | 是 |
| POST | /api/v1/writer/documents/:id/autosave | 自动保存 | 是 |
| GET | /api/v1/writer/documents/:id/versions | 获取版本历史 | 是 |
| GET | /api/v1/writer/document/:documentId/versions/:versionId | 获取特定版本 | 是 |
| POST | /api/v1/writer/document/:documentId/versions/compare | 版本对比 | 是 |
| POST | /api/v1/writer/document/:documentId/versions/:versionId/restore | 恢复版本 | 是 |
| GET | /api/v1/writer/documents/:id/content | 获取文档内容 | 是 |
| PUT | /api/v1/writer/documents/:id/content | 更新文档内容 | 是 |
| POST | /api/v1/writer/documents/:id/word-count | 计算字数 | 是 |
| GET | /api/v1/writer/user/shortcuts | 获取用户快捷键 | 是 |
| PUT | /api/v1/writer/user/shortcuts | 更新用户快捷键 | 是 |
| POST | /api/v1/writer/user/shortcuts/reset | 重置快捷键 | 是 |

## 性能优化

1. **文档缓存**
   - Redis 缓存热点文档
   - CDN 分发文档内容

2. **自动保存优化**
   - 防抖处理，避免频繁保存
   - 批量保存变更

3. **搜索优化**
   - 全文索引（MongoDB Atlas Search）
   - 搜索结果缓存

## 扩展点

1. **协作功能增强**
   - 实时协作编辑（WebSocket + OT算法）
   - 评论和批注系统
   - 变更建议和审核流程

2. **导入导出**
   - 支持导入Word、TXT、Markdown
   - 导出为EPUB、PDF、MOBI

3. **模板系统**
   - 预设项目模板
   - 章节模板
   - 风格指南

4. **插件系统**
   - 自定义编辑器插件
   - 第三方工具集成

## 安全考虑

1. **内容安全**
   - 敏感词检测
   - 内容审核机制
   - 违规内容处理

2. **权限控制**
   - 项目访问权限
   - 文档操作权限
   - API访问频率限制

3. **数据保护**
   - 自动备份
   - 版本历史保留
   - 软删除机制
