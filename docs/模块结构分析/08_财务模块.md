# 财务模块结构分析

## 模块概述

财务模块负责平台的财务管理系统，包括用户钱包、充值消费、转账提现、收入分成等功能。该模块采用双钱包系统设计（财务钱包和共享钱包），并集成了AI配额管理系统。

## 目录结构

```
财务模块/
├── api/v1/
│   ├── finance/                  # 财务API
│   │   ├── types.go             # 通用响应类型
│   │   └── wallet_api.go        # 钱包API
│   └── shared/                  # 共享API
│       └── wallet_api.go        # 共享钱包API
├── service/shared/wallet/        # 钱包服务层
│   ├── interfaces.go            # 服务接口定义
│   ├── wallet_service.go        # 钱包基础服务
│   ├── unified_wallet_service.go # 统一钱包服务
│   ├── transaction_service.go   # 交易服务
│   └── withdraw_service.go      # 提现服务
├── repository/
│   ├── interfaces/shared/       # 仓储接口
│   │   └── wallet_repository.go
│   └── mongodb/shared/          # MongoDB仓储实现
│       └── wallet_repository.go
└── models/
    ├── finance/                 # 财务模型
    │   ├── wallet.go           # 钱包、交易、提现模型
    │   └── author_revenue.go   # 作者收入、结算模型
    └── ai/                      # AI配额模型
        └── user_quota.go       # AI配额管理模型
```

## 核心组件

### 1. 钱包管理 API (`api/v1/finance/wallet_api.go`)

```go
type WalletAPI struct {
    service wallet.WalletService
}

// 主要接口：
- GetWalletBalance(ctx)          // 获取钱包余额
- GetWalletInfo(ctx)             // 获取钱包详情
- Recharge(ctx)                  // 钱包充值
- Consume(ctx)                   // 钱包消费
- Transfer(ctx)                  // 转账给其他用户
- GetTransactions(ctx)           // 获取交易记录
- RequestWithdraw(ctx)           // 请求提现
- GetWithdrawals(ctx)            // 获取提现记录
```

### 2. 钱包服务接口 (`service/shared/wallet/interfaces.go`)

```go
type WalletService interface {
    // 钱包管理
    CreateWallet(ctx, userID)         // 创建钱包
    GetWallet(ctx, userID)            // 获取钱包
    GetBalance(ctx, userID)           // 获取余额
    FreezeWallet(ctx, userID)         // 冻结钱包
    UnfreezeWallet(ctx, userID)       // 解冻钱包

    // 交易操作
    Recharge(ctx, userID, amount, method)          // 充值
    Consume(ctx, userID, amount, reason)           // 消费
    Transfer(ctx, fromUserID, toUserID, amount)    // 转账

    // 交易查询
    GetTransaction(ctx, transactionID)             // 获取交易详情
    ListTransactions(ctx, userID, req)             // 获取交易列表

    // 提现管理
    RequestWithdraw(ctx, userID, amount, account)  // 请求提现
    ListWithdrawRequests(ctx, req)                 // 获取提现列表
    ApproveWithdraw(ctx, withdrawID, adminID)      // 批准提现
    RejectWithdraw(ctx, withdrawID, adminID)       // 拒绝提现
    ProcessWithdraw(ctx, withdrawID)               // 处理提现

    // 健康检查
    Health(ctx)                                    // 服务健康检查
}
```

### 3. 统一钱包服务 (`service/shared/wallet/unified_wallet_service.go`)

```go
type UnifiedWalletService struct {
    walletRepo      repository.WalletRepository
    transactionRepo  repository.TransactionRepository
    withdrawRepo     repository.WithdrawRepository
}

// 功能特点：
- 整合钱包、交易、提现服务
- 提供单一入口点
- 业务逻辑验证和协调
- 事务一致性保证
```

## 数据模型

### 1. 钱包 (`models/finance/wallet.go`)

```go
type Wallet struct {
    ID        string      `bson:"_id,omitempty" json:"id"`
    UserID    string      `bson:"user_id" json:"-"`
    Balance   types.Money `bson:"balance_cents" json:"-"`           // 余额（分）
    Frozen    bool        `bson:"frozen" json:"frozen"`             // 是否冻结
    FrozenAt  time.Time   `bson:"frozen_at,omitempty" json:"frozen_at,omitempty"`
    CreatedAt time.Time   `bson:"created_at" json:"-"`
    UpdatedAt time.Time   `bson:"updated_at" json:"-"`
}
```

### 2. 交易记录 (`models/finance/wallet.go`)

```go
type Transaction struct {
    ID              string      `bson:"_id,omitempty" json:"id"`
    UserID          string      `bson:"user_id" json:"-"`
    Type            string      `bson:"type" json:"type"`                // recharge, consume, transfer_in, transfer_out
    Amount          types.Money `bson:"amount_cents" json:"-"`          // 交易金额（分）
    Balance         types.Money `bson:"balance_cents" json:"-"`         // 交易后余额（分）
    RelatedUserID   string      `bson:"related_user_id,omitempty" json:"related_user_id,omitempty"` // 转账相关用户
    Method          string      `bson:"method,omitempty" json:"method,omitempty"`  // 支付方式
    Reason          string      `bson:"reason,omitempty" json:"reason,omitempty"`
    Status          string      `bson:"status" json:"status"`            // pending, success, failed
    OrderNo         string      `bson:"order_no,omitempty" json:"order_no,omitempty"`
    ThirdPartyNo    string      `bson:"third_party_no,omitempty" json:"third_party_no,omitempty"`
    TransactionTime time.Time   `bson:"transaction_time" json:"-"`
    CreatedAt       time.Time   `bson:"created_at" json:"-"`
    UpdatedAt       time.Time   `bson:"updated_at,omitempty" json:"updated_at,omitempty"`
}

type TransactionType string

const (
    TransactionTypeRecharge    TransactionType = "recharge"     // 充值
    TransactionTypeConsume     TransactionType = "consume"      // 消费
    TransactionTypeTransferIn  TransactionType = "transfer_in"  // 转入
    TransactionTypeTransferOut TransactionType = "transfer_out" // 转出
    TransactionTypeWithdraw    TransactionType = "withdraw"     // 提现
    TransactionTypeRefund      TransactionType = "refund"       // 退款
)
```

### 3. 提现请求 (`models/finance/wallet.go`)

```go
type WithdrawRequest struct {
    ID            string      `bson:"_id,omitempty" json:"id"`
    UserID        string      `bson:"user_id" json:"-"`
    Amount        types.Money `bson:"amount_cents" json:"-"`         // 提现金额（分）
    Fee           types.Money `bson:"fee_cents" json:"-"`            // 手续费（分）
    ActualAmount  types.Money `bson:"actual_amount_cents" json:"-"`  // 实际到账金额（分）
    Account       string      `bson:"account" json:"account"`        // 提现账号
    AccountType   string      `bson:"account_type" json:"account_type"`   // alipay, wechat, bank
    AccountName   string      `bson:"account_name,omitempty" json:"account_name,omitempty"`
    Status        string      `bson:"status" json:"status"`           // pending, approved, rejected, processed
    ReviewedBy    string      `bson:"reviewed_by,omitempty" json:"reviewed_by,omitempty"`
    ReviewedAt    time.Time   `bson:"reviewed_at,omitempty" json:"reviewed_at,omitempty"`
    RejectReason  string      `bson:"reject_reason,omitempty" json:"reject_reason,omitempty"`
    ProcessedAt   time.Time   `bson:"processed_at,omitempty" json:"processed_at,omitempty"`
    TransactionID string      `bson:"transaction_id,omitempty" json:"transaction_id,omitempty"`
    OrderNo       string      `bson:"order_no" json:"order_no"`
    CreatedAt     time.Time   `bson:"created_at" json:"-"`
    UpdatedAt     time.Time   `bson:"updated_at" json:"-"`
}

// 注意：提现状态枚举定义在 models/finance/author_revenue.go
// WithdrawStatusPending, WithdrawStatusApproved, WithdrawStatusRejected, WithdrawStatusCompleted, WithdrawStatusFailed
```

### 4. AI配额 (`models/ai/user_quota.go`)

```go
type UserQuota struct {
    ID              string                 `bson:"_id,omitempty" json:"id"`
    UserID          string                 `bson:"user_id" json:"userId"`
    QuotaType       QuotaType              `bson:"quota_type" json:"quotaType"`
    TotalQuota      int64                  `bson:"total_quota" json:"totalQuota"`
    UsedQuota       int64                  `bson:"used_quota" json:"usedQuota"`
    RemainingQuota  int64                  `bson:"remaining_quota" json:"remainingQuota"`
    Status          QuotaStatus            `bson:"status" json:"status"`
    ResetAt         *time.Time             `bson:"reset_at,omitempty" json:"resetAt,omitempty"`
    ExpiresAt       *time.Time             `bson:"expires_at,omitempty" json:"expiresAt,omitempty"`
    Metadata        map[string]interface{} `bson:"metadata,omitempty" json:"metadata,omitempty"`
    CreatedAt       time.Time              `bson:"created_at" json:"createdAt"`
    UpdatedAt       time.Time              `bson:"updated_at" json:"updatedAt"`
}

type QuotaType string

const (
    QuotaTypeDaily   QuotaType = "daily"   // 每日配额
    QuotaTypeMonthly QuotaType = "monthly" // 每月配额
    QuotaTypeTotal   QuotaType = "total"   // 总配额
)

type QuotaStatus string

const (
    QuotaStatusActive    QuotaStatus = "active"     // 激活
    QuotaStatusExhausted QuotaStatus = "exhausted"  // 已耗尽
    QuotaStatusSuspended QuotaStatus = "suspended"  // 暂停
)

type QuotaTransaction struct {
    ID              string                 `bson:"_id,omitempty" json:"id"`
    UserID          string                 `bson:"user_id" json:"userId"`
    QuotaType       QuotaType              `bson:"quota_type" json:"quotaType"`
    Amount          int64                  `bson:"amount" json:"amount"`                    // 消耗数量
    Type            QuotaTransactionType   `bson:"type" json:"type"`                        // consume/recharge
    Service         string                 `bson:"service" json:"service"`                  // chat/writing/image
    Model           string                 `bson:"model,omitempty" json:"model,omitempty"`
    RequestID       string                 `bson:"request_id,omitempty" json:"requestId,omitempty"`
    Description     string                 `bson:"description,omitempty" json:"description,omitempty"`
    BeforeBalance   int64                  `bson:"before_balance" json:"beforeBalance"`
    AfterBalance    int64                  `bson:"after_balance" json:"afterBalance"`
    Timestamp       time.Time              `bson:"timestamp" json:"timestamp"`
}
```

## 数据库集合

### wallets 集合
```javascript
{
  _id: ObjectId,
  user_id: String,
  balance: Number,
  frozen: Boolean,
  frozen_at: ISODate,
  created_at: ISODate,
  updated_at: ISODate
}
```

### transactions 集合
```javascript
{
  _id: ObjectId,
  user_id: String,
  type: String,              // recharge/consume/transfer_in/transfer_out/withdraw/refund
  amount: Number,
  balance: Number,
  related_user_id: String,
  method: String,
  reason: String,
  status: String,            // pending/success/failed
  order_no: String,
  third_party_no: String,
  transaction_time: ISODate,
  created_at: ISODate,
  updated_at: ISODate
}
```

### withdraw_requests 集合
```javascript
{
  _id: ObjectId,
  user_id: String,
  amount: Number,
  fee: Number,
  actual_amount: Number,
  account: String,
  account_type: String,      // alipay/wechat/bank
  account_name: String,
  status: String,            // pending/approved/rejected/processed
  reviewed_by: String,
  reviewed_at: ISODate,
  reject_reason: String,
  processed_at: ISODate,
  transaction_id: String,
  order_no: String,
  created_at: ISODate,
  updated_at: ISODate
}
```

### ai_user_quotas 集合
```javascript
{
  _id: ObjectId,
  user_id: String,
  quota_type: String,        // daily/monthly/total
  total_quota: Number,
  used_quota: Number,
  remaining_quota: Number,
  status: String,            // active/exhausted/suspended
  reset_at: ISODate,
  expires_at: ISODate,
  metadata: {
    role: String,            // reader/writer
    membership_level: String
  },
  created_at: ISODate,
  updated_at: ISODate
}
```

### ai_quota_transactions 集合
```javascript
{
  _id: ObjectId,
  user_id: String,
  quota_type: String,
  amount: Number,
  type: String,              // consume/recharge
  service: String,           // chat/writing/image
  model: String,
  request_id: String,
  description: String,
  before_balance: Number,
  after_balance: Number,
  timestamp: ISODate
}
```

## 核心功能

### 1. 钱包管理

**功能描述**：
- 用户钱包创建
- 钱包余额查询
- 钱包冻结/解冻
- 余额变动通知

**主要API**：
```
GET  /api/v1/finance/wallet/balance          // 获取余额
GET  /api/v1/finance/wallet                 // 获取钱包详情
POST /api/v1/finance/wallet/recharge        // 充值
POST /api/v1/finance/wallet/consume         // 消费
POST /api/v1/finance/wallet/transfer        // 转账
```

### 2. 交易管理

**交易流程**：
```
1. 发起交易请求
   ↓
2. 验证余额和状态
   ↓
3. 创建交易记录（pending）
   ↓
4. 执行交易操作
   ↓
5. 更新交易状态（success/failed）
   ↓
6. 通知用户
```

**交易类型**：
- 充值（recharge）
- 消费（consume）
- 转入（transfer_in）
- 转出（transfer_out）
- 提现（withdraw）
- 退款（refund）

### 3. 提现管理

**提现流程**：
```
1. 用户提交提现申请
   ↓
2. 系统验证余额和限额
   ↓
3. 计算手续费
   ↓
4. 创建提现记录（pending）
   ↓
5. 管理员审核
   ↓
6a. 批准 → 处理打款 → 更新状态（processed）
6b. 拒绝 → 返还余额 → 更新状态（rejected）
```

**提现规则**：
- 最低提现金额限制
- 提现手续费计算
- 每日/每月提现次数限制
- 审核时效要求

### 4. AI配额管理

**配额类型**：
- 每日配额（daily）- 每天重置
- 每月配额（monthly）- 每月重置
- 总配额（total）- 永久有效

**配额分配策略**：
```go
type QuotaAllocation struct {
    Role           string  // 用户角色
    DailyQuota     int64   // 每日配额
    MonthlyQuota   int64   // 每月配额
    TotalQuota     int64   // 总配额
}

// 默认配额分配
const (
    ReaderDailyQuota   = 10000  // 普通读者每日
    WriterDailyQuota   = 50000  // 作者每日
    VIPDailyQuota      = 100000 // VIP每日
)
```

**配额阈值警告**：
- 20% 剩余 - 警告通知
- 10% 剩余 - 严重警告
- 0% 剩余 - 配额耗尽

## API端点列表

### 钱包相关
| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| GET | /api/v1/finance/wallet/balance | 获取余额 | 是 |
| GET | /api/v1/finance/wallet | 获取钱包详情 | 是 |
| POST | /api/v1/finance/wallet/recharge | 充值 | 是 |
| POST | /api/v1/finance/wallet/consume | 消费 | 是 |
| POST | /api/v1/finance/wallet/transfer | 转账 | 是 |
| GET | /api/v1/finance/wallet/transactions | 获取交易记录 | 是 |

### 提现相关
| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| POST | /api/v1/finance/wallet/withdraw | 请求提现 | 是 |
| GET | /api/v1/finance/wallet/withdrawals | 获取提现记录 | 是 |
| PUT | /api/v1/admin/withdraw/:id/approve | 批准提现 | 管理员 |
| PUT | /api/v1/admin/withdraw/:id/reject | 拒绝提现 | 管理员 |
| PUT | /api/v1/admin/withdraw/:id/process | 处理提现 | 管理员 |

### AI配额相关
| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| GET | /api/v1/ai/quota | 获取配额信息 | 是 |
| GET | /api/v1/ai/quota/all | 获取所有配额类型 | 是 |
| GET | /api/v1/ai/quota/statistics | 配额使用统计 | 是 |
| GET | /api/v1/ai/quota/transactions | 配额交易历史 | 是 |
| POST | /api/v1/ai/quota/recharge | 充值配额 | 是 |
| PUT | /api/v1/admin/quota/:userId | 更新用户配额 | 管理员 |
| POST | /api/v1/admin/quota/:userId/suspend | 暂停用户配额 | 管理员 |
| POST | /api/v1/admin/quota/:userId/activate | 激活用户配额 | 管理员 |

## 收入分成系统

### 分成规则

```go
type RevenueShareRule struct {
    Role            string  `json:"role"`              // 角色
    AuthorShare     float64 `json:"authorShare"`       // 作者分成比例
    PlatformShare   float64 `json:"platformShare"`     // 平台分成比例
}

// 默认分成规则
const (
    DefaultAuthorShare    = 0.70  // 作者 70%
    DefaultPlatformShare  = 0.30  // 平台 30%
    VIPAuthorShare        = 0.80  // VIP作者 80%
    VIPPlatformShare      = 0.20  // VIP平台 20%
)
```

### 收入计算

```go
type RevenueCalculator struct {
    BookPrice       float64  // 书籍价格
    ChapterPrice    float64  // 章节价格
    SalesCount      int64    // 销售数量
    AuthorShare     float64  // 作者分成比例
}

// 计算公式
AuthorRevenue = (BookPrice * SalesCount) * AuthorShare - PlatformFee
PlatformRevenue = (BookPrice * SalesCount) * PlatformShare
```

### 结算周期

- 日结算 - 每日统计收入
- 周结算 - 每周生成结算单
- 月结算 - 每月实际打款

## 安全机制

### 1. 交易安全

- 事务一致性保证
- 余额变动原子性
- 幂等性设计
- 防重复提交

### 2. 提现安全

- 多重审核机制
- 账户验证
- 限额控制
- 异常检测

### 3. 数据安全

- 敏感信息加密
- 交易记录不可篡改
- 审计日志
- 定期对账

## 性能优化

### 1. 缓存策略

- Redis 缓存余额
- 配额信息缓存
- 热点数据预加载

### 2. 数据库优化

- 合理索引设计
- 交易记录分区
- 历史数据归档

### 3. 异步处理

- 充值回调异步
- 通知异步发送
- 统计异步计算

## 监控告警

### 关键指标

- 交易成功率
- 提现处理时长
- 配额消耗速率
- 异常交易比例

### 告警规则

- 余额不足告警
- 大额交易告警
- 提现超时告警
- 系统异常告警
