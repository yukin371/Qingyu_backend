# 认证授权模块结构分析

## 模块概述

认证授权模块负责用户身份验证、授权和账户管理，是整个系统安全的基础。该模块采用JWT令牌机制，支持基于角色的访问控制(RBAC)。

## 目录结构

```
认证授权模块/
├── api/v1/
│   ├── user/                      # 用户API
│   │   ├── user_api.go           # 用户基本操作
│   │   ├── profile_api.go        # 用户资料
│   │   └── password_api.go       # 密码管理
│   └── shared/                    # 共享认证API
│       └── auth_api.go           # 登录/注册/令牌刷新
├── service/user/                   # 用户服务层
│   ├── user_service.go           # 用户业务逻辑
│   └── password_service.go       # 密码服务
├── repository/interfaces/user/    # 用户仓储接口
├── repository/mongodb/user/        # MongoDB仓储实现
│   ├── user_repository_mongo.go  # 用户CRUD
│   └── password_reset_repository_mongo.go  # 密码重置
└── models/users/                   # 数据模型
    ├── user.go                   # 用户实体
    ├── user_stats.go             # 用户统计
    └── password_reset.go         # 密码重置
```

## 核心组件

### 1. API层 (api/v1/)

#### 1.1 用户基本操作 API (`api/v1/user/user_api.go`)
```go
type UserAPI struct {
    service userService.UserService
}

// 主要接口：
- Register(ctx)              // 用户注册
- Login(ctx)                 // 用户登录
- Logout(ctx)                // 用户登出
- GetUserProfile(ctx)        // 获取用户资料
- UpdateUserProfile(ctx)     // 更新用户资料
- ChangePassword(ctx)         // 修改密码
- GetUserBooks(ctx)           // 获取用户作品列表
```

#### 1.2 认证共享 API (`api/v1/shared/auth_api.go`)
```go
type AuthAPI struct {
    authService userService.AuthService
}

// 主要接口：
- Register(ctx)              // 注册（带邮箱/手机验证）
- Login(ctx)                 // 登录
- Logout(ctx)                // 登出
- RefreshToken(ctx)          // 刷新令牌
- GetUserPermissions(ctx)    // 获取用户权限
- GetUserRoles(ctx)          // 获取用户角色
```

### 2. 服务层 (service/user/)

#### 2.1 用户服务 (`service/user/user_service.go`)
```go
type UserService interface {
    // 用户管理
    Create(ctx, user) (*User, error)
    GetByID(ctx, id) (*User, error)
    Update(ctx, id, updates) (*User, error)
    Delete(ctx, id) error

    // 认证相关
    Register(ctx, req) (*User, string, error)
    Login(ctx, username, password) (*User, string, error)
    VerifyEmail(ctx, token) error
    VerifyPhone(ctx, phone, code) error

    // 资料管理
    UpdateProfile(ctx, id, profile) (*User, error)
    ChangePassword(ctx, id, old, new) error
    RequestPasswordReset(ctx, email) error
    ResetPassword(ctx, token, password) error

    // 统计信息
    GetUserStats(ctx, id) (*UserStats, error)
}
```

**核心功能**：
- 用户注册时进行邮箱/手机验证
- 使用 bcrypt 对密码进行哈希存储
- JWT 令牌生成和验证
- 密码重置流程管理
- 用户状态管理（活跃/禁用/删除）

### 3. 数据模型层 (models/users/)

#### 3.1 用户实体 (`models/users/user.go`)
```go
type User struct {
    ID              primitive.ObjectID `bson:"_id,omitempty" json:"id"`
    Username        string             `bson:"username" json:"username" validate:"required,min=3,max=20"`
    Email           string             `bson:"email" json:"email" validate:"required,email"`
    Phone           string             `bson:"phone,omitempty" json:"phone,omitempty"`
    PasswordHash    string             `bson:"password_hash" json:"-"`
    Nickname        string             `bson:"nickname" json:"nickname"`
    Avatar          string             `bson:"avatar" json:"avatar"`
    Bio             string             `bson:"bio" json:"bio"`
    Status          UserStatus         `bson:"status" json:"status"`
    Roles           []string           `bson:"roles" json:"roles"`
    EmailVerified   bool               `bson:"email_verified" json:"emailVerified"`
    PhoneVerified   bool               `bson:"phone_verified" json:"phoneVerified"`
    CreatedAt       time.Time          `bson:"created_at" json:"createdAt"`
    UpdatedAt       time.Time          `bson:"updated_at" json:"updatedAt"`
    LastLoginAt     *time.Time         `bson:"last_login_at,omitempty" json:"lastLoginAt,omitempty"`
}

type UserStatus string

const (
    UserStatusActive    UserStatus = "active"     // 活跃
    UserStatusInactive  UserStatus = "inactive"   // 非活跃
    UserStatusBanned    UserStatus = "banned"     // 封禁
    UserStatusDeleted   UserStatus = "deleted"    // 已删除
)
```

#### 3.2 密码重置 (`models/users/password_reset.go`)
```go
type PasswordReset struct {
    ID        primitive.ObjectID `bson:"_id,omitempty" json:"id"`
    Email     string             `bson:"email" json:"email"`
    Token     string             `bson:"token" json:"token"`
    ExpiresAt time.Time          `bson:"expires_at" json:"expiresAt"`
    Used      bool               `bson:"used" json:"used"`
    CreatedAt time.Time          `bson:"created_at" json:"createdAt"`
}
```

### 4. 仓储层 (repository/)

#### 4.1 用户仓储接口 (`repository/interfaces/user/user_repository_interface.go`)
```go
type UserRepository interface {
    // 基础CRUD
    Create(ctx, user) (*User, error)
    GetByID(ctx, id) (*User, error)
    Update(ctx, id, updates) (*User, error)
    Delete(ctx, id) error

    // 查询方法
    GetByEmail(ctx, email) (*User, error)
    GetByUsername(ctx, username) (*User, error)
    GetByPhone(ctx, phone) (*User, error)
    List(ctx, filter, limit, offset) ([]*User, error)

    // 认证相关
    UpdateLastLogin(ctx, id) error
    UpdatePassword(ctx, id, hash) error

    // 统计
    Count(ctx, filter) (int64, error)
    GetStats(ctx) (*UserStats, error)
}
```

#### 4.2 MongoDB 实现 (`repository/mongodb/user/user_repository_mongo.go`)
- 使用 `users` 集合
- 支持邮箱、用户名、手机号唯一索引
- 密码使用 bcrypt 哈希存储
- 支持软删除（status = deleted）

## 认证流程

### 注册流程
```
1. 用户提交注册信息（用户名/邮箱/密码）
   ↓
2. 后端验证信息格式和唯一性
   ↓
3. 创建用户记录（状态：inactive，未验证）
   ↓
4. 发送验证邮件/短信
   ↓
5. 用户点击验证链接或输入验证码
   ↓
6. 激活账户（状态：active）
   ↓
7. 返回JWT令牌
```

### 登录流程
```
1. 用户提交用户名/邮箱和密码
   ↓
2. 后端查询用户记录
   ↓
3. 验证密码（bcrypt比较）
   ↓
4. 检查账户状态（是否被封禁/删除）
   ↓
5. 生成JWT访问令牌和刷新令牌
   ↓
6. 更新最后登录时间
   ↓
7. 返回令牌和用户基本信息
```

### 令牌刷新流程
```
1. 客户端提交刷新令牌
   ↓
2. 后端验证刷新令牌有效性
   ↓
3. 检查令牌是否在黑名单中
   ↓
4. 生成新的访问令牌和刷新令牌
   ↓
5. 将旧刷新令牌加入黑名单
   ↓
6. 返回新令牌
```

## 权限控制

### 角色定义
```go
const (
    RoleUser      = "user"       // 普通用户
    RoleAuthor    = "author"     // 作者
    RoleEditor    = "editor"     // 编辑
    RoleAdmin     = "admin"      // 管理员
    RoleSuperAdmin = "superadmin" // 超级管理员
)
```

### 权限检查中间件
```go
// 基于角色的访问控制
func RequireRole(roles ...string) gin.HandlerFunc {
    return func(c *gin.Context) {
        // 检查用户角色
        // 允许或拒绝访问
    }
}

// 基于权限的访问控制
func RequirePermission(permission string) gin.HandlerFunc {
    return func(c *gin.Context) {
        // 检查用户权限
        // 允许或拒绝访问
    }
}
```

## 数据库集合

### users 集合
```javascript
{
  _id: ObjectId,
  username: String (unique),
  email: String (unique),
  phone: String (unique),
  password_hash: String,
  nickname: String,
  avatar: String,
  bio: String,
  status: String,  // active/inactive/banned/deleted
  roles: [String],
  email_verified: Boolean,
  phone_verified: Boolean,
  created_at: ISODate,
  updated_at: ISODate,
  last_login_at: ISODate
}
```

### password_resets 集合
```javascript
{
  _id: ObjectId,
  email: String,
  token: String (unique),
  expires_at: ISODate,
  used: Boolean,
  created_at: ISODate
}
```

## 安全特性

1. **密码安全**
   - 使用 bcrypt 哈希算法（cost factor: 10）
   - 密码强度验证（最小长度、复杂度要求）
   - 密码重置令牌有效期控制

2. **令牌安全**
   - JWT 签名密钥存储在环境变量
   - 访问令牌有效期：2小时
   - 刷新令牌有效期：7天
   - 令牌黑名单机制（Redis存储）

3. **账户安全**
   - 登录失败次数限制
   - 邮箱/手机验证要求
   - 可疑登录检测
   - 账户封禁/删除状态检查

## API端点列表

| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| POST | /api/v1/shared/auth/register | 用户注册 | 否 |
| POST | /api/v1/shared/auth/login | 用户登录 | 否 |
| POST | /api/v1/shared/auth/logout | 用户登出 | 是 |
| POST | /api/v1/shared/auth/refresh | 刷新令牌 | 否 |
| GET | /api/v1/shared/auth/permissions | 获取权限 | 是 |
| GET | /api/v1/shared/auth/roles | 获取角色 | 是 |
| GET | /api/v1/users/profile | 获取个人资料 | 是 |
| PUT | /api/v1/users/profile | 更新个人资料 | 是 |
| PUT | /api/v1/users/password | 修改密码 | 是 |
| GET | /api/v1/users/:userId/books | 获取用户作品 | 是 |
| POST | /api/v1/users/password/reset | 请求密码重置 | 否 |
| POST | /api/v1/users/password/reset/confirm | 确认密码重置 | 否 |

## 依赖关系

### 依赖的模块
- 无（认证模块是基础模块）

### 被依赖的模块
- 所有其他模块（写作、阅读、社交等）都依赖认证模块进行用户身份验证

### 外部服务
- **邮件服务**: 用于发送验证邮件和密码重置邮件
- **短信服务**: 用于发送手机验证码
- **Redis**: 存储令牌黑名单和验证码

## 配置项

```yaml
auth:
  jwt:
    secret: ${JWT_SECRET}
    access_token_duration: 2h
    refresh_token_duration: 168h  # 7天
  bcrypt:
    cost: 10
  email:
    from: noreply@qingyu.com
    verification_url: https://qingyu.com/verify
    reset_url: https://qingyu.com/reset-password
  password:
    min_length: 8
    require_uppercase: true
    require_lowercase: true
    require_digit: true
    require_special_char: true
```

## 扩展点

1. **第三方登录集成**
   - 可添加 OAuth2.0 支持（微信、QQ、GitHub等）
   - 统一身份认证（SSO）

2. **多因素认证（MFA）**
   - TOTP（基于时间的一次性密码）
   - 短信验证码二次确认

3. **单点登录（SSO）**
   - 支持多个子系统的统一登录
   - CAS 或 OAuth2.0 协议支持

4. **审计日志**
   - 记录所有认证和授权操作
   - 异常登录检测和告警

## 性能优化

1. **缓存策略**
   - Redis 缓存用户基本信息
   - 令牌黑名单使用 Redis 存储

2. **数据库优化**
   - 用户名、邮箱、手机号建立唯一索引
   - 复合索引优化查询性能

3. **异步处理**
   - 邮件发送异步处理
   - 短信发送异步处理

## 监控指标

- 注册成功率
- 登录成功率
- 令牌刷新频率
- 密码重置请求量
- 活跃用户数
- 封禁用户数
