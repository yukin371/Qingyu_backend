# 社交互动模块结构分析

## 模块概述

社交互动模块负责用户之间的互动功能，包括评论系统、点赞收藏、用户关系等。该模块增强了用户参与度和内容传播。

## 目录结构

```
社交互动模块/
├── api/v1/
│   ├── social/                   # 社交API
│   │   ├── comment_api.go      # 评论系统
│   │   ├── like_api.go         # 点赞系统
│   │   └── collection_api.go   # 收藏系统
│   └── reader/                  # 阅读器社交API（兼容路由）
├── service/social/               # 社交服务层
│   ├── comment_service.go      # 评论服务
│   ├── like_service.go         # 点赞服务
│   └── collection_service.go   # 收藏服务
├── repository/interfaces/social/ # 仓储接口
├── repository/mongodb/social/    # MongoDB仓储实现
│   ├── comment_repository_mongo.go
│   ├── like_repository_mongo.go
│   └── collection_repository_mongo.go
└── models/social/                # 数据模型
    ├── comment.go               # 评论
    ├── like.go                  # 点赞
    ├── collection.go            # 收藏
    ├── user_relation.go         # 用户关系
    └── notification.go          # 通知
```

## 核心组件

### 1. 评论系统 API (`api/v1/social/comment_api.go`)

```go
type CommentAPI struct {
    service social.CommentService
}

// 主要接口：
- CreateComment(ctx)           // 创建评论
- GetCommentList(ctx)          // 获取评论列表
- GetCommentDetail(ctx)        // 获取评论详情
- UpdateComment(ctx)           // 更新评论
- DeleteComment(ctx)           // 删除评论
- ReplyComment(ctx)            // 回复评论
- GetCommentThread(ctx)        // 获取评论线程
- LikeComment(ctx)             // 点赞评论
- UnlikeComment(ctx)           // 取消点赞评论
```

### 2. 点赞系统 API (`api/v1/social/like_api.go`)

```go
type LikeAPI struct {
    service social.LikeService
}

// 主要接口：
- LikeBook(ctx)                // 点赞书籍
- UnlikeBook(ctx)              // 取消点赞书籍
- GetBookLikeInfo(ctx)         // 获取点赞信息
- GetUserLikedBooks(ctx)       // 获取用户点赞的书籍
- GetUserLikeStats(ctx)        // 获取用户点赞统计
```

### 3. 收藏系统 API (`api/v1/social/collection_api.go`)

```go
type CollectionAPI struct {
    service social.CollectionService
}

// 主要接口：
- AddCollection(ctx)           // 添加收藏
- GetCollections(ctx)          // 获取收藏列表
- UpdateCollection(ctx)        // 更新收藏
- DeleteCollection(ctx)        // 删除收藏
- CheckCollected(ctx)          // 检查是否已收藏
- GetCollectionsByTag(ctx)     // 按标签获取收藏
- ShareCollection(ctx)         // 分享收藏
- UnshareCollection(ctx)       // 取消分享收藏
- CreateFolder(ctx)            // 创建收藏夹
- GetFolders(ctx)              // 获取收藏夹列表
- UpdateFolder(ctx)            // 更新收藏夹
- DeleteFolder(ctx)            // 删除收藏夹
```

## 数据模型

### 1. 评论 (`models/social/comment.go`)

```go
type Comment struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    UserID          primitive.ObjectID   `bson:"user_id" json:"userId"`
    TargetType      TargetType           `bson:"target_type" json:"targetType"`
    TargetID        primitive.ObjectID   `bson:"target_id" json:"targetId"`
    ParentID        *primitive.ObjectID  `bson:"parent_id,omitempty" json:"parentId,omitempty"`
    RootID          *primitive.ObjectID  `bson:"root_id,omitempty" json:"rootId,omitempty"`

    // 评论内容
    Content         string               `bson:"content" json:"content" validate:"required,max=1000"`
    RichContent     string               `bson:"rich_content,omitempty" json:"richContent,omitempty"`

    // 状态信息
    State           CommentState         `bson:"state" json:"state"`                   // visible/hidden/deleted
    LikeCount       int                  `bson:"like_count" json:"likeCount"`
    ReplyCount      int                  `bson:"reply_count" json:"replyCount"`
    ReportCount     int                  `bson:"report_count" json:"reportCount"

    // 管理信息
    IsPinned        bool                 `bson:"is_pinned" json:"isPinned"`           // 是否置顶
    IsFeatured      bool                 `bson:"is_featured" json:"isFeatured"`       // 是否精选

    // 时间戳
    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`
    UpdatedAt       time.Time            `bson:"updated_at" json:"updatedAt"`
    DeletedAt       *time.Time           `bson:"deleted_at,omitempty" json:"deletedAt,omitempty"`
}

type TargetType string

const (
    TargetTypeBook        TargetType = "book"         // 书籍
    TargetTypeChapter     TargetType = "chapter"      // 章节
    TargetTypeArticle     TargetType = "article"      // 文章
    TargetTypeAnnouncement TargetType = "announcement" // 公告
    TargetTypeProject     TargetType = "project"      // 项目
)

type CommentState string

const (
    CommentStateVisible  CommentState = "visible"   // 可见
    CommentStateHidden   CommentState = "hidden"    // 隐藏
    CommentStateDeleted  CommentState = "deleted"   // 已删除
    CommentStateRejected CommentState = "rejected"  // 已拒绝
)
```

### 2. 点赞 (`models/social/like.go`)

```go
type Like struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    UserID          primitive.ObjectID   `bson:"user_id" json:"userId"`
    TargetType      TargetType           `bson:"target_type" json:"targetType"`
    TargetID        primitive.ObjectID   `bson:"target_id" json:"targetId"`

    // 时间戳
    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`

    // 复合索引
    IndexKey        string               `bson:"index_key" json:"-"` // user_target_type
}

type LikeStatistics struct {
    TargetType      TargetType           `bson:"target_type" json:"targetType"`
    TargetID        primitive.ObjectID   `bson:"target_id" json:"targetId"`
    LikeCount       int64                `bson:"like_count" json:"likeCount"`
}
```

### 3. 收藏 (`models/social/collection.go`)

```go
type Collection struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    UserID          primitive.ObjectID   `bson:"user_id" json:"userId"`
    Title           string               `bson:"title" json:"title" validate:"required,max=100"`
    Description     string               `bson:"description,omitempty" json:"description,omitempty"`
    Cover           string               `bson:"cover,omitempty" json:"cover,omitempty"`

    // 收藏内容
    Items           []CollectionItem     `bson:"items" json:"items"`
    ItemCount       int                  `bson:"item_count" json:"itemCount"`

    // 分类和标签
    FolderID        *primitive.ObjectID  `bson:"folder_id,omitempty" json:"folderId,omitempty"`
    Tags            []string             `bson:"tags" json:"tags"`

    // 设置
    IsPublic        bool                 `bson:"is_public" json:"isPublic"`
    IsFeatured      bool                 `bson:"is_featured" json:"isFeatured"`

    // 统计
    ViewCount       int64                `bson:"view_count" json:"viewCount"`
    LikeCount       int64                `bson:"like_count" json:"likeCount"`
    ForkCount       int64                `bson:"fork_count" json:"forkCount"`      // 被复制次数

    // 时间戳
    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`
    UpdatedAt       time.Time            `bson:"updated_at" json:"updatedAt"`
}

type CollectionItem struct {
    TargetType      TargetType           `bson:"target_type" json:"targetType"`
    TargetID        primitive.ObjectID   `bson:"target_id" json:"targetId"`
    AddedAt         time.Time            `bson:"added_at" json:"addedAt"`
    Note            string               `bson:"note,omitempty" json:"note,omitempty"`
}

type CollectionFolder struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    UserID          primitive.ObjectID   `bson:"user_id" json:"userId"`
    Name            string               `bson:"name" json:"name"`
    Description     string               `bson:"description,omitempty" json:"description,omitempty"`
    Icon            string               `bson:"icon,omitempty" json:"icon,omitempty"`
    Color           string               `bson:"color,omitempty" json:"color,omitempty"`
    Order           int                  `bson:"order" json:"order"`
    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`
    UpdatedAt       time.Time            `bson:"updated_at" json:"updatedAt"`
}
```

## 核心功能

### 1. 评论系统

**评论层级结构**：
```
评论1 (根评论)
  ├─ 回复1.1
  │   └─ 回复1.1.1
  └─ 回复1.2
评论2 (根评论)
  └─ 回复2.1
```

**评论状态管理**：
- `visible` - 正常显示
- `hidden` - 管理员隐藏
- `deleted` - 用户删除
- `rejected` - 审核拒绝

**主要功能**：
- 支持嵌套回复（最多3层）
- 评论点赞
- 评论举报
- 评论置顶
- 精选评论

### 2. 点赞系统

**点赞类型**：
- 书籍点赞
- 章节点赞
- 评论点赞
- 收藏点赞

**点赞统计**：
```go
type LikeStats struct {
    TotalLikes     int64  `json:"totalLikes"`     // 总点赞数
    TodayLikes     int64  `json:"todayLikes"`     // 今日点赞
    WeekLikes      int64  `json:"weekLikes"`      // 本周点赞
    MonthLikes     int64  `json:"monthLikes"`     // 本月点赞
    MostLiked      string `json:"mostLiked"`      // 最喜欢的内容类型
}
```

### 3. 收藏系统

**收藏功能**：
- 创建收藏夹
- 添加内容到收藏
- 收藏夹分类管理
- 收藏分享
- 公开/私密收藏

**收藏类型**：
- 书籍收藏
- 章节收藏
- 评论收藏
- 文章收藏

## 数据库集合

### comments 集合
```javascript
{
  _id: ObjectId,
  user_id: ObjectId,
  target_type: String,  // book/chapter/article/announcement/project
  target_id: ObjectId,
  parent_id: ObjectId,
  root_id: ObjectId,
  content: String,
  rich_content: String,
  state: String,        // visible/hidden/deleted/rejected
  like_count: Number,
  reply_count: Number,
  report_count: Number,
  is_pinned: Boolean,
  is_featured: Boolean,
  created_at: ISODate,
  updated_at: ISODate,
  deleted_at: ISODate
}
```

### likes 集合
```javascript
{
  _id: ObjectId,
  user_id: ObjectId,
  target_type: String,
  target_id: ObjectId,
  created_at: ISODate,
  index_key: String  // user_target_type (复合索引)
}
```

### collections 集合
```javascript
{
  _id: ObjectId,
  user_id: ObjectId,
  title: String,
  description: String,
  cover: String,
  items: [{
    target_type: String,
    target_id: ObjectId,
    added_at: ISODate,
    note: String
  }],
  item_count: Number,
  folder_id: ObjectId,
  tags: [String],
  is_public: Boolean,
  is_featured: Boolean,
  view_count: Number,
  like_count: Number,
  fork_count: Number,
  created_at: ISODate,
  updated_at: ISODate
}
```

### collection_folders 集合
```javascript
{
  _id: ObjectId,
  user_id: ObjectId,
  name: String,
  description: String,
  icon: String,
  color: String,
  order: Number,
  created_at: ISODate,
  updated_at: ISODate
}
```

## API端点列表

### 评论相关
| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| POST | /api/v1/social/comments | 创建评论 | 是 |
| GET | /api/v1/social/comments | 获取评论列表 | 否 |
| GET | /api/v1/social/comments/:id | 获取评论详情 | 否 |
| PUT | /api/v1/social/comments/:id | 更新评论 | 是 |
| DELETE | /api/v1/social/comments/:id | 删除评论 | 是 |
| POST | /api/v1/social/comments/:id/reply | 回复评论 | 是 |
| GET | /api/v1/social/comments/:id/thread | 获取评论线程 | 否 |
| POST | /api/v1/social/comments/:id/like | 点赞评论 | 是 |
| DELETE | /api/v1/social/comments/:id/like | 取消点赞评论 | 是 |

### 点赞相关
| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| POST | /api/v1/social/books/:bookId/like | 点赞书籍 | 是 |
| DELETE | /api/v1/social/books/:bookId/like | 取消点赞书籍 | 是 |
| GET | /api/v1/social/books/:bookId/like/info | 获取点赞信息 | 否 |
| GET | /api/v1/social/likes/books | 获取用户点赞的书籍 | 是 |
| GET | /api/v1/social/likes/stats | 获取用户点赞统计 | 是 |

### 收藏相关
| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| POST | /api/v1/social/collections | 创建收藏 | 是 |
| GET | /api/v1/social/collections | 获取收藏列表 | 是 |
| PUT | /api/v1/social/collections/:id | 更新收藏 | 是 |
| DELETE | /api/v1/social/collections/:id | 删除收藏 | 是 |
| GET | /api/v1/social/collections/check | 检查是否已收藏 | 是 |
| GET | /api/v1/social/collections/by-tag | 按标签获取收藏 | 否 |
| POST | /api/v1/social/collections/:id/share | 分享收藏 | 是 |
| DELETE | /api/v1/social/collections/:id/share | 取消分享收藏 | 是 |
| GET | /api/v1/social/collections/public | 公开收藏列表 | 否 |
| GET | /api/v1/social/collections/stats | 收藏统计 | 是 |
| POST | /api/v1/social/collections/folders | 创建收藏夹 | 是 |
| GET | /api/v1/social/collections/folders | 获取收藏夹列表 | 是 |
| PUT | /api/v1/social/collections/folders/:id | 更新收藏夹 | 是 |
| DELETE | /api/v1/social/collections/folders/:id | 删除收藏夹 | 是 |

## 扩展功能

### 1. 内容推荐
基于用户点赞和收藏行为：
```go
type RecommendationEngine interface {
    // 基于点赞历史推荐
    GetRecommendationsByLikes(userID) ([]Content, error)

    // 基于收藏历史推荐
    GetRecommendationsByCollections(userID) ([]Content, error)

    // 协同过滤推荐
    GetCollaborativeRecommendations(userID) ([]Content, error)
}
```

### 2. 社交图谱
```
用户关系图谱：
- 关注关系
- 好友关系
- 共同收藏/点赞
- 社区发现
```

### 3. 内容质量评分
```go
type QualityScore struct {
    LikeScore       float64  // 点赞分数
    CommentScore    float64  // 评论分数
    CollectionScore float64  // 收藏分数
    ShareScore      float64  // 分享分数
    TotalScore      float64  // 综合分数
}
```

## 性能优化

1. **评论加载优化**
   - 分页加载
   - 懒加载回复
   - 缓存热门评论

2. **点赞统计优化**
   - Redis 缓存点赞数
   - 定期同步到数据库

3. **收藏查询优化**
   - 创建索引
   - 缓存热门收藏

## 安全考虑

1. **内容审核**
   - 敏感词过滤
   - 垃圾评论检测
   - 举报机制

2. **频率限制**
   - 评论发布频率限制
   - 点赞频率限制
   - 防刷榜机制

3. **隐私保护**
   - 私密收藏保护
   - 用户数据脱敏
   - 访问控制
