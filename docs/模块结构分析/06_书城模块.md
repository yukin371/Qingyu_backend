# 书城模块结构分析

## 模块概述

书城模块是平台的内容分发和商业化中心，负责书籍发布、分类管理、评分评论、排行榜、付费阅读等功能。

## 目录结构

```
书城模块/
├── api/v1/
│   └── bookstore/               # 书城API
│       ├── bookstore_api.go    # 书城主页
│       ├── book_detail_api.go  # 书籍详情
│       └── book_rating_api.go  # 评分系统
├── service/bookstore/           # 书城服务层
│   ├── bookstore_service.go   # 书城服务
│   ├── book_detail_service.go # 书籍详情服务
│   ├── search_service.go      # 搜索服务
│   └── ranking_service.go     # 排行榜服务
├── repository/interfaces/bookstore/ # 仓储接口
├── repository/mongodb/bookstore/  # MongoDB仓储实现
├── models/bookstore/            # 数据模型
│   ├── book.go                 # 书籍
│   ├── chapter.go              # 章节
│   ├── category.go             # 分类
│   ├── ranking.go              # 排行榜
│   ├── banner.go               # 横幅
│   └── rating.go               # 评分
└── search/                     # 搜索引擎
    └── indexer.go              # 索引器
```

## 核心组件

### 1. 书城API (`api/v1/bookstore/bookstore_api.go`)

```go
type BookstoreAPI struct {
    service bookstore.BookstoreService
}

// 主要接口：
- GetHomepage(ctx)             // 获取书城首页
- SearchBooks(ctx)             // 搜索书籍
- GetRecommendedBooks(ctx)     // 获取推荐书籍
- GetFeaturedBooks(ctx)        // 获取精选书籍
- GetBooksByCategory(ctx)      // 按分类获取书籍
- GetCategories(ctx)           // 获取分类列表
- GetCategoryTree(ctx)         // 获取分类树
- GetActiveBanners(ctx)        // 获取活跃横幅
- IncrementBannerClick(ctx)   // 增加横幅点击量
```

### 2. 书籍详情API (`api/v1/bookstore/book_detail_api.go`)

```go
type BookDetailAPI struct {
    service bookstore.BookDetailService
}

// 主要接口：
- GetBookDetail(ctx)           // 获取书籍详情
- GetBookChapters(ctx)         // 获取书籍章节
- GetSimilarBooks(ctx)         // 获取相似书籍
- GetBookStatistics(ctx)       // 获取书籍统计
- IncrementBookView(ctx)      // 增加书籍浏览量
```

### 3. 评分API (`api/v1/bookstore/book_rating_api.go`)

```go
type BookRatingAPI struct {
    service bookstore.BookRatingService
}

// 主要接口：
- GetBookRating(ctx)           // 获取书籍评分
- CreateRating(ctx)            // 创建评分
- UpdateRating(ctx)            // 更新评分
- DeleteRating(ctx)            // 删除评分
- GetRatingsByUserID(ctx)      // 获取用户评分历史
```

## 数据模型

### 1. 书籍 (`models/bookstore/book.go`)

```go
type Book struct {
    ID            primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    Title         string               `bson:"title" json:"title"`
    Author        string               `bson:"author" json:"author"`
    AuthorID      primitive.ObjectID   `bson:"author_id,omitempty" json:"authorId,omitempty"`
    Introduction  string               `bson:"introduction" json:"introduction"`
    Cover         string               `bson:"cover" json:"cover"`
    CategoryIDs   []primitive.ObjectID `bson:"category_ids" json:"categoryIds"`
    Categories    []string             `bson:"categories" json:"categories"`
    Tags          []string             `bson:"tags" json:"tags"`
    Status        BookStatus           `bson:"status" json:"status"`
    Rating        float64              `bson:"rating" json:"rating"`
    RatingCount   int64                `bson:"rating_count" json:"ratingCount"`
    ViewCount     int64                `bson:"view_count" json:"viewCount"`
    WordCount     int64                `bson:"word_count" json:"wordCount"`
    ChapterCount  int                  `bson:"chapter_count" json:"chapterCount"`
    Price         float64              `bson:"price" json:"price"`
    IsFree        bool                 `bson:"is_free" json:"isFree"`
    IsRecommended bool                 `bson:"is_recommended" json:"isRecommended"`
    IsFeatured    bool                 `bson:"is_featured" json:"isFeatured"`
    IsHot         bool                 `bson:"is_hot" json:"isHot"`
    PublishedAt   *time.Time           `bson:"published_at,omitempty" json:"publishedAt,omitempty"`
    LastUpdateAt  *time.Time           `bson:"last_update_at,omitempty" json:"lastUpdateAt,omitempty"`
    CreatedAt     time.Time            `bson:"created_at" json:"createdAt"`
    UpdatedAt     time.Time            `bson:"updated_at" json:"updatedAt"`
}

type BookStatus string

const (
    BookStatusDraft     BookStatus = "draft"     // 草稿
    BookStatusOngoing   BookStatus = "ongoing"   // 连载中
    BookStatusCompleted BookStatus = "completed" // 已完结
    BookStatusPaused    BookStatus = "paused"    // 暂停更新
)
```

### 2. 章节 (`models/bookstore/chapter.go`)

```go
type Chapter struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    BookID          primitive.ObjectID   `bson:"book_id" json:"bookId"`
    VolumeNumber    int                  `bson:"volume_number" json:"volumeNumber"`
    ChapterNumber   int                  `bson:"chapter_number" json:"chapterNumber"`
    Title           string               `bson:"title" json:"title"`

    // 内容
    Content         string               `bson:"content,omitempty" json:"content,omitempty"`
    WordCount       int64                `bson:"word_count" json:"wordCount"`

    // 访问控制
    IsPaid          bool                 `bson:"is_paid" json:"isPaid"`
    Price           float64              `bson:"price" json:"price"`
    IsLocked        bool                 `bson:"is_locked" json:"isLocked"`

    // 发布状态
    Status          ChapterStatus        `bson:"status" json:"status"`
    PublishedAt     *time.Time           `bson:"published_at,omitempty" json:"publishedAt,omitempty"`

    // 统计
    ViewCount       int64                `bson:"view_count" json:"viewCount"`

    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`
    UpdatedAt       time.Time            `bson:"updated_at" json:"updatedAt"`
}

type ChapterStatus string

const (
    ChapterStatusDraft      ChapterStatus = "draft"      // 草稿
    ChapterStatusPublished  ChapterStatus = "published"  // 已发布
    ChapterStatusLocked     ChapterStatus = "locked"     // 锁定
)
```

### 3. 分类 (`models/bookstore/category.go`)

```go
type Category struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    Name            string               `bson:"name" json:"name"`
    Description     string               `bson:"description,omitempty" json:"description,omitempty"`
    ParentID        *primitive.ObjectID  `bson:"parent_id,omitempty" json:"parentId,omitempty"`
    Level           int                  `bson:"level" json:"level"`             // 层级（1-3）
    Order           int                  `bson:"order" json:"order"`
    Icon            string               `bson:"icon,omitempty" json:"icon,omitempty"`
    Cover           string               `bson:"cover,omitempty" json:"cover,omitempty"`

    // 统计
    BookCount       int64                `bson:"book_count" json:"bookCount"`

    // 状态
    IsActive        bool                 `bson:"is_active" json:"isActive"`

    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`
    UpdatedAt       time.Time            `bson:"updated_at" json:"updatedAt"`
}

type CategoryTree struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    Name            string               `bson:"name" json:"name"`
    Level           int                  `bson:"level" json:"level"`
    Order           int                  `bson:"order" json:"order"`
    BookCount       int64                `bson:"book_count" json:"bookCount"`
    Children        []*CategoryTree      `bson:"children,omitempty" json:"children,omitempty"`
}
```

### 4. 排行榜 (`models/bookstore/ranking.go`)

```go
type Ranking struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    Type            RankingType         `bson:"type" json:"type"`
    Period          string               `bson:"period" json:"period"`           // YYYY-MM
    Items           []RankingItem        `bson:"items" json:"items"`

    // 统计信息
    TotalViews      int64                `bson:"total_views" json:"totalViews"`
    TotalReads      int64                `bson:"total_reads" json:"totalReads"`

    // 时间
    CalculatedAt    time.Time            `bson:"calculated_at" json:"calculatedAt"`
    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`
}

type RankingType string

const (
    RankingTypeRealtime  RankingType = "realtime"  // 实时榜
    RankingTypeWeekly    RankingType = "weekly"    // 周榜
    RankingTypeMonthly   RankingType = "monthly"   // 月榜
    RankingTypeNewbie    RankingType = "newbie"    // 新人榜
)

type RankingItem struct {
    BookID          primitive.ObjectID   `bson:"book_id" json:"bookId"`
    Book            *BookBasic           `bson:"book,omitempty" json:"book,omitempty"`
    Rank            int                  `bson:"rank" json:"rank"`
    Score           float64              `bson:"score" json:"score"`
    Change          int                  `bson:"change,omitempty" json:"change,omitempty"` // 排名变化
    Badge           string               `bson:"badge,omitempty" json:"badge,omitempty"`
}
```

## 数据库集合

### books 集合
```javascript
{
  _id: ObjectId,
  title: String,
  author: String,
  author_id: ObjectId,
  introduction: String,
  cover: String,
  category_ids: [ObjectId],
  categories: [String],
  tags: [String],
  status: String,            // draft/published/ongoing/completed/paused
  rating: Number,            // 0-10
  rating_count: Number,
  view_count: Number,
  word_count: Number,
  chapter_count: Number,
  price: Number,
  is_free: Boolean,
  is_recommended: Boolean,
  is_featured: Boolean,
  is_hot: Boolean,
  published_at: ISODate,
  last_update_at: ISODate,
  created_at: ISODate,
  updated_at: ISODate
}
```

### chapters 集合
```javascript
{
  _id: ObjectId,
  book_id: ObjectId,
  volume_number: Number,
  chapter_number: Number,
  title: String,
  content: String,
  word_count: Number,
  is_paid: Boolean,
  price: Number,
  is_locked: Boolean,
  status: String,           // draft/published/locked
  view_count: Number,
  published_at: ISODate,
  created_at: ISODate,
  updated_at: ISODate
}
```

### categories 集合
```javascript
{
  _id: ObjectId,
  name: String,
  description: String,
  parent_id: ObjectId,
  level: Number,             // 1-3
  order: Number,
  icon: String,
  cover: String,
  book_count: Number,
  is_active: Boolean,
  created_at: ISODate,
  updated_at: ISODate
}
```

### rankings 集合
```javascript
{
  _id: ObjectId,
  type: String,              // realtime/weekly/monthly/newbie
  period: String,             // YYYY-MM
  items: [{
    book_id: ObjectId,
    rank: Number,
    score: Number,
    change: Number,
    badge: String
  }],
  total_views: Number,
  total_reads: Number,
  calculated_at: ISODate,
  created_at: ISODate
}
```

### ratings 集合
```javascript
{
  _id: ObjectId,
  book_id: ObjectId,
  user_id: ObjectId,
  score: Number,              // 0-10
  comment: String,
  created_at: ISODate,
  updated_at: ISODate
}
```

## 核心功能

### 1. 首页聚合

```go
type HomepageData struct {
    Banners         []*Banner           `json:"banners"`
    Rankings        struct {
        Realtime    []*RankingItem      `json:"realtime"`
        Weekly      []*RankingItem      `json:"weekly"`
        Monthly     []*RankingItem      `json:"monthly"`
        Newbie      []*RankingItem      `json:"newbie"`
    }                           `json:"rankings"`
    RecommendedBooks []*Book            `json:"recommendedBooks"`
    FeaturedBooks    []*Book            `json:"featuredBooks"`
    Categories       []*Category         `json:"categories"`
    NewReleases      []*Book            `json:"newReleases,omitempty"`
    PopularTags      []string            `json:"popularTags,omitempty"`
}
```

### 2. 搜索功能

支持搜索类型：
- 书名搜索
- 作者搜索
- 简介/内容搜索
- 分类筛选
- 标签筛选
- 价格区间筛选
- 状态筛选

### 3. 推荐算法

```go
type RecommendationEngine interface {
    // 基于内容的推荐
    GetContentBasedRecommendations(userID, limit) ([]*Book, error)

    // 协同过滤推荐
    GetCollaborativeRecommendations(userID, limit) ([]*Book, error)

    // 热门推荐
    GetTrendingBooks(limit) ([]*Book, error)

    // 新书推荐
    GetNewReleases(limit) ([]*Book, error)
}
```

### 4. 排行榜系统

```go
type RankingCalculator interface {
    // 实时榜（浏览量、阅读量）
    CalculateRealtimeRanking(period string) ([]*RankingItem, error)

    // 周榜（综合评分）
    CalculateWeeklyRanking(period string) ([]*RankingItem, error)

    // 月榜（综合评分）
    CalculateMonthlyRanking(period string) ([]*RankingItem, error)

    // 新人榜（新作者作品）
    CalculateNewbieRanking(period string) ([]*RankingItem, error)
}
```

## API端点列表

| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| GET | /api/v1/bookstore/homepage | 获取书城首页 | 否 |
| GET | /api/v1/bookstore/books/search | 搜索书籍 | 否 |
| GET | /api/v1/bookstore/books/recommended | 获取推荐书籍 | 否 |
| GET | /api/v1/bookstore/books/featured | 获取精选书籍 | 否 |
| GET | /api/v1/bookstore/books/:id | 获取书籍详情 | 否 |
| GET | /api/v1/bookstore/books/:id/detail | 获取书籍详细信息 | 否 |
| GET | /api/v1/bookstore/books/:id/similar | 获取相似书籍 | 否 |
| GET | /api/v1/bookstore/books/:id/statistics | 获取书籍统计 | 否 |
| POST | /api/v1/bookstore/books/:id/view | 增加浏览量 | 否 |
| GET | /api/v1/bookstore/categories/tree | 获取分类树 | 否 |
| GET | /api/v1/bookstore/categories/:id | 获取分类详情 | 否 |
| GET | /api/v1/bookstore/categories/:id/books | 获取分类书籍 | 否 |
| GET | /api/v1/bookstore/banners | 获取横幅列表 | 否 |
| POST | /api/v1/bookstore/banners/:id/click | 增加横幅点击 | 否 |
| GET | /api/v1/bookstore/rankings/realtime | 实时榜 | 否 |
| GET | /api/v1/bookstore/rankings/weekly | 周榜 | 否 |
| GET | /api/v1/bookstore/rankings/monthly | 月榜 | 否 |
| GET | /api/v1/bookstore/rankings/newbie | 新人榜 | 否 |
| GET | /api/v1/bookstore/rankings/:type | 按类型获取榜单 | 否 |
| GET | /api/v1/bookstore/books/:id/rating | 获取书籍评分 | 否 |
| POST | /api/v1/bookstore/books/:id/rating | 创建评分 | 是 |
| PUT | /api/v1/bookstore/books/:id/rating | 更新评分 | 是 |
| DELETE | /api/v1/bookstore/books/:id/rating | 删除评分 | 是 |

## 付费系统

### 付费模式
```go
type PurchaseModel string

const (
    ModelFree        PurchaseModel = "free"       // 免费
    ModelChapter     PurchaseModel = "chapter"    // 按章付费
    ModelBook        PurchaseModel = "book"       // 全书购买
    ModelVip         PurchaseModel = "vip"        // VIP会员
    ModelSubscription PurchaseModel = "subscription" // 订阅制
)
```

### 章节购买流程
```
1. 用户选择要购买的章节
   ↓
2. 后端验证章节状态和价格
   ↓
3. 检查用户余额
   ↓
4. 扣除费用
   ↓
5. 解锁章节内容
   ↓
6. 记录购买记录
```

## 性能优化

1. **搜索优化**
   - MongoDB Atlas Search 全文索引
   - 搜索结果缓存

2. **推荐缓存**
   - Redis 缓存热门推荐
   - 定期更新推荐列表

3. **排行榜计算**
   - 定时任务异步计算
   - 缓存计算结果

## 安全考虑

1. **内容安全**
   - 内容审核机制
   - 违规内容处理

2. **评分防刷**
   - 用户评分限制
   - 异常评分检测

3. **访问控制**
   - 付费内容权限验证
   - 防爬虫机制
