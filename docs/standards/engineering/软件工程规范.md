# 软件工程规范

**版本**: v2.0
**更新**: 2026-01-08
**状态**: ✅ 正式实施

---

## 一、编码规范

### 1.1 Go语言规范

**命名规范**：
- 包名：小写单词，不使用下划线
- 常量：大写+下划线 `MAX_RETRY_COUNT`
- 接口：以动词或er结尾 `Reader`, `Writer`
- 结构体：驼峰命名 `BookService`
- 方法：驼峰命名 `GetBookByID`

**示例**：
```go
// ✅ 好的命名
type BookService interface {}
func (s *BookService) GetBookByID(id string) (*Book, error) {}

// ❌ 不好的命名
type book_service interface {}
func (s *book_service) get_book(id string) (*Book, error) {}
```

**代码组织**：
```go
// 1. 导入包（标准库、第三方、项目内部）
import (
    "context"
    "fmt"

    "github.com/gin-gonic/gin"

    "Qingyu_backend/models"
    "Qingyu_backend/service"
)

// 2. 常量
const (
    DefaultPageSize = 20
    MaxPageSize = 100
)

// 3. 全局变量
var (
    ErrNotFound = errors.New("not found")
)

// 4. 接口定义
type ServiceInterface interface {}

// 5. 结构体定义
type ServiceStruct struct {}

// 6. 方法实现
func (s *ServiceStruct) Method() {}
```

### 1.2 错误处理

**错误定义**：
```go
// 定义错误类型
type ValidationError struct {
    Field   string
    Message string
}

func (e *ValidationError) Error() string {
    return fmt.Sprintf("%s: %s", e.Field, e.Message)
}
```

**错误处理**：
```go
// ✅ 好的错误处理
result, err := service.DoSomething()
if err != nil {
    return fmt.Errorf("操作失败: %w", err)
}

// ❌ 忽略错误
result, _ := service.DoSomething()
```

### 1.3 注释规范

**包注释**：
```go
// Package bookstore 提供书籍管理相关服务
//
// 核心功能：
// - 书籍CRUD操作
// - 书籍搜索
// - 书籍推荐
package bookstore
```

**函数注释**：
```go
// GetBookByID 根据ID获取书籍信息
//
// 参数：
//   ctx - 上下文
//   bookID - 书籍ID
//
// 返回：
//   *Book - 书籍信息
//   error - 错误信息
func (s *BookService) GetBookByID(ctx context.Context, bookID string) (*Book, error) {
    // ...
}
```

---

## 二、版本控制

### 2.1 Git规范

**分支策略**：
- `master` - 主分支，生产环境
- `develop` - 开发分支
- `feature/*` - 功能分支
- `bugfix/*` - Bug修复分支
- `hotfix/*` - 紧急修复分支

**Commit消息**：
```
<type>(<scope>): <subject>

<body>

<footer>
```

**类型（type）**：
- `feat` - 新功能
- `fix` - Bug修复
- `docs` - 文档更新
- `style` - 代码格式（不影响功能）
- `refactor` - 重构
- `test` - 测试相关
- `chore` - 构建/工具相关

**示例**：
```
feat(bookstore): 添加书籍推荐功能

- 实现基于用户行为的推荐算法
- 添加推荐结果缓存
- 提供推荐API接口

Closes #123
```

### 2.2 Code Review

**Review检查点**：
- [ ] 代码符合规范
- [ ] 功能正确实现
- [ ] 有充分的测试
- [ ] 错误处理完善
- [ ] 性能考虑合理
- [ ] 安全问题检查
- [ ] 文档同步更新

---

## 三、文档规范

### 3.1 代码文档

**必须文档化**：
- 公共API
- 复杂算法
- 业务逻辑
- 配置选项

**无需文档化**：
- 简单的getter/setter
- 显而易见的代码

### 3.2 设计文档

**文档结构**：
```markdown
# [功能名称]设计文档

## 1. 背景
## 2. 目标
## 3. 方案设计
## 4. 接口定义
## 5. 数据模型
## 6. 实施计划
## 7. 风险评估
```

**文档位置**：
- 设计文档：`doc/design/`
- API文档：`doc/api/`
- 架构文档：`doc/architecture/`

---

## 四、项目管理

### 4.1 需求管理

**需求优先级**：
- P0 ⭐⭐⭐⭐⭐ - 核心功能，必须实现
- P1 ⭐⭐⭐⭐ - 重要功能，尽快实现
- P2 ⭐⭐⭐ - 一般功能，排期实现
- P3 ⭐⭐ - 可选功能，空闲实现

**需求ID规则**：
```
REQ-{模块}-{功能}-{序号}

例如：
REQ-AI-AGENT-001  - AI模块Agent功能
REQ-BOOK-SEARCH-001 - 书籍搜索功能
```

### 4.2 任务管理

**任务状态**：
- `TODO` - 待办
- `IN_PROGRESS` - 进行中
- `REVIEW` - 审查中
- `DONE` - 已完成
- `BLOCKED` - 阻塞

**任务标签**：
- `bug` - Bug修复
- `feature` - 新功能
- `improvement` - 改进
- `documentation` - 文档

---

## 五、质量保证

### 5.1 代码质量工具

**静态分析**：
```bash
# go vet
go vet ./...

# golangci-lint
golangci-lint run

# gofmt
gofmt -l .

# goimports
goimports -l .
```

**代码检查清单**：
- [ ] 无编译警告
- [ ] 通过静态分析
- [ ] 通过所有测试
- [ ] 代码格式正确
- [ ] 无安全漏洞

### 5.2 性能监控

**关键指标**：
- API响应时间
- 数据库查询时间
- 内存使用
- CPU使用
- 并发数

**监控工具**：
- 日志分析
- APM工具
- 自定义指标
- 告警系统

---

## 六、安全规范

### 6.1 输入验证

**所有输入必须验证**：
- 类型检查
- 长度限制
- 格式验证
- 范围检查
- 特殊字符过滤

```go
// ✅ 好的验证
func ValidateEmail(email string) error {
    if !emailRegex.MatchString(email) {
        return errors.New("邮箱格式不正确")
    }
    if len(email) > 100 {
        return errors.New("邮箱过长")
    }
    return nil
}
```

### 6.2 敏感数据

**不记录敏感信息**：
- 密码
- Token
- 个人隐私
- 信用卡信息

**加密存储**：
```go
// ✅ 使用bcrypt
hashedPassword, err := bcrypt.GenerateFromPassword([]byte(password), bcrypt.DefaultCost)
```

### 6.3 SQL注入防护

**使用参数化查询**：
```go
// ✅ 正确
filter := bson.M{"email": email}
cursor, err := collection.Find(ctx, filter)

// ❌ 错误
query := fmt.Sprintf("{\"email\": \"%s\"}", email)
```

---

## 七、部署规范

### 7.1 环境配置

**环境区分**：
- `development` - 开发环境
- `staging` - 预发布环境
- `production` - 生产环境

**配置管理**：
- 使用环境变量
- 配置文件不提交
- 敏感配置加密

### 7.2 发布流程

**发布检查**：
- [ ] 所有测试通过
- [ ] 代码审查通过
- [ ] 文档更新完成
- [ ] 性能测试通过
- [ ] 安全检查通过
- [ ] 回滚方案准备

**灰度发布**：
1. 小流量测试（5%）
2. 中等流量（30%）
3. 大流量（70%）
4. 全量发布（100%）

---

## 八、团队协作

### 8.1 沟通规范

**日常沟通**：
- 站会：每日同步进度
- 周会：总结和计划
- 复盘：问题和改进

**异步沟通**：
- PR Review
- 文档评论
- Issue讨论

### 8.2 知识分享

**分享形式**：
- 技术分享会
- 文档编写
- 代码Walkthrough
- 最佳实践总结

---

## 九、持续改进

### 9.1 复盘机制

**复盘周期**：
- 事故复盘
- 月度复盘
- 季度复盘

**复盘内容**：
- 做得好的地方
- 需要改进的地方
- 改进措施
- 跟踪落实

### 9.2 技术债务

**债务管理**：
- 记录技术债务
- 评估影响和优先级
- 制定偿还计划
- 定期Review

---

**相关文档**：
- [架构设计规范](../architecture/架构设计规范.md)
- [API设计规范](../api/API设计规范.md)
- [测试规范](../testing/测试架构设计规范.md)
