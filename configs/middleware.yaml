# 中间件配置文件
# Qingyu Backend Middleware Configuration

middleware:
  # ========== 静态配置中间件 ==========
  # 这些中间件在启动时加载，修改后需要重启服务

  # 请求ID配置
  request_id:
    header_name: "X-Request-ID"
    force_gen: false

  # 异常恢复配置
  recovery:
    stack_size: 4096
    disable_print: true

  # 安全头配置
  security:
    enable_x_frame_options: true
    x_frame_options: "DENY"
    enable_hsts: true
    enable_csp: false

  # 日志配置
  logger:
    skip_paths:
      - "/health"
      - "/metrics"

  # 压缩配置
  compression:
    enabled: true
    level: 5
    types:
      - "application/json"
      - "text/html"
      - "text/plain"
      - "text/css"
      - "application/javascript"

  # CORS配置
  cors:
    allowed_origins:
      - "*"  # 生产环境应该配置具体域名
    allowed_methods:
      - "GET"
      - "POST"
      - "PUT"
      - "PATCH"
      - "DELETE"
      - "OPTIONS"
    allowed_headers:
      - "Origin"
      - "Content-Type"
      - "Content-Length"
      - "Accept-Encoding"
      - "Authorization"
      - "X-Request-ID"
    exposed_headers:
      - "Content-Length"
      - "X-Request-ID"
      - "X-Response-Time"
    allow_credentials: true  # 注意: 当设置为true时，allowed_origins不能使用"*"
    max_age: 86400  # 24小时（秒）

  # ========== 动态配置中间件 ==========
  # 这些中间件支持热更新（未来实现）

  # 限流配置（支持热更新）
  rate_limit:
    enabled: ${RATE_LIMIT_ENABLED:false}
    strategy: "token_bucket"  # token_bucket | sliding_window | redis
    rate: 100
    burst: 200
    window_size: 60  # 秒
    key_func: "ip"  # ip | user | path | ip_path | user_path
    skip_paths:
      - "/health"
      - "/metrics"
    skip_successful: false
    skip_failed_request: false
    message: "请求过于频繁，请稍后再试"
    status_code: 429
    cleanup_interval: 300  # 秒
    redis:
      addr: ${REDIS_ADDR:localhost:6379}
      password: ${REDIS_PASSWORD:""}
      db: 0
      prefix: "ratelimit:"
      pool_size: 10
      min_idle_conns: 2
      max_retries: 3
      dial_timeout: 5s
      read_timeout: 3s
      write_timeout: 3s

  # 认证配置
  auth:
    enabled: true
    secret: ${JWT_SECRET}  # 从环境变量读取
    skip_paths:
      - "/health"
      - "/metrics"
      - "/api/v1/auth/login"
      - "/api/v1/auth/register"

  # 权限配置
  permission:
    enabled: true
    strategy: "rbac"  # rbac | casbin
    config_path: "configs/permissions.yaml"
    skip_paths:
      - "/health"
      - "/metrics"
    session_timeout: 30m  # 30分钟

# ========== 优先级覆盖（可选） ==========
# 仅覆盖需要调整的中间件，未列出的使用默认Priority()值
priority_overrides:
  # CORS中间件优先级固定为4（最外层基础设施）
  cors: 4

  # 示例：调整限流中间件优先级
  # rate_limit: 7  # 在认证之后执行（原8）

  # 示例：调整监控中间件优先级
  # metrics: 6     # 在日志之前执行（原7）

# ========== 路由组配置（可选） ==========
# 为不同路由组配置特定的中间件和优先级
middleware_groups:
  # 示例：API路由组配置
  # api_group:
  #   # 使用的中间件列表（按名称）
  #   middlewares:
  #     - request_id
  #     - recovery
  #     - cors
  #     - auth
  #     - permission
  #     - logger
  #   # 路由组特定的优先级覆盖
  #   priority_overrides:
  #     auth: 8       # API组认证优先级为8
  #     permission: 9 # API组权限检查优先级为9

  # 示例：WebSocket路由组配置
  # websocket_group:
  #   middlewares:
  #     - request_id
  #     - recovery
  #     - auth
  #   priority_overrides:
  #     logger: 100   # WebSocket组不使用日志
