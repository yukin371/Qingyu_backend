# Qingyu后端告警规则
# 定义关键指标的告警阈值

groups:
  # API性能告警
  - name: api_performance_alerts
    interval: 30s
    rules:
      # 高错误率告警
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
          category: performance
        annotations:
          summary: "检测到高错误率"
          description: "{{ $labels.method }} {{ $labels.path }} 错误率为 {{ $value | humanize }} 请求/秒"

      # 响应时间过长告警
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, http_request_duration_seconds) > 0.5
        for: 10m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "P95响应时间过高"
          description: "{{ $labels.method }} {{ $labels.path }} P95响应时间为 {{ $value | humanizeDuration }}"

      # 极高响应时间告警
      - alert: VeryHighResponseTime
        expr: histogram_quantile(0.95, http_request_duration_seconds) > 2.0
        for: 5m
        labels:
          severity: critical
          category: performance
        annotations:
          summary: "P95响应时间严重过高"
          description: "{{ $labels.method }} {{ $labels.path }} P95响应时间为 {{ $value | humanizeDuration }}"

  # 数据库告警
  - name: database_alerts
    interval: 30s
    rules:
      # 数据库连接池告警
      - alert: DatabaseConnectionPoolHigh
        expr: db_pool_connections / db_pool_connections > 0.8
        for: 10m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "数据库连接池使用率过高"
          description: "{{ $labels.database }} 连接池使用率为 {{ $value | humanizePercentage }}"

      # 数据库查询慢
      - alert: SlowDatabaseQuery
        expr: histogram_quantile(0.95, db_query_duration_seconds) > 1.0
        for: 15m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "数据库查询响应慢"
          description: "{{ $labels.database }} {{ $labels.operation }} P95查询时间为 {{ $value | humanizeDuration }}"

      # 数据库错误率告警
      - alert: DatabaseHighErrorRate
        expr: rate(db_query_errors_total[5m]) > 10
        for: 5m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "数据库错误率过高"
          description: "{{ $labels.database }} {{ $labels.operation }} 错误率为 {{ $value | humanize }} 错误/秒"

  # 缓存告警
  - name: cache_alerts
    interval: 30s
    rules:
      # 缓存命中率低
      - alert: LowCacheHitRate
        expr: |
          rate(cache_hits_total[5m]) /
          (rate(cache_hits_total[5m]) + rate(cache_misses_total[5m])) < 0.6
        for: 15m
        labels:
          severity: warning
          category: cache
        annotations:
          summary: "缓存命中率过低"
          description: "{{ $labels.cache }} 缓存命中率为 {{ $value | humanizePercentage }}"

      # Redis连接数告警
      - alert: RedisConnectionHigh
        expr: redis_connections > 100
        for: 10m
        labels:
          severity: warning
          category: cache
        annotations:
          summary: "Redis连接数过高"
          description: "Redis连接数为 {{ $value }}"

  # 服务可用性告警
  - name: service_availability_alerts
    interval: 30s
    rules:
      # 服务健康检查失败
      - alert: ServiceUnhealthy
        expr: service_health_status < 1
        for: 2m
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "服务不健康"
          description: "{{ $labels.service }} ({{ $labels.version }}) 健康检查失败"

      # 活跃用户数异常
      - alert: LowActiveUsers
        expr: user_active_total < 10
        for: 30m
        labels:
          severity: warning
          category: business
        annotations:
          summary: "活跃用户数过低"
          description: "当前活跃用户数为 {{ $value }}"

  # 业务指标告警
  - name: business_alerts
    interval: 1m
    rules:
      # AI配额使用率告警
      - alert: HighAIQuotaUsage
        expr: |
          (ai_quota_usage - ai_quota_total) / ai_quota_total > 0.9
        for: 5m
        labels:
          severity: warning
          category: business
        annotations:
          summary: "AI配额使用率过高"
          description: "用户 {{ $labels.user_id }} 的 {{ $labels.quota_type }} 配额使用率为 {{ $value | humanizePercentage }}"

  # 系统资源告警
  - name: system_alerts
    interval: 30s
    rules:
      # Goroutine数量告警
      - alert: HighGoroutineCount
        expr: goroutine_count > 1000
        for: 15m
        labels:
          severity: warning
          category: system
        annotations:
          summary: "Goroutine数量过高"
          description: "当前Goroutine数量为 {{ $value }}"

      # HTTP活跃请求告警
      - alert: HighActiveRequests
        expr: http_active_requests > 100
        for: 10m
        labels:
          severity: warning
          category: system
        annotations:
          summary: "活跃HTTP请求数过高"
          description: "当前活跃请求数为 {{ $value }}"

      # 内存使用告警
      - alert: HighMemoryUsage
        expr: |
          (system_memory_usage_bytes{type="used"} /
          system_memory_usage_bytes{type="total"}) > 0.9
        for: 10m
        labels:
          severity: critical
          category: system
        annotations:
          summary: "内存使用率过高"
          description: "内存使用率为 {{ $value | humanizePercentage }}"

  # 安全告警
  - name: security_alerts
    interval: 30s
    rules:
      # 异常请求速率（可能的攻击）
      - alert: SuspiciousRequestRate
        expr: |
          sum by (path) (rate(http_requests_total[1m])) > 100
        for: 2m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "检测到异常请求速率"
          description: "{{ $labels.path }} 的请求速率为 {{ $value | humanize }} 请求/秒"

      # 异常用户注册
      - alert: SuspiciousRegistrationRate
        expr: rate(user_registrations_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "检测到异常注册速率"
          description: "用户注册速率为 {{ $value | humanize }} 注册/秒"
