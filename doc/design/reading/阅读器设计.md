# 阅读器设计

## 1. 需求概述

### 1.1 功能描述
阅读器是青羽阅读平台的核心功能模块，为用户提供流畅、舒适的阅读体验。系统支持章节正文展示、个性化阅读设置、阅读进度管理、划线注记等功能，确保用户能够专注于内容阅读。

### 1.2 业务价值
- **用户留存**：优质的阅读体验提升用户粘性和平台留存率
- **付费转化**：流畅的阅读体验促进VIP内容的付费转化
- **数据收集**：阅读行为数据为推荐算法提供重要输入
- **差异化竞争**：独特的阅读功能形成平台竞争优势

### 1.3 用户场景
- **沉浸式阅读**：用户专注阅读书籍内容，享受不被打扰的阅读时光
- **个性化设置**：用户根据阅读习惯调整字体、背景、翻页等设置
- **进度管理**：用户查看阅读进度，快速跳转到指定章节
- **内容标记**：用户对重要内容进行划线、注记、收藏

### 1.4 功能边界
- **包含功能**：章节内容展示、阅读设置、进度管理、划线注记、书签收藏
- **不包含功能**：内容编辑（由写作端提供）、社交互动（由社交模块提供）

## 2. 架构设计

### 2.1 整体架构
`

   Router层        路由分发、权限验证

   API层           阅读接口、设置管理

   Service层       阅读逻辑、进度计算

   Repository层    内容获取、设置存储

   Model层         章节模型、设置模型

`

### 2.2 模块划分
- **内容模块**：章节内容获取、格式化、缓存管理
- **设置模块**：阅读偏好设置、主题管理、字体配置
- **进度模块**：阅读进度记录、同步、统计分析
- **标记模块**：划线注记、书签管理、笔记功能

## 3. 详细设计

### 3.1 Router层设计
- **路由分组**：/api/v1/reader
- **中间件**：JWT认证中间件、日志中间件、权限验证中间件
- **路径规范**：RESTful风格，支持章节ID和书籍ID参数
- **参数处理**：路径参数（书籍ID、章节ID）、查询参数（设置选项）

### 3.2 API层设计
- **接口定义**：章节内容获取、阅读设置管理、进度同步
- **请求验证**：用户权限验证、VIP内容验证、参数格式验证
- **响应格式**：统一JSON格式，支持分页和流式加载
- **错误处理**：权限不足、内容不存在、网络异常等错误处理

### 3.3 Service层设计
- **业务流程**：内容权限验证、格式化处理、进度计算
- **数据处理**：章节内容解析、阅读时长统计、设置同步
- **依赖服务**：用户服务、支付服务、统计服务
- **异常处理**：内容加载失败、权限验证失败、设置同步异常
- **Repository交互**：通过Repository接口获取章节内容和用户设置

### 3.4 Repository层设计
- **接口抽象**：定义ChapterRepository和SettingsRepository接口
- **查询封装**：章节内容查询、用户设置查询、进度记录查询
- **事务管理**：阅读进度更新事务、设置修改事务
- **缓存策略**：热门章节内容缓存、用户设置缓存
- **异常处理**：数据库连接异常、查询超时处理
- **与Model关系**：章节模型和设置模型的数据映射

### 3.5 Model层设计
- **数据模型**：Chapter、ReadingSettings、ReadingProgress等实体
- **约束规则**：章节内容完整性、设置参数范围、进度有效性
- **验证逻辑**：内容格式验证、权限验证、数据一致性检查
- **Repository接口**：定义数据访问和操作的接口方法

## 4. 数据设计

### 4.1 数据模型

#### 4.1.1 章节模型 (Chapter)

```go
type Chapter struct {

    ID          string    `bson:"_id,omitempty" json:"id"`

    BookID      string    `bson:"book_id" json:"bookId"`           // 书籍ID

    Title       string    `bson:"title" json:"title"`              // 章节标题

    Content     string    `bson:"content" json:"content"`          // 章节内容

    WordCount   int       `bson:"word_count" json:"wordCount"`     // 字数

    ChapterNum  int       `bson:"chapter_num" json:"chapterNum"`   // 章节序号

    IsVIP       bool      `bson:"is_vip" json:"isVip"`             // 是否VIP章节

    Price       int64     `bson:"price" json:"price"`              // 价格（分）

    Status      int       `bson:"status" json:"status"`            // 状态：1-正常，2-删除

    PublishTime time.Time `bson:"publish_time" json:"publishTime"` // 发布时间

    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`     // 创建时间

    UpdatedAt   time.Time `bson:"updated_at" json:"updatedAt"`     // 更新时间

}```

#### 4.1.2 阅读设置模型 (ReadingSettings)

```go
type ReadingSettings struct {

    ID          string    `bson:"_id,omitempty" json:"id"`

    UserID      string    `bson:"user_id" json:"userId"`           // 用户ID

    FontFamily  string    `bson:"font_family" json:"fontFamily"`   // 字体

    FontSize    int       `bson:"font_size" json:"fontSize"`       // 字号

    LineHeight  float64   `bson:"line_height" json:"lineHeight"`   // 行高

    Theme       string    `bson:"theme" json:"theme"`              // 主题

    Background  string    `bson:"background" json:"background"`    // 背景色

    PageMode    int       `bson:"page_mode" json:"pageMode"`       // 翻页模式：1-滑动，2-仿真

    AutoScroll  bool      `bson:"auto_scroll" json:"autoScroll"`   // 自动滚动

    ScrollSpeed int       `bson:"scroll_speed" json:"scrollSpeed"` // 滚动速度

    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`

    UpdatedAt   time.Time `bson:"updated_at" json:"updatedAt"`

}
```

#### 4.1.3 阅读进度模型 (ReadingProgress)

```go
type ReadingProgress struct {

    ID          string    `bson:"_id,omitempty" json:"id"`

    UserID      string    `bson:"user_id" json:"userId"`           // 用户ID

    BookID      string    `bson:"book_id" json:"bookId"`           // 书籍ID

    ChapterID   string    `bson:"chapter_id" json:"chapterId"`     // 章节ID

    Progress    float64   `bson:"progress" json:"progress"`        // 进度：0-1之间的小数

    ReadingTime int64     `bson:"reading_time" json:"readingTime"` // 阅读时间（秒）

    LastReadAt  time.Time `bson:"last_read_at" json:"lastReadAt"`  // 最后阅读时间

    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`

    UpdatedAt   time.Time `bson:"updated_at" json:"updatedAt"`

}
```

#### 4.1.4 划线注记模型 (Annotation)

```go
type Annotation struct {
    ID          string    json:"_id,omitempty" json:"id"
    UserID      string    json:"user_id" json:"userId"            // 用户ID
    BookID      string    json:"book_id" json:"bookId"            // 书籍ID
    ChapterID   string    json:"chapter_id" json:"chapterId"      // 章节ID
    StartPos    int       json:"start_pos" json:"startPos"        // 开始位置
    EndPos      int       json:"end_pos" json:"endPos"            // 结束位置
    Content     string    json:"content" json:"content"           // 标记内容
    Note        string    json:"note" json:"note"                 // 用户笔记
    Color       string    json:"color" json:"color"               // 标记颜色
    Type        int       json:"type" json:"type"                 // 类型：1-划线，2-书签
    CreatedAt   time.Time json:"created_at" json:"createdAt"
    UpdatedAt   time.Time json:"updated_at" json:"updatedAt"
}
```

### 4.2 数据关系

- **章节-书籍**：多对一关系，一本书包含多个章节
- **进度-用户**：多对一关系，一个用户有多个阅读进度记录
- **设置-用户**：一对一关系，每个用户有一套阅读设置
- **注记-章节**：多对一关系，一个章节可以有多个注记

### 4.3 索引策略

| 集合名称 | 索引字段 | 索引类型 | 说明 |
|---------|---------|---------|------|
| chapters | book_id, chapter_num | compound | 书籍章节查询索引 |
| chapters | book_id, status | compound | 有效章节查询索引 |
| reading_settings | user_id | unique | 用户设置唯一索引 |
| reading_progress | user_id, book_id | compound | 用户阅读进度索引 |
| annotations | user_id, book_id | compound | 用户注记查询索引 |
| annotations | chapter_id | normal | 章节注记查询索引 |

### 4.4 数据迁移

- **版本1.0**：基础章节、设置、进度数据结构
- **版本1.1**：增加划线注记功能
- **版本1.2**：增加阅读统计和分析功能

## 5. 接口设计

### 5.1 API概览

| 方法   | 路径                                    | 功能描述   | 权限要求 |
| ---- | ------------------------------------- | ------ | ---- |
| GET  | /api/v1/reader/chapters/:id           | 获取章节内容 | 登录用户 |
| GET  | /api/v1/reader/books/:bookId/chapters | 获取章节列表 | 登录用户 |
| GET  | /api/v1/reader/settings               | 获取阅读设置 | 登录用户 |
| PUT  | /api/v1/reader/settings               | 更新阅读设置 | 登录用户 |
| GET  | /api/v1/reader/progress/:bookId       | 获取阅读进度 | 登录用户 |
| PUT  | /api/v1/reader/progress               | 更新阅读进度 | 登录用户 |
| GET  | /api/v1/reader/annotations            | 获取用户注记 | 登录用户 |
| POST | /api/v1/reader/annotations            | 创建注记   | 登录用户 |

### 5.2 请求与响应格式

#### 5.2.1 获取章节内容 (GET /api/v1/reader/chapters/:id)

**请求参数**:

- id (path): 章节ID

**响应格式**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "chapter_id",
    "bookId": "book_id",
    "title": "章节标题",
    "content": "章节内容...",
    "wordCount": 2000,
    "chapterNum": 1,
    "isVip": false,
    "price": 0,
    "publishTime": "2024-01-01T00:00:00Z",
    "prevChapter": {
      "id": "prev_chapter_id",
      "title": "上一章标题"
    },
    "nextChapter": {
      "id": "next_chapter_id",
      "title": "下一章标题"
    }
  }
}
```

#### 5.2.2 获取阅读设置 (GET /api/v1/reader/settings)

**请求参数**: 无

**响应格式**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "fontFamily": "Microsoft YaHei",
    "fontSize": 16,
    "lineHeight": 1.5,
    "theme": "light",
    "background": "#ffffff",
    "pageMode": 1,
    "autoScroll": false,
    "scrollSpeed": 3
  }
}
```

#### 5.2.3 更新阅读进度 (PUT /api/v1/reader/progress)

**请求参数**:

```json
{
  "bookId": "book_id",
  "chapterId": "chapter_id",
  "chapterNum": 1,
  "progress": 0.5,
  "readingTime": 300
}
```

**响应格式**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "updated": true
  }
}
```

**状态码**:

- 200: 成功
- 400: 请求参数错误
- 401: 未登录
- 403: 权限不足（VIP内容）
- 404: 章节不存在
- 500: 服务器错误

## 6. 安全设计

### 6.1 权限控制

- **登录验证**：所有阅读功能需要用户登录
- **VIP验证**：VIP章节需要验证用户VIP权限或单章购买记录
- **内容保护**：防止未授权用户获取付费内容

### 6.2 数据安全

- **内容加密**：VIP章节内容进行加密存储和传输
- **防盗版**：添加水印、限制复制等防盗版措施
- **隐私保护**：用户阅读记录和注记数据隐私保护

### 6.3 输入验证

- **参数校验**：章节ID、进度值、设置参数的有效性验证
- **内容过滤**：用户注记内容的敏感词过滤
- **防刷保护**：防止恶意刷阅读进度和时长

### 6.4 审计日志

- **阅读行为**：记录用户阅读行为用于推荐和分析
- **付费记录**：记录VIP内容访问和付费行为
- **异常监控**：监控异常访问和可疑行为

## 7. 测试设计

### 7.1 测试策略

- **单元测试**：Service层业务逻辑、Repository层数据访问
- **集成测试**：API接口功能、权限验证、数据一致性
- **性能测试**：大文件加载、高并发阅读、缓存效果
- **兼容性测试**：不同设备、浏览器的阅读体验

### 7.2 测试用例

- **正常流程**：章节加载、设置修改、进度同步、注记创建
- **权限验证**：VIP内容访问、未登录访问、权限不足
- **边界条件**：超长章节、无效参数、网络异常
- **性能测试**：1000并发阅读、大章节加载、缓存命中率

### 7.3 性能测试

- **加载速度**：章节内容加载<2s，设置更新<500ms
- **并发能力**：支持5000并发用户同时阅读
- **缓存效果**：热门章节缓存命中率>90%

## 8. 部署和运维

### 8.1 部署方案

- **CDN加速**：章节内容通过CDN分发，提升加载速度
- **读写分离**：阅读请求走读库，进度更新走写库
- **缓存策略**：Redis缓存热门章节和用户设置
- **负载均衡**：多实例部署，支持水平扩展

### 8.2 监控指标

- **业务指标**：章节阅读量、平均阅读时长、用户留存率
- **技术指标**：API响应时间、缓存命中率、错误率
- **用户体验**：页面加载时间、操作响应时间

### 8.3 日志策略

- **阅读日志**：记录用户阅读行为和偏好
- **性能日志**：记录慢查询和性能瓶颈
- **错误日志**：记录系统异常和用户反馈

### 8.4 故障处理

- **内容降级**：缓存失效时提供基础阅读功能
- **权限降级**：权限服务异常时允许免费内容访问
- **数据恢复**：阅读进度数据的备份和恢复机制

## 9. 风险评估

### 9.1 技术风险

- **性能瓶颈**：大量并发阅读可能导致服务器压力
- **缓存失效**：缓存雪崩可能影响阅读体验
- **数据丢失**：阅读进度数据丢失影响用户体验

### 9.2 业务风险

- **盗版风险**：内容被非法复制和传播
- **用户流失**：阅读体验差导致用户流失
- **付费转化**：VIP内容体验不佳影响付费转化

### 9.3 性能风险

- **加载缓慢**：大章节内容加载影响阅读体验
- **同步延迟**：阅读进度同步延迟影响多端体验
- **设备兼容**：不同设备的阅读体验差异

## 10. 实施计划

### 10.1 开发阶段

- **第1周**：章节模型设计、基础阅读功能
- **第2周**：阅读设置、进度管理功能
- **第3周**：划线注记、权限验证功能
- **第4周**：性能优化、测试部署

### 10.2 测试阶段

- **功能测试**：核心阅读功能验证
- **性能测试**：并发和加载性能测试
- **兼容性测试**：多设备兼容性验证
- **用户测试**：真实用户体验测试

### 10.3 上线计划

- **灰度发布**：部分用户先行体验
- **数据监控**：密切监控阅读数据和性能
- **用户反馈**：收集用户反馈持续优化
- **全量发布**：稳定后全量发布
