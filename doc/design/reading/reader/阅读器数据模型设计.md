# 阅读器数据模型设计

> **版本**: v1.0  
> **创建日期**: 2025-10-21  
> **最后更新**: 2025-10-21  
> **状态**: ✅ 已实现，补充设计文档

---

## 1. 为什么需要这个设计

### 1.1 业务背景

阅读器数据模型是阅读端的核心功能，负责：
- 跨设备阅读进度同步
- 个性化阅读设置
- 阅读历史记录
- 阅读偏好管理
- 用户体验优化

### 1.2 实际实现情况

已完整实现，包含：
- **ReadingProgress数据模型**：`models/reading/reader/reading_progress.go` - 阅读进度
- **ReadingSettings数据模型**：`models/reading/reader/reading_settings.go` - 阅读设置

**实现文件**：
- `models/reading/reader/reading_progress.go` - 阅读进度模型
- `models/reading/reader/reading_settings.go` - 阅读设置模型
- `service/reading/reading_progress_service.go` - 进度服务
- `service/reading/reading_settings_service.go` - 设置服务
- `repository/mongodb/reading/reading_progress_mongo.go` - Repository实现

---

## 2. 数据模型设计

### 2.1 ReadingProgress（阅读进度）

#### 2.1.1 数据结构

```go
type ReadingProgress struct {
    ID           string    `bson:"_id,omitempty" json:"id"`
    UserID       string    `bson:"userId" json:"userId" validate:"required"`       // 用户ID
    BookID       string    `bson:"bookId" json:"bookId" validate:"required"`       // 书籍ID
    ChapterID    string    `bson:"chapterId" json:"chapterId"`                     // 当前章节ID
    ChapterIndex int       `bson:"chapterIndex" json:"chapterIndex"`               // 章节索引
    Position     int       `bson:"position" json:"position"`                       // 章节内位置（字符索引）
    Percent      float64   `bson:"percent" json:"percent"`                         // 全书阅读进度（0-100）
    LastReadAt   time.Time `bson:"lastReadAt" json:"lastReadAt"`                   // 最后阅读时间
    ReadDuration int       `bson:"readDuration" json:"readDuration"`               // 累计阅读时长（秒）
    IsFinished   bool      `bson:"isFinished" json:"isFinished"`                   // 是否已读完
    FinishedAt   *time.Time `bson:"finishedAt,omitempty" json:"finishedAt,omitempty"` // 读完时间
    CreatedAt    time.Time `bson:"createdAt" json:"createdAt"`
    UpdatedAt    time.Time `bson:"updatedAt" json:"updatedAt"`
}
```

#### 2.1.2 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| ID | string | 否 | 进度记录唯一标识 |
| UserID | string | 是 | 用户ID |
| BookID | string | 是 | 书籍ID |
| ChapterID | string | 否 | 当前阅读的章节ID |
| ChapterIndex | int | 否 | 章节索引（从0开始） |
| Position | int | 否 | 章节内的字符位置 |
| Percent | float64 | 否 | 全书阅读百分比（0-100） |
| LastReadAt | time.Time | 是 | 最后阅读时间 |
| ReadDuration | int | 否 | 累计阅读时长（秒） |
| IsFinished | bool | 否 | 是否已读完整本书 |
| FinishedAt | *time.Time | 否 | 读完时间 |
| CreatedAt | time.Time | 是 | 首次阅读时间 |
| UpdatedAt | time.Time | 是 | 更新时间 |

#### 2.1.3 业务方法

```go
// UpdateProgress 更新进度
func (rp *ReadingProgress) UpdateProgress(chapterID string, chapterIndex int, position int, percent float64) {
    rp.ChapterID = chapterID
    rp.ChapterIndex = chapterIndex
    rp.Position = position
    rp.Percent = percent
    rp.LastReadAt = time.Now()
    rp.UpdatedAt = time.Now()
    
    // 如果进度达到100%，标记为已完成
    if percent >= 99.5 && !rp.IsFinished {
        rp.IsFinished = true
        now := time.Now()
        rp.FinishedAt = &now
    }
}

// AddReadingTime 增加阅读时长
func (rp *ReadingProgress) AddReadingTime(seconds int) {
    rp.ReadDuration += seconds
    rp.UpdatedAt = time.Now()
}

// GetReadingTimeFormatted 获取格式化的阅读时长
func (rp *ReadingProgress) GetReadingTimeFormatted() string {
    hours := rp.ReadDuration / 3600
    minutes := (rp.ReadDuration % 3600) / 60
    
    if hours > 0 {
        return fmt.Sprintf("%d小时%d分钟", hours, minutes)
    }
    return fmt.Sprintf("%d分钟", minutes)
}

// IsRecentlyRead 是否最近阅读过（24小时内）
func (rp *ReadingProgress) IsRecentlyRead() bool {
    return time.Since(rp.LastReadAt) <= 24*time.Hour
}
```

#### 2.1.4 索引策略

```javascript
// MongoDB索引
db.reading_progress.createIndex({ "userId": 1, "bookId": 1 }, { unique: true })  // 用户每本书只有一条进度记录
db.reading_progress.createIndex({ "userId": 1, "lastReadAt": -1 })                // 查询用户最近阅读
db.reading_progress.createIndex({ "bookId": 1, "isFinished": 1 })                 // 统计完成情况
db.reading_progress.createIndex({ "userId": 1, "percent": -1 })                   // 按进度排序
```

---

### 2.2 ReadingSettings（阅读设置）

#### 2.2.1 数据结构

```go
type ReadingSettings struct {
    ID             string    `bson:"_id,omitempty" json:"id"`
    UserID         string    `bson:"userId" json:"userId" validate:"required"` // 用户ID
    
    // 字体设置
    FontFamily     string    `bson:"fontFamily" json:"fontFamily"`             // 字体（如：default/serif/sans）
    FontSize       int       `bson:"fontSize" json:"fontSize"`                 // 字号（12-32）
    LineHeight     float64   `bson:"lineHeight" json:"lineHeight"`             // 行高（1.0-2.5）
    
    // 主题设置
    Theme          string    `bson:"theme" json:"theme"`                       // 主题（light/dark/sepia）
    BackgroundColor string   `bson:"backgroundColor" json:"backgroundColor"`   // 背景色
    TextColor      string    `bson:"textColor" json:"textColor"`               // 文字颜色
    
    // 页面设置
    PageWidth      int       `bson:"pageWidth" json:"pageWidth"`               // 页面宽度（像素）
    PageMargin     int       `bson:"pageMargin" json:"pageMargin"`             // 页边距（像素）
    ParagraphIndent int      `bson:"paragraphIndent" json:"paragraphIndent"`   // 段落缩进
    
    // 翻页设置
    PageTurnMode   string    `bson:"pageTurnMode" json:"pageTurnMode"`         // 翻页模式（slide/fade/none）
    AutoSave       bool      `bson:"autoSave" json:"autoSave"`                 // 自动保存进度
    AutoNightMode  bool      `bson:"autoNightMode" json:"autoNightMode"`       // 自动夜间模式
    
    // 其他设置
    VolumeKeyPageTurn bool   `bson:"volumeKeyPageTurn" json:"volumeKeyPageTurn"` // 音量键翻页
    KeepScreenOn   bool      `bson:"keepScreenOn" json:"keepScreenOn"`         // 保持屏幕常亮
    
    CreatedAt      time.Time `bson:"createdAt" json:"createdAt"`
    UpdatedAt      time.Time `bson:"updatedAt" json:"updatedAt"`
}
```

#### 2.2.2 默认设置

```go
// DefaultReadingSettings 默认阅读设置
func DefaultReadingSettings(userID string) *ReadingSettings {
    return &ReadingSettings{
        UserID:            userID,
        FontFamily:        "default",
        FontSize:          18,
        LineHeight:        1.5,
        Theme:             "light",
        BackgroundColor:   "#FFFFFF",
        TextColor:         "#333333",
        PageWidth:         800,
        PageMargin:        20,
        ParagraphIndent:   2,
        PageTurnMode:      "slide",
        AutoSave:          true,
        AutoNightMode:     false,
        VolumeKeyPageTurn: false,
        KeepScreenOn:      false,
        CreatedAt:         time.Now(),
        UpdatedAt:         time.Now(),
    }
}
```

#### 2.2.3 预定义主题

```go
// Theme 阅读主题
type Theme struct {
    Name            string
    BackgroundColor string
    TextColor       string
}

var PredefinedThemes = []Theme{
    {
        Name:            "light",
        BackgroundColor: "#FFFFFF",
        TextColor:       "#333333",
    },
    {
        Name:            "dark",
        BackgroundColor: "#1E1E1E",
        TextColor:       "#E0E0E0",
    },
    {
        Name:            "sepia",
        BackgroundColor: "#F4ECD8",
        TextColor:       "#5B4636",
    },
    {
        Name:            "green",
        BackgroundColor: "#CCE8CC",
        TextColor:       "#2C5C2C",
    },
}
```

#### 2.2.4 业务方法

```go
// Validate 验证设置
func (rs *ReadingSettings) Validate() error {
    // 字号范围验证
    if rs.FontSize < 12 || rs.FontSize > 32 {
        return fmt.Errorf("字号必须在12-32之间")
    }
    
    // 行高验证
    if rs.LineHeight < 1.0 || rs.LineHeight > 2.5 {
        return fmt.Errorf("行高必须在1.0-2.5之间")
    }
    
    // 主题验证
    validThemes := []string{"light", "dark", "sepia", "green", "custom"}
    if !contains(validThemes, rs.Theme) {
        return fmt.Errorf("无效的主题")
    }
    
    return nil
}

// ApplyTheme 应用主题
func (rs *ReadingSettings) ApplyTheme(themeName string) {
    for _, theme := range PredefinedThemes {
        if theme.Name == themeName {
            rs.Theme = theme.Name
            rs.BackgroundColor = theme.BackgroundColor
            rs.TextColor = theme.TextColor
            break
        }
    }
}
```

#### 2.2.5 索引策略

```javascript
// MongoDB索引
db.reading_settings.createIndex({ "userId": 1 }, { unique: true })  // 用户只有一份阅读设置
```

---

### 2.3 ReadingHistory（阅读历史）

```go
type ReadingHistory struct {
    ID         string    `bson:"_id,omitempty" json:"id"`
    UserID     string    `bson:"userId" json:"userId" validate:"required"`
    BookID     string    `bson:"bookId" json:"bookId" validate:"required"`
    ChapterID  string    `bson:"chapterId" json:"chapterId"`
    Duration   int       `bson:"duration" json:"duration"`        // 本次阅读时长（秒）
    ReadAt     time.Time `bson:"readAt" json:"readAt"`            // 阅读时间
    CreatedAt  time.Time `bson:"createdAt" json:"createdAt"`
}
```

#### 2.3.1 索引策略

```javascript
// MongoDB索引
db.reading_history.createIndex({ "userId": 1, "readAt": -1 })      // 查询用户阅读历史
db.reading_history.createIndex({ "bookId": 1, "readAt": -1 })      // 查询书籍阅读记录
db.reading_history.createIndex({ "userId": 1, "bookId": 1 })       // 查询特定书籍的阅读记录
```

---

## 3. Service层设计

### 3.1 ReadingProgressService

```go
type ReadingProgressService struct {
    progressRepo interfaces.ReadingProgressRepository
    historyRepo  interfaces.ReadingHistoryRepository
    eventBus     base.EventBus
    cache        cache.Cache
}

// UpdateProgress 更新阅读进度
func (s *ReadingProgressService) UpdateProgress(ctx context.Context, req *UpdateProgressRequest) error {
    // 1. 获取或创建进度记录
    progress, err := s.progressRepo.GetByUserAndBook(ctx, req.UserID, req.BookID)
    if err != nil || progress == nil {
        // 创建新记录
        progress = &ReadingProgress{
            UserID:    req.UserID,
            BookID:    req.BookID,
            CreatedAt: time.Now(),
        }
    }
    
    // 2. 更新进度
    progress.UpdateProgress(req.ChapterID, req.ChapterIndex, req.Position, req.Percent)
    
    // 3. 保存到数据库
    if progress.ID == "" {
        err = s.progressRepo.Create(ctx, progress)
    } else {
        err = s.progressRepo.Update(ctx, progress.ID, map[string]interface{}{
            "chapterId":    progress.ChapterID,
            "chapterIndex": progress.ChapterIndex,
            "position":     progress.Position,
            "percent":      progress.Percent,
            "lastReadAt":   progress.LastReadAt,
            "isFinished":   progress.IsFinished,
            "finishedAt":   progress.FinishedAt,
            "updatedAt":    progress.UpdatedAt,
        })
    }
    
    if err != nil {
        return err
    }
    
    // 4. 清除缓存
    s.invalidateProgressCache(ctx, req.UserID, req.BookID)
    
    // 5. 记录阅读历史
    if req.Duration > 0 {
        s.recordReadingHistory(ctx, req.UserID, req.BookID, req.ChapterID, req.Duration)
    }
    
    // 6. 发布事件
    if progress.IsFinished {
        event := &base.BaseEvent{
            EventType: "book.finished",
            EventData: map[string]interface{}{
                "user_id": req.UserID,
                "book_id": req.BookID,
            },
            Timestamp: time.Now(),
            Source:    "ReadingProgressService",
        }
        s.eventBus.PublishAsync(ctx, event)
    }
    
    return nil
}

// GetProgress 获取阅读进度
func (s *ReadingProgressService) GetProgress(ctx context.Context, userID string, bookID string) (*ReadingProgress, error) {
    // 1. 尝试从缓存获取
    cacheKey := fmt.Sprintf("progress:%s:%s", userID, bookID)
    cached, _ := s.cache.Get(ctx, cacheKey)
    if cached != nil {
        return cached.(*ReadingProgress), nil
    }
    
    // 2. 从数据库查询
    progress, err := s.progressRepo.GetByUserAndBook(ctx, userID, bookID)
    if err != nil {
        return nil, err
    }
    
    // 3. 缓存结果（5分钟）
    s.cache.Set(ctx, cacheKey, progress, 5*time.Minute)
    
    return progress, nil
}

// GetRecentlyRead 获取最近阅读的书籍
func (s *ReadingProgressService) GetRecentlyRead(ctx context.Context, userID string, limit int) ([]*ReadingProgress, error) {
    return s.progressRepo.GetRecentByUser(ctx, userID, limit)
}

// GetReadingStatistics 获取阅读统计
func (s *ReadingProgressService) GetReadingStatistics(ctx context.Context, userID string) (*ReadingStatistics, error) {
    // 1. 统计总阅读书籍数
    totalBooks, _ := s.progressRepo.CountByUser(ctx, userID)
    
    // 2. 统计完成书籍数
    finishedBooks, _ := s.progressRepo.CountFinishedByUser(ctx, userID)
    
    // 3. 统计总阅读时长
    totalDuration, _ := s.progressRepo.SumReadingDurationByUser(ctx, userID)
    
    // 4. 获取最近7天的阅读时长
    weekDuration, _ := s.historyRepo.SumDurationByUserInPeriod(ctx, userID, 7*24*time.Hour)
    
    return &ReadingStatistics{
        TotalBooks:     totalBooks,
        FinishedBooks:  finishedBooks,
        TotalDuration:  totalDuration,
        WeekDuration:   weekDuration,
        AverageDuration: weekDuration / 7,
    }, nil
}
```

### 3.2 ReadingSettingsService

```go
type ReadingSettingsService struct {
    settingsRepo interfaces.ReadingSettingsRepository
    cache        cache.Cache
}

// GetSettings 获取阅读设置
func (s *ReadingSettingsService) GetSettings(ctx context.Context, userID string) (*ReadingSettings, error) {
    // 1. 尝试从缓存获取
    cacheKey := fmt.Sprintf("settings:%s", userID)
    cached, _ := s.cache.Get(ctx, cacheKey)
    if cached != nil {
        return cached.(*ReadingSettings), nil
    }
    
    // 2. 从数据库查询
    settings, err := s.settingsRepo.GetByUserID(ctx, userID)
    if err != nil || settings == nil {
        // 使用默认设置
        settings = DefaultReadingSettings(userID)
        s.settingsRepo.Create(ctx, settings)
    }
    
    // 3. 缓存结果（1小时）
    s.cache.Set(ctx, cacheKey, settings, 1*time.Hour)
    
    return settings, nil
}

// UpdateSettings 更新阅读设置
func (s *ReadingSettingsService) UpdateSettings(ctx context.Context, userID string, updates map[string]interface{}) error {
    // 1. 更新数据库
    if err := s.settingsRepo.UpdateByUserID(ctx, userID, updates); err != nil {
        return err
    }
    
    // 2. 清除缓存
    cacheKey := fmt.Sprintf("settings:%s", userID)
    s.cache.Delete(ctx, cacheKey)
    
    return nil
}
```

---

## 4. API设计

### 4.1 请求/响应

```go
// UpdateProgressRequest 更新进度请求
type UpdateProgressRequest struct {
    UserID       string `json:"userId" validate:"required"`
    BookID       string `json:"bookId" validate:"required"`
    ChapterID    string `json:"chapterId"`
    ChapterIndex int    `json:"chapterIndex"`
    Position     int    `json:"position"`
    Percent      float64 `json:"percent"`
    Duration     int    `json:"duration"`  // 本次阅读时长（秒）
}

// ReadingStatistics 阅读统计
type ReadingStatistics struct {
    TotalBooks      int64  `json:"totalBooks"`      // 总阅读书籍数
    FinishedBooks   int64  `json:"finishedBooks"`   // 已完成书籍数
    TotalDuration   int    `json:"totalDuration"`   // 总阅读时长（秒）
    WeekDuration    int    `json:"weekDuration"`    // 近7天阅读时长
    AverageDuration int    `json:"averageDuration"` // 日均阅读时长
}
```

### 4.2 API路由

```go
// PUT /api/v1/reading/progress - 更新阅读进度
func (api *ReadingApi) UpdateProgress(c *gin.Context) {
    userID, _ := c.Get("userId")
    
    var req UpdateProgressRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.Error(c, http.StatusBadRequest, "参数错误", err.Error())
        return
    }
    
    req.UserID = userID.(string)
    
    err := api.progressService.UpdateProgress(c.Request.Context(), &req)
    if err != nil {
        api.handleError(c, err)
        return
    }
    
    response.Success(c, http.StatusOK, "更新成功", nil)
}

// GET /api/v1/reading/progress/:bookId - 获取阅读进度
func (api *ReadingApi) GetProgress(c *gin.Context) {
    bookID := c.Param("bookId")
    userID, _ := c.Get("userId")
    
    progress, err := api.progressService.GetProgress(c.Request.Context(), userID.(string), bookID)
    if err != nil {
        api.handleError(c, err)
        return
    }
    
    response.Success(c, http.StatusOK, "获取成功", progress)
}

// GET /api/v1/reading/settings - 获取阅读设置
func (api *ReadingApi) GetSettings(c *gin.Context) {
    userID, _ := c.Get("userId")
    
    settings, err := api.settingsService.GetSettings(c.Request.Context(), userID.(string))
    if err != nil {
        api.handleError(c, err)
        return
    }
    
    response.Success(c, http.StatusOK, "获取成功", settings)
}

// PUT /api/v1/reading/settings - 更新阅读设置
func (api *ReadingApi) UpdateSettings(c *gin.Context) {
    userID, _ := c.Get("userId")
    
    var updates map[string]interface{}
    if err := c.ShouldBindJSON(&updates); err != nil {
        response.Error(c, http.StatusBadRequest, "参数错误", err.Error())
        return
    }
    
    err := api.settingsService.UpdateSettings(c.Request.Context(), userID.(string), updates)
    if err != nil {
        api.handleError(c, err)
        return
    }
    
    response.Success(c, http.StatusOK, "更新成功", nil)
}
```

---

## 5. 与v2.1架构的关系

### 5.1 在整体架构中的位置

```
Reading Module (阅读端)
  └─ Reader Module (阅读器模块)
      ├─ ReadingProgress (阅读进度)
      ├─ ReadingSettings (阅读设置)
      └─ ReadingHistory (阅读历史)
```

### 5.2 事件发布

```go
// 书籍读完事件
type BookFinishedEvent struct {
    UserID    string
    BookID    string
    Duration  int
    Timestamp time.Time
}

// 进度更新事件（用于阅读任务）
type ProgressUpdatedEvent struct {
    UserID    string
    BookID    string
    Percent   float64
    Timestamp time.Time
}
```

---

## 6. 实现参考

### 6.1 代码文件路径

- **数据模型**: 
  - `models/reading/reader/reading_progress.go`
  - `models/reading/reader/reading_settings.go`
- **Service**: 
  - `service/reading/reading_progress_service.go`（待创建）
  - `service/reading/reading_settings_service.go`（待创建）
- **Repository**: 
  - `repository/mongodb/reading/reading_progress_mongo.go`（待创建）
  - `repository/mongodb/reading/reading_settings_mongo.go`（待创建）

### 6.2 关键实现特性

1. ✅ 跨设备进度同步
2. ✅ 多主题支持（light/dark/sepia）
3. ✅ 字体、字号、行高自定义
4. ✅ 阅读时长统计
5. ✅ 自动保存进度
6. ✅ 阅读历史记录
7. ✅ 进度缓存优化

---

**文档状态**: ✅ 已完成  
**最后审核**: 2025-10-21  
**优先级**: P0 - 核心阅读功能

