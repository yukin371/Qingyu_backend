# 标注缓存设计

> **版本**: v1.0  
> **创建日期**: 2025-10-21  
> **状态**: ⚠️ 待实现

---

## 1. 设计概述

标注缓存用于优化标注加载性能，减少数据库查询。

---

## 2. 缓存策略

### 2.1 章节标注缓存

**缓存Key**：`annotations:chapter:{userId}:{chapterId}`

**TTL**: 10分钟

**缓存内容**：
```go
type CachedChapterAnnotations struct {
    ChapterID   string
    Annotations []Annotation  // 按startPos排序
    CachedAt    time.Time
}
```

### 2.2 书籍标注摘要缓存

**缓存Key**：`annotations:book:summary:{userId}:{bookId}`

**TTL**: 30分钟

**用途**：快速显示书籍的标注统计

---

## 3. 更新策略

```go
// 标注创建/更新/删除时清除缓存
func OnAnnotationChanged(userID, chapterID string) {
    cache.Delete("annotations:chapter:" + userID + ":" + chapterID)
}
```

---

## 4. 批量加载优化

```go
// 批量获取多个章节的标注（用于离线阅读）
func GetChaptersAnnotations(userID string, chapterIDs []string) map[string][]Annotation {
    result := make(map[string][]Annotation)
    
    for _, chapterID := range chapterIDs {
        cacheKey := "annotations:chapter:" + userID + ":" + chapterID
        
        // 尝试从缓存获取
        cached := cache.Get(cacheKey)
        if cached != nil {
            result[chapterID] = cached.([]Annotation)
            continue
        }
        
        // 从数据库加载
        annotations := loadFromDB(userID, chapterID)
        result[chapterID] = annotations
        
        // 缓存结果
        cache.Set(cacheKey, annotations, 10*time.Minute)
    }
    
    return result
}
```

---

**文档状态**: ✅ 已完成  
**优先级**: P0

