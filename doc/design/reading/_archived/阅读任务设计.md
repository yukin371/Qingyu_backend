> ⚠️ **文档状态**: 已过时（2025-10-21）
> 
> 本文档基于v2.0架构设计，已被新的v2.1架构取代。
> 
> **替代文档**：[阅读任务系统设计v2](./阅读任务系统设计v2.md)
> 
> **过时原因**：
> - 职责边界不清晰（Reading Task vs User Level vs Wallet Service）
> - 直接修改用户余额和经验值（违反单一数据源原则）
> - 缺少事件发布机制
> 
> 详见：[模块边界优化方案](../重构规划/模块边界优化方案.md)

---

# 阅读任务设计

## 1. 需求概述

### 1.1 功能描述
阅读任务系统是青羽阅读平台的用户激励核心，通过设置每日阅读目标、打卡机制和代币奖励，鼓励用户养成良好的阅读习惯。系统支持任务管理、进度跟踪、奖励发放等功能，提升用户活跃度和平台粘性。

### 1.2 业务价值
- **用户留存**：通过任务激励提升用户日活跃度和留存率
- **习惯养成**：帮助用户建立持续的阅读习惯
- **平台粘性**：每日任务增强用户对平台的依赖性
- **数据收集**：阅读行为数据为个性化推荐提供支持

### 1.3 用户场景
- **每日打卡**：用户完成每日30分钟阅读任务获得代币奖励
- **进度查看**：用户查看当日和历史阅读任务完成情况
- **奖励领取**：用户领取完成任务后的代币和其他奖励
- **统计分析**：用户查看个人阅读统计和成就记录

### 1.4 功能边界
- **包含功能**：每日任务、阅读打卡、代币奖励、进度统计、成就系统
- **不包含功能**：代币消费（由钱包系统提供）、内容推荐（由推荐系统提供）

## 2. 架构设计

### 2.1 整体架构
`

   Router层        任务路由、权限验证

   API层           任务接口、奖励管理

   Service层       任务逻辑、奖励计算

   Repository层    任务数据、统计存储

   Model层         任务模型、奖励模型

`

### 2.2 模块划分
- **任务模块**：每日任务生成、任务状态管理、完成验证
- **打卡模块**：阅读时长统计、打卡记录、连续打卡
- **奖励模块**：代币发放、奖励计算、特殊奖励
- **统计模块**：阅读统计、成就统计、排行榜

## 3. 详细设计

### 3.1 Router层设计
- **路由分组**：/api/v1/tasks
- **中间件**：JWT认证中间件、日志中间件、限流中间件
- **路径规范**：RESTful风格，支持任务类型和日期参数
- **参数处理**：用户ID、任务类型、日期范围、分页参数

### 3.2 API层设计
- **接口定义**：任务查询、打卡提交、奖励领取、统计查看
- **请求验证**：用户身份验证、任务有效性验证、重复提交检查
- **响应格式**：统一JSON格式，包含任务状态和奖励信息
- **错误处理**：任务不存在、重复打卡、奖励已领取等错误处理

### 3.3 Service层设计
- **业务流程**：任务生成、进度计算、奖励发放、统计更新
- **数据处理**：阅读时长计算、连续天数统计、成就判定
- **依赖服务**：用户服务、钱包服务、阅读记录服务
- **异常处理**：任务生成失败、奖励发放异常、数据同步异常
- **Repository交互**：通过Repository接口管理任务数据和用户统计

### 3.4 Repository层设计
- **接口抽象**：定义TaskRepository和StatisticsRepository接口
- **查询封装**：任务查询、统计查询、排行榜查询、历史记录查询
- **事务管理**：任务完成事务、奖励发放事务、统计更新事务
- **缓存策略**：用户任务缓存、统计数据缓存、排行榜缓存
- **异常处理**：数据库异常处理、缓存同步异常处理
- **与Model关系**：任务模型和统计模型的数据映射

### 3.5 Model层设计
- **数据模型**：Task、ReadingRecord、UserStatistics等实体
- **约束规则**：任务时间有效性、奖励数量限制、统计数据准确性
- **验证逻辑**：任务完成条件验证、奖励资格验证、数据一致性检查
- **Repository接口**：定义任务管理和统计计算的接口方法

## 4. 数据设计

### 4.1 数据模型

#### 4.1.1 每日任务模型 (DailyTask)

```go
type DailyTask struct {
    ID          string    bson:"_id,omitempty" json:"id"
    UserID      string    bson:"user_id" json:"userId"            // 用户ID
    TaskDate    time.Time bson:"task_date" json:"taskDate"        // 任务日期
    TaskType    int       bson:"task_type" json:"taskType"        // 任务类型：1-阅读时长，2-阅读章节
    Target      int64     bson:"target" json:"target"             // 目标值（秒/章节数）
    Progress    int64     bson:"progress" json:"progress"         // 当前进度
    Status      int       bson:"status" json:"status"             // 状态：1-进行中，2-已完成，3-已过期
    RewardType  int       bson:"reward_type" json:"rewardType"    // 奖励类型：1-代币，2-积分
    RewardAmount int64    bson:"reward_amount" json:"rewardAmount" // 奖励数量
    IsRewarded  bool      bson:"is_rewarded" json:"isRewarded"    // 是否已领取奖励
    CompletedAt time.Time bson:"completed_at" json:"completedAt"  // 完成时间
    CreatedAt   time.Time bson:"created_at" json:"createdAt"
    UpdatedAt   time.Time bson:"updated_at" json:"updatedAt"
}
```

#### 4.1.2 阅读记录模型 (ReadingRecord)

```go
type ReadingRecord struct {
    ID          string    bson:"_id,omitempty" json:"id"
    UserID      string    bson:"user_id" json:"userId"            // 用户ID
    BookID      string    bson:"book_id" json:"bookId"            // 书籍ID
    ChapterID   string    bson:"chapter_id" json:"chapterId"      // 章节ID
    StartTime   time.Time bson:"start_time" json:"startTime"      // 开始时间
    EndTime     time.Time bson:"end_time" json:"endTime"          // 结束时间
    Duration    int64     bson:"duration" json:"duration"         // 阅读时长（秒）
    WordCount   int       bson:"word_count" json:"wordCount"      // 阅读字数
    IsValid     bool      bson:"is_valid" json:"isValid"          // 是否有效阅读
    Source      string    bson:"source" json:"source"             // 来源：app, web
    CreatedAt   time.Time bson:"created_at" json:"createdAt"
}
```

#### 4.1.3 用户统计模型 (UserStatistics)

```go
type UserStatistics struct {
    ID              string    bson:"_id,omitempty" json:"id"
    UserID          string    bson:"user_id" json:"userId"              // 用户ID
    TotalReadingTime int64    bson:"total_reading_time" json:"totalReadingTime" // 总阅读时长（秒）
    TotalDays       int       bson:"total_days" json:"totalDays"        // 总阅读天数
    ContinuousDays  int       bson:"continuous_days" json:"continuousDays" // 连续阅读天数
    MaxContinuous   int       bson:"max_continuous" json:"maxContinuous" // 最大连续天数
    TotalBooks      int       bson:"total_books" json:"totalBooks"      // 阅读书籍总数
    TotalChapters   int       bson:"total_chapters" json:"totalChapters" // 阅读章节总数
    TotalCoins      int64     bson:"total_coins" json:"totalCoins"      // 获得代币总数
    LastReadDate    time.Time bson:"last_read_date" json:"lastReadDate" // 最后阅读日期
    CreatedAt       time.Time bson:"created_at" json:"createdAt"
    UpdatedAt       time.Time bson:"updated_at" json:"updatedAt"
}
```

#### 4.1.4 成就模型 (Achievement)

```go
type Achievement struct {
    ID          string    bson:"_id,omitempty" json:"id"
    Name        string    bson:"name" json:"name"                 // 成就名称
    Description string    bson:"description" json:"description"   // 成就描述
    Icon        string    bson:"icon" json:"icon"                 // 成就图标
    Type        int       bson:"type" json:"type"                 // 类型：1-阅读时长，2-连续天数，3-书籍数量
    Condition   int64     bson:"condition" json:"condition"       // 达成条件
    RewardType  int       bson:"reward_type" json:"rewardType"    // 奖励类型
    RewardAmount int64    bson:"reward_amount" json:"rewardAmount" // 奖励数量
    IsActive    bool      bson:"is_active" json:"isActive"        // 是否启用
    CreatedAt   time.Time bson:"created_at" json:"createdAt"
    UpdatedAt   time.Time bson:"updated_at" json:"updatedAt"
}
```

#### 4.1.5 用户成就模型 (UserAchievement)

```go
type UserAchievement struct {
    ID            string    bson:"_id,omitempty" json:"id"
    UserID        string    bson:"user_id" json:"userId"            // 用户ID
    AchievementID string    bson:"achievement_id" json:"achievementId" // 成就ID
    Progress      int64     bson:"progress" json:"progress"         // 当前进度
    IsCompleted   bool      bson:"is_completed" json:"isCompleted"  // 是否完成
    IsRewarded    bool      bson:"is_rewarded" json:"isRewarded"    // 是否已领取奖励
    CompletedAt   time.Time bson:"completed_at" json:"completedAt"  // 完成时间
    CreatedAt     time.Time bson:"created_at" json:"createdAt"
    UpdatedAt     time.Time bson:"updated_at" json:"updatedAt"
}
```

### 4.2 数据关系

- **任务-用户**：多对一关系，一个用户有多个每日任务
- **记录-用户**：多对一关系，一个用户有多个阅读记录
- **统计-用户**：一对一关系，每个用户有一个统计记录
- **成就-用户**：多对多关系，用户和成就的完成关系

### 4.3 索引策略

| 集合名称 | 索引字段 | 索引类型 | 说明 |
|---------|---------|---------|------|
| daily_tasks | user_id, task_date | compound | 用户每日任务查询 |
| daily_tasks | task_date, status | compound | 任务状态统计查询 |
| reading_records | user_id, created_at | compound | 用户阅读记录时序查询 |
| reading_records | user_id, start_time | compound | 用户阅读时间查询 |
| user_statistics | user_id | unique | 用户统计唯一索引 |
| user_statistics | continuous_days | normal | 连续天数排行查询 |
| user_achievements | user_id, achievement_id | compound | 用户成就查询 |
| user_achievements | achievement_id, is_completed | compound | 成就完成统计查询 |

### 4.4 数据迁移

- **版本1.0**：基础任务、记录、统计数据结构
- **版本1.1**：增加成就系统、奖励机制
- **版本1.2**：增加排行榜、社交分享功能

## 5. 接口设计

### 5.1 API概览

| 方法 | 路径 | 功能描述 | 权限要求 |
|-----|------|---------|---------|
| GET | /api/v1/tasks/daily | 获取每日任务 | 登录用户 |
| POST | /api/v1/tasks/checkin | 提交阅读打卡 | 登录用户 |
| POST | /api/v1/tasks/rewards/claim | 领取任务奖励 | 登录用户 |
| GET | /api/v1/tasks/statistics | 获取阅读统计 | 登录用户 |
| GET | /api/v1/tasks/achievements | 获取成就列表 | 登录用户 |
| POST | /api/v1/tasks/achievements/:id/claim | 领取成就奖励 | 登录用户 |
| GET | /api/v1/tasks/rankings | 获取排行榜 | 登录用户 |

### 5.2 请求与响应格式

#### 5.2.1 获取每日任务 (GET /api/v1/tasks/daily)

**请求参数**:

```json
{
  "date": "2024-01-01"
}
```

**响应格式**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "tasks": [
      {
        "id": "task_id",
        "taskType": 1,
        "target": 1800,
        "progress": 1200,
        "status": 1,
        "rewardType": 1,
        "rewardAmount": 10,
        "isRewarded": false,
        "progressPercent": 66.7
      }
    ],
    "totalProgress": {
      "readingTime": 1200,
      "targetTime": 1800,
      "completedTasks": 0,
      "totalTasks": 1
    }
  }
}
```

#### 5.2.2 提交阅读打卡 (POST /api/v1/tasks/checkin)

**请求参数**:

```json
{
  "bookId": "book_id",
  "chapterId": "chapter_id",
  "startTime": "2024-01-01T10:00:00Z",
  "endTime": "2024-01-01T10:30:00Z",
  "duration": 1800,
  "wordCount": 1000
}
```

**响应格式**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "recordId": "record_id",
    "isValid": true,
    "taskUpdated": true,
    "newProgress": 1800,
    "taskCompleted": true,
    "rewardEarned": {
      "type": 1,
      "amount": 10
    }
  }
}
```

#### 5.2.3 获取阅读统计 (GET /api/v1/tasks/statistics)

**请求参数**:

```json
{
  "period": "week",
  "startDate": "2024-01-01",
  "endDate": "2024-01-07"
}
```

**响应格式**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "overview": {
      "totalReadingTime": 36000,
      "totalDays": 15,
      "continuousDays": 7,
      "maxContinuous": 12,
      "totalBooks": 5,
      "totalCoins": 150
    },
    "dailyStats": [
      {
        "date": "2024-01-01",
        "readingTime": 1800,
        "completedTasks": 1,
        "earnedCoins": 10
      }
    ],
    "achievements": [
      {
        "id": "achievement_id",
        "name": "阅读新手",
        "isCompleted": true,
        "completedAt": "2024-01-01T00:00:00Z"
      }
    ]
  }
}
```

#### 5.2.4 领取任务奖励 (POST /api/v1/tasks/rewards/claim)

**请求参数**:

```json
{
  "taskId": "task_id"
}
```

**响应格式**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "claimed": true,
    "rewardType": 1,
    "rewardAmount": 10,
    "newBalance": 120
  }
}
```

#### 5.2.5 获取排行榜 (GET /api/v1/tasks/rankings)

**请求参数**:

```json
{
  "type": "continuous_days",
  "period": "month",
  "limit": 50
}
```

**响应格式**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "rankings": [
      {
        "rank": 1,
        "user": {
          "id": "user_id",
          "nickname": "用户昵称",
          "avatar": "头像URL"
        },
        "value": 30,
        "label": "连续30天"
      }
    ],
    "myRank": {
      "rank": 15,
      "value": 7,
      "label": "连续7天"
    }
  }
}
```

**状态码**:

- 200: 成功
- 400: 请求参数错误
- 401: 未登录
- 409: 重复操作（如重复打卡）
- 500: 服务器错误

## 6. 核心算法设计

### 6.1 阅读时长统计算法

#### 6.1.1 Redis Bitmap实现

```go
// 使用Redis Bitmap记录用户每分钟的阅读状态
func RecordReadingMinute(userID string, timestamp time.Time) error {
    // 计算在当天的第几分钟
    dayStart := time.Date(timestamp.Year(), timestamp.Month(), timestamp.Day(), 0, 0, 0, 0, timestamp.Location())
    minuteOffset := int(timestamp.Sub(dayStart).Minutes())
    
    // 设置对应位为1
    key := fmt.Sprintf("reading:%s:%s", userID, dayStart.Format("2006-01-02"))
    return redis.SetBit(key, minuteOffset, 1)
}

// 计算当天总阅读时长
func CalculateDailyReadingTime(userID string, date time.Time) (int64, error) {
    key := fmt.Sprintf("reading:%s:%s", userID, date.Format("2006-01-02"))
    return redis.BitCount(key)
}
```

#### 6.1.2 有效阅读判定

- **最小阅读时长**：单次阅读不少于1分钟
- **最大间隔时间**：连续阅读间隔不超过5分钟
- **异常检测**：检测异常快速翻页等无效行为
- **去重处理**：同一时间段重复记录去重

### 6.2 连续天数计算算法

#### 6.2.1 连续天数统计

```go
func CalculateContinuousDays(userID string, currentDate time.Time) (int, error) {
    continuousDays := 0
    checkDate := currentDate
    
    for {
        // 检查当天是否有阅读记录
        hasReading, err := HasReadingRecord(userID, checkDate)
        if err != nil {
            return 0, err
        }
        
        if !hasReading {
            break
        }
        
        continuousDays++
        checkDate = checkDate.AddDate(0, 0, -1)
        
        // 防止无限循环，最多查询365天
        if continuousDays >= 365 {
            break
        }
    }
    
    return continuousDays, nil
}
```

#### 6.2.2 成就进度更新

```go
func UpdateAchievementProgress(userID string, achievementType int, currentValue int64) error {
    // 获取用户相关成就
    achievements, err := GetUserAchievements(userID, achievementType)
    if err != nil {
        return err
    }
    
    for _, achievement := range achievements {
        if achievement.IsCompleted {
            continue
        }
        
        // 更新进度
        achievement.Progress = currentValue
        
        // 检查是否完成
        if currentValue >= achievement.Condition {
            achievement.IsCompleted = true
            achievement.CompletedAt = time.Now()
            
            // 发送成就完成通知
            SendAchievementNotification(userID, achievement.ID)
        }
        
        // 保存更新
        err = SaveUserAchievement(achievement)
        if err != nil {
            return err
        }
    }
    
    return nil
}
```

### 6.3 奖励计算算法

#### 6.3.1 基础奖励计算

```go
func CalculateTaskReward(taskType int, progress int64, target int64) int64 {
    baseReward := int64(10) // 基础奖励10代币
    
    switch taskType {
    case 1: // 阅读时长任务
        if progress >= target {
            return baseReward
        }
    case 2: // 阅读章节任务
        if progress >= target {
            return baseReward
        }
    }
    
    return 0
}
```

#### 6.3.2 连续奖励加成

```go
func CalculateContinuousBonus(continuousDays int) float64 {
    switch {
    case continuousDays >= 30:
        return 2.0 // 连续30天，奖励翻倍
    case continuousDays >= 14:
        return 1.5 // 连续14天，奖励1.5倍
    case continuousDays >= 7:
        return 1.2 // 连续7天，奖励1.2倍
    default:
        return 1.0 // 无加成
    }
}
```

## 7. 安全设计

### 7.1 防刷机制

- **时间验证**：验证阅读时间的合理性，防止虚假时长
- **行为分析**：分析用户阅读行为模式，检测异常
- **频率限制**：限制打卡提交频率，防止恶意刷取
- **设备指纹**：记录设备信息，防止多设备刷取

### 7.2 数据安全

- **数据加密**：敏感统计数据加密存储
- **访问控制**：用户只能访问自己的任务和统计数据
- **审计日志**：记录所有奖励发放和异常操作

### 7.3 奖励安全

- **重复检查**：防止重复领取奖励
- **额度限制**：设置每日奖励上限
- **异常监控**：监控异常奖励发放行为

## 8. 性能优化

### 8.1 缓存策略

- **任务缓存**：缓存用户当日任务状态
- **统计缓存**：缓存用户统计数据，定期更新
- **排行榜缓存**：缓存排行榜数据，每小时更新

### 8.2 数据库优化

- **分区存储**：按日期分区存储阅读记录
- **索引优化**：为常用查询建立合适索引
- **批量处理**：批量更新统计数据

### 8.3 计算优化

- **异步处理**：统计计算异步进行
- **增量更新**：只计算变化的数据
- **定时任务**：定时生成每日任务和更新统计

## 9. 监控和运维

### 9.1 监控指标

- **业务指标**：任务完成率、用户活跃度、奖励发放量
- **技术指标**：API响应时间、数据库性能、缓存命中率
- **异常指标**：异常打卡行为、奖励发放异常

### 9.2 告警机制

- **异常告警**：检测到刷取行为时触发告警
- **性能告警**：系统性能指标异常时告警
- **业务告警**：关键业务指标异常时告警

### 9.3 数据分析

- **用户行为分析**：分析用户阅读习惯和任务完成情况
- **效果评估**：评估任务系统对用户活跃度的影响
- **优化建议**：基于数据分析提供优化建议

## 10. 实施计划

### 10.1 开发阶段

- **第1周**：数据模型设计、基础架构搭建
- **第2周**：每日任务系统、阅读记录统计
- **第3周**：奖励系统、代币发放机制
- **第4周**：成就系统、排行榜功能
- **第5周**：防刷机制、安全加固
- **第6周**：性能优化、测试部署

### 10.2 测试阶段

- **功能测试**：核心任务功能验证
- **性能测试**：高并发打卡、大量数据统计
- **安全测试**：防刷机制、异常行为检测
- **用户测试**：真实用户使用体验测试

### 10.3 上线计划

- **灰度发布**：先对部分用户开放任务功能
- **数据监控**：密切监控任务数据和用户反馈
- **运营配合**：配合运营活动调整任务和奖励
- **持续优化**：根据数据反馈持续优化机制
- **全量发布**：稳定后向所有用户开放

## 11. 风险评估

### 11.1 技术风险

- **性能瓶颈**：大量用户同时打卡可能导致系统压力
- **数据一致性**：分布式环境下统计数据的一致性
- **缓存失效**：缓存雪崩可能影响任务功能

### 11.2 业务风险

- **刷取风险**：恶意用户可能刷取任务奖励
- **成本控制**：奖励发放成本需要合理控制
- **用户流失**：任务设计不当可能导致用户流失

### 11.3 运营风险

- **奖励通胀**：过多奖励可能导致代币贬值
- **用户依赖**：过度依赖奖励可能影响自然阅读
- **公平性**：确保任务系统对所有用户公平
