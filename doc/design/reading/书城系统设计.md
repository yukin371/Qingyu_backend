# 书城系统设计

## 1. 需求概述

### 1.1 功能描述
书城系统是青羽阅读平台的核心展示模块，为用户提供书籍浏览、搜索、分类和发现功能。系统通过轮播Banner、多维度榜单、个性化推荐等方式，帮助用户快速找到感兴趣的书籍。

### 1.2 业务价值
- **流量入口**：作为平台主要流量入口，提升用户活跃度和留存率
- **内容分发**：高效的内容分发机制，提升优质作品的曝光度
- **用户体验**：直观的浏览体验，降低用户寻找内容的成本
- **商业价值**：通过榜单和推荐位实现内容的商业化运营

### 1.3 用户场景
- **新用户探索**：新用户通过书城首页了解平台内容，发现感兴趣的书籍
- **老用户回访**：老用户通过榜单和推荐发现新的优质内容
- **分类浏览**：用户根据兴趣偏好浏览特定分类的书籍
- **搜索查找**：用户通过关键词搜索特定书籍或作者

### 1.4 功能边界
- **包含功能**：书城首页、书籍详情、分类浏览、搜索功能、榜单展示、Banner管理
- **不包含功能**：个性化推荐算法（由推荐系统提供）、阅读功能（由阅读器提供）、用户管理（由用户系统提供）

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────┐
│   Router层      │ ← 路由分发、中间件处理、参数验证
├─────────────────┤
│   API层         │ ← HTTP接口、参数验证、响应格式化
├─────────────────┤
│   Service层     │ ← 业务逻辑、数据聚合、缓存策略
├─────────────────┤
│   Repository层  │ ← 数据访问、查询优化、事务管理
├─────────────────┤
│   Model层       │ ← 数据模型、业务实体、验证规则
└─────────────────┘
```

### 2.2 模块划分

- **首页模块**：轮播Banner、榜单展示、推荐位管理、数据聚合
- **书籍模块**：书籍详情、基本信息、统计数据、搜索功能
- **分类模块**：分类管理、分类浏览、层级结构、标签系统
- **Banner模块**：Banner管理、点击统计、时间控制、目标跳转

## 3. 详细设计

### 3.1 Router层设计
- **路由分组**：/api/v1/bookstore
- **中间件**：认证中间件（可选）、日志中间件、CORS中间件、限流中间件
- **路径规范**：RESTful风格，资源名词复数形式
- **参数处理**：路径参数（ID）、查询参数（分页、筛选）、请求体（搜索条件）
- **公私分离**：区分公开路由和需要认证的路由

### 3.2 API层设计
- **接口定义**：标准HTTP方法，统一的路径命名，完整的Swagger文档
- **请求验证**：参数类型校验、业务规则验证、安全过滤、防SQL注入
- **响应格式**：统一的JSON响应结构，包含状态码、消息、数据、分页信息
- **错误处理**：标准错误码、详细错误信息、国际化支持、错误日志记录

### 3.3 Service层设计
- **业务流程**：数据聚合、业务规则处理、缓存管理、并发控制
- **数据处理**：多数据源整合、数据格式转换、业务计算、统计分析
- **依赖服务**：推荐服务、搜索服务、统计服务、缓存服务
- **异常处理**：业务异常捕获、降级策略、重试机制、熔断保护
- **Repository交互**：通过Repository接口访问数据，支持事务操作

### 3.4 Repository层设计
- **接口抽象**：定义BookRepository、CategoryRepository、BannerRepository接口，支持多种数据源实现
- **查询封装**：复杂查询的封装，包括分页、排序、筛选、全文搜索、聚合查询
- **事务管理**：读写分离、事务边界控制、一致性保证、死锁处理
- **缓存策略**：热点数据缓存、缓存更新策略、缓存穿透防护、缓存雪崩预防
- **异常处理**：数据库异常统一处理、连接池管理、超时控制
- **与Model关系**：Model到数据库字段的映射、数据类型转换、验证规则

### 3.5 Model层设计
- **数据模型**：Book、Category、Banner等核心实体定义，包含完整的字段和约束
- **约束规则**：字段必填性、唯一性、长度限制、格式验证、业务规则验证
- **验证逻辑**：业务规则验证、数据完整性检查、跨字段验证
- **Repository接口**：定义数据访问需要的接口方法，支持复杂查询和统计

## 4. 数据设计

### 4.1 数据模型

#### 4.1.1 书籍模型 (Book)
```go
type Book struct {
    ID           primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    Title        string              `bson:"title" json:"title"`                    // 书名
    Author       string              `bson:"author" json:"author"`                  // 作者
    Introduction string              `bson:"introduction" json:"introduction"`      // 简介
    Cover        string              `bson:"cover" json:"cover"`                    // 封面URL
    CategoryIDs  []primitive.ObjectID `bson:"category_ids" json:"categoryIds"`      // 分类ID列表
    Tags         []string            `bson:"tags" json:"tags"`                      // 标签
    Status       string              `bson:"status" json:"status"`                  // 状态：draft/published
    WordCount    int64               `bson:"word_count" json:"wordCount"`           // 字数
    ChapterCount int                 `bson:"chapter_count" json:"chapterCount"`     // 章节数
    ViewCount    int64               `bson:"view_count" json:"viewCount"`           // 浏览量
    LikeCount    int64               `bson:"like_count" json:"likeCount"`           // 点赞数
    CommentCount int64               `bson:"comment_count" json:"commentCount"`     // 评论数
    Rating       float64             `bson:"rating" json:"rating"`                  // 评分 0-5
    RatingCount  int64               `bson:"rating_count" json:"ratingCount"`       // 评分人数
    IsRecommended bool               `bson:"is_recommended" json:"isRecommended"`   // 是否推荐
    IsFeatured   bool                `bson:"is_featured" json:"isFeatured"`         // 是否精选
    PublishedAt  *time.Time          `bson:"published_at,omitempty" json:"publishedAt,omitempty"` // 发布时间
    CreatedAt    time.Time           `bson:"created_at" json:"createdAt"`           // 创建时间
    UpdatedAt    time.Time           `bson:"updated_at" json:"updatedAt"`           // 更新时间
}
```

#### 4.1.2 分类模型 (Category)
```go
type Category struct {
    ID          primitive.ObjectID `bson:"_id,omitempty" json:"id"`
    Name        string            `bson:"name" json:"name"`                        // 分类名称
    Description string            `bson:"description" json:"description"`          // 分类描述
    Icon        string            `bson:"icon" json:"icon"`                        // 分类图标URL
    ParentID    *primitive.ObjectID `bson:"parent_id,omitempty" json:"parentId,omitempty"` // 父分类ID
    Level       int               `bson:"level" json:"level"`                      // 分类层级 0-顶级分类
    SortOrder   int               `bson:"sort_order" json:"sortOrder"`             // 排序权重
    BookCount   int64             `bson:"book_count" json:"bookCount"`             // 书籍数量
    IsActive    bool              `bson:"is_active" json:"isActive"`               // 是否启用
    CreatedAt   time.Time         `bson:"created_at" json:"createdAt"`             // 创建时间
    UpdatedAt   time.Time         `bson:"updated_at" json:"updatedAt"`             // 更新时间
}
```

#### 4.1.3 Banner模型 (Banner)
```go
type Banner struct {
    ID          primitive.ObjectID `bson:"_id,omitempty" json:"id"`
    Title       string            `bson:"title" json:"title"`                      // 标题
    Description string            `bson:"description" json:"description"`          // 描述
    Image       string            `bson:"image" json:"image"`                      // 图片URL
    Target      string            `bson:"target" json:"target"`                    // 跳转目标
    TargetType  string            `bson:"target_type" json:"targetType"`           // 目标类型：book/category/url
    SortOrder   int               `bson:"sort_order" json:"sortOrder"`             // 排序权重
    IsActive    bool              `bson:"is_active" json:"isActive"`               // 是否启用
    StartTime   *time.Time        `bson:"start_time,omitempty" json:"startTime,omitempty"` // 开始时间
    EndTime     *time.Time        `bson:"end_time,omitempty" json:"endTime,omitempty"`     // 结束时间
    ClickCount  int64             `bson:"click_count" json:"clickCount"`           // 点击次数
    CreatedAt   time.Time         `bson:"created_at" json:"createdAt"`             // 创建时间
    UpdatedAt   time.Time         `bson:"updated_at" json:"updatedAt"`             // 更新时间
}
```

### 4.2 数据关系
- **书籍与分类**：多对多关系，一本书可以属于多个分类，一个分类包含多本书
- **分类层级**：树形结构，支持多级分类，通过parent_id和level字段维护层级关系
- **Banner与目标**：一对一关系，每个Banner指向一个目标（书籍、分类或外链）

### 4.3 索引策略

| 集合名称 | 索引字段 | 索引类型 | 说明 |
|---------|---------|---------|------|
| books | title | text | 全文搜索索引 |
| books | author | normal | 作者查询索引 |
| books | category_ids | normal | 分类查询索引 |
| books | status | normal | 状态查询索引 |
| books | is_recommended | normal | 推荐书籍索引 |
| books | is_featured | normal | 精选书籍索引 |
| books | rating, view_count | compound | 排序复合索引 |
| books | created_at | normal | 时间排序索引 |
| categories | parent_id | normal | 父分类查询索引 |
| categories | level | normal | 层级查询索引 |
| categories | sort_order | normal | 排序索引 |
| categories | is_active | normal | 状态查询索引 |
| banners | is_active | normal | 状态查询索引 |
| banners | target_type | normal | 目标类型索引 |
| banners | sort_order | normal | 排序索引 |
| banners | start_time, end_time | compound | 时间范围索引 |

### 4.4 数据迁移
- **版本1.0**：基础数据结构创建
- **版本1.1**：添加书籍统计字段（view_count, like_count等）
- **版本1.2**：添加分类层级结构支持
- **版本1.3**：添加Banner时间控制功能

## 5. 接口设计

### 5.1 API概览

| 方法 | 路径 | 功能描述 | 权限要求 |
|-----|------|---------|---------|
| GET | /api/v1/bookstore/homepage | 获取首页数据 | 无 |
| GET | /api/v1/bookstore/books/{id} | 获取书籍详情 | 无 |
| GET | /api/v1/bookstore/books/recommended | 获取推荐书籍 | 无 |
| GET | /api/v1/bookstore/books/featured | 获取精选书籍 | 无 |
| GET | /api/v1/bookstore/books/search | 搜索书籍 | 无 |
| POST | /api/v1/bookstore/books/{id}/view | 增加浏览量 | 可选认证 |
| GET | /api/v1/bookstore/categories/tree | 获取分类树 | 无 |
| GET | /api/v1/bookstore/categories/{id} | 获取分类详情 | 无 |
| GET | /api/v1/bookstore/categories/{id}/books | 根据分类获取书籍 | 无 |
| GET | /api/v1/bookstore/banners | 获取Banner列表 | 无 |
| POST | /api/v1/bookstore/banners/{id}/click | 增加点击次数 | 可选认证 |

### 5.2 请求与响应格式

#### 5.2.1 获取首页数据 (GET /api/v1/bookstore/homepage)

**响应格式**:
```json
{
  "code": 200,
  "message": "获取首页数据成功",
  "data": {
    "banners": [
      {
        "id": "banner_id",
        "title": "Banner标题",
        "image": "https://example.com/banner.jpg",
        "target": "book_id_or_url",
        "targetType": "book"
      }
    ],
    "recommendedBooks": [
      {
        "id": "book_id",
        "title": "书名",
        "author": "作者",
        "cover": "https://example.com/cover.jpg",
        "rating": 4.5,
        "viewCount": 1000
      }
    ],
    "featuredBooks": [...],
    "categories": [...],
    "stats": {
      "totalBooks": 10000,
      "publishedBooks": 8000
    }
  }
}
```

#### 5.2.2 搜索书籍 (GET /api/v1/bookstore/books/search)

**请求参数**:
- keyword (query): 搜索关键词
- categoryId (query): 分类ID
- author (query): 作者
- minRating (query): 最低评分
- tags (query): 标签数组
- sortBy (query): 排序字段
- sortOrder (query): 排序方向
- page (query): 页码
- size (query): 每页数量

**响应格式**:
```json
{
  "code": 200,
  "message": "搜索书籍成功",
  "data": [
    {
      "id": "book_id",
      "title": "书名",
      "author": "作者",
      "introduction": "简介",
      "cover": "封面URL",
      "rating": 4.5,
      "viewCount": 1000
    }
  ],
  "total": 100,
  "page": 1,
  "size": 20
}
```

**状态码**:
- 200: 成功
- 400: 请求参数错误
- 500: 服务器错误

## 6. 安全设计

### 6.1 权限控制
- **公开接口**：书籍浏览、搜索、分类查看等功能对所有用户开放
- **认证接口**：浏览量统计、点击统计等需要用户认证以防刷量
- **管理接口**：书籍管理、分类管理、Banner管理需要管理员权限

### 6.2 数据安全
- **输入验证**：所有用户输入进行严格验证，防止SQL注入和XSS攻击
- **输出过滤**：敏感信息过滤，如内部ID、调试信息等
- **访问控制**：基于角色的访问控制，确保用户只能访问授权资源

### 6.3 输入验证
- **参数校验**：类型检查、长度限制、格式验证、范围检查
- **业务验证**：状态检查、权限验证、业务规则验证
- **防护措施**：限流、防刷、防爬虫、IP黑名单

### 6.4 审计日志
- **操作记录**：记录所有重要操作，包括用户ID、操作时间、操作内容
- **异常监控**：监控异常访问模式，如频繁请求、异常IP等
- **数据追踪**：关键数据变更的完整追踪链路

## 7. 测试设计

### 7.1 测试策略
- **单元测试**：覆盖所有Service层业务逻辑，Repository层数据访问逻辑
- **集成测试**：测试API接口的完整流程，包括参数验证、业务处理、响应格式
- **端到端测试**：模拟用户完整使用流程，验证系统整体功能

### 7.2 测试用例
- **正常流程**：用户浏览首页、搜索书籍、查看详情等正常操作
- **边界条件**：空数据、大数据量、极限参数等边界情况
- **异常处理**：网络异常、数据库异常、参数错误等异常情况
- **性能测试**：高并发访问、大数据量查询、缓存效果等性能指标

### 7.3 性能测试
- **负载测试**：模拟正常用户负载，验证系统稳定性
- **压力测试**：测试系统极限承载能力
- **缓存测试**：验证缓存策略的有效性和一致性

## 8. 部署和运维

### 8.1 部署方案
- **容器化部署**：使用Docker容器化部署，支持水平扩展
- **负载均衡**：使用Nginx进行负载均衡和反向代理
- **数据库集群**：MongoDB副本集部署，支持读写分离

### 8.2 监控指标
- **业务指标**：书籍浏览量、搜索量、分类访问量、Banner点击率
- **技术指标**：响应时间、错误率、并发数、数据库性能
- **资源指标**：CPU使用率、内存使用率、磁盘IO、网络IO

### 8.3 日志策略
- **访问日志**：记录所有API访问，包括请求参数、响应时间、状态码
- **业务日志**：记录关键业务操作，如书籍创建、分类变更等
- **错误日志**：记录所有系统错误和异常，便于问题排查

### 8.4 故障处理
- **常见问题**：数据库连接超时、缓存失效、第三方服务异常
- **应急预案**：服务降级、熔断机制、备用方案
- **恢复流程**：故障定位、问题修复、服务恢复、事后总结

## 9. 风险评估

### 9.1 技术风险
- **数据库性能**：大量并发查询可能导致数据库性能瓶颈
- **缓存一致性**：缓存与数据库数据不一致的风险
- **第三方依赖**：推荐服务、搜索服务等外部依赖的可用性风险

### 9.2 业务风险
- **数据质量**：书籍信息不准确、分类混乱等数据质量问题
- **用户体验**：搜索结果不准确、页面加载慢等用户体验问题
- **内容合规**：书籍内容的合规性审查和管理

### 9.3 性能风险
- **热点数据**：热门书籍、分类的访问集中可能导致性能瓶颈
- **搜索性能**：复杂搜索条件下的查询性能问题
- **缓存雪崩**：缓存大量失效导致数据库压力激增

## 10. 实施计划

### 10.1 开发阶段
- **第一阶段（2周）**：完成Model层和Repository层开发
- **第二阶段（2周）**：完成Service层和API层开发
- **第三阶段（1周）**：完成Router层和集成测试
- **第四阶段（1周）**：性能优化和部署准备

### 10.2 测试阶段
- **单元测试**：开发过程中同步进行，覆盖率要求80%以上
- **集成测试**：API开发完成后进行，验证接口功能完整性
- **性能测试**：部署前进行，确保满足性能要求
- **用户验收测试**：与产品团队协作进行功能验收

### 10.3 上线计划
- **灰度发布**：先在小范围用户中测试，逐步扩大范围
- **监控部署**：部署完整的监控和告警系统
- **回滚方案**：准备快速回滚机制，确保服务稳定性
- **文档更新**：更新API文档、运维文档、用户手册

## 11. 后续优化

### 11.1 功能扩展
- **个性化推荐**：基于用户行为的个性化书籍推荐
- **社交功能**：书评、评分、收藏、分享等社交功能
- **智能搜索**：语义搜索、搜索建议、热门搜索等

### 11.2 性能优化
- **缓存优化**：多级缓存、缓存预热、智能缓存策略
- **数据库优化**：索引优化、查询优化、分库分表
- **CDN加速**：静态资源CDN加速，提升用户体验

### 11.3 技术升级
- **微服务拆分**：将书城系统拆分为更细粒度的微服务
- **消息队列**：引入消息队列处理异步任务
- **大数据分析**：用户行为分析、内容推荐算法优化
