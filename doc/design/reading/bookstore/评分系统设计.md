# 评分系统设计

> **版本**: v1.0  
> **创建日期**: 2025-10-21  
> **最后更新**: 2025-10-21  
> **状态**: ✅ 已实现，补充设计文档

---

## 1. 为什么需要这个设计

### 1.1 业务背景

评分系统是内容质量评估的核心功能，负责：
- 用户对书籍的主观评价
- 书籍质量的量化指标
- 推荐系统的重要数据源
- 作者作品质量反馈
- 榜单排序的关键因素

### 1.2 实际实现情况

已完整实现，包含：
- **BookRating数据模型**：`models/reading/bookstore/book_rating.go`
- **评分统计**：集成在BookStatistics中
- **评分验证**：防止重复评分、恶意刷分

**实现文件**：
- `models/reading/bookstore/book_rating.go` - 评分数据模型
- `models/reading/bookstore/book_statistics.go` - 统计数据（包含评分）
- `service/bookstore/bookstore_service.go` - 评分业务逻辑
- `repository/mongodb/bookstore/book_rating_mongo.go` - Repository实现

---

## 2. 数据模型设计

### 2.1 BookRating（书籍评分）

#### 2.1.1 数据结构

```go
type BookRating struct {
    ID        string    `bson:"_id,omitempty" json:"id"`
    BookID    string    `bson:"bookId" json:"bookId" validate:"required"`       // 书籍ID
    UserID    string    `bson:"userId" json:"userId" validate:"required"`       // 用户ID
    Rating    float64   `bson:"rating" json:"rating" validate:"required,min=0,max=5"` // 评分（0-5星）
    Review    string    `bson:"review,omitempty" json:"review,omitempty"`       // 评论内容
    Tags      []string  `bson:"tags,omitempty" json:"tags,omitempty"`           // 评价标签
    IsHelpful int       `bson:"isHelpful" json:"isHelpful"`                     // 有用数（点赞数）
    CreatedAt time.Time `bson:"createdAt" json:"createdAt"`
    UpdatedAt time.Time `bson:"updatedAt" json:"updatedAt"`
}
```

#### 2.1.2 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| ID | string | 否 | 评分记录唯一标识 |
| BookID | string | 是 | 书籍ID |
| UserID | string | 是 | 用户ID |
| Rating | float64 | 是 | 评分（0-5星，支持0.5间隔） |
| Review | string | 否 | 评论文字内容（可选） |
| Tags | []string | 否 | 评价标签（如：剧情精彩、文笔优美、更新稳定） |
| IsHelpful | int | 否 | 有用数（其他用户点赞数） |
| CreatedAt | time.Time | 是 | 创建时间 |
| UpdatedAt | time.Time | 是 | 更新时间 |

#### 2.1.3 评分规则

```go
// 评分范围：0-5星
const (
    MinRating = 0.0
    MaxRating = 5.0
    RatingStep = 0.5  // 最小间隔0.5星
)

// 评分等级
const (
    RatingPoor      = 1.0  // 差
    RatingFair      = 2.0  // 一般
    RatingGood      = 3.0  // 良好
    RatingVeryGood  = 4.0  // 很好
    RatingExcellent = 5.0  // 优秀
)
```

#### 2.1.4 评价标签

```go
// 预定义评价标签
var PredefinedTags = []string{
    "剧情精彩",
    "文笔优美",
    "人物丰满",
    "世界观宏大",
    "更新稳定",
    "情节紧凑",
    "逻辑严谨",
    "脑洞大开",
    "轻松愉快",
    "感人至深",
    "值得推荐",
}

// 负面标签
var NegativeTags = []string{
    "情节拖沓",
    "人物单薄",
    "更新慢",
    "逻辑混乱",
    "注水严重",
}
```

#### 2.1.5 业务方法

```go
// IsValidRating 验证评分是否有效
func IsValidRating(rating float64) bool {
    if rating < MinRating || rating > MaxRating {
        return false
    }
    // 检查是否是0.5的倍数
    return math.Mod(rating*10, 5) == 0
}

// GetRatingLevel 获取评分等级
func GetRatingLevel(rating float64) string {
    switch {
    case rating >= 4.5:
        return "优秀"
    case rating >= 3.5:
        return "很好"
    case rating >= 2.5:
        return "良好"
    case rating >= 1.5:
        return "一般"
    default:
        return "差"
    }
}

// CanModifyRating 是否可以修改评分（24小时内可修改）
func (r *BookRating) CanModifyRating() bool {
    return time.Since(r.CreatedAt) <= 24*time.Hour
}
```

#### 2.1.6 索引策略

```javascript
// MongoDB索引
db.book_ratings.createIndex({ "bookId": 1, "userId": 1 }, { unique: true })  // 用户对每本书只能评分一次
db.book_ratings.createIndex({ "bookId": 1, "rating": -1 })                    // 按评分查询
db.book_ratings.createIndex({ "userId": 1, "createdAt": -1 })                 // 查询用户的评分历史
db.book_ratings.createIndex({ "createdAt": -1 })                              // 按时间查询最新评分
db.book_ratings.createIndex({ "isHelpful": -1 })                              // 查询最有用的评论
```

---

### 2.2 BookStatistics（书籍统计 - 包含评分统计）

```go
type BookStatistics struct {
    BookID           string    `bson:"_id" json:"bookId"`
    
    // 评分统计
    TotalRatings     int64     `bson:"totalRatings" json:"totalRatings"`         // 总评分数
    AverageRating    float64   `bson:"averageRating" json:"averageRating"`       // 平均评分
    RatingDistribution map[string]int64 `bson:"ratingDistribution" json:"ratingDistribution"` // 评分分布
    
    // 其他统计...
    Reads            int64     `bson:"reads" json:"reads"`
    Favorites        int64     `bson:"favorites" json:"favorites"`
    Comments         int64     `bson:"comments" json:"comments"`
    Revenue          float64   `bson:"revenue" json:"revenue"`
    UpdatedAt        time.Time `bson:"updatedAt" json:"updatedAt"`
}
```

#### 2.2.1 评分分布

```go
// RatingDistribution 评分分布
// 示例: {"5": 100, "4": 80, "3": 30, "2": 10, "1": 5}
type RatingDistribution map[string]int64

// GetDistributionPercent 获取各星级的百分比
func (rd RatingDistribution) GetDistributionPercent() map[string]float64 {
    total := int64(0)
    for _, count := range rd {
        total += count
    }
    
    if total == 0 {
        return make(map[string]float64)
    }
    
    percent := make(map[string]float64)
    for star, count := range rd {
        percent[star] = float64(count) / float64(total) * 100
    }
    
    return percent
}
```

---

## 3. Service层设计

### 3.1 评分业务方法

```go
// RateBook 用户评分书籍
func (s *BookstoreService) RateBook(ctx context.Context, req *RateBookRequest) (*RateBookResponse, error) {
    // 1. 验证评分
    if !IsValidRating(req.Rating) {
        return nil, errors.NewValidationError("评分必须是0-5之间的0.5倍数")
    }
    
    // 2. 检查用户是否已评分
    existingRating, _ := s.ratingRepo.GetByUserAndBook(ctx, req.UserID, req.BookID)
    if existingRating != nil {
        // 已评分，检查是否可以修改
        if !existingRating.CanModifyRating() {
            return nil, errors.NewBusinessError("评分提交后24小时内可修改")
        }
        
        // 更新评分
        return s.updateRating(ctx, existingRating, req)
    }
    
    // 3. 验证用户是否阅读过该书（可选：防止恶意刷分）
    hasRead, _ := s.readingProgressRepo.HasReadBook(ctx, req.UserID, req.BookID)
    if !hasRead {
        return nil, errors.NewBusinessError("请先阅读该书籍后再评分")
    }
    
    // 4. 创建评分
    rating := &BookRating{
        BookID:    req.BookID,
        UserID:    req.UserID,
        Rating:    req.Rating,
        Review:    req.Review,
        Tags:      req.Tags,
        IsHelpful: 0,
        CreatedAt: time.Now(),
        UpdatedAt: time.Now(),
    }
    
    if err := s.ratingRepo.Create(ctx, rating); err != nil {
        return nil, errors.NewInternalError("创建评分失败").WithCause(err)
    }
    
    // 5. 更新书籍统计
    if err := s.updateBookRatingStatistics(ctx, req.BookID); err != nil {
        // 统计更新失败不影响评分创建
        log.Printf("更新评分统计失败: %v", err)
    }
    
    // 6. 发布事件
    event := &base.BaseEvent{
        EventType: "book.rated",
        EventData: map[string]interface{}{
            "book_id": req.BookID,
            "user_id": req.UserID,
            "rating":  req.Rating,
        },
        Timestamp: time.Now(),
        Source:    "BookstoreService",
    }
    s.eventBus.PublishAsync(ctx, event)
    
    // 7. 返回响应
    return &RateBookResponse{
        RatingID:  rating.ID,
        BookID:    rating.BookID,
        Rating:    rating.Rating,
        CreatedAt: rating.CreatedAt,
    }, nil
}

// GetBookRatings 获取书籍的评分列表
func (s *BookstoreService) GetBookRatings(ctx context.Context, bookID string, page, pageSize int) (*GetBookRatingsResponse, error) {
    // 1. 查询评分列表
    ratings, total, err := s.ratingRepo.GetByBookID(ctx, bookID, page, pageSize)
    if err != nil {
        return nil, err
    }
    
    // 2. 获取书籍评分统计
    stats, _ := s.bookStatsRepo.GetByBookID(ctx, bookID)
    
    // 3. 构建响应
    return &GetBookRatingsResponse{
        Ratings:       ratings,
        Total:         total,
        AverageRating: stats.AverageRating,
        TotalRatings:  stats.TotalRatings,
        Distribution:  stats.RatingDistribution,
    }, nil
}

// updateBookRatingStatistics 更新书籍评分统计
func (s *BookstoreService) updateBookRatingStatistics(ctx context.Context, bookID string) error {
    // 1. 聚合计算评分
    pipeline := []bson.M{
        {"$match": bson.M{"bookId": bookID}},
        {"$group": bson.M{
            "_id": "$bookId",
            "totalRatings": bson.M{"$sum": 1},
            "averageRating": bson.M{"$avg": "$rating"},
            "ratings": bson.M{"$push": "$rating"},
        }},
    }
    
    result, err := s.ratingRepo.Aggregate(ctx, pipeline)
    if err != nil {
        return err
    }
    
    // 2. 计算评分分布
    distribution := make(map[string]int64)
    for _, rating := range result.Ratings {
        star := fmt.Sprintf("%.0f", math.Floor(rating))
        distribution[star]++
    }
    
    // 3. 更新统计
    updates := map[string]interface{}{
        "totalRatings":       result.TotalRatings,
        "averageRating":      result.AverageRating,
        "ratingDistribution": distribution,
        "updatedAt":          time.Now(),
    }
    
    return s.bookStatsRepo.Update(ctx, bookID, updates)
}
```

### 3.2 评分验证规则

```go
// ValidateRatingRequest 验证评分请求
func (s *BookstoreService) ValidateRatingRequest(req *RateBookRequest) error {
    // 1. 评分范围验证
    if !IsValidRating(req.Rating) {
        return fmt.Errorf("评分必须在0-5之间，且为0.5的倍数")
    }
    
    // 2. 评论长度验证
    if len(req.Review) > 2000 {
        return fmt.Errorf("评论内容不能超过2000字")
    }
    
    // 3. 标签数量验证
    if len(req.Tags) > 5 {
        return fmt.Errorf("最多选择5个标签")
    }
    
    // 4. 标签有效性验证
    validTags := append(PredefinedTags, NegativeTags...)
    for _, tag := range req.Tags {
        if !contains(validTags, tag) {
            return fmt.Errorf("无效的标签: %s", tag)
        }
    }
    
    return nil
}
```

### 3.3 防刷分机制

```go
// CheckAbuseRating 检查是否存在刷分行为
func (s *BookstoreService) CheckAbuseRating(ctx context.Context, userID string, bookID string) (bool, error) {
    // 1. 检查用户最近评分频率（24小时内不超过10本书）
    count, err := s.ratingRepo.CountUserRatingsInPeriod(ctx, userID, 24*time.Hour)
    if err != nil {
        return false, err
    }
    if count >= 10 {
        return true, nil
    }
    
    // 2. 检查用户是否批量评分（1小时内不超过3本书）
    recentCount, _ := s.ratingRepo.CountUserRatingsInPeriod(ctx, userID, 1*time.Hour)
    if recentCount >= 3 {
        return true, nil
    }
    
    // 3. 检查IP地址是否异常（可选）
    // ...
    
    return false, nil
}
```

---

## 4. 评分展示策略

### 4.1 评分排序

```go
// 默认排序：最有用的评论优先
type RatingSortBy string

const (
    SortByHelpful  RatingSortBy = "helpful"   // 按有用数排序
    SortByRecent   RatingSortBy = "recent"    // 按时间排序
    SortByRating   RatingSortBy = "rating"    // 按评分排序（高分/低分）
)

// GetBookRatingsWithSort 带排序的评分查询
func (s *BookstoreService) GetBookRatingsWithSort(ctx context.Context, bookID string, sortBy RatingSortBy, page, pageSize int) ([]*BookRating, error) {
    switch sortBy {
    case SortByHelpful:
        return s.ratingRepo.GetByBookIDSortByHelpful(ctx, bookID, page, pageSize)
    case SortByRecent:
        return s.ratingRepo.GetByBookIDSortByTime(ctx, bookID, page, pageSize)
    case SortByRating:
        return s.ratingRepo.GetByBookIDSortByRating(ctx, bookID, page, pageSize)
    default:
        return s.ratingRepo.GetByBookID(ctx, bookID, page, pageSize)
    }
}
```

### 4.2 评分过滤

```go
// 只显示有评论内容的评分
func (s *BookstoreService) GetBookRatingsWithReview(ctx context.Context, bookID string, page, pageSize int) ([]*BookRating, error) {
    filter := bson.M{
        "bookId": bookID,
        "review": bson.M{"$ne": ""},  // 评论不为空
    }
    return s.ratingRepo.FindWithFilter(ctx, filter, page, pageSize)
}

// 按星级过滤
func (s *BookstoreService) GetBookRatingsByStar(ctx context.Context, bookID string, star int, page, pageSize int) ([]*BookRating, error) {
    minRating := float64(star)
    maxRating := float64(star + 1)
    
    filter := bson.M{
        "bookId": bookID,
        "rating": bson.M{
            "$gte": minRating,
            "$lt":  maxRating,
        },
    }
    return s.ratingRepo.FindWithFilter(ctx, filter, page, pageSize)
}
```

---

## 5. API设计

### 5.1 请求/响应

```go
// RateBookRequest 评分请求
type RateBookRequest struct {
    BookID string   `json:"bookId" validate:"required"`
    UserID string   `json:"userId" validate:"required"`
    Rating float64  `json:"rating" validate:"required,min=0,max=5"`
    Review string   `json:"review"`
    Tags   []string `json:"tags"`
}

// RateBookResponse 评分响应
type RateBookResponse struct {
    RatingID  string    `json:"ratingId"`
    BookID    string    `json:"bookId"`
    Rating    float64   `json:"rating"`
    CreatedAt time.Time `json:"createdAt"`
}

// GetBookRatingsRequest 获取评分列表请求
type GetBookRatingsRequest struct {
    BookID   string       `json:"bookId" validate:"required"`
    SortBy   RatingSortBy `json:"sortBy"`   // helpful/recent/rating
    StarFilter int        `json:"starFilter"` // 1-5，0表示不过滤
    Page     int          `json:"page"`
    PageSize int          `json:"pageSize"`
}

// GetBookRatingsResponse 获取评分列表响应
type GetBookRatingsResponse struct {
    Ratings       []*BookRating        `json:"ratings"`
    Total         int64                `json:"total"`
    AverageRating float64              `json:"averageRating"`
    TotalRatings  int64                `json:"totalRatings"`
    Distribution  map[string]int64     `json:"distribution"`  // 评分分布
}
```

### 5.2 API路由

```go
// POST /api/v1/books/:bookId/rate - 评分书籍
func (api *BookstoreApi) RateBook(c *gin.Context) {
    bookID := c.Param("bookId")
    userID, _ := c.Get("userId")
    
    var req RateBookRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.Error(c, http.StatusBadRequest, "参数错误", err.Error())
        return
    }
    
    req.BookID = bookID
    req.UserID = userID.(string)
    
    resp, err := api.bookstoreService.RateBook(c.Request.Context(), &req)
    if err != nil {
        api.handleError(c, err)
        return
    }
    
    response.Success(c, http.StatusCreated, "评分成功", resp)
}

// GET /api/v1/books/:bookId/ratings - 获取评分列表
func (api *BookstoreApi) GetBookRatings(c *gin.Context) {
    bookID := c.Param("bookId")
    sortBy := c.DefaultQuery("sortBy", "helpful")
    page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
    pageSize, _ := strconv.Atoi(c.DefaultQuery("pageSize", "20"))
    
    resp, err := api.bookstoreService.GetBookRatings(c.Request.Context(), bookID, page, pageSize)
    if err != nil {
        api.handleError(c, err)
        return
    }
    
    response.Success(c, http.StatusOK, "获取成功", resp)
}

// PUT /api/v1/ratings/:ratingId/helpful - 标记评分有用
func (api *BookstoreApi) MarkRatingHelpful(c *gin.Context) {
    ratingID := c.Param("ratingId")
    userID, _ := c.Get("userId")
    
    err := api.bookstoreService.MarkRatingHelpful(c.Request.Context(), ratingID, userID.(string))
    if err != nil {
        api.handleError(c, err)
        return
    }
    
    response.Success(c, http.StatusOK, "操作成功", nil)
}
```

---

## 6. 与v2.1架构的关系

### 6.1 在整体架构中的位置

```
Reading Module (阅读端)
  └─ Bookstore Module (书城模块)
      └─ Rating System (评分系统)
          ├─ BookRating (评分数据)
          ├─ RatingStatistics (评分统计)
          └─ RatingValidation (评分验证)
```

### 6.2 事件发布

```go
// 书籍被评分事件
type BookRatedEvent struct {
    BookID    string
    UserID    string
    Rating    float64
    HasReview bool
    Timestamp time.Time
}

// 评分统计更新事件
type RatingStatsUpdatedEvent struct {
    BookID        string
    AverageRating float64
    TotalRatings  int64
    Timestamp     time.Time
}
```

---

## 7. 性能优化

### 7.1 评分统计缓存

```go
// 缓存平均评分（1小时）
func (s *BookstoreService) GetCachedAverageRating(ctx context.Context, bookID string) (float64, error) {
    cacheKey := fmt.Sprintf("book:rating:avg:%s", bookID)
    
    // 尝试从缓存获取
    cached, err := s.cache.Get(ctx, cacheKey)
    if err == nil && cached != nil {
        return cached.(float64), nil
    }
    
    // 从数据库查询
    stats, err := s.bookStatsRepo.GetByBookID(ctx, bookID)
    if err != nil {
        return 0, err
    }
    
    // 缓存结果
    s.cache.Set(ctx, cacheKey, stats.AverageRating, 1*time.Hour)
    
    return stats.AverageRating, nil
}
```

### 7.2 异步更新统计

```go
// 评分后异步更新统计，不阻塞响应
func (s *BookstoreService) RateBook(ctx context.Context, req *RateBookRequest) (*RateBookResponse, error) {
    // ... 创建评分 ...
    
    // 异步更新统计
    go s.updateBookRatingStatistics(context.Background(), req.BookID)
    
    return resp, nil
}
```

---

## 8. 实现参考

### 8.1 代码文件路径

- **数据模型**: `models/reading/bookstore/book_rating.go`
- **统计模型**: `models/reading/bookstore/book_statistics.go`
- **Service**: `service/bookstore/bookstore_service.go`
- **Repository**: `repository/mongodb/bookstore/book_rating_mongo.go`
- **API**: `api/v1/reading/book_rating_api.go`

### 8.2 关键实现特性

1. ✅ 0-5星评分系统，支持0.5间隔
2. ✅ 用户每本书只能评分一次
3. ✅ 24小时内可修改评分
4. ✅ 评分分布统计
5. ✅ 评论有用数（点赞）
6. ✅ 防刷分机制
7. ✅ 异步统计更新

---

**文档状态**: ✅ 已完成  
**最后审核**: 2025-10-21  
**优先级**: P0 - 核心业务功能

