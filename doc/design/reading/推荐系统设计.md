# 推荐系统设计

> **架构说明**: 本文档基于**模块化单体架构**设计。
> 
> - ✅ 当前采用单一代码库，统一部署
> - ✅ 通过模块化保持清晰边界
> - ✅ 为未来可能的微服务化预留空间
> 
> 参考：[微服务架构划分建议](../微服务架构划分建议.md)

## 1. 需求概述

### 1.1 功能描述
推荐系统是青羽阅读平台的智能引擎，通过分析用户行为、内容特征和协同过滤算法，为用户提供个性化的书籍推荐。系统支持实时推荐、离线计算、多维度推荐策略，提升用户发现优质内容的效率。

### 1.2 业务价值
- **用户体验**：精准推荐提升用户满意度和平台粘性
- **内容分发**：帮助优质内容获得更多曝光和阅读量
- **商业转化**：提升付费内容的转化率和用户价值
- **数据驱动**：基于数据分析优化推荐策略和效果

### 1.3 用户场景
- **首页推荐**：用户打开应用时看到个性化推荐的书籍列表
- **相似推荐**：用户阅读某本书时推荐相似的书籍
- **兴趣发现**：基于用户历史行为推荐新的兴趣领域
- **热门推荐**：结合热度和个人偏好的综合推荐

### 1.4 功能边界
- **包含功能**：个性化推荐、协同过滤、内容推荐、热度推荐、实时计算
- **不包含功能**：内容生产（由写作端提供）、用户管理（由用户系统提供）

## 2. 架构设计

### 2.1 整体架构

**当前架构：模块化单体**

```
┌─────────────────────────────────────────────┐
│          Gin HTTP Server (主应用)           │
├─────────────────────────────────────────────┤
│         推荐模块 (Recommendation Module)     │
│  ┌───────────────────────────────────────┐  │
│  │  实时推荐服务 (Real-time Service)     │  │
│  │  ├── 策略融合                         │  │
│  │  ├── 结果排序                         │  │
│  │  └── 缓存管理                         │  │
│  └───────────────────────────────────────┘  │
│  ┌───────────────────────────────────────┐  │
│  │  算法引擎 (Algorithm Engine)          │  │
│  │  ├── 协同过滤                         │  │
│  │  ├── 内容推荐                         │  │
│  │  └── 混合策略                         │  │
│  └───────────────────────────────────────┘  │
│  ┌───────────────────────────────────────┐  │
│  │  数据处理 (Data Processing)           │  │
│  │  ├── 特征工程                         │  │
│  │  ├── 用户画像                         │  │
│  │  └── 离线计算                         │  │
│  └───────────────────────────────────────┘  │
├─────────────────────────────────────────────┤
│             Repository Layer                │
│  UserBehaviorRepo + ItemRepo + ProfileRepo  │
├─────────────────────────────────────────────┤
│              Data Layer                     │
│  MongoDB (行为/特征) + Redis (缓存/画像)     │
└─────────────────────────────────────────────┘
```

**架构说明**：
- 推荐系统作为主应用的一个模块
- 算法在应用内运行，无需独立服务
- 离线计算可使用定时任务或异步处理
- Redis 缓存推荐结果和用户画像

### 2.2 模块划分
- **实时推荐**：在线推荐服务、缓存管理、A/B测试
- **离线计算**：模型训练、特征计算、批量推荐
- **算法引擎**：协同过滤、内容推荐、深度学习模型
- **数据管道**：行为收集、特征提取、效果评估

## 3. 详细设计

### 3.1 Router层设计
- **路由分组**：/api/v1/recommendation
- **中间件**：认证中间件（可选）、限流中间件、日志中间件
- **路径规范**：RESTful风格，支持用户ID和推荐类型参数
- **参数处理**：用户ID、推荐数量、推荐类型、过滤条件

### 3.2 API层设计
- **接口定义**：个性化推荐、相似推荐、热门推荐、分类推荐
- **请求验证**：用户身份验证、参数有效性验证、频率限制
- **响应格式**：统一JSON格式，包含推荐理由和置信度
- **错误处理**：算法异常、数据不足、服务降级处理

### 3.3 Service层设计
- **业务流程**：推荐策略选择、结果融合、去重排序
- **数据处理**：用户画像构建、物品特征提取、相似度计算
- **依赖服务**：用户服务、书籍服务、行为分析服务
- **异常处理**：算法失效降级、冷启动处理、实时性保证
- **Repository交互**：通过Repository接口获取用户行为和物品数据

### 3.4 Repository层设计
- **接口抽象**：定义UserBehaviorRepository和ItemRepository接口
- **查询封装**：用户行为查询、物品特征查询、相似度查询
- **事务管理**：行为数据写入事务、推荐结果缓存事务
- **缓存策略**：用户画像缓存、推荐结果缓存、模型参数缓存
- **异常处理**：数据库异常处理、缓存失效处理
- **与Model关系**：行为模型和推荐模型的数据映射

### 3.5 Model层设计
- **数据模型**：UserBehavior、ItemFeature、RecommendationResult等实体
- **约束规则**：行为数据完整性、特征值范围、推荐结果有效性
- **验证逻辑**：数据质量验证、模型输出验证、业务规则验证
- **Repository接口**：定义数据访问和算法计算的接口方法

## 4. 数据设计

### 4.1 数据模型

#### 4.1.1 用户行为模型 (UserBehavior)
```go
type UserBehavior struct {
    ID          string    json:"_id,omitempty" json:"id"
    UserID      string    json:"user_id" json:"userId"            // 用户ID
    ItemID      string    json:"item_id" json:"itemId"            // 物品ID（书籍ID）
    BehaviorType int      json:"behavior_type" json:"behaviorType" // 行为类型：1-浏览，2-收藏，3-阅读，4-评分，5-分享
    Score       float64   json:"score" json:"score"               // 行为分数
    Duration    int64     json:"duration" json:"duration"         // 持续时长（秒）
    Context     string    json:"context" json:"context"           // 上下文信息
    Timestamp   time.Time json:"timestamp" json:"timestamp"       // 行为时间
    CreatedAt   time.Time json:"created_at" json:"createdAt"
}
```

#### 4.1.2 物品特征模型 (ItemFeature)
```go
type ItemFeature struct {
    ID          string            json:"_id,omitempty" json:"id"
    ItemID      string            json:"item_id" json:"itemId"        // 物品ID
    CategoryID  string            json:"category_id" json:"categoryId" // 分类ID
    Tags        []string          json:"tags" json:"tags"             // 标签列表
    Features    map[string]float64 json:"features" json:"features"     // 特征向量
    Embedding   []float64         json:"embedding" json:"embedding"   // 嵌入向量
    Popularity  float64           json:"popularity" json:"popularity"  // 热度分数
    Quality     float64           json:"quality" json:"quality"       // 质量分数
    CreatedAt   time.Time         json:"created_at" json:"createdAt"
    UpdatedAt   time.Time         json:"updated_at" json:"updatedAt"
}
```

#### 4.1.3 用户画像模型 (UserProfile)
```go
type UserProfile struct {
    ID            string            json:"_id,omitempty" json:"id"
    UserID        string            json:"user_id" json:"userId"          // 用户ID
    Preferences   map[string]float64 json:"preferences" json:"preferences" // 偏好特征
    Categories    map[string]float64 json:"categories" json:"categories"   // 分类偏好
    Tags          map[string]float64 json:"tags" json:"tags"               // 标签偏好
    ReadingHabits map[string]interface{} json:"reading_habits" json:"readingHabits" // 阅读习惯
    ActiveTime    []int             json:"active_time" json:"activeTime"  // 活跃时段
    LastUpdate    time.Time         json:"last_update" json:"lastUpdate"  // 最后更新时间
    CreatedAt     time.Time         json:"created_at" json:"createdAt"
    UpdatedAt     time.Time         json:"updated_at" json:"updatedAt"
}
```

#### 4.1.4 推荐结果模型 (RecommendationResult)
```go
type RecommendationResult struct {
    ID          string    json:"_id,omitempty" json:"id"
    UserID      string    json:"user_id" json:"userId"            // 用户ID
    ItemID      string    json:"item_id" json:"itemId"            // 推荐物品ID
    Algorithm   string    json:"algorithm" json:"algorithm"       // 推荐算法
    Score       float64   json:"score" json:"score"               // 推荐分数
    Reason      string    json:"reason" json:"reason"             // 推荐理由
    Position    int       json:"position" json:"position"         // 推荐位置
    Context     string    json:"context" json:"context"           // 推荐上下文
    IsClicked   bool      json:"is_clicked" json:"isClicked"      // 是否点击
    IsRead      bool      json:"is_read" json:"isRead"            // 是否阅读
    CreatedAt   time.Time json:"created_at" json:"createdAt"
    UpdatedAt   time.Time json:"updated_at" json:"updatedAt"
}
```

### 4.2 数据关系
- **用户-行为**：一对多关系，一个用户有多个行为记录
- **物品-特征**：一对一关系，每个物品有一套特征
- **用户-画像**：一对一关系，每个用户有一个画像
- **推荐-结果**：多对多关系，用户和物品的推荐关系

### 4.3 索引策略
| 集合名称 | 索引字段 | 索引类型 | 说明 |
|---------|---------|---------|------|
| user_behaviors | user_id, timestamp | compound | 用户行为时序查询 |
| user_behaviors | item_id, behavior_type | compound | 物品行为统计查询 |
| item_features | item_id | unique | 物品特征唯一索引 |
| user_profiles | user_id | unique | 用户画像唯一索引 |
| recommendation_results | user_id, created_at | compound | 用户推荐历史查询 |
| recommendation_results | item_id | normal | 物品推荐统计查询 |

### 4.4 数据迁移
- **版本1.0**：基础行为数据、物品特征数据结构
- **版本1.1**：增加用户画像、推荐结果跟踪
- **版本1.2**：增加深度学习特征、实时更新机制

## 5. 接口设计

### 5.1 API概览

| 方法 | 路径 | 功能描述 | 权限要求 |
|-----|------|---------|---------|
| GET | /api/v1/recommendation/personal | 个性化推荐 | 登录用户 |
| GET | /api/v1/recommendation/similar/:itemId | 相似物品推荐 | 无 |
| GET | /api/v1/recommendation/hot | 热门推荐 | 无 |
| GET | /api/v1/recommendation/category/:categoryId | 分类推荐 | 无 |
| POST | /api/v1/recommendation/feedback | 推荐反馈 | 登录用户 |
| POST | /api/v1/recommendation/behavior | 行为上报 | 登录用户 |

### 5.2 请求与响应格式

#### 5.2.1 个性化推荐 (GET /api/v1/recommendation/personal)

**请求参数**:
```json
{
  "count": 20,
  "scene": "homepage",
  "excludeRead": true
}
```

**响应格式**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "recommendations": [
      {
        "itemId": "book_id",
        "title": "书名",
        "author": "作者",
        "cover": "封面URL",
        "score": 0.95,
        "reason": "因为你喜欢玄幻小说",
        "algorithm": "collaborative_filtering"
      }
    ],
    "total": 20,
    "requestId": "req_12345"
  }
}
```

#### 5.2.2 相似物品推荐 (GET /api/v1/recommendation/similar/:itemId)

**请求参数**:
- itemId (path): 物品ID
- count (query): 推荐数量，默认10

**响应格式**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "recommendations": [
      {
        "itemId": "similar_book_id",
        "title": "相似书名",
        "similarity": 0.85,
        "reason": "读者也喜欢"
      }
    ]
  }
}
```

#### 5.2.3 行为上报 (POST /api/v1/recommendation/behavior)

**请求参数**:
```json
{
  "itemId": "book_id",
  "behaviorType": 3,
  "score": 1.0,
  "duration": 300,
  "context": "homepage_recommendation"
}
```

**响应格式**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "recorded": true
  }
}
```

**状态码**:
- 200: 成功
- 400: 请求参数错误
- 401: 未登录
- 429: 请求频率过高
- 500: 服务器错误

## 6. 算法设计

### 6.1 协同过滤算法

#### 6.1.1 用户协同过滤 (User-Based CF)
- **相似度计算**：使用余弦相似度计算用户间相似性
- **邻居选择**：选择Top-K相似用户作为邻居
- **评分预测**：基于邻居用户的评分预测目标用户偏好
- **适用场景**：用户数量相对较少，用户行为丰富

#### 6.1.2 物品协同过滤 (Item-Based CF)
- **相似度计算**：基于用户行为计算物品间相似性
- **相似物品**：为每个物品计算最相似的物品列表
- **推荐生成**：基于用户历史行为和物品相似性生成推荐
- **适用场景**：物品数量相对稳定，用户行为稀疏

### 6.2 内容推荐算法

#### 6.2.1 基于标签的推荐
- **标签提取**：从书籍描述中提取关键标签
- **用户画像**：基于用户行为构建标签偏好画像
- **相似度匹配**：计算用户画像与物品标签的匹配度
- **推荐排序**：按匹配度排序生成推荐列表

#### 6.2.2 基于内容特征的推荐
- **特征工程**：提取书籍的文本特征、统计特征
- **向量化表示**：将书籍和用户转换为向量表示
- **相似度计算**：使用向量相似度进行推荐
- **深度学习**：使用神经网络学习更复杂的特征表示

### 6.3 混合推荐策略

#### 6.3.1 加权融合
- **算法权重**：为不同算法分配权重
- **动态调整**：根据用户类型和场景动态调整权重
- **效果评估**：通过A/B测试优化权重配置

#### 6.3.2 分层推荐
- **召回层**：使用多种算法召回候选物品
- **排序层**：使用机器学习模型对候选物品排序
- **过滤层**：应用业务规则和多样性约束

## 7. 实时计算架构

### 7.1 流式处理
- **数据流**：Kafka接收用户行为数据流
- **实时计算**：Flink处理实时行为数据
- **增量更新**：实时更新用户画像和推荐结果
- **低延迟**：保证推荐结果的实时性

### 7.2 缓存策略
- **多级缓存**：Redis + 本地缓存的多级缓存架构
- **预计算**：离线预计算热门推荐结果
- **缓存更新**：基于用户行为触发缓存更新
- **缓存穿透**：使用布隆过滤器防止缓存穿透

### 7.3 A/B测试框架
- **实验设计**：支持多种推荐算法的A/B测试
- **流量分配**：按用户ID进行流量分配
- **效果评估**：实时监控各算法的效果指标
- **自动优化**：基于效果自动调整算法权重

## 8. 离线计算架构

### 8.1 批处理流程
- **数据ETL**：从各数据源提取、转换、加载数据
- **特征工程**：批量计算用户和物品特征
- **模型训练**：使用Spark MLlib训练推荐模型
- **结果生成**：批量生成推荐结果并存储

### 8.2 模型训练
- **数据准备**：清洗和预处理训练数据
- **特征选择**：选择有效的特征进行模型训练
- **模型评估**：使用交叉验证评估模型效果
- **模型部署**：将训练好的模型部署到线上服务

### 8.3 效果评估
- **离线评估**：使用历史数据评估算法效果
- **在线评估**：通过A/B测试评估实际效果
- **业务指标**：点击率、转化率、用户满意度等
- **技术指标**：准确率、召回率、覆盖率、多样性等

## 9. 安全设计

### 9.1 数据安全
- **隐私保护**：用户行为数据脱敏和匿名化处理
- **数据加密**：敏感数据加密存储和传输
- **访问控制**：严格控制推荐数据的访问权限

### 9.2 算法安全
- **防刷机制**：检测和防止恶意刷行为数据
- **公平性**：避免算法偏见和歧视
- **透明性**：提供推荐理由增加算法透明度

### 9.3 系统安全
- **限流保护**：防止恶意请求影响系统稳定性
- **异常检测**：监控异常推荐请求和行为
- **降级机制**：在系统异常时提供基础推荐服务

## 10. 性能优化

### 10.1 计算优化
- **并行计算**：使用多线程和分布式计算提升性能
- **算法优化**：优化算法复杂度和计算效率
- **增量计算**：只计算变化的部分，避免全量计算
- **预计算**：提前计算常用的推荐结果

### 10.2 存储优化
- **数据分区**：按用户或时间分区存储数据
- **索引优化**：为常用查询建立合适的索引
- **数据压缩**：压缩存储减少空间占用
- **冷热分离**：将热数据和冷数据分别存储

### 10.3 网络优化
- **CDN加速**：使用CDN加速推荐结果分发
- **数据压缩**：压缩网络传输数据
- **连接池**：使用连接池减少连接开销
- **异步处理**：使用异步处理提升响应速度

## 11. 监控和运维

### 11.1 监控指标
- **业务指标**：推荐点击率、转化率、用户满意度
- **技术指标**：API响应时间、算法准确率、系统吞吐量
- **资源指标**：CPU使用率、内存使用率、磁盘IO

### 11.2 告警机制
- **阈值告警**：关键指标超过阈值时触发告警
- **异常检测**：使用机器学习检测异常模式
- **自动恢复**：在可能的情况下自动恢复服务

### 11.3 日志分析
- **推荐日志**：记录推荐请求和结果
- **行为日志**：记录用户行为和反馈
- **性能日志**：记录系统性能和瓶颈

## 12. 实施计划

### 12.1 开发阶段
- **第1-2周**：基础架构搭建、数据模型设计
- **第3-4周**：协同过滤算法实现
- **第5-6周**：内容推荐算法实现
- **第7-8周**：实时计算和缓存系统
- **第9-10周**：A/B测试框架和效果评估
- **第11-12周**：性能优化和系统测试

### 12.2 测试阶段
- **算法测试**：验证各推荐算法的准确性
- **性能测试**：测试系统的并发处理能力
- **A/B测试**：对比不同算法的实际效果
- **用户测试**：收集真实用户的使用反馈

### 12.3 上线计划
- **灰度发布**：先对部分用户开放推荐功能
- **效果监控**：密切监控推荐效果和系统性能
- **持续优化**：根据数据反馈持续优化算法
- **全量发布**：稳定后向所有用户开放
