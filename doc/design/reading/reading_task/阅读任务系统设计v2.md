# é˜…è¯»ä»»åŠ¡ç³»ç»Ÿè®¾è®¡ v2.0

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
> **åˆ›å»ºæ—¶é—´**: 2025-10-21  
> **æ›´æ–°**: é‡æ–°è®¾è®¡èŒè´£è¾¹ç•Œï¼Œå¼ºè°ƒäº‹ä»¶å‘å¸ƒ

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£é‡æ–°è®¾è®¡é˜…è¯»ä»»åŠ¡ç³»ç»Ÿï¼Œæ˜ç¡®å…¶èŒè´£ä¸ºä»»åŠ¡æµç¨‹ç®¡ç†å’Œå¥–åŠ±è§¦å‘ï¼Œä¸ç›´æ¥ä¿®æ”¹ç”¨æˆ·ä½™é¢å’Œç»éªŒå€¼ã€‚

---

## ä¸€ã€æ¨¡å—èŒè´£

### 1.1 Reading TaskèŒè´£

**è´Ÿè´£**ï¼š
- âœ… ä»»åŠ¡å®šä¹‰ä¸é…ç½®
- âœ… ä»»åŠ¡è¿›åº¦è¿½è¸ª
- âœ… ä»»åŠ¡å®Œæˆåˆ¤å®š
- âœ… è§¦å‘å¥–åŠ±äº‹ä»¶ï¼ˆå‘å¸ƒäº‹ä»¶ï¼‰

**ä¸è´Ÿè´£**ï¼š
- âŒ ç›´æ¥ä¿®æ”¹ç”¨æˆ·ç»éªŒå€¼
- âŒ ç›´æ¥ä¿®æ”¹ç”¨æˆ·ä»£å¸ä½™é¢
- âŒ ç­‰çº§è®¡ç®—
- âŒ æˆå°±è§£é”

### 1.2 ä¸å…¶ä»–æ¨¡å—åä½œ

```
Reading Task
  â”œâ”€ æ£€æµ‹ä»»åŠ¡å®Œæˆ
  â”œâ”€ å‘å¸ƒTaskCompletedEvent â”€â”€â”
  â””â”€                           â”‚
                               â”œâ”€â”€> User Level Service
                               â”‚      â””â”€ å¢åŠ ç»éªŒå€¼
                               â”‚      â””â”€ æ£€æŸ¥å‡çº§
                               â”‚
                               â””â”€â”€> Wallet Service
                                      â””â”€ å¢åŠ ä»£å¸
```

---

## äºŒã€æ•°æ®æ¨¡å‹

### 2.1 Task (ä»»åŠ¡å®šä¹‰)

```go
type Task struct {
    ID           string    `bson:"_id" json:"id"`
    Type         string    `bson:"type" json:"type"` // daily, weekly, achievement
    Title        string    `bson:"title" json:"title"`
    Description  string    `bson:"description" json:"description"`
    Target       int       `bson:"target" json:"target"` // ç›®æ ‡å€¼
    RewardExp    int       `bson:"reward_exp" json:"rewardExp"` // å¥–åŠ±ç»éªŒå€¼
    RewardTokens int64     `bson:"reward_tokens" json:"rewardTokens"` // å¥–åŠ±ä»£å¸
    Status       string    `bson:"status" json:"status"` // active, inactive
    CreatedAt    time.Time `bson:"created_at" json:"createdAt"`
}
```

### 2.2 TaskProgress (ä»»åŠ¡è¿›åº¦)

```go
type TaskProgress struct {
    ID        string    `bson:"_id" json:"id"`
    UserID    string    `bson:"user_id" json:"userId"`
    TaskID    string    `bson:"task_id" json:"taskId"`
    Current   int       `bson:"current" json:"current"` // å½“å‰è¿›åº¦
    Completed bool      `bson:"completed" json:"completed"`
    UpdatedAt time.Time `bson:"updated_at" json:"updatedAt"`
}
```

---

## ä¸‰ã€Serviceæ¥å£

```go
package reading

type ReadingTaskService interface {
    base.BaseService
    
    // ä»»åŠ¡ç®¡ç†
    GetTask(ctx context.Context, taskID string) (*Task, error)
    ListUserTasks(ctx context.Context, userID string) ([]*Task, error)
    
    // è¿›åº¦ç®¡ç†
    UpdateProgress(ctx context.Context, userID, taskID string, increment int) error
    GetTaskProgress(ctx context.Context, userID, taskID string) (*TaskProgress, error)
    
    // å®Œæˆåˆ¤å®š
    CheckTaskCompletion(ctx context.Context, userID, taskID string) (bool, error)
    
    // äº‹ä»¶å¤„ç†
    OnUserBehavior(ctx context.Context, event *UserBehaviorEvent) error
}
```

---

## å››ã€äº‹ä»¶å‘å¸ƒ

### 4.1 TaskCompletedEvent

```go
type TaskCompletedEvent struct {
    TaskID       string    `json:"taskId"`
    UserID       string    `json:"userId"`
    TaskType     string    `json:"taskType"`
    RewardExp    int       `json:"rewardExp"` // å¥–åŠ±ç»éªŒå€¼
    RewardTokens int64     `json:"rewardTokens"` // å¥–åŠ±ä»£å¸
    CompletedAt  time.Time `json:"completedAt"`
}
```

### 4.2 å‘å¸ƒäº‹ä»¶å®ç°

```go
func (s *ReadingTaskServiceImpl) CheckTaskCompletion(ctx context.Context, userID, taskID string) (bool, error) {
    task, _ := s.taskRepo.GetByID(ctx, taskID)
    progress, _ := s.progressRepo.GetProgress(ctx, userID, taskID)
    
    if progress.Current >= task.Target {
        // å‘å¸ƒä»»åŠ¡å®Œæˆäº‹ä»¶ï¼ˆä¸ç›´æ¥ä¿®æ”¹ä½™é¢ï¼‰
        event := &TaskCompletedEvent{
            TaskID:       taskID,
            UserID:       userID,
            TaskType:     task.Type,
            RewardExp:    task.RewardExp,
            RewardTokens: task.RewardTokens,
            CompletedAt:  time.Now(),
        }
        
        s.eventBus.PublishAsync(ctx, event)
        
        // æ ‡è®°ä»»åŠ¡å·²å®Œæˆ
        progress.Completed = true
        s.progressRepo.Update(ctx, progress)
        
        return true, nil
    }
    
    return false, nil
}
```

---

## äº”ã€ä»»åŠ¡ç¤ºä¾‹

### 5.1 æ¯æ—¥ä»»åŠ¡

| ä»»åŠ¡ | ç›®æ ‡ | ç»éªŒå€¼å¥–åŠ± | ä»£å¸å¥–åŠ± |
|------|------|-----------|---------|
| æ¯æ—¥é˜…è¯» | é˜…è¯»30åˆ†é’Ÿ | 50 | 10 |
| è¿ç»­ç­¾åˆ° | è¿ç»­7å¤© | 100 | 20 |
| è¯„è®ºäº’åŠ¨ | å‘è¡¨3æ¡è¯„è®º | 30 | 5 |

### 5.2 æˆå°±ä»»åŠ¡

| æˆå°± | æ¡ä»¶ | ç»éªŒå€¼å¥–åŠ± | ä»£å¸å¥–åŠ± |
|------|------|-----------|---------|
| é˜…è¯»è¾¾äºº | ç´¯è®¡é˜…è¯»100å°æ—¶ | 500 | 100 |
| ä¹¦è™« | é˜…è¯»100æœ¬ä¹¦ | 1000 | 200 |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**åˆ›å»ºæ—¶é—´**: 2025-10-21

