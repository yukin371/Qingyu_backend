# 阅读任务系统设计 v2.0

> **文档版本**: v2.0  
> **创建时间**: 2025-10-21  
> **更新**: 重新设计职责边界，强调事件发布

## 📋 文档概述

本文档重新设计阅读任务系统，明确其职责为任务流程管理和奖励触发，不直接修改用户余额和经验值。

---

## 一、模块职责

### 1.1 Reading Task职责

**负责**：
- ✅ 任务定义与配置
- ✅ 任务进度追踪
- ✅ 任务完成判定
- ✅ 触发奖励事件（发布事件）

**不负责**：
- ❌ 直接修改用户经验值
- ❌ 直接修改用户代币余额
- ❌ 等级计算
- ❌ 成就解锁

### 1.2 与其他模块协作

```
Reading Task
  ├─ 检测任务完成
  ├─ 发布TaskCompletedEvent ──┐
  └─                           │
                               ├──> User Level Service
                               │      └─ 增加经验值
                               │      └─ 检查升级
                               │
                               └──> Wallet Service
                                      └─ 增加代币
```

---

## 二、数据模型

### 2.1 Task (任务定义)

```go
type Task struct {
    ID           string    `bson:"_id" json:"id"`
    Type         string    `bson:"type" json:"type"` // daily, weekly, achievement
    Title        string    `bson:"title" json:"title"`
    Description  string    `bson:"description" json:"description"`
    Target       int       `bson:"target" json:"target"` // 目标值
    RewardExp    int       `bson:"reward_exp" json:"rewardExp"` // 奖励经验值
    RewardTokens int64     `bson:"reward_tokens" json:"rewardTokens"` // 奖励代币
    Status       string    `bson:"status" json:"status"` // active, inactive
    CreatedAt    time.Time `bson:"created_at" json:"createdAt"`
}
```

### 2.2 TaskProgress (任务进度)

```go
type TaskProgress struct {
    ID        string    `bson:"_id" json:"id"`
    UserID    string    `bson:"user_id" json:"userId"`
    TaskID    string    `bson:"task_id" json:"taskId"`
    Current   int       `bson:"current" json:"current"` // 当前进度
    Completed bool      `bson:"completed" json:"completed"`
    UpdatedAt time.Time `bson:"updated_at" json:"updatedAt"`
}
```

---

## 三、Service接口

```go
package reading

type ReadingTaskService interface {
    base.BaseService
    
    // 任务管理
    GetTask(ctx context.Context, taskID string) (*Task, error)
    ListUserTasks(ctx context.Context, userID string) ([]*Task, error)
    
    // 进度管理
    UpdateProgress(ctx context.Context, userID, taskID string, increment int) error
    GetTaskProgress(ctx context.Context, userID, taskID string) (*TaskProgress, error)
    
    // 完成判定
    CheckTaskCompletion(ctx context.Context, userID, taskID string) (bool, error)
    
    // 事件处理
    OnUserBehavior(ctx context.Context, event *UserBehaviorEvent) error
}
```

---

## 四、事件发布

### 4.1 TaskCompletedEvent

```go
type TaskCompletedEvent struct {
    TaskID       string    `json:"taskId"`
    UserID       string    `json:"userId"`
    TaskType     string    `json:"taskType"`
    RewardExp    int       `json:"rewardExp"` // 奖励经验值
    RewardTokens int64     `json:"rewardTokens"` // 奖励代币
    CompletedAt  time.Time `json:"completedAt"`
}
```

### 4.2 发布事件实现

```go
func (s *ReadingTaskServiceImpl) CheckTaskCompletion(ctx context.Context, userID, taskID string) (bool, error) {
    task, _ := s.taskRepo.GetByID(ctx, taskID)
    progress, _ := s.progressRepo.GetProgress(ctx, userID, taskID)
    
    if progress.Current >= task.Target {
        // 发布任务完成事件（不直接修改余额）
        event := &TaskCompletedEvent{
            TaskID:       taskID,
            UserID:       userID,
            TaskType:     task.Type,
            RewardExp:    task.RewardExp,
            RewardTokens: task.RewardTokens,
            CompletedAt:  time.Now(),
        }
        
        s.eventBus.PublishAsync(ctx, event)
        
        // 标记任务已完成
        progress.Completed = true
        s.progressRepo.Update(ctx, progress)
        
        return true, nil
    }
    
    return false, nil
}
```

---

## 五、任务示例

### 5.1 每日任务

| 任务 | 目标 | 经验值奖励 | 代币奖励 |
|------|------|-----------|---------|
| 每日阅读 | 阅读30分钟 | 50 | 10 |
| 连续签到 | 连续7天 | 100 | 20 |
| 评论互动 | 发表3条评论 | 30 | 5 |

### 5.2 成就任务

| 成就 | 条件 | 经验值奖励 | 代币奖励 |
|------|------|-----------|---------|
| 阅读达人 | 累计阅读100小时 | 500 | 100 |
| 书虫 | 阅读100本书 | 1000 | 200 |

---

**文档版本**: v2.0  
**创建时间**: 2025-10-21

