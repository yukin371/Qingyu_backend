# 社交功能设计

> **架构说明**: 本文档基于**模块化单体架构**设计。
> 
> - ✅ 当前采用单一代码库，统一部署
> - ✅ 通过模块化保持清晰边界
> - ✅ 为未来可能的微服务化预留空间
> 
> 参考：[微服务架构划分建议](../微服务架构划分建议.md)

## 1. 需求概述

### 1.1 功能描述

社交功能是青羽阅读平台的互动核心，为用户提供围绕阅读内容的社交体验。系统支持段评互动、书圈讨论、用户关注等功能，构建以书籍为纽带的阅读社区，提升用户参与度和平台粘性。

### 1.2 业务价值

- **用户粘性**：社交互动增强用户对平台的依赖和活跃度
- **内容价值**：用户生成内容丰富书籍的价值和吸引力
- **社区氛围**：良好的社区氛围提升用户体验和口碑传播
- **数据洞察**：社交数据为内容推荐和运营决策提供依据

### 1.3 用户场景

- **段评互动**：用户在阅读过程中对精彩片段发表评论和互动
- **书圈讨论**：用户在书籍专属圈子中讨论剧情、角色、感想
- **用户关注**：用户关注感兴趣的读者，获取其阅读动态
- **内容分享**：用户分享阅读心得、书籍推荐到社交平台

### 1.4 功能边界

- **包含功能**：段评系统、书圈功能、用户关注、内容分享、互动统计
- **不包含功能**：私信聊天（独立IM系统）、直播功能（独立直播系统）

## 2. 架构设计

### 2.1 整体架构
`

   Router层       ← 社交路由、权限验证

   API层           社交接口、内容审核

   Service层     │  社交逻辑、消息推送

   Repository层    社交数据、关系管理

   Model层         评论模型、关系模型

`

### 2.2 模块划分

- **段评模块**：段落评论、点赞互动、评论管理
- **书圈模块**：话题讨论、帖子管理、圈子运营
- **关注模块**：用户关注、粉丝管理、动态推送
- **审核模块**：内容审核、违规处理、举报系统

## 3. 详细设计

### 3.1 Router层设计

- **路由分组**：/api/v1/social
- **中间件**：JWT认证中间件、权限验证中间件、限流中间件
- **路径规范**：RESTful风格，支持嵌套资源路径
- **参数处理**：用户ID、内容ID、分页参数、筛选条件

### 3.2 API层设计

- **接口定义**：段评CRUD、书圈管理、关注关系、互动统计
- **请求验证**：用户身份验证、内容权限验证、频率限制
- **响应格式**：统一JSON格式，包含用户信息和互动数据
- **错误处理**：权限不足、内容违规、频率超限等错误处理

### 3.3 Service层设计

- **业务流程**：内容发布、审核流程、消息通知、统计计算
- **数据处理**：内容格式化、敏感词过滤、关系计算
- **依赖服务**：用户服务、内容审核服务、消息推送服务
- **异常处理**：审核失败、推送异常、数据一致性处理
- **Repository交互**：通过Repository接口管理社交数据和用户关系

### 3.4 Repository层设计

- **接口抽象**：定义CommentRepository和RelationRepository接口
- **查询封装**：评论查询、关系查询、统计查询、分页查询
- **事务管理**：评论发布事务、关注关系事务、统计更新事务
- **缓存策略**：热门评论缓存、用户关系缓存、统计数据缓存
- **异常处理**：数据库异常处理、缓存同步异常处理
- **与Model关系**：评论模型和关系模型的数据映射

### 3.5 Model层设计

- **数据模型**：Comment、BookCircle、UserRelation等社交实体
- **约束规则**：内容长度限制、关系唯一性、状态有效性
- **验证逻辑**：内容格式验证、权限验证、业务规则验证
- **Repository接口**：定义社交数据访问和关系管理的接口方法

## 4. 数据设计

### 4.1 数据模型

#### 4.1.1 段评模型 (Comment)

```go
type Comment struct {
    ID          string    json:"_id,omitempty" json:"id"
    BookID      string    json:"book_id" json:"bookId"            // 书籍ID
    ChapterID   string    json:"chapter_id" json:"chapterId"      // 章节ID
    UserID      string    json:"user_id" json:"userId"            // 用户ID
    Content     string    json:"content" json:"content"           // 评论内容
    StartPos    int       json:"start_pos" json:"startPos"        // 开始位置
    EndPos      int       json:"end_pos" json:"endPos"            // 结束位置
    QuoteText   string    json:"quote_text" json:"quoteText"      // 引用文本
    ParentID    string    json:"parent_id" json:"parentId"        // 父评论ID
    ReplyToID   string    json:"reply_to_id" json:"replyToId"     // 回复目标ID
    LikeCount   int64     json:"like_count" json:"likeCount"      // 点赞数
    ReplyCount  int64     json:"reply_count" json:"replyCount"    // 回复数
    Status      int       json:"status" json:"status"             // 状态：1-正常，2-删除，3-屏蔽
    IsTop       bool      json:"is_top" json:"isTop"              // 是否置顶
    UpdatedAt   time.Time json:"updated_at" json:"updatedAt"
    CreatedAt   time.Time json:"created_at" json:"createdAt"
}
```

#### 4.1.2 书圈模型 (BookCircle)

```go
type BookCircle struct {
    ID          string    json:"_id,omitempty" json:"id"
    BookID      string    json:"book_id" json:"bookId"            // 书籍ID
    Name        string    json:"name" json:"name"                 // 圈子名称
    Description string    json:"description" json:"description"   // 圈子描述
    Avatar      string    json:"avatar" json:"avatar"             // 圈子头像
    MemberCount int64     json:"member_count" json:"memberCount"  // 成员数量
    PostCount   int64     json:"post_count" json:"postCount"      // 帖子数量
    IsOfficial  bool      json:"is_official" json:"isOfficial"    // 是否官方圈子
    Status      int       json:"status" json:"status"             // 状态：1-正常，2-关闭
    CreatedAt   time.Time json:"created_at" json:"createdAt"
    UpdatedAt   time.Time json:"updated_at" json:"updatedAt"
}
```

#### 4.1.3 圈子帖子模型 (CirclePost)

```go
type CirclePost struct {
    ID          string    json:"_id,omitempty" json:"id"
    CircleID    string    json:"circle_id" json:"circleId"        // 圈子ID
    UserID      string    json:"user_id" json:"userId"            // 用户ID
    Title       string    json:"title" json:"title"               // 帖子标题
    Content     string    json:"content" json:"content"           // 帖子内容
    Images      []string  json:"images" json:"images"             // 图片列表
    Type        int       json:"type" json:"type"                 // 类型：1-讨论，2-分享，3-求助
    LikeCount   int64     json:"like_count" json:"likeCount"      // 点赞数
    CommentCount int64    json:"comment_count" json:"commentCount" // 评论数
    ViewCount   int64     json:"view_count" json:"viewCount"      // 浏览数
    IsTop       bool      json:"is_top" json:"isTop"              // 是否置顶
    IsHot       bool      json:"is_hot" json:"isHot"              // 是否热门
    Status      int       json:"status" json:"status"             // 状态：1-正常，2-删除，3-屏蔽
    CreatedAt   time.Time json:"created_at" json:"createdAt"
    UpdatedAt   time.Time json:"updated_at" json:"updatedAt"
}
```

#### 4.1.4 用户关系模型 (UserRelation)

```go
type UserRelation struct {
    ID          string    json:"_id,omitempty" json:"id"
    FollowerID  string    json:"follower_id" json:"followerId"    // 关注者ID
    FolloweeID  string    json:"followee_id" json:"followeeId"    // 被关注者ID
    Status      int       json:"status" json:"status"             // 状态：1-关注，2-取消关注
    CreatedAt   time.Time json:"created_at" json:"createdAt"
    UpdatedAt   time.Time json:"updated_at" json:"updatedAt"
}
```

#### 4.1.5 互动记录模型 (Interaction)

```go
type Interaction struct {
    ID          string    json:"_id,omitempty" json:"id"
    UserID      string    json:"user_id" json:"userId"            // 用户ID
    TargetID    string    json:"target_id" json:"targetId"        // 目标ID
    TargetType  int       json:"target_type" json:"targetType"    // 目标类型：1-评论，2-帖子
    Action      int       json:"action" json:"action"             // 动作：1-点赞，2-收藏，3-分享
    Status      int       json:"status" json:"status"             // 状态：1-有效，2-取消
    CreatedAt   time.Time json:"created_at" json:"createdAt"
    UpdatedAt   time.Time json:"updated_at" json:"updatedAt"
}
```

### 4.2 数据关系

- **评论-章节**：多对一关系，一个章节可以有多个评论
- **评论-用户**：多对一关系，一个用户可以发表多个评论
- **帖子-圈子**：多对一关系，一个圈子包含多个帖子
- **关系-用户**：多对多关系，用户之间的关注关系

### 4.3 索引策略

| 集合名称 | 索引字段 | 索引类型 | 说明 |
|---------|---------|---------|------|
| comments | chapter_id, created_at | compound | 章节评论时序查询 |
| comments | user_id, created_at | compound | 用户评论历史查询 |
| comments | book_id, like_count | compound | 书籍热门评论查询 |
| circle_posts | circle_id, created_at | compound | 圈子帖子时序查询 |
| circle_posts | user_id, created_at | compound | 用户帖子历史查询 |
| user_relations | follower_id, status | compound | 用户关注列表查询 |
| user_relations | followee_id, status | compound | 用户粉丝列表查询 |
| interactions | user_id, target_type | compound | 用户互动记录查询 |

### 4.4 数据迁移

- **版本1.0**：基础评论、帖子、关注数据结构
- **版本1.1**：增加互动统计、热度计算功能
- **版本1.2**：增加内容审核、举报处理功能

## 5. 接口设计

### 5.1 API概览

| 方法 | 路径 | 功能描述 | 权限要求 |
|-----|------|---------|---------|
| GET | /api/v1/social/comments | 获取评论列表 | 无 |
| POST | /api/v1/social/comments | 发表评论 | 登录用户 |
| PUT | /api/v1/social/comments/:id | 修改评论 | 评论作者 |
| DELETE | /api/v1/social/comments/:id | 删除评论 | 评论作者 |
| POST | /api/v1/social/comments/:id/like | 点赞评论 | 登录用户 |
| GET | /api/v1/social/circles/:id | 获取书圈信息 | 无 |
| GET | /api/v1/social/circles/:id/posts | 获取圈子帖子 | 无 |
| POST | /api/v1/social/circles/:id/posts | 发表帖子 | 登录用户 |
| POST | /api/v1/social/follow | 关注用户 | 登录用户 |
| DELETE | /api/v1/social/follow/:userId | 取消关注 | 登录用户 |

### 5.2 请求与响应格式

#### 5.2.1 获取评论列表 (GET /api/v1/social/comments)

**请求参数**:

```json
{
  "chapterId": "chapter_id",
  "sortBy": "like_count",
  "sortOrder": "desc",
  "page": 1,
  "pageSize": 20
}
```

**响应格式**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "comments": [
      {
        "id": "comment_id",
        "content": "评论内容",
        "quoteText": "引用文本",
        "user": {
          "id": "user_id",
          "nickname": "用户昵称",
          "avatar": "头像URL"
        },
        "likeCount": 10,
        "replyCount": 3,
        "isLiked": false,
        "createdAt": "2024-01-01T00:00:00Z",
        "replies": []
      }
    ],
    "total": 100,
    "page": 1,
    "pageSize": 20
  }
}
```

#### 5.2.2 发表评论 (POST /api/v1/social/comments)

**请求参数**:

```json
{
  "chapterId": "chapter_id",
  "content": "评论内容",
  "startPos": 100,
  "endPos": 150,
  "quoteText": "引用的原文",
  "parentId": "parent_comment_id"
}
```

**响应格式**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "new_comment_id",
    "status": "published"
  }
}
```

#### 5.2.3 获取圈子帖子 (GET /api/v1/social/circles/:id/posts)

**请求参数**:

```json
{
  "id": "circle_id",
  "type": "post_type",
  "sortBy": "like_count",
  "page": 1,
  "pageSize": 10
}
```

**响应格式**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "posts": [
      {
        "id": "post_id",
        "title": "帖子标题",
        "content": "帖子内容摘要",
        "images": ["image1.jpg"],
        "user": {
          "id": "user_id",
          "nickname": "用户昵称"
        },
        "likeCount": 20,
        "commentCount": 5,
        "viewCount": 100,
        "isTop": false,
        "createdAt": "2024-01-01T00:00:00Z"
      }
    ],
    "total": 50,
    "page": 1,
    "pageSize": 10
  }
}
```

#### 5.2.4 关注用户 (POST /api/v1/social/follow)

**请求参数**:

```json
{
  "userId": "target_user_id"
}
```

**响应格式**:

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "followed": true,
    "followCount": 101
  }
}
```

**状态码**:

- 200: 成功
- 400: 请求参数错误
- 401: 未登录
- 403: 权限不足
- 429: 操作频率过高
- 500: 服务器错误

## 6. 安全设计

### 6.1 权限控制

- **身份验证**：所有社交操作需要用户登录
- **内容权限**：用户只能修改删除自己的内容
- **管理权限**：管理员可以管理所有社交内容

### 6.2 内容安全

- **敏感词过滤**：自动检测和过滤敏感词汇
- **内容审核**：AI + 人工审核相结合的内容审核机制
- **举报系统**：用户可以举报违规内容，及时处理
- **防刷机制**：防止恶意刷评论、点赞等行为

### 6.3 隐私保护

- **用户隐私**：保护用户个人信息不被泄露
- **关注隐私**：支持私密关注，不公开关注关系
- **内容隐私**：支持评论可见性设置

### 6.4 反垃圾机制

- **频率限制**：限制用户发布内容的频率
- **质量检测**：检测低质量内容和垃圾信息
- **用户信誉**：建立用户信誉体系，限制低信誉用户

## 7. 测试设计

### 7.1 测试策略

- **单元测试**：Service层业务逻辑、Repository层数据访问
- **集成测试**：API接口功能、权限验证、数据一致性
- **性能测试**：高并发评论、大量用户关注、热门内容访问
- **安全测试**：内容审核、权限验证、防刷机制

### 7.2 测试用例

- **正常流程**：评论发布、帖子创建、用户关注、内容互动
- **权限验证**：未登录操作、跨用户操作、管理员权限
- **边界条件**：超长内容、频繁操作、异常参数
- **安全测试**：敏感词检测、恶意内容、刷量行为

### 7.3 性能测试

- **并发能力**：支持1000并发用户同时发表评论
- **响应时间**：评论加载<1s，发布评论<2s
- **数据处理**：支持单章节万级评论的查询和展示

## 8. 部署和运维

### 8.1 部署方案

- **微服务部署**：社交功能独立部署，支持水平扩展
- **数据库集群**：MongoDB副本集，读写分离
- **缓存集群**：Redis集群，缓存热门内容和用户关系
- **消息队列**：Kafka处理异步消息和通知推送

### 8.2 监控指标

- **业务指标**：评论数量、用户活跃度、互动率
- **技术指标**：API响应时间、数据库性能、缓存命中率
- **内容指标**：审核通过率、违规内容比例、用户举报数

### 8.3 日志策略

- **用户行为**：记录用户社交行为和互动数据
- **内容审核**：记录内容审核过程和结果
- **系统性能**：记录系统性能和异常情况

### 8.4 故障处理

- **服务降级**：在高峰期提供基础社交功能
- **数据恢复**：社交数据的备份和恢复机制
- **审核降级**：审核服务异常时的降级策略

## 9. 风险评估

### 9.1 技术风险

- **性能瓶颈**：大量用户同时互动可能导致系统压力
- **数据一致性**：分布式环境下的数据一致性问题
- **缓存失效**：缓存雪崩可能影响社交功能

### 9.2 业务风险

- **内容风险**：违规内容可能带来法律和声誉风险
- **用户流失**：社区氛围差可能导致用户流失
- **恶意行为**：恶意用户可能破坏社区环境

### 9.3 运营风险

- **审核压力**：大量用户生成内容带来审核压力
- **社区管理**：需要专业的社区运营和管理
- **用户纠纷**：用户之间的纠纷需要及时处理

## 10. 实施计划

### 10.1 开发阶段

- **第1周**：数据模型设计、基础架构搭建
- **第2周**：段评系统开发、评论CRUD功能
- **第3周**：书圈系统开发、帖子管理功能
- **第4周**：用户关注系统、关系管理功能
- **第5周**：内容审核系统、安全机制
- **第6周**：性能优化、测试部署

### 10.2 测试阶段

- **功能测试**：核心社交功能验证
- **性能测试**：并发和负载性能测试
- **安全测试**：内容安全和权限验证
- **用户测试**：真实用户社交体验测试

### 10.3 上线计划

- **灰度发布**：先对部分活跃用户开放
- **社区运营**：配备专业的社区运营团队
- **数据监控**：密切监控社交数据和用户反馈
- **持续优化**：根据用户反馈持续优化功能
- **全量发布**：稳定后向所有用户开放
