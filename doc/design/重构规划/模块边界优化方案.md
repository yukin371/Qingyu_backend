# æ¨¡å—è¾¹ç•Œä¼˜åŒ–æ–¹æ¡ˆ

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¶é—´**: 2025-10-21  
> **å®æ–½çŠ¶æ€**: è®¾è®¡é˜¶æ®µ

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†é˜è¿°é’ç¾½å¹³å°æ¶æ„é‡æ„ä¸­çš„æ¨¡å—è¾¹ç•Œä¼˜åŒ–æ–¹æ¡ˆï¼Œæ˜ç¡®å„æ¨¡å—çš„èŒè´£åˆ’åˆ†ï¼Œå®ç°å•ä¸€æ•°æ®æºåŸåˆ™ï¼Œé¿å…èŒè´£ä¸æ¸…å’Œæ•°æ®æºåˆ†æ•£çš„é—®é¢˜ã€‚

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

1. **å•ä¸€æ•°æ®æº**ï¼šæ¯ç§æ ¸å¿ƒæ•°æ®åªæœ‰ä¸€ä¸ªæ¨¡å—è´Ÿè´£ç»´æŠ¤
2. **èŒè´£æ˜ç¡®**ï¼šæ¯ä¸ªæ¨¡å—çš„è¾¹ç•Œæ¸…æ™°ï¼Œä¸å­˜åœ¨èŒè´£é‡å 
3. **äº‹ä»¶é©±åŠ¨**ï¼šè·¨æ¨¡å—é€šä¿¡ä¼˜å…ˆä½¿ç”¨äº‹ä»¶ï¼Œå‡å°‘ç›´æ¥ä¾èµ–
4. **æ•°æ®ä¸€è‡´æ€§**ï¼šé€šè¿‡äº‹ä»¶å’ŒSagaæ¨¡å¼ä¿è¯æ•°æ®æœ€ç»ˆä¸€è‡´æ€§

---

## ä¸€ã€Reading Task vs User Level vs Wallet Service

### 1.1 ç°çŠ¶é—®é¢˜åˆ†æ

**é—®é¢˜æè¿°**ï¼š
- Reading Taskæ¨¡å—åŒ…å«æˆå°±ç³»ç»Ÿå’Œä»£å¸å¥–åŠ±
- User Levelæ¨¡å—ç®¡ç†ç”¨æˆ·ç­‰çº§å’Œç»éªŒå€¼
- Wallet Serviceç®¡ç†ä»£å¸ä½™é¢
- ç”¨æˆ·çŠ¶æ€çš„"å•ä¸€æ•°æ®æº"è¢«åˆ†æ•£åˆ°å¤šä¸ªæ¨¡å—

**å¯¼è‡´çš„é—®é¢˜**ï¼š
- âŒ æ•°æ®ä¸ä¸€è‡´é£é™©ï¼ˆç»éªŒå€¼å’Œä»£å¸å¯èƒ½åœ¨å¤šå¤„è¢«ä¿®æ”¹ï¼‰
- âŒ èŒè´£ä¸æ¸…ï¼ˆå¥–åŠ±å‘æ”¾çš„è´£ä»»ä¸»ä½“ä¸æ˜ç¡®ï¼‰
- âŒ éš¾ä»¥æ‰©å±•ï¼ˆæ–°å¢å¥–åŠ±ç±»å‹éœ€è¦ä¿®æ”¹å¤šä¸ªæ¨¡å—ï¼‰
- âŒ æµ‹è¯•å›°éš¾ï¼ˆéœ€è¦åŒæ—¶Mockå¤šä¸ªæ¨¡å—ï¼‰

### 1.2 ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡

#### æ¨¡å—èŒè´£åˆ’åˆ†

| æ¨¡å— | èŒè´£ | æ•°æ®æ‰€æœ‰æƒ | æ“ä½œæƒé™ |
|------|------|-----------|---------|
| **Reading Task** | â€¢ ä»»åŠ¡å®šä¹‰ä¸é…ç½®<br>â€¢ ä»»åŠ¡è¿›åº¦è¿½è¸ª<br>â€¢ ä»»åŠ¡å®Œæˆåˆ¤å®š<br>â€¢ **è§¦å‘**å¥–åŠ±äº‹ä»¶ | ä»»åŠ¡çŠ¶æ€ã€ä»»åŠ¡è¿›åº¦ | åªè¯»ç”¨æˆ·ç­‰çº§/ä»£å¸ |
| **User Level** | â€¢ ç”¨æˆ·ç­‰çº§ä½“ç³»<br>â€¢ ç»éªŒå€¼è®¡ç®—ä¸ç»´æŠ¤<br>â€¢ å‡çº§é€»è¾‘<br>â€¢ æˆå°±è§£é”<br>â€¢ å‹‹ç« é¢å‘ | ç»éªŒå€¼ï¼ˆå”¯ä¸€ï¼‰<br>ç­‰çº§ã€æˆå°±ã€å‹‹ç«  | å¢å‡ç»éªŒå€¼ |
| **Wallet Service** | â€¢ ä»£å¸ä½™é¢ç®¡ç†<br>â€¢ äº¤æ˜“è®°å½•<br>â€¢ æç°å¤„ç†<br>â€¢ é£æ§æ£€æŸ¥ | ä»£å¸ä½™é¢ï¼ˆå”¯ä¸€ï¼‰<br>äº¤æ˜“è®°å½• | å¢å‡ä»£å¸ |

#### æ•°æ®æµè½¬å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Reading Task Module                        â”‚
â”‚                                                               â”‚
â”‚  1. æ£€æµ‹ä»»åŠ¡å®Œæˆ                                              â”‚
â”‚  2. è®¡ç®—å¥–åŠ±æ•°é‡ï¼ˆç»éªŒå€¼ã€ä»£å¸ï¼‰                              â”‚
â”‚  3. å‘å¸ƒTaskCompletedEvent                                   â”‚
â”‚     {                                                        â”‚
â”‚       taskID: "xxx",                                         â”‚
â”‚       userID: "yyy",                                         â”‚
â”‚       rewardExp: 100,        // å¥–åŠ±ç»éªŒå€¼                    â”‚
â”‚       rewardTokens: 50       // å¥–åŠ±ä»£å¸                      â”‚
â”‚     }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ TaskCompletedEvent
                            â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                                   â”‚
          â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User Level Module  â”‚           â”‚  Wallet Service     â”‚
â”‚                     â”‚           â”‚                     â”‚
â”‚  è®¢é˜…äº‹ä»¶å¤„ç†ï¼š      â”‚           â”‚  è®¢é˜…äº‹ä»¶å¤„ç†ï¼š      â”‚
â”‚  1. å¢åŠ ç»éªŒå€¼      â”‚           â”‚  1. å¢åŠ ä»£å¸        â”‚
â”‚  2. æ£€æŸ¥å‡çº§        â”‚           â”‚  2. è®°å½•äº¤æ˜“        â”‚
â”‚  3. æ£€æŸ¥æˆå°±è§£é”    â”‚           â”‚  3. æ›´æ–°ä½™é¢        â”‚
â”‚                     â”‚           â”‚                     â”‚
â”‚  å‘å¸ƒäº‹ä»¶ï¼š          â”‚           â”‚  å‘å¸ƒäº‹ä»¶ï¼š          â”‚
â”‚  - UserLevelUpEvent â”‚           â”‚  - TokenAddedEvent  â”‚
â”‚  - AchievementEvent â”‚           â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 æ¥å£è®¾è®¡

#### Reading Task Serviceæ¥å£

```go
package reading

import (
    "context"
    "Qingyu_backend/service/base"
)

// ReadingTaskService é˜…è¯»ä»»åŠ¡æœåŠ¡æ¥å£
type ReadingTaskService interface {
    base.BaseService
    
    // ä»»åŠ¡ç®¡ç†
    GetTask(ctx context.Context, taskID string) (*Task, error)
    ListUserTasks(ctx context.Context, userID string) ([]*Task, error)
    
    // è¿›åº¦ç®¡ç†
    UpdateProgress(ctx context.Context, userID, taskID string, progress int) error
    GetTaskProgress(ctx context.Context, userID, taskID string) (*TaskProgress, error)
    
    // å®Œæˆåˆ¤å®š
    CheckTaskCompletion(ctx context.Context, userID, taskID string) (bool, error)
    
    // äº‹ä»¶å¤„ç†æ–¹æ³•ï¼ˆå¼ºåˆ¶å®šä¹‰ï¼‰
    OnTaskCompleted(ctx context.Context, event *TaskCompletedEvent) error
    OnUserBehavior(ctx context.Context, event *UserBehaviorEvent) error
}

// TaskCompletedEvent ä»»åŠ¡å®Œæˆäº‹ä»¶
type TaskCompletedEvent struct {
    TaskID       string `json:"task_id"`
    UserID       string `json:"user_id"`
    TaskType     string `json:"task_type"` // daily, weekly, achievement
    RewardExp    int    `json:"reward_exp"`    // å¥–åŠ±ç»éªŒå€¼
    RewardTokens int64  `json:"reward_tokens"` // å¥–åŠ±ä»£å¸
    CompletedAt  time.Time `json:"completed_at"`
}
```

#### User Level Serviceæ¥å£

```go
package platform

import (
    "context"
    "Qingyu_backend/service/base"
)

// UserLevelService ç”¨æˆ·ç­‰çº§æœåŠ¡æ¥å£
type UserLevelService interface {
    base.BaseService
    
    // ç­‰çº§ç®¡ç†
    GetUserLevel(ctx context.Context, userID string) (*UserLevel, error)
    GetLevelConfig(ctx context.Context, level int) (*LevelConfig, error)
    
    // ç»éªŒå€¼ç®¡ç†ï¼ˆå”¯ä¸€æ•°æ®æºï¼‰
    AddExperience(ctx context.Context, userID string, exp int, reason string) error
    GetExperience(ctx context.Context, userID string) (int, error)
    
    // å‡çº§æ£€æŸ¥
    CheckLevelUp(ctx context.Context, userID string) (bool, *UserLevel, error)
    
    // æˆå°±ç®¡ç†
    UnlockAchievement(ctx context.Context, userID, achievementID string) error
    GetUserAchievements(ctx context.Context, userID string) ([]*Achievement, error)
    
    // äº‹ä»¶å¤„ç†æ–¹æ³•ï¼ˆå¼ºåˆ¶å®šä¹‰ï¼‰
    OnTaskCompleted(ctx context.Context, event *TaskCompletedEvent) error
    OnUserBehavior(ctx context.Context, event *UserBehaviorEvent) error
}

// UserLevelUpEvent ç”¨æˆ·å‡çº§äº‹ä»¶
type UserLevelUpEvent struct {
    UserID      string `json:"user_id"`
    OldLevel    int    `json:"old_level"`
    NewLevel    int    `json:"new_level"`
    UnlockedAt  time.Time `json:"unlocked_at"`
}
```

#### Wallet Serviceæ¥å£ï¼ˆå·²å­˜åœ¨ï¼Œéœ€è¦æ·»åŠ äº‹ä»¶æ–¹æ³•ï¼‰

```go
package wallet

// WalletService é’±åŒ…æœåŠ¡æ¥å£
type WalletService interface {
    // ... ç°æœ‰æ–¹æ³• ...
    
    // äº‹ä»¶å¤„ç†æ–¹æ³•ï¼ˆæ–°å¢ï¼‰
    OnTaskCompleted(ctx context.Context, event *TaskCompletedEvent) error
    OnRevenueGenerated(ctx context.Context, event *RevenueEvent) error
}
```

### 1.4 äº‹ä»¶å¤„ç†å®ç°ç¤ºä¾‹

#### Reading Taskå®ç°

```go
func (s *ReadingTaskServiceImpl) CheckTaskCompletion(ctx context.Context, userID, taskID string) (bool, error) {
    // 1. è·å–ä»»åŠ¡
    task, err := s.taskRepo.GetByID(ctx, taskID)
    if err != nil {
        return false, err
    }
    
    // 2. è·å–è¿›åº¦
    progress, err := s.progressRepo.GetProgress(ctx, userID, taskID)
    if err != nil {
        return false, err
    }
    
    // 3. åˆ¤æ–­å®Œæˆ
    if progress.Current >= task.Target {
        // 4. å‘å¸ƒä»»åŠ¡å®Œæˆäº‹ä»¶ï¼ˆä¸ç›´æ¥ä¿®æ”¹ç»éªŒå€¼å’Œä»£å¸ï¼‰
        event := &TaskCompletedEvent{
            TaskID:       taskID,
            UserID:       userID,
            TaskType:     task.Type,
            RewardExp:    task.RewardExp,
            RewardTokens: task.RewardTokens,
            CompletedAt:  time.Now(),
        }
        
        if err := s.eventBus.PublishAsync(ctx, "task.completed", event); err != nil {
            log.Error("å‘å¸ƒä»»åŠ¡å®Œæˆäº‹ä»¶å¤±è´¥", err)
            // ä¸å½±å“ä¸»æµç¨‹ï¼Œä½†è®°å½•æ—¥å¿—
        }
        
        return true, nil
    }
    
    return false, nil
}
```

#### User Levelå®ç°

```go
func (s *UserLevelServiceImpl) OnTaskCompleted(ctx context.Context, event *TaskCompletedEvent) error {
    // 1. å¢åŠ ç»éªŒå€¼ï¼ˆå”¯ä¸€æ•°æ®æºï¼‰
    if err := s.AddExperience(ctx, event.UserID, event.RewardExp, fmt.Sprintf("task_%s", event.TaskID)); err != nil {
        return fmt.Errorf("å¢åŠ ç»éªŒå€¼å¤±è´¥: %w", err)
    }
    
    // 2. æ£€æŸ¥å‡çº§
    levelUp, newLevel, err := s.CheckLevelUp(ctx, event.UserID)
    if err != nil {
        log.Error("æ£€æŸ¥å‡çº§å¤±è´¥", err)
        // ä¸é˜»å¡ä¸»æµç¨‹
    }
    
    if levelUp {
        // 3. å‘å¸ƒå‡çº§äº‹ä»¶
        upgradeEvent := &UserLevelUpEvent{
            UserID:     event.UserID,
            OldLevel:   newLevel.Level - 1,
            NewLevel:   newLevel.Level,
            UnlockedAt: time.Now(),
        }
        s.eventBus.PublishAsync(ctx, "user.level_up", upgradeEvent)
    }
    
    // 4. æ£€æŸ¥æˆå°±
    s.checkAchievements(ctx, event.UserID, event.TaskType)
    
    return nil
}
```

#### Wallet Serviceå®ç°

```go
func (s *UnifiedWalletService) OnTaskCompleted(ctx context.Context, event *TaskCompletedEvent) error {
    // å¢åŠ ä»£å¸ï¼ˆå”¯ä¸€æ•°æ®æºï¼‰
    _, err := s.Recharge(ctx, event.UserID, float64(event.RewardTokens), fmt.Sprintf("task_reward_%s", event.TaskID))
    if err != nil {
        return fmt.Errorf("å¢åŠ ä»£å¸å¤±è´¥: %w", err)
    }
    
    return nil
}
```

### 1.5 æ•°æ®æ¨¡å‹è®¾è®¡

#### Taskæ•°æ®æ¨¡å‹

```go
package models

type Task struct {
    ID           string    `bson:"_id" json:"id"`
    Type         string    `bson:"type" json:"type"` // daily, weekly, achievement
    Title        string    `bson:"title" json:"title"`
    Description  string    `bson:"description" json:"description"`
    Target       int       `bson:"target" json:"target"`      // ç›®æ ‡å€¼
    RewardExp    int       `bson:"reward_exp" json:"rewardExp"`       // å¥–åŠ±ç»éªŒå€¼
    RewardTokens int64     `bson:"reward_tokens" json:"rewardTokens"` // å¥–åŠ±ä»£å¸
    Status       string    `bson:"status" json:"status"`
    CreatedAt    time.Time `bson:"created_at" json:"createdAt"`
}

type TaskProgress struct {
    ID        string    `bson:"_id" json:"id"`
    UserID    string    `bson:"user_id" json:"userId"`
    TaskID    string    `bson:"task_id" json:"taskId"`
    Current   int       `bson:"current" json:"current"`   // å½“å‰è¿›åº¦
    Completed bool      `bson:"completed" json:"completed"`
    UpdatedAt time.Time `bson:"updated_at" json:"updatedAt"`
}
```

#### User Levelæ•°æ®æ¨¡å‹

```go
package models

type UserLevel struct {
    ID            string    `bson:"_id" json:"id"`
    UserID        string    `bson:"user_id" json:"userId"`
    Level         int       `bson:"level" json:"level"`
    Experience    int       `bson:"experience" json:"experience"` // å½“å‰ç»éªŒå€¼ï¼ˆå”¯ä¸€æ•°æ®æºï¼‰
    NextLevelExp  int       `bson:"next_level_exp" json:"nextLevelExp"` // ä¸‹ä¸€çº§æ‰€éœ€ç»éªŒ
    Achievements  []string  `bson:"achievements" json:"achievements"` // å·²è§£é”æˆå°±IDåˆ—è¡¨
    Badges        []string  `bson:"badges" json:"badges"` // å‹‹ç« IDåˆ—è¡¨
    UpdatedAt     time.Time `bson:"updated_at" json:"updatedAt"`
}

type Achievement struct {
    ID          string   `bson:"_id" json:"id"`
    Title       string   `bson:"title" json:"title"`
    Description string   `bson:"description" json:"description"`
    Icon        string   `bson:"icon" json:"icon"`
    Type        string   `bson:"type" json:"type"` // reading, writing, social
    Condition   string   `bson:"condition" json:"condition"` // è§£é”æ¡ä»¶
    Reward      int      `bson:"reward" json:"reward"` // å¥–åŠ±ç»éªŒå€¼
}

type LevelConfig struct {
    Level        int      `bson:"level" json:"level"`
    RequiredExp  int      `bson:"required_exp" json:"requiredExp"`
    Privileges   []string `bson:"privileges" json:"privileges"` // ç‰¹æƒåˆ—è¡¨
    BadgeID      string   `bson:"badge_id" json:"badgeId"`
}
```

---

## äºŒã€Monetization vs Wallet Service

### 2.1 ç°çŠ¶é—®é¢˜åˆ†æ

**é—®é¢˜æè¿°**ï¼š
- Monetizationæ¨¡å—åŒ…å«æ”¶å…¥ç®¡ç†ã€æç°ç®¡ç†
- Wallet Serviceä¹ŸåŒ…å«æç°ç®¡ç†ã€äº¤æ˜“è®°å½•
- è´¢åŠ¡é€»è¾‘å’Œè´¦æœ¬ç®¡ç†æ··åœ¨ä¸€èµ·

**å¯¼è‡´çš„é—®é¢˜**ï¼š
- âŒ è´¢åŠ¡æ ¸å¿ƒè´¦æœ¬çš„å®‰å…¨æ€§å’Œéš”ç¦»æ€§ä¸è¶³
- âŒ ä¸šåŠ¡è§„åˆ™ï¼ˆåˆ†æˆæ¯”ä¾‹ã€åˆçº¦ï¼‰ä¸æŠ€æœ¯è´¦æœ¬ï¼ˆä½™é¢ã€äº¤æ˜“ï¼‰è€¦åˆ
- âŒ éš¾ä»¥è¿›è¡Œè´¢åŠ¡å®¡è®¡å’Œå¯¹è´¦

### 2.2 ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡

#### æ¨¡å—èŒè´£åˆ’åˆ†

| æ¨¡å— | å±‚æ¬¡ | èŒè´£ | æ•°æ®æ‰€æœ‰æƒ |
|------|------|------|-----------|
| **Monetization Service** | ä¸šåŠ¡é€»è¾‘å±‚ | â€¢ æ”¶ç›Šè®¡ç®—ï¼ˆè®¢é˜…ã€æ‰“èµã€å¹¿å‘Šã€ç‰ˆæƒï¼‰<br>â€¢ åˆ†æˆæ¯”ä¾‹ç®¡ç†<br>â€¢ åˆçº¦ç®¡ç†<br>â€¢ è´¢åŠ¡æŠ¥è¡¨ç”Ÿæˆ<br>â€¢ æç°ç”³è¯·æµç¨‹ï¼ˆä¸šåŠ¡å®¡æ ¸ï¼‰<br>â€¢ ç¨åŠ¡å¤„ç† | æ”¶ç›Šè®°å½•ã€åˆçº¦ã€åˆ†æˆé…ç½® |
| **Wallet Service** | æŠ€æœ¯è´¦æœ¬å±‚ | â€¢ ä»£å¸/è´§å¸ä½™é¢ç®¡ç†ï¼ˆå”¯ä¸€ï¼‰<br>â€¢ äº¤æ˜“è®°å½•ï¼ˆå”¯ä¸€ï¼‰<br>â€¢ æç°å¤„ç†ï¼ˆæŠ€æœ¯æ“ä½œï¼‰<br>â€¢ é£æ§æ£€æŸ¥<br>â€¢ è´¦æœ¬å¯¹è´¦ | ä½™é¢ï¼ˆå”¯ä¸€ï¼‰ã€äº¤æ˜“è®°å½•ï¼ˆå”¯ä¸€ï¼‰ |

#### åä½œæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Monetization Service                      â”‚
â”‚                   (ä¸šåŠ¡é€»è¾‘å±‚)                              â”‚
â”‚                                                              â”‚
â”‚  èŒè´£ï¼š                                                      â”‚
â”‚  1. è®¡ç®—ä½œè€…æ”¶ç›Šï¼ˆæ ¹æ®é˜…è¯»é‡ã€æ‰“èµã€å¹¿å‘Šç­‰ï¼‰                â”‚
â”‚  2. åº”ç”¨åˆ†æˆæ¯”ä¾‹ï¼ˆæ ¹æ®åˆçº¦é…ç½®ï¼‰                            â”‚
â”‚  3. ç”Ÿæˆè´¢åŠ¡æŠ¥è¡¨                                            â”‚
â”‚  4. å®¡æ ¸æç°ç”³è¯·                                            â”‚
â”‚                                                              â”‚
â”‚  ä¸è´Ÿè´£ï¼šç›´æ¥ä¿®æ”¹ä½™é¢                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ è°ƒç”¨Wallet API
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Wallet Service                             â”‚
â”‚                  (æŠ€æœ¯è´¦æœ¬å±‚)                                â”‚
â”‚                                                              â”‚
â”‚  èŒè´£ï¼š                                                      â”‚
â”‚  1. å¢åŠ /æ‰£é™¤ä½™é¢ï¼ˆå”¯ä¸€å…¥å£ï¼‰                               â”‚
â”‚  2. è®°å½•æ‰€æœ‰äº¤æ˜“ï¼ˆå”¯ä¸€æ•°æ®æºï¼‰                              â”‚
â”‚  3. å¤„ç†æç°ï¼ˆæŠ€æœ¯æ“ä½œï¼šå†»ç»“ã€è§£å†»ã€è½¬è´¦ï¼‰                  â”‚
â”‚  4. é£æ§æ£€æŸ¥ï¼ˆå¼‚å¸¸äº¤æ˜“æ£€æµ‹ï¼‰                                â”‚
â”‚  5. ç”Ÿæˆå¯¹è´¦æŠ¥è¡¨                                            â”‚
â”‚                                                              â”‚
â”‚  æ•°æ®æºï¼š                                                    â”‚
â”‚  - ç”¨æˆ·ä½™é¢ï¼ˆå”¯ä¸€ï¼‰                                          â”‚
â”‚  - äº¤æ˜“è®°å½•ï¼ˆå”¯ä¸€ï¼‰                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 æ¥å£è®¾è®¡

#### Monetization Serviceæ¥å£

```go
package writing

import (
    "context"
    "Qingyu_backend/service/base"
    "Qingyu_backend/service/shared/wallet"
)

// MonetizationService ç¨¿è´¹ç»“ç®—æœåŠ¡æ¥å£
type MonetizationService interface {
    base.BaseService
    
    // æ”¶ç›Šè®¡ç®—
    CalculateRevenue(ctx context.Context, authorID string, period Period) (*RevenueReport, error)
    CalculateChapterRevenue(ctx context.Context, chapterID string) (float64, error)
    
    // åˆ†æˆç®¡ç†
    GetShareConfig(ctx context.Context, authorID string) (*ShareConfig, error)
    UpdateShareConfig(ctx context.Context, authorID string, config *ShareConfig) error
    
    // åˆçº¦ç®¡ç†
    GetContract(ctx context.Context, authorID string) (*Contract, error)
    CreateContract(ctx context.Context, contract *Contract) error
    UpdateContract(ctx context.Context, authorID string, updates map[string]interface{}) error
    
    // æç°ç”³è¯·ï¼ˆä¸šåŠ¡å±‚ï¼‰
    RequestWithdrawal(ctx context.Context, req *WithdrawalRequest) (*WithdrawalOrder, error)
    ApproveWithdrawal(ctx context.Context, orderID, adminID string) error
    RejectWithdrawal(ctx context.Context, orderID, adminID, reason string) error
    
    // è´¢åŠ¡æŠ¥è¡¨
    GenerateFinancialReport(ctx context.Context, authorID string, period Period) (*FinancialReport, error)
    
    // ç¨åŠ¡å¤„ç†
    CalculateTax(ctx context.Context, amount float64, authorID string) (float64, error)
}

// RevenueReport æ”¶ç›ŠæŠ¥è¡¨
type RevenueReport struct {
    AuthorID        string  `json:"authorId"`
    Period          Period  `json:"period"`
    SubscriptionRev float64 `json:"subscriptionRevenue"` // è®¢é˜…æ”¶å…¥
    RewardRev       float64 `json:"rewardRevenue"`       // æ‰“èµæ”¶å…¥
    AdRev           float64 `json:"adRevenue"`           // å¹¿å‘Šæ”¶å…¥
    CopyrightRev    float64 `json:"copyrightRevenue"`    // ç‰ˆæƒæ”¶å…¥
    TotalRev        float64 `json:"totalRevenue"`
    ShareRatio      float64 `json:"shareRatio"`          // åˆ†æˆæ¯”ä¾‹
    AuthorShare     float64 `json:"authorShare"`         // ä½œè€…å®é™…æ”¶å…¥
}

// WithdrawalRequest æç°ç”³è¯·
type WithdrawalRequest struct {
    AuthorID string  `json:"authorId"`
    Amount   float64 `json:"amount"`
    Account  string  `json:"account"` // æç°è´¦å·
    Method   string  `json:"method"`  // æç°æ–¹å¼ï¼šalipay, wechat, bank
}

// WithdrawalOrder æç°è®¢å•
type WithdrawalOrder struct {
    ID         string    `json:"id"`
    AuthorID   string    `json:"authorId"`
    Amount     float64   `json:"amount"`
    Fee        float64   `json:"fee"`       // æ‰‹ç»­è´¹
    Tax        float64   `json:"tax"`       // ç¨è´¹
    NetAmount  float64   `json:"netAmount"` // å®é™…åˆ°è´¦
    Status     string    `json:"status"`    // pending, approved, rejected, completed
    Reason     string    `json:"reason,omitempty"`
    CreatedAt  time.Time `json:"createdAt"`
    UpdatedAt  time.Time `json:"updatedAt"`
}
```

#### Wallet Serviceæ¥å£ï¼ˆæ‰©å±•ï¼‰

```go
package wallet

// WalletService é’±åŒ…æœåŠ¡æ¥å£
type WalletService interface {
    // ... ç°æœ‰æ–¹æ³• ...
    
    // æç°å¤„ç†ï¼ˆæŠ€æœ¯æ“ä½œï¼‰
    FreezeForWithdrawal(ctx context.Context, userID string, amount float64, orderID string) error
    ProcessWithdrawal(ctx context.Context, orderID string) error
    CancelWithdrawal(ctx context.Context, orderID string) error // è§£å†»èµ„é‡‘
    
    // é£æ§æ£€æŸ¥
    CheckRiskControl(ctx context.Context, userID string, amount float64) (bool, error)
    
    // å¯¹è´¦
    ReconcileTransactions(ctx context.Context, startDate, endDate time.Time) (*ReconciliationReport, error)
}
```

### 2.4 ä¸šåŠ¡æµç¨‹ç¤ºä¾‹ï¼šä½œè€…æç°

```go
// Monetization Serviceå®ç°
func (ms *MonetizationServiceImpl) RequestWithdrawal(ctx context.Context, req *WithdrawalRequest) (*WithdrawalOrder, error) {
    // 1. ä¸šåŠ¡è§„åˆ™æ£€æŸ¥
    contract, err := ms.GetContract(ctx, req.AuthorID)
    if err != nil {
        return nil, err
    }
    
    // æ£€æŸ¥åˆçº¦æ˜¯å¦å…è®¸æç°
    if !contract.AllowWithdrawal() {
        return nil, errors.New("åˆçº¦ä¸å…è®¸æç°")
    }
    
    // æ£€æŸ¥æœ€å°æç°é‡‘é¢
    if req.Amount < contract.MinWithdrawalAmount {
        return nil, fmt.Errorf("æç°é‡‘é¢ä¸èƒ½ä½äº%v", contract.MinWithdrawalAmount)
    }
    
    // 2. è°ƒç”¨Wallet Serviceæ£€æŸ¥ä½™é¢
    balance, err := ms.walletService.GetBalance(ctx, req.AuthorID)
    if err != nil {
        return nil, err
    }
    
    if balance < req.Amount {
        return nil, errors.New("ä½™é¢ä¸è¶³")
    }
    
    // 3. é£æ§æ£€æŸ¥ï¼ˆWallet Serviceæä¾›ï¼‰
    passed, err := ms.walletService.CheckRiskControl(ctx, req.AuthorID, req.Amount)
    if err != nil || !passed {
        return nil, errors.New("é£æ§æ£€æŸ¥æœªé€šè¿‡")
    }
    
    // 4. è®¡ç®—ç¨è´¹
    tax, err := ms.CalculateTax(ctx, req.Amount, req.AuthorID)
    if err != nil {
        return nil, err
    }
    
    // 5. åˆ›å»ºæç°è®¢å•ï¼ˆMonetizationç®¡ç†ï¼‰
    order := &WithdrawalOrder{
        ID:        uuid.New().String(),
        AuthorID:  req.AuthorID,
        Amount:    req.Amount,
        Fee:       req.Amount * 0.01,  // 1%æ‰‹ç»­è´¹
        Tax:       tax,
        NetAmount: req.Amount - req.Amount*0.01 - tax,
        Status:    "pending",
        CreatedAt: time.Now(),
    }
    
    if err := ms.orderRepo.Create(ctx, order); err != nil {
        return nil, err
    }
    
    // 6. è°ƒç”¨Wallet Serviceå†»ç»“èµ„é‡‘
    if err := ms.walletService.FreezeForWithdrawal(ctx, req.AuthorID, req.Amount, order.ID); err != nil {
        // å›æ»šï¼šåˆ é™¤è®¢å•
        ms.orderRepo.Delete(ctx, order.ID)
        return nil, err
    }
    
    // 7. å‘å¸ƒäº‹ä»¶
    ms.eventBus.PublishAsync(ctx, "withdrawal.requested", &WithdrawalRequestedEvent{
        OrderID:  order.ID,
        AuthorID: req.AuthorID,
        Amount:   req.Amount,
    })
    
    return order, nil
}

func (ms *MonetizationServiceImpl) ApproveWithdrawal(ctx context.Context, orderID, adminID string) error {
    // 1. è·å–è®¢å•
    order, err := ms.orderRepo.GetByID(ctx, orderID)
    if err != nil {
        return err
    }
    
    // 2. æ›´æ–°è®¢å•çŠ¶æ€
    order.Status = "approved"
    if err := ms.orderRepo.Update(ctx, order); err != nil {
        return err
    }
    
    // 3. è°ƒç”¨Wallet Serviceå¤„ç†æç°ï¼ˆæŠ€æœ¯æ“ä½œï¼‰
    if err := ms.walletService.ProcessWithdrawal(ctx, orderID); err != nil {
        // å›æ»šçŠ¶æ€
        order.Status = "pending"
        ms.orderRepo.Update(ctx, order)
        return err
    }
    
    // 4. å‘å¸ƒäº‹ä»¶
    ms.eventBus.PublishAsync(ctx, "withdrawal.approved", &WithdrawalApprovedEvent{
        OrderID:  orderID,
        AuthorID: order.AuthorID,
        Amount:   order.NetAmount,
    })
    
    return nil
}
```

### 2.5 æ•°æ®æ¨¡å‹è®¾è®¡

#### Monetizationæ•°æ®æ¨¡å‹

```go
package models

// Revenue æ”¶ç›Šè®°å½•
type Revenue struct {
    ID          string    `bson:"_id" json:"id"`
    AuthorID    string    `bson:"author_id" json:"authorId"`
    BookID      string    `bson:"book_id" json:"bookId"`
    Source      string    `bson:"source" json:"source"` // subscription, reward, ad, copyright
    Amount      float64   `bson:"amount" json:"amount"`
    ShareRatio  float64   `bson:"share_ratio" json:"shareRatio"`
    AuthorShare float64   `bson:"author_share" json:"authorShare"`
    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`
}

// Contract åˆçº¦
type Contract struct {
    ID                  string    `bson:"_id" json:"id"`
    AuthorID            string    `bson:"author_id" json:"authorId"`
    Type                string    `bson:"type" json:"type"` // standard, premium, exclusive
    ShareRatio          float64   `bson:"share_ratio" json:"shareRatio"` // åˆ†æˆæ¯”ä¾‹ 0-1
    MinWithdrawalAmount float64   `bson:"min_withdrawal_amount" json:"minWithdrawalAmount"`
    StartDate           time.Time `bson:"start_date" json:"startDate"`
    EndDate             *time.Time `bson:"end_date,omitempty" json:"endDate,omitempty"`
    Status              string    `bson:"status" json:"status"` // active, expired, terminated
    CreatedAt           time.Time `bson:"created_at" json:"createdAt"`
}

// ShareConfig åˆ†æˆé…ç½®
type ShareConfig struct {
    ID            string  `bson:"_id" json:"id"`
    ContractType  string  `bson:"contract_type" json:"contractType"`
    SubscriptionShare float64 `bson:"subscription_share" json:"subscriptionShare"` // è®¢é˜…åˆ†æˆæ¯”ä¾‹
    RewardShare       float64 `bson:"reward_share" json:"rewardShare"`             // æ‰“èµåˆ†æˆæ¯”ä¾‹
    AdShare           float64 `bson:"ad_share" json:"adShare"`                     // å¹¿å‘Šåˆ†æˆæ¯”ä¾‹
    CopyrightShare    float64 `bson:"copyright_share" json:"copyrightShare"`       // ç‰ˆæƒåˆ†æˆæ¯”ä¾‹
}
```

---

## ä¸‰ã€AI Module Go/Pythonåˆ†å±‚

### 3.1 ç°çŠ¶é—®é¢˜åˆ†æ

**é—®é¢˜æè¿°**ï¼š
- å½“å‰AIæ¨¡å—å®Œå…¨åœ¨Goä¸­å®ç°
- AIé€»è¾‘ï¼ˆAgentã€RAGï¼‰ä¸APIå¤„ç†æ··åœ¨ä¸€èµ·
- éš¾ä»¥åˆ©ç”¨Pythonç”Ÿæ€çš„AIå·¥å…·å’Œåº“

**å¯¼è‡´çš„é—®é¢˜**ï¼š
- âŒ å¤æ‚AIé€»è¾‘åœ¨Goä¸­å®ç°å›°éš¾
- âŒ æ— æ³•åˆ©ç”¨Pythonä¸°å¯Œçš„AIç”Ÿæ€ï¼ˆLangChainã€å‘é‡æ•°æ®åº“å®¢æˆ·ç«¯ç­‰ï¼‰
- âŒ Agentå·¥å…·è°ƒç”¨ç³»ç»Ÿéš¾ä»¥æ‰©å±•
- âŒ RAGæ£€ç´¢å¢å¼ºå®ç°å¤æ‚

### 3.2 ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡

#### æ¶æ„åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Go Backend Service                     â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚       Router Layer (Gin)                 â”‚            â”‚
â”‚  â”‚  - /api/v1/ai/chat                       â”‚            â”‚
â”‚  â”‚  - /api/v1/ai/generate                   â”‚            â”‚
â”‚  â”‚  - /api/v1/ai/rag/search                 â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                   â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚       API Layer                          â”‚            â”‚
â”‚  â”‚  - å‚æ•°éªŒè¯                              â”‚            â”‚
â”‚  â”‚  - è®¤è¯æˆæƒ                              â”‚            â”‚
â”‚  â”‚  - SSEå“åº”åŒ…è£…                           â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                   â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   AI Proxy Service (Goä»£ç†å±‚)           â”‚            â”‚
â”‚  â”‚                                           â”‚            â”‚
â”‚  â”‚  èŒè´£ï¼š                                   â”‚            â”‚
â”‚  â”‚  1. gRPC Clientï¼ˆè¿æ¥PythonæœåŠ¡ï¼‰        â”‚            â”‚
â”‚  â”‚  2. æµå¼å“åº”ä»£ç†ï¼ˆSSEè½¬æ¢ï¼‰               â”‚            â”‚
â”‚  â”‚  3. ç†”æ–­å™¨ï¼ˆCircuit Breakerï¼‰            â”‚            â”‚
â”‚  â”‚  4. é™æµå™¨ï¼ˆRate Limiterï¼‰               â”‚            â”‚
â”‚  â”‚  5. è¶…æ—¶æ§åˆ¶                              â”‚            â”‚
â”‚  â”‚  6. é”™è¯¯è½¬æ¢ï¼ˆPythonå¼‚å¸¸â†’Goé”™è¯¯ï¼‰        â”‚            â”‚
â”‚  â”‚  7. è¯·æ±‚/å“åº”æ—¥å¿—                         â”‚            â”‚
â”‚  â”‚                                           â”‚            â”‚
â”‚  â”‚  ä¸è´Ÿè´£ï¼š                                 â”‚            â”‚
â”‚  â”‚  - AIæ ¸å¿ƒé€»è¾‘                             â”‚            â”‚
â”‚  â”‚  - å·¥å…·è°ƒç”¨æ‰§è¡Œ                           â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ gRPC (æ¨è) / HTTP
                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Python AI Agent Service (FastAPI)             â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚     gRPC Server / HTTP Server            â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                   â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚       Agent Engine Layer                 â”‚            â”‚
â”‚  â”‚                                           â”‚            â”‚
â”‚  â”‚  èŒè´£ï¼š                                   â”‚            â”‚
â”‚  â”‚  1. Agentæ ¸å¿ƒå¼•æ“ï¼ˆBaseAgentï¼‰           â”‚            â”‚
â”‚  â”‚  2. ä»»åŠ¡ç†è§£ä¸è§„åˆ’                        â”‚            â”‚
â”‚  â”‚  3. æ­¥éª¤æ‰§è¡Œç¼–æ’                          â”‚            â”‚
â”‚  â”‚  4. å¤šAgentåä½œ                           â”‚            â”‚
â”‚  â”‚  5. ç»“æœæ±‡æ€»                              â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                   â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚       Tool Calling System                â”‚            â”‚
â”‚  â”‚                                           â”‚            â”‚
â”‚  â”‚  èŒè´£ï¼š                                   â”‚            â”‚
â”‚  â”‚  1. å·¥å…·æ³¨å†Œä¸å‘ç°                        â”‚            â”‚
â”‚  â”‚  2. å‚æ•°éªŒè¯                              â”‚            â”‚
â”‚  â”‚  3. è°ƒç”¨Go APIï¼ˆå›è°ƒï¼‰                    â”‚            â”‚
â”‚  â”‚  4. ç»“æœè§£æ                              â”‚            â”‚
â”‚  â”‚  5. é”™è¯¯å¤„ç†                              â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                   â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚       RAG Retrieval Engine               â”‚            â”‚
â”‚  â”‚                                           â”‚            â”‚
â”‚  â”‚  èŒè´£ï¼š                                   â”‚            â”‚
â”‚  â”‚  1. å‘é‡åŒ–ï¼ˆEmbeddingï¼‰                   â”‚            â”‚
â”‚  â”‚  2. å‘é‡æ£€ç´¢ï¼ˆMilvus/Qdrantï¼‰            â”‚            â”‚
â”‚  â”‚  3. æ··åˆæ£€ç´¢ï¼ˆè¯­ä¹‰+å…³é”®è¯ï¼‰               â”‚            â”‚
â”‚  â”‚  4. é‡æ’åºï¼ˆRerankï¼‰                      â”‚            â”‚
â”‚  â”‚  5. ä¸Šä¸‹æ–‡æ„å»º                            â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚    External Services                      â”‚            â”‚
â”‚  â”‚  - OpenAI API                             â”‚            â”‚
â”‚  â”‚  - Claude API                             â”‚            â”‚
â”‚  â”‚  - æœ¬åœ°LLM                                 â”‚            â”‚
â”‚  â”‚  - å‘é‡æ•°æ®åº“ï¼ˆMilvus/Qdrantï¼‰            â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 é€šä¿¡åè®®è®¾è®¡

#### gRPC Protoå®šä¹‰

```protobuf
syntax = "proto3";

package ai;

service AIAgentService {
  // æ–‡æœ¬ç”Ÿæˆ
  rpc GenerateText(GenerateRequest) returns (GenerateResponse);
  
  // æµå¼æ–‡æœ¬ç”Ÿæˆ
  rpc GenerateTextStream(GenerateRequest) returns (stream StreamChunk);
  
  // å¯¹è¯
  rpc Chat(ChatRequest) returns (ChatResponse);
  
  // æµå¼å¯¹è¯
  rpc ChatStream(ChatRequest) returns (stream StreamChunk);
  
  // RAGæ£€ç´¢å¢å¼ºç”Ÿæˆ
  rpc RAGGenerate(RAGRequest) returns (RAGResponse);
  
  // Agentæ‰§è¡Œ
  rpc ExecuteAgent(AgentRequest) returns (AgentResponse);
  
  // å¥åº·æ£€æŸ¥
  rpc HealthCheck(HealthRequest) returns (HealthResponse);
}

message GenerateRequest {
  string prompt = 1;
  string model = 2;
  float temperature = 3;
  int32 max_tokens = 4;
  map<string, string> metadata = 5;
}

message GenerateResponse {
  string text = 1;
  int32 tokens_used = 2;
  string model = 3;
}

message StreamChunk {
  string delta = 1;
  bool is_final = 2;
  string error = 3;
}

message ChatRequest {
  string session_id = 1;
  repeated Message messages = 2;
  string model = 3;
  float temperature = 4;
}

message Message {
  string role = 1;
  string content = 2;
}

message RAGRequest {
  string query = 1;
  repeated string knowledge_bases = 2;
  int32 top_k = 3;
  bool include_citations = 4;
}

message RAGResponse {
  string answer = 1;
  repeated Source sources = 2;
  float confidence = 3;
}

message Source {
  string document_id = 1;
  string content = 2;
  float score = 3;
}

message AgentRequest {
  string agent_type = 1; // creative, analysis, review, assistant
  string task = 2;
  map<string, string> context = 3;
  repeated string tools = 4; // å¯ç”¨å·¥å…·åˆ—è¡¨
}

message AgentResponse {
  string result = 1;
  repeated ToolCall tool_calls = 2;
  string status = 3;
}

message ToolCall {
  string tool_name = 1;
  string parameters = 2; // JSON
  string result = 3;
}
```

### 3.4 Go AI Proxy Serviceå®ç°æ¡†æ¶

```go
package ai

import (
    "context"
    "io"
    "time"
    
    "google.golang.org/grpc"
    pb "Qingyu_backend/proto/ai" // ç”Ÿæˆçš„gRPCä»£ç 
)

// AIProxyService Go AIä»£ç†æœåŠ¡
type AIProxyService struct {
    grpcClient    pb.AIAgentServiceClient
    conn          *grpc.ClientConn
    circuitBreaker *CircuitBreaker
    rateLimiter    *RateLimiter
    timeout        time.Duration
}

// NewAIProxyService åˆ›å»ºAIä»£ç†æœåŠ¡
func NewAIProxyService(pythonAddr string) (*AIProxyService, error) {
    // 1. å»ºç«‹gRPCè¿æ¥
    conn, err := grpc.Dial(pythonAddr, 
        grpc.WithInsecure(),
        grpc.WithTimeout(30*time.Second),
    )
    if err != nil {
        return nil, err
    }
    
    client := pb.NewAIAgentServiceClient(conn)
    
    return &AIProxyService{
        grpcClient:     client,
        conn:           conn,
        circuitBreaker: NewCircuitBreaker(5, 30*time.Second),
        rateLimiter:    NewRateLimiter(100, time.Second), // 100 QPS
        timeout:        30 * time.Second,
    }, nil
}

// GenerateText æ–‡æœ¬ç”Ÿæˆï¼ˆåŒæ­¥ï¼‰
func (s *AIProxyService) GenerateText(ctx context.Context, req *GenerateRequest) (*GenerateResponse, error) {
    // 1. é™æµæ£€æŸ¥
    if !s.rateLimiter.Allow() {
        return nil, errors.New("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•")
    }
    
    // 2. ç†”æ–­æ£€æŸ¥
    if !s.circuitBreaker.Allow() {
        return nil, errors.New("AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨")
    }
    
    // 3. è½¬å‘åˆ°PythonæœåŠ¡
    ctx, cancel := context.WithTimeout(ctx, s.timeout)
    defer cancel()
    
    pbReq := &pb.GenerateRequest{
        Prompt:      req.Prompt,
        Model:       req.Model,
        Temperature: req.Temperature,
        MaxTokens:   int32(req.MaxTokens),
    }
    
    resp, err := s.grpcClient.GenerateText(ctx, pbReq)
    if err != nil {
        s.circuitBreaker.RecordFailure()
        return nil, s.convertError(err)
    }
    
    s.circuitBreaker.RecordSuccess()
    
    // 4. å“åº”è½¬æ¢
    return &GenerateResponse{
        Text:       resp.Text,
        TokensUsed: int(resp.TokensUsed),
        Model:      resp.Model,
    }, nil
}

// GenerateTextStream æµå¼æ–‡æœ¬ç”Ÿæˆ
func (s *AIProxyService) GenerateTextStream(ctx context.Context, req *GenerateRequest) (<-chan *StreamChunk, error) {
    // 1. é™æµå’Œç†”æ–­æ£€æŸ¥
    if !s.rateLimiter.Allow() {
        return nil, errors.New("è¯·æ±‚è¿‡äºé¢‘ç¹")
    }
    if !s.circuitBreaker.Allow() {
        return nil, errors.New("AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨")
    }
    
    // 2. è°ƒç”¨gRPCæµå¼æ¥å£
    pbReq := &pb.GenerateRequest{
        Prompt:      req.Prompt,
        Model:       req.Model,
        Temperature: req.Temperature,
        MaxTokens:   int32(req.MaxTokens),
    }
    
    stream, err := s.grpcClient.GenerateTextStream(ctx, pbReq)
    if err != nil {
        s.circuitBreaker.RecordFailure()
        return nil, s.convertError(err)
    }
    
    // 3. åˆ›å»ºè¾“å‡ºchannel
    chunkChan := make(chan *StreamChunk, 100)
    
    // 4. å¼‚æ­¥æ¥æ”¶æµå¼æ•°æ®
    go func() {
        defer close(chunkChan)
        
        for {
            chunk, err := stream.Recv()
            if err == io.EOF {
                s.circuitBreaker.RecordSuccess()
                return
            }
            if err != nil {
                s.circuitBreaker.RecordFailure()
                chunkChan <- &StreamChunk{
                    Error: s.convertError(err).Error(),
                }
                return
            }
            
            chunkChan <- &StreamChunk{
                Delta:   chunk.Delta,
                IsFinal: chunk.IsFinal,
            }
        }
    }()
    
    return chunkChan, nil
}

// convertError é”™è¯¯è½¬æ¢
func (s *AIProxyService) convertError(err error) error {
    // TODO: å°†gRPCé”™è¯¯è½¬æ¢ä¸ºç»Ÿä¸€çš„Goé”™è¯¯
    return err
}

// Close å…³é—­è¿æ¥
func (s *AIProxyService) Close() error {
    return s.conn.Close()
}
```

### 3.5 Python AI Agent Serviceæ¡†æ¶ï¼ˆä¼ªä»£ç ï¼‰

```python
# main.py
from fastapi import FastAPI
from grpc import aio
import ai_agent_pb2
import ai_agent_pb2_grpc

class AIAgentServicer(ai_agent_pb2_grpc.AIAgentServiceServicer):
    def __init__(self):
        self.agent_engine = AgentEngine()
        self.tool_registry = ToolRegistry()
        self.rag_engine = RAGEngine()
        
    async def GenerateTextStream(self, request, context):
        """æµå¼æ–‡æœ¬ç”Ÿæˆ"""
        try:
            # è°ƒç”¨Agentå¼•æ“
            async for chunk in self.agent_engine.generate_stream(
                prompt=request.prompt,
                model=request.model,
                temperature=request.temperature
            ):
                yield ai_agent_pb2.StreamChunk(
                    delta=chunk.text,
                    is_final=chunk.is_final
                )
        except Exception as e:
            yield ai_agent_pb2.StreamChunk(
                error=str(e)
            )
    
    async def ExecuteAgent(self, request, context):
        """æ‰§è¡ŒAgentä»»åŠ¡"""
        agent = self.agent_engine.create_agent(request.agent_type)
        
        # æ³¨å†Œå·¥å…·
        for tool_name in request.tools:
            tool = self.tool_registry.get_tool(tool_name)
            agent.register_tool(tool)
        
        # æ‰§è¡Œä»»åŠ¡
        result = await agent.execute(
            task=request.task,
            context=request.context
        )
        
        return ai_agent_pb2.AgentResponse(
            result=result.output,
            tool_calls=[
                ai_agent_pb2.ToolCall(
                    tool_name=call.tool_name,
                    parameters=call.parameters,
                    result=call.result
                )
                for call in result.tool_calls
            ],
            status="completed"
        )

# å¯åŠ¨gRPCæœåŠ¡å™¨
async def serve():
    server = aio.server()
    ai_agent_pb2_grpc.add_AIAgentServiceServicer_to_server(
        AIAgentServicer(), server
    )
    server.add_insecure_port('[::]:50051')
    await server.start()
    await server.wait_for_termination()

if __name__ == '__main__':
    import asyncio
    asyncio.run(serve())
```

---

## å››ã€å®æ–½å»ºè®®

### 4.1 å®æ–½ä¼˜å…ˆçº§

| ä¼˜åŒ–é¡¹ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥æ—¶ | é£é™©ç­‰çº§ |
|--------|--------|----------|---------|
| Reading Task vs User LevelèŒè´£åˆ’åˆ† | P0 | 3-5å¤© | ä¸­ |
| Monetization vs Walletåˆ†ç¦» | P0 | 5-7å¤© | é«˜ |
| AI Module Go/Pythonåˆ†å±‚ | P1 | 2-3å‘¨ | é«˜ |

### 4.2 å®æ–½æ­¥éª¤

#### é˜¶æ®µ1ï¼šæ¥å£å®šä¹‰ï¼ˆ1å‘¨ï¼‰
1. å®šä¹‰æ‰€æœ‰æ–°å¢æ¥å£
2. å®šä¹‰äº‹ä»¶ç»“æ„
3. è¯„å®¡ä¸ç¡®è®¤

#### é˜¶æ®µ2ï¼šæ•°æ®æ¨¡å‹è®¾è®¡ï¼ˆ1å‘¨ï¼‰
1. è®¾è®¡MongoDB Schema
2. è®¾è®¡æ•°æ®è¿ç§»æ–¹æ¡ˆ
3. å‡†å¤‡æµ‹è¯•æ•°æ®

#### é˜¶æ®µ3ï¼šåˆ†æ¨¡å—å®æ–½ï¼ˆ2-4å‘¨ï¼‰
1. Reading Taské‡æ„
2. User Levelå®ç°
3. Monetizationå®ç°
4. Python AI Serviceå¼€å‘

#### é˜¶æ®µ4ï¼šé›†æˆæµ‹è¯•ï¼ˆ1å‘¨ï¼‰
1. å•å…ƒæµ‹è¯•
2. é›†æˆæµ‹è¯•
3. æ€§èƒ½æµ‹è¯•

### 4.3 é£é™©ä¸æŒ‘æˆ˜

| é£é™© | å½±å“ | åº”å¯¹æªæ–½ |
|------|------|---------|
| æ•°æ®è¿ç§»å¤±è´¥ | é«˜ | å……åˆ†æµ‹è¯•ï¼Œå¤‡ä»½æ•°æ®ï¼Œç°åº¦å‘å¸ƒ |
| äº‹ä»¶ä¸¢å¤± | é«˜ | äº‹ä»¶æŒä¹…åŒ–ï¼Œè¡¥å¿æœºåˆ¶ |
| PythonæœåŠ¡ç¨³å®šæ€§ | ä¸­ | ç†”æ–­å™¨ï¼Œé™çº§æ–¹æ¡ˆ |
| æ€§èƒ½ä¸‹é™ | ä¸­ | ç¼“å­˜ä¼˜åŒ–ï¼Œè¿æ¥æ±  |

---

## äº”ã€æ€»ç»“

æœ¬æ¨¡å—è¾¹ç•Œä¼˜åŒ–æ–¹æ¡ˆé€šè¿‡æ˜ç¡®èŒè´£åˆ’åˆ†ã€å®ç°å•ä¸€æ•°æ®æºã€å¼•å…¥äº‹ä»¶é©±åŠ¨å’ŒGo/Pythonåˆ†å±‚ï¼Œæ˜¾è‘—æå‡äº†ç³»ç»Ÿçš„ï¼š

1. **å¯ç»´æŠ¤æ€§**ï¼šèŒè´£æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œä¿®æ”¹
2. **å¯æ‰©å±•æ€§**ï¼šæ¨¡å—ç‹¬ç«‹ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½
3. **å¯æµ‹è¯•æ€§**ï¼šè¾¹ç•Œæ˜ç¡®ï¼Œä¾¿äºå•å…ƒæµ‹è¯•
4. **æ•°æ®ä¸€è‡´æ€§**ï¼šå•ä¸€æ•°æ®æºï¼Œå‡å°‘ä¸ä¸€è‡´é£é™©
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šGoå¤„ç†é«˜å¹¶å‘ï¼ŒPythonå¤„ç†AIå¤æ‚é€»è¾‘

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼š
- [ ] ç¼–å†™è¯¦ç»†çš„æ¥å£è®¾è®¡æ–‡æ¡£
- [ ] å‡†å¤‡æ•°æ®è¿ç§»æ–¹æ¡ˆ
- [ ] æ­å»ºPython AIæœåŠ¡æ¡†æ¶
- [ ] å®æ–½äº‹ä»¶é©±åŠ¨æ¶æ„æ”¹é€ 

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2025-10-21  
**è´Ÿè´£äºº**: æ¶æ„ç»„  
**å®¡æ ¸çŠ¶æ€**: å¾…è¯„å®¡

