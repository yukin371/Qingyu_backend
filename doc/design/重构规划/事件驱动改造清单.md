# 事件驱动改造清单

> **文档版本**: v1.0  
> **创建时间**: 2025-10-21  
> **状态**: 规划中

## 📋 文档概述

本文档列出所有需要添加事件发布的Service方法、需要实现的EventHandler、以及事件订阅关系图。

---

## 一、需要添加事件发布的Service方法

### 1.1 User Service

| 方法 | 需要发布的事件 | 优先级 |
|------|---------------|--------|
| `CreateUser` | `user.created` | P0 |
| `UpdateUser` | `user.updated` | P1 |
| `DeleteUser` | `user.deleted` | P1 |
| `ChangePassword` | `user.password_changed` | P1 |

### 1.2 User Level Service

| 方法 | 需要发布的事件 | 优先级 |
|------|---------------|--------|
| `AddExperience` | `user.exp_added` | P1 |
| `CheckLevelUp` | `user.level_up` | P0 |
| `UnlockAchievement` | `user.achievement_unlocked` | P0 |

### 1.3 Reading Task Service

| 方法 | 需要发布的事件 | 优先级 |
|------|---------------|--------|
| `CompleteTask` | `task.completed` | P0 |
| `UpdateProgress` | `task.progress_updated` | P1 |

### 1.4 Wallet Service

| 方法 | 需要发布的事件 | 优先级 |
|------|---------------|--------|
| `Recharge` | `wallet.recharged` | P1 |
| `Consume` | `wallet.consumed` | P1 |
| `Transfer` | `wallet.transferred` | P1 |
| `ProcessWithdrawal` | `wallet.withdrawal_processed` | P0 |

### 1.5 Project Service

| 方法 | 需要发布的事件 | 优先级 |
|------|---------------|--------|
| `CreateProject` | `project.created` | P0 |
| `UpdateProject` | `project.updated` | P1 |
| `DeleteProject` | `project.deleted` | P1 |

### 1.6 Document Service

| 方法 | 需要发布的事件 | 优先级 |
|------|---------------|--------|
| `CreateDocument` | `document.created` | P0 |
| `UpdateDocument` | `document.updated` | P0 |
| `CreateVersion` | `document.version_created` | P0 |

### 1.7 Bookstore Service

| 方法 | 需要发布的事件 | 优先级 |
|------|---------------|--------|
| `PurchaseChapter` | `chapter.purchased` | P0 |
| `UnlockChapter` | `chapter.unlocked` | P0 |

### 1.8 AI Service

| 方法 | 需要发布的事件 | 优先级 |
|------|---------------|--------|
| `CreateChatSession` | `chat.session_created` | P0 |
| `GenerateText` | `ai.generation_completed` | P1 |

---

## 二、需要实现的EventHandler

### 2.1 User Level相关Handler

| Handler | 订阅事件 | 处理逻辑 | 优先级 |
|---------|---------|---------|--------|
| `TaskCompletedHandler` | `task.completed` | 增加经验值，检查升级 | P0 |
| `UserBehaviorHandler` | `user.behavior` | 记录行为，计算经验 | P1 |

### 2.2 Wallet相关Handler

| Handler | 订阅事件 | 处理逻辑 | 优先级 |
|---------|---------|---------|--------|
| `TaskCompletedWalletHandler` | `task.completed` | 增加代币奖励 | P0 |
| `ChapterPurchasedHandler` | `chapter.purchased` | 扣除读者代币 | P0 |

### 2.3 RAG相关Handler

| Handler | 订阅事件 | 处理逻辑 | 优先级 |
|---------|---------|---------|--------|
| `DocumentVersionCreatedHandler` | `document.version_created` | 向量化文档内容 | P0 |
| `CharacterCreatedHandler` | `character.created` | 向量化角色信息 | P1 |
| `SettingUpdatedHandler` | `setting.updated` | 更新设定索引 | P1 |

### 2.4 Notification相关Handler

| Handler | 订阅事件 | 处理逻辑 | 优先级 |
|---------|---------|---------|--------|
| `UserLevelUpNotificationHandler` | `user.level_up` | 发送升级通知 | P1 |
| `AchievementUnlockedNotificationHandler` | `user.achievement_unlocked` | 发送成就通知 | P1 |
| `ChapterPurchasedNotificationHandler` | `chapter.purchased` | 通知作者有新收益 | P1 |

---

## 三、事件订阅关系图

```
事件: task.completed
  订阅者:
    - UserLevelService.OnTaskCompleted    [增加经验值]
    - WalletService.OnTaskCompleted       [增加代币]
    - NotificationService.OnTaskCompleted [发送完成通知]

事件: user.level_up
  订阅者:
    - NotificationService.OnUserLevelUp   [发送升级通知]
    - AchievementService.OnUserLevelUp    [检查等级相关成就]

事件: document.version_created
  订阅者:
    - RAGService.OnDocumentVersionCreated [向量化文档]
    - BackupService.OnDocumentVersionCreated [备份版本]

事件: chapter.purchased
  订阅者:
    - WalletService.OnChapterPurchased    [扣除读者代币]
    - MonetizationService.OnChapterPurchased [记录作者收益]
    - NotificationService.OnChapterPurchased [通知作者]
    - BookstoreService.OnChapterPurchased [解锁章节]

事件: chat.session_created
  订阅者:
    - RAGService.OnChatSessionCreated     [准备知识库]
    - AnalyticsService.OnChatSessionCreated [记录使用统计]
```

---

## 四、改造优先级排序

### Phase 1 (P0 - 核心功能)

1. `task.completed` 事件 + 订阅者
2. `user.level_up` 事件 + 订阅者
3. `document.version_created` 事件 + 订阅者
4. `chapter.purchased` 事件 + 订阅者

### Phase 2 (P1 - 扩展功能)

5. `user.behavior` 事件 + 订阅者
6. `wallet.*` 系列事件 + 订阅者
7. 通知相关事件处理器

---

## 五、实施步骤

### 步骤1: 定义事件结构（1天）
- 在`models/events`中定义所有事件结构
- 编写事件文档

### 步骤2: 添加事件发布（3天）
- 在对应Service方法中添加事件发布
- 编写单元测试

### 步骤3: 实现EventHandler（3天）
- 实现所有P0优先级的Handler
- 编写单元测试

### 步骤4: 注册EventHandler（1天）
- 在应用启动时注册所有Handler
- 配置EventBus

### 步骤5: 集成测试（2天）
- 端到端测试
- 监控事件流转

---

**文档版本**: v1.0  
**创建时间**: 2025-10-21  
**负责人**: 架构组

