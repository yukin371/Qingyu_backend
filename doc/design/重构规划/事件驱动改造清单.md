# äº‹ä»¶é©±åŠ¨æ”¹é€ æ¸…å•

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¶é—´**: 2025-10-21  
> **çŠ¶æ€**: è§„åˆ’ä¸­

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£åˆ—å‡ºæ‰€æœ‰éœ€è¦æ·»åŠ äº‹ä»¶å‘å¸ƒçš„Serviceæ–¹æ³•ã€éœ€è¦å®ç°çš„EventHandlerã€ä»¥åŠäº‹ä»¶è®¢é˜…å…³ç³»å›¾ã€‚

---

## ä¸€ã€éœ€è¦æ·»åŠ äº‹ä»¶å‘å¸ƒçš„Serviceæ–¹æ³•

### 1.1 User Service

| æ–¹æ³• | éœ€è¦å‘å¸ƒçš„äº‹ä»¶ | ä¼˜å…ˆçº§ |
|------|---------------|--------|
| `CreateUser` | `user.created` | P0 |
| `UpdateUser` | `user.updated` | P1 |
| `DeleteUser` | `user.deleted` | P1 |
| `ChangePassword` | `user.password_changed` | P1 |

### 1.2 User Level Service

| æ–¹æ³• | éœ€è¦å‘å¸ƒçš„äº‹ä»¶ | ä¼˜å…ˆçº§ |
|------|---------------|--------|
| `AddExperience` | `user.exp_added` | P1 |
| `CheckLevelUp` | `user.level_up` | P0 |
| `UnlockAchievement` | `user.achievement_unlocked` | P0 |

### 1.3 Reading Task Service

| æ–¹æ³• | éœ€è¦å‘å¸ƒçš„äº‹ä»¶ | ä¼˜å…ˆçº§ |
|------|---------------|--------|
| `CompleteTask` | `task.completed` | P0 |
| `UpdateProgress` | `task.progress_updated` | P1 |

### 1.4 Wallet Service

| æ–¹æ³• | éœ€è¦å‘å¸ƒçš„äº‹ä»¶ | ä¼˜å…ˆçº§ |
|------|---------------|--------|
| `Recharge` | `wallet.recharged` | P1 |
| `Consume` | `wallet.consumed` | P1 |
| `Transfer` | `wallet.transferred` | P1 |
| `ProcessWithdrawal` | `wallet.withdrawal_processed` | P0 |

### 1.5 Project Service

| æ–¹æ³• | éœ€è¦å‘å¸ƒçš„äº‹ä»¶ | ä¼˜å…ˆçº§ |
|------|---------------|--------|
| `CreateProject` | `project.created` | P0 |
| `UpdateProject` | `project.updated` | P1 |
| `DeleteProject` | `project.deleted` | P1 |

### 1.6 Document Service

| æ–¹æ³• | éœ€è¦å‘å¸ƒçš„äº‹ä»¶ | ä¼˜å…ˆçº§ |
|------|---------------|--------|
| `CreateDocument` | `document.created` | P0 |
| `UpdateDocument` | `document.updated` | P0 |
| `CreateVersion` | `document.version_created` | P0 |

### 1.7 Bookstore Service

| æ–¹æ³• | éœ€è¦å‘å¸ƒçš„äº‹ä»¶ | ä¼˜å…ˆçº§ |
|------|---------------|--------|
| `PurchaseChapter` | `chapter.purchased` | P0 |
| `UnlockChapter` | `chapter.unlocked` | P0 |

### 1.8 AI Service

| æ–¹æ³• | éœ€è¦å‘å¸ƒçš„äº‹ä»¶ | ä¼˜å…ˆçº§ |
|------|---------------|--------|
| `CreateChatSession` | `chat.session_created` | P0 |
| `GenerateText` | `ai.generation_completed` | P1 |

---

## äºŒã€éœ€è¦å®ç°çš„EventHandler

### 2.1 User Levelç›¸å…³Handler

| Handler | è®¢é˜…äº‹ä»¶ | å¤„ç†é€»è¾‘ | ä¼˜å…ˆçº§ |
|---------|---------|---------|--------|
| `TaskCompletedHandler` | `task.completed` | å¢åŠ ç»éªŒå€¼ï¼Œæ£€æŸ¥å‡çº§ | P0 |
| `UserBehaviorHandler` | `user.behavior` | è®°å½•è¡Œä¸ºï¼Œè®¡ç®—ç»éªŒ | P1 |

### 2.2 Walletç›¸å…³Handler

| Handler | è®¢é˜…äº‹ä»¶ | å¤„ç†é€»è¾‘ | ä¼˜å…ˆçº§ |
|---------|---------|---------|--------|
| `TaskCompletedWalletHandler` | `task.completed` | å¢åŠ ä»£å¸å¥–åŠ± | P0 |
| `ChapterPurchasedHandler` | `chapter.purchased` | æ‰£é™¤è¯»è€…ä»£å¸ | P0 |

### 2.3 RAGç›¸å…³Handler

| Handler | è®¢é˜…äº‹ä»¶ | å¤„ç†é€»è¾‘ | ä¼˜å…ˆçº§ |
|---------|---------|---------|--------|
| `DocumentVersionCreatedHandler` | `document.version_created` | å‘é‡åŒ–æ–‡æ¡£å†…å®¹ | P0 |
| `CharacterCreatedHandler` | `character.created` | å‘é‡åŒ–è§’è‰²ä¿¡æ¯ | P1 |
| `SettingUpdatedHandler` | `setting.updated` | æ›´æ–°è®¾å®šç´¢å¼• | P1 |

### 2.4 Notificationç›¸å…³Handler

| Handler | è®¢é˜…äº‹ä»¶ | å¤„ç†é€»è¾‘ | ä¼˜å…ˆçº§ |
|---------|---------|---------|--------|
| `UserLevelUpNotificationHandler` | `user.level_up` | å‘é€å‡çº§é€šçŸ¥ | P1 |
| `AchievementUnlockedNotificationHandler` | `user.achievement_unlocked` | å‘é€æˆå°±é€šçŸ¥ | P1 |
| `ChapterPurchasedNotificationHandler` | `chapter.purchased` | é€šçŸ¥ä½œè€…æœ‰æ–°æ”¶ç›Š | P1 |

---

## ä¸‰ã€äº‹ä»¶è®¢é˜…å…³ç³»å›¾

```
äº‹ä»¶: task.completed
  è®¢é˜…è€…:
    - UserLevelService.OnTaskCompleted    [å¢åŠ ç»éªŒå€¼]
    - WalletService.OnTaskCompleted       [å¢åŠ ä»£å¸]
    - NotificationService.OnTaskCompleted [å‘é€å®Œæˆé€šçŸ¥]

äº‹ä»¶: user.level_up
  è®¢é˜…è€…:
    - NotificationService.OnUserLevelUp   [å‘é€å‡çº§é€šçŸ¥]
    - AchievementService.OnUserLevelUp    [æ£€æŸ¥ç­‰çº§ç›¸å…³æˆå°±]

äº‹ä»¶: document.version_created
  è®¢é˜…è€…:
    - RAGService.OnDocumentVersionCreated [å‘é‡åŒ–æ–‡æ¡£]
    - BackupService.OnDocumentVersionCreated [å¤‡ä»½ç‰ˆæœ¬]

äº‹ä»¶: chapter.purchased
  è®¢é˜…è€…:
    - WalletService.OnChapterPurchased    [æ‰£é™¤è¯»è€…ä»£å¸]
    - MonetizationService.OnChapterPurchased [è®°å½•ä½œè€…æ”¶ç›Š]
    - NotificationService.OnChapterPurchased [é€šçŸ¥ä½œè€…]
    - BookstoreService.OnChapterPurchased [è§£é”ç« èŠ‚]

äº‹ä»¶: chat.session_created
  è®¢é˜…è€…:
    - RAGService.OnChatSessionCreated     [å‡†å¤‡çŸ¥è¯†åº“]
    - AnalyticsService.OnChatSessionCreated [è®°å½•ä½¿ç”¨ç»Ÿè®¡]
```

---

## å››ã€æ”¹é€ ä¼˜å…ˆçº§æ’åº

### Phase 1 (P0 - æ ¸å¿ƒåŠŸèƒ½)

1. `task.completed` äº‹ä»¶ + è®¢é˜…è€…
2. `user.level_up` äº‹ä»¶ + è®¢é˜…è€…
3. `document.version_created` äº‹ä»¶ + è®¢é˜…è€…
4. `chapter.purchased` äº‹ä»¶ + è®¢é˜…è€…

### Phase 2 (P1 - æ‰©å±•åŠŸèƒ½)

5. `user.behavior` äº‹ä»¶ + è®¢é˜…è€…
6. `wallet.*` ç³»åˆ—äº‹ä»¶ + è®¢é˜…è€…
7. é€šçŸ¥ç›¸å…³äº‹ä»¶å¤„ç†å™¨

---

## äº”ã€å®æ–½æ­¥éª¤

### æ­¥éª¤1: å®šä¹‰äº‹ä»¶ç»“æ„ï¼ˆ1å¤©ï¼‰
- åœ¨`models/events`ä¸­å®šä¹‰æ‰€æœ‰äº‹ä»¶ç»“æ„
- ç¼–å†™äº‹ä»¶æ–‡æ¡£

### æ­¥éª¤2: æ·»åŠ äº‹ä»¶å‘å¸ƒï¼ˆ3å¤©ï¼‰
- åœ¨å¯¹åº”Serviceæ–¹æ³•ä¸­æ·»åŠ äº‹ä»¶å‘å¸ƒ
- ç¼–å†™å•å…ƒæµ‹è¯•

### æ­¥éª¤3: å®ç°EventHandlerï¼ˆ3å¤©ï¼‰
- å®ç°æ‰€æœ‰P0ä¼˜å…ˆçº§çš„Handler
- ç¼–å†™å•å…ƒæµ‹è¯•

### æ­¥éª¤4: æ³¨å†ŒEventHandlerï¼ˆ1å¤©ï¼‰
- åœ¨åº”ç”¨å¯åŠ¨æ—¶æ³¨å†Œæ‰€æœ‰Handler
- é…ç½®EventBus

### æ­¥éª¤5: é›†æˆæµ‹è¯•ï¼ˆ2å¤©ï¼‰
- ç«¯åˆ°ç«¯æµ‹è¯•
- ç›‘æ§äº‹ä»¶æµè½¬

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2025-10-21  
**è´Ÿè´£äºº**: æ¶æ„ç»„

