# 数据库设计说明书

本文档列出 MongoDB 集合、字段与索引设计，并与代码实现对齐，支持后续开发与优化。

## 1. 概览

- 数据库：MongoDB（WiredTiger）
- 命名：snake_case 字段
- 参考实现：service/document 与 models/document 代码

## 2. 集合与字段

### 2.1 users（用户）

- _id, username(unique), email(unique), password, created_at, updated_at

### 2.2 projects（项目）

- _id, owner_id, name, status[public|private], description, created_at, updated_at
- 索引：_id(unique), owner_id, status, owner_id+status, created_at(desc), deleted_at(sparse)

### 2.3 nodes（节点）
- _id, project_id, parent_id, type[folder|file], name, slug, relative_path, order, created_at, updated_at

### 2.4 documents（文档）
- _id, project_id(opt), node_id, title, content, format, words, version, created_at, updated_at

### 2.5 file_revisions（文件版本）
- _id, project_id, node_id, version, author_id, message, snapshot(opt), parent_version, created_at

### 2.6 file_patches（补丁）
- _id, project_id, node_id, base_version, diff_format, diff_payload, created_by, status, preview(opt), metadata, created_at, updated_at

### 2.7 novel_files（兼容/历史命名）
- 用于版本服务的文件集合（后续与 documents 合并或迁移，参考 service/document/version_service.go）

### 2.8 ai_providers / ai_models（AI 配置）
- 见 models/ai 目录，包含 Provider/Model 基本信息与时间戳

## 3. 索引策略
- 高频过滤字段建立单列或复合索引（owner_id, status, created_at）
- 稀疏索引用于软删除/可选字段（deleted_at）
- 版本/补丁集合按 project_id、node_id、version 建立常用查询索引

## 4. 一致性与迁移
- 新增字段默认可空，迁移采用后向兼容策略
- 大内容 snapshot 可外置存储并存储引用（storage_ref）

## 5. 数据生命周期
- 历史版本归档策略（时间或数量阈值）
- 备份与恢复：见《部署与运维指南》./部署与运维指南.md

## 6. 关联文档
- 软件需求规格说明书(SRS) ./软件需求规格说明书(SRS).md
- 架构设计说明书 ./架构设计说明书.md
- API 接口总览 ./API接口总览.md
- 测试计划与用例 ./测试计划与用例.md
- 部署与运维指南 ./部署与运维指南.md
- 安全设计与威胁建模 ./安全设计与威胁建模.md
- 日志与监控 ./日志与监控.md