# 统计分析系统设计

> **版本**: v1.0  
> **创建日期**: 2025-10-21  
> **状态**: ✅ 已实现，补充设计文档

---

## 1. 设计概述

### 1.1 业务价值

- 书籍阅读数据统计
- 章节阅读数据统计
- 用户行为分析
- 作者作品数据分析

### 1.2 实现情况

**已实现**：
- BookStats数据模型：`models/stats/book_stats.go`
- ChapterStats数据模型：`models/stats/chapter_stats.go`
- ReaderBehavior数据模型：`models/stats/reader_behavior.go`

---

## 2. 核心数据模型

### 2.1 BookStats（书籍统计）

```go
type BookStats struct {
    BookID        string    `bson:"_id" json:"bookId"`
    Reads         int64     `bson:"reads" json:"reads"`           // 阅读数
    Favorites     int64     `bson:"favorites" json:"favorites"`   // 收藏数
    Comments      int64     `bson:"comments" json:"comments"`     // 评论数
    Shares        int64     `bson:"shares" json:"shares"`         // 分享数
    AverageRating float64   `bson:"averageRating" json:"averageRating"`
    TotalRatings  int64     `bson:"totalRatings" json:"totalRatings"`
    Revenue       float64   `bson:"revenue" json:"revenue"`       // 总收益
    UpdatedAt     time.Time `bson:"updatedAt" json:"updatedAt"`
}
```

### 2.2 ChapterStats（章节统计）

```go
type ChapterStats struct {
    ChapterID  string    `bson:"_id" json:"chapterId"`
    BookID     string    `bson:"bookId" json:"bookId"`
    Reads      int64     `bson:"reads" json:"reads"`
    UniqueReads int64    `bson:"uniqueReads" json:"uniqueReads"` // 独立读者数
    Likes      int64     `bson:"likes" json:"likes"`
    Comments   int64     `bson:"comments" json:"comments"`
    Revenue    float64   `bson:"revenue" json:"revenue"`
    UpdatedAt  time.Time `bson:"updatedAt" json:"updatedAt"`
}
```

### 2.3 ReaderBehavior（读者行为）

```go
type ReaderBehavior struct {
    ID         string    `bson:"_id,omitempty" json:"id"`
    UserID     string    `bson:"userId" json:"userId"`
    BookID     string    `bson:"bookId" json:"bookId"`
    ChapterID  string    `bson:"chapterId" json:"chapterId"`
    Action     string    `bson:"action" json:"action"`  // read/favorite/comment/share
    Duration   int       `bson:"duration" json:"duration"` // 阅读时长（秒）
    CreatedAt  time.Time `bson:"createdAt" json:"createdAt"`
}
```

**索引策略**：
```javascript
db.book_stats.createIndex({ "bookId": 1 })
db.chapter_stats.createIndex({ "bookId": 1, "chapterId": 1 })
db.reader_behavior.createIndex({ "userId": 1, "createdAt": -1 })
db.reader_behavior.createIndex({ "bookId": 1, "action": 1 })
```

---

## 3. 统计计算策略

### 3.1 实时统计 vs 批量统计

**实时统计**（用户行为触发）：
- 阅读数（+1）
- 收藏数（+1/-1）
- 评论数（+1）

**批量统计**（定时任务）：
- 日榜、周榜、月榜
- 独立读者数（去重统计）
- 平均阅读时长

### 3.2 增量更新设计

```go
// 阅读行为触发统计更新
func OnChapterRead(userID, chapterID string, duration int) {
    // 1. 更新章节统计
    chapterStatsRepo.Increment(chapterID, map[string]interface{}{
        "reads": 1,
    })
    
    // 2. 记录读者行为
    behavior := &ReaderBehavior{
        UserID:    userID,
        ChapterID: chapterID,
        Action:    "read",
        Duration:  duration,
        CreatedAt: time.Now(),
    }
    behaviorRepo.Create(behavior)
    
    // 3. 异步更新书籍统计
    go updateBookStats(chapterID)
}
```

### 3.3 独立读者统计（独特设计）

**问题**：如何高效统计独立读者数（去重）？

**解决方案**：HyperLogLog算法（Redis实现）

```go
// 使用HyperLogLog估算独立读者数
func AddUniqueReader(chapterID string, userID string) {
    key := "unique_readers:chapter:" + chapterID
    redis.PFAdd(key, userID)
}

func GetUniqueReaderCount(chapterID string) int64 {
    key := "unique_readers:chapter:" + chapterID
    count := redis.PFCount(key)
    return count
}
```

**优势**：
- 内存占用极小（12KB可统计百万级）
- O(1)时间复杂度
- 误差率<1%

---

## 4. 统计聚合设计

### 4.1 多维度聚合

```go
type StatsAggregation struct {
    BookID      string
    TimeRange   string  // daily/weekly/monthly
    
    TotalReads      int64
    UniqueReaders   int64
    AverageDuration int
    PeakReadTime    string  // 阅读高峰时段
    
    ChapterStats    []ChapterStatsItem
}

// 聚合查询（MongoDB Aggregation Pipeline）
func AggregateBookStats(bookID string, timeRange string) (*StatsAggregation, error) {
    pipeline := []bson.M{
        {"$match": bson.M{
            "bookId": bookID,
            "createdAt": bson.M{"$gte": getStartTime(timeRange)},
        }},
        {"$group": bson.M{
            "_id": nil,
            "totalReads": bson.M{"$sum": 1},
            "uniqueReaders": bson.M{"$addToSet": "$userId"},
            "averageDuration": bson.M{"$avg": "$duration"},
        }},
    }
    
    // 执行聚合
    result := behaviorRepo.Aggregate(pipeline)
    
    return result, nil
}
```

### 4.2 热力图统计

```go
// 章节阅读热力图（识别读者流失点）
type ChapterHeatmap struct {
    ChapterIndex int
    ReadCount    int64
    DropRate     float64  // 流失率
}

func GenerateChapterHeatmap(bookID string) ([]ChapterHeatmap, error) {
    chapters := getChaptersByBook(bookID)
    heatmap := []ChapterHeatmap{}
    
    for i, chapter := range chapters {
        stats := chapterStatsRepo.GetByChapterID(chapter.ID)
        
        dropRate := 0.0
        if i > 0 {
            prevStats := chapterStatsRepo.GetByChapterID(chapters[i-1].ID)
            if prevStats.UniqueReads > 0 {
                dropRate = float64(prevStats.UniqueReads - stats.UniqueReads) / float64(prevStats.UniqueReads) * 100
            }
        }
        
        heatmap = append(heatmap, ChapterHeatmap{
            ChapterIndex: i + 1,
            ReadCount:    stats.UniqueReads,
            DropRate:     dropRate,
        })
    }
    
    return heatmap, nil
}
```

---

## 5. StatsService设计

### 5.1 核心方法

```go
type StatsService interface {
    // GetBookStats 获取书籍统计
    GetBookStats(ctx context.Context, bookID string) (*BookStats, error)
    
    // GetChapterStats 获取章节统计
    GetChapterStats(ctx context.Context, chapterID string) (*ChapterStats, error)
    
    // RecordBehavior 记录用户行为
    RecordBehavior(ctx context.Context, behavior *ReaderBehavior) error
    
    // AggregateStats 聚合统计
    AggregateStats(ctx context.Context, bookID string, timeRange string) (*StatsAggregation, error)
    
    // GenerateHeatmap 生成章节热力图
    GenerateHeatmap(ctx context.Context, bookID string) ([]ChapterHeatmap, error)
}
```

---

## 6. API设计

```
GET /api/v1/stats/books/:bookId              - 获取书籍统计
GET /api/v1/stats/books/:bookId/heatmap      - 获取章节热力图
GET /api/v1/stats/books/:bookId/aggregate    - 聚合统计
POST /api/v1/stats/behavior                  - 记录行为
```

---

## 7. 与v2.1架构的关系

```
Stats Module (统计分析)
  ├─ BookStats (书籍统计)
  ├─ ChapterStats (章节统计)
  ├─ ReaderBehavior (行为记录)
  └─ StatsService (统计服务)
```

**事件订阅**：
```go
// 监听阅读事件自动记录统计
eventBus.Subscribe("chapter.read", recordReadBehavior)
eventBus.Subscribe("book.favorited", updateFavoriteStats)
eventBus.Subscribe("book.commented", updateCommentStats)
```

---

## 8. 实现参考

**代码文件**：
- `models/stats/book_stats.go` - 书籍统计模型
- `models/stats/chapter_stats.go` - 章节统计模型
- `models/stats/reader_behavior.go` - 行为模型
- `service/stats/stats_service.go`（待创建） - 统计服务

---

**文档状态**: ✅ 已完成  
**优先级**: P0

