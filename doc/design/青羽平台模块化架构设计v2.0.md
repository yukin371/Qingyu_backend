# 青羽平台模块化架构设计 v2.1

> **文档版本**: v2.1  
> **最后更新**: 2025-10-21  
> **架构优化**: 2025-10-21 (基于架构改进建议)

## 📋 文档概述

本文档基于青羽项目最新的架构重构（Repository模式、依赖注入、事件驱动），重新规划青羽一站式阅读写作平台的完整模块划分，为模块化开发提供清晰的架构指导。

**v2.1 架构优化重点**：
- ✅ 明确模块边界，实现单一数据源原则
- ✅ 引入Python AI Agent系统，实现Go/Python分层架构
- ✅ 完善事件驱动架构，强制事件发布机制
- ✅ 引入Saga事务模式，保证分布式事务一致性
- ✅ 强制AI流式接口，提升用户体验

## 🎯 设计目标

1. **清晰的模块边界**：每个模块职责明确，便于独立开发和维护
2. **高内聚低耦合**：模块内部功能紧密相关，模块间依赖最小化
3. **可扩展性**：支持未来功能扩展和微服务化改造
4. **可测试性**：每个模块可独立测试，便于质量保障
5. **面向未来**：为AI Agent、高级功能预留扩展空间

---

## 🏗️ 整体架构设计

### 架构分层视图

```
┌────────────────────────────────────────────────────────────────┐
│                      前端应用层 (Frontend)                       │
│           Web端 (Vue3) + 移动端 (Flutter/React Native)          │
├────────────────────────────────────────────────────────────────┤
│                      API网关层 (API Gateway)                    │
│          路由分发 + 认证鉴权 + 限流熔断 + 协议转换              │
├────────────────────────────────────────────────────────────────┤
│                      业务模块层 (Business Modules)              │
│  ┌──────────┬──────────┬──────────┬──────────┬──────────┐     │
│  │ 阅读模块  │ 写作模块  │ AI模块   │ 社交模块  │ 用户模块  │     │
│  └──────────┴──────────┴──────────┴──────────┴──────────┘     │
├────────────────────────────────────────────────────────────────┤
│                     共享服务层 (Shared Services)                │
│  推荐服务 | 消息服务 | 存储服务 | 支付服务 | 搜索服务           │
├────────────────────────────────────────────────────────────────┤
│                     基础设施层 (Infrastructure)                 │
│  数据库(MongoDB) | 缓存(Redis) | 消息队列(RabbitMQ) | OSS       │
└────────────────────────────────────────────────────────────────┘
```

### 技术架构层次

```
┌─────────────────────────────────────────────────────────────────┐
│                    Router Layer (路由层)                         │
│              Gin路由 + 中间件链 + API版本管理                     │
├─────────────────────────────────────────────────────────────────┤
│                     API Layer (接口层)                           │
│          HTTP请求处理 + 参数验证 + 响应构建 + 流式代理            │
├─────────────────────────────────────────────────────────────────┤
│                   Service Layer (业务层)                         │
│    业务逻辑 + 事件发布(强制) + 流程编排 + 依赖注入 + Saga编排     │
├─────────────────────────────────────────────────────────────────┤
│                 Repository Layer (仓储层)                        │
│     数据访问抽象 + 查询封装 + 事务管理 + 缓存策略                 │
├─────────────────────────────────────────────────────────────────┤
│                    Model Layer (模型层)                          │
│           数据模型 + 业务实体 + 验证规则                          │
├────────────────────┬────────────────────────────────────────────┤
│   Data Layer (Go)  │      Python AI Service Layer               │
│   MongoDB + Redis  │   ┌──────────────────────────────────┐    │
│   Elasticsearch    │   │  Python AI Agent Service         │    │
│   MinIO            │   │  - FastAPI服务框架               │    │
│                    │   │  - Agent核心引擎                 │    │
│                    │   │  - 工具调用系统                  │    │
│                    │   │  - RAG检索引擎                   │    │
│                    │   │  - 向量数据库(Milvus/Qdrant)     │    │
│                    │   └──────────────────────────────────┘    │
│                    │            ▲                               │
│                    │            │ gRPC/HTTP                     │
│  Go AI Proxy ──────┼────────────┘                               │
│  (流式代理+熔断)    │                                            │
└────────────────────┴────────────────────────────────────────────┘
```

**关键架构特性**：
1. **Go/Python混合架构**：Go处理高并发API，Python处理AI核心逻辑
2. **强制事件驱动**：核心业务流程必须发布事件
3. **Saga事务模式**：跨服务事务采用Saga补偿机制
4. **流式优先**：AI接口强制使用流式响应

---

## 🔧 架构优化重点说明

### 模块边界优化

基于架构评审，我们对以下模块的职责边界进行了明确划分：

#### 1. Reading Task vs User Level vs Wallet Service

**问题**：用户状态的"单一数据源"被分散，职责不清。

**优化方案**：

| 模块 | 职责 | 数据源 |
|------|------|--------|
| **Reading Task** | 任务定义、进度追踪、完成判定、**触发**奖励事件 | 任务状态 |
| **User Level** | 等级计算、成就解锁、**经验值状态维护** | 经验值(唯一) |
| **Wallet Service** | **代币余额管理**、交易记录、提现处理 | 代币余额(唯一) |

**事件驱动流程**：
```
Reading Task完成 
  → 发布TaskCompletedEvent{经验值, 代币数}
    ├→ User Level订阅 → 增加经验值 → 检查升级 → 发布UserLevelUpEvent
    └→ Wallet Service订阅 → 增加代币 → 记录交易
```

#### 2. Monetization vs Wallet Service

**问题**：财务逻辑和账本管理混在一起，安全隔离不足。

**优化方案**：

| 模块 | 定位 | 职责 |
|------|------|------|
| **Monetization Service** | 业务逻辑层 | 收益计算、分成比例、合约管理、财务报表、提现申请流程 |
| **Wallet Service** | 技术账本层 | 账本记录、余额管理、交易处理、风控检查 |

**协作原则**：
- ✅ Wallet Service是**唯一的资金账本**，任何资金变动必须通过它
- ✅ Monetization Service是**业务流程编排者**，不直接修改账本
- ✅ Monetization调用Wallet API进行记账操作

#### 3. AI Module Go/Python分层

**问题**：Go和Python服务职责不清晰。

**优化方案**：

```
┌──────────────────────────────────────────┐
│      Go Backend (Gin 服务)               │
│  ┌────────────────────────────────┐      │
│  │  AI Proxy Service (Go)         │      │
│  │  - HTTP API接口                │      │
│  │  - 请求验证和转发              │      │
│  │  - 流式响应代理(SSE)           │      │
│  │  - 熔断器和限流                │      │
│  │  - 错误转换                    │      │
│  └──────────┬─────────────────────┘      │
└─────────────┼────────────────────────────┘
              │ gRPC/HTTP
┌─────────────▼────────────────────────────┐
│    Python AI Agent Service (FastAPI)     │
│  ┌────────────────────────────────┐      │
│  │  AI Agent核心逻辑              │      │
│  │  - Agent引擎                   │      │
│  │  - 工具调用执行                │      │
│  │  - RAG检索增强                 │      │
│  │  - Prompt处理                  │      │
│  └────────────────────────────────┘      │
└──────────────────────────────────────────┘
```

**职责明确**：
- **Go层**：高并发、低延迟的API网关，流式响应代理
- **Python层**：AI核心逻辑、复杂计算、工具调用

---

## 📦 核心业务模块划分

## 一、📖 阅读端模块 (Reading Module)

### 模块概述

为用户提供完整的在线阅读体验，包括书城浏览、书籍阅读、社交互动等功能。

### 1.1 书城系统 (Bookstore)

**模块职责**：

- 书籍展示和分类管理
- 榜单排行和推荐位管理
- 书籍搜索和筛选
- Banner和运营活动

**核心功能**：

```
bookstore/
├── 书籍管理 (Book Management)
│   ├── 书籍CRUD
│   ├── 书籍分类
│   ├── 书籍标签
│   └── 书籍状态管理
├── 榜单系统 (Ranking System)
│   ├── 实时榜
│   ├── 周榜/月榜
│   ├── 新人榜
│   └── 分类榜
├── 搜索功能 (Search)
│   ├── 全文搜索
│   ├── 高级筛选
│   ├── 搜索建议
│   └── 搜索统计
└── Banner管理 (Banner)
    ├── 轮播Banner
    ├── 推荐位
    └── 活动入口
```

**数据模型**：

- `Book`：书籍基本信息
- `Category`：分类信息
- `Banner`：Banner配置
- `BookStatistics`：书籍统计数据

**对外接口**：

```go
type BookstoreService interface {
    // 书籍管理
    GetBook(ctx context.Context, bookID string) (*Book, error)
    ListBooks(ctx context.Context, filter BookFilter) (*PagedBooks, error)
    SearchBooks(ctx context.Context, keyword string) ([]*Book, error)
  
    // 榜单管理
    GetRankingList(ctx context.Context, rankType string) ([]*Book, error)
    UpdateRanking(ctx context.Context) error
  
    // Banner管理
    GetBanners(ctx context.Context, position string) ([]*Banner, error)
}
```

**依赖关系**：

- ⬆️ 依赖：推荐服务、搜索服务、存储服务
- ⬇️ 被依赖：阅读器模块、社交模块

### 1.2 阅读器 (Reader)

**模块职责**：

- 章节内容展示
- 阅读设置管理
- 阅读进度同步
- 书签和笔记功能

**核心功能**：

```
reader/
├── 章节管理 (Chapter Management)
│   ├── 章节获取
│   ├── 章节导航
│   ├── 章节缓存
│   └── 付费章节控制
├── 阅读设置 (Reading Settings)
│   ├── 字体设置
│   ├── 主题设置
│   ├── 翻页模式
│   └── 护眼模式
├── 阅读记录 (Reading History)
│   ├── 进度记录
│   ├── 历史同步
│   ├── 多端同步
│   └── 离线阅读
├── 书签笔记 (Bookmark & Notes)
│   ├── 书签管理
│   ├── 笔记管理
│   ├── 高亮标注
│   └── 导出功能
└── 生词本 (Vocabulary)
    ├── 划词查询
    ├── 生词收藏
    ├── 复习提醒
    └── 导出单词
```

**数据模型**：

- `ReadingProgress`：阅读进度
- `Bookmark`：书签
- `Note`：笔记
- `ReadingSettings`：阅读设置
- `Vocabulary`：生词本

**对外接口**：

```go
type ReaderService interface {
    // 章节管理
    GetChapter(ctx context.Context, bookID, chapterID string) (*Chapter, error)
    GetChapterList(ctx context.Context, bookID string) ([]*ChapterInfo, error)
  
    // 阅读进度
    SaveProgress(ctx context.Context, userID, bookID string, progress ReadingProgress) error
    GetProgress(ctx context.Context, userID, bookID string) (*ReadingProgress, error)
  
    // 书签笔记
    AddBookmark(ctx context.Context, bookmark *Bookmark) error
    AddNote(ctx context.Context, note *Note) error
    GetBookmarks(ctx context.Context, userID, bookID string) ([]*Bookmark, error)
}
```

### 1.3 推荐系统 (Recommendation)

**模块职责**：

- 个性化推荐算法
- 用户画像构建
- 推荐效果评估

**核心功能**：

```
recommendation/
├── 推荐算法 (Algorithm)
│   ├── 协同过滤
│   ├── 内容推荐
│   ├── 深度学习模型
│   └── 混合推荐
├── 用户画像 (User Profile)
│   ├── 行为分析
│   ├── 偏好建模
│   ├── 标签提取
│   └── 画像更新
├── 推荐策略 (Strategy)
│   ├── 冷启动处理
│   ├── 多样性控制
│   ├── 新颖性保证
│   └── A/B测试
└── 效果评估 (Evaluation)
    ├── 点击率统计
    ├── 转化率分析
    ├── 用户反馈
    └── 效果优化
```

**对外接口**：

```go
type RecommendationService interface {
    GetPersonalizedRecommendations(ctx context.Context, userID string, limit int) ([]*Book, error)
    GetSimilarBooks(ctx context.Context, bookID string, limit int) ([]*Book, error)
    GetHotBooks(ctx context.Context, category string, limit int) ([]*Book, error)
    UpdateUserProfile(ctx context.Context, userID string, behavior UserBehavior) error
}
```

### 1.4 社交系统 (Social)

**模块职责**：

- 评论和互动
- 用户关系管理
- 社区运营

**核心功能**：

```
social/
├── 评论系统 (Comment)
│   ├── 段评功能
│   ├── 章评功能
│   ├── 书评功能
│   ├── 评论点赞
│   └── 评论举报
├── 互动功能 (Interaction)
│   ├── 点赞收藏
│   ├── 分享转发
│   ├── 打赏功能
│   └── 投票功能
├── 用户关系 (Relationship)
│   ├── 关注系统
│   ├── 粉丝管理
│   ├── 好友系统
│   └── 黑名单
└── 书圈功能 (Book Circle)
    ├── 话题圈创建
    ├── 圈内发帖
    ├── 帖子管理
    └── 圈子运营
```

**数据模型**：

- `Comment`：评论
- `Like`：点赞
- `Follow`：关注关系
- `BookCircle`：书圈
- `Post`：帖子

**对外接口**：

```go
type SocialService interface {
    // 评论管理
    AddComment(ctx context.Context, comment *Comment) error
    GetComments(ctx context.Context, targetID string, commentType string) ([]*Comment, error)
    LikeComment(ctx context.Context, userID, commentID string) error
  
    // 用户关系
    Follow(ctx context.Context, followerID, followeeID string) error
    Unfollow(ctx context.Context, followerID, followeeID string) error
    GetFollowers(ctx context.Context, userID string) ([]*User, error)
}
```

### 1.5 阅读任务 (Reading Task)

**模块职责**：

- 阅读打卡和激励
- 任务系统
- 成就系统

**核心功能**：

```
reading_task/
├── 每日打卡 (Daily Check-in)
│   ├── 阅读时长统计
│   ├── 打卡记录
│   ├── 连续打卡
│   └── 打卡奖励
├── 任务系统 (Task System)
│   ├── 每日任务
│   ├── 周任务
│   ├── 活动任务
│   └── 任务奖励
├── 成就系统 (Achievement)
│   ├── 成就解锁
│   ├── 勋章系统
│   ├── 等级体系
│   └── 排行榜
└── 代币奖励 (Token Reward)
    ├── 代币发放
    ├── 代币消费
    ├── 代币记录
    └── 代币兑换
```

---

## 二、✍️ 写作端模块 (Writing Module)

### 模块概述

为作者提供专业的写作工具和创作环境，支持AI辅助创作、作品管理、数据分析等功能。

### 2.1 编辑器系统 (Editor)

**模块职责**：

- 富文本编辑
- Markdown编辑
- 实时保存和协作

**核心功能**：

```
editor/
├── 双模式编辑器 (Dual Mode Editor)
│   ├── 富文本模式
│   ├── Markdown模式
│   ├── 模式切换
│   └── 实时预览
├── 编辑功能 (Editing Features)
│   ├── 文本格式化
│   ├── 图片插入
│   ├── 表格编辑
│   ├── 代码块
│   └── 数学公式
├── 自动保存 (Auto Save)
│   ├── 定时保存
│   ├── 编辑状态检测
│   ├── 保存失败重试
│   └── 离线编辑支持
├── 协作编辑 (Collaboration)
│   ├── 多人实时协作
│   ├── 冲突解决
│   ├── 权限管理
│   └── 协作历史
└── 版本控制 (Version Control)
    ├── 历史版本记录
    ├── 版本对比
    ├── 版本回滚
    └── 分支管理
```

**对外接口**：

```go
type EditorService interface {
    SaveContent(ctx context.Context, projectID, documentID string, content Content) error
    GetContent(ctx context.Context, projectID, documentID string) (*Content, error)
    AutoSave(ctx context.Context, projectID, documentID string, content Content) error
    CreateVersion(ctx context.Context, projectID, documentID string, versionInfo VersionInfo) error
}
```

### 2.2 项目管理 (Project Management)

**模块职责**：

- 作品项目管理
- 文档组织
- 协作者管理

**核心功能**：

```
project_management/
├── 项目管理 (Project)
│   ├── 项目CRUD
│   ├── 项目配置
│   ├── 项目归档
│   └── 项目导入导出
├── 文档管理 (Document)
│   ├── 文档树结构
│   ├── 章节管理
│   ├── 文档移动
│   └── 文档搜索
├── 大纲管理 (Outline)
│   ├── 大纲编辑
│   ├── 大纲视图
│   ├── 大纲导出
│   └── 大纲模板
└── 协作管理 (Collaboration)
    ├── 协作者邀请
    ├── 权限分配
    ├── 协作日志
    └── 协作通知
```

### 2.3 设定百科 (Encyclopedia)

**模块职责**：

- 世界观设定管理
- 角色/地点/时间线管理
- 设定引用

**核心功能**：

```
encyclopedia/
├── 角色设定 (Character)
│   ├── 角色卡管理
│   ├── 角色关系图
│   ├── 角色发展线
│   └── 角色模板
├── 地图设定 (Location)
│   ├── 地图编辑器
│   ├── 地点管理
│   ├── 路径规划
│   └── 地图图层
├── 时间线 (Timeline)
│   ├── 时间轴编辑
│   ├── 事件管理
│   ├── 时间线视图
│   └── 时间线导出
├── 功法/物品设定 (Items)
│   ├── 功法系统
│   ├── 道具管理
│   ├── 技能树
│   └── 装备系统
└── 设定模板 (Templates)
    ├── 预设模板
    ├── 自定义模板
    ├── 模板市场
    └── 模板导入导出
```

**数据模型**：

- `Character`：角色设定
- `Location`：地点设定
- `Timeline`：时间线
- `Setting`：设定项
- `SettingTemplate`：设定模板

### 2.4 AI写作助手 (AI Writing Assistant)

**模块职责**：

- AI续写和改写
- 创意辅助
- 文本优化

**核心功能**：

```
ai_writing_assistant/
├── 智能续写 (Continuation)
│   ├── 段落续写
│   ├── 情节续写
│   ├── 对话生成
│   └── 场景描述
├── 文本改写 (Rewriting)
│   ├── 语句优化
│   ├── 风格转换
│   ├── 扩写缩写
│   └── 润色修饰
├── 创意辅助 (Creative Assist)
│   ├── 情节建议
│   ├── 角色塑造建议
│   ├── 冲突设计
│   └── 高潮铺垫
└── 智能分析 (Analysis)
    ├── 文风分析
    ├── 情感分析
    ├── 节奏分析
    └── 质量评估
```

### 2.5 内容审核 (Content Review)

**模块职责**：

- 敏感词检测
- 合规审核
- 质量检查

**核心功能**：

```
content_review/
├── 敏感词检测 (Sensitive Word)
│   ├── 敏感词库管理
│   ├── 实时检测
│   ├── 智能替换建议
│   └── 检测报告
├── 合规审核 (Compliance)
│   ├── 版权检测
│   ├── 原创度检测
│   ├── 合规建议
│   └── 审核记录
└── 质量检查 (Quality Check)
    ├── 错别字检测
    ├── 语法检查
    ├── 标点检查
    └── 一键修复
```

### 2.6 数据统计 (Analytics)

**模块职责**：

- 作品数据统计
- 读者画像分析
- 收益统计

**核心功能**：

```
analytics/
├── 阅读数据 (Reading Data)
│   ├── 阅读量统计
│   ├── 完读率分析
│   ├── 跳章率分析
│   └── 阅读热力图
├── 读者画像 (Reader Profile)
│   ├── 年龄分布
│   ├── 性别分析
│   ├── 地域分布
│   └── 偏好分析
├── 互动数据 (Interaction Data)
│   ├── 评论统计
│   ├── 点赞收藏
│   ├── 打赏统计
│   └── 分享传播
└── 收益统计 (Revenue)
    ├── 订阅收入
    ├── 打赏收入
    ├── 广告收入
    └── 收益趋势
```

### 2.7 稿费结算 (Monetization)

**模块职责**：

- 收益计算
- 提现管理
- 财务报表

**核心功能**：

```
monetization/
├── 收入管理 (Income)
│   ├── 订阅分成
│   ├── 打赏分成
│   ├── 广告分成
│   └── 版权收入
├── 提现管理 (Withdrawal)
│   ├── 提现申请
│   ├── 提现审核
│   ├── 支付宝提现
│   └── 微信提现
├── 财务报表 (Financial Report)
│   ├── 收入明细
│   ├── 结算记录
│   ├── 税务处理
│   └── 发票管理
└── 合约管理 (Contract)
    ├── 签约管理
    ├── 合同条款
    ├── 分成比例
    └── 合约到期提醒
```

---

## 三、🤖 AI服务模块 (AI Module)

### 模块概述

提供统一的AI服务接口，支持多AI提供商接入，提供智能对话、内容生成等功能。

### 3.1 AI服务架构 (AI Service Architecture)

**模块职责**：

- 统一AI服务接口
- 多提供商适配
- 智能路由和负载均衡

**核心功能**：

```
ai_service_architecture/
├── 统一接口 (Unified Interface)
│   ├── 文本生成接口
│   ├── 对话接口
│   ├── 图像生成接口
│   └── 语音接口
├── 智能路由 (Smart Routing)
│   ├── 负载均衡
│   ├── 服务选择
│   ├── 故障转移
│   └── 性能监控
├── 配置管理 (Configuration)
│   ├── 模型配置
│   ├── 参数配置
│   ├── 密钥管理
│   └── 动态更新
└── 健康检查 (Health Check)
    ├── 服务状态监控
    ├── 可用性检测
    ├── 性能指标
    └── 告警机制
```

**对外接口**：

```go
type AIService interface {
    // 文本生成
    GenerateText(ctx context.Context, req *GenerateTextRequest) (*GenerateTextResponse, error)
    GenerateTextStream(ctx context.Context, req *GenerateTextRequest) (<-chan *StreamChunk, error)
  
    // 对话管理
    Chat(ctx context.Context, req *ChatRequest) (*ChatResponse, error)
    ChatStream(ctx context.Context, req *ChatRequest) (<-chan *StreamChunk, error)
  
    // 模型管理
    ListModels(ctx context.Context) ([]*ModelInfo, error)
    GetModelInfo(ctx context.Context, modelID string) (*ModelInfo, error)
}
```

### 3.2 AI适配器 (AI Adapters)

**模块职责**：

- 多AI提供商接入
- 协议适配和转换
- 错误处理

**核心功能**：

```
ai_adapters/
├── OpenAI适配器 (OpenAI Adapter)
│   ├── GPT-4接入
│   ├── GPT-3.5接入
│   ├── 流式响应处理
│   └── 错误处理
├── Claude适配器 (Claude Adapter)
│   ├── Claude-3接入
│   ├── 长上下文支持
│   ├── 安全过滤
│   └── 响应转换
├── 国产AI适配器 (Domestic AI)
│   ├── 文心一言
│   ├── 通义千问
│   ├── 混元
│   └── 豆包
├── 开源模型适配器 (Open Source)
│   ├── Llama接入
│   ├── ChatGLM接入
│   ├── Qwen接入
│   └── 本地部署支持
└── 适配器工厂 (Adapter Factory)
    ├── 适配器注册
    ├── 适配器创建
    ├── 适配器管理
    └── 适配器选择
```

**适配器接口**：

```go
type AIAdapter interface {
    GetProviderName() string
    GetModelList() []string
    Generate(ctx context.Context, req *GenerateRequest) (*GenerateResponse, error)
    GenerateStream(ctx context.Context, req *GenerateRequest) (<-chan *StreamChunk, error)
    Health(ctx context.Context) error
}
```

### 3.3 上下文管理 (Context Management)

**模块职责**：

- 对话上下文存储
- 上下文检索优化
- 长上下文处理

**核心功能**：

```
context_management/
├── 上下文存储 (Context Storage)
│   ├── 短期上下文（Redis）
│   ├── 长期上下文（MongoDB）
│   ├── 压缩存储
│   └── 过期管理
├── 上下文检索 (Context Retrieval)
│   ├── 相似度检索
│   ├── 关键词检索
│   ├── 时间序列检索
│   └── 智能排序
├── 上下文优化 (Context Optimization)
│   ├── 上下文压缩
│   ├── 无关信息过滤
│   ├── 重要信息提取
│   └── Token优化
└── 小说上下文 (Novel Context)
    ├── 角色记忆
    ├── 情节记忆
    ├── 世界观记忆
    └── 风格记忆
```

### 3.4 AI聊天功能 (AI Chat)

**模块职责**：

- 智能对话
- 会话管理
- 多轮对话

**核心功能**：

```
ai_chat/
├── 会话管理 (Session Management)
│   ├── 会话创建
│   ├── 会话持久化
│   ├── 会话恢复
│   └── 会话清理
├── 对话处理 (Dialogue Processing)
│   ├── 意图识别
│   ├── 实体提取
│   ├── 上下文关联
│   └── 回复生成
├── 流式响应 (Streaming)
│   ├── SSE推送
│   ├── WebSocket推送
│   ├── 流式解析
│   └── 错误恢复
└── 对话记录 (Chat History)
    ├── 历史存储
    ├── 历史检索
    ├── 历史导出
    └── 历史分析
```

### 3.5 Agent系统 (Agent System) 🆕

**模块职责**：

- AI Agent框架
- 多Agent协作
- 工具调用

**核心功能**：

```
agent_system/
├── Agent框架 (Agent Framework)
│   ├── Agent基类
│   ├── Agent生命周期
│   ├── Agent通信协议
│   └── Agent注册管理
├── 专业Agent (Specialized Agents)
│   ├── 创作Agent
│   │   ├── 情节设计Agent
│   │   ├── 角色塑造Agent
│   │   ├── 对话生成Agent
│   │   └── 场景描写Agent
│   ├── 分析Agent
│   │   ├── 文本分析Agent
│   │   ├── 情感分析Agent
│   │   ├── 质量评估Agent
│   │   └── 数据分析Agent
│   ├── 审核Agent
│   │   ├── 内容审核Agent
│   │   ├── 合规检查Agent
│   │   └── 原创度检测Agent
│   └── 助手Agent
│       ├── 写作助手Agent
│       ├── 阅读助手Agent
│       └── 客服Agent
├── 工具调用 (Tool Calling) 🔧
│   ├── 工具注册框架
│   │   ├── 工具接口定义
│   │   ├── 工具元数据管理
│   │   ├── 权限控制
│   │   └── 版本管理
│   ├── 写作工具集成 ⭐
│   │   ├── 大纲工具
│   │   │   ├── 自动生成大纲（三幕式、英雄之旅等）
│   │   │   ├── 章节规划
│   │   │   ├── 情节发展建议
│   │   │   └── 大纲CRUD操作
│   │   ├── 角色卡工具
│   │   │   ├── 自动创建角色档案
│   │   │   ├── 角色发展弧线设计
│   │   │   ├── 角色冲突分析
│   │   │   └── 角色卡CRUD操作
│   │   ├── 关系图谱工具
│   │   │   ├── 自动生成角色关系网络
│   │   │   ├── 关系演变追踪
│   │   │   ├── 冲突关系可视化
│   │   │   └── 关系更新操作
│   │   ├── 时间线工具
│   │   │   ├── 自动构建故事时间线
│   │   │   ├── 多线索并行管理
│   │   │   ├── 时间线冲突检测
│   │   │   └── 事件添加/查询
│   │   ├── 世界观设定工具
│   │   │   ├── 世界观框架搭建
│   │   │   ├── 设定一致性检查
│   │   │   ├── 地点/组织/势力管理
│   │   │   └── 设定CRUD操作
│   │   ├── 设定百科工具
│   │   │   ├── 查询已有设定
│   │   │   ├── 自动关联相关设定
│   │   │   ├── 设定归档
│   │   │   └── 全文搜索
│   │   ├── 文档操作工具
│   │   │   ├── 读取文档内容
│   │   │   ├── 修改文档内容
│   │   │   ├── 版本管理
│   │   │   └── 批量操作
│   │   └── 数据统计工具
│   │       ├── 字数统计
│   │       ├── 章节分析
│   │       ├── 角色出场频率
│   │       └── 数据导出
│   ├── 通用工具集成
│   │   ├── 搜索工具（全文/语义搜索）
│   │   ├── 知识库查询
│   │   ├── 外部API调用
│   │   └── 文件处理
│   ├── 工具执行引擎
│   │   ├── 参数验证
│   │   ├── 权限检查
│   │   ├── 执行监控
│   │   └── 结果缓存
│   └── 错误处理
│       ├── 工具调用失败重试
│       ├── 降级策略
│       ├── 错误日志记录
│       └── 用户友好提示
├── Agent协作 (Agent Collaboration)
│   ├── 多Agent编排
│   ├── 任务分配
│   ├── 结果汇总
│   └── 冲突解决
└── Agent记忆 (Agent Memory)
    ├── 短期记忆
    ├── 长期记忆
    ├── 工作记忆
    └── 知识库
```

**🔥 核心特性：Agent工具调用系统**

Agent系统最大的创新在于能够**直接调用写作端的工具**，实现从"文本生成"到"操作执行"的跨越：

| 能力维度             | 传统AI助手       | 青羽AI Agent       |
| -------------------- | ---------------- | ------------------ |
| **文本生成**   | ✅ 生成建议文本  | ✅ 生成建议文本    |
| **工具操作**   | ❌ 不能操作工具  | ✅ 能调用写作工具  |
| **自动化程度** | 需要用户手动执行 | 自动执行并反馈结果 |
| **效率提升**   | 2-3倍            | 10倍+              |

**使用场景示例**：

```
场景1：快速创建小说框架
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
用户: "我想写一部修仙小说，主角叫林风"

Agent自动执行：
1. 创作Agent调用【大纲工具】
   → 生成修仙小说大纲（入门→历练→突破→飞升）
2. 创作Agent调用【角色卡工具】
   → 创建主角林风的角色卡（天赋、性格、背景）
   → 创建配角（师父、宿敌、女主）
3. 创作Agent调用【关系图谱工具】
   → 生成角色关系网络图
4. 创作Agent调用【世界观工具】
   → 构建修炼体系、门派势力、灵石系统
5. 创作Agent调用【时间线工具】
   → 创建主线时间线
6. 助手Agent调用【设定百科工具】
   → 将所有设定归档到百科

⏱️ 耗时：约3分钟
📊 输出：完整的创作框架，可直接开始写作

传统方式需要：数小时甚至数天
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

场景2：设定一致性检查
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
用户: "帮我检查全文设定是否有矛盾"

Agent自动执行：
1. 助手Agent调用【文档操作工具】
   → 读取所有章节内容
2. 助手Agent调用【设定百科工具】
   → 读取所有设定（角色、世界观、时间线）
3. 分析Agent调用【设定一致性检查工具】
   → 扫描全文，标注矛盾点
   → 检测到：第5章林风使用了第10章才学会的功法
4. 分析Agent调用【时间线验证工具】
   → 检查时间线逻辑
   → 检测到：第8章的时间点早于第7章
5. 助手Agent整理生成报告
   → 列出所有问题点和修改建议

⏱️ 耗时：约1分钟
📊 输出：详细的问题报告和修改建议

人工检查需要：数小时阅读全文
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**Agent接口设计**：

```go
type Agent interface {
    GetName() string
    GetDescription() string
    GetCapabilities() []string
    Execute(ctx context.Context, task *Task) (*Result, error)
    RegisterTool(tool Tool) error
    Collaborate(ctx context.Context, agents []Agent, task *Task) (*Result, error)
}

type CreativeAgent struct {
    aiService AIService
    tools     []Tool
    memory    Memory
}

func (a *CreativeAgent) Execute(ctx context.Context, task *Task) (*Result, error) {
    // 1. 理解任务
    understanding := a.understandTask(task)
  
    // 2. 规划步骤
    plan := a.planSteps(understanding)
  
    // 3. 执行计划
    for _, step := range plan {
        result := a.executeStep(step)
        if result.NeedTool {
            toolResult := a.callTool(step.Tool, step.Input)
            result.Merge(toolResult)
        }
    }
  
    // 4. 汇总结果
    return a.summarizeResults(results)
}
```

### 3.6 RAG检索增强系统 (RAG System) 🆕

**模块职责**：

- 智能向量检索
- 知识库管理
- 检索结果增强

**核心功能**：

```
rag_system/
├── 向量化引擎 (Vectorization Engine)
│   ├── 文本向量化
│   │   ├── 文档预处理（分词、清洗）
│   │   ├── 文本分块（chunk splitting）
│   │   ├── 向量编码（embedding）
│   │   └── 批量向量化
│   ├── 向量模型管理
│   │   ├── OpenAI text-embedding-ada-002
│   │   ├── 中文向量模型（BGE、M3E）
│   │   ├── 多语言模型支持
│   │   └── 模型热切换
│   └── 向量缓存
│       ├── 向量结果缓存
│       ├── LRU淘汰策略
│       └── 缓存预热
├── 知识库管理 (Knowledge Base Management)
│   ├── 用户私有知识库
│   │   ├── 项目文档索引
│   │   ├── 角色卡索引
│   │   ├── 大纲索引
│   │   ├── 设定百科索引
│   │   ├── 对话历史索引
│   │   └── 素材库索引
│   ├── 平台知识库
│   │   ├── 优秀作品库
│   │   ├── 写作技巧库
│   │   ├── 类型套路库
│   │   ├── FAQ知识库
│   │   └── 平台文档库
│   ├── 外部知识库
│   │   ├── 历史知识库
│   │   ├── 地理知识库
│   │   ├── 科学知识库
│   │   ├── 文化知识库
│   │   └── 百科知识库
│   └── 知识库同步
│       ├── 增量索引
│       ├── 全量重建
│       ├── 自动更新检测
│       └── 版本管理
├── 向量检索引擎 (Vector Search Engine)
│   ├── 向量数据库集成
│   │   ├── Milvus集成
│   │   ├── Qdrant集成
│   │   ├── Elasticsearch Vector集成
│   │   └── 多库支持
│   ├── 检索策略
│   │   ├── 语义检索（向量相似度）
│   │   ├── 关键词检索（BM25）
│   │   ├── 混合检索（hybrid search）
│   │   ├── 多路召回（multi-recall）
│   │   └── 智能重排序（rerank）
│   ├── 检索优化
│   │   ├── 索引优化（HNSW、IVF）
│   │   ├── 查询优化（query rewrite）
│   │   ├── 过滤优化（metadata filter）
│   │   ├── 结果去重
│   │   └── 相关性打分
│   └── 检索配置
│       ├── Top-K配置
│       ├── 相似度阈值
│       ├── 检索范围限定
│       └── 权重配置
├── RAG工作流引擎 (RAG Workflow Engine)
│   ├── 查询处理
│   │   ├── 意图识别
│   │   ├── 实体提取
│   │   ├── 查询重写
│   │   ├── 查询扩展
│   │   └── 多查询生成
│   ├── 检索编排
│   │   ├── 多源并行检索
│   │   ├── 检索结果融合
│   │   ├── 结果过滤
│   │   ├── 相关性排序
│   │   └── Top-K选择
│   ├── 上下文构建
│   │   ├── Prompt模板管理
│   │   ├── 上下文拼接
│   │   ├── Token长度控制
│   │   ├── 引用标注
│   │   └── 元数据注入
│   ├── 生成增强
│   │   ├── RAG增强提示词
│   │   ├── 多轮对话支持
│   │   ├── 上下文记忆
│   │   └── 结果后处理
│   └── 质量评估
│       ├── 检索质量评估
│       ├── 生成质量评估
│       ├── 相关性评分
│       └── 反馈收集
└── 性能监控 (Performance Monitoring)
    ├── 检索性能监控
    │   ├── 检索延迟统计
    │   ├── 检索准确率统计
    │   ├── 召回率统计
    │   └── 性能告警
    ├── 向量化性能监控
    │   ├── 向量化速度
    │   ├── 批处理吞吐量
    │   ├── 失败率统计
    │   └── 队列监控
    └── 资源监控
        ├── 向量数据库资源
        ├── 缓存命中率
        ├── 存储空间使用
        └── 成本统计
```

**RAG应用场景设计**：

```
场景1：智能写作续写
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
用户输入："帮我续写主角林风和反派血魔的对决场景"

RAG工作流：
1. 意图识别：写作续写请求，涉及两个角色
2. 实体提取：主角=林风，反派=血魔
3. 多源检索：
   ├─ 检索【角色卡】→ 林风能力、性格、战斗风格
   ├─ 检索【角色卡】→ 血魔能力、性格、战斗风格
   ├─ 检索【已写章节】→ 前面的战斗描写风格
   ├─ 检索【世界观】→ 修炼体系、法术设定
   └─ 检索【平台作品库】→ 优秀的对决场景参考
4. 结果融合排序：按相关性排序Top-10
5. 构建上下文：
```

   基于以下设定续写战斗场景：

   【林风能力】：剑修，擅长"无影剑诀"，速度极快
   【血魔能力】：血道魔功，可操控鲜血，防御强大
   【修炼等级】：林风筑基后期，血魔金丹初期
   【战斗风格】：林风以速度取胜，血魔以力量压制
   【参考场景】：（引用平台优秀作品的战斗描写）

   请续写林风和血魔的对决场景，要符合人设和实力差距...

```
6. AI生成：创作Agent基于RAG上下文生成战斗场景
7. 引用标注：标注设定来源（角色卡ID、章节ID等）

输出结果：
✅ 符合人设的战斗场景
✅ 逻辑连贯，不会出现能力矛盾
✅ 可追溯信息来源
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

场景2：设定问答
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
用户输入："我的小说中修炼等级分为哪几个阶段？"

RAG工作流：
1. 意图识别：设定查询请求
2. 查询重写："修炼等级"、"境界划分"、"实力阶段"
3. 检索【世界观设定】：
   ├─ 找到"修炼体系"设定文档
   ├─ 找到相关章节中的等级描述
   └─ 找到角色卡中的修为记录
4. 结果去重合并
5. 构建回答：
```

   根据您的设定，修炼等级分为以下阶段：

1. 炼气期（1-9层）- 来源：世界观设定第3页
2. 筑基期（初期/中期/后期）- 来源：第5章描述
3. 金丹期（初期/中期/后期）- 来源：第12章描述
4. 元婴期 - 来源：世界观设定第5页
5. 化神期 - 来源：角色卡"掌门"

   当前主角林风处于：筑基后期（第50章）

```

输出结果：
✅ 准确的设定信息
✅ 可追溯的来源引用
✅ 避免了AI幻觉
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

场景3：阅读助手问答
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
读者输入："第50章提到的'天机阁'是什么组织？"

RAG工作流：
1. 意图识别：书籍内容查询
2. 实体提取：组织名="天机阁"，章节=50
3. 检索【书籍章节】：
   ├─ 检索第1-50章中所有提到"天机阁"的段落
   ├─ Top-5相关段落
4. 上下文构建：
```

   根据书籍内容，"天机阁"的相关信息如下：

   【第15章】首次提到：天机阁是大陆最神秘的情报组织...
   【第28章】详细介绍：天机阁有三大堂口，分别掌管...
   【第45章】重要情节：主角从天机阁购买了敌人的情报...
   【第50章】最新出现：天机阁阁主现身，实力深不可测...

```
5. AI整合回答

输出结果：
✅ 综合全书信息的完整回答
✅ 标注出处章节，方便回看
✅ 帮助读者理解剧情
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**技术架构**：

```
┌─────────────────────────────────────────────────────────┐
│                     应用层 (Application)                 │
│  写作助手、阅读助手、设定问答、灵感激发                  │
├─────────────────────────────────────────────────────────┤
│                   RAG工作流层 (Workflow)                 │
│  查询理解 → 多源检索 → 结果融合 → 上下文构建 → AI生成    │
├─────────────────────────────────────────────────────────┤
│                   检索引擎层 (Search Engine)              │
│  ┌──────────┬──────────┬──────────┬──────────┐          │
│  │ 语义检索  │ 关键词   │ 混合检索  │ 重排序   │          │
│  └──────────┴──────────┴──────────┴──────────┘          │
├─────────────────────────────────────────────────────────┤
│                 向量数据库层 (Vector DB)                  │
│  ┌──────────┬──────────┬──────────┐                     │
│  │  Milvus  │  Qdrant  │   ES     │                     │
│  └──────────┴──────────┴──────────┘                     │
├─────────────────────────────────────────────────────────┤
│                   知识库层 (Knowledge Base)               │
│  ┌──────────┬──────────┬──────────┐                     │
│  │ 用户私有  │ 平台公共  │ 外部知识  │                     │
│  └──────────┴──────────┴──────────┘                     │
└─────────────────────────────────────────────────────────┘
```

**对外接口**：

```go
type RAGService interface {
    // 向量化文档
    VectorizeDocument(ctx context.Context, doc *Document) error
    VectorizeBatch(ctx context.Context, docs []*Document) error
  
    // 检索
    Search(ctx context.Context, query string, options SearchOptions) (*SearchResult, error)
    SemanticSearch(ctx context.Context, query string, topK int) ([]*SearchResult, error)
    HybridSearch(ctx context.Context, query string, options HybridOptions) ([]*SearchResult, error)
  
    // RAG增强生成
    RAGGenerate(ctx context.Context, query string, options RAGOptions) (*RAGResponse, error)
  
    // 知识库管理
    IndexDocument(ctx context.Context, doc *Document, knowledgeBase string) error
    UpdateIndex(ctx context.Context, docID string, doc *Document) error
    DeleteFromIndex(ctx context.Context, docID string) error
  
    // 知识库查询
    GetKnowledgeBases(ctx context.Context, userID string) ([]*KnowledgeBase, error)
    GetDocumentsByKB(ctx context.Context, kbID string) ([]*Document, error)
}

type SearchOptions struct {
    TopK            int               // 返回Top-K结果
    Threshold       float32           // 相似度阈值
    KnowledgeBases  []string          // 检索的知识库列表
    Filters         map[string]string // 元数据过滤
    Rerank          bool              // 是否重排序
}

type RAGOptions struct {
    SearchOptions   SearchOptions
    MaxContextLen   int               // 最大上下文长度
    IncludeCitations bool             // 是否包含引用
    Temperature     float32           // 生成温度
}

type RAGResponse struct {
    Answer      string              // AI生成的回答
    Sources     []*Source           // 信息来源
    Confidence  float32             // 置信度
    SearchTime  int64               // 检索耗时(ms)
    GenerateTime int64              // 生成耗时(ms)
}

type Source struct {
    DocumentID   string             // 文档ID
    DocumentType string             // 文档类型（角色卡/章节/设定）
    Content      string             // 引用内容
    Score        float32            // 相关性得分
    Location     string             // 位置信息（章节号/页码）
}
```

### 3.7 配额管理 (Quota Management)

**模块职责**：

- API调用配额控制
- 成本管理
- 使用统计

**核心功能**：

```
quota_management/
├── 配额控制 (Quota Control)
│   ├── 用户配额
│   ├── 项目配额
│   ├── API配额
│   └── Token配额
├── 成本管理 (Cost Management)
│   ├── 成本统计
│   ├── 成本预警
│   ├── 预算控制
│   └── 成本优化
├── 使用统计 (Usage Statistics)
│   ├── 调用次数统计
│   ├── Token使用统计
│   ├── 成本统计
│   └── 效率分析
└── 缓存优化 (Cache Optimization)
    ├── 响应缓存
    ├── 相似查询检测
    ├── 缓存命中率
    └── 成本节省统计
```

---

## 四、👤 用户中心模块 (User Module)

### 模块概述

提供统一的用户管理、认证授权、角色权限等功能。

### 4.1 用户管理 (User Management)

**模块职责**：

- 用户注册登录
- 用户信息管理
- 多端登录管理

**核心功能**：

```
user_management/
├── 认证服务 (Authentication)
│   ├── 用户注册
│   ├── 用户登录
│   ├── 邮箱验证
│   ├── 手机验证
│   ├── 第三方登录
│   │   ├── 微信登录
│   │   ├── QQ登录
│   │   └── GitHub登录
│   └── 双因素认证(2FA)
├── 用户信息 (User Profile)
│   ├── 基本信息
│   ├── 个人资料
│   ├── 头像管理
│   └── 账号设置
├── 会话管理 (Session)
│   ├── Token管理
│   ├── 多端登录
│   ├── 设备管理
│   └── 在线状态
└── 账号安全 (Security)
    ├── 密码管理
    ├── 安全问题
    ├── 登录日志
    └── 异常检测
```

**对外接口**：

```go
type UserService interface {
    Register(ctx context.Context, req *RegisterRequest) (*RegisterResponse, error)
    Login(ctx context.Context, req *LoginRequest) (*LoginResponse, error)
    Logout(ctx context.Context, userID, token string) error
    GetProfile(ctx context.Context, userID string) (*UserProfile, error)
    UpdateProfile(ctx context.Context, userID string, profile *UserProfile) error
}
```

### 4.2 角色权限 (Role Permission) 🆕

**模块职责**：

- RBAC权限管理
- 角色管理
- 权限检查

**核心功能**：

```
role_permission/
├── 角色管理 (Role Management)
│   ├── 系统角色
│   │   ├── 超级管理员
│   │   ├── 平台管理员
│   │   ├── 运营人员
│   │   └── 客服人员
│   ├── 业务角色
│   │   ├── 普通读者
│   │   ├── VIP读者
│   │   ├── 作者
│   │   ├── 签约作者
│   │   └── 大神作者
│   ├── 自定义角色
│   └── 角色继承
├── 权限管理 (Permission Management)
│   ├── 资源权限
│   │   ├── 阅读权限
│   │   ├── 写作权限
│   │   ├── 评论权限
│   │   └── 管理权限
│   ├── 操作权限
│   │   ├── 创建
│   │   ├── 读取
│   │   ├── 更新
│   │   └── 删除
│   ├── 数据权限
│   │   ├── 个人数据
│   │   ├── 团队数据
│   │   └── 公开数据
│   └── API权限
├── 权限检查 (Permission Check)
│   ├── 中间件检查
│   ├── 装饰器检查
│   ├── 动态检查
│   └── 批量检查
└── 权限缓存 (Permission Cache)
    ├── 用户权限缓存
    ├── 角色权限缓存
    ├── 缓存更新
    └── 缓存失效
```

**权限模型设计**：

```go
type Permission struct {
    ID          string   `json:"id" bson:"_id"`
    Resource    string   `json:"resource"`    // 资源类型：book, chapter, comment
    Action      string   `json:"action"`      // 操作：create, read, update, delete
    Conditions  []string `json:"conditions"`  // 条件：owner, vip, subscribed
}

type Role struct {
    ID          string       `json:"id" bson:"_id"`
    Name        string       `json:"name"`
    Description string       `json:"description"`
    Permissions []string     `json:"permissions"` // 权限ID列表
    ParentRole  string       `json:"parent_role"` // 父角色（继承）
    IsSystem    bool         `json:"is_system"`   // 是否系统角色
    Level       int          `json:"level"`       // 角色等级
}

type UserRole struct {
    UserID    string    `json:"user_id" bson:"user_id"`
    RoleID    string    `json:"role_id" bson:"role_id"`
    ExpiresAt time.Time `json:"expires_at"` // 角色过期时间（VIP等）
}
```

**权限检查示例**：

```go
type PermissionService interface {
    // 权限检查
    CheckPermission(ctx context.Context, userID, resource, action string) (bool, error)
    CheckMultiPermissions(ctx context.Context, userID string, checks []PermissionCheck) (map[string]bool, error)
  
    // 角色管理
    AssignRole(ctx context.Context, userID, roleID string, expiresAt time.Time) error
    RevokeRole(ctx context.Context, userID, roleID string) error
    GetUserRoles(ctx context.Context, userID string) ([]*Role, error)
  
    // 权限管理
    GrantPermission(ctx context.Context, roleID, permissionID string) error
    RevokePermission(ctx context.Context, roleID, permissionID string) error
    GetRolePermissions(ctx context.Context, roleID string) ([]*Permission, error)
}

// 权限检查中间件
func PermissionMiddleware(resource, action string) gin.HandlerFunc {
    return func(c *gin.Context) {
        userID := c.GetString("user_id")
      
        hasPermission, err := permissionService.CheckPermission(c, userID, resource, action)
        if err != nil || !hasPermission {
            c.JSON(403, gin.H{"error": "权限不足"})
            c.Abort()
            return
        }
      
        c.Next()
    }
}
```

### 4.3 用户等级 (User Level) 🆕

**模块职责**：

- 用户等级体系
- 经验值管理
- 等级特权

**核心功能**：

```
user_level/
├── 等级体系 (Level System)
│   ├── 读者等级
│   │   ├── 见习读者 (Lv1-5)
│   │   ├── 资深读者 (Lv6-10)
│   │   ├── 铁杆书虫 (Lv11-15)
│   │   └── 传说书友 (Lv16+)
│   ├── 作者等级
│   │   ├── 新手作者 (Lv1-5)
│   │   ├── 签约作者 (Lv6-10)
│   │   ├── 精品作者 (Lv11-15)
│   │   └── 大神作者 (Lv16+)
│   └── 等级配置
│       ├── 等级经验值
│       ├── 等级权益
│       └── 等级徽章
├── 经验值系统 (Experience Points)
│   ├── 经验获取
│   │   ├── 阅读获取经验
│   │   ├── 写作获取经验
│   │   ├── 互动获取经验
│   │   └── 任务获取经验
│   ├── 经验计算
│   └── 升级机制
├── 特权系统 (Privileges)
│   ├── 阅读特权
│   │   ├── 免费章节额度
│   │   ├── 优先阅读权
│   │   └── 特殊标识
│   ├── 写作特权
│   │   ├── 更多推荐位
│   │   ├── 优先审核
│   │   └── 数据分析权限
│   └── 社交特权
│       ├── 评论权重
│       ├── 专属表情
│       └── 特殊标识
└── 成就系统 (Achievement)
    ├── 成就类型
    │   ├── 阅读成就
    │   ├── 创作成就
    │   ├── 社交成就
    │   └── 活动成就
    ├── 成就奖励
    └── 成就展示
```

---

## 五、🔗 共享服务模块 (Shared Services)

### 5.1 消息通知服务 (Notification Service)

**模块职责**：

- 多渠道消息推送
- 消息模板管理
- 推送策略

**核心功能**：

```
notification_service/
├── 推送渠道 (Push Channels)
│   ├── 站内消息
│   ├── 邮件通知
│   ├── 短信通知
│   ├── APP推送
│   └── 微信通知
├── 消息模板 (Templates)
│   ├── 模板管理
│   ├── 变量替换
│   ├── 多语言支持
│   └── 模板预览
├── 推送策略 (Push Strategy)
│   ├── 即时推送
│   ├── 定时推送
│   ├── 批量推送
│   └── 智能推送
└── 用户偏好 (User Preference)
    ├── 推送设置
    ├── 免打扰时段
    ├── 渠道偏好
    └── 订阅管理
```

### 5.2 文件存储服务 (Storage Service)

**模块职责**：

- 文件上传下载
- CDN加速
- 图片处理

**核心功能**：

```
storage_service/
├── 对象存储 (Object Storage)
│   ├── MinIO/OSS
│   ├── 文件上传
│   ├── 文件下载
│   └── 文件管理
├── CDN加速 (CDN)
│   ├── 静态资源加速
│   ├── 缓存策略
│   ├── 回源配置
│   └── 防盗链
├── 图片处理 (Image Processing)
│   ├── 缩略图生成
│   ├── 格式转换
│   ├── 裁剪旋转
│   └── 水印添加
└── 文件安全 (Security)
    ├── 病毒扫描
    ├── 敏感内容检测
    ├── 访问控制
    └── 加密存储
```

### 5.3 搜索服务 (Search Service)

**模块职责**：

- 全文搜索
- 搜索建议
- 搜索分析

**核心功能**：

```
search_service/
├── 全文搜索 (Full-Text Search)
│   ├── Elasticsearch
│   ├── 书籍搜索
│   ├── 作者搜索
│   ├── 章节搜索
│   └── 评论搜索
├── 搜索优化 (Search Optimization)
│   ├── 分词处理
│   ├── 同义词
│   ├── 拼音搜索
│   └── 模糊搜索
├── 搜索建议 (Search Suggestion)
│   ├── 自动补全
│   ├── 热门搜索
│   ├── 搜索历史
│   └── 相关搜索
└── 搜索分析 (Search Analytics)
    ├── 搜索热词
    ├── 搜索趋势
    ├── 无结果搜索
    └── 搜索转化率
```

### 5.4 钱包服务 (Wallet Service)

**模块职责**：

- 代币管理
- 支付集成
- 交易记录

**核心功能**：

```
wallet_service/
├── 代币管理 (Token Management)
│   ├── 代币发放
│   ├── 代币消费
│   ├── 余额查询
│   └── 代币转账
├── 支付集成 (Payment Integration)
│   ├── 微信支付
│   ├── 支付宝
│   ├── 银联支付
│   └── 虚拟货币
├── 提现管理 (Withdrawal)
│   ├── 提现申请
│   ├── 提现审核
│   ├── 提现处理
│   └── 提现记录
└── 交易记录 (Transaction)
    ├── 交易流水
    ├── 对账功能
    ├── 风控监控
    └── 财务报表
```

### 5.5 消息队列服务 (Message Queue Service)

**模块职责**：

- 异步任务处理
- 事件驱动
- 消息可靠传递

**核心功能**：

```
message_queue_service/
├── 消息传递 (Message Delivery)
│   ├── 点对点消息
│   ├── 发布订阅
│   ├── 延时消息
│   └── 事务消息
├── 队列管理 (Queue Management)
│   ├── 队列创建
│   ├── 队列配置
│   ├── 死信队列
│   └── 重试机制
├── 消费者管理 (Consumer)
│   ├── 消费组
│   ├── 负载均衡
│   ├── 消费确认
│   └── 消费监控
└── 事件总线 (Event Bus)
    ├── 事件发布
    ├── 事件订阅
    ├── 事件路由
    └── 事件持久化
```

### 5.6 管理后台服务 (Admin Service)

**模块职责**：

- 平台管理
- 数据统计
- 运营工具

**核心功能**：

```
admin_service/
├── 用户管理 (User Management)
│   ├── 用户列表
│   ├── 用户详情
│   ├── 用户封禁
│   └── 用户分析
├── 内容管理 (Content Management)
│   ├── 书籍审核
│   ├── 章节审核
│   ├── 评论审核
│   └── 内容下架
├── 运营工具 (Operation Tools)
│   ├── Banner配置
│   ├── 活动管理
│   ├── 推荐配置
│   └── 通知发送
├── 数据统计 (Statistics)
│   ├── 用户统计
│   ├── 内容统计
│   ├── 收入统计
│   └── 趋势分析
└── 系统配置 (System Config)
    ├── 参数配置
    ├── 权限配置
    ├── 字典管理
    └── 日志查看
```

---

## 六、⚙️ 基础设施模块 (Infrastructure)

### 6.1 认证授权 (Authentication & Authorization)

**核心功能**：

```
auth/
├── JWT认证
├── OAuth2.0
├── SSO单点登录
└── API密钥管理
```

### 6.2 中间件 (Middleware)

**核心功能**：

```
middleware/
├── 认证中间件
├── 权限中间件
├── 日志中间件
├── 限流中间件
├── CORS中间件
├── 压缩中间件
└── 错误处理中间件
```

### 6.3 配置中心 (Configuration Center)

**核心功能**：

```
config_center/
├── 配置管理
├── 配置热更新
├── 配置版本控制
└── 多环境配置
```

### 6.4 监控告警 (Monitoring & Alerting)

**核心功能**：

```
monitoring/
├── Prometheus监控
├── Grafana可视化
├── 日志收集(ELK)
├── 链路追踪(Jaeger)
└── 告警通知
```

---

## 🔄 模块依赖关系图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端应用                              │
└────────────┬────────────────────────────────────────────────┘
             │
┌────────────▼────────────────────────────────────────────────┐
│                      API网关 + 中间件                        │
└────┬────────┬────────┬────────┬────────┬─────────┬─────────┘
     │        │        │        │        │         │
┌────▼────┐┌─▼──────┐┌▼──────┐┌▼──────┐┌▼───────┐┌▼────────┐
│阅读模块││写作模块││AI模块 ││社交模块││用户模块││管理模块│
└────┬────┘└─┬──────┘└┬──────┘└┬──────┘└┬───────┘└┬────────┘
     │       │        │        │        │         │
     └───────┴────────┴────────┴────────┴─────────┴─────┐
                                                          │
┌────────────────────────────────────────────────────────▼─┐
│                      共享服务层                           │
│  推荐│消息│存储│搜索│钱包│消息队列                        │
└────────────────────────────────────────────────────────┬─┘
                                                          │
┌────────────────────────────────────────────────────────▼─┐
│                     基础设施层                            │
│  MongoDB│Redis│RabbitMQ│Elasticsearch│MinIO              │
└──────────────────────────────────────────────────────────┘
```

---

## 📊 模块开发优先级

### 🔥 P0 - 核心功能 (第1-3个月)

**目标**：实现MVP，基础功能可用

1. **用户中心模块**

   - 用户注册登录 ✅
   - JWT认证 ✅
   - 基础权限管理 ✅
2. **阅读端核心**

   - 书城首页 ✅
   - 基础阅读器
   - 简单推荐
3. **写作端核心**

   - 基础编辑器
   - 项目管理 ✅
   - 文档管理 ✅
4. **AI基础服务**

   - AI服务架构 ✅
   - OpenAI适配器 ✅
   - 基础对话功能 ✅

### 🔥 P1 - 完善功能 (第4-6个月)

**目标**：功能完整，体验优化

1. **阅读端完善**

   - 书签笔记
   - 阅读任务
   - 基础社交
2. **写作端完善**

   - 设定百科
   - AI写作助手
   - 版本控制 ✅
3. **AI高级功能**

   - 多AI适配器
   - 上下文管理 ✅
   - 配额管理
4. **共享服务**

   - 文件存储 ✅
   - 消息通知
   - 钱包系统 ✅

### 🔥 P2 - 高级功能 (第7-9个月)

**目标**：功能深化，性能优化

1. **高级AI功能**

   - Agent系统 🆕
   - 智能分析
   - 多Agent协作
2. **角色权限系统** 🆕

   - RBAC完整实现
   - 用户等级体系
   - 特权系统
3. **数据分析**

   - 作者数据统计
   - 读者画像
   - 收益分析
4. **运营功能**

   - 稿费结算
   - 管理后台
   - 数据报表

---

## 🎯 模块开发指南

### 开发规范

每个模块开发需要包含：

1. **设计文档** ✅

   - 模块架构设计
   - 接口设计
   - 数据模型设计
2. **代码实现** ✅

   - Router层
   - API层
   - Service层
   - Repository层
   - Model层
3. **测试覆盖** ✅

   - 单元测试 (>80%覆盖率)
   - 集成测试
   - 接口测试
4. **文档完善** ✅

   - API文档
   - 使用指南
   - 部署文档

### 模块接口设计原则

1. **统一规范**：遵循RESTful设计
2. **版本管理**：API版本化管理
3. **错误处理**：统一错误码和响应
4. **性能考虑**：合理的缓存和优化
5. **安全设计**：认证、授权、限流

### 模块协作规范

1. **接口优先**：定义清晰的接口契约
2. **异步通信**：使用消息队列解耦
3. **事件驱动**：重要业务发布事件
4. **服务降级**：做好容错和降级

---

## 🚀 未来规划

### 微服务化准备

当满足以下条件时考虑微服务化：

- ✅ 团队规模 > 15人
- ✅ 日活用户 > 10万
- ✅ 某个模块成为性能瓶颈
- ✅ 需要独立部署和扩展

### 技术演进方向

1. **AI能力增强**

   - 更强大的Agent系统
   - 多模态AI支持（图像、语音）
   - 垂直领域模型训练
2. **性能优化**

   - 数据库分库分表
   - 读写分离
   - CDN全球部署
3. **功能扩展**

   - 音频书功能
   - 视频创作
   - 直播互动

---

## 📚 附录

### 参考文档

- [青羽项目开发规则 v2.0](../../../.cursor/rules/qingyubackend.mdc)
- [架构设计规范](../architecture/架构设计规范.md)
- [Repository层设计规范](../architecture/repository层设计规范.md)
- [架构迁移指南](../migration/architecture_migration_guide.md)

### 技术选型

| 技术栈   | 选型               | 用途      |
| -------- | ------------------ | --------- |
| 编程语言 | Go 1.21+           | 后端服务  |
| Web框架  | Gin                | HTTP服务  |
| 数据库   | MongoDB            | 文档存储  |
| 缓存     | Redis              | 缓存/会话 |
| 消息队列 | RabbitMQ           | 异步处理  |
| 搜索引擎 | Elasticsearch      | 全文搜索  |
| 对象存储 | MinIO/OSS          | 文件存储  |
| 监控     | Prometheus+Grafana | 系统监控  |

---

## 📋 架构改进建议实施说明

基于2025年10月的架构评审，本次v2.1更新主要实施了以下改进：

### 1. 结构与边界优化 ✅

**已完成**：
- 明确Reading Task、User Level、Wallet Service的职责边界
- 分离Monetization和Wallet Service的业务逻辑层与账本层
- 定义AI Module的Go/Python分层架构

**详细设计文档**：`doc/design/重构规划/模块边界优化方案.md`

### 2. 技术层面深化 🚧

**规划中**：
- 强制事件方法定义（Service接口中必须包含事件方法）
- 配置中心集成（Prompt模板管理、AI配置热更新）
- RAG索引触发机制（事件驱动的向量化）

**详细设计文档**：
- `doc/design/core/事件驱动架构设计.md`
- `doc/design/platform/配置中心集成设计.md`
- `doc/design/ai/11.RAG事件驱动索引设计.md`

### 3. 风险与非功能性要求 🚧

**规划中**：
- Saga事务模式（跨服务事务一致性保证）
- AI流式接口强制（降低延迟感知）
- Python AI Agent系统（工具调用、RAG增强）

**详细设计文档**：
- `doc/design/core/Saga事务模式设计.md`
- `doc/design/ai/12.AI流式接口规范.md`
- `doc/design/ai/07.Python_AI_Agent系统架构设计.md`

### 4. 实施路线图

```
Phase 1: 文档编写 (2周)                    [进行中]
  └─ 完成所有设计文档编写

Phase 2: 接口设计与评审 (1周)              [待开始]
  └─ 定义新模块接口，更新现有接口

Phase 3: 数据模型设计 (1周)                [待开始]
  └─ MongoDB Schema设计，数据迁移方案

Phase 4: Python AI Agent开发 (4-6周)       [待开始]
  └─ FastAPI框架，Agent引擎，工具调用，RAG

Phase 5: 模块重构实施 (4-6周)              [待开始]
  └─ Monetization，Reading Task，User Level，事件驱动，Saga

Phase 6: 集成测试与优化 (2-3周)            [待开始]
  └─ 端到端测试，性能测试，压力测试
```

### 5. 关键成功指标

| 指标 | 目标 | 现状 |
|------|------|------|
| 架构清晰度 | 所有模块职责明确 | 文档化中 |
| AI响应延迟 | 延迟感知降低50%+ | 待实施 |
| 数据一致性 | 核心交易0数据丢失 | 待实施 |
| 开发效率 | Agent工具调用10倍+ | 待实施 |
| 可维护性 | 测试覆盖率>80% | 待提升 |

---

**文档版本**: v2.1  
**最后更新**: 2025-10-21  
