# 点赞系统设计文档

**版本**: v1.0  
**创建日期**: 2025-10-25  
**状态**: 实施中

---

## 一、概述

### 1.1 目标

实现通用点赞系统，支持书籍、评论、章节点赞，使用Redis缓存提升性能，提供防刷机制。

### 1.2 核心功能

- 点赞/取消点赞（书籍、评论）
- 点赞去重（一个用户对一个对象只能点赞一次）
- 点赞数统计
- 用户点赞列表查询
- 批量查询点赞状态
- Redis缓存热点数据

### 1.3 技术栈

- **数据存储**: MongoDB（持久化）
- **缓存**: Redis（热点数据缓存）
- **防重**: MongoDB唯一索引 + Redis SETNX
- **防刷**: Redis TTL限流

---

## 二、数据模型设计

### 2.1 Like 点赞模型

```go
type Like struct {
    ID         primitive.ObjectID  // 点赞ID
    UserID     string             // 用户ID
    TargetType string             // 目标类型（book/comment/chapter）
    TargetID   string             // 目标ID
    CreatedAt  time.Time          // 创建时间
}
```

### 2.2 数据库索引

**MongoDB索引**：

```javascript
// 唯一索引：防止重复点赞
db.likes.createIndex(
  { user_id: 1, target_type: 1, target_id: 1 }, 
  { unique: true }
)

// 用户点赞列表查询
db.likes.createIndex({ user_id: 1, created_at: -1 })

// 目标点赞数统计
db.likes.createIndex({ target_type: 1, target_id: 1 })
```

### 2.3 Redis缓存策略

**缓存Key设计**：

```
# 点赞数缓存（String类型）
Key: like:count:{target_type}:{target_id}
Value: 点赞数（整数）
TTL: 1小时

# 用户点赞状态缓存（Set类型）
Key: like:user:{user_id}:{target_type}
Value: Set集合（target_id列表）
TTL: 1小时

# 防刷限流（String类型）
Key: like:limit:{user_id}:{target_id}
Value: 1
TTL: 1秒
```

---

## 三、系统架构

### 3.1 分层设计

```
API Layer (like_api.go)
    ↓
Service Layer (like_service.go)
    ↓ ↓ ↓
    LikeRepository    CommentRepository    EventBus
    (MongoDB+Redis)   (更新点赞数)       (事件发布)
    ↓
MongoDB (likes集合) + Redis (缓存)
```

### 3.2 核心流程

#### 点赞流程

```
1. 检查防刷限制（Redis TTL）
2. 检查是否已点赞（Redis Set / MongoDB）
3. 添加点赞记录（MongoDB）
4. 更新缓存（Redis）
5. 更新目标对象点赞数（CommentRepository）
6. 发布点赞事件（EventBus）
7. 返回结果
```

#### 取消点赞流程

```
1. 检查是否已点赞
2. 删除点赞记录（MongoDB）
3. 更新缓存（Redis）
4. 更新目标对象点赞数（CommentRepository）
5. 发布取消点赞事件
6. 返回结果
```

---

## 四、API设计

### 4.1 端点列表

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/v1/reader/books/:id/like | 点赞书籍 |
| DELETE | /api/v1/reader/books/:id/like | 取消点赞书籍 |
| GET | /api/v1/reader/books/:id/like/status | 检查书籍点赞状态 |
| POST | /api/v1/reader/comments/:id/like | 点赞评论 |
| DELETE | /api/v1/reader/comments/:id/like | 取消点赞评论 |
| GET | /api/v1/reader/likes | 获取用户点赞列表 |

### 4.2 请求示例

**点赞书籍**

```http
POST /api/v1/reader/books/507f1f77bcf86cd799439011/like
Authorization: Bearer <token>
```

**响应**

```json
{
  "code": 200,
  "message": "点赞成功",
  "data": {
    "like_count": 128,
    "is_liked": true
  }
}
```

---

## 五、业务规则

### 5.1 点赞规则

- **去重**: 一个用户对同一对象只能点赞一次（MongoDB唯一索引）
- **防刷**: 1秒内不能重复点赞同一对象（Redis TTL）
- **幂等性**: 重复点赞不报错，返回已点赞状态
- **原子性**: 使用MongoDB原子操作确保一致性

### 5.2 缓存规则

- **缓存优先**: 读操作优先从Redis获取
- **缓存更新**: 点赞/取消点赞时同步更新Redis
- **缓存失效**: TTL 1小时，自动过期
- **缓存穿透**: 空结果也缓存（TTL 5分钟）

### 5.3 统计规则

- **实时统计**: 点赞数实时更新（Redis + MongoDB）
- **最终一致性**: Redis缓存过期后从MongoDB重新加载
- **批量查询**: 支持批量获取点赞数和点赞状态

---

## 六、安全与性能

### 6.1 安全措施

- **认证**: JWT Token验证
- **防刷**: Redis TTL限流（1秒/次）
- **防重**: MongoDB唯一索引
- **权限**: 只能点赞已发布的内容

### 6.2 性能优化

- **Redis缓存**: 热点数据缓存，响应时间 <50ms
- **批量查询**: 支持批量获取，减少数据库查询
- **异步更新**: 事件驱动，异步更新热度
- **索引优化**: MongoDB复合唯一索引

### 6.3 性能指标

- 点赞操作响应时间：<100ms
- 查询点赞状态：<50ms（缓存命中）
- 批量查询：<200ms（100条）
- 并发支持：1000 QPS

---

## 七、事件设计

### 7.1 事件类型

- `like.book.added` - 书籍被点赞
- `like.book.removed` - 书籍取消点赞
- `like.comment.added` - 评论被点赞
- `like.comment.removed` - 评论取消点赞

### 7.2 事件数据

```go
{
  "event_type": "like.book.added",
  "event_data": {
    "user_id": "...",
    "target_type": "book",
    "target_id": "...",
    "like_count": 128
  },
  "timestamp": "2025-10-25T10:00:00Z",
  "source": "LikeService"
}
```

### 7.3 事件处理

- **热度更新**: 更新书籍/评论热度分数
- **推荐系统**: 用户行为数据收集
- **通知**: 作者收到点赞通知（可选）

---

## 八、测试策略

### 8.1 单元测试

- LikeRepository CRUD操作
- Redis缓存读写
- 点赞去重测试
- 防刷机制测试

### 8.2 集成测试

- 点赞/取消点赞完整流程
- 并发点赞测试
- 缓存一致性测试
- 性能压力测试

### 8.3 测试用例

```go
// 测试点赞去重
func TestLikeService_DuplicateLike(t *testing.T)

// 测试防刷机制
func TestLikeService_RateLimiting(t *testing.T)

// 测试并发点赞
func TestLikeService_ConcurrentLike(t *testing.T)

// 测试缓存命中
func TestLikeRepository_CacheHit(t *testing.T)
```

---

## 九、Redis集成

### 9.1 Redis客户端配置

使用项目已有的Redis配置（`config/redis.go`）：

```go
// Redis配置已就绪
type RedisConfig struct {
    Host     string
    Port     int
    Password string
    DB       int
    // ... 连接池配置
}
```

### 9.2 Redis操作封装

```go
// 缓存点赞数
func (r *LikeRepository) setCachedLikeCount(targetType, targetID string, count int64) error

// 获取缓存点赞数
func (r *LikeRepository) getCachedLikeCount(targetType, targetID string) (int64, bool, error)

// 缓存用户点赞状态
func (r *LikeRepository) setCachedUserLike(userID, targetType, targetID string) error

// 检查缓存点赞状态
func (r *LikeRepository) isCachedUserLiked(userID, targetType, targetID string) (bool, bool, error)

// 防刷检查
func (r *LikeRepository) checkRateLimit(userID, targetID string) (bool, error)
```

---

## 十、后续优化

### 10.1 功能扩展

- [ ] 支持点赞动画效果
- [ ] 点赞排行榜
- [ ] 热门内容推荐（基于点赞数）
- [ ] 点赞历史记录

### 10.2 性能优化

- [ ] Redis Cluster支持
- [ ] 异步批量写入MongoDB
- [ ] 点赞数定时同步（减少实时写入压力）
- [ ] CDN缓存点赞数

---

## 十一、风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| Redis故障 | 中 | 降级到纯MongoDB模式 |
| 缓存不一致 | 低 | TTL自动过期 + 定时同步 |
| 并发点赞冲突 | 低 | MongoDB唯一索引 + 原子操作 |
| 点赞刷量 | 中 | 限流 + 异常检测 + 封禁机制 |

---

**文档状态**: ✅ 已完成  
**下一步**: 实现Repository层

