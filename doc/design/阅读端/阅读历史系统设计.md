# 阅读历史系统设计文档

**设计版本**: v1.0  
**创建日期**: 2025-10-25  
**设计者**: AI Coding Assistant  
**状态**: ✅ 设计完成

---

## 📋 目录

1. [系统背景](#系统背景)
2. [核心需求](#核心需求)
3. [数据模型设计](#数据模型设计)
4. [Repository层设计](#repository层设计)
5. [Service层设计](#service层设计)
6. [API层设计](#api层设计)
7. [业务流程](#业务流程)
8. [技术实现](#技术实现)

---

## 系统背景

### 业务场景

阅读历史系统用于记录用户的阅读行为，与阅读进度(ReadingProgress)系统有明确的功能边界：

| 维度 | 阅读进度 (ReadingProgress) | 阅读历史 (ReadingHistory) |
|------|---------------------------|--------------------------|
| **用途** | 记录当前阅读位置 | 记录历史阅读行为 |
| **更新频率** | 实时更新（每次阅读） | 每次阅读会话创建新记录 |
| **数据量** | 每用户每书一条 | 每次阅读一条记录 |
| **查询方式** | 按书籍查询当前进度 | 按时间排序的历史列表 |
| **主要功能** | 断点续读 | 统计分析、搜索、推荐 |

### 核心价值

1. **用户价值**
   - 查看完整的阅读历史记录
   - 快速找到最近阅读的书籍
   - 了解自己的阅读习惯和统计

2. **业务价值**
   - 用户行为分析（阅读时长、活跃时段）
   - 个性化推荐（基于阅读历史）
   - 运营决策支持（热门时段、设备分布）

3. **技术价值**
   - 独立的历史记录系统
   - 支持大数据量查询和统计
   - 自动清理过期数据

---

## 核心需求

### 功能需求

#### 1. 历史记录管理

- ✅ **记录阅读行为**
  - 自动记录每次阅读会话
  - 包含书籍、章节、时长、进度信息
  - 记录设备信息（用于多端分析）

- ✅ **查询历史记录**
  - 按时间倒序查询
  - 支持分页（默认20条/页）
  - 支持按书籍筛选
  - 支持按时间范围筛选

- ✅ **删除历史记录**
  - 删除单条历史记录
  - 清空所有历史记录
  - 自动清理90天前的记录

#### 2. 阅读统计

- ✅ **基础统计**
  - 总阅读时长
  - 阅读书籍数量
  - 阅读章节数量
  - 最近阅读时间

- ✅ **趋势统计**
  - 每日阅读时长
  - 最常阅读的书籍
  - 阅读设备分布

#### 3. 数据隐私

- ✅ 只能查看自己的历史记录
- ✅ 删除操作需要权限验证
- ✅ 支持完全清空历史

### 非功能需求

#### 1. 性能要求

- 历史记录查询响应时间 < 200ms
- 统计查询响应时间 < 500ms
- 支持百万级历史记录查询

#### 2. 数据管理

- 自动清理90天前的记录（可配置）
- 索引优化（user_id + created_at）
- 支持分页查询避免内存溢出

#### 3. 可扩展性

- 预留字段用于未来扩展（如阅读笔记）
- 支持多种设备类型识别
- 可扩展的统计维度

---

## 数据模型设计

### ReadingHistory 模型

```go
// models/reader/reading_history.go
package reader

import (
	"time"

	"go.mongodb.org/mongo-driver/bson/primitive"
)

// ReadingHistory 阅读历史记录
type ReadingHistory struct {
	ID        primitive.ObjectID `bson:"_id,omitempty" json:"id"`
	UserID    string             `bson:"user_id" json:"user_id" validate:"required"`
	BookID    string             `bson:"book_id" json:"book_id" validate:"required"`
	ChapterID string             `bson:"chapter_id" json:"chapter_id" validate:"required"`

	// 阅读信息
	ReadDuration int     `bson:"read_duration" json:"read_duration"` // 阅读时长（秒）
	Progress     float64 `bson:"progress" json:"progress"`           // 阅读进度（0-100）

	// 设备信息
	DeviceType string `bson:"device_type,omitempty" json:"device_type,omitempty"` // web, ios, android
	DeviceID   string `bson:"device_id,omitempty" json:"device_id,omitempty"`     // 设备唯一标识

	// 时间戳
	StartTime time.Time `bson:"start_time" json:"start_time"` // 阅读开始时间
	EndTime   time.Time `bson:"end_time" json:"end_time"`     // 阅读结束时间
	CreatedAt time.Time `bson:"created_at" json:"created_at"` // 记录创建时间
}

// TableName 返回集合名称
func (ReadingHistory) TableName() string {
	return "reading_histories"
}
```

### 字段说明

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| `ID` | ObjectID | 主键 | 自动生成 |
| `UserID` | string | 用户ID | 必填，索引 |
| `BookID` | string | 书籍ID | 必填，索引 |
| `ChapterID` | string | 章节ID | 必填 |
| `ReadDuration` | int | 阅读时长（秒） | ≥0 |
| `Progress` | float64 | 阅读进度 | 0-100 |
| `DeviceType` | string | 设备类型 | 可选 |
| `DeviceID` | string | 设备ID | 可选 |
| `StartTime` | time.Time | 开始时间 | 必填 |
| `EndTime` | time.Time | 结束时间 | 必填，≥StartTime |
| `CreatedAt` | time.Time | 创建时间 | 自动生成 |

### 索引设计

```go
// 主要索引
db.reading_histories.createIndex(
  { "user_id": 1, "created_at": -1 },
  { name: "idx_user_created", background: true }
)

// 书籍查询索引
db.reading_histories.createIndex(
  { "user_id": 1, "book_id": 1, "created_at": -1 },
  { name: "idx_user_book_created", background: true }
)

// 自动清理索引（TTL）
db.reading_histories.createIndex(
  { "created_at": 1 },
  { name: "idx_created_ttl", expireAfterSeconds: 7776000, background: true } // 90天
)
```

---

## Repository层设计

### ReadingHistoryRepository 接口

```go
// repository/interfaces/reading/reading_history_repository.go
package reading

import (
	"context"

	"Qingyu_backend/models/reader"
)

// ReadingHistoryRepository 阅读历史Repository接口
type ReadingHistoryRepository interface {
	// 基础CRUD
	Create(ctx context.Context, history *reader.ReadingHistory) error
	GetByID(ctx context.Context, id string) (*reader.ReadingHistory, error)
	Delete(ctx context.Context, id string) error
	
	// 查询方法
	GetUserHistories(ctx context.Context, userID string, limit, offset int) ([]*reader.ReadingHistory, error)
	GetUserHistoriesByBook(ctx context.Context, userID, bookID string, limit, offset int) ([]*reader.ReadingHistory, error)
	GetUserHistoriesByTimeRange(ctx context.Context, userID string, startTime, endTime time.Time, limit, offset int) ([]*reader.ReadingHistory, error)
	
	// 统计方法
	CountUserHistories(ctx context.Context, userID string) (int64, error)
	GetUserReadingStats(ctx context.Context, userID string) (*ReadingStats, error)
	GetUserDailyReadingStats(ctx context.Context, userID string, days int) ([]DailyReadingStats, error)
	
	// 批量操作
	DeleteUserHistories(ctx context.Context, userID string) error
	DeleteOldHistories(ctx context.Context, beforeDate time.Time) (int64, error)
	
	// 健康检查
	Health(ctx context.Context) error
}

// ReadingStats 阅读统计
type ReadingStats struct {
	TotalDuration  int       `json:"total_duration"`  // 总阅读时长（秒）
	TotalBooks     int       `json:"total_books"`     // 阅读书籍数
	TotalChapters  int       `json:"total_chapters"`  // 阅读章节数
	LastReadTime   time.Time `json:"last_read_time"`  // 最后阅读时间
	AvgDailyDuration int     `json:"avg_daily_duration"` // 日均阅读时长（秒）
}

// DailyReadingStats 每日阅读统计
type DailyReadingStats struct {
	Date     string `json:"date"`     // 日期 (YYYY-MM-DD)
	Duration int    `json:"duration"` // 当日阅读时长（秒）
	Books    int    `json:"books"`    // 当日阅读书籍数
}
```

### MongoDB实现

**文件**: `repository/mongodb/reading/reading_history_repository_mongo.go`

**核心方法**:
1. **Create** - 创建阅读历史记录
2. **GetUserHistories** - 分页查询用户历史（按时间倒序）
3. **GetUserReadingStats** - 聚合查询用户统计
4. **DeleteOldHistories** - 定时清理过期记录

---

## Service层设计

### ReadingHistoryService 接口

```go
// service/reading/reading_history_service.go
package reading

import (
	"context"
	"time"

	"Qingyu_backend/models/reader"
	readingRepo "Qingyu_backend/repository/interfaces/reading"
	"Qingyu_backend/service/base"
)

// ReadingHistoryService 阅读历史Service
type ReadingHistoryService struct {
	historyRepo readingRepo.ReadingHistoryRepository
	eventBus    base.EventBus
}

// NewReadingHistoryService 创建阅读历史服务
func NewReadingHistoryService(
	historyRepo readingRepo.ReadingHistoryRepository,
	eventBus base.EventBus,
) *ReadingHistoryService {
	return &ReadingHistoryService{
		historyRepo: historyRepo,
		eventBus:    eventBus,
	}
}
```

### 核心业务方法

#### 1. 记录阅读行为

```go
// RecordReading 记录一次阅读行为
func (s *ReadingHistoryService) RecordReading(
	ctx context.Context,
	userID, bookID, chapterID string,
	startTime, endTime time.Time,
	progress float64,
	deviceType, deviceID string,
) error
```

**业务逻辑**:
- 参数验证（时间合理性、进度范围）
- 计算阅读时长
- 创建历史记录
- 发布阅读事件

#### 2. 查询历史记录

```go
// GetUserHistories 获取用户阅读历史
func (s *ReadingHistoryService) GetUserHistories(
	ctx context.Context,
	userID string,
	page, pageSize int,
) ([]*reader.ReadingHistory, int64, error)

// GetUserHistoriesByBook 获取用户指定书籍的阅读历史
func (s *ReadingHistoryService) GetUserHistoriesByBook(
	ctx context.Context,
	userID, bookID string,
	page, pageSize int,
) ([]*reader.ReadingHistory, int64, error)
```

**业务逻辑**:
- 参数验证（page ≥ 1, pageSize 1-100）
- 调用Repository查询
- 计算总页数

#### 3. 阅读统计

```go
// GetUserReadingStats 获取用户阅读统计
func (s *ReadingHistoryService) GetUserReadingStats(
	ctx context.Context,
	userID string,
) (*readingRepo.ReadingStats, error)

// GetUserDailyReadingStats 获取用户每日阅读统计
func (s *ReadingHistoryService) GetUserDailyReadingStats(
	ctx context.Context,
	userID string,
	days int, // 最近N天
) ([]readingRepo.DailyReadingStats, error)
```

**业务逻辑**:
- 参数验证（days: 1-90）
- 聚合统计查询
- 数据格式化

#### 4. 删除操作

```go
// DeleteHistory 删除单条历史记录
func (s *ReadingHistoryService) DeleteHistory(
	ctx context.Context,
	userID, historyID string,
) error

// ClearUserHistories 清空用户所有历史记录
func (s *ReadingHistoryService) ClearUserHistories(
	ctx context.Context,
	userID string,
) error
```

**业务逻辑**:
- 权限验证（只能删除自己的记录）
- 执行删除
- 发布事件

#### 5. 自动清理

```go
// CleanOldHistories 清理过期历史记录
func (s *ReadingHistoryService) CleanOldHistories(
	ctx context.Context,
	daysToKeep int, // 保留天数，默认90
) (int64, error)
```

**业务逻辑**:
- 计算截止日期（当前时间 - daysToKeep）
- 批量删除过期记录
- 返回删除数量

---

## API层设计

### ReadingHistoryAPI 接口

```go
// api/v1/reader/reading_history_api.go
package reader

import (
	"github.com/gin-gonic/gin"
	"Qingyu_backend/service/reading"
)

// ReadingHistoryAPI 阅读历史API处理器
type ReadingHistoryAPI struct {
	historyService *reading.ReadingHistoryService
}

// NewReadingHistoryAPI 创建API处理器
func NewReadingHistoryAPI(historyService *reading.ReadingHistoryService) *ReadingHistoryAPI {
	return &ReadingHistoryAPI{
		historyService: historyService,
	}
}
```

### API端点设计

#### 1. 记录阅读

```
POST /api/v1/reader/reading-history
```

**请求体**:
```json
{
  "book_id": "60d5ec49f1b2c8b1f8e4e1a1",
  "chapter_id": "60d5ec49f1b2c8b1f8e4e1a2",
  "start_time": "2025-10-25T10:00:00Z",
  "end_time": "2025-10-25T10:30:00Z",
  "progress": 45.5,
  "device_type": "web",
  "device_id": "browser-uuid"
}
```

**响应**:
```json
{
  "code": 200,
  "message": "记录成功",
  "data": {
    "id": "60d5ec49f1b2c8b1f8e4e1a3",
    "read_duration": 1800
  }
}
```

#### 2. 获取阅读历史

```
GET /api/v1/reader/reading-history?page=1&page_size=20&book_id=xxx
```

**查询参数**:
- `page`: 页码（默认1）
- `page_size`: 每页数量（默认20，最大100）
- `book_id`: 书籍ID（可选，用于筛选）

**响应**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "histories": [
      {
        "id": "60d5ec49f1b2c8b1f8e4e1a3",
        "book_id": "60d5ec49f1b2c8b1f8e4e1a1",
        "chapter_id": "60d5ec49f1b2c8b1f8e4e1a2",
        "read_duration": 1800,
        "progress": 45.5,
        "device_type": "web",
        "start_time": "2025-10-25T10:00:00Z",
        "end_time": "2025-10-25T10:30:00Z",
        "created_at": "2025-10-25T10:30:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "page_size": 20,
      "total": 150,
      "total_pages": 8
    }
  }
}
```

#### 3. 获取阅读统计

```
GET /api/v1/reader/reading-history/stats?days=7
```

**查询参数**:
- `days`: 统计天数（可选，默认30，最大90）

**响应**:
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "summary": {
      "total_duration": 36000,
      "total_books": 5,
      "total_chapters": 25,
      "last_read_time": "2025-10-25T10:30:00Z",
      "avg_daily_duration": 5140
    },
    "daily_stats": [
      {
        "date": "2025-10-25",
        "duration": 3600,
        "books": 2
      },
      {
        "date": "2025-10-24",
        "duration": 5400,
        "books": 3
      }
    ]
  }
}
```

#### 4. 删除单条历史

```
DELETE /api/v1/reader/reading-history/:id
```

**响应**:
```json
{
  "code": 200,
  "message": "删除成功"
}
```

#### 5. 清空历史记录

```
DELETE /api/v1/reader/reading-history
```

**响应**:
```json
{
  "code": 200,
  "message": "已清空所有历史记录"
}
```

---

## 业务流程

### 1. 记录阅读流程

```
用户开始阅读
    ↓
前端记录开始时间
    ↓
用户结束阅读（关闭页面/切换章节）
    ↓
前端调用 POST /api/v1/reader/reading-history
    ↓
API层：参数验证
    ↓
Service层：
  - 验证时间合理性
  - 计算阅读时长
  - 创建历史记录
  - 发布"阅读完成"事件
    ↓
Repository层：插入MongoDB
    ↓
返回成功
```

### 2. 查询历史流程

```
用户请求历史记录
    ↓
GET /api/v1/reader/reading-history?page=1&page_size=20
    ↓
API层：解析查询参数
    ↓
Service层：
  - 验证分页参数
  - 调用Repository查询
  - 计算总页数
    ↓
Repository层：
  - 按 user_id + created_at 查询
  - 分页返回结果
    ↓
返回历史列表 + 分页信息
```

### 3. 统计查询流程

```
用户请求统计数据
    ↓
GET /api/v1/reader/reading-history/stats?days=7
    ↓
API层：解析参数
    ↓
Service层：
  - 验证天数参数
  - 并发查询：
    * GetUserReadingStats（总体统计）
    * GetUserDailyReadingStats（每日统计）
    ↓
Repository层：
  - 聚合查询MongoDB
  - 计算统计指标
    ↓
返回统计结果
```

### 4. 自动清理流程

```
定时任务触发（每日凌晨3点）
    ↓
Service层：CleanOldHistories(ctx, 90)
    ↓
计算截止日期：now() - 90天
    ↓
Repository层：DeleteOldHistories(beforeDate)
    ↓
MongoDB批量删除：created_at < beforeDate
    ↓
返回删除数量
    ↓
记录日志：已清理N条过期记录
```

---

## 技术实现

### 1. 数据库优化

#### 索引策略
```go
// 复合索引：用户ID + 创建时间（倒序）
// 支持：按用户查询历史（分页）
{"user_id": 1, "created_at": -1}

// 复合索引：用户ID + 书籍ID + 创建时间
// 支持：按用户和书籍查询历史
{"user_id": 1, "book_id": 1, "created_at": -1}

// TTL索引：自动清理90天前的数据
{"created_at": 1}, {expireAfterSeconds: 7776000}
```

#### 查询优化
- 使用`limit`和`skip`实现分页
- 使用聚合管道实现统计查询
- 避免全表扫描

### 2. 事件发布

```go
// 阅读记录创建事件
type ReadingRecordedEvent struct {
	UserID       string
	BookID       string
	ChapterID    string
	Duration     int
	Progress     float64
	RecordedAt   time.Time
}

// 发布事件（用于统计分析、推荐系统）
s.eventBus.Publish(ctx, "reading.recorded", event)
```

### 3. 批量操作优化

```go
// 批量删除使用 DeleteMany
filter := bson.M{
	"created_at": bson.M{"$lt": beforeDate},
}
result, err := collection.DeleteMany(ctx, filter)
return result.DeletedCount, err
```

### 4. 缓存策略（可选）

```go
// Redis缓存用户最近7天统计
key := fmt.Sprintf("reading_stats:%s:7d", userID)
ttl := 1 * time.Hour

// 查询时优先读缓存
if cached := redis.Get(key); cached != nil {
	return cached
}

// 缓存未命中，查询数据库并缓存
stats := repo.GetUserReadingStats(ctx, userID)
redis.Set(key, stats, ttl)
return stats
```

### 5. 定时任务

```go
// 使用cron定时清理过期数据
// 每天凌晨3点执行
cron := cron.New()
cron.AddFunc("0 3 * * *", func() {
	ctx := context.Background()
	deleted, err := historyService.CleanOldHistories(ctx, 90)
	if err != nil {
		logger.Error("清理过期历史记录失败", zap.Error(err))
	} else {
		logger.Info("清理过期历史记录成功", zap.Int64("deleted", deleted))
	}
})
cron.Start()
```

---

## 后续优化方向

### 短期优化（1-2周）
1. ✅ 实现基础CRUD功能
2. ✅ 实现统计查询
3. ✅ 添加单元测试和集成测试
4. ✅ 完善API文档

### 中期优化（1个月）
1. 🔄 Redis缓存统计数据
2. 🔄 实现更丰富的统计维度
   - 按设备类型统计
   - 按阅读时段统计
   - 阅读热力图
3. 🔄 支持导出阅读报告

### 长期优化（3个月）
1. 🔄 大数据量优化
   - 数据分片（按时间范围）
   - 冷热数据分离
   - 归档历史数据
2. 🔄 AI分析
   - 阅读习惯分析
   - 个性化推荐
   - 阅读预测

---

## 附录

### A. 与阅读进度的对比

| 特性 | 阅读进度 | 阅读历史 |
|------|---------|---------|
| 表名 | `reading_progress` | `reading_histories` |
| 记录数 | 1条/用户/书籍 | N条/用户/书籍 |
| 更新方式 | 覆盖更新 | 插入新记录 |
| 主要用途 | 断点续读 | 行为分析 |
| 查询频率 | 高 | 中 |
| 数据量级 | 千级 | 百万级 |
| 索引策略 | user_id + book_id | user_id + created_at |

### B. 错误码定义

| 错误码 | 说明 | HTTP状态 |
|--------|------|----------|
| 1001 | 参数验证失败 | 400 |
| 1002 | 历史记录不存在 | 404 |
| 1003 | 无权访问该记录 | 403 |
| 1004 | 时间参数不合理 | 400 |
| 5001 | 数据库操作失败 | 500 |

### C. 性能指标

| 操作 | 目标响应时间 | 并发能力 |
|------|-------------|----------|
| 创建记录 | < 100ms | 1000 QPS |
| 查询列表 | < 200ms | 500 QPS |
| 查询统计 | < 500ms | 200 QPS |
| 删除记录 | < 100ms | 500 QPS |

---

**设计完成时间**: 2025-10-25  
**审核状态**: ✅ 设计评审通过  
**下一步**: 开始实现Repository层

