# 评论系统设计文档

**版本**: v1.0  
**创建日期**: 2025-10-25  
**状态**: 实施中

---

## 一、概述

### 1.1 目标

实现完整的评论系统，支持用户对书籍和章节发表评论、回复评论、点赞评论，以及自动审核功能。

### 1.2 核心功能

- 评论发表与管理（CRUD）
- 评论回复（支持嵌套回复）
- 评论点赞
- 自动审核（敏感词过滤）
- 评论排序（最新、最热）
- 评分系统（1-5星）

### 1.3 技术栈

- **数据存储**: MongoDB
- **缓存**: 无（未来可扩展）
- **审核**: 敏感词库检测

---

## 二、数据模型设计

### 2.1 Comment 评论模型

```go
type Comment struct {
    ID        primitive.ObjectID  // 评论ID
    BookID    string             // 书籍ID
    ChapterID string             // 章节ID（可选）
    UserID    string             // 用户ID
    
    // 评论内容
    Content string  // 评论内容（10-500字）
    Rating  int     // 评分（0-5星，0表示无评分）
    
    // 回复相关
    ParentID    string  // 父评论ID
    RootID      string  // 根评论ID
    ReplyToUser string  // 回复的目标用户ID
    
    // 统计
    LikeCount  int  // 点赞数
    ReplyCount int  // 回复数
    
    // 审核
    Status       string  // approved/rejected/pending
    RejectReason string  // 拒绝原因
    
    // 时间戳
    CreatedAt time.Time
    UpdatedAt time.Time
}
```

### 2.2 数据库索引

```javascript
// 书籍评论查询（按创建时间降序）
db.comments.createIndex({ book_id: 1, created_at: -1 })

// 用户评论历史
db.comments.createIndex({ user_id: 1, created_at: -1 })

// 回复查询
db.comments.createIndex({ parent_id: 1 })

// 审核队列
db.comments.createIndex({ status: 1, created_at: -1 })

// 点赞数排序（热度）
db.comments.createIndex({ book_id: 1, like_count: -1 })
```

---

## 三、系统架构

### 3.1 分层设计

```
API Layer (comment_api.go)
    ↓
Service Layer (comment_service.go)
    ↓ ↓ ↓
    Repository Layer    SensitiveWordRepo    EventBus
    (comment_repository)  (审核)            (事件发布)
    ↓
MongoDB (comments集合)
```

### 3.2 核心流程

#### 评论发表流程

```
1. 用户提交评论 → API层参数验证
2. Service层 → 敏感词检测
3. 自动审核 → status = approved/rejected
4. 保存评论 → Repository层
5. 发布事件 → CommentCreatedEvent
6. 返回结果
```

#### 评论回复流程

```
1. 获取父评论信息
2. 设置ParentID和RootID
3. 增加父评论的ReplyCount
4. 保存回复评论
5. 发布CommentRepliedEvent
```

---

## 四、API设计

### 4.1 端点列表

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/v1/reader/comments | 发表评论 |
| GET | /api/v1/reader/comments | 获取评论列表 |
| GET | /api/v1/reader/comments/:id | 获取评论详情 |
| PUT | /api/v1/reader/comments/:id | 编辑评论 |
| DELETE | /api/v1/reader/comments/:id | 删除评论 |
| POST | /api/v1/reader/comments/:id/reply | 回复评论 |
| POST | /api/v1/reader/comments/:id/like | 点赞评论 |
| DELETE | /api/v1/reader/comments/:id/like | 取消点赞 |

### 4.2 请求示例

**发表评论**

```http
POST /api/v1/reader/comments
Authorization: Bearer <token>
Content-Type: application/json

{
  "book_id": "507f1f77bcf86cd799439011",
  "chapter_id": "507f1f77bcf86cd799439012",
  "content": "这本书真不错，情节很吸引人！",
  "rating": 5
}
```

**获取评论列表**

```http
GET /api/v1/reader/comments?bookId=507f1f77bcf86cd799439011&sortBy=latest&page=1&size=20
```

### 4.3 响应格式

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "id": "507f1f77bcf86cd799439013",
    "book_id": "507f1f77bcf86cd799439011",
    "user_id": "507f1f77bcf86cd799439010",
    "content": "这本书真不错，情节很吸引人！",
    "rating": 5,
    "like_count": 0,
    "reply_count": 0,
    "status": "approved",
    "created_at": "2025-10-25T10:00:00Z",
    "updated_at": "2025-10-25T10:00:00Z"
  }
}
```

---

## 五、业务规则

### 5.1 评论规则

- 内容长度：10-500字
- 评分范围：0-5星（0表示无评分）
- 编辑时限：发表后30分钟内可编辑
- 删除权限：只能删除自己的评论

### 5.2 审核规则

- **自动审核**: 发表时进行敏感词检测
- **通过**: status = "approved"
- **拒绝**: status = "rejected"，记录拒绝原因
- **待审核**: status = "pending"（备用，当前未启用）

### 5.3 回复规则

- 支持两级回复（一级评论 + 回复）
- ParentID: 直接回复的评论ID
- RootID: 顶级评论ID
- 回复会增加父评论的reply_count

### 5.4 点赞规则

- 一个用户对一条评论只能点赞一次
- 点赞数影响评论热度排序
- 点赞操作在like系统中实现（见点赞系统设计文档）

---

## 六、安全与性能

### 6.1 安全措施

- **敏感词过滤**: 集成审核服务的敏感词库
- **权限控制**: JWT认证 + 用户ID验证
- **防刷**: 限制用户评论频率（1分钟1条）
- **XSS防护**: 评论内容HTML转义

### 6.2 性能优化

- **索引优化**: 针对查询场景建立复合索引
- **分页查询**: 默认20条/页，最大100条/页
- **查询优化**: 
  - 最新评论：按created_at降序
  - 最热评论：按like_count降序
- **未来扩展**: Redis缓存热门评论

---

## 七、事件设计

### 7.1 事件类型

- `comment.created` - 评论创建
- `comment.replied` - 评论回复
- `comment.deleted` - 评论删除
- `comment.reviewed` - 评论审核（备用）

### 7.2 事件数据

```go
{
  "event_type": "comment.created",
  "event_data": {
    "comment_id": "...",
    "book_id": "...",
    "user_id": "...",
    "status": "approved"
  },
  "timestamp": "2025-10-25T10:00:00Z",
  "source": "CommentService"
}
```

---

## 八、测试策略

### 8.1 单元测试

- CommentRepository CRUD操作
- CommentService 业务逻辑
- 敏感词过滤
- 权限验证

### 8.2 集成测试

- 发表评论完整流程
- 评论回复流程
- 评论编辑与删除
- 审核流程

### 8.3 性能测试

- 评论列表查询响应时间 <200ms
- 并发评论发表测试

---

## 九、后续优化

### 9.1 功能扩展

- [ ] 评论图片上传
- [ ] 评论@提醒
- [ ] 评论举报功能
- [ ] 管理员人工审核界面

### 9.2 性能优化

- [ ] Redis缓存热门评论
- [ ] 评论数据归档（历史数据）
- [ ] CDN加速评论图片

---

## 十、风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 恶意评论攻击 | 高 | 敏感词过滤 + 频率限制 |
| 评论数据膨胀 | 中 | 分页查询 + 定期归档 |
| 敏感词库更新 | 低 | 提供管理接口，定期更新 |

---

**文档状态**: ✅ 已完成  
**下一步**: 实现Repository层

