# 协作编辑系统设计文档

## 1. 概述

### 1.1 项目背景
协作编辑是青羽写作平台支持团队创作的核心功能。该系统允许多个用户同时对同一文档进行编辑、评论和修订，旨在提供无缝的团队协作体验。

### 1.2 设计目标
- **实时同步**：保证多用户编辑的实时性和一致性
- **冲突解决**：自动处理编辑冲突，保证数据不丢失
- **权限管理**：支持灵活的文档访问和编辑权限控制
- **评论与反馈**：提供段落级别的评论和修订功能
- **高可用性**：保证协作服务的稳定和可靠

## 2. 技术架构

### 2.1 整体架构
```
┌─────────────────┐
│   Frontend      │ ← 实时协作界面
├─────────────────┤
│   WebSocket     │ ← 实时通信通道
├─────────────────┤
│   Collaboration Server │ ← 协作服务器
├─────────────────┤
│   CRDT Service  │ ← 冲突解决服务
├─────────────────┤
│   Auth Service  │ ← 权限验证服务
├─────────────────┤
│   Database      │ ← 数据持久化
└─────────────────┘
```

### 2.2 模块划分
- **WebSocket Server**：处理客户端的实时连接和消息转发
- **CRDT Service**：基于Y.js等CRDT算法，处理数据同步和冲突解决
- **Auth Service**：验证用户身份和文档权限
- **Persistence Service**：将协作内容持久化到数据库

## 3. 功能设计

### 3.1 实时编辑
- **多人光标**：实时显示其他协作者的光标位置
- **内容同步**：实时同步文本、格式等内容的修改
- **在线状态**：显示当前在线的协作者列表

### 3.2 评论与修订
- **段落评论**：支持对特定段落添加评论
- **修订追踪**：记录所有修改，并支持接受或拒绝修订
- **版本对比**：可视化不同版本之间的差异

### 3.3 权限管理
- **角色定义**：支持所有者、编辑者、评论者、只读等角色
- **访问控制**：基于角色的文档访问和操作权限控制
- **分享链接**：生成带有不同权限的分享链接

## 4. 数据模型

### 4.1 协作会话模型
```go
type CollaborationSession struct {
    ID          string   `bson:"_id,omitempty" json:"id"`
    DocumentID  string   `bson:"document_id" json:"documentId"`
    ActiveUsers []string `bson:"active_users" json:"activeUsers"`
    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`
}
```

## 5. 接口设计

### 5.1 WebSocket /ws/collaboration/:documentId
- **功能**：建立协作连接
- **消息格式**：JSON
- **上行消息**：`{ "type": "update", "data": "..." }`
- **下行消息**：`{ "type": "update", "data": "...", "from": "..." }`