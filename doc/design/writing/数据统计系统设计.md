# å†™ä½œç«¯æ•°æ®ç»Ÿè®¡ç³»ç»Ÿè®¾è®¡

> **ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-10-17  
> **æœ€åæ›´æ–°**: 2025-10-17  
> **ç»´æŠ¤è€…**: é’ç¾½å†™ä½œå›¢é˜Ÿ  
> **ä¼˜å…ˆçº§**: ğŸ”¥ MVPé«˜ä¼˜å…ˆçº§

## 1. éœ€æ±‚æ¦‚è¿°

### 1.1 åŠŸèƒ½æè¿°

æ•°æ®ç»Ÿè®¡ç³»ç»Ÿä¸ºä½œè€…æä¾›å…¨æ–¹ä½çš„ä½œå“æ•°æ®åˆ†æèƒ½åŠ›ï¼ŒåŒ…æ‹¬é˜…è¯»æ•°æ®ã€è¯»è€…è¡Œä¸ºåˆ†æã€ç« èŠ‚è´¨é‡è¯„ä¼°ç­‰ï¼Œå¸®åŠ©ä½œè€…äº†è§£ä½œå“è¡¨ç°ï¼Œä¼˜åŒ–åˆ›ä½œç­–ç•¥ã€‚ç³»ç»Ÿæ”¯æŒå®æ—¶ç»Ÿè®¡ã€å†å²è¶‹åŠ¿åˆ†æã€å¤šç»´åº¦å¯¹æ¯”ã€å¯è§†åŒ–æŠ¥è¡¨ç­‰åŠŸèƒ½ã€‚

### 1.2 ä¸šåŠ¡ä»·å€¼

- **æ•°æ®é©±åŠ¨åˆ›ä½œ**ï¼šé€šè¿‡æ•°æ®åˆ†ææŒ‡å¯¼åˆ›ä½œæ–¹å‘ï¼Œæå‡ä½œå“è´¨é‡
- **è¯»è€…æ´å¯Ÿ**ï¼šæ·±å…¥äº†è§£è¯»è€…è¡Œä¸ºå’Œåå¥½ï¼Œç²¾å‡†å®šä½ç›®æ ‡è¯»è€…
- **æ”¶å…¥åˆ†æ**ï¼šæ¸…æ™°å±•ç¤ºè®¢é˜…ã€æ‰“èµç­‰æ”¶å…¥æ•°æ®ï¼Œå¸®åŠ©ä½œè€…è§„åˆ’
- **ä½œå“ä¼˜åŒ–**ï¼šè¯†åˆ«é«˜è´¨é‡å’Œä½è´¨é‡ç« èŠ‚ï¼Œé’ˆå¯¹æ€§æ”¹è¿›

### 1.3 ç”¨æˆ·åœºæ™¯

**ä½œè€…ç«¯åœºæ™¯**ï¼š
1. **æŸ¥çœ‹ä½œå“æ¦‚è§ˆ**ï¼šå¿«é€Ÿäº†è§£ä½œå“çš„æ€»ä½“æ•°æ®ï¼ˆæ€»é˜…è¯»é‡ã€æ”¶è—æ•°ã€è®¢é˜…æ•°ï¼‰
2. **åˆ†æç« èŠ‚è¡¨ç°**ï¼šæŸ¥çœ‹æ¯ç« çš„å®Œè¯»ç‡ã€è·³ç« ç‡ã€åœç•™æ—¶é—´ç­‰
3. **è¿½è¸ªè¯»è€…è¡Œä¸º**ï¼šäº†è§£è¯»è€…ä»å“ªé‡Œæ¥ã€åœ¨å“ªé‡Œæµå¤±ã€å–œæ¬¢å“ªäº›ç« èŠ‚
4. **æ”¶å…¥ç»Ÿè®¡**ï¼šæŸ¥çœ‹è®¢é˜…æ”¶å…¥ã€æ‰“èµæ”¶å…¥ã€å¹¿å‘Šæ”¶å…¥çš„è¯¦ç»†æ•°æ®
5. **è¶‹åŠ¿åˆ†æ**ï¼šæŸ¥çœ‹é˜…è¯»é‡ã€æ”¶è—æ•°ç­‰æŒ‡æ ‡çš„å†å²è¶‹åŠ¿
6. **å¯¹æ¯”åˆ†æ**ï¼šå¯¹æ¯”ä¸åŒä½œå“æˆ–ä¸åŒæ—¶æœŸçš„æ•°æ®è¡¨ç°

**ç®¡ç†å‘˜åœºæ™¯**ï¼š
1. **å¹³å°æ•°æ®æ€»è§ˆ**ï¼šæŸ¥çœ‹å¹³å°æ•´ä½“çš„é˜…è¯»æ•°æ®ã€æ´»è·ƒä½œè€…æ•°ç­‰
2. **ä½œå“æ’è¡Œ**ï¼šæŸ¥çœ‹é˜…è¯»é‡ã€æ”¶å…¥ç­‰ç»´åº¦çš„ä½œå“æ’è¡Œ
3. **æ•°æ®æŠ¥è¡¨**ï¼šç”Ÿæˆå¹³å°è¿è¥æŠ¥è¡¨ï¼Œæ”¯æŒå¯¼å‡º

### 1.4 åŠŸèƒ½è¾¹ç•Œ

**åŒ…å«åŠŸèƒ½**ï¼š
- âœ… ä½œå“æ•°æ®æ¦‚è§ˆï¼ˆé˜…è¯»é‡ã€æ”¶è—ã€è®¢é˜…ã€è¯„è®ºï¼‰
- âœ… ç« èŠ‚æ•°æ®åˆ†æï¼ˆå®Œè¯»ç‡ã€è·³ç« ç‡ã€åœç•™æ—¶é—´ã€è·³å‡ºç‚¹ï¼‰
- âœ… è¯»è€…è¡Œä¸ºåˆ†æï¼ˆæ¥æºæ¸ é“ã€é˜…è¯»è½¨è¿¹ã€æµå¤±åˆ†æï¼‰
- âœ… æ”¶å…¥ç»Ÿè®¡ï¼ˆè®¢é˜…ã€æ‰“èµã€å¹¿å‘Šåˆ†æˆï¼‰
- âœ… è¶‹åŠ¿åˆ†æï¼ˆæ—¥/å‘¨/æœˆè¶‹åŠ¿å›¾ï¼‰
- âœ… æ•°æ®å¯¹æ¯”ï¼ˆä½œå“å¯¹æ¯”ã€æ—¶æœŸå¯¹æ¯”ï¼‰
- âœ… æ•°æ®å¯¼å‡ºï¼ˆExcelã€CSVã€PDFï¼‰
- âœ… å®æ—¶æ•°æ®æ›´æ–°

**ä¸åŒ…å«åŠŸèƒ½**ï¼š
- âŒ è¯»è€…ç”»åƒï¼ˆåæœŸç‰ˆæœ¬ï¼Œéœ€è¦æ›´è¯¦ç»†çš„ç”¨æˆ·æ•°æ®ï¼‰
- âŒ æ™ºèƒ½é¢„æµ‹ï¼ˆåæœŸç‰ˆæœ¬ï¼ŒAIé¢„æµ‹é˜…è¯»è¶‹åŠ¿ï¼‰
- âŒ ç«å“åˆ†æï¼ˆåæœŸç‰ˆæœ¬ï¼‰
- âŒ A/Bæµ‹è¯•ï¼ˆåæœŸç‰ˆæœ¬ï¼‰

---

## 2. æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯æ•°æ®å¯è§†åŒ– (Vue + ECharts)              â”‚
â”‚          æŠ˜çº¿å›¾ | æŸ±çŠ¶å›¾ | é¥¼å›¾ | çƒ­åŠ›å›¾ | æ•°æ®è¡¨æ ¼             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  Router Layer (è·¯ç”±å±‚)                        â”‚
â”‚               /api/v1/statistics/*                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   API Layer (æ¥å£å±‚)                          â”‚
â”‚    WorkStatisticsApi / ChapterStatisticsApi / RevenueApi    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                Service Layer (ä¸šåŠ¡é€»è¾‘å±‚)                      â”‚
â”‚  StatisticsService / ChapterAnalysisService / RevenueServiceâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            Repository Layer (æ•°æ®è®¿é—®å±‚)                       â”‚
â”‚  ReadingLogRepo / ChapterStatsRepo / RevenueRepo            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚               Model Layer (æ•°æ®æ¨¡å‹å±‚)                         â”‚
â”‚  ReadingLog / ChapterStats / RevenueRecord                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        æ•°æ®é‡‡é›†ä¸è®¡ç®—å±‚ (Kafka + Flink + Redis)                â”‚
â”‚     åŸ‹ç‚¹æ•°æ® â†’ Kafka â†’ Flinkå®æ—¶è®¡ç®— â†’ MongoDB/Redis          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®æµè®¾è®¡

#### æ•°æ®é‡‡é›†æµç¨‹
```
ç”¨æˆ·é˜…è¯»è¡Œä¸º â†’ å‰ç«¯åŸ‹ç‚¹ â†’ Kafkaæ¶ˆæ¯é˜Ÿåˆ— 
â†’ Flinkå®æ—¶è®¡ç®— â†’ èšåˆç»Ÿè®¡æ•°æ® 
â†’ MongoDBå­˜å‚¨ + Redisç¼“å­˜ â†’ APIæŸ¥è¯¢
```

#### æ•°æ®æŸ¥è¯¢æµç¨‹
```
ç”¨æˆ·è¯·æ±‚ â†’ APIå±‚ â†’ Serviceå±‚ â†’ Redisç¼“å­˜æŸ¥è¯¢
â†’ (ç¼“å­˜æœªå‘½ä¸­) â†’ MongoDBæŸ¥è¯¢ â†’ å†™å…¥Redis â†’ è¿”å›ç»“æœ
```

#### æ•°æ®å¯¼å‡ºæµç¨‹
```
å¯¼å‡ºè¯·æ±‚ â†’ åå°å¼‚æ­¥ä»»åŠ¡ â†’ æŸ¥è¯¢æ•°æ® â†’ æ ¼å¼è½¬æ¢ 
â†’ ç”Ÿæˆæ–‡ä»¶ â†’ OSSå­˜å‚¨ â†’ é€šçŸ¥ç”¨æˆ· â†’ ä¸‹è½½é“¾æ¥
```

### 2.3 æ¨¡å—åˆ’åˆ†

**æ ¸å¿ƒæ¨¡å—**ï¼š
- **StatisticsService**ï¼šç»Ÿè®¡æ•°æ®æ ¸å¿ƒæœåŠ¡
- **ChapterAnalysisService**ï¼šç« èŠ‚åˆ†ææœåŠ¡
- **RevenueService**ï¼šæ”¶å…¥ç»Ÿè®¡æœåŠ¡
- **TrendAnalysisService**ï¼šè¶‹åŠ¿åˆ†ææœåŠ¡
- **ComparisonService**ï¼šæ•°æ®å¯¹æ¯”æœåŠ¡

**æ•°æ®é‡‡é›†æ¨¡å—**ï¼š
- **EventCollector**ï¼šåŸ‹ç‚¹æ•°æ®æ”¶é›†å™¨
- **RealtimeProcessor**ï¼šFlinkå®æ—¶å¤„ç†å™¨
- **AggregationCalculator**ï¼šèšåˆè®¡ç®—å™¨

**è¾…åŠ©æ¨¡å—**ï¼š
- **ExportService**ï¼šæ•°æ®å¯¼å‡ºæœåŠ¡
- **CacheManager**ï¼šç»Ÿè®¡æ•°æ®ç¼“å­˜ç®¡ç†
- **ReportGenerator**ï¼šæŠ¥è¡¨ç”Ÿæˆå™¨

---

## 3. è¯¦ç»†è®¾è®¡

### 3.1 Routerå±‚è®¾è®¡

**è·¯ç”±åˆ†ç»„**ï¼š`/api/v1/statistics`

**è·¯ç”±å®šä¹‰**ï¼š
```go
// ä½œå“ç»Ÿè®¡è·¯ç”±
statsGroup := v1.Group("/statistics")
statsGroup.Use(middleware.JWTAuth())
{
    // ä½œå“æ¦‚è§ˆ
    statsGroup.GET("/works/:workId/overview", workStatsApi.GetOverview)
    
    // ç« èŠ‚ç»Ÿè®¡
    statsGroup.GET("/works/:workId/chapters", chapterStatsApi.GetChapterStats)
    statsGroup.GET("/works/:workId/chapters/:chapterId", chapterStatsApi.GetChapterDetail)
    
    // è¯»è€…è¡Œä¸ºåˆ†æ
    statsGroup.GET("/works/:workId/readers/behavior", readerAnalysisApi.GetReaderBehavior)
    statsGroup.GET("/works/:workId/readers/source", readerAnalysisApi.GetReaderSource)
    statsGroup.GET("/works/:workId/readers/retention", readerAnalysisApi.GetRetention)
    
    // æ”¶å…¥ç»Ÿè®¡
    statsGroup.GET("/works/:workId/revenue", revenueApi.GetRevenue)
    statsGroup.GET("/works/:workId/revenue/trend", revenueApi.GetRevenueTrend)
    
    // è¶‹åŠ¿åˆ†æ
    statsGroup.GET("/works/:workId/trends", trendApi.GetTrends)
    
    // æ•°æ®å¯¹æ¯”
    statsGroup.POST("/comparison", comparisonApi.CompareWorks)
    
    // æ•°æ®å¯¼å‡º
    statsGroup.POST("/export", exportApi.ExportData)
    statsGroup.GET("/export/:taskId", exportApi.GetExportTask)
}

// æˆ‘çš„ç»Ÿè®¡ï¼ˆä½œè€…è‡ªå·±çš„æ‰€æœ‰ä½œå“ï¼‰
myStatsGroup := v1.Group("/my-statistics")
myStatsGroup.Use(middleware.JWTAuth())
{
    // æˆ‘çš„ä½œå“åˆ—è¡¨ç»Ÿè®¡
    myStatsGroup.GET("/works", myStatsApi.GetMyWorksStats)
    
    // æ€»æ”¶å…¥ç»Ÿè®¡
    myStatsGroup.GET("/revenue/total", myStatsApi.GetTotalRevenue)
}
```

### 3.2 APIå±‚è®¾è®¡

#### 3.2.1 ä½œå“æ¦‚è§ˆæ¥å£

**è¯·æ±‚**ï¼š
```
GET /api/v1/statistics/works/:workId/overview?period=30d
```

**æŸ¥è¯¢å‚æ•°**ï¼š
- `period`: ç»Ÿè®¡å‘¨æœŸï¼ˆ7d, 30d, 90d, allï¼‰

**å“åº”**ï¼š
```json
{
  "code": 200,
  "message": "æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "workId": "work123",
    "workTitle": "æˆ‘çš„å°è¯´",
    "period": "30d",
    "overview": {
      "totalReadCount": 120000,
      "totalReaders": 5000,
      "avgReadTime": 180, // ç§’
      "completionRate": 0.65, // å®Œè¯»ç‡
      "favoriteCount": 1200,
      "subscriptionCount": 800,
      "commentCount": 3500,
      "shareCount": 450
    },
    "trends": {
      "readCountChange": "+15%", // ç›¸æ¯”ä¸Šä¸ªå‘¨æœŸ
      "readerCountChange": "+8%",
      "favoriteCountChange": "+12%"
    },
    "updatedAt": "2025-10-17T10:30:00Z"
  }
}
```

#### 3.2.2 ç« èŠ‚ç»Ÿè®¡æ¥å£

**è¯·æ±‚**ï¼š
```
GET /api/v1/statistics/works/:workId/chapters?sort=completion_rate&order=asc&limit=10
```

**æŸ¥è¯¢å‚æ•°**ï¼š
- `sort`: æ’åºå­—æ®µï¼ˆread_count, completion_rate, jump_rate, stay_timeï¼‰
- `order`: æ’åºæ–¹å‘ï¼ˆasc, descï¼‰
- `limit`: è¿”å›æ•°é‡

**å“åº”**ï¼š
```json
{
  "code": 200,
  "message": "æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "totalChapters": 50,
    "chapters": [
      {
        "chapterId": "chapter1",
        "chapterTitle": "ç¬¬ä¸€ç« ï¼šå¼€ç«¯",
        "chapterNumber": 1,
        "wordCount": 2500,
        "readCount": 5000,
        "uniqueReaders": 4200,
        "completionRate": 0.85, // å®Œè¯»ç‡
        "jumpRate": 0.05, // è·³è¿‡ç‡
        "avgStayTime": 300, // å¹³å‡åœç•™æ—¶é—´ï¼ˆç§’ï¼‰
        "jumpOutRate": 0.10, // è·³å‡ºç‡ï¼ˆè¯»å®Œåä¸ç»§ç»­ï¼‰
        "jumpOutPosition": [0.3, 0.6, 0.9], // è·³å‡ºçƒ­ç‚¹ä½ç½®ï¼ˆå½’ä¸€åŒ–ï¼‰
        "qualityScore": 8.5, // è´¨é‡è¯„åˆ†ï¼ˆåŸºäºå¤šæŒ‡æ ‡è®¡ç®—ï¼‰
        "ranking": 5 // åœ¨æ‰€æœ‰ç« èŠ‚ä¸­çš„æ’å
      }
    ]
  }
}
```

#### 3.2.3 ç« èŠ‚è¯¦ç»†æ•°æ®æ¥å£

**è¯·æ±‚**ï¼š
```
GET /api/v1/statistics/works/:workId/chapters/:chapterId?period=7d
```

**å“åº”**ï¼š
```json
{
  "code": 200,
  "message": "æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "chapterId": "chapter1",
    "chapterInfo": {
      "title": "ç¬¬ä¸€ç« ï¼šå¼€ç«¯",
      "number": 1,
      "wordCount": 2500,
      "publishedAt": "2025-10-01T10:00:00Z"
    },
    "statistics": {
      "readCount": 5000,
      "uniqueReaders": 4200,
      "completionRate": 0.85,
      "jumpRate": 0.05,
      "avgStayTime": 300,
      "jumpOutRate": 0.10
    },
    "trends": {
      "daily": [
        {
          "date": "2025-10-10",
          "readCount": 120,
          "uniqueReaders": 100,
          "completionRate": 0.83
        }
      ]
    },
    "heatmap": {
      "description": "ç« èŠ‚å†…å®¹çƒ­åŠ›å›¾ï¼Œæ˜¾ç¤ºè¯»è€…åœç•™æ—¶é•¿åˆ†å¸ƒ",
      "data": [
        {
          "position": 0.1, // ä½ç½®ï¼ˆå½’ä¸€åŒ–ï¼Œ0-1ï¼‰
          "heatValue": 0.8, // çƒ­åº¦å€¼ï¼ˆå½’ä¸€åŒ–ï¼Œ0-1ï¼‰
          "readCount": 4500, // è¯»åˆ°æ­¤å¤„çš„äººæ•°
          "avgStayTime": 15 // è¯¥ä½ç½®å¹³å‡åœç•™æ—¶é—´ï¼ˆç§’ï¼‰
        },
        {
          "position": 0.3,
          "heatValue": 0.6,
          "readCount": 4000,
          "avgStayTime": 20
        }
      ]
    },
    "jumpOutPoints": {
      "description": "è¯»è€…è·³å‡ºçƒ­ç‚¹ï¼Œæ˜¾ç¤ºè¯»è€…åœ¨å“ªäº›ä½ç½®ç¦»å¼€",
      "data": [
        {
          "position": 0.3,
          "jumpOutCount": 500,
          "jumpOutRate": 0.12,
          "reason": "å¯èƒ½åŸå› ï¼šæƒ…èŠ‚æ‹–æ²“"
        }
      ]
    },
    "comments": {
      "totalCount": 150,
      "topComments": [
        {
          "content": "è¿™ä¸€ç« å†™å¾—çœŸå¥½ï¼",
          "likes": 50,
          "position": 0.8
        }
      ]
    }
  }
}
```

#### 3.2.4 è¯»è€…è¡Œä¸ºåˆ†ææ¥å£

**è¯·æ±‚**ï¼š
```
GET /api/v1/statistics/works/:workId/readers/behavior?period=30d
```

**å“åº”**ï¼š
```json
{
  "code": 200,
  "message": "æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "readerSource": {
      "search": 2000, // æœç´¢å¼•æ“
      "recommendation": 1500, // æ¨èç³»ç»Ÿ
      "ranking": 800, // æ¦œå•
      "social": 500, // ç¤¾äº¤åˆ†äº«
      "direct": 200 // ç›´æ¥è®¿é—®
    },
    "readingPath": {
      "description": "è¯»è€…é˜…è¯»è·¯å¾„åˆ†æ",
      "sequentialReading": 0.70, // é¡ºåºé˜…è¯»æ¯”ä¾‹
      "jumpReading": 0.20, // è·³è·ƒé˜…è¯»æ¯”ä¾‹
      "randomReading": 0.10, // éšæœºé˜…è¯»æ¯”ä¾‹
      "avgChaptersPerSession": 3.5 // æ¯æ¬¡é˜…è¯»å¹³å‡ç« èŠ‚æ•°
    },
    "retention": {
      "day1": 0.60, // æ¬¡æ—¥ç•™å­˜ç‡
      "day7": 0.35, // 7æ—¥ç•™å­˜ç‡
      "day30": 0.20 // 30æ—¥ç•™å­˜ç‡
    },
    "churn": {
      "totalChurn": 1500, // æµå¤±è¯»è€…æ•°
      "churnRate": 0.30, // æµå¤±ç‡
      "churnReasons": {
        "updateTooSlow": 500,
        "qualityDecline": 300,
        "plotBoring": 400,
        "other": 300
      }
    }
  }
}
```

#### 3.2.5 æ”¶å…¥ç»Ÿè®¡æ¥å£

**è¯·æ±‚**ï¼š
```
GET /api/v1/statistics/works/:workId/revenue?period=30d
```

**å“åº”**ï¼š
```json
{
  "code": 200,
  "message": "æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "workId": "work123",
    "period": "30d",
    "revenue": {
      "total": 15000.00, // æ€»æ”¶å…¥ï¼ˆå…ƒï¼‰
      "subscription": 10000.00, // è®¢é˜…æ”¶å…¥
      "reward": 3000.00, // æ‰“èµæ”¶å…¥
      "advertising": 2000.00 // å¹¿å‘Šåˆ†æˆ
    },
    "breakdown": {
      "subscriptionCount": 800, // è®¢é˜…äººæ•°
      "avgSubscriptionPrice": 12.50, // å¹³å‡è®¢é˜…ä»·æ ¼
      "rewardCount": 150, // æ‰“èµäººæ¬¡
      "avgRewardAmount": 20.00, // å¹³å‡æ‰“èµé‡‘é¢
      "adImpressions": 100000, // å¹¿å‘Šå±•ç¤ºæ¬¡æ•°
      "adCPM": 20.00 // åƒæ¬¡å±•ç¤ºæ”¶ç›Š
    },
    "trends": {
      "daily": [
        {
          "date": "2025-10-10",
          "total": 500.00,
          "subscription": 350.00,
          "reward": 100.00,
          "advertising": 50.00
        }
      ]
    },
    "topRewardChapters": [
      {
        "chapterId": "chapter10",
        "chapterTitle": "ç¬¬åç« ï¼šé«˜æ½®",
        "rewardAmount": 800.00,
        "rewardCount": 40
      }
    ]
  }
}
```

### 3.3 Serviceå±‚è®¾è®¡

#### StatisticsService æ ¸å¿ƒæ–¹æ³•

```go
type StatisticsService struct {
    readingLogRepo    repository.ReadingLogRepository
    chapterStatsRepo  repository.ChapterStatsRepository
    revenueRepo       repository.RevenueRepository
    cacheManager      *StatsCacheManager
    flinkClient       *FlinkClient
    eventBus          base.EventBus
}

// GetWorkOverview è·å–ä½œå“æ¦‚è§ˆç»Ÿè®¡
func (s *StatisticsService) GetWorkOverview(ctx context.Context, workId string, period string) (*WorkOverviewResponse, error) {
    // 1. å‚æ•°éªŒè¯
    if workId == "" {
        return nil, errors.NewValidationError("ä½œå“IDä¸èƒ½ä¸ºç©º")
    }
    
    // 2. å°è¯•ä»ç¼“å­˜è·å–
    cacheKey := fmt.Sprintf("stats:overview:%s:%s", workId, period)
    if cached, err := s.cacheManager.Get(ctx, cacheKey); err == nil {
        var overview WorkOverviewResponse
        if json.Unmarshal([]byte(cached), &overview) == nil {
            return &overview, nil
        }
    }
    
    // 3. è®¡ç®—æ—¶é—´èŒƒå›´
    startTime, endTime := s.calculateTimeRange(period)
    
    // 4. å¹¶è¡ŒæŸ¥è¯¢å„é¡¹æŒ‡æ ‡
    var (
        totalReadCount     int64
        totalReaders       int64
        avgReadTime        float64
        completionRate     float64
        favoriteCount      int64
        subscriptionCount  int64
        commentCount       int64
        shareCount         int64
        wg                 sync.WaitGroup
        mu                 sync.Mutex
    )
    
    // 4.1 æŸ¥è¯¢é˜…è¯»æ•°æ®
    wg.Add(1)
    go func() {
        defer wg.Done()
        stats, _ := s.readingLogRepo.GetWorkStats(ctx, workId, startTime, endTime)
        mu.Lock()
        totalReadCount = stats.TotalReadCount
        totalReaders = stats.UniqueReaders
        avgReadTime = stats.AvgReadTime
        completionRate = stats.CompletionRate
        mu.Unlock()
    }()
    
    // 4.2 æŸ¥è¯¢äº’åŠ¨æ•°æ®
    wg.Add(1)
    go func() {
        defer wg.Done()
        interactions, _ := s.readingLogRepo.GetInteractionStats(ctx, workId, startTime, endTime)
        mu.Lock()
        favoriteCount = interactions.FavoriteCount
        commentCount = interactions.CommentCount
        shareCount = interactions.ShareCount
        mu.Unlock()
    }()
    
    // 4.3 æŸ¥è¯¢è®¢é˜…æ•°æ®
    wg.Add(1)
    go func() {
        defer wg.Done()
        subCount, _ := s.revenueRepo.GetSubscriptionCount(ctx, workId, startTime, endTime)
        mu.Lock()
        subscriptionCount = subCount
        mu.Unlock()
    }()
    
    wg.Wait()
    
    // 5. è®¡ç®—è¶‹åŠ¿å˜åŒ–
    trends := s.calculateTrends(ctx, workId, period)
    
    // 6. æ„å»ºå“åº”
    overview := &WorkOverviewResponse{
        WorkId: workId,
        Period: period,
        Overview: OverviewData{
            TotalReadCount:    totalReadCount,
            TotalReaders:      totalReaders,
            AvgReadTime:       int(avgReadTime),
            CompletionRate:    completionRate,
            FavoriteCount:     favoriteCount,
            SubscriptionCount: subscriptionCount,
            CommentCount:      commentCount,
            ShareCount:        shareCount,
        },
        Trends:    trends,
        UpdatedAt: time.Now(),
    }
    
    // 7. å†™å…¥ç¼“å­˜ï¼ˆ5åˆ†é’ŸTTLï¼‰
    if data, err := json.Marshal(overview); err == nil {
        s.cacheManager.Set(ctx, cacheKey, string(data), 5*time.Minute)
    }
    
    return overview, nil
}

// AnalyzeChapter åˆ†æç« èŠ‚æ•°æ®
func (s *StatisticsService) AnalyzeChapter(ctx context.Context, workId, chapterId string, period string) (*ChapterAnalysisResponse, error) {
    // 1. æŸ¥è¯¢ç« èŠ‚åŸºç¡€ä¿¡æ¯
    chapterInfo, err := s.chapterStatsRepo.GetChapterInfo(ctx, chapterId)
    if err != nil {
        return nil, errors.NewInternalError("æŸ¥è¯¢ç« èŠ‚ä¿¡æ¯å¤±è´¥").WithCause(err)
    }
    
    // 2. è®¡ç®—æ—¶é—´èŒƒå›´
    startTime, endTime := s.calculateTimeRange(period)
    
    // 3. æŸ¥è¯¢ç« èŠ‚ç»Ÿè®¡æ•°æ®
    stats, err := s.chapterStatsRepo.GetChapterStats(ctx, chapterId, startTime, endTime)
    if err != nil {
        return nil, errors.NewInternalError("æŸ¥è¯¢ç« èŠ‚ç»Ÿè®¡å¤±è´¥").WithCause(err)
    }
    
    // 4. æŸ¥è¯¢è¶‹åŠ¿æ•°æ®
    trends, _ := s.chapterStatsRepo.GetChapterTrends(ctx, chapterId, startTime, endTime)
    
    // 5. ç”Ÿæˆçƒ­åŠ›å›¾æ•°æ®
    heatmap := s.generateHeatmap(ctx, chapterId, startTime, endTime)
    
    // 6. åˆ†æè·³å‡ºç‚¹
    jumpOutPoints := s.analyzeJumpOutPoints(ctx, chapterId, startTime, endTime)
    
    // 7. æŸ¥è¯¢è¯„è®ºæ•°æ®
    comments, _ := s.readingLogRepo.GetChapterComments(ctx, chapterId, 10)
    
    // 8. æ„å»ºå“åº”
    return &ChapterAnalysisResponse{
        ChapterId:     chapterId,
        ChapterInfo:   chapterInfo,
        Statistics:    stats,
        Trends:        trends,
        Heatmap:       heatmap,
        JumpOutPoints: jumpOutPoints,
        Comments:      comments,
    }, nil
}

// generateHeatmap ç”Ÿæˆç« èŠ‚çƒ­åŠ›å›¾
func (s *StatisticsService) generateHeatmap(ctx context.Context, chapterId string, startTime, endTime time.Time) HeatmapData {
    // ä»é˜…è¯»æ—¥å¿—ä¸­æå–è¯»è€…åœç•™æ•°æ®
    logs, _ := s.readingLogRepo.GetReadingLogs(ctx, chapterId, startTime, endTime)
    
    // å°†ç« èŠ‚åˆ†æˆ100æ®µï¼Œç»Ÿè®¡æ¯æ®µçš„åœç•™æ—¶é•¿
    segments := 100
    heatValues := make([]float64, segments)
    readCounts := make([]int64, segments)
    stayTimes := make([]float64, segments)
    
    for _, log := range logs {
        // log.ReadProgress: é˜…è¯»è¿›åº¦ï¼ˆ0-1ï¼‰
        // log.StayTime: åœç•™æ—¶é—´ï¼ˆç§’ï¼‰
        segment := int(log.ReadProgress * float64(segments))
        if segment >= segments {
            segment = segments - 1
        }
        
        readCounts[segment]++
        stayTimes[segment] += float64(log.StayTime)
    }
    
    // è®¡ç®—çƒ­åº¦å€¼ï¼ˆå½’ä¸€åŒ–ï¼‰
    maxStayTime := 0.0
    for i := 0; i < segments; i++ {
        if readCounts[i] > 0 {
            stayTimes[i] /= float64(readCounts[i]) // å¹³å‡åœç•™æ—¶é—´
            if stayTimes[i] > maxStayTime {
                maxStayTime = stayTimes[i]
            }
        }
    }
    
    // å½’ä¸€åŒ–çƒ­åº¦å€¼
    for i := 0; i < segments; i++ {
        if maxStayTime > 0 {
            heatValues[i] = stayTimes[i] / maxStayTime
        }
    }
    
    // æ„å»ºçƒ­åŠ›å›¾æ•°æ®ï¼ˆé‡‡æ ·ï¼Œè¿”å›20ä¸ªç‚¹ï¼‰
    var data []HeatmapPoint
    step := segments / 20
    for i := 0; i < segments; i += step {
        data = append(data, HeatmapPoint{
            Position:    float64(i) / float64(segments),
            HeatValue:   heatValues[i],
            ReadCount:   readCounts[i],
            AvgStayTime: int(stayTimes[i]),
        })
    }
    
    return HeatmapData{
        Description: "ç« èŠ‚å†…å®¹çƒ­åŠ›å›¾ï¼Œæ˜¾ç¤ºè¯»è€…åœç•™æ—¶é•¿åˆ†å¸ƒ",
        Data:        data,
    }
}

// analyzeJumpOutPoints åˆ†æç« èŠ‚è·³å‡ºç‚¹
func (s *StatisticsService) analyzeJumpOutPoints(ctx context.Context, chapterId string, startTime, endTime time.Time) JumpOutPointsData {
    // æŸ¥è¯¢è·³å‡ºè®°å½•
    jumpOuts, _ := s.readingLogRepo.GetJumpOutRecords(ctx, chapterId, startTime, endTime)
    
    // ç»Ÿè®¡è·³å‡ºç‚¹åˆ†å¸ƒ
    segments := 100
    jumpOutCounts := make([]int64, segments)
    
    for _, record := range jumpOuts {
        segment := int(record.JumpOutPosition * float64(segments))
        if segment >= segments {
            segment = segments - 1
        }
        jumpOutCounts[segment]++
    }
    
    // æ‰¾å‡ºè·³å‡ºçƒ­ç‚¹ï¼ˆå‰5ä¸ªï¼‰
    type PointCount struct {
        Position float64
        Count    int64
    }
    var points []PointCount
    for i, count := range jumpOutCounts {
        if count > 0 {
            points = append(points, PointCount{
                Position: float64(i) / float64(segments),
                Count:    count,
            })
        }
    }
    
    // æŒ‰æ•°é‡æ’åº
    sort.Slice(points, func(i, j int) bool {
        return points[i].Count > points[j].Count
    })
    
    // å–å‰5ä¸ª
    var data []JumpOutPoint
    for i := 0; i < len(points) && i < 5; i++ {
        totalReaders, _ := s.readingLogRepo.GetReaderCountAtPosition(ctx, chapterId, points[i].Position)
        jumpOutRate := float64(points[i].Count) / float64(totalReaders)
        
        data = append(data, JumpOutPoint{
            Position:      points[i].Position,
            JumpOutCount:  points[i].Count,
            JumpOutRate:   jumpOutRate,
            Reason:        s.inferJumpOutReason(jumpOutRate),
        })
    }
    
    return JumpOutPointsData{
        Description: "è¯»è€…è·³å‡ºçƒ­ç‚¹ï¼Œæ˜¾ç¤ºè¯»è€…åœ¨å“ªäº›ä½ç½®ç¦»å¼€",
        Data:        data,
    }
}

// inferJumpOutReason æ¨æ–­è·³å‡ºåŸå› 
func (s *StatisticsService) inferJumpOutReason(jumpOutRate float64) string {
    if jumpOutRate > 0.3 {
        return "å¯èƒ½åŸå› ï¼šæƒ…èŠ‚æ‹–æ²“æˆ–å†…å®¹è´¨é‡è¾ƒå·®"
    } else if jumpOutRate > 0.15 {
        return "å¯èƒ½åŸå› ï¼šèŠ‚å¥æŠŠæ¡ä¸ä½³"
    } else if jumpOutRate > 0.05 {
        return "å¯èƒ½åŸå› ï¼šéƒ¨åˆ†è¯»è€…é˜…è¯»ä¹ æƒ¯"
    }
    return "æ­£å¸¸èŒƒå›´"
}
```

### 3.4 Repositoryå±‚è®¾è®¡

#### ReadingLogRepository æ¥å£å®šä¹‰

```go
type ReadingLogRepository interface {
    // é˜…è¯»æ—¥å¿—åŸºç¡€æ“ä½œ
    Create(ctx context.Context, log *models.ReadingLog) error
    BatchCreate(ctx context.Context, logs []*models.ReadingLog) error
    
    // ç»Ÿè®¡æŸ¥è¯¢
    GetWorkStats(ctx context.Context, workId string, startTime, endTime time.Time) (*WorkStats, error)
    GetChapterStats(ctx context.Context, chapterId string, startTime, endTime time.Time) (*ChapterStats, error)
    GetInteractionStats(ctx context.Context, workId string, startTime, endTime time.Time) (*InteractionStats, error)
    
    // è¯»è€…è¡Œä¸ºåˆ†æ
    GetReaderSource(ctx context.Context, workId string, startTime, endTime time.Time) (map[string]int64, error)
    GetReadingPath(ctx context.Context, workId string, startTime, endTime time.Time) (*ReadingPathStats, error)
    GetRetentionRate(ctx context.Context, workId string, startTime, endTime time.Time) (*RetentionStats, error)
    
    // ç« èŠ‚è¯¦ç»†åˆ†æ
    GetReadingLogs(ctx context.Context, chapterId string, startTime, endTime time.Time) ([]*models.ReadingLog, error)
    GetJumpOutRecords(ctx context.Context, chapterId string, startTime, endTime time.Time) ([]*models.JumpOutRecord, error)
    GetReaderCountAtPosition(ctx context.Context, chapterId string, position float64) (int64, error)
    
    // è¯„è®ºæŸ¥è¯¢
    GetChapterComments(ctx context.Context, chapterId string, limit int) ([]*models.Comment, error)
}
```

#### ChapterStatsRepository æ¥å£å®šä¹‰

```go
type ChapterStatsRepository interface {
    // ç« èŠ‚ä¿¡æ¯
    GetChapterInfo(ctx context.Context, chapterId string) (*ChapterInfo, error)
    
    // ç« èŠ‚ç»Ÿè®¡
    GetChapterStats(ctx context.Context, chapterId string, startTime, endTime time.Time) (*ChapterStats, error)
    GetAllChaptersStats(ctx context.Context, workId string, startTime, endTime time.Time) ([]*ChapterStats, error)
    
    // è¶‹åŠ¿æ•°æ®
    GetChapterTrends(ctx context.Context, chapterId string, startTime, endTime time.Time) (*TrendData, error)
    
    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    UpdateChapterStats(ctx context.Context, chapterId string, stats *ChapterStats) error
    BatchUpdateStats(ctx context.Context, statsMap map[string]*ChapterStats) error
}
```

#### RevenueRepository æ¥å£å®šä¹‰

```go
type RevenueRepository interface {
    // æ”¶å…¥è®°å½•
    Create(ctx context.Context, record *models.RevenueRecord) error
    GetByWorkId(ctx context.Context, workId string, startTime, endTime time.Time) ([]*models.RevenueRecord, error)
    
    // æ”¶å…¥ç»Ÿè®¡
    GetTotalRevenue(ctx context.Context, workId string, startTime, endTime time.Time) (*RevenueStats, error)
    GetRevenueByType(ctx context.Context, workId string, revenueType string, startTime, endTime time.Time) (float64, error)
    GetSubscriptionCount(ctx context.Context, workId string, startTime, endTime time.Time) (int64, error)
    
    // æ”¶å…¥è¶‹åŠ¿
    GetRevenueTrend(ctx context.Context, workId string, startTime, endTime time.Time, granularity string) ([]*RevenuePoint, error)
    
    // æ’è¡Œæ¦œ
    GetTopRewardChapters(ctx context.Context, workId string, limit int, startTime, endTime time.Time) ([]*ChapterRevenue, error)
}
```

### 3.5 Modelå±‚è®¾è®¡

#### ReadingLog é˜…è¯»æ—¥å¿—æ¨¡å‹

```go
type ReadingLog struct {
    ID            string    `bson:"_id,omitempty" json:"id"`
    UserID        string    `bson:"user_id" json:"userId"`
    WorkID        string    `bson:"work_id" json:"workId"`
    ChapterID     string    `bson:"chapter_id" json:"chapterId"`
    SessionID     string    `bson:"session_id" json:"sessionId"` // é˜…è¯»ä¼šè¯ID
    ReadProgress  float64   `bson:"read_progress" json:"readProgress"` // é˜…è¯»è¿›åº¦ï¼ˆ0-1ï¼‰
    StayTime      int       `bson:"stay_time" json:"stayTime"` // åœç•™æ—¶é—´ï¼ˆç§’ï¼‰
    IsCompleted   bool      `bson:"is_completed" json:"isCompleted"` // æ˜¯å¦è¯»å®Œ
    IsJumpOut     bool      `bson:"is_jump_out" json:"isJumpOut"` // æ˜¯å¦è·³å‡º
    JumpOutPos    float64   `bson:"jump_out_position" json:"jumpOutPosition"` // è·³å‡ºä½ç½®
    Source        string    `bson:"source" json:"source"` // æ¥æºï¼ˆsearch, recommendation, ranking, etc.ï¼‰
    Device        string    `bson:"device" json:"device"` // è®¾å¤‡ç±»å‹ï¼ˆmobile, desktop, tabletï¼‰
    CreatedAt     time.Time `bson:"created_at" json:"createdAt"`
}
```

#### ChapterStats ç« èŠ‚ç»Ÿè®¡æ¨¡å‹

```go
type ChapterStats struct {
    ID             string    `bson:"_id,omitempty" json:"id"`
    WorkID         string    `bson:"work_id" json:"workId"`
    ChapterID      string    `bson:"chapter_id" json:"chapterId"`
    ChapterNumber  int       `bson:"chapter_number" json:"chapterNumber"`
    Date           string    `bson:"date" json:"date"` // ç»Ÿè®¡æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰
    ReadCount      int64     `bson:"read_count" json:"readCount"`
    UniqueReaders  int64     `bson:"unique_readers" json:"uniqueReaders"`
    CompletionRate float64   `bson:"completion_rate" json:"completionRate"`
    JumpRate       float64   `bson:"jump_rate" json:"jumpRate"`
    AvgStayTime    float64   `bson:"avg_stay_time" json:"avgStayTime"`
    JumpOutRate    float64   `bson:"jump_out_rate" json:"jumpOutRate"`
    QualityScore   float64   `bson:"quality_score" json:"qualityScore"` // è´¨é‡è¯„åˆ†
    UpdatedAt      time.Time `bson:"updated_at" json:"updatedAt"`
}
```

#### RevenueRecord æ”¶å…¥è®°å½•æ¨¡å‹

```go
type RevenueRecord struct {
    ID           string    `bson:"_id,omitempty" json:"id"`
    WorkID       string    `bson:"work_id" json:"workId"`
    ChapterID    string    `bson:"chapter_id" json:"chapterId"` // å¯é€‰ï¼Œé’ˆå¯¹ç« èŠ‚çš„æ”¶å…¥
    UserID       string    `bson:"user_id" json:"userId"` // ä»˜è´¹ç”¨æˆ·ID
    Type         string    `bson:"type" json:"type"` // subscription, reward, advertising
    Amount       float64   `bson:"amount" json:"amount"` // é‡‘é¢ï¼ˆå…ƒï¼‰
    Currency     string    `bson:"currency" json:"currency"` // è´§å¸ç±»å‹ï¼ˆCNYï¼‰
    OrderID      string    `bson:"order_id" json:"orderId"` // è®¢å•ID
    Status       string    `bson:"status" json:"status"` // pending, completed, refunded
    SettledAt    time.Time `bson:"settled_at" json:"settledAt"` // ç»“ç®—æ—¶é—´
    CreatedAt    time.Time `bson:"created_at" json:"createdAt"`
}
```

---

## 4. æ•°æ®é‡‡é›†ä¸å®æ—¶è®¡ç®—

### 4.1 åŸ‹ç‚¹è®¾è®¡

**å‰ç«¯åŸ‹ç‚¹äº‹ä»¶**ï¼š
```javascript
// è¿›å…¥ç« èŠ‚
sendEvent({
  event: 'chapter_enter',
  workId: 'work123',
  chapterId: 'chapter1',
  userId: 'user456',
  sessionId: 'session789',
  source: 'recommendation',
  device: 'mobile',
  timestamp: Date.now()
});

// é˜…è¯»è¿›åº¦
sendEvent({
  event: 'reading_progress',
  workId: 'work123',
  chapterId: 'chapter1',
  userId: 'user456',
  sessionId: 'session789',
  progress: 0.5, // å·²è¯»50%
  stayTime: 60, // åœç•™60ç§’
  timestamp: Date.now()
});

// ç¦»å¼€ç« èŠ‚
sendEvent({
  event: 'chapter_leave',
  workId: 'work123',
  chapterId: 'chapter1',
  userId: 'user456',
  sessionId: 'session789',
  progress: 0.8,
  stayTime: 180,
  isCompleted: false,
  timestamp: Date.now()
});

// æ”¶è—ä½œå“
sendEvent({
  event: 'work_favorite',
  workId: 'work123',
  userId: 'user456',
  timestamp: Date.now()
});
```

### 4.2 Kafka Topicè®¾è®¡

**Topicå‘½åè§„èŒƒ**ï¼š
- `reading-events`: é˜…è¯»è¡Œä¸ºäº‹ä»¶
- `interaction-events`: äº’åŠ¨äº‹ä»¶ï¼ˆæ”¶è—ã€è¯„è®ºã€åˆ†äº«ï¼‰
- `revenue-events`: æ”¶å…¥äº‹ä»¶ï¼ˆè®¢é˜…ã€æ‰“èµï¼‰

**æ¶ˆæ¯æ ¼å¼**ï¼š
```json
{
  "eventType": "chapter_enter",
  "eventData": {
    "workId": "work123",
    "chapterId": "chapter1",
    "userId": "user456",
    "sessionId": "session789",
    "source": "recommendation",
    "device": "mobile"
  },
  "timestamp": 1697538600000
}
```

### 4.3 Flinkå®æ—¶è®¡ç®—

**è®¡ç®—é€»è¾‘**ï¼š
```java
// ä¼ªä»£ç ç¤ºä¾‹
DataStream<ReadingEvent> events = env
    .addSource(new FlinkKafkaConsumer<>("reading-events", ...))
    .map(new EventParser());

// è®¡ç®—ç« èŠ‚é˜…è¯»é‡ï¼ˆ5åˆ†é’Ÿçª—å£ï¼‰
DataStream<ChapterStats> readCounts = events
    .keyBy(event -> event.getChapterId())
    .window(TumblingEventTimeWindows.of(Time.minutes(5)))
    .aggregate(new ReadCountAggregator());

// è®¡ç®—å®Œè¯»ç‡
DataStream<CompletionRate> completionRates = events
    .filter(event -> event.getEventType().equals("chapter_leave"))
    .keyBy(event -> event.getChapterId())
    .window(TumblingEventTimeWindows.of(Time.minutes(5)))
    .aggregate(new CompletionRateAggregator());

// å†™å…¥MongoDB
readCounts.addSink(new MongoDBSink(...));
completionRates.addSink(new MongoDBSink(...));

// å†™å…¥Redisç¼“å­˜
readCounts.addSink(new RedisSink(...));
```

---

## 5. æ•°æ®å¯¼å‡º

### 5.1 å¯¼å‡ºæ ¼å¼

**Excelæ ¼å¼**ï¼š
- ä½œå“æ¦‚è§ˆæ•°æ®
- ç« èŠ‚ç»Ÿè®¡åˆ—è¡¨
- æ”¶å…¥æ˜ç»†

**CSVæ ¼å¼**ï¼š
- åŸå§‹é˜…è¯»æ—¥å¿—
- è¯»è€…è¡Œä¸ºæ•°æ®

**PDFæ ¼å¼**ï¼š
- æ•°æ®åˆ†ææŠ¥å‘Šï¼ˆå«å›¾è¡¨ï¼‰

### 5.2 å¯¼å‡ºæµç¨‹

```go
// ExportService
func (s *ExportService) ExportData(ctx context.Context, req *ExportRequest) (*ExportTaskResponse, error) {
    // 1. åˆ›å»ºå¯¼å‡ºä»»åŠ¡
    task := &models.ExportTask{
        ID:        primitive.NewObjectID().Hex(),
        UserID:    req.UserID,
        WorkID:    req.WorkID,
        Type:      req.ExportType, // excel, csv, pdf
        Status:    "pending",
        CreatedAt: time.Now(),
    }
    
    // 2. ä¿å­˜ä»»åŠ¡è®°å½•
    if err := s.exportTaskRepo.Create(ctx, task); err != nil {
        return nil, err
    }
    
    // 3. å¼‚æ­¥æ‰§è¡Œå¯¼å‡º
    go s.executeExport(context.Background(), task)
    
    // 4. è¿”å›ä»»åŠ¡ID
    return &ExportTaskResponse{
        TaskID:            task.ID,
        Status:            task.Status,
        EstimatedDuration: "3-5åˆ†é’Ÿ",
    }, nil
}

// executeExport æ‰§è¡Œå¯¼å‡ºï¼ˆåå°ä»»åŠ¡ï¼‰
func (s *ExportService) executeExport(ctx context.Context, task *models.ExportTask) {
    // 1. æ›´æ–°ä»»åŠ¡çŠ¶æ€
    task.Status = "processing"
    s.exportTaskRepo.Update(ctx, task.ID, task)
    
    // 2. æŸ¥è¯¢æ•°æ®
    data, err := s.queryExportData(ctx, task.WorkID, task.Type)
    if err != nil {
        task.Status = "failed"
        task.ErrorMsg = err.Error()
        s.exportTaskRepo.Update(ctx, task.ID, task)
        return
    }
    
    // 3. ç”Ÿæˆæ–‡ä»¶
    var fileBytes []byte
    var fileName string
    
    switch task.Type {
    case "excel":
        fileBytes, fileName = s.generateExcel(data)
    case "csv":
        fileBytes, fileName = s.generateCSV(data)
    case "pdf":
        fileBytes, fileName = s.generatePDF(data)
    }
    
    // 4. ä¸Šä¼ åˆ°OSS
    fileURL, err := s.ossService.Upload(ctx, fileName, fileBytes)
    if err != nil {
        task.Status = "failed"
        task.ErrorMsg = "æ–‡ä»¶ä¸Šä¼ å¤±è´¥"
        s.exportTaskRepo.Update(ctx, task.ID, task)
        return
    }
    
    // 5. æ›´æ–°ä»»åŠ¡çŠ¶æ€
    task.Status = "completed"
    task.FileURL = fileURL
    task.CompletedAt = time.Now()
    s.exportTaskRepo.Update(ctx, task.ID, task)
    
    // 6. å‘é€é€šçŸ¥
    s.notifyUser(ctx, task.UserID, task.ID, fileURL)
}
```

---

## 6. ç¼“å­˜ç­–ç•¥

### 6.1 Redisç¼“å­˜è®¾è®¡

**ç¼“å­˜Keyè®¾è®¡**ï¼š
- `stats:overview:{workId}:{period}`: ä½œå“æ¦‚è§ˆç»Ÿè®¡ï¼ˆTTL: 5åˆ†é’Ÿï¼‰
- `stats:chapter:{chapterId}`: ç« èŠ‚ç»Ÿè®¡ï¼ˆTTL: 5åˆ†é’Ÿï¼‰
- `stats:revenue:{workId}:{period}`: æ”¶å…¥ç»Ÿè®¡ï¼ˆTTL: 10åˆ†é’Ÿï¼‰
- `stats:realtime:{workId}`: å®æ—¶é˜…è¯»æ•°ï¼ˆTTL: 1åˆ†é’Ÿï¼‰

**ç¼“å­˜æ›´æ–°ç­–ç•¥**ï¼š
- **è¢«åŠ¨æ›´æ–°**ï¼šç¼“å­˜è¿‡æœŸåï¼Œä¸‹æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°
- **ä¸»åŠ¨æ›´æ–°**ï¼šFlinkè®¡ç®—å®Œæˆåï¼Œä¸»åŠ¨åˆ·æ–°ç¼“å­˜
- **ç¼“å­˜é¢„çƒ­**ï¼šå®šæ—¶ä»»åŠ¡é¢„çƒ­çƒ­é—¨ä½œå“çš„ç»Ÿè®¡æ•°æ®

### 6.2 å¤šçº§ç¼“å­˜

```
ç”¨æˆ·è¯·æ±‚ â†’ åº”ç”¨å†…å­˜ç¼“å­˜ï¼ˆ1åˆ†é’Ÿï¼‰ 
â†’ Redisç¼“å­˜ï¼ˆ5åˆ†é’Ÿï¼‰ 
â†’ MongoDBæŸ¥è¯¢ 
â†’ å›å†™ç¼“å­˜
```

---

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 æŸ¥è¯¢ä¼˜åŒ–

- **ç´¢å¼•ä¼˜åŒ–**ï¼šåœ¨MongoDBä¸­å»ºç«‹åˆé€‚çš„ç´¢å¼•
- **åˆ†é¡µæŸ¥è¯¢**ï¼šå¤§æ•°æ®é‡ä½¿ç”¨åˆ†é¡µ
- **èšåˆæŸ¥è¯¢**ï¼šä½¿ç”¨MongoDBèšåˆç®¡é“
- **é¢„è®¡ç®—**ï¼šé€šè¿‡Flinké¢„è®¡ç®—ç»Ÿè®¡æ•°æ®

### 7.2 æ€§èƒ½æŒ‡æ ‡

- **æŸ¥è¯¢å“åº”æ—¶é—´**ï¼š< 500ms (P95)
- **æ•°æ®å»¶è¿Ÿ**ï¼š< 5åˆ†é’Ÿï¼ˆå®æ—¶ç»Ÿè®¡ï¼‰
- **å¹¶å‘æ”¯æŒ**ï¼š200 QPS
- **æ•°æ®ä¿ç•™**ï¼šåŸå§‹æ—¥å¿—ä¿ç•™30å¤©ï¼Œèšåˆæ•°æ®æ°¸ä¹…ä¿ç•™

---

## 8. å®æ–½è®¡åˆ’

### 8.1 å¼€å‘é˜¶æ®µ (8å¤©)

**Phase 1: æ•°æ®é‡‡é›† (2å¤©)**
- [ ] å‰ç«¯åŸ‹ç‚¹å®ç°
- [ ] Kafkaæ¶ˆæ¯é˜Ÿåˆ—é…ç½®
- [ ] æ•°æ®æ¨¡å‹è®¾è®¡

**Phase 2: å®æ—¶è®¡ç®— (2å¤©)**
- [ ] Flinkå®æ—¶è®¡ç®—ä»»åŠ¡
- [ ] æ•°æ®èšåˆé€»è¾‘
- [ ] MongoDBå­˜å‚¨

**Phase 3: ç»Ÿè®¡API (3å¤©)**
- [ ] ä½œå“æ¦‚è§ˆAPI
- [ ] ç« èŠ‚ç»Ÿè®¡API
- [ ] æ”¶å…¥ç»Ÿè®¡API
- [ ] è¶‹åŠ¿åˆ†æAPI

**Phase 4: æ•°æ®å¯¼å‡º (1å¤©)**
- [ ] å¯¼å‡ºåŠŸèƒ½å®ç°
- [ ] æŠ¥è¡¨ç”Ÿæˆ

---

## 9. ç›¸å…³æ–‡æ¡£

- [å†™ä½œç«¯æ¨¡å—è®¾è®¡](./README_å†™ä½œç«¯æ¨¡å—è®¾è®¡æ–‡æ¡£æ€»è§ˆ.md)
- [æ•°æ®åˆ†æç³»ç»Ÿ](../platform/æ•°æ®åˆ†æç³»ç»Ÿ.md)
- [æ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡](../shared/æ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡.md)
- [MongoDBåº”ç”¨å±‚ä¼˜åŒ–è®¾è®¡](../database/MongoDBåº”ç”¨å±‚ä¼˜åŒ–è®¾è®¡.md)

---

**æ–‡æ¡£çŠ¶æ€**: âœ… è®¾è®¡å®Œæˆ  
**æœ€åæ›´æ–°**: 2025-10-17  
**ä¸‹ä¸€æ­¥**: è¿›å…¥å¼€å‘é˜¶æ®µ

