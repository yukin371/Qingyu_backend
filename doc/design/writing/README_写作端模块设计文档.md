# 写作端模块设计文档

> **架构版本**: v2.1  
> **最后更新**: 2025-10-21  
> **模块定位**: 青羽平台写作端核心功能

## 📋 概述

写作端模块为作者提供专业的写作工具和创作环境，支持AI辅助创作、作品管理、数据分析等功能。本模块遵循v2.1架构设计，与AI模块深度集成。

## 🏗️ 模块架构

```
writing/
├── project/            # 2.2 项目管理
├── document/           # 2.2 文档管理
├── editor/             # 2.1 编辑器系统
├── encyclopedia/       # 2.3 设定百科
│   ├── character/      # 角色管理
│   ├── worldsetting/   # 世界观设定
│   ├── timeline/       # 时间线
│   └── location/       # 地理设定
├── ai_assistant/       # 2.4 AI写作助手
├── content_review/     # 2.5 内容审核
├── statistics/         # 2.6 数据统计
└── monetization/       # 2.7 稿费结算
```

## 📚 设计文档索引

### 2.1 编辑器系统 (Editor)

#### [编辑器系统设计](./编辑器系统设计.md)
**功能范围**：
- 双模式编辑（Markdown + 富文本）
- 自动保存和实时同步
- 图片上传和格式转换
- 字数统计

**核心功能**：
- ✅ 30秒自动保存
- ✅ Markdown ↔ 富文本互转
- ✅ MongoDB + GridFS存储
- ✅ 实时字数统计

**状态**：✅ 已完成

### 2.2 项目管理 (Project Management)

#### [项目管理系统设计](./项目管理系统设计.md)
**功能范围**：
- 项目CRUD操作
- 项目分类和标签
- 项目统计（字数、章节数）
- 项目权限管理
- 协作者管理

**核心数据**：
- Project（项目信息）
- ProjectCollaborator（协作者）
- ProjectStatistics（统计数据）

**状态**：✅ 已完成

#### [文档管理系统设计](./文档管理系统设计.md)
**功能范围**：
- 文档树形结构管理
- 文档CRUD操作
- 文档拖拽排序
- 文档层级管理（最多3层）

**核心功能**：
- ✅ 树形结构（卷、章、节、场景）
- ✅ 拖拽排序
- ✅ 文档移动和复制

**状态**：✅ 已完成

### 2.3 设定百科 (Encyclopedia)

#### [世界观设定管理设计](./世界观设定管理设计.md)
**功能范围**：
- 世界观设定管理
- 设定分类和标签
- 设定引用和关联

**状态**：✅ 已完成

#### [角色卡\_关系图设计](./角色卡_关系图设计.md)
**功能范围**：
- 角色卡片管理
- 角色关系图谱
- 角色发展线
- 角色模板

**核心功能**：
- ✅ 角色基本信息（姓名、性格、背景）
- ✅ 关系网络可视化
- ✅ 角色发展弧线

**状态**：✅ 已完成

#### [大纲\_时间\_空间地图设计](./大纲_时间_空间地图设计.md)
**功能范围**：
- 大纲编辑（三幕式、英雄之旅等）
- 时间线管理
- 地图编辑器

**核心功能**：
- ✅ 大纲模板
- ✅ 时间轴可视化
- ✅ 地图标注

**状态**：✅ 已完成

### 2.4 AI写作助手 (AI Writing Assistant)

#### [AI智能辅助系统](./AI智能辅助系统.md)
**功能范围**：
- AI续写和改写
- 创意辅助
- 文本优化
- 智能分析

**v2.1集成**：
- ✅ 集成Python AI Agent系统
- ✅ Agent工具调用（大纲、角色卡、时间线等）
- ✅ RAG检索增强（智能引用用户设定）
- ✅ 流式响应（降低延迟感知）

**相关文档**：
- [Python AI Agent系统架构设计](../ai/07.Python_AI_Agent系统架构设计.md)
- [Agent工具调用集成设计](../ai/09.Agent工具调用集成设计.md)
- [RAG检索增强系统设计](../ai/10.RAG检索增强系统设计.md)

**状态**：✅ 基础功能完成，v2.1增强中

### 2.5 内容审核 (Content Review)

#### [内容审核系统设计](./内容审核系统设计.md)
**功能范围**：
- 敏感词检测
- 合规审核
- 质量检查（错别字、语法）

**核心功能**：
- ✅ 敏感词库管理
- ✅ 实时检测
- ✅ 智能替换建议

**状态**：✅ 已完成

### 2.6 数据统计 (Analytics)

#### [数据统计系统设计](./数据统计系统设计.md)
**功能范围**：
- 作品数据统计（阅读量、完读率）
- 读者画像分析
- 收益统计
- 数据可视化

**核心功能**：
- ✅ 阅读数据统计
- ✅ 读者画像分析
- ✅ 互动数据统计

**状态**：✅ 已完成

### 2.7 稿费结算 (Monetization) - v2.1重新设计

#### [稿费结算系统设计](./稿费结算系统设计.md) ⭐
**功能范围**：
- 收益计算（订阅、打赏、广告、版权）
- 分成比例管理
- 合约管理
- 财务报表生成
- 提现申请流程（业务审核）

**v2.1架构特性**：
- ✅ 业务逻辑层：负责收益计算和分成
- ✅ 与Wallet Service协作：通过API修改余额
- ✅ 不直接操作账本：遵循单一数据源原则

**核心流程**：
```
Monetization Service (业务层)
  ├─ 计算收益金额
  ├─ 应用分成比例
  ├─ 审核提现申请
  └─ 调用Wallet API ──┐
                       │
                       ▼
Wallet Service (技术账本层)
  ├─ 增加/扣除余额（唯一入口）
  ├─ 记录交易
  └─ 处理提现
```

**状态**：✅ v2.1版本已完成

### 其他文档

#### [数据模型设计说明](./数据模型设计说明.md)
**文档类型**：技术文档  
**内容**：写作端核心数据模型设计  
**状态**：✅ 已完成

## 🎯 v2.1架构要点

### AI深度集成

写作端模块与AI模块深度集成：

**Agent工具调用**：
- Agent可直接调用大纲工具、角色卡工具、时间线工具
- 自动化创作框架搭建
- 设定一致性自动检查

**RAG检索增强**：
- 智能检索用户已有设定
- 基于设定的智能续写
- 自动引用和标注

**使用场景示例**：
```
用户: "我想写一部修仙小说，主角叫林风"

Agent自动执行：
1. 调用【大纲工具】→ 生成修仙小说大纲
2. 调用【角色卡工具】→ 创建主角林风的角色卡
3. 调用【关系图谱工具】→ 生成角色关系网络
4. 调用【世界观工具】→ 构建修炼体系
5. 调用【时间线工具】→ 创建主线时间线
6. 调用【设定百科工具】→ 归档所有设定

⏱️ 耗时：约3分钟
📊 输出：完整的创作框架，可直接开始写作
```

### 模块边界优化

**Monetization vs Wallet Service**：

| 模块 | 定位 | 职责 |
|------|------|------|
| **Monetization Service** | 业务逻辑层 | 收益计算、分成比例、合约管理、财务报表 |
| **Wallet Service** | 技术账本层 | 账本记录、余额管理、交易处理、风控检查 |

**协作原则**：
- ✅ Wallet Service是**唯一的资金账本**
- ✅ Monetization Service是**业务流程编排者**
- ✅ Monetization调用Wallet API进行记账

## 🔗 相关文档

### 架构总览
- [青羽平台模块化架构设计v2.1](../青羽平台模块化架构设计v2.1.md) - 第二章：写作端模块

### AI模块集成
- [Python AI Agent系统架构设计](../ai/07.Python_AI_Agent系统架构设计.md)
- [Agent工具调用集成设计](../ai/09.Agent工具调用集成设计.md)
- [RAG检索增强系统设计](../ai/10.RAG检索增强系统设计.md)

### 重构规划
- [模块边界优化方案](../重构规划/模块边界优化方案.md) - Monetization vs Wallet边界

### 相关模块
- [钱包系统](../shared/钱包系统设计.md) - 资金账本管理
- [事件驱动架构](../core/事件驱动架构设计.md) - RAG索引触发

## 🚀 开发优先级

### P0 - 核心功能 (MVP)
1. ✅ 项目管理和文档管理
2. ✅ 基础编辑器（Markdown + 富文本）
3. ✅ 角色卡和大纲管理
4. ✅ AI基础辅助

### P1 - 完善功能
1. ✅ 设定百科完善
2. ✅ AI写作助手完善
3. ✅ 版本控制
4. ✅ 稿费结算v2.1

### P2 - 高级功能 (v2.1重点)
1. 🚧 Agent工具调用集成
2. 🚧 RAG检索增强
3. 🚧 AI流式接口
4. 数据分析增强

## 📞 联系方式

**文档维护者**：青羽写作端架构组  
**最后更新**：2025-10-21  
**架构版本**：v2.1
