# 字数统计服务设计

> **版本**: v1.0  
> **创建日期**: 2025-10-21  
> **状态**: ✅ 已实现，补充设计文档

---

## 1. 设计概述

### 1.1 业务价值

- 实时字数统计（项目、文档、章节）
- 写作进度追踪
- 稿费计算基础数据

### 1.2 实现情况

**已实现**：
- DocumentContent中包含WordCount字段
- 基础字数统计逻辑

**文件位置**：
- `models/document/document.go`
- `service/document/word_count_service.go`（待完善）

---

## 2. 统计策略设计

### 2.1 多级统计

```
Project (项目总字数)
  ↓
Node (节点字数 = 子节点字数之和)
  ↓
Document (文档字数)
  ↓
DocumentContent (内容实际字数)
```

---

## 3. 字数计算规则

### 3.1 中英文混合计算

```go
func CountWords(content string) int {
    // 1. 去除Markdown语法标记
    plain := StripMarkdown(content)
    
    // 2. 统计中文字符
    chineseCount := countChinese(plain)
    
    // 3. 统计英文单词
    englishWords := countEnglishWords(plain)
    
    // 4. 混合计算
    return chineseCount + englishWords
}

func countChinese(text string) int {
    count := 0
    for _, r := range text {
        if unicode.Is(unicode.Scripts["Han"], r) {
            count++
        }
    }
    return count
}

func countEnglishWords(text string) int {
    words := regexp.MustCompile(`[a-zA-Z]+`).FindAllString(text, -1)
    return len(words)
}
```

### 3.2 Markdown处理

```go
func StripMarkdown(content string) string {
    // 移除代码块
    content = regexp.MustCompile("```[\\s\\S]*?```").ReplaceAllString(content, "")
    
    // 移除链接：[text](url) -> text
    content = regexp.MustCompile(`\[([^\]]+)\]\([^\)]+\)`).ReplaceAllString(content, "$1")
    
    // 移除图片：![alt](url) -> ""
    content = regexp.MustCompile(`!\[[^\]]*\]\([^\)]+\)`).ReplaceAllString(content, "")
    
    // 移除标题标记：### Title -> Title
    content = regexp.MustCompile(`^#+\s*`, ).ReplaceAllString(content, "")
    
    // 移除粗体/斜体标记
    content = regexp.MustCompile(`[*_]{1,2}`).ReplaceAllString(content, "")
    
    return content
}
```

---

## 4. 统计更新策略（独特设计）

### 4.1 增量更新

**问题**：每次保存都重新统计整个项目的字数，性能差

**解决方案**：只更新变化的部分

```go
func (s *WordCountService) UpdateDocumentWordCount(ctx context.Context, documentID string, oldWordCount, newWordCount int) error {
    diff := newWordCount - oldWordCount
    
    if diff == 0 {
        return nil  // 字数未变化
    }
    
    // 1. 更新文档字数
    s.documentRepo.Update(ctx, documentID, map[string]interface{}{
        "wordCount": newWordCount,
    })
    
    // 2. 递归更新父节点字数
    doc, _ := s.documentRepo.GetByID(ctx, documentID)
    if doc.ParentNodeID != "" {
        s.updateNodeWordCount(ctx, doc.ParentNodeID, diff)
    }
    
    // 3. 更新项目总字数
    s.updateProjectWordCount(ctx, doc.ProjectID, diff)
    
    return nil
}

func (s *WordCountService) updateNodeWordCount(ctx context.Context, nodeID string, diff int) {
    // 递归更新父节点
    node, _ := s.nodeRepo.GetByID(ctx, nodeID)
    
    newWordCount := node.WordCount + diff
    s.nodeRepo.Update(ctx, nodeID, map[string]interface{}{
        "wordCount": newWordCount,
    })
    
    if node.ParentID != "" {
        s.updateNodeWordCount(ctx, node.ParentID, diff)
    }
}
```

**优势**：
- O(log N)复杂度，只更新路径上的节点
- 避免全量重新计算

### 4.2 定时校准

```go
// 每天凌晨校准一次，防止增量更新累积误差
func (s *WordCountService) RecalibrateProjectWordCount(ctx context.Context, projectID string) error {
    // 1. 重新计算所有文档字数
    totalWords := 0
    documents, _ := s.documentRepo.GetByProjectID(ctx, projectID)
    
    for _, doc := range documents {
        content, _ := s.contentRepo.GetByDocumentID(ctx, doc.ID)
        actualWords := CountWords(content.Content)
        
        // 更新文档字数
        if actualWords != doc.WordCount {
            s.documentRepo.Update(ctx, doc.ID, map[string]interface{}{
                "wordCount": actualWords,
            })
        }
        
        totalWords += actualWords
    }
    
    // 2. 更新项目总字数
    s.projectRepo.Update(ctx, projectID, map[string]interface{}{
        "totalWordCount": totalWords,
    })
    
    return nil
}
```

---

## 5. 写作统计分析

### 5.1 日均字数统计

```go
type WritingStats struct {
    TotalWords    int       // 总字数
    TodayWords    int       // 今日新增
    WeekWords     int       // 本周新增
    MonthWords    int       // 本月新增
    DailyAverage  int       // 日均字数
    WritingDays   int       // 写作天数
    Streak        int       // 连续写作天数
}

func (s *WordCountService) GetWritingStats(ctx context.Context, projectID string) (*WritingStats, error) {
    // 从统计表查询
    stats := &WritingStats{}
    
    // 查询今日字数
    today := time.Now().Format("2006-01-02")
    todayStats, _ := s.statsRepo.GetByDate(ctx, projectID, today)
    stats.TodayWords = todayStats.WordCount
    
    // 查询本周字数
    weekStart := getWeekStart(time.Now())
    stats.WeekWords, _ = s.statsRepo.SumWordCountInPeriod(ctx, projectID, weekStart, time.Now())
    
    // 计算日均和连续天数
    stats.DailyAverage = stats.TotalWords / max(stats.WritingDays, 1)
    stats.Streak = s.calculateStreak(ctx, projectID)
    
    return stats, nil
}
```

### 5.2 写作日历

```go
// 生成写作日历（类似GitHub贡献图）
type WritingCalendar struct {
    Year  int
    Months []MonthData
}

type MonthData struct {
    Month int
    Days  map[int]int  // day -> wordCount
}

func (s *WordCountService) GetWritingCalendar(ctx context.Context, projectID string, year int) (*WritingCalendar, error) {
    // 查询全年的写作记录
    startDate := time.Date(year, 1, 1, 0, 0, 0, 0, time.Local)
    endDate := time.Date(year, 12, 31, 23, 59, 59, 0, time.Local)
    
    records, _ := s.statsRepo.GetByPeriod(ctx, projectID, startDate, endDate)
    
    // 构建日历数据
    calendar := buildCalendar(year, records)
    
    return calendar, nil
}
```

---

## 6. Service层接口

```go
type WordCountService interface {
    // CountWords 计算文本字数
    CountWords(content string) int
    
    // UpdateDocumentWordCount 更新文档字数
    UpdateDocumentWordCount(ctx context.Context, documentID string, oldWordCount, newWordCount int) error
    
    // GetProjectWordCount 获取项目总字数
    GetProjectWordCount(ctx context.Context, projectID string) (int, error)
    
    // GetWritingStats 获取写作统计
    GetWritingStats(ctx context.Context, projectID string) (*WritingStats, error)
    
    // RecalibrateProjectWordCount 校准项目字数
    RecalibrateProjectWordCount(ctx context.Context, projectID string) error
}
```

---

## 7. API设计

```
GET /api/v1/projects/:projectId/wordcount        - 获取项目字数
GET /api/v1/projects/:projectId/writing-stats    - 获取写作统计
GET /api/v1/projects/:projectId/writing-calendar - 获取写作日历
```

---

## 8. 与v2.1架构的关系

```
Writing Module
  └─ Document Module
      └─ WordCountService
          ├─ 实时字数统计
          ├─ 增量更新机制
          └─ 写作分析
```

**事件发布**：
```go
// 字数更新事件（用于成就系统、任务系统）
eventBus.Publish("wordcount.updated", WordCountUpdatedEvent{
    ProjectID:  projectID,
    TotalWords: newTotalWords,
    DailyWords: todayWords,
})
```

---

## 9. 实现参考

**代码文件**：
- `models/document/document.go` - WordCount字段
- `service/document/word_count_service.go`（待创建） - 字数统计服务
- `models/stats/writing_stats.go`（待创建） - 写作统计模型

---

**文档状态**: ✅ 已完成  
**优先级**: P0

