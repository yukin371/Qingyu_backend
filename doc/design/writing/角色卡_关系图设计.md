# 角色卡关系图设计

## 1. 需求概述

### 1.1 功能描述
角色卡关系图是青羽写作系统中用于管理小说角色及其相互关系的核心功能模块。该功能允许用户创建、编辑角色信息，并通过可视化的关系图展示角色之间的复杂关系网络，帮助作者更好地构建和管理小说世界观。

### 1.2 业务价值
- **角色管理**：提供完整的角色信息管理功能，包括基本信息、性格特征、背景故事等
- **关系可视化**：通过图形化界面直观展示角色间的复杂关系网络
- **创作辅助**：帮助作者理清角色关系，避免情节冲突，提升创作质量
- **世界观构建**：支持复杂世界观的构建和管理

### 1.3 用户场景
- 作者创建新角色并设置基本信息
- 建立角色之间的关系（亲情、友情、敌对等）
- 通过关系图查看角色网络
- 编辑角色信息和关系属性
- 删除不需要的角色或关系

### 1.4 功能边界
- 支持角色基本信息管理（姓名、别名、描述、头像等）
- 支持多种关系类型定义
- 支持关系图的可视化展示
- 不包含角色AI生成功能（后续版本支持）

## 2. 架构设计

### 2.1 整体架构
```
┌─────────────────┐
│   Frontend      │ ← 关系图可视化界面
├─────────────────┤
│   Router        │ ← 路由层：/api/v1/character/*
├─────────────────┤
│   API Layer     │ ← HTTP接口处理
├─────────────────┤
│   Service Layer │ ← 业务逻辑处理
├─────────────────┤
│   Model Layer   │ ← 数据模型定义
├─────────────────┤
│   MongoDB       │ ← 数据持久化
└─────────────────┘
```

### 2.2 模块划分
- **CharacterAPI**：角色管理HTTP接口
- **RelationshipAPI**：关系管理HTTP接口
- **CharacterService**：角色业务逻辑
- **RelationshipService**：关系业务逻辑
- **GraphService**：关系图生成服务

### 2.3 数据流向
1. 客户端发送角色或关系操作请求
2. Router层路由到对应API处理函数
3. API层验证参数并调用Service层
4. Service层执行业务逻辑并操作Model层
5. Model层与MongoDB交互
6. 返回结果并更新关系图

### 2.4 技术选型
- **Web框架**：Gin
- **数据库**：MongoDB
- **图形处理**：前端D3.js或类似库
- **认证**：JWT中间件
- **日志**：Zap

## 3. 详细设计

### 3.1 Router层设计
```go
// router/character/character.go
func InitCharacterRouter(router *gin.RouterGroup) {
    characterApi := api.NewCharacterApi()
    relationshipApi := api.NewRelationshipApi()
    
    charGroup := router.Group("/character")
    charGroup.Use(middleware.AuthMiddleware())
    {
        // 角色管理
        charGroup.POST("", characterApi.CreateCharacter)
        charGroup.GET("/:id", characterApi.GetCharacter)
        charGroup.PUT("/:id", characterApi.UpdateCharacter)
        charGroup.DELETE("/:id", characterApi.DeleteCharacter)
        charGroup.GET("/project/:projectId", characterApi.ListCharacters)
        
        // 关系管理
        charGroup.POST("/relationship", relationshipApi.CreateRelationship)
        charGroup.PUT("/relationship/:id", relationshipApi.UpdateRelationship)
        charGroup.DELETE("/relationship/:id", relationshipApi.DeleteRelationship)
        charGroup.GET("/relationship/project/:projectId", relationshipApi.ListRelationships)
        
        // 关系图
        charGroup.GET("/graph/:projectId", characterApi.GetRelationshipGraph)
    }
}
```

### 3.2 API层设计
```go
// api/v1/character/character.go
type CharacterApi struct {
    characterService *service.CharacterService
    graphService     *service.GraphService
}

// CreateCharacter 创建角色
func (api *CharacterApi) CreateCharacter(c *gin.Context) {
    var req CreateCharacterRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.FailWithMessage("参数验证失败", c)
        return
    }
    
    userID := c.GetString("userID")
    character, err := api.characterService.CreateCharacter(userID, &req)
    if err != nil {
        response.FailWithMessage(err.Error(), c)
        return
    }
    
    response.OkWithData(character, c)
}

// GetRelationshipGraph 获取关系图数据
func (api *CharacterApi) GetRelationshipGraph(c *gin.Context) {
    projectID := c.Param("projectId")
    userID := c.GetString("userID")
    
    graph, err := api.graphService.GenerateGraph(userID, projectID)
    if err != nil {
        response.FailWithMessage(err.Error(), c)
        return
    }
    
    response.OkWithData(graph, c)
}
```

### 3.3 Service层设计
```go
// service/character/character.go
type CharacterService struct {
    // 依赖注入
}

func (s *CharacterService) CreateCharacter(userID string, req *CreateCharacterRequest) (*models.Character, error) {
    // 1. 权限验证
    if err := s.validatePermission(userID, req.ProjectID); err != nil {
        return nil, err
    }
    
    // 2. 业务逻辑处理
    character := &models.Character{
        ProjectID:  req.ProjectID,
        Name:       req.Name,
        Alias:      req.Alias,
        Summary:    req.Summary,
        Traits:     req.Traits,
        Background: req.Background,
        AvatarURL:  req.AvatarURL,
        CreatedBy:  userID,
    }
    
    // 3. 数据持久化
    if err := s.saveCharacter(character); err != nil {
        return nil, err
    }
    
    return character, nil
}

// service/character/graph.go
type GraphService struct {
    characterService    *CharacterService
    relationshipService *RelationshipService
}

func (s *GraphService) GenerateGraph(userID, projectID string) (*RelationshipGraph, error) {
    // 1. 获取所有角色
    characters, err := s.characterService.GetCharactersByProject(projectID)
    if err != nil {
        return nil, err
    }
    
    // 2. 获取所有关系
    relationships, err := s.relationshipService.GetRelationshipsByProject(projectID)
    if err != nil {
        return nil, err
    }
    
    // 3. 构建图数据结构
    graph := &RelationshipGraph{
        Nodes: make([]GraphNode, len(characters)),
        Edges: make([]GraphEdge, len(relationships)),
    }
    
    // 4. 填充节点数据
    for i, char := range characters {
        graph.Nodes[i] = GraphNode{
            ID:        char.ID,
            Name:      char.Name,
            AvatarURL: char.AvatarURL,
            Traits:    char.Traits,
        }
    }
    
    // 5. 填充边数据
    for i, rel := range relationships {
        graph.Edges[i] = GraphEdge{
            Source:       rel.FromCharacterID,
            Target:       rel.ToCharacterID,
            Relationship: rel.Type,
            Description:  rel.Description,
        }
    }
    
    return graph, nil
}
```

### 3.4 Model层设计
```go
// models/character/character.go
type Character struct {
    ID         string    `bson:"_id,omitempty" json:"id"`
    ProjectID  string    `bson:"project_id" json:"projectId"`
    Name       string    `bson:"name" json:"name"`
    Alias      []string  `bson:"alias,omitempty" json:"alias,omitempty"`
    Summary    string    `bson:"summary,omitempty" json:"summary,omitempty"`
    Traits     []string  `bson:"traits,omitempty" json:"traits,omitempty"`
    Background string    `bson:"background,omitempty" json:"background,omitempty"`
    AvatarURL  string    `bson:"avatar_url,omitempty" json:"avatarUrl,omitempty"`
    CreatedBy  string    `bson:"created_by" json:"createdBy"`
    CreatedAt  time.Time `bson:"created_at" json:"createdAt"`
    UpdatedAt  time.Time `bson:"updated_at" json:"updatedAt"`
    DeletedAt  *time.Time `bson:"deleted_at,omitempty" json:"deletedAt,omitempty"`
}

// models/character/relationship.go
type Relationship struct {
    ID              string           `bson:"_id,omitempty" json:"id"`
    ProjectID       string           `bson:"project_id" json:"projectId"`
    FromCharacterID string           `bson:"from_character_id" json:"fromCharacterId"`
    ToCharacterID   string           `bson:"to_character_id" json:"toCharacterId"`
    Type            RelationshipType `bson:"type" json:"type"`
    Description     string           `bson:"description,omitempty" json:"description,omitempty"`
    Strength        int              `bson:"strength" json:"strength"` // 关系强度 1-10
    CreatedBy       string           `bson:"created_by" json:"createdBy"`
    CreatedAt       time.Time        `bson:"created_at" json:"createdAt"`
    UpdatedAt       time.Time        `bson:"updated_at" json:"updatedAt"`
}

type RelationshipType string

const (
    RelationshipFamily    RelationshipType = "family"    // 亲情
    RelationshipFriend    RelationshipType = "friend"    // 友情
    RelationshipLove      RelationshipType = "love"      // 爱情
    RelationshipEnemy     RelationshipType = "enemy"     // 敌对
    RelationshipMentor    RelationshipType = "mentor"    // 师生
    RelationshipColleague RelationshipType = "colleague" // 同事
    RelationshipRival     RelationshipType = "rival"     // 竞争
)

// models/character/graph.go
type RelationshipGraph struct {
    Nodes []GraphNode `json:"nodes"`
    Edges []GraphEdge `json:"edges"`
}

type GraphNode struct {
    ID        string   `json:"id"`
    Name      string   `json:"name"`
    AvatarURL string   `json:"avatarUrl,omitempty"`
    Traits    []string `json:"traits,omitempty"`
}

type GraphEdge struct {
    Source       string `json:"source"`
    Target       string `json:"target"`
    Relationship string `json:"relationship"`
    Description  string `json:"description,omitempty"`
    Strength     int    `json:"strength"`
}
```

## 4. 数据设计

### 4.1 数据库设计

#### 4.1.1 集合设计
- **characters**：存储角色信息
- **relationships**：存储角色关系信息

#### 4.1.2 索引设计
```javascript
// characters集合索引
db.characters.createIndex({ "project_id": 1 })
db.characters.createIndex({ "project_id": 1, "name": 1 })
db.characters.createIndex({ "created_by": 1 })

// relationships集合索引
db.relationships.createIndex({ "project_id": 1 })
db.relationships.createIndex({ "from_character_id": 1 })
db.relationships.createIndex({ "to_character_id": 1 })
db.relationships.createIndex({ "project_id": 1, "from_character_id": 1, "to_character_id": 1 })
```

#### 4.1.3 数据约束
- 角色名称在同一项目内不能重复
- 关系不能自指向（from_character_id != to_character_id）
- 关系强度范围：1-10

### 4.2 数据迁移策略
- 支持从旧版本数据结构平滑迁移
- 提供数据导入导出功能
- 支持批量数据操作

## 5. API设计

### 5.1 角色管理API

#### 5.1.1 创建角色
```
POST /api/v1/character
Content-Type: application/json
Authorization: Bearer <token>

{
    "projectId": "string",
    "name": "string",
    "alias": ["string"],
    "summary": "string",
    "traits": ["string"],
    "background": "string",
    "avatarUrl": "string"
}

Response:
{
    "code": 200,
    "message": "success",
    "data": {
        "id": "string",
        "projectId": "string",
        "name": "string",
        "alias": ["string"],
        "summary": "string",
        "traits": ["string"],
        "background": "string",
        "avatarUrl": "string",
        "createdBy": "string",
        "createdAt": "2024-01-01T00:00:00Z",
        "updatedAt": "2024-01-01T00:00:00Z"
    }
}
```

#### 5.1.2 获取角色列表
```
GET /api/v1/character/project/{projectId}?page=1&size=20
Authorization: Bearer <token>

Response:
{
    "code": 200,
    "message": "success",
    "data": {
        "list": [Character],
        "total": 100,
        "page": 1,
        "size": 20
    }
}
```

### 5.2 关系管理API

#### 5.2.1 创建关系
```
POST /api/v1/character/relationship
Content-Type: application/json
Authorization: Bearer <token>

{
    "projectId": "string",
    "fromCharacterId": "string",
    "toCharacterId": "string",
    "type": "family|friend|love|enemy|mentor|colleague|rival",
    "description": "string",
    "strength": 5
}
```

#### 5.2.2 获取关系图
```
GET /api/v1/character/graph/{projectId}
Authorization: Bearer <token>

Response:
{
    "code": 200,
    "message": "success",
    "data": {
        "nodes": [
            {
                "id": "string",
                "name": "string",
                "avatarUrl": "string",
                "traits": ["string"]
            }
        ],
        "edges": [
            {
                "source": "string",
                "target": "string",
                "relationship": "string",
                "description": "string",
                "strength": 5
            }
        ]
    }
}
```

## 6. 安全设计

### 6.1 认证授权
- 使用JWT中间件进行用户身份验证
- 基于项目权限控制角色和关系的访问
- 支持角色级别的权限控制（创建者、协作者、只读）

### 6.2 数据安全
- 输入参数验证和过滤
- SQL注入防护（MongoDB注入防护）
- XSS攻击防护
- 敏感数据加密存储

### 6.3 API安全
- 请求频率限制
- 参数长度限制
- 文件上传安全检查（头像上传）

## 7. 测试设计

### 7.1 单元测试
- Service层业务逻辑测试
- Model层数据操作测试
- 工具函数测试

### 7.2 集成测试
- API接口测试
- 数据库操作测试
- 权限验证测试

### 7.3 性能测试
- 大量角色数据查询性能
- 复杂关系图生成性能
- 并发操作测试

### 7.4 测试用例
```go
func TestCreateCharacter(t *testing.T) {
    // 测试正常创建角色
    // 测试重复名称创建
    // 测试无效项目ID
    // 测试权限验证
}

func TestGenerateGraph(t *testing.T) {
    // 测试空关系图生成
    // 测试复杂关系图生成
    // 测试性能边界
}
```

## 8. 部署和运维

### 8.1 部署要求
- MongoDB 4.4+
- Go 1.19+
- 内存：最少2GB，推荐4GB
- 存储：根据角色数量和头像文件大小确定

### 8.2 监控指标
- API响应时间
- 数据库查询性能
- 内存使用情况
- 错误率统计

### 8.3 日志记录
- 用户操作日志
- 系统错误日志
- 性能监控日志
- 安全审计日志

### 8.4 备份策略
- 数据库定期备份
- 头像文件备份
- 配置文件备份

## 9. 风险评估

### 9.1 技术风险
- **数据一致性风险**：角色删除时关系数据的清理
  - 缓解措施：实现软删除和级联清理机制
- **性能风险**：大型关系图渲染性能问题
  - 缓解措施：实现分页加载和图形优化算法
- **并发风险**：多用户同时编辑同一角色
  - 缓解措施：实现乐观锁机制

### 9.2 业务风险
- **数据丢失风险**：用户误删重要角色数据
  - 缓解措施：实现回收站功能和数据恢复机制
- **权限风险**：未授权用户访问他人角色数据
  - 缓解措施：严格的权限验证和审计日志

### 9.3 运维风险
- **存储风险**：头像文件存储空间不足
  - 缓解措施：实现文件压缩和云存储迁移
- **备份风险**：数据备份失败或恢复困难
  - 缓解措施：多重备份策略和定期恢复测试

## 10. 实施计划

### 10.1 开发阶段
1. **第一阶段**（1-2周）：基础数据模型和API开发
2. **第二阶段**（2-3周）：关系图生成和可视化功能
3. **第三阶段**（1周）：安全加固和性能优化
4. **第四阶段**（1周）：测试和文档完善

### 10.2 测试阶段
- 单元测试：与开发并行进行
- 集成测试：第三阶段完成后
- 用户验收测试：第四阶段

### 10.3 上线计划
- 灰度发布：先向部分用户开放
- 全量发布：灰度测试通过后
- 监控和优化：上线后持续进行

### 10.4 里程碑
- M1：基础CRUD功能完成
- M2：关系图功能完成
- M3：测试和优化完成
- M4：正式上线

**字段说明：**

- `ID`：角色唯一标识符
- `ProjectID`：所属项目ID，实现项目级别的数据隔离
- `Name`：角色姓名（必填）
- `Alias`：角色别名列表，支持多个别名
- `Summary`：角色简介
- `Traits`：性格标签数组，用于快速识别角色特征
- `Background`：角色背景故事
- `AvatarURL`：角色头像URL
- `CreatedAt/UpdatedAt`：时间戳字段

### 3.2 角色关系模型 (CharacterRelation)

```go
type CharacterRelation struct {
    ID        string       `bson:"_id,omitempty" json:"id"`
    ProjectID string       `bson:"project_id" json:"projectId"`
    FromID    string       `bson:"from_id" json:"fromId"`
    ToID      string       `bson:"to_id" json:"toId"`
    Type      RelationType `bson:"type" json:"type"`
    Strength  int          `bson:"strength" json:"strength"` // 0-100 强度
    Notes     string       `bson:"notes,omitempty" json:"notes,omitempty"`
    CreatedAt time.Time    `bson:"created_at" json:"createdAt"`
    UpdatedAt time.Time    `bson:"updated_at" json:"updatedAt"`
}
```

**字段说明：**
- `FromID/ToID`：关系的起点和终点角色ID，支持有向关系
- `Type`：关系类型（枚举值）
- `Strength`：关系强度（0-100），用于关系图中的视觉权重
- `Notes`：关系备注，描述具体的关系细节

### 3.3 关系类型枚举 (RelationType)

```go
type RelationType string

const (
    RelationFriend  RelationType = "朋友"
    RelationFamily  RelationType = "家庭"
    RelationEnemy   RelationType = "敌人"
    RelationRomance RelationType = "恋人"
    RelationAlly    RelationType = "盟友"
    RelationOther   RelationType = "其他"
)
```

**设计考虑：**
- 使用中文枚举值，便于用户理解
- 提供 `RelationOther` 作为扩展选项
- 包含验证函数 `IsValidRelationType()` 确保数据有效性

## 4. 数据库设计

### 4.1 集合结构

#### 4.1.1 characters 集合
```javascript
{
  "_id": ObjectId,
  "project_id": String,
  "name": String,
  "alias": [String],
  "summary": String,
  "traits": [String],
  "background": String,
  "avatar_url": String,
  "created_at": ISODate,
  "updated_at": ISODate
}
```

#### 4.1.2 character_relations 集合
```javascript
{
  "_id": ObjectId,
  "project_id": String,
  "from_id": String,
  "to_id": String,
  "type": String,
  "strength": Number,
  "notes": String,
  "created_at": ISODate,
  "updated_at": ISODate
}
```

### 4.2 索引设计

#### 4.2.1 characters 集合索引
```javascript
// 项目级查询索引
{ "project_id": 1, "created_at": -1 }

// 角色名称搜索索引
{ "project_id": 1, "name": 1 }

// 别名搜索索引
{ "project_id": 1, "alias": 1 }

// 性格标签搜索索引
{ "project_id": 1, "traits": 1 }
```

#### 4.2.2 character_relations 集合索引
```javascript
// 查询某角色的所有关系
{ "project_id": 1, "from_id": 1 }
{ "project_id": 1, "to_id": 1 }

// 查询特定关系类型
{ "project_id": 1, "type": 1 }

// 复合查询索引
{ "project_id": 1, "from_id": 1, "type": 1 }
```

## 5. 业务逻辑设计

### 5.1 Service 层设计

#### 5.1.1 CharacterService

```go
type CharacterService struct{}

// 角色管理方法
func (s *CharacterService) CreateCharacter(ctx context.Context, character *Character) (*Character, error)
func (s *CharacterService) GetCharacterByID(ctx context.Context, projectID, characterID string) (*Character, error)
func (s *CharacterService) ListCharacters(ctx context.Context, projectID string, limit, offset int) ([]*Character, error)
func (s *CharacterService) UpdateCharacter(ctx context.Context, projectID, characterID string, updates *Character) (*Character, error)
func (s *CharacterService) DeleteCharacter(ctx context.Context, projectID, characterID string) error
func (s *CharacterService) SearchCharacters(ctx context.Context, projectID, keyword string) ([]*Character, error)
```

#### 5.1.2 CharacterRelationService

```go
type CharacterRelationService struct{}

// 关系管理方法
func (s *CharacterRelationService) CreateRelation(ctx context.Context, relation *CharacterRelation) (*CharacterRelation, error)
func (s *CharacterRelationService) GetRelationsByCharacter(ctx context.Context, projectID, characterID string) ([]*CharacterRelation, error)
func (s *CharacterRelationService) UpdateRelation(ctx context.Context, relationID string, updates *CharacterRelation) (*CharacterRelation, error)
func (s *CharacterRelationService) DeleteRelation(ctx context.Context, relationID string) error

// 关系图专用方法
func (s *CharacterRelationService) GetRelationGraph(ctx context.Context, projectID string) (*RelationGraph, error)
func (s *CharacterRelationService) GetCharacterNetwork(ctx context.Context, projectID, characterID string, depth int) (*CharacterNetwork, error)
```

### 5.2 关系图数据结构

#### 5.2.1 关系图响应模型

```go
// RelationGraph 完整的关系图数据
type RelationGraph struct {
    Nodes []*GraphNode `json:"nodes"`
    Edges []*GraphEdge `json:"edges"`
}

// GraphNode 图节点（角色）
type GraphNode struct {
    ID       string   `json:"id"`
    Name     string   `json:"name"`
    Avatar   string   `json:"avatar,omitempty"`
    Traits   []string `json:"traits,omitempty"`
    Summary  string   `json:"summary,omitempty"`
}

// GraphEdge 图边（关系）
type GraphEdge struct {
    ID       string       `json:"id"`
    Source   string       `json:"source"`
    Target   string       `json:"target"`
    Type     RelationType `json:"type"`
    Strength int          `json:"strength"`
    Notes    string       `json:"notes,omitempty"`
}
```

#### 5.2.2 角色网络模型

```go
// CharacterNetwork 以某个角色为中心的关系网络
type CharacterNetwork struct {
    CenterCharacter *Character           `json:"centerCharacter"`
    DirectRelations []*RelationWithChar `json:"directRelations"`
    IndirectRelations []*RelationWithChar `json:"indirectRelations,omitempty"`
}

// RelationWithChar 带角色信息的关系
type RelationWithChar struct {
    Relation  *CharacterRelation `json:"relation"`
    Character *Character         `json:"character"`
}
```

### 5.3 业务规则

#### 5.3.1 关系管理规则
1. **双向关系处理**：
   - 对称关系（如朋友、恋人）自动创建双向边
   - 非对称关系（如上下级）仅创建单向边

2. **关系强度计算**：
   - 基于关系类型设置默认强度
   - 支持用户手动调整强度值
   - 强度影响关系图中的视觉表现

3. **关系冲突检测**：
   - 检测矛盾关系（如同时为朋友和敌人）
   - 提供关系冲突警告机制

#### 5.3.2 数据一致性规则
1. **级联删除**：删除角色时自动删除相关的所有关系
2. **引用完整性**：确保关系中的角色ID有效
3. **项目隔离**：严格按项目ID进行数据隔离

## 6. API 接口设计

### 6.1 角色管理接口

```
POST   /api/v1/projects/{projectId}/characters          # 创建角色
GET    /api/v1/projects/{projectId}/characters          # 获取角色列表
GET    /api/v1/projects/{projectId}/characters/{id}     # 获取角色详情
PUT    /api/v1/projects/{projectId}/characters/{id}     # 更新角色
DELETE /api/v1/projects/{projectId}/characters/{id}     # 删除角色
GET    /api/v1/projects/{projectId}/characters/search   # 搜索角色
```

### 6.2 关系管理接口

```
POST   /api/v1/projects/{projectId}/relations           # 创建关系
GET    /api/v1/projects/{projectId}/relations           # 获取关系列表
GET    /api/v1/projects/{projectId}/relations/{id}      # 获取关系详情
PUT    /api/v1/projects/{projectId}/relations/{id}      # 更新关系
DELETE /api/v1/projects/{projectId}/relations/{id}      # 删除关系
```

### 6.3 关系图接口

```
GET    /api/v1/projects/{projectId}/relation-graph      # 获取完整关系图
GET    /api/v1/projects/{projectId}/characters/{id}/network  # 获取角色关系网络
```

### 6.4 接口响应格式

#### 6.4.1 标准响应格式
```json
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": "2024-01-01T00:00:00Z"
}
```

#### 6.4.2 关系图响应示例
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "nodes": [
      {
        "id": "char_001",
        "name": "张三",
        "avatar": "https://example.com/avatar1.jpg",
        "traits": ["勇敢", "正直"],
        "summary": "主角，正义感强烈的年轻人"
      }
    ],
    "edges": [
      {
        "id": "rel_001",
        "source": "char_001",
        "target": "char_002",
        "type": "朋友",
        "strength": 85,
        "notes": "从小一起长大的好友"
      }
    ]
  }
}
```

## 7. 前端集成考虑

### 7.1 关系图可视化
- **图形库选择**：推荐使用 D3.js 或 Cytoscape.js
- **布局算法**：支持力导向布局、层次布局等多种布局方式
- **交互功能**：节点拖拽、缩放、筛选、搜索等

### 7.2 性能优化
- **分页加载**：大量角色时采用分页或虚拟滚动
- **按需渲染**：根据视口范围动态渲染节点
- **缓存策略**：合理使用浏览器缓存和内存缓存

## 8. 扩展性设计

### 8.1 未来功能扩展
1. **关系时间线**：支持关系的时间维度变化
2. **关系强度动态计算**：基于情节发展自动调整关系强度
3. **角色群组**：支持角色分组管理
4. **关系模板**：预定义常见的关系模式

### 8.2 数据迁移考虑
- 预留扩展字段，便于未来功能升级
- 设计向后兼容的数据结构
- 提供数据迁移脚本和工具

## 9. 安全性考虑

### 9.1 权限控制
- 基于项目的访问控制
- 角色和关系的操作权限验证
- 防止跨项目数据访问

### 9.2 数据验证
- 输入参数严格验证
- 关系类型枚举值验证
- 防止SQL注入和XSS攻击

## 10. 测试策略

### 10.1 单元测试
- Model 层数据验证测试
- Service 层业务逻辑测试
- API 层接口测试

### 10.2 集成测试
- 数据库操作集成测试
- 完整业务流程测试
- 性能压力测试

## 11. 部署和监控

### 11.1 部署考虑
- MongoDB 索引优化
- 连接池配置
- 缓存策略配置

### 11.2 监控指标
- API 响应时间
- 数据库查询性能
- 内存使用情况
- 错误率统计

## 关联文档
- 软件需求规格说明书(SRS) ../软件需求规格说明书(SRS).md
- 架构设计说明书 ../架构设计说明书.md
- API 接口总览 ../API接口总览.md
- 数据库设计说明书 ../数据库设计说明书.md
- 测试计划与用例 ../测试计划与用例.md
- 部署与运维指南 ../部署与运维指南.md
- 安全设计与威胁建模 ../安全设计与威胁建模.md
- 日志与监控 ../日志与监控.md
- 需求追踪矩阵 ../需求追踪矩阵.md

### 11.2 监控指标
- API 响应时间
- 数据库查询性能
- 内存使用情况
- 错误率统计

---

**文档版本**：v1.0  
**创建日期**：2024-01-01  
**最后更新**：2024-01-01  
**维护者**：青羽写作团队