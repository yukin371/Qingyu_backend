# 稿费结算系统设计 (Monetization Module)

> **文档版本**: v2.0  
> **创建时间**: 2025-10-21  
> **更新**: 明确与Wallet Service的职责分离

## 📋 文档概述

本文档设计稿费结算系统（Monetization Service），专注于业务逻辑层的收益计算、分成比例和合约管理，与Wallet Service协作完成资金操作。

---

## 一、模块职责

### 1.1 Monetization Service (业务逻辑层)

**职责**：
- ✅ 收益计算（订阅、打赏、广告、版权）
- ✅ 分成比例管理
- ✅ 合约管理
- ✅ 财务报表生成
- ✅ 提现申请流程（业务审核）
- ✅ 税务处理

**不负责**：
- ❌ 直接修改账户余额
- ❌ 交易记录管理
- ❌ 资金风控

### 1.2 与Wallet Service协作

```
Monetization Service (业务层)
  ├─ 计算收益金额
  ├─ 应用分成比例
  ├─ 审核提现申请
  └─ 调用Wallet API ──┐
                       │
                       ▼
Wallet Service (技术账本层)
  ├─ 增加/扣除余额（唯一入口）
  ├─ 记录交易
  ├─ 风控检查
  └─ 处理提现（技术操作）
```

---

## 二、数据模型

### 2.1 Revenue (收益记录)

```go
type Revenue struct {
    ID          string    `bson:"_id" json:"id"`
    AuthorID    string    `bson:"author_id" json:"authorId"`
    BookID      string    `bson:"book_id" json:"bookId"`
    ChapterID   string    `bson:"chapter_id,omitempty" json:"chapterId,omitempty"`
    Source      string    `bson:"source" json:"source"` // subscription, reward, ad, copyright
    Amount      float64   `bson:"amount" json:"amount"` // 原始金额
    ShareRatio  float64   `bson:"share_ratio" json:"shareRatio"` // 分成比例
    AuthorShare float64   `bson:"author_share" json:"authorShare"` // 作者实际收入
    Status      string    `bson:"status" json:"status"` // pending, settled
    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`
    SettledAt   *time.Time `bson:"settled_at,omitempty" json:"settledAt,omitempty"`
}
```

### 2.2 Contract (合约)

```go
type Contract struct {
    ID                  string    `bson:"_id" json:"id"`
    AuthorID            string    `bson:"author_id" json:"authorId"`
    Type                string    `bson:"type" json:"type"` // standard, premium, exclusive
    ShareRatio          float64   `bson:"share_ratio" json:"shareRatio"` // 0-1
    MinWithdrawalAmount float64   `bson:"min_withdrawal_amount" json:"minWithdrawalAmount"`
    StartDate           time.Time `bson:"start_date" json:"startDate"`
    EndDate             *time.Time `bson:"end_date,omitempty" json:"endDate,omitempty"`
    Status              string    `bson:"status" json:"status"`
}
```

---

## 三、Service接口

```go
package monetization

type MonetizationService interface {
    // 收益计算
    RecordRevenue(ctx context.Context, authorID, bookID, chapterID string, amount float64) error
    CalculateRevenue(ctx context.Context, authorID string, period Period) (*RevenueReport, error)
    
    // 分成管理
    GetShareConfig(ctx context.Context, authorID string) (*ShareConfig, error)
    
    // 合约管理
    GetContract(ctx context.Context, authorID string) (*Contract, error)
    CreateContract(ctx context.Context, contract *Contract) error
    
    // 提现申请（业务层）
    RequestWithdrawal(ctx context.Context, req *WithdrawalRequest) (*WithdrawalOrder, error)
    ApproveWithdrawal(ctx context.Context, orderID, adminID string) error
    
    // 财务报表
    GenerateFinancialReport(ctx context.Context, authorID string, period Period) (*FinancialReport, error)
    
    // 事件处理
    OnChapterPurchased(ctx context.Context, event *ChapterPurchasedEvent) error
}
```

---

## 四、业务流程

### 4.1 用户购买章节

```go
func (ms *MonetizationServiceImpl) OnChapterPurchased(ctx context.Context, event *ChapterPurchasedEvent) error {
    // 1. 获取合约和分成比例
    contract, _ := ms.GetContract(ctx, event.AuthorID)
    shareRatio := contract.ShareRatio
    
    // 2. 计算作者收益
    authorShare := event.Amount * shareRatio
    
    // 3. 记录收益
    revenue := &Revenue{
        AuthorID:    event.AuthorID,
        BookID:      event.BookID,
        ChapterID:   event.ChapterID,
        Source:      "subscription",
        Amount:      event.Amount,
        ShareRatio:  shareRatio,
        AuthorShare: authorShare,
        Status:      "pending",
    }
    
    if err := ms.revenueRepo.Create(ctx, revenue); err != nil {
        return err
    }
    
    // 4. 调用Wallet Service增加作者余额（唯一入口）
    _, err := ms.walletService.Recharge(
        ctx,
        event.AuthorID,
        authorShare,
        fmt.Sprintf("chapter_revenue_%s", event.ChapterID),
    )
    
    if err != nil {
        // 标记收益失败，后续补偿
        revenue.Status = "failed"
        ms.revenueRepo.Update(ctx, revenue)
        return err
    }
    
    // 5. 标记收益已结算
    revenue.Status = "settled"
    now := time.Now()
    revenue.SettledAt = &now
    ms.revenueRepo.Update(ctx, revenue)
    
    return nil
}
```

### 4.2 作者提现

```go
func (ms *MonetizationServiceImpl) RequestWithdrawal(ctx context.Context, req *WithdrawalRequest) (*WithdrawalOrder, error) {
    // 1. 业务规则检查
    contract, _ := ms.GetContract(ctx, req.AuthorID)
    if req.Amount < contract.MinWithdrawalAmount {
        return nil, errors.New("提现金额不足")
    }
    
    // 2. 查询Wallet余额
    balance, _ := ms.walletService.GetBalance(ctx, req.AuthorID)
    if balance < req.Amount {
        return nil, errors.New("余额不足")
    }
    
    // 3. 风控检查（Wallet提供）
    passed, _ := ms.walletService.CheckRiskControl(ctx, req.AuthorID, req.Amount)
    if !passed {
        return nil, errors.New("风控未通过")
    }
    
    // 4. 计算税费
    tax := ms.CalculateTax(ctx, req.Amount, req.AuthorID)
    
    // 5. 创建提现订单
    order := &WithdrawalOrder{
        ID:        uuid.New().String(),
        AuthorID:  req.AuthorID,
        Amount:    req.Amount,
        Fee:       req.Amount * 0.01,
        Tax:       tax,
        NetAmount: req.Amount - req.Amount*0.01 - tax,
        Status:    "pending",
    }
    
    ms.orderRepo.Create(ctx, order)
    
    // 6. 调用Wallet Service冻结资金
    if err := ms.walletService.FreezeForWithdrawal(ctx, req.AuthorID, req.Amount, order.ID); err != nil {
        return nil, err
    }
    
    return order, nil
}
```

---

**文档版本**: v2.0  
**创建时间**: 2025-10-21

