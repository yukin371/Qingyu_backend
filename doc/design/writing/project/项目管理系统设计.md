# 项目管理系统设计文档

> **版本**: v1.0  
> **创建日期**: 2025-10-16  
> **最后更新**: 2025-10-16  
> **维护者**: 青羽写作团队

## 1. 概述

### 1.1 功能描述

项目管理系统是青羽写作平台的基础模块,为作者提供创作项目的全生命周期管理功能。系统支持项目创建、编辑、删除、权限管理、统计分析等核心功能,是写作端的入口和组织中心。

### 1.2 业务价值

- **项目组织**：提供清晰的项目结构和分类管理
- **权限控制**：支持多人协作和权限管理
- **数据统计**：实时统计项目进度和创作数据
- **版本发布**：支持作品发布到书城的管理

### 1.3 用户场景

1. **创建新项目**：作者开始新的创作项目
2. **项目管理**：查看、编辑、删除项目
3. **协作管理**：邀请协作者共同创作
4. **进度跟踪**：查看项目统计和创作进度
5. **作品发布**：将项目发布到书城

### 1.4 功能边界

**包含功能**：
- 项目CRUD操作
- 项目分类和标签管理
- 项目封面和简介管理
- 项目统计（字数、章节数等）
- 项目权限管理
- 项目状态管理（草稿、连载、完结）

**不包含功能**：
- 具体文档内容编辑（由编辑器模块负责）
- 发布审核流程（由审核模块负责）
- 读者互动功能（由阅读端负责）

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────┐
│         Router Layer (路由层)            │
│         /api/v1/projects/*              │
├─────────────────────────────────────────┤
│         API Layer (接口层)               │
│          ProjectApi                     │
├─────────────────────────────────────────┤
│        Service Layer (业务逻辑层)         │
│      ProjectService                     │
├─────────────────────────────────────────┤
│      Repository Layer (数据访问层)        │
│     ProjectRepository                   │
├─────────────────────────────────────────┤
│        Model Layer (数据模型层)           │
│           Project                       │
├─────────────────────────────────────────┤
│         MongoDB (存储层)                 │
└─────────────────────────────────────────┘
```

### 2.2 模块划分

- **ProjectService**：项目管理核心服务
- **ProjectStatisticsService**：项目统计服务
- **ProjectPermissionService**：项目权限管理服务
- **ProjectPublishService**：项目发布服务

### 2.3 数据流设计

```
用户请求 → 权限验证 → 业务逻辑 → 数据持久化 → 统计更新 → 缓存更新 → 响应返回
```

### 2.4 技术选型

- **Go**: 1.21+
- **Gin**: Web框架
- **MongoDB**: 数据存储
- **Redis**: 缓存和统计

## 3. 详细设计

### 3.1 数据模型设计

#### 3.1.1 Project模型

```go
// models/document/project.go
package document

import "time"

// Project 项目模型
type Project struct {
    ID          string         `bson:"_id,omitempty" json:"id"`
    AuthorID    string         `bson:"author_id" json:"authorId" validate:"required"`
    Title       string         `bson:"title" json:"title" validate:"required,min=1,max=100"`
    Summary     string         `bson:"summary,omitempty" json:"summary,omitempty"`
    CoverURL    string         `bson:"cover_url,omitempty" json:"coverUrl,omitempty"`
    Status      ProjectStatus  `bson:"status" json:"status"`
    Category    string         `bson:"category,omitempty" json:"category,omitempty"`
    Tags        []string       `bson:"tags,omitempty" json:"tags,omitempty"`
    Visibility  Visibility     `bson:"visibility" json:"visibility"`
    
    // 统计信息
    Statistics  ProjectStats   `bson:"statistics" json:"statistics"`
    
    // 设置信息
    Settings    ProjectSettings `bson:"settings" json:"settings"`
    
    // 协作信息
    Collaborators []Collaborator `bson:"collaborators,omitempty" json:"collaborators,omitempty"`
    
    // 时间戳
    CreatedAt   time.Time      `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time      `bson:"updated_at" json:"updatedAt"`
    PublishedAt *time.Time     `bson:"published_at,omitempty" json:"publishedAt,omitempty"`
    DeletedAt   *time.Time     `bson:"deleted_at,omitempty" json:"deletedAt,omitempty"`
}

// ProjectStatus 项目状态
type ProjectStatus string

const (
    StatusDraft     ProjectStatus = "draft"     // 草稿
    StatusSerializing ProjectStatus = "serializing" // 连载中
    StatusCompleted ProjectStatus = "completed" // 已完结
    StatusSuspended ProjectStatus = "suspended" // 暂停
    StatusArchived  ProjectStatus = "archived"  // 已归档
)

// Visibility 可见性
type Visibility string

const (
    VisibilityPrivate Visibility = "private" // 私密
    VisibilityPublic  Visibility = "public"  // 公开
)

// ProjectStats 项目统计
type ProjectStats struct {
    TotalWords    int       `bson:"total_words" json:"totalWords"`       // 总字数
    ChapterCount  int       `bson:"chapter_count" json:"chapterCount"`   // 章节数
    DocumentCount int       `bson:"document_count" json:"documentCount"` // 文档数
    LastUpdateAt  time.Time `bson:"last_update_at" json:"lastUpdateAt"`  // 最后更新时间
}

// ProjectSettings 项目设置
type ProjectSettings struct {
    AutoBackup     bool   `bson:"auto_backup" json:"autoBackup"`         // 自动备份
    BackupInterval int    `bson:"backup_interval" json:"backupInterval"` // 备份间隔（小时）
    WordCountGoal  int    `bson:"word_count_goal,omitempty" json:"wordCountGoal,omitempty"` // 字数目标
}

// Collaborator 协作者
type Collaborator struct {
    UserID     string           `bson:"user_id" json:"userId"`
    Role       CollaboratorRole `bson:"role" json:"role"`
    InvitedAt  time.Time        `bson:"invited_at" json:"invitedAt"`
    AcceptedAt *time.Time       `bson:"accepted_at,omitempty" json:"acceptedAt,omitempty"`
}

// CollaboratorRole 协作者角色
type CollaboratorRole string

const (
    RoleOwner  CollaboratorRole = "owner"  // 所有者
    RoleEditor CollaboratorRole = "editor" // 编辑者
    RoleViewer CollaboratorRole = "viewer" // 查看者
)

// 业务方法
func (p *Project) IsOwner(userID string) bool {
    return p.AuthorID == userID
}

func (p *Project) CanEdit(userID string) bool {
    if p.IsOwner(userID) {
        return true
    }
    
    for _, collab := range p.Collaborators {
        if collab.UserID == userID && collab.Role == RoleEditor && collab.AcceptedAt != nil {
            return true
        }
    }
    
    return false
}

func (p *Project) CanView(userID string) bool {
    if p.CanEdit(userID) {
        return true
    }
    
    for _, collab := range p.Collaborators {
        if collab.UserID == userID && collab.AcceptedAt != nil {
            return true
        }
    }
    
    return p.Visibility == VisibilityPublic
}

func (p *Project) UpdateStatistics(stats ProjectStats) {
    p.Statistics = stats
    p.UpdatedAt = time.Now()
}
```

### 3.2 Repository层设计

#### 3.2.1 ProjectRepository接口

```go
// repository/interfaces/writing/project_repository.go
package writing

import (
    "context"
    "qingyu_backend/models/document"
    "qingyu_backend/repository/interfaces/infrastructure"
)

type ProjectRepository interface {
    // 基础CRUD操作
    Create(ctx context.Context, project *document.Project) error
    GetByID(ctx context.Context, id string) (*document.Project, error)
    GetByAuthorID(ctx context.Context, authorID string) ([]*document.Project, error)
    Update(ctx context.Context, id string, updates map[string]interface{}) error
    Delete(ctx context.Context, id string) error
    
    // 查询操作
    List(ctx context.Context, filter infrastructure.Filter) ([]*document.Project, error)
    FindWithPagination(ctx context.Context, filter infrastructure.Filter, pagination infrastructure.Pagination) (*infrastructure.PagedResult[document.Project], error)
    
    // 统计操作
    UpdateStatistics(ctx context.Context, id string, stats *document.ProjectStats) error
    GetStatistics(ctx context.Context, id string) (*document.ProjectStats, error)
    
    // 协作者操作
    AddCollaborator(ctx context.Context, projectID string, collaborator *document.Collaborator) error
    RemoveCollaborator(ctx context.Context, projectID, userID string) error
    UpdateCollaboratorRole(ctx context.Context, projectID, userID string, role document.CollaboratorRole) error
    GetCollaborators(ctx context.Context, projectID string) ([]*document.Collaborator, error)
    
    // 状态操作
    UpdateStatus(ctx context.Context, id string, status document.ProjectStatus) error
    
    // 软删除
    SoftDelete(ctx context.Context, id string) error
    Restore(ctx context.Context, id string) error
    
    // 健康检查
    Health(ctx context.Context) error
}
```

#### 3.2.2 MongoDB实现

```go
// repository/mongodb/writing/project_repository_mongo.go
package writing

import (
    "context"
    "fmt"
    "time"
    
    "go.mongodb.org/mongo-driver/bson"
    "go.mongodb.org/mongo-driver/bson/primitive"
    "go.mongodb.org/mongo-driver/mongo"
    "go.mongodb.org/mongo-driver/mongo/options"
    
    "qingyu_backend/models/document"
    "qingyu_backend/repository/interfaces/infrastructure"
)

type MongoProjectRepository struct {
    collection   *mongo.Collection
    queryBuilder infrastructure.QueryBuilder
}

func NewMongoProjectRepository(db *mongo.Database) *MongoProjectRepository {
    return &MongoProjectRepository{
        collection:   db.Collection("projects"),
        queryBuilder: mongodb.NewMongoQueryBuilder(),
    }
}

// Create 创建项目
func (r *MongoProjectRepository) Create(ctx context.Context, project *document.Project) error {
    project.ID = primitive.NewObjectID().Hex()
    project.CreatedAt = time.Now()
    project.UpdatedAt = time.Now()
    project.Status = document.StatusDraft
    project.Visibility = document.VisibilityPrivate
    
    // 初始化统计
    project.Statistics = document.ProjectStats{
        TotalWords:    0,
        ChapterCount:  0,
        DocumentCount: 0,
        LastUpdateAt:  time.Now(),
    }
    
    // 初始化设置
    project.Settings = document.ProjectSettings{
        AutoBackup:     true,
        BackupInterval: 24,
    }
    
    _, err := r.collection.InsertOne(ctx, project)
    if err != nil {
        return fmt.Errorf("创建项目失败: %w", err)
    }
    
    return nil
}

// GetByID 根据ID获取项目
func (r *MongoProjectRepository) GetByID(ctx context.Context, id string) (*document.Project, error) {
    var project document.Project
    
    objID, err := primitive.ObjectIDFromHex(id)
    if err != nil {
        return nil, fmt.Errorf("无效的项目ID: %w", err)
    }
    
    filter := bson.M{
        "_id":        objID,
        "deleted_at": nil, // 排除已删除的项目
    }
    
    err = r.collection.FindOne(ctx, filter).Decode(&project)
    if err != nil {
        if err == mongo.ErrNoDocuments {
            return nil, nil
        }
        return nil, fmt.Errorf("查询项目失败: %w", err)
    }
    
    return &project, nil
}

// GetByAuthorID 获取作者的所有项目
func (r *MongoProjectRepository) GetByAuthorID(ctx context.Context, authorID string) ([]*document.Project, error) {
    filter := bson.M{
        "author_id":  authorID,
        "deleted_at": nil,
    }
    
    opts := options.Find().SetSort(bson.D{{Key: "updated_at", Value: -1}})
    
    cursor, err := r.collection.Find(ctx, filter, opts)
    if err != nil {
        return nil, fmt.Errorf("查询项目列表失败: %w", err)
    }
    defer cursor.Close(ctx)
    
    var projects []*document.Project
    if err = cursor.All(ctx, &projects); err != nil {
        return nil, fmt.Errorf("解析项目数据失败: %w", err)
    }
    
    return projects, nil
}

// Update 更新项目
func (r *MongoProjectRepository) Update(ctx context.Context, id string, updates map[string]interface{}) error {
    objID, err := primitive.ObjectIDFromHex(id)
    if err != nil {
        return fmt.Errorf("无效的项目ID: %w", err)
    }
    
    updates["updated_at"] = time.Now()
    
    filter := bson.M{"_id": objID}
    update := bson.M{"$set": updates}
    
    result, err := r.collection.UpdateOne(ctx, filter, update)
    if err != nil {
        return fmt.Errorf("更新项目失败: %w", err)
    }
    
    if result.MatchedCount == 0 {
        return fmt.Errorf("项目不存在")
    }
    
    return nil
}

// UpdateStatistics 更新项目统计
func (r *MongoProjectRepository) UpdateStatistics(ctx context.Context, id string, stats *document.ProjectStats) error {
    stats.LastUpdateAt = time.Now()
    
    updates := map[string]interface{}{
        "statistics":  stats,
        "updated_at": time.Now(),
    }
    
    return r.Update(ctx, id, updates)
}

// AddCollaborator 添加协作者
func (r *MongoProjectRepository) AddCollaborator(ctx context.Context, projectID string, collaborator *document.Collaborator) error {
    objID, err := primitive.ObjectIDFromHex(projectID)
    if err != nil {
        return fmt.Errorf("无效的项目ID: %w", err)
    }
    
    collaborator.InvitedAt = time.Now()
    
    filter := bson.M{"_id": objID}
    update := bson.M{
        "$push": bson.M{"collaborators": collaborator},
        "$set":  bson.M{"updated_at": time.Now()},
    }
    
    _, err = r.collection.UpdateOne(ctx, filter, update)
    if err != nil {
        return fmt.Errorf("添加协作者失败: %w", err)
    }
    
    return nil
}

// SoftDelete 软删除项目
func (r *MongoProjectRepository) SoftDelete(ctx context.Context, id string) error {
    now := time.Now()
    updates := map[string]interface{}{
        "deleted_at": &now,
        "updated_at": now,
    }
    
    return r.Update(ctx, id, updates)
}

// Health 健康检查
func (r *MongoProjectRepository) Health(ctx context.Context) error {
    return r.collection.Database().Client().Ping(ctx, nil)
}
```

### 3.3 Service层设计

```go
// service/project/project_service.go
package project

import (
    "context"
    "fmt"
    "time"
    
    "qingyu_backend/models/document"
    "qingyu_backend/repository/interfaces"
    "qingyu_backend/pkg/errors"
    "qingyu_backend/service/base"
)

type ProjectService struct {
    projectRepo  interfaces.ProjectRepository
    documentRepo interfaces.DocumentRepository
    eventBus     base.EventBus
    serviceName  string
    version      string
}

func NewProjectService(
    projectRepo interfaces.ProjectRepository,
    documentRepo interfaces.DocumentRepository,
    eventBus base.EventBus,
) *ProjectService {
    return &ProjectService{
        projectRepo:  projectRepo,
        documentRepo: documentRepo,
        eventBus:     eventBus,
        serviceName:  "ProjectService",
        version:      "1.0.0",
    }
}

// CreateProject 创建项目
func (s *ProjectService) CreateProject(ctx context.Context, req *CreateProjectRequest) (*CreateProjectResponse, error) {
    // 1. 参数验证
    if err := s.validateCreateProjectRequest(req); err != nil {
        return nil, errors.NewValidationError("参数验证失败").WithDetails(err.Error())
    }
    
    // 2. 获取用户ID
    userID := ctx.Value("userID").(string)
    
    // 3. 创建项目对象
    project := &document.Project{
        AuthorID:    userID,
        Title:       req.Title,
        Summary:     req.Summary,
        CoverURL:    req.CoverURL,
        Category:    req.Category,
        Tags:        req.Tags,
    }
    
    // 4. 保存到数据库
    if err := s.projectRepo.Create(ctx, project); err != nil {
        return nil, errors.NewInternalError("创建项目失败").WithCause(err)
    }
    
    // 5. 发布事件
    s.eventBus.PublishAsync(ctx, &base.BaseEvent{
        EventType: "project.created",
        EventData: map[string]interface{}{
            "project_id": project.ID,
            "author_id":  project.AuthorID,
            "title":      project.Title,
        },
        Timestamp: time.Now(),
        Source:    s.serviceName,
    })
    
    // 6. 返回响应
    return &CreateProjectResponse{
        ProjectID: project.ID,
        Title:     project.Title,
        Status:    string(project.Status),
        CreatedAt: project.CreatedAt,
    }, nil
}

// GetProject 获取项目详情
func (s *ProjectService) GetProject(ctx context.Context, projectID string) (*document.Project, error) {
    // 1. 查询项目
    project, err := s.projectRepo.GetByID(ctx, projectID)
    if err != nil {
        return nil, errors.NewInternalError("查询项目失败").WithCause(err)
    }
    
    if project == nil {
        return nil, errors.NewNotFoundError("项目不存在")
    }
    
    // 2. 权限检查
    userID := ctx.Value("userID").(string)
    if !project.CanView(userID) {
        return nil, errors.NewAuthError("无权限查看该项目")
    }
    
    return project, nil
}

// ListMyProjects 获取我的项目列表
func (s *ProjectService) ListMyProjects(ctx context.Context, req *ListProjectsRequest) (*ListProjectsResponse, error) {
    userID := ctx.Value("userID").(string)
    
    // 1. 构建查询条件
    filter := infrastructure.NewFilter()
    filter.AddCondition("author_id", "=", userID)
    filter.AddCondition("deleted_at", "=", nil)
    
    if req.Status != "" {
        filter.AddCondition("status", "=", req.Status)
    }
    
    if req.Category != "" {
        filter.AddCondition("category", "=", req.Category)
    }
    
    filter.SetSort(map[string]interface{}{
        "updated_at": -1,
    })
    
    // 2. 分页查询
    pagination := infrastructure.Pagination{
        Page:     req.Page,
        PageSize: req.PageSize,
    }
    pagination.CalculatePagination()
    
    result, err := s.projectRepo.FindWithPagination(ctx, filter, pagination)
    if err != nil {
        return nil, errors.NewInternalError("查询项目列表失败").WithCause(err)
    }
    
    // 3. 返回响应
    return &ListProjectsResponse{
        Projects: result.Data,
        Total:    result.Total,
        Page:     result.Page,
        PageSize: result.PageSize,
    }, nil
}

// UpdateProject 更新项目
func (s *ProjectService) UpdateProject(ctx context.Context, projectID string, req *UpdateProjectRequest) error {
    // 1. 查询项目
    project, err := s.projectRepo.GetByID(ctx, projectID)
    if err != nil {
        return errors.NewInternalError("查询项目失败").WithCause(err)
    }
    
    if project == nil {
        return errors.NewNotFoundError("项目不存在")
    }
    
    // 2. 权限检查
    userID := ctx.Value("userID").(string)
    if !project.CanEdit(userID) {
        return errors.NewAuthError("无权限编辑该项目")
    }
    
    // 3. 构建更新数据
    updates := make(map[string]interface{})
    
    if req.Title != "" {
        updates["title"] = req.Title
    }
    if req.Summary != "" {
        updates["summary"] = req.Summary
    }
    if req.CoverURL != "" {
        updates["cover_url"] = req.CoverURL
    }
    if req.Category != "" {
        updates["category"] = req.Category
    }
    if req.Tags != nil {
        updates["tags"] = req.Tags
    }
    if req.Status != "" {
        updates["status"] = req.Status
    }
    
    // 4. 更新项目
    if err := s.projectRepo.Update(ctx, projectID, updates); err != nil {
        return errors.NewInternalError("更新项目失败").WithCause(err)
    }
    
    // 5. 发布事件
    s.eventBus.PublishAsync(ctx, &base.BaseEvent{
        EventType: "project.updated",
        EventData: map[string]interface{}{
            "project_id": projectID,
            "updates":    updates,
        },
        Timestamp: time.Now(),
        Source:    s.serviceName,
    })
    
    return nil
}

// DeleteProject 删除项目
func (s *ProjectService) DeleteProject(ctx context.Context, projectID string) error {
    // 1. 查询项目
    project, err := s.projectRepo.GetByID(ctx, projectID)
    if err != nil {
        return errors.NewInternalError("查询项目失败").WithCause(err)
    }
    
    if project == nil {
        return errors.NewNotFoundError("项目不存在")
    }
    
    // 2. 权限检查（只有所有者可以删除）
    userID := ctx.Value("userID").(string)
    if !project.IsOwner(userID) {
        return errors.NewAuthError("只有项目所有者可以删除项目")
    }
    
    // 3. 软删除项目
    if err := s.projectRepo.SoftDelete(ctx, projectID); err != nil {
        return errors.NewInternalError("删除项目失败").WithCause(err)
    }
    
    // 4. 级联删除文档（可选，也可以保留）
    // TODO: 实现文档级联删除
    
    // 5. 发布事件
    s.eventBus.PublishAsync(ctx, &base.BaseEvent{
        EventType: "project.deleted",
        EventData: map[string]interface{}{
            "project_id": projectID,
            "author_id":  project.AuthorID,
        },
        Timestamp: time.Now(),
        Source:    s.serviceName,
    })
    
    return nil
}

// UpdateProjectStatistics 更新项目统计
func (s *ProjectService) UpdateProjectStatistics(ctx context.Context, projectID string) error {
    // 1. 查询项目下的所有文档
    // TODO: 实现文档统计查询
    
    // 2. 计算统计数据
    stats := &document.ProjectStats{
        TotalWords:    0,  // TODO: 从文档汇总
        ChapterCount:  0,  // TODO: 从文档汇总
        DocumentCount: 0,  // TODO: 从文档汇总
        LastUpdateAt:  time.Now(),
    }
    
    // 3. 更新统计
    if err := s.projectRepo.UpdateStatistics(ctx, projectID, stats); err != nil {
        return errors.NewInternalError("更新统计失败").WithCause(err)
    }
    
    return nil
}

// 私有方法
func (s *ProjectService) validateCreateProjectRequest(req *CreateProjectRequest) error {
    if req.Title == "" {
        return fmt.Errorf("项目标题不能为空")
    }
    if len(req.Title) > 100 {
        return fmt.Errorf("项目标题不能超过100字符")
    }
    return nil
}

// BaseService接口实现
func (s *ProjectService) Initialize(ctx context.Context) error {
    return nil
}

func (s *ProjectService) Health(ctx context.Context) error {
    return s.projectRepo.Health(ctx)
}

func (s *ProjectService) Close(ctx context.Context) error {
    return nil
}

func (s *ProjectService) GetServiceName() string {
    return s.serviceName
}

func (s *ProjectService) GetVersion() string {
    return s.version
}
```

### 3.4 API层设计

```go
// api/v1/writer/project_api.go
package writer

import (
    "net/http"
    "strconv"
    
    "github.com/gin-gonic/gin"
    "qingyu_backend/service/project"
    "qingyu_backend/pkg/response"
)

type ProjectApi struct {
    projectService *project.ProjectService
}

func NewProjectApi(projectService *project.ProjectService) *ProjectApi {
    return &ProjectApi{
        projectService: projectService,
    }
}

// CreateProject 创建项目
func (api *ProjectApi) CreateProject(c *gin.Context) {
    var req project.CreateProjectRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.Error(c, http.StatusBadRequest, "参数错误", err.Error())
        return
    }
    
    resp, err := api.projectService.CreateProject(c.Request.Context(), &req)
    if err != nil {
        response.HandleError(c, err)
        return
    }
    
    response.Success(c, http.StatusCreated, "创建成功", resp)
}

// GetProject 获取项目详情
func (api *ProjectApi) GetProject(c *gin.Context) {
    projectID := c.Param("id")
    
    project, err := api.projectService.GetProject(c.Request.Context(), projectID)
    if err != nil {
        response.HandleError(c, err)
        return
    }
    
    response.Success(c, http.StatusOK, "获取成功", project)
}

// ListProjects 获取项目列表
func (api *ProjectApi) ListProjects(c *gin.Context) {
    page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
    pageSize, _ := strconv.Atoi(c.DefaultQuery("pageSize", "10"))
    status := c.Query("status")
    category := c.Query("category")
    
    req := &project.ListProjectsRequest{
        Page:     page,
        PageSize: pageSize,
        Status:   status,
        Category: category,
    }
    
    resp, err := api.projectService.ListMyProjects(c.Request.Context(), req)
    if err != nil {
        response.HandleError(c, err)
        return
    }
    
    response.Success(c, http.StatusOK, "获取成功", resp)
}

// UpdateProject 更新项目
func (api *ProjectApi) UpdateProject(c *gin.Context) {
    projectID := c.Param("id")
    
    var req project.UpdateProjectRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.Error(c, http.StatusBadRequest, "参数错误", err.Error())
        return
    }
    
    if err := api.projectService.UpdateProject(c.Request.Context(), projectID, &req); err != nil {
        response.HandleError(c, err)
        return
    }
    
    response.Success(c, http.StatusOK, "更新成功", nil)
}

// DeleteProject 删除项目
func (api *ProjectApi) DeleteProject(c *gin.Context) {
    projectID := c.Param("id")
    
    if err := api.projectService.DeleteProject(c.Request.Context(), projectID); err != nil {
        response.HandleError(c, err)
        return
    }
    
    response.Success(c, http.StatusOK, "删除成功", nil)
}
```

### 3.5 Router层设计

```go
// router/writer/project.go
package writer

import (
    "github.com/gin-gonic/gin"
    "qingyu_backend/api/v1/writer"
    "qingyu_backend/middleware"
)

func InitProjectRouter(r *gin.RouterGroup, projectApi *writer.ProjectApi) {
    projectGroup := r.Group("/projects")
    projectGroup.Use(middleware.JWTAuth())
    {
        // 项目管理
        projectGroup.POST("", projectApi.CreateProject)
        projectGroup.GET("", projectApi.ListProjects)
        projectGroup.GET("/:id", projectApi.GetProject)
        projectGroup.PUT("/:id", projectApi.UpdateProject)
        projectGroup.DELETE("/:id", projectApi.DeleteProject)
    }
}
```

## 4. API接口设计

### 4.1 项目管理接口

#### 4.1.1 创建项目

```http
POST /api/v1/projects
Authorization: Bearer {token}
Content-Type: application/json

{
  "title": "我的小说",
  "summary": "这是一部玄幻小说",
  "coverUrl": "https://example.com/cover.jpg",
  "category": "玄幻",
  "tags": ["热血", "升级流"]
}

Response:
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "projectId": "string",
    "title": "我的小说",
    "status": "draft",
    "createdAt": "2025-10-16T10:00:00Z"
  }
}
```

#### 4.1.2 获取项目列表

```http
GET /api/v1/projects?page=1&pageSize=10&status=draft
Authorization: Bearer {token}

Response:
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "projects": [...],
    "total": 100,
    "page": 1,
    "pageSize": 10
  }
}
```

#### 4.1.3 获取项目详情

```http
GET /api/v1/projects/{id}
Authorization: Bearer {token}

Response:
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "id": "string",
    "authorId": "string",
    "title": "我的小说",
    "summary": "这是一部玄幻小说",
    "coverUrl": "https://example.com/cover.jpg",
    "status": "draft",
    "category": "玄幻",
    "tags": ["热血", "升级流"],
    "statistics": {
      "totalWords": 10000,
      "chapterCount": 10,
      "documentCount": 20
    },
    "createdAt": "2025-10-16T10:00:00Z",
    "updatedAt": "2025-10-16T10:00:00Z"
  }
}
```

#### 4.1.4 更新项目

```http
PUT /api/v1/projects/{id}
Authorization: Bearer {token}
Content-Type: application/json

{
  "title": "我的新小说",
  "summary": "更新后的简介",
  "status": "serializing"
}

Response:
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

#### 4.1.5 删除项目

```http
DELETE /api/v1/projects/{id}
Authorization: Bearer {token}

Response:
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

## 5. 性能优化

### 5.1 查询优化

- **索引优化**：在author_id、status、category等字段建立索引
- **分页查询**：使用分页避免大数据量查询
- **统计缓存**：项目统计数据使用Redis缓存

### 5.2 缓存策略

- **项目详情缓存**：缓存30分钟
- **项目列表缓存**：缓存10分钟
- **统计数据缓存**：缓存1小时

## 6. 安全设计

### 6.1 权限控制

- **所有者权限**：完全控制权限
- **编辑者权限**：可编辑内容，不能删除项目
- **查看者权限**：只能查看

### 6.2 数据验证

- 标题长度限制：1-100字符
- 简介长度限制：最多1000字符
- 标签数量限制：最多10个

## 7. 测试设计

### 7.1 单元测试

```go
func TestProjectService_CreateProject(t *testing.T) {
    // 测试正常创建
    // 测试参数验证
    // 测试权限验证
}
```

### 7.2 集成测试

- API接口测试
- 数据库操作测试
- 权限验证测试

## 8. 相关文档

- [文档管理系统设计](./文档管理系统设计.md)
- [编辑器系统设计](./编辑器系统设计.md)
- [版本控制系统设计](./版本控制系统设计.md)
- [实施文档](../../implementation/04写作端模块/README_写作端实施文档.md)

---

**文档版本**: v1.0  
**创建日期**: 2025-10-16  
**最后更新**: 2025-10-16  
**维护者**: 青羽写作团队

