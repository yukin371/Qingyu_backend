# 大纲时间空间地图设计文档

## 1. 需求概述

### 1.1 功能描述

大纲时间空间地图是青羽创作平台的核心功能模块，为小说、剧本等创作作品提供多维度的可视化管理工具。该模块通过大纲管理、时间线管理、空间地图和关系图谱四个维度，帮助创作者更好地组织和管理作品的结构化信息。

### 1.2 业务价值

- **提升创作效率**：通过可视化工具帮助作者快速梳理作品结构
- **增强作品质量**：通过多维度管理确保作品逻辑的一致性和完整性
- **降低创作门槛**：为新手作者提供结构化的创作指导
- **支持协作创作**：为团队创作提供统一的管理平台

### 1.3 用户场景

1. **小说创作者**：管理章节大纲、角色关系、时间线和世界观设定
2. **剧本创作者**：管理场次结构、角色关系、时间轴和场景设定
3. **游戏策划**：管理剧情分支、角色关系、时间线和地图场景
4. **学术研究者**：管理论文结构、时间规划和参考资料关系

### 1.4 功能边界

**包含功能**：
- 大纲结构的创建、编辑、删除和层级管理
- 时间线事件的创建、编辑和可视化展示
- 空间地图的创建、编辑和地理关系管理
- 关系图谱的创建、编辑和可视化展示
- 多维度数据的关联和同步

**不包含功能**：
- 具体文档内容的编辑（由文档编辑器负责）
- 复杂的图形绘制功能
- 实时协作编辑（暂不支持）

## 2. 架构设计

### 2.1 总体架构

大纲时间空间地图模块采用分层架构设计，包含以下层次：

```
┌─────────────────────────────────────────┐
│              前端展示层                    │
│    (Vue.js + D3.js + Canvas)            │
├─────────────────────────────────────────┤
│              API接口层                    │
│         (Gin + RESTful API)             │
├─────────────────────────────────────────┤
│              业务逻辑层                    │
│    (Service + Business Logic)           │
├─────────────────────────────────────────┤
│              数据访问层                    │
│         (Repository + DAO)              │
├─────────────────────────────────────────┤
│              数据存储层                    │
│           (MongoDB + Redis)             │
└─────────────────────────────────────────┘
```

### 2.2 模块划分

- **OutlineMap模块**：概要地图主体管理
- **Outline模块**：大纲结构管理
- **Timeline模块**：时间线管理
- **SpaceMap模块**：空间地图管理
- **Relationship模块**：关系图谱管理

### 2.3 数据流设计

```
用户操作 → API接口 → 业务逻辑验证 → 数据持久化 → 缓存更新 → 响应返回
```

### 2.4 技术选型

- **Web框架**：Gin (高性能HTTP框架)
- **数据库**：MongoDB (文档型数据库，适合复杂结构数据)
- **缓存**：Redis (提升查询性能)
- **认证**：JWT (无状态认证)
- **日志**：Logrus (结构化日志)

## 3. 详细设计

### 3.1 Router层设计

```go
// router/outline_map/outline_map.go
package outline_map

import (
    "github.com/gin-gonic/gin"
    "qingyu_backend/api/v1/outline_map"
    "qingyu_backend/middleware"
)

func RegisterRoutes(r *gin.RouterGroup) {
    // 概要地图路由组
    mapRouter := r.Group("/outline-map")
    mapRouter.Use(middleware.JWTAuth())
    mapRouter.Use(middleware.ProjectPermission())
    {
        mapApi := outline_map.NewOutlineMapApi()
        outlineApi := outline_map.NewOutlineApi()
        timelineApi := outline_map.NewTimelineApi()
        spaceApi := outline_map.NewSpaceMapApi()
        relationApi := outline_map.NewRelationshipApi()
        
        // 概要地图基础操作
        mapRouter.POST("/", mapApi.Create)
        mapRouter.GET("/", mapApi.List)
        mapRouter.GET("/:id", mapApi.Get)
        mapRouter.GET("/:id/full", mapApi.GetFull)
        mapRouter.PUT("/:id", mapApi.Update)
        mapRouter.DELETE("/:id", mapApi.Delete)
        
        // 大纲相关路由
        outlineGroup := mapRouter.Group("/:mapId/outline")
        {
            outlineGroup.POST("/node", outlineApi.CreateNode)
            outlineGroup.GET("/tree", outlineApi.GetTree)
            outlineGroup.PUT("/node/:nodeId", outlineApi.UpdateNode)
            outlineGroup.DELETE("/node/:nodeId", outlineApi.DeleteNode)
            outlineGroup.POST("/node/:nodeId/move", outlineApi.MoveNode)
            outlineGroup.GET("/statistics", outlineApi.GetStatistics)
        }
        
        // 时间线相关路由
        timelineGroup := mapRouter.Group("/:mapId/timeline")
        {
            timelineGroup.POST("/event", timelineApi.CreateEvent)
            timelineGroup.GET("/events", timelineApi.GetEvents)
            timelineGroup.PUT("/event/:eventId", timelineApi.UpdateEvent)
            timelineGroup.DELETE("/event/:eventId", timelineApi.DeleteEvent)
            timelineGroup.GET("/range", timelineApi.GetRange)
        }
        
        // 空间地图相关路由
        spaceGroup := mapRouter.Group("/:mapId/space")
        {
            spaceGroup.POST("/location", spaceApi.CreateLocation)
            spaceGroup.GET("/tree", spaceApi.GetTree)
            spaceGroup.PUT("/location/:locationId", spaceApi.UpdateLocation)
            spaceGroup.DELETE("/location/:locationId", spaceApi.DeleteLocation)
            spaceGroup.GET("/search", spaceApi.Search)
        }
        
        // 关系图谱相关路由
        relationGroup := mapRouter.Group("/:mapId/relationship")
        {
            relationGroup.POST("/", relationApi.Create)
            relationGroup.GET("/", relationApi.List)
            relationGroup.PUT("/:relationId", relationApi.Update)
            relationGroup.DELETE("/:relationId", relationApi.Delete)
            relationGroup.GET("/graph", relationApi.GetGraph)
        }
    }
}
```

### 3.2 API层设计

```go
// api/v1/outline_map/outline_map.go
package outline_map

import (
    "net/http"
    "strconv"
    
    "github.com/gin-gonic/gin"
    "qingyu_backend/global"
    "qingyu_backend/model/common/response"
    "qingyu_backend/model/outline_map"
    "qingyu_backend/service"
    "qingyu_backend/utils"
)

type OutlineMapApi struct {
    outlineMapService service.OutlineMapService
}

func NewOutlineMapApi() *OutlineMapApi {
    return &OutlineMapApi{
        outlineMapService: service.ServiceGroupApp.OutlineMapServiceGroup.OutlineMapService,
    }
}

// Create 创建概要地图
func (a *OutlineMapApi) Create(c *gin.Context) {
    var req outline_map.CreateOutlineMapRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.FailWithMessage(err.Error(), c)
        return
    }
    
    // 参数验证
    if err := utils.Verify(req, utils.OutlineMapVerify); err != nil {
        response.FailWithMessage(err.Error(), c)
        return
    }
    
    // 获取用户信息
    userID := utils.GetUserID(c)
    
    // 创建概要地图
    outlineMap := &outline_map.OutlineMap{
        ProjectID:   req.ProjectID,
        Name:        req.Name,
        Description: req.Description,
        Type:        req.Type,
        Status:      "draft",
        CreatedBy:   userID,
    }
    
    if result, err := a.outlineMapService.Create(outlineMap); err != nil {
        global.GVA_LOG.Error("创建概要地图失败!", zap.Error(err))
        response.FailWithMessage("创建失败", c)
    } else {
        response.OkWithData(result, c)
    }
}

// List 获取概要地图列表
func (a *OutlineMapApi) List(c *gin.Context) {
    projectID := c.Query("projectId")
    if projectID == "" {
        response.FailWithMessage("项目ID不能为空", c)
        return
    }
    
    // 分页参数
    page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
    pageSize, _ := strconv.Atoi(c.DefaultQuery("pageSize", "10"))
    
    if list, total, err := a.outlineMapService.GetByProjectID(projectID, page, pageSize); err != nil {
        global.GVA_LOG.Error("获取概要地图列表失败!", zap.Error(err))
        response.FailWithMessage("获取失败", c)
    } else {
        response.OkWithDetailed(response.PageResult{
            List:     list,
            Total:    total,
            Page:     page,
            PageSize: pageSize,
        }, "获取成功", c)
    }
}
```

### 3.3 Service层设计

```go
// service/outline_map/outline_map.go
package outline_map

import (
    "errors"
    "time"
    
    "qingyu_backend/global"
    "qingyu_backend/model/outline_map"
    "go.mongodb.org/mongo-driver/bson"
    "go.mongodb.org/mongo-driver/bson/primitive"
)

type OutlineMapService struct{}

// Create 创建概要地图
func (s *OutlineMapService) Create(outlineMap *outline_map.OutlineMap) (*outline_map.OutlineMap, error) {
    // 检查项目权限
    if !s.checkProjectPermission(outlineMap.ProjectID, outlineMap.CreatedBy) {
        return nil, errors.New("无权限访问该项目")
    }
    
    // 设置创建时间
    now := time.Now()
    outlineMap.ID = primitive.NewObjectID().Hex()
    outlineMap.CreatedAt = now
    outlineMap.UpdatedAt = now
    
    // 保存到数据库
    collection := global.GVA_MONGO_DB.Collection("outline_maps")
    if _, err := collection.InsertOne(global.GVA_CTX, outlineMap); err != nil {
        return nil, err
    }
    
    return outlineMap, nil
}

// GetByID 根据ID获取概要地图
func (s *OutlineMapService) GetByID(id string) (*outline_map.OutlineMap, error) {
    var outlineMap outline_map.OutlineMap
    collection := global.GVA_MONGO_DB.Collection("outline_maps")
    
    objID, err := primitive.ObjectIDFromHex(id)
    if err != nil {
        return nil, errors.New("无效的ID格式")
    }
    
    if err := collection.FindOne(global.GVA_CTX, bson.M{"_id": objID}).Decode(&outlineMap); err != nil {
        return nil, err
    }
    
    return &outlineMap, nil
}
```

### 3.4 Model层设计

```go
// model/outline_map/outline_map.go
package outline_map

import (
    "time"
)

// OutlineMap 概要地图主体
type OutlineMap struct {
    ID          string    `bson:"_id,omitempty" json:"id"`
    ProjectID   string    `bson:"project_id" json:"projectId" binding:"required"`
    Name        string    `bson:"name" json:"name" binding:"required,min=1,max=100"`
    Description string    `bson:"description,omitempty" json:"description,omitempty"`
    Type        MapType   `bson:"type" json:"type" binding:"required,oneof=novel script game academic"`
    Status      string    `bson:"status" json:"status"`
    CreatedBy   string    `bson:"created_by" json:"createdBy"`
    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time `bson:"updated_at" json:"updatedAt"`
    
    // 非持久化字段，用于返回完整数据
    Outline   *OutlineStructure `bson:"-" json:"outline,omitempty"`
    Timeline  *TimelineData     `bson:"-" json:"timeline,omitempty"`
    SpaceMap  *SpaceMapData     `bson:"-" json:"spaceMap,omitempty"`
}

type MapType string

const (
    MapTypeNovel    MapType = "novel"    // 小说
    MapTypeScript   MapType = "script"   // 剧本
    MapTypeGame     MapType = "game"     // 游戏
    MapTypeAcademic MapType = "academic" // 学术
)
```

## 4. 数据设计

### 4.1 数据库设计

#### 4.1.1 集合设计

**outline_maps 集合**
```javascript
{
  "_id": ObjectId,
  "project_id": String,
  "name": String,
  "description": String,
  "type": String, // novel | script | game | academic
  "status": String, // draft | active | archived
  "created_by": String,
  "created_at": Date,
  "updated_at": Date
}
```

**outline_nodes 集合**
```javascript
{
  "_id": ObjectId,
  "map_id": String,
  "parent_id": String,
  "type": String, // part | chapter | section | scene
  "title": String,
  "summary": String,
  "content": String,
  "order": Number,
  "status": String, // planned | writing | completed
  "word_count": Number,
  "document_id": String,
  "character_ids": [String],
  "location_ids": [String],
  "timeline_ids": [String],
  "tags": [String],
  "notes": String,
  "created_at": Date,
  "updated_at": Date
}
```

#### 4.1.2 索引设计

```javascript
// outline_maps 索引
db.outline_maps.createIndex({"project_id": 1})
db.outline_maps.createIndex({"type": 1})
db.outline_maps.createIndex({"status": 1})
db.outline_maps.createIndex({"created_at": -1})

// outline_nodes 索引
db.outline_nodes.createIndex({"map_id": 1})
db.outline_nodes.createIndex({"parent_id": 1})
db.outline_nodes.createIndex({"map_id": 1, "parent_id": 1, "order": 1})
db.outline_nodes.createIndex({"document_id": 1})
```

#### 4.1.3 数据约束

- **主键约束**：所有集合使用ObjectId作为主键
- **外键约束**：通过应用层逻辑保证引用完整性
- **唯一性约束**：同一项目下概要地图名称唯一
- **非空约束**：必填字段不能为空

### 4.2 数据迁移策略

#### 4.2.1 版本控制
- 使用数据库版本号管理数据结构变更
- 提供向前兼容的迁移脚本
- 支持数据回滚机制

#### 4.2.2 迁移步骤
1. 备份现有数据
2. 执行结构变更
3. 数据格式转换
4. 验证数据完整性
5. 更新应用配置

## 5. API设计

### 5.1 概要地图API

#### 5.1.1 创建概要地图
```http
POST /api/v1/outline-map
Content-Type: application/json
Authorization: Bearer {token}

{
  "projectId": "string",
  "name": "string",
  "description": "string",
  "type": "novel|script|game|academic"
}

Response:
{
  "code": 0,
  "data": {
    "id": "string",
    "projectId": "string",
    "name": "string",
    "description": "string",
    "type": "string",
    "status": "draft",
    "createdAt": "2024-01-01T00:00:00Z",
    "updatedAt": "2024-01-01T00:00:00Z"
  },
  "msg": "创建成功"
}
```

#### 5.1.2 获取概要地图列表
```http
GET /api/v1/outline-map?projectId={projectId}&page=1&pageSize=10
Authorization: Bearer {token}

Response:
{
  "code": 0,
  "data": {
    "list": [...],
    "total": 100,
    "page": 1,
    "pageSize": 10
  },
  "msg": "获取成功"
}
```

### 5.2 大纲API

#### 5.2.1 创建大纲节点
```http
POST /api/v1/outline-map/{mapId}/outline/node
Content-Type: application/json
Authorization: Bearer {token}

{
  "parentId": "string",
  "type": "part|chapter|section|scene",
  "title": "string",
  "summary": "string",
  "order": 1
}
```

#### 5.2.2 获取大纲树
```http
GET /api/v1/outline-map/{mapId}/outline/tree
Authorization: Bearer {token}

Response:
{
  "code": 0,
  "data": [
    {
      "id": "string",
      "title": "string",
      "type": "chapter",
      "order": 1,
      "children": [...]
    }
  ],
  "msg": "获取成功"
}
```

## 6. 安全设计

### 6.1 身份认证

#### 6.1.1 JWT认证
- 使用JWT Token进行用户身份验证
- Token包含用户ID、角色信息和过期时间
- 支持Token刷新机制

#### 6.1.2 认证流程
```
用户登录 → 验证凭据 → 生成JWT Token → 返回Token → 后续请求携带Token
```

### 6.2 权限控制

#### 6.2.1 项目权限
- **项目所有者**：拥有项目的完全控制权
- **项目成员**：可以查看和编辑项目内容
- **访客**：只能查看公开项目

#### 6.2.2 资源权限
- 概要地图的访问权限继承项目权限
- 支持细粒度的操作权限控制
- 实现基于角色的访问控制(RBAC)

### 6.3 数据安全

#### 6.3.1 数据加密
- 敏感数据使用AES-256加密存储
- 数据传输使用HTTPS协议
- 数据库连接使用SSL加密

#### 6.3.2 数据备份
- 定期自动备份数据库
- 支持增量备份和全量备份
- 备份数据异地存储

### 6.4 API安全

#### 6.4.1 请求验证
- 参数类型和格式验证
- 请求频率限制
- SQL注入防护

#### 6.4.2 响应安全
- 敏感信息过滤
- 错误信息脱敏
- 跨域请求控制

## 7. 测试设计

### 7.1 单元测试

#### 7.1.1 测试覆盖范围
- Service层业务逻辑测试
- Model层数据验证测试
- 工具函数测试

#### 7.1.2 测试用例示例
```go
func TestOutlineMapService_Create(t *testing.T) {
    tests := []struct {
        name    string
        input   *outline_map.OutlineMap
        want    *outline_map.OutlineMap
        wantErr bool
    }{
        {
            name: "正常创建概要地图",
            input: &outline_map.OutlineMap{
                ProjectID:   "project123",
                Name:        "测试概要地图",
                Type:        outline_map.MapTypeNovel,
                CreatedBy:   "user123",
            },
            wantErr: false,
        },
        {
            name: "项目ID为空",
            input: &outline_map.OutlineMap{
                Name:      "测试概要地图",
                Type:      outline_map.MapTypeNovel,
                CreatedBy: "user123",
            },
            wantErr: true,
        },
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            s := &OutlineMapService{}
            got, err := s.Create(tt.input)
            if (err != nil) != tt.wantErr {
                t.Errorf("Create() error = %v, wantErr %v", err, tt.wantErr)
                return
            }
            if !tt.wantErr && got == nil {
                t.Errorf("Create() got = nil, want not nil")
            }
        })
    }
}
```

### 7.2 集成测试

#### 7.2.1 API集成测试
- 测试完整的API调用流程
- 验证数据库操作正确性
- 测试异常情况处理

#### 7.2.2 数据库集成测试
- 测试数据持久化
- 验证事务处理
- 测试并发操作

### 7.3 性能测试

#### 7.3.1 负载测试
- 模拟高并发用户访问
- 测试系统响应时间
- 验证系统稳定性

#### 7.3.2 压力测试
- 测试系统极限负载
- 验证系统恢复能力
- 测试资源使用情况

## 8. 部署和运维

### 8.1 部署要求

#### 8.1.1 系统要求
- **操作系统**：Linux (Ubuntu 20.04+)
- **内存**：最低4GB，推荐8GB
- **存储**：最低50GB SSD
- **网络**：稳定的网络连接

#### 8.1.2 软件依赖
- **Go**：1.19+
- **MongoDB**：5.0+
- **Redis**：6.0+
- **Nginx**：1.18+

### 8.2 监控和日志

#### 8.2.1 系统监控
- CPU、内存、磁盘使用率监控
- 网络流量监控
- 数据库性能监控
- 应用响应时间监控

#### 8.2.2 日志管理
```go
// 日志配置示例
logger := logrus.New()
logger.SetFormatter(&logrus.JSONFormatter{})
logger.SetLevel(logrus.InfoLevel)

// 业务日志记录
global.GVA_LOG.Info("创建概要地图", 
    zap.String("userId", userID),
    zap.String("projectId", projectID),
    zap.String("mapId", mapID))
```

#### 8.2.3 告警机制
- 系统异常自动告警
- 性能指标超阈值告警
- 业务异常告警
- 支持邮件、短信、钉钉等告警方式

### 8.3 备份策略

#### 8.3.1 数据备份
- 每日自动全量备份
- 每小时增量备份
- 备份数据保留30天
- 异地备份存储

#### 8.3.2 恢复策略
- 支持指定时间点恢复
- 提供数据恢复验证
- 制定灾难恢复预案

## 9. 风险评估

### 9.1 技术风险

#### 9.1.1 数据一致性风险
- **风险描述**：多维度数据关联可能导致数据不一致
- **影响程度**：高
- **缓解措施**：
  - 使用数据库事务保证操作原子性
  - 实现数据完整性检查机制
  - 定期进行数据一致性校验

#### 9.1.2 性能风险
- **风险描述**：复杂查询和大数据量可能影响系统性能
- **影响程度**：中
- **缓解措施**：
  - 优化数据库索引设计
  - 实现数据分页和懒加载
  - 使用Redis缓存热点数据

### 9.2 业务风险

#### 9.2.1 数据丢失风险
- **风险描述**：用户创作数据丢失造成重大损失
- **影响程度**：高
- **缓解措施**：
  - 实施多重备份策略
  - 提供数据导出功能
  - 建立数据恢复机制

#### 9.2.2 用户体验风险
- **风险描述**：复杂功能可能影响用户使用体验
- **影响程度**：中
- **缓解措施**：
  - 提供用户操作指南
  - 实现渐进式功能引导
  - 收集用户反馈持续优化

### 9.3 运维风险

#### 9.3.1 系统可用性风险
- **风险描述**：系统故障影响用户正常使用
- **影响程度**：高
- **缓解措施**：
  - 实现系统高可用架构
  - 建立完善的监控告警机制
  - 制定故障应急响应预案

## 10. 实施计划

### 10.1 开发阶段

#### 10.1.1 第一阶段（4周）
- **目标**：完成基础架构和核心模型设计
- **交付物**：
  - 数据模型定义
  - 基础API框架
  - 数据库设计和初始化
- **里程碑**：基础架构搭建完成

#### 10.1.2 第二阶段（6周）
- **目标**：实现概要地图和大纲管理功能
- **交付物**：
  - 概要地图CRUD功能
  - 大纲节点管理功能
  - 树形结构处理逻辑
- **里程碑**：核心功能开发完成

#### 10.1.3 第三阶段（4周）
- **目标**：实现时间线和空间地图功能
- **交付物**：
  - 时间线事件管理
  - 空间地图位置管理
  - 关联关系处理
- **里程碑**：全部功能开发完成

### 10.2 测试阶段

#### 10.2.1 单元测试（2周）
- 编写和执行单元测试用例
- 代码覆盖率达到80%以上
- 修复发现的问题

#### 10.2.2 集成测试（2周）
- 执行API集成测试
- 数据库集成测试
- 性能测试和优化

### 10.3 上线阶段

#### 10.3.1 预发布环境部署（1周）
- 部署到预发布环境
- 执行完整功能测试
- 性能和安全测试

#### 10.3.2 生产环境上线（1周）
- 生产环境部署
- 数据迁移和验证
- 监控和告警配置
- 用户培训和文档更新

## 关联文档

- [软件需求规格说明书(SRS)](../软件需求规格说明书(SRS).md)
- [架构设计说明书](../架构设计说明书.md)
- [API接口总览](../API接口总览.md)
- [数据库设计说明书](../数据库设计说明书.md)
- [测试计划与用例](../测试计划与用例.md)
- [部署与运维指南](../部署与运维指南.md)
- [安全设计与威胁建模](../安全设计与威胁建模.md)
- [日志与监控](../日志与监控.md)
- [需求追踪矩阵](../需求追踪矩阵.md)