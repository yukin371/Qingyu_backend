# 世界观设定管理系统设计文档

> **版本**: v1.0  
> **创建日期**: 2025-10-16  
> **最后更新**: 2025-10-16  
> **维护者**: 青羽写作团队

## 1. 概述

### 1.1 功能描述

世界观设定管理系统是青羽写作平台的重要辅助功能，为作者提供结构化的世界观构建工具。系统支持多种设定类型管理，包括修炼体系、势力组织、地理设定、物品设定等，帮助作者构建完整、一致的作品世界观。

### 1.2 业务价值

- **结构化管理**：提供分类清晰的设定管理
- **关联引用**：设定之间可以建立关联关系
- **快速查阅**：编辑时快速查找和引用设定
- **一致性保证**：避免设定前后矛盾

### 1.3 用户场景

1. **创建设定**：新建修炼体系、势力等设定
2. **分类管理**：按类型组织设定
3. **设定引用**：在文档中引用设定内容
4. **设定搜索**：快速查找相关设定
5. **设定导出**：导出设定文档

### 1.4 功能边界

**包含功能**：
- 多类型设定管理
- 设定分类和标签
- 富文本设定内容
- 设定关联关系
- 设定搜索和筛选
- 设定导入导出

**不包含功能**：
- 设定自动生成（后期AI功能）
- 设定共享市场（后期功能）
- 协作编辑（后期功能）

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────┐
│         Router Layer (路由层)            │
│    /api/v1/projects/:id/settings/*     │
├─────────────────────────────────────────┤
│         API Layer (接口层)               │
│      WorldSettingApi                    │
├─────────────────────────────────────────┤
│        Service Layer (业务逻辑层)         │
│    WorldSettingService                  │
├─────────────────────────────────────────┤
│      Repository Layer (数据访问层)        │
│   WorldSettingRepository                │
├─────────────────────────────────────────┤
│        Model Layer (数据模型层)           │
│         WorldSetting                    │
├─────────────────────────────────────────┤
│         MongoDB (存储层)                 │
└─────────────────────────────────────────┘
```

### 2.2 设定类型

```go
// SettingType 设定类型
type SettingType string

const (
    TypeCultivation   SettingType = "cultivation"   // 修炼体系
    TypeFaction       SettingType = "faction"       // 势力组织
    TypeGeography     SettingType = "geography"     // 地理设定
    TypeItem          SettingType = "item"          // 物品设定
    TypeSkill         SettingType = "skill"         // 技能设定
    TypeRace          SettingType = "race"          // 种族设定
    TypeHistory       SettingType = "history"       // 历史事件
    TypeCulture       SettingType = "culture"       // 文化设定
    TypeMagic         SettingType = "magic"         // 魔法体系
    TypeTechnology    SettingType = "technology"    // 科技体系
    TypeOther         SettingType = "other"         // 其他
)
```

## 3. 详细设计

### 3.1 数据模型设计

```go
// models/document/world_setting.go
package document

import "time"

// WorldSetting 世界观设定
type WorldSetting struct {
    ID          string       `bson:"_id,omitempty" json:"id"`
    ProjectID   string       `bson:"project_id" json:"projectId" validate:"required"`
    Type        SettingType  `bson:"type" json:"type" validate:"required"`
    Category    string       `bson:"category,omitempty" json:"category,omitempty"` // 二级分类
    Name        string       `bson:"name" json:"name" validate:"required,min=1,max=100"`
    Summary     string       `bson:"summary,omitempty" json:"summary,omitempty"`
    Content     string       `bson:"content" json:"content"`                       // 富文本内容
    
    // 结构化字段（可选，根据类型不同）
    Properties  map[string]interface{} `bson:"properties,omitempty" json:"properties,omitempty"`
    
    // 关联关系
    RelatedSettings []string `bson:"related_settings,omitempty" json:"relatedSettings,omitempty"`
    RelatedCharacters []string `bson:"related_characters,omitempty" json:"relatedCharacters,omitempty"`
    RelatedLocations []string `bson:"related_locations,omitempty" json:"relatedLocations,omitempty"`
    
    // 标签和备注
    Tags        []string     `bson:"tags,omitempty" json:"tags,omitempty"`
    Notes       string       `bson:"notes,omitempty" json:"notes,omitempty"`
    
    // 引用统计
    ReferenceCount int       `bson:"reference_count" json:"referenceCount"` // 被引用次数
    
    // 图片和附件
    Images      []string     `bson:"images,omitempty" json:"images,omitempty"`
    Attachments []string     `bson:"attachments,omitempty" json:"attachments,omitempty"`
    
    // 时间戳
    CreatedBy   string       `bson:"created_by" json:"createdBy"`
    CreatedAt   time.Time    `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time    `bson:"updated_at" json:"updatedAt"`
    DeletedAt   *time.Time   `bson:"deleted_at,omitempty" json:"deletedAt,omitempty"`
}

// GetDisplayName 获取显示名称
func (w *WorldSetting) GetDisplayName() string {
    if w.Name != "" {
        return w.Name
    }
    return string(w.Type)
}

// AddReference 增加引用计数
func (w *WorldSetting) AddReference() {
    w.ReferenceCount++
}

// SettingType定义见上文2.2节
```

### 3.2 特定类型的属性结构

```go
// CultivationProperties 修炼体系属性
type CultivationProperties struct {
    Levels      []CultivationLevel `json:"levels"`      // 修炼等级
    Method      string            `json:"method"`       // 修炼方法
    Energy      string            `json:"energy"`       // 能量名称（灵力、真气等）
    Description string            `json:"description"`  // 描述
}

type CultivationLevel struct {
    Name        string `json:"name"`        // 等级名称
    Order       int    `json:"order"`       // 排序
    Description string `json:"description"` // 描述
}

// FactionProperties 势力组织属性
type FactionProperties struct {
    LeaderName   string   `json:"leaderName"`   // 领导者
    MemberCount  int      `json:"memberCount"`  // 成员数量
    Territory    string   `json:"territory"`    // 势力范围
    Strength     string   `json:"strength"`     // 实力等级
    Affiliation  string   `json:"affiliation"`  // 所属阵营
    Allies       []string `json:"allies"`       // 盟友
    Enemies      []string `json:"enemies"`      // 敌对势力
}

// GeographyProperties 地理设定属性
type GeographyProperties struct {
    LocationType string  `json:"locationType"` // 地点类型
    Climate      string  `json:"climate"`      // 气候
    Area         float64 `json:"area"`         // 面积
    Population   int     `json:"population"`   // 人口
    Coordinates  string  `json:"coordinates"`  // 坐标
}

// ItemProperties 物品设定属性
type ItemProperties struct {
    ItemType    string `json:"itemType"`    // 物品类型
    Rarity      string `json:"rarity"`      // 稀有度
    Effect      string `json:"effect"`      // 效果
    Origin      string `json:"origin"`      // 来历
    Material    string `json:"material"`    // 材质
}
```

### 3.3 Repository层设计

```go
// repository/interfaces/writing/world_setting_repository.go
package writing

import (
    "context"
    "qingyu_backend/models/document"
    "qingyu_backend/repository/interfaces/infrastructure"
)

type WorldSettingRepository interface {
    // 基础CRUD操作
    Create(ctx context.Context, setting *document.WorldSetting) error
    GetByID(ctx context.Context, id string) (*document.WorldSetting, error)
    Update(ctx context.Context, id string, updates map[string]interface{}) error
    Delete(ctx context.Context, id string) error
    
    // 查询操作
    GetByProjectID(ctx context.Context, projectID string) ([]*document.WorldSetting, error)
    GetByType(ctx context.Context, projectID string, settingType document.SettingType) ([]*document.WorldSetting, error)
    GetByCategory(ctx context.Context, projectID, category string) ([]*document.WorldSetting, error)
    Search(ctx context.Context, projectID, keyword string) ([]*document.WorldSetting, error)
    
    // 分页查询
    FindWithPagination(ctx context.Context, filter infrastructure.Filter, pagination infrastructure.Pagination) (*infrastructure.PagedResult[document.WorldSetting], error)
    
    // 关联操作
    AddRelatedSetting(ctx context.Context, settingID, relatedID string) error
    RemoveRelatedSetting(ctx context.Context, settingID, relatedID string) error
    GetRelatedSettings(ctx context.Context, settingID string) ([]*document.WorldSetting, error)
    
    // 引用统计
    IncrementReferenceCount(ctx context.Context, id string) error
    DecrementReferenceCount(ctx context.Context, id string) error
    
    // 软删除
    SoftDelete(ctx context.Context, id string) error
    
    // 健康检查
    Health(ctx context.Context) error
}
```

### 3.4 Service层设计

```go
// service/worldsetting/world_setting_service.go
package worldsetting

import (
    "context"
    "fmt"
    "time"
    
    "qingyu_backend/models/document"
    "qingyu_backend/repository/interfaces"
    "qingyu_backend/pkg/errors"
    "qingyu_backend/service/base"
)

type WorldSettingService struct {
    settingRepo  interfaces.WorldSettingRepository
    projectRepo  interfaces.ProjectRepository
    eventBus     base.EventBus
}

func NewWorldSettingService(
    settingRepo interfaces.WorldSettingRepository,
    projectRepo interfaces.ProjectRepository,
    eventBus base.EventBus,
) *WorldSettingService {
    return &WorldSettingService{
        settingRepo:  settingRepo,
        projectRepo:  projectRepo,
        eventBus:     eventBus,
    }
}

// CreateSetting 创建设定
func (s *WorldSettingService) CreateSetting(ctx context.Context, req *CreateSettingRequest) (*CreateSettingResponse, error) {
    // 1. 参数验证
    if err := s.validateCreateSettingRequest(req); err != nil {
        return nil, errors.NewValidationError("参数验证失败").WithDetails(err.Error())
    }
    
    // 2. 验证项目权限
    project, err := s.projectRepo.GetByID(ctx, req.ProjectID)
    if err != nil {
        return nil, errors.NewInternalError("查询项目失败").WithCause(err)
    }
    
    if project == nil {
        return nil, errors.NewNotFoundError("项目不存在")
    }
    
    userID := ctx.Value("userID").(string)
    if !project.CanEdit(userID) {
        return nil, errors.NewAuthError("无权限编辑该项目")
    }
    
    // 3. 创建设定对象
    setting := &document.WorldSetting{
        ProjectID:       req.ProjectID,
        Type:            req.Type,
        Category:        req.Category,
        Name:            req.Name,
        Summary:         req.Summary,
        Content:         req.Content,
        Properties:      req.Properties,
        Tags:            req.Tags,
        Notes:           req.Notes,
        Images:          req.Images,
        CreatedBy:       userID,
        ReferenceCount:  0,
    }
    
    // 4. 保存设定
    if err := s.settingRepo.Create(ctx, setting); err != nil {
        return nil, errors.NewInternalError("创建设定失败").WithCause(err)
    }
    
    // 5. 发布事件
    s.eventBus.PublishAsync(ctx, &base.BaseEvent{
        EventType: "worldsetting.created",
        EventData: map[string]interface{}{
            "setting_id": setting.ID,
            "project_id": setting.ProjectID,
            "type":       setting.Type,
            "name":       setting.Name,
        },
        Timestamp: time.Now(),
        Source:    "WorldSettingService",
    })
    
    return &CreateSettingResponse{
        SettingID: setting.ID,
        Name:      setting.Name,
        Type:      string(setting.Type),
        CreatedAt: setting.CreatedAt,
    }, nil
}

// GetSettingsByType 按类型获取设定列表
func (s *WorldSettingService) GetSettingsByType(ctx context.Context, projectID string, settingType document.SettingType) ([]*document.WorldSetting, error) {
    // 1. 验证项目权限
    project, err := s.projectRepo.GetByID(ctx, projectID)
    if err != nil {
        return nil, errors.NewInternalError("查询项目失败").WithCause(err)
    }
    
    if project == nil {
        return nil, errors.NewNotFoundError("项目不存在")
    }
    
    userID := ctx.Value("userID").(string)
    if !project.CanView(userID) {
        return nil, errors.NewAuthError("无权限查看该项目")
    }
    
    // 2. 查询设定列表
    settings, err := s.settingRepo.GetByType(ctx, projectID, settingType)
    if err != nil {
        return nil, errors.NewInternalError("查询设定失败").WithCause(err)
    }
    
    return settings, nil
}

// SearchSettings 搜索设定
func (s *WorldSettingService) SearchSettings(ctx context.Context, projectID, keyword string) ([]*document.WorldSetting, error) {
    // 1. 验证项目权限
    project, err := s.projectRepo.GetByID(ctx, projectID)
    if err != nil {
        return nil, errors.NewInternalError("查询项目失败").WithCause(err)
    }
    
    if project == nil {
        return nil, errors.NewNotFoundError("项目不存在")
    }
    
    userID := ctx.Value("userID").(string)
    if !project.CanView(userID) {
        return nil, errors.NewAuthError("无权限查看该项目")
    }
    
    // 2. 搜索设定
    settings, err := s.settingRepo.Search(ctx, projectID, keyword)
    if err != nil {
        return nil, errors.NewInternalError("搜索设定失败").WithCause(err)
    }
    
    return settings, nil
}

// AddRelatedSetting 添加关联设定
func (s *WorldSettingService) AddRelatedSetting(ctx context.Context, settingID, relatedID string) error {
    // 1. 验证设定存在
    setting, err := s.settingRepo.GetByID(ctx, settingID)
    if err != nil {
        return errors.NewInternalError("查询设定失败").WithCause(err)
    }
    
    if setting == nil {
        return errors.NewNotFoundError("设定不存在")
    }
    
    // 2. 验证项目权限
    project, err := s.projectRepo.GetByID(ctx, setting.ProjectID)
    if err != nil {
        return errors.NewInternalError("查询项目失败").WithCause(err)
    }
    
    userID := ctx.Value("userID").(string)
    if !project.CanEdit(userID) {
        return errors.NewAuthError("无权限编辑该项目")
    }
    
    // 3. 添加关联
    if err := s.settingRepo.AddRelatedSetting(ctx, settingID, relatedID); err != nil {
        return errors.NewInternalError("添加关联失败").WithCause(err)
    }
    
    return nil
}

// 私有方法
func (s *WorldSettingService) validateCreateSettingRequest(req *CreateSettingRequest) error {
    if req.ProjectID == "" {
        return fmt.Errorf("项目ID不能为空")
    }
    if req.Name == "" {
        return fmt.Errorf("设定名称不能为空")
    }
    if len(req.Name) > 100 {
        return fmt.Errorf("设定名称不能超过100字符")
    }
    return nil
}
```

### 3.5 API层设计

```go
// api/v1/writer/world_setting_api.go
package writer

import (
    "net/http"
    
    "github.com/gin-gonic/gin"
    "qingyu_backend/service/worldsetting"
    "qingyu_backend/pkg/response"
)

type WorldSettingApi struct {
    settingService *worldsetting.WorldSettingService
}

func NewWorldSettingApi(settingService *worldsetting.WorldSettingService) *WorldSettingApi {
    return &WorldSettingApi{
        settingService: settingService,
    }
}

// CreateSetting 创建设定
func (api *WorldSettingApi) CreateSetting(c *gin.Context) {
    projectID := c.Param("projectId")
    
    var req worldsetting.CreateSettingRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.Error(c, http.StatusBadRequest, "参数错误", err.Error())
        return
    }
    
    req.ProjectID = projectID
    
    resp, err := api.settingService.CreateSetting(c.Request.Context(), &req)
    if err != nil {
        response.HandleError(c, err)
        return
    }
    
    response.Success(c, http.StatusCreated, "创建成功", resp)
}

// GetSettingsByType 按类型获取设定
func (api *WorldSettingApi) GetSettingsByType(c *gin.Context) {
    projectID := c.Param("projectId")
    settingType := c.Query("type")
    
    settings, err := api.settingService.GetSettingsByType(c.Request.Context(), projectID, document.SettingType(settingType))
    if err != nil {
        response.HandleError(c, err)
        return
    }
    
    response.Success(c, http.StatusOK, "获取成功", settings)
}

// SearchSettings 搜索设定
func (api *WorldSettingApi) SearchSettings(c *gin.Context) {
    projectID := c.Param("projectId")
    keyword := c.Query("keyword")
    
    settings, err := api.settingService.SearchSettings(c.Request.Context(), projectID, keyword)
    if err != nil {
        response.HandleError(c, err)
        return
    }
    
    response.Success(c, http.StatusOK, "搜索成功", settings)
}
```

## 4. API接口设计

### 4.1 创建设定

```http
POST /api/v1/projects/{projectId}/settings
Authorization: Bearer {token}
Content-Type: application/json

{
  "type": "cultivation",
  "category": "修真",
  "name": "境界体系",
  "summary": "本作品的修炼境界划分",
  "content": "<p>详细描述...</p>",
  "properties": {
    "levels": [
      {"name": "筑基", "order": 1},
      {"name": "金丹", "order": 2}
    ]
  },
  "tags": ["核心设定"]
}

Response:
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "settingId": "setting123",
    "name": "境界体系",
    "type": "cultivation",
    "createdAt": "2025-10-16T10:00:00Z"
  }
}
```

### 4.2 获取设定列表

```http
GET /api/v1/projects/{projectId}/settings?type=cultivation
Authorization: Bearer {token}

Response:
{
  "code": 200,
  "message": "获取成功",
  "data": [
    {
      "id": "setting123",
      "name": "境界体系",
      "type": "cultivation",
      "summary": "本作品的修炼境界划分",
      "referenceCount": 5
    }
  ]
}
```

### 4.3 搜索设定

```http
GET /api/v1/projects/{projectId}/settings/search?keyword=境界
Authorization: Bearer {token}

Response:
{
  "code": 200,
  "message": "搜索成功",
  "data": [...]
}
```

## 5. 前端集成示例

```vue
<template>
  <div class="settings-manager">
    <!-- 类型筛选 -->
    <el-tabs v-model="activeType" @tab-click="handleTypeChange">
      <el-tab-pane label="修炼体系" name="cultivation"></el-tab-pane>
      <el-tab-pane label="势力组织" name="faction"></el-tab-pane>
      <el-tab-pane label="地理设定" name="geography"></el-tab-pane>
      <el-tab-pane label="物品设定" name="item"></el-tab-pane>
    </el-tabs>
    
    <!-- 设定列表 -->
    <el-table :data="settings">
      <el-table-column prop="name" label="名称"></el-table-column>
      <el-table-column prop="summary" label="简介"></el-table-column>
      <el-table-column prop="referenceCount" label="引用次数"></el-table-column>
      <el-table-column label="操作">
        <template #default="{ row }">
          <el-button size="small" @click="editSetting(row)">编辑</el-button>
          <el-button size="small" @click="insertToDocument(row)">插入</el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>

<script>
export default {
  data() {
    return {
      activeType: 'cultivation',
      settings: []
    }
  },
  
  methods: {
    async loadSettings() {
      const res = await this.$api.getSettingsByType(this.projectId, this.activeType)
      this.settings = res.data
    },
    
    handleTypeChange() {
      this.loadSettings()
    },
    
    insertToDocument(setting) {
      // 在编辑器中插入设定引用
      this.$emit('insert-setting', setting)
    }
  }
}
</script>
```

## 6. 性能优化

- **索引优化**：在project_id、type、name等字段建立索引
- **全文搜索**：使用MongoDB文本索引或Elasticsearch
- **缓存策略**：常用设定缓存30分钟

## 7. 相关文档

- [角色卡关系图设计](./角色卡_关系图设计.md)
- [大纲时间空间地图设计](./大纲_时间_空间地图设计.md)
- [项目管理系统设计](./项目管理系统设计.md)

---

**文档版本**: v1.0  
**创建日期**: 2025-10-16  
**最后更新**: 2025-10-16  
**维护者**: 青羽写作团队

