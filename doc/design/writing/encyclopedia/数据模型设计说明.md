# å†™ä½œç«¯æ•°æ®æ¨¡å‹è®¾è®¡è¯´æ˜

> **ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-10-16  
> **ç»´æŠ¤è€…**: é’ç¾½å†™ä½œå›¢é˜Ÿ

## æ¦‚è¿°

æœ¬æ–‡æ¡£è§£é‡Šå†™ä½œç«¯æ¨¡å—çš„æ•°æ®æ¨¡å‹è®¾è®¡ç†å¿µï¼Œç‰¹åˆ«æ˜¯**Document**å’Œ**DocumentContent**åˆ†ç¦»çš„è®¾è®¡åŸå› ã€‚

---

## æ ¸å¿ƒè®¾è®¡ç†å¿µï¼šå…³æ³¨ç‚¹åˆ†ç¦»

### ä¸ºä»€ä¹ˆDocumentä¸åŒ…å«contentå­—æ®µï¼Ÿ

è¿™æ˜¯ä¸€ä¸ª**å…³æ³¨ç‚¹åˆ†ç¦»ï¼ˆSeparation of Concernsï¼‰**çš„ç»å…¸è®¾è®¡æ¨¡å¼ã€‚

### æ•°æ®æ¨¡å‹å…³è”å…³ç³»

```
Document (1) â†â”€â”€â”€â”€â”¬â”€â”€ DocumentContent (0..1) å½“å‰å†…å®¹
                  â””â”€â”€ Version (0..N) å†å²ç‰ˆæœ¬

å…³è”æ–¹å¼ï¼š
- DocumentContent.DocumentID â†’ Document.ID
- Version.DocumentID â†’ Document.ID
- æŸ¥è¯¢ï¼šé€šè¿‡DocumentIDåå‘æŸ¥è¯¢ï¼ˆå•å‘å…³è”ï¼‰
```

**ä¸ºä»€ä¹ˆä¸ä½¿ç”¨Document.ContentIDï¼Ÿ**
- âœ… é¿å…åŒå‘å…³è”ï¼Œå‡å°‘æ•°æ®åŒæ­¥é—®é¢˜
- âœ… å•å‘å…³è”æ›´æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
- âœ… åå‘æŸ¥è¯¢æ€§èƒ½ç›¸åŒï¼ˆéƒ½æœ‰ç´¢å¼•ï¼‰
- âœ… ç¬¦åˆMongoDBæ¨èçš„å…³è”æ¨¡å¼

### ä¸‰ä¸ªç‹¬ç«‹çš„æ¨¡å‹

#### 1. Documentï¼ˆæ–‡æ¡£ç»“æ„æ¨¡å‹ï¼‰

**èŒè´£**ï¼šç®¡ç†æ–‡æ¡£çš„**ç»„ç»‡ç»“æ„å’Œå…ƒæ•°æ®**

```go
type Document struct {
    // ç»“æ„ä¿¡æ¯
    ID, ProjectID, ParentID  // æ ‘å½¢ç»“æ„
    Level, Order, Type       // å±‚çº§å’Œæ’åº
    
    // å…ƒæ•°æ®
    Title, Status, Tags, Notes
    
    // å…³è”
    CharacterIDs, LocationIDs, TimelineIDs
    
    // ç»Ÿè®¡
    WordCount  // å†—ä½™å­—æ®µï¼Œä»DocumentContentåŒæ­¥
    
    // âŒ ä¸åŒ…å«ï¼šå®é™…å†…å®¹ï¼ˆcontentï¼‰
    // âŒ ä¸åŒ…å«ï¼šContentIDï¼ˆé€šè¿‡DocumentIDåå‘æŸ¥è¯¢ï¼‰
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- æŸ¥è¯¢æ–‡æ¡£æ ‘
- æ‹–æ‹½æ’åº
- æ–‡æ¡£ç§»åŠ¨
- ç»“æ„è°ƒæ•´

#### 2. DocumentContentï¼ˆæ–‡æ¡£å†…å®¹æ¨¡å‹ï¼‰

**èŒè´£**ï¼šç®¡ç†æ–‡æ¡£çš„**å®é™…å†…å®¹**

```go
type DocumentContent struct {
    ID, DocumentID      // å…³è”åˆ°Document
    Content             // å®é™…æ–‡æ¡£å†…å®¹ï¼ˆå¯èƒ½å¾ˆå¤§ï¼‰
    ContentType         // markdown | richtext
    WordCount, CharCount
    GridFSID            // å¤§æ–‡ä»¶ï¼ˆ>1MBï¼‰å­˜å‚¨åœ¨GridFS
    Version             // ä¹è§‚é”ç‰ˆæœ¬å·
    LastSavedAt
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- ç¼–è¾‘å™¨åŠ è½½å†…å®¹
- ä¿å­˜å†…å®¹
- è‡ªåŠ¨ä¿å­˜

#### 3. Versionï¼ˆç‰ˆæœ¬å†å²æ¨¡å‹ï¼‰

**èŒè´£**ï¼šç®¡ç†æ–‡æ¡£çš„**å†å²ç‰ˆæœ¬**

```go
type Version struct {
    ID, DocumentID
    VersionNum          // ç‰ˆæœ¬å·
    Content             // å†å²ç‰ˆæœ¬çš„å†…å®¹
    GridFSID            // å¤§æ–‡ä»¶ç‰ˆæœ¬
    Comment             // ç‰ˆæœ¬è¯´æ˜
    CreatedBy, CreatedAt
    IsAutoSave          // æ˜¯å¦è‡ªåŠ¨ä¿å­˜
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- ç‰ˆæœ¬å†å²
- ç‰ˆæœ¬å¯¹æ¯”
- ç‰ˆæœ¬å›æ»š

---

## è®¾è®¡ä¼˜åŠ¿

### 1. æ€§èƒ½ä¼˜åŒ– ğŸš€

#### æŸ¥è¯¢æ–‡æ¡£æ ‘ï¼ˆé«˜é¢‘æ“ä½œï¼‰

**âŒ å¦‚æœDocumentåŒ…å«content**ï¼š
```go
// æŸ¥è¯¢100ä¸ªæ–‡æ¡£çš„æ ‘
documents, _ := repo.GetDocumentTree(projectID)

// é—®é¢˜ï¼š
// - éœ€è¦åŠ è½½æ‰€æœ‰æ–‡æ¡£çš„å®Œæ•´å†…å®¹ï¼ˆå¯èƒ½å‡ åMBï¼‰
// - å“åº”æ—¶é—´ï¼š5-10ç§’
// - å†…å­˜å ç”¨ï¼š100MB+
// - ç½‘ç»œä¼ è¾“ï¼šæ…¢
```

**âœ… å½“å‰è®¾è®¡ï¼ˆåˆ†ç¦»ï¼‰**ï¼š
```go
// æŸ¥è¯¢100ä¸ªæ–‡æ¡£çš„æ ‘
documents, _ := repo.GetDocumentTree(projectID)

// ä¼˜åŠ¿ï¼š
// - åªåŠ è½½å…ƒæ•°æ®ï¼ˆæ ‡é¢˜ã€å±‚çº§ã€é¡ºåºï¼‰
// - å“åº”æ—¶é—´ï¼š<300ms
// - å†…å­˜å ç”¨ï¼š<1MB
// - ç½‘ç»œä¼ è¾“ï¼šå¿«
```

### 2. æŒ‰éœ€åŠ è½½ ğŸ“¦

```go
// ç”¨æˆ·æµè§ˆæ–‡æ¡£æ ‘ â†’ åªåŠ è½½Document
GET /api/v1/projects/123/documents/tree

// ç”¨æˆ·ç‚¹å‡»æŸä¸ªæ–‡æ¡£ç¼–è¾‘ â†’ æ‰åŠ è½½DocumentContent
GET /api/v1/documents/doc123/content
```

### 3. ç‰ˆæœ¬æ§åˆ¶ ğŸ“š

```go
// ä¸€å¯¹å¤šå…³ç³»
Document (1)
    â†“
DocumentContent (1ä¸ªå½“å‰ç‰ˆæœ¬)
    â†“
Version (Nä¸ªå†å²ç‰ˆæœ¬)

// æŸ¥è¯¢ç‰ˆæœ¬å†å²ä¸å½±å“DocumentæŸ¥è¯¢
GET /api/v1/documents/doc123/versions
```

### 4. å¤§æ–‡ä»¶æ”¯æŒ ğŸ’¾

```go
// å°æ–‡æ¡£ï¼ˆ<1MBï¼‰
DocumentContent {
    Content: "å®é™…å†…å®¹...",  // ç›´æ¥å­˜å‚¨
    GridFSID: ""
}

// å¤§æ–‡æ¡£ï¼ˆ>1MBï¼‰
DocumentContent {
    Content: "",  // å†…å®¹ä¸ºç©º
    GridFSID: "gridfs_123"  // å­˜å‚¨åœ¨GridFS
}

// Documentå§‹ç»ˆä¿æŒè½»é‡
```

### 5. æ•°æ®åº“æŸ¥è¯¢æ•ˆç‡ âš¡

```mongodb
// æŸ¥è¯¢æ–‡æ¡£åˆ—è¡¨ï¼ˆç´¢å¼•è¦†ç›–ï¼‰
db.documents.find({project_id: "123"})
  .project({title: 1, level: 1, order: 1})
// â†’ åªæ‰«æç´¢å¼•ï¼Œä¸è¯»å–æ–‡æ¡£å†…å®¹

// æŸ¥è¯¢æ–‡æ¡£å†…å®¹ï¼ˆæŒ‰éœ€ï¼‰
db.document_contents.findOne({document_id: "doc123"})
// â†’ åªåœ¨éœ€è¦æ—¶æŸ¥è¯¢
```

---

## æ•°æ®åº“è®¾è®¡

### é›†åˆç»“æ„

```javascript
// documents é›†åˆï¼ˆè½»é‡çº§ï¼‰
{
  "_id": "doc123",
  "project_id": "proj123",
  "parent_id": "parent456",
  "title": "ç¬¬ä¸€ç« ",
  "type": "chapter",
  "level": 1,
  "order": 1,
  // æ³¨æ„ï¼šç§»é™¤äº†content_idå­—æ®µï¼Œé€šè¿‡document_idåå‘æŸ¥è¯¢
  "word_count": 5000,          // å†—ä½™ï¼Œä»DocumentContentåŒæ­¥
  "created_at": ISODate
}

// document_contents é›†åˆï¼ˆé‡é‡çº§ï¼‰
{
  "_id": "content789",
  "document_id": "doc123",     // å…³è”åˆ°Document
  "content": "å®é™…çš„æ–‡æ¡£å†…å®¹...",  // å¯èƒ½å¾ˆå¤§
  "content_type": "markdown",
  "word_count": 5000,
  "version": 3,                // ä¹è§‚é”ç‰ˆæœ¬å·
  "gridfs_id": "",             // å¤§æ–‡ä»¶æ—¶ä½¿ç”¨
  "created_at": ISODate
}

// versions é›†åˆï¼ˆå†å²ç‰ˆæœ¬ï¼‰
{
  "_id": "ver001",
  "document_id": "doc123",     // å…³è”åˆ°Document
  "version_num": 2,            // ç‰ˆæœ¬å·ï¼ˆv1, v2, v3...ï¼‰
  "content": "ç¬¬äºŒç‰ˆçš„å®Œæ•´å†…å®¹...", // å®Œæ•´å¿«ç…§ï¼Œæ”¯æŒç‹¬ç«‹å›æ»š
  "gridfs_id": "",             // å¤§æ–‡ä»¶ç‰ˆæœ¬æ—¶ä½¿ç”¨
  "comment": "ä¿®æ”¹äº†ç¬¬ä¸‰æ®µ",
  "created_by": "user123",
  "is_auto_save": false,
  "created_at": ISODate
}
```

### ç´¢å¼•è®¾è®¡

```javascript
// documentsç´¢å¼•ï¼ˆç”¨äºæ ‘æŸ¥è¯¢ï¼‰
db.documents.createIndex({
  "project_id": 1,
  "level": 1,
  "order": 1
})

// document_contentsç´¢å¼•ï¼ˆç”¨äºå†…å®¹æŸ¥è¯¢ï¼‰
db.document_contents.createIndex({
  "document_id": 1
})

// versionsç´¢å¼•ï¼ˆç”¨äºç‰ˆæœ¬æŸ¥è¯¢ï¼‰
db.versions.createIndex({
  "document_id": 1,
  "version_num": -1
})
```

---

## APIè®¾è®¡

### æ–‡æ¡£ç»“æ„APIï¼ˆä½¿ç”¨Documentï¼‰

```http
# æŸ¥è¯¢æ–‡æ¡£æ ‘ï¼ˆå¿«é€Ÿï¼‰
GET /api/v1/projects/123/documents/tree
â†’ è¿”å›ï¼šDocumentæ•°ç»„ï¼ˆä¸å«contentï¼‰

# åˆ›å»ºæ–‡æ¡£ï¼ˆåªåˆ›å»ºç»“æ„ï¼‰
POST /api/v1/projects/123/documents
{
  "title": "ç¬¬ä¸€ç« ",
  "type": "chapter"
}
â†’ åˆ›å»ºï¼šDocumentè®°å½•
```

### æ–‡æ¡£å†…å®¹APIï¼ˆä½¿ç”¨DocumentContentï¼‰

```http
# è·å–æ–‡æ¡£å†…å®¹ï¼ˆç¼–è¾‘æ—¶ï¼‰
GET /api/v1/documents/doc123/content
â†’ è¿”å›ï¼šDocumentContentï¼ˆåŒ…å«å®é™…å†…å®¹ï¼‰

# ä¿å­˜æ–‡æ¡£å†…å®¹
PUT /api/v1/documents/doc123/content
{
  "content": "æ›´æ–°çš„å†…å®¹...",
  "version": 3
}
â†’ æ›´æ–°ï¼šDocumentContentï¼Œåˆ›å»ºVersion
```

### ç‰ˆæœ¬ç®¡ç†APIï¼ˆä½¿ç”¨Versionï¼‰

```http
# æŸ¥è¯¢ç‰ˆæœ¬å†å²
GET /api/v1/documents/doc123/versions
â†’ è¿”å›ï¼šVersionæ•°ç»„

# æ¢å¤ç‰ˆæœ¬
POST /api/v1/documents/doc123/restore/v2
â†’ æ¢å¤ï¼šå°†Versionå†…å®¹å¤åˆ¶åˆ°DocumentContent
```

---

## å®é™…ä½¿ç”¨æµç¨‹

### åœºæ™¯1ï¼šæŸ¥çœ‹é¡¹ç›®å¤§çº²

```
ç”¨æˆ·æ“ä½œï¼šæ‰“å¼€é¡¹ç›® â†’ æŸ¥çœ‹æ–‡æ¡£æ ‘
    â†“
GET /api/v1/projects/123/documents/tree
    â†“
åªæŸ¥è¯¢documentsé›†åˆï¼ˆè½»é‡çº§ï¼‰
    â†“
è¿”å›ï¼š100ä¸ªæ–‡æ¡£çš„å…ƒæ•°æ®ï¼ˆ<100KBï¼‰
    â†“
å“åº”æ—¶é—´ï¼š<300ms âœ…
```

### åœºæ™¯2ï¼šç¼–è¾‘æ–‡æ¡£

```
ç”¨æˆ·æ“ä½œï¼šç‚¹å‡»æ–‡æ¡£ â†’ åŠ è½½ç¼–è¾‘å™¨
    â†“
GET /api/v1/documents/doc123/content
    â†“
é€šè¿‡document_idåå‘æŸ¥è¯¢document_contentsé›†åˆ
db.document_contents.findOne({document_id: "doc123"})
    â†“
è¿”å›ï¼šDocumentContentï¼ˆåŒ…å«å®é™…å†…å®¹ï¼‰
    â†“
å“åº”æ—¶é—´ï¼š<500ms âœ…ï¼ˆæœ‰ç´¢å¼•ï¼‰
```

### åœºæ™¯3ï¼šè‡ªåŠ¨ä¿å­˜

```
ç¼–è¾‘å™¨ï¼š30ç§’è‡ªåŠ¨ä¿å­˜
    â†“
POST /api/v1/documents/doc123/autosave
{
  "content": "æ›´æ–°çš„å†…å®¹...",
  "version": 3  // ä¹è§‚é”
}
    â†“
æ›´æ–°document_contentsï¼ˆä¸åˆ›å»ºVersionï¼‰
    â†“
åŒæ­¥æ›´æ–°documents.word_count
    â†“
å“åº”æ—¶é—´ï¼š<200ms âœ…
```

### åœºæ™¯4ï¼šæ‰‹åŠ¨ä¿å­˜ï¼ˆåˆ›å»ºç‰ˆæœ¬ï¼‰

```
ç”¨æˆ·æ“ä½œï¼šç‚¹å‡»ä¿å­˜æŒ‰é’®
    â†“
PUT /api/v1/documents/doc123/content
{
  "content": "æ›´æ–°çš„å†…å®¹...",
  "version": 3,
  "comment": "å®Œæˆç¬¬ä¸€ç« ä¿®æ”¹"
}
    â†“
1. æ›´æ–°document_contents
2. åˆ›å»ºæ–°Versionè®°å½•
3. æ›´æ–°documents.word_count
    â†“
å¯ä»¥å›æº¯ç‰ˆæœ¬å†å² âœ…
```

---

## å¯¹æ¯”å…¶ä»–è®¾è®¡æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šæ‰€æœ‰å†…å®¹éƒ½åœ¨Documentä¸­ âŒ

```go
type Document struct {
    ID, Title, ...
    Content string  // é—®é¢˜ï¼šæ¯æ¬¡æŸ¥è¯¢éƒ½åŠ è½½å†…å®¹
}
```

**ç¼ºç‚¹**ï¼š
- âŒ æŸ¥è¯¢æ–‡æ¡£æ ‘æ…¢ï¼ˆåŠ è½½æ‰€æœ‰å†…å®¹ï¼‰
- âŒ æ— æ³•æ”¯æŒç‰ˆæœ¬æ§åˆ¶
- âŒ æ— æ³•æ”¯æŒå¤§æ–‡ä»¶
- âŒ å†…å­˜å ç”¨å¤§
- âŒ ç½‘ç»œä¼ è¾“æ…¢

### æ–¹æ¡ˆBï¼šDocument + DocumentContentåˆ†ç¦» âœ…ï¼ˆå½“å‰æ–¹æ¡ˆï¼‰

```go
type Document struct {
    ID, Title, ...
    ContentID string  // æŒ‡å‘DocumentContent
}

type DocumentContent struct {
    ID, DocumentID
    Content string
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… æŸ¥è¯¢æ–‡æ¡£æ ‘å¿«ï¼ˆåªåŠ è½½å…ƒæ•°æ®ï¼‰
- âœ… æ”¯æŒç‰ˆæœ¬æ§åˆ¶
- âœ… æ”¯æŒå¤§æ–‡ä»¶ï¼ˆGridFSï¼‰
- âœ… æŒ‰éœ€åŠ è½½
- âœ… æ€§èƒ½ä¼˜ç§€

---

## æŠ€æœ¯å®ç°

### Documentæ¨¡å‹ï¼ˆå½“å‰å·²å®ç°ï¼‰

```go
type Document struct {
    // ... å…¶ä»–å­—æ®µ
    ContentID string  // å…³è”DocumentContent
    WordCount int     // å†—ä½™å­—æ®µï¼Œæ–¹ä¾¿æŸ¥è¯¢
    Version   int     // ç‰ˆæœ¬å·ï¼ˆä¹è§‚é”ï¼‰
}
```

### DocumentContentæ¨¡å‹ï¼ˆåˆšåˆšåˆ›å»ºï¼‰

```go
type DocumentContent struct {
    ID           string
    DocumentID   string    // å…³è”åˆ°Document
    Content      string    // å®é™…å†…å®¹
    ContentType  string    // markdown | richtext
    GridFSID     string    // å¤§æ–‡ä»¶æ”¯æŒ
    Version      int       // ä¹è§‚é”
    // ...
}
```

### Versionæ¨¡å‹ï¼ˆéœ€è¦æ›´æ–°ï¼‰

```go
type Version struct {
    ID          string
    DocumentID  string    // å…³è”åˆ°Document
    VersionNum  int       // ç‰ˆæœ¬å·
    Content     string    // å†å²ç‰ˆæœ¬å†…å®¹
    GridFSID    string    // å¤§æ–‡ä»¶ç‰ˆæœ¬
    // ...
}
```

---

## æ€»ç»“

### âœ… å½“å‰è®¾è®¡æ˜¯æ­£ç¡®çš„

**Documentæ¨¡å‹**ï¼š
- âœ… åªåŒ…å«ç»“æ„å’Œå…ƒæ•°æ®
- âœ… ä½¿ç”¨ContentIDå…³è”å†…å®¹
- âœ… æ·»åŠ äº†Versionå­—æ®µï¼ˆä¹è§‚é”ï¼‰
- âœ… WordCountå†—ä½™å­—æ®µï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰

**DocumentContentæ¨¡å‹**ï¼ˆå·²åˆ›å»ºï¼‰ï¼š
- âœ… ç‹¬ç«‹å­˜å‚¨å®é™…å†…å®¹
- âœ… æ”¯æŒGridFSå¤§æ–‡ä»¶
- âœ… åŒ…å«ç‰ˆæœ¬æ§åˆ¶å­—æ®µ

**Versionæ¨¡å‹**ï¼ˆéœ€è¦æ›´æ–°ï¼‰ï¼š
- ğŸ”„ éœ€è¦æ·»åŠ æ–°çš„Versionç»“æ„
- âœ… ä¿ç•™æ—§çš„FileRevisionç­‰ç»“æ„ï¼ˆå…¼å®¹æ€§ï¼‰

---

## ä¸‹ä¸€æ­¥

æˆ‘ä¼šä¸ºæ‚¨ï¼š
1. âœ… å·²åˆ›å»ºDocumentContentæ¨¡å‹
2. ğŸ”„ æ›´æ–°Versionæ¨¡å‹ï¼ˆæ·»åŠ æ–°ç»“æ„ï¼‰
3. ğŸ“ åˆ›å»ºæ­¤è¯´æ˜æ–‡æ¡£

è¿™ä¸ªè®¾è®¡å®Œå…¨ç¬¦åˆæœ€ä½³å®è·µï¼Œè¯·æ”¾å¿ƒç»§ç»­ä½¿ç”¨ï¼

**éœ€è¦æˆ‘ç»§ç»­æ›´æ–°Versionæ¨¡å‹å—ï¼Ÿ**

