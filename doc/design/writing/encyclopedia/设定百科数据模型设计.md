# 设定百科数据模型设计

> **版本**: v1.0  
> **创建日期**: 2025-10-21  
> **最后更新**: 2025-10-21  
> **状态**: ✅ 已实现，补充设计文档

---

## 1. 为什么需要这个设计

### 1.1 业务背景

设定百科是网络小说创作的重要辅助工具，负责：
- 角色、地点、时间线等世界观管理
- 创作资料系统化整理
- 前后文设定一致性保障
- AI辅助创作的知识库
- 提升创作效率

### 1.2 实际实现情况

已完整实现，包含三个核心模型：
- **Character**（角色卡）：`models/document/character.go` - 人物设定
- **Location**（地点）：`models/document/location.go` - 场景/地点设定
- **Timeline**（时间线）：`models/document/timeline.go` - 时间线和事件管理

**实现文件**：
- `models/document/character.go` - 角色数据模型
- `models/document/location.go` - 地点数据模型
- `models/document/timeline.go` - 时间线数据模型
- `service/document/character_service.go`（待创建） - 角色服务
- `service/document/location_service.go`（待创建） - 地点服务
- `service/document/timeline_service.go`（待创建） - 时间线服务

---

## 2. 数据模型设计

### 2.1 Character（角色卡）

#### 2.1.1 数据结构

```go
type Character struct {
    ID         string   `bson:"_id,omitempty" json:"id"`
    ProjectID  string   `bson:"project_id" json:"projectId"`              // 所属项目ID
    Name       string   `bson:"name" json:"name"`                         // 角色名字
    Alias      []string `bson:"alias,omitempty" json:"alias,omitempty"`   // 别名/绰号
    Summary    string   `bson:"summary,omitempty" json:"summary,omitempty"` // 简介
    Traits     []string `bson:"traits,omitempty" json:"traits,omitempty"` // 性格标签
    Background string   `bson:"background,omitempty" json:"background,omitempty"` // 背景故事
    AvatarURL  string   `bson:"avatar_url,omitempty" json:"avatarUrl,omitempty"`  // 头像URL
    
    // AI相关字段（用于AI辅助创作）
    PersonalityPrompt string `bson:"personality_prompt,omitempty" json:"personalityPrompt,omitempty"` // 性格提示词
    SpeechPattern     string `bson:"speech_pattern,omitempty" json:"speechPattern,omitempty"`         // 语言风格
    CurrentState      string `bson:"current_state,omitempty" json:"currentState,omitempty"`           // 当前状态
    
    CreatedAt time.Time `bson:"created_at" json:"createdAt"`
    UpdatedAt time.Time `bson:"updated_at" json:"updatedAt"`
}
```

#### 2.1.2 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| ID | string | 否 | 角色唯一标识 |
| ProjectID | string | 是 | 所属项目ID |
| Name | string | 是 | 角色名字 |
| Alias | []string | 否 | 别名/绰号列表 |
| Summary | string | 否 | 角色简介（一句话描述） |
| Traits | []string | 否 | 性格标签（如：冷静、勇敢、智慧） |
| Background | string | 否 | 背景故事（详细设定） |
| AvatarURL | string | 否 | 头像图片URL |
| PersonalityPrompt | string | 否 | AI生成时的性格提示词 |
| SpeechPattern | string | 否 | 角色说话风格 |
| CurrentState | string | 否 | 角色当前状态（剧情进展） |
| CreatedAt | time.Time | 是 | 创建时间 |
| UpdatedAt | time.Time | 是 | 更新时间 |

#### 2.1.3 CharacterRelation（角色关系）

```go
type CharacterRelation struct {
    ID            string    `bson:"_id,omitempty" json:"id"`
    ProjectID     string    `bson:"project_id" json:"projectId"`
    SourceCharID  string    `bson:"source_char_id" json:"sourceCharId"`   // 源角色ID
    TargetCharID  string    `bson:"target_char_id" json:"targetCharId"`   // 目标角色ID
    RelationType  string    `bson:"relation_type" json:"relationType"`    // 关系类型
    Description   string    `bson:"description" json:"description"`       // 关系描述
    IsBidirectional bool   `bson:"is_bidirectional" json:"isBidirectional"` // 是否双向关系
    CreatedAt     time.Time `bson:"created_at" json:"createdAt"`
}
```

#### 2.1.4 RelationType（关系类型）

```go
const (
    RelationFamily    = "family"     // 家人
    RelationFriend    = "friend"     // 朋友
    RelationEnemy     = "enemy"      // 敌人
    RelationLover     = "lover"      // 情侣
    RelationMaster    = "master"     // 师徒
    RelationRival     = "rival"      // 竞争对手
    RelationAlly      = "ally"       // 盟友
    RelationSubordinate = "subordinate" // 上下级
    RelationOther     = "other"      // 其他
)
```

#### 2.1.5 索引策略

```javascript
// MongoDB索引
db.characters.createIndex({ "project_id": 1, "name": 1 })
db.characters.createIndex({ "project_id": 1, "created_at": -1 })
db.character_relations.createIndex({ "project_id": 1 })
db.character_relations.createIndex({ "source_char_id": 1, "target_char_id": 1 })
```

---

### 2.2 Location（地点）

#### 2.2.1 数据结构

```go
type Location struct {
    ID          string    `bson:"_id,omitempty" json:"id"`
    ProjectID   string    `bson:"project_id" json:"projectId"`
    Name        string    `bson:"name" json:"name"`                            // 地点名称
    Description string    `bson:"description,omitempty" json:"description,omitempty"` // 描述
    Climate     string    `bson:"climate,omitempty" json:"climate,omitempty"`  // 气候
    Culture     string    `bson:"culture,omitempty" json:"culture,omitempty"`  // 文化特色
    Geography   string    `bson:"geography,omitempty" json:"geography,omitempty"` // 地理特征
    Atmosphere  string    `bson:"atmosphere,omitempty" json:"atmosphere,omitempty"` // 氛围
    ParentID    string    `bson:"parent_id,omitempty" json:"parentId,omitempty"` // 父级地点ID（层级结构）
    ImageURL    string    `bson:"image_url,omitempty" json:"imageUrl,omitempty"` // 地点图片
    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time `bson:"updated_at" json:"updatedAt"`
}
```

#### 2.2.2 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| ID | string | 否 | 地点唯一标识 |
| ProjectID | string | 是 | 所属项目ID |
| Name | string | 是 | 地点名称 |
| Description | string | 否 | 地点描述 |
| Climate | string | 否 | 气候特征 |
| Culture | string | 否 | 文化特色 |
| Geography | string | 否 | 地理特征 |
| Atmosphere | string | 否 | 氛围描述 |
| ParentID | string | 否 | 父级地点ID（支持层级：大陆→国家→城市→区域） |
| ImageURL | string | 否 | 地点图片URL |
| CreatedAt | time.Time | 是 | 创建时间 |
| UpdatedAt | time.Time | 是 | 更新时间 |

#### 2.2.3 LocationRelation（地点关系）

```go
type LocationRelation struct {
    ID            string    `bson:"_id,omitempty" json:"id"`
    ProjectID     string    `bson:"project_id" json:"projectId"`
    SourceLocID   string    `bson:"source_loc_id" json:"sourceLocId"`
    TargetLocID   string    `bson:"target_loc_id" json:"targetLocId"`
    RelationType  string    `bson:"relation_type" json:"relationType"` // contains/borders/connects
    Description   string    `bson:"description" json:"description"`
    CreatedAt     time.Time `bson:"created_at" json:"createdAt"`
}
```

#### 2.2.4 层级查询示例

```go
// 获取地点的完整路径（如：修真大陆→东部仙域→天剑宗→剑峰）
func GetLocationPath(locationID string) ([]string, error) {
    path := []string{}
    currentID := locationID
    
    for currentID != "" {
        loc, err := GetLocationByID(currentID)
        if err != nil || loc == nil {
            break
        }
        path = append([]string{loc.Name}, path...) // 前置插入
        currentID = loc.ParentID
    }
    
    return path, nil
}
```

#### 2.2.5 索引策略

```javascript
// MongoDB索引
db.locations.createIndex({ "project_id": 1, "name": 1 })
db.locations.createIndex({ "project_id": 1, "parent_id": 1 })  // 层级查询
db.location_relations.createIndex({ "project_id": 1 })
```

---

### 2.3 Timeline（时间线）

#### 2.3.1 数据结构

```go
type Timeline struct {
    ID          string     `bson:"_id,omitempty" json:"id"`
    ProjectID   string     `bson:"project_id" json:"projectId"`
    Name        string     `bson:"name" json:"name"`                          // 时间线名称
    Description string     `bson:"description,omitempty" json:"description,omitempty"` // 描述
    StartTime   *StoryTime `bson:"start_time,omitempty" json:"startTime,omitempty"`    // 起始时间
    EndTime     *StoryTime `bson:"end_time,omitempty" json:"endTime,omitempty"`        // 结束时间
    CreatedAt   time.Time  `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time  `bson:"updated_at" json:"updatedAt"`
}
```

#### 2.3.2 StoryTime（故事时间）

```go
// StoryTime 故事时间（灵活的时间表示）
type StoryTime struct {
    Year   int    `bson:"year,omitempty" json:"year,omitempty"`     // 年
    Month  int    `bson:"month,omitempty" json:"month,omitempty"`   // 月
    Day    int    `bson:"day,omitempty" json:"day,omitempty"`       // 日
    Custom string `bson:"custom,omitempty" json:"custom,omitempty"` // 自定义时间（如：开天辟地后三千年）
}

// ToString 转换为字符串
func (st *StoryTime) ToString() string {
    if st.Custom != "" {
        return st.Custom
    }
    if st.Year > 0 {
        return fmt.Sprintf("%d年%d月%d日", st.Year, st.Month, st.Day)
    }
    return ""
}
```

#### 2.3.3 TimelineEvent（时间线事件）

```go
type TimelineEvent struct {
    ID           string     `bson:"_id,omitempty" json:"id"`
    ProjectID    string     `bson:"project_id" json:"projectId"`
    TimelineID   string     `bson:"timeline_id" json:"timelineId"`            // 所属时间线ID
    Title        string     `bson:"title" json:"title"`                       // 事件标题
    Description  string     `bson:"description,omitempty" json:"description,omitempty"` // 事件描述
    StoryTime    *StoryTime `bson:"story_time,omitempty" json:"storyTime,omitempty"`   // 事件时间
    Duration     string     `bson:"duration,omitempty" json:"duration,omitempty"`      // 持续时间
    Impact       string     `bson:"impact,omitempty" json:"impact,omitempty"`          // 事件影响
    Participants []string   `bson:"participants,omitempty" json:"participants,omitempty"` // 参与角色ID
    LocationIDs  []string   `bson:"location_ids,omitempty" json:"locationIds,omitempty"`  // 相关地点ID
    ChapterIDs   []string   `bson:"chapter_ids,omitempty" json:"chapterIds,omitempty"`    // 相关章节ID
    EventType    EventType  `bson:"event_type" json:"eventType"`              // 事件类型
    Importance   int        `bson:"importance" json:"importance"`             // 重要性（1-10）
    CreatedAt    time.Time  `bson:"created_at" json:"createdAt"`
    UpdatedAt    time.Time  `bson:"updated_at" json:"updatedAt"`
}
```

#### 2.3.4 EventType（事件类型）

```go
type EventType string

const (
    EventBattle      EventType = "battle"       // 战斗
    EventMeeting     EventType = "meeting"      // 会议/相遇
    EventDiscovery   EventType = "discovery"    // 发现/突破
    EventBirth       EventType = "birth"        // 出生
    EventDeath       EventType = "death"        // 死亡
    EventMarriage    EventType = "marriage"     // 结婚
    EventBreakthrough EventType = "breakthrough" // 突破/升级
    EventTravel      EventType = "travel"       // 旅行
    EventPlot        EventType = "plot"         // 剧情事件
    EventOther       EventType = "other"        // 其他
)
```

#### 2.3.5 索引策略

```javascript
// MongoDB索引
db.timelines.createIndex({ "project_id": 1 })
db.timeline_events.createIndex({ "project_id": 1, "timeline_id": 1 })
db.timeline_events.createIndex({ "project_id": 1, "event_type": 1 })
db.timeline_events.createIndex({ "participants": 1 })  // 查询角色参与的事件
```

---

## 3. Service层设计

### 3.1 CharacterService

```go
type CharacterService struct {
    characterRepo interfaces.CharacterRepository
    relationRepo  interfaces.CharacterRelationRepository
    eventBus      base.EventBus
}

// CreateCharacter 创建角色
func (s *CharacterService) CreateCharacter(ctx context.Context, req *CreateCharacterRequest) (*CreateCharacterResponse, error) {
    character := &Character{
        ProjectID:         req.ProjectID,
        Name:              req.Name,
        Alias:             req.Alias,
        Summary:           req.Summary,
        Traits:            req.Traits,
        Background:        req.Background,
        PersonalityPrompt: req.PersonalityPrompt,
        CreatedAt:         time.Now(),
        UpdatedAt:         time.Now(),
    }
    
    if err := s.characterRepo.Create(ctx, character); err != nil {
        return nil, errors.NewInternalError("创建角色失败").WithCause(err)
    }
    
    // 发布事件
    event := &base.BaseEvent{
        EventType: "character.created",
        EventData: map[string]interface{}{
            "character_id": character.ID,
            "project_id":   character.ProjectID,
            "name":         character.Name,
        },
        Timestamp: time.Now(),
        Source:    "CharacterService",
    }
    s.eventBus.PublishAsync(ctx, event)
    
    return &CreateCharacterResponse{
        CharacterID: character.ID,
        Name:        character.Name,
    }, nil
}

// AddCharacterRelation 添加角色关系
func (s *CharacterService) AddCharacterRelation(ctx context.Context, req *AddCharacterRelationRequest) error {
    relation := &CharacterRelation{
        ProjectID:       req.ProjectID,
        SourceCharID:    req.SourceCharID,
        TargetCharID:    req.TargetCharID,
        RelationType:    req.RelationType,
        Description:     req.Description,
        IsBidirectional: req.IsBidirectional,
        CreatedAt:       time.Now(),
    }
    
    if err := s.relationRepo.Create(ctx, relation); err != nil {
        return errors.NewInternalError("添加角色关系失败").WithCause(err)
    }
    
    // 如果是双向关系，添加反向关系
    if req.IsBidirectional {
        reverseRelation := &CharacterRelation{
            ProjectID:       req.ProjectID,
            SourceCharID:    req.TargetCharID,
            TargetCharID:    req.SourceCharID,
            RelationType:    req.RelationType,
            Description:     req.Description,
            IsBidirectional: true,
            CreatedAt:       time.Now(),
        }
        s.relationRepo.Create(ctx, reverseRelation)
    }
    
    return nil
}

// GetCharacterGraph 获取角色关系图
func (s *CharacterService) GetCharacterGraph(ctx context.Context, projectID string) (*CharacterGraph, error) {
    // 1. 获取所有角色
    characters, err := s.characterRepo.GetByProjectID(ctx, projectID)
    if err != nil {
        return nil, err
    }
    
    // 2. 获取所有关系
    relations, err := s.relationRepo.GetByProjectID(ctx, projectID)
    if err != nil {
        return nil, err
    }
    
    // 3. 构建关系图
    graph := &CharacterGraph{
        Nodes: characters,
        Edges: relations,
    }
    
    return graph, nil
}
```

### 3.2 LocationService

```go
type LocationService struct {
    locationRepo interfaces.LocationRepository
    eventBus     base.EventBus
}

// GetLocationTree 获取地点层级树
func (s *LocationService) GetLocationTree(ctx context.Context, projectID string) ([]*LocationNode, error) {
    // 1. 获取所有地点
    locations, err := s.locationRepo.GetByProjectID(ctx, projectID)
    if err != nil {
        return nil, err
    }
    
    // 2. 构建树形结构
    tree := buildLocationTree(locations)
    
    return tree, nil
}

// buildLocationTree 构建地点树
func buildLocationTree(locations []*Location) []*LocationNode {
    nodeMap := make(map[string]*LocationNode)
    var roots []*LocationNode
    
    // 创建所有节点
    for _, loc := range locations {
        nodeMap[loc.ID] = &LocationNode{
            Location: loc,
            Children: []*LocationNode{},
        }
    }
    
    // 构建父子关系
    for _, loc := range locations {
        node := nodeMap[loc.ID]
        if loc.ParentID == "" {
            roots = append(roots, node)
        } else {
            if parent, ok := nodeMap[loc.ParentID]; ok {
                parent.Children = append(parent.Children, node)
            }
        }
    }
    
    return roots
}
```

### 3.3 TimelineService

```go
type TimelineService struct {
    timelineRepo interfaces.TimelineRepository
    eventRepo    interfaces.TimelineEventRepository
    eventBus     base.EventBus
}

// CreateTimelineEvent 创建时间线事件
func (s *TimelineService) CreateTimelineEvent(ctx context.Context, req *CreateTimelineEventRequest) (*CreateTimelineEventResponse, error) {
    event := &TimelineEvent{
        ProjectID:    req.ProjectID,
        TimelineID:   req.TimelineID,
        Title:        req.Title,
        Description:  req.Description,
        StoryTime:    req.StoryTime,
        Duration:     req.Duration,
        Impact:       req.Impact,
        Participants: req.Participants,
        LocationIDs:  req.LocationIDs,
        EventType:    req.EventType,
        Importance:   req.Importance,
        CreatedAt:    time.Now(),
        UpdatedAt:    time.Now(),
    }
    
    if err := s.eventRepo.Create(ctx, event); err != nil {
        return nil, errors.NewInternalError("创建事件失败").WithCause(err)
    }
    
    return &CreateTimelineEventResponse{
        EventID: event.ID,
        Title:   event.Title,
    }, nil
}

// GetTimelineEvents 获取时间线事件列表（按时间排序）
func (s *TimelineService) GetTimelineEvents(ctx context.Context, timelineID string) ([]*TimelineEvent, error) {
    events, err := s.eventRepo.GetByTimelineID(ctx, timelineID)
    if err != nil {
        return nil, err
    }
    
    // 按时间排序
    sort.Slice(events, func(i, j int) bool {
        return compareStoryTime(events[i].StoryTime, events[j].StoryTime) < 0
    })
    
    return events, nil
}
```

---

## 4. API设计

### 4.1 角色API

```go
// POST /api/v1/projects/:projectId/characters - 创建角色
// GET /api/v1/projects/:projectId/characters - 获取角色列表
// GET /api/v1/characters/:characterId - 获取角色详情
// PUT /api/v1/characters/:characterId - 更新角色
// DELETE /api/v1/characters/:characterId - 删除角色
// POST /api/v1/characters/relations - 添加角色关系
// GET /api/v1/projects/:projectId/characters/graph - 获取角色关系图
```

### 4.2 地点API

```go
// POST /api/v1/projects/:projectId/locations - 创建地点
// GET /api/v1/projects/:projectId/locations - 获取地点列表
// GET /api/v1/projects/:projectId/locations/tree - 获取地点层级树
// GET /api/v1/locations/:locationId - 获取地点详情
// PUT /api/v1/locations/:locationId - 更新地点
// DELETE /api/v1/locations/:locationId - 删除地点
```

### 4.3 时间线API

```go
// POST /api/v1/projects/:projectId/timelines - 创建时间线
// GET /api/v1/projects/:projectId/timelines - 获取时间线列表
// POST /api/v1/timelines/:timelineId/events - 创建事件
// GET /api/v1/timelines/:timelineId/events - 获取事件列表
// PUT /api/v1/timeline-events/:eventId - 更新事件
// DELETE /api/v1/timeline-events/:eventId - 删除事件
```

---

## 5. 与v2.1架构的关系

### 5.1 在整体架构中的位置

```
Writing Module (写作端)
  └─ Document Module (文档模块)
      └─ Encyclopedia System (设定百科系统)
          ├─ Character (角色卡)
          ├─ Location (地点)
          ├─ Timeline (时间线)
          └─ Relations (关系管理)
```

### 5.2 与AI模块的集成

```go
// 角色设定可以作为AI创作的上下文
type AIContext struct {
    Characters []Character  // 相关角色
    Locations  []Location   // 相关地点
    Events     []TimelineEvent  // 相关事件
}

// 在AI生成时注入角色性格
func BuildPromptWithCharacter(character *Character, basePrompt string) string {
    return fmt.Sprintf("%s\n\n角色设定：\n性格：%s\n说话风格：%s", 
        basePrompt, 
        character.PersonalityPrompt, 
        character.SpeechPattern)
}
```

---

## 6. 实现参考

### 6.1 代码文件路径

- **数据模型**: 
  - `models/document/character.go`
  - `models/document/location.go`
  - `models/document/timeline.go`
- **Service**（待创建）:
  - `service/document/character_service.go`
  - `service/document/location_service.go`
  - `service/document/timeline_service.go`
- **Repository**（待创建）:
  - `repository/mongodb/document/character_mongo.go`
  - `repository/mongodb/document/location_mongo.go`
  - `repository/mongodb/document/timeline_mongo.go`

### 6.2 关键实现特性

1. ✅ 角色卡管理（支持AI性格提示）
2. ✅ 角色关系图
3. ✅ 地点层级管理
4. ✅ 时间线和事件管理
5. ✅ 灵活的时间表示（年月日或自定义）
6. ✅ 与章节内容关联
7. ✅ 支持AI辅助创作

---

**文档状态**: ✅ 已完成  
**最后审核**: 2025-10-21  
**优先级**: P0 - 核心创作工具

