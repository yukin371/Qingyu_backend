# 作品管理系统设计文档

## 1. 概述

### 1.1 功能描述
作品管理系统负责处理用户作品的创建、编辑、发布、查看、搜索等核心功能，是写作平台的核心业务模块。

### 1.2 设计目标
- **多格式支持**：支持多种文档格式的作品
- **版本管理**：支持作品的版本控制和历史记录
- **协作功能**：支持多用户协作编辑
- **分类管理**：灵活的分类和标签系统
- **搜索功能**：强大的全文搜索能力

## 2. 功能模块

### 2.1 作品CRUD
- 创建新作品
- 编辑作品内容
- 发布/取消发布
- 删除作品

### 2.2 版本管理
- 自动保存草稿
- 版本历史记录
- 版本对比
- 版本回滚

### 2.3 分类管理
- 多级分类结构
- 标签系统
- 分类统计

### 2.4 搜索功能
- 全文搜索
- 标签搜索
- 分类筛选
- 高级搜索

### 2.5 权限控制
- 公开/私有设置
- 协作权限管理
- 查看权限控制

## 3. 数据模型

### 3.1 作品实体
```go
type Work struct {
    ID          uint64    `json:"id" gorm:"primaryKey"`
    UserID      uint64    `json:"user_id" gorm:"index"`
    Title       string    `json:"title" gorm:"size:200"`
    Description string    `json:"description" gorm:"type:text"`
    Content     string    `json:"content" gorm:"type:longtext"`
    CategoryID  uint64    `json:"category_id" gorm:"index"`
    Tags        string    `json:"tags" gorm:"type:json"`
    CoverURL    string    `json:"cover_url" gorm:"size:255"`
    Status      int8      `json:"status" gorm:"default:1;index"` // 1:草稿 2:已发布 3:已删除
    Visibility  int8      `json:"visibility" gorm:"default:1"`   // 1:公开 2:私有 3:仅好友
    ViewCount   int       `json:"view_count" gorm:"default:0"`
    LikeCount   int       `json:"like_count" gorm:"default:0"`
    WordCount   int       `json:"word_count" gorm:"default:0"`
    CreatedAt   time.Time `json:"created_at" gorm:"index"`
    UpdatedAt   time.Time `json:"updated_at"`
    PublishedAt *time.Time `json:"published_at"`
}
```

### 3.2 分类实体
```go
type Category struct {
    ID          uint64    `json:"id" gorm:"primaryKey"`
    Name        string    `json:"name" gorm:"size:50"`
    Description string    `json:"description" gorm:"type:text"`
    ParentID    uint64    `json:"parent_id" gorm:"default:0"`
    SortOrder   int       `json:"sort_order" gorm:"default:0"`
    Status      int8      `json:"status" gorm:"default:1"`
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
}
```

### 3.3 版本历史
```go
type WorkVersion struct {
    ID        uint64    `json:"id" gorm:"primaryKey"`
    WorkID    uint64    `json:"work_id" gorm:"index"`
    Version   int       `json:"version"`
    Title     string    `json:"title" gorm:"size:200"`
    Content   string    `json:"content" gorm:"type:longtext"`
    ChangeLog string    `json:"change_log" gorm:"type:text"`
    CreatedAt time.Time `json:"created_at"`
}
```

### 3.4 协作关系
```go
type WorkCollaborator struct {
    ID         uint64    `json:"id" gorm:"primaryKey"`
    WorkID     uint64    `json:"work_id" gorm:"index"`
    UserID     uint64    `json:"user_id" gorm:"index"`
    Permission int8      `json:"permission"` // 1:只读 2:编辑 3:管理
    Status     int8      `json:"status" gorm:"default:1"`
    CreatedAt  time.Time `json:"created_at"`
    UpdatedAt  time.Time `json:"updated_at"`
}
```

## 4. API 接口

### 4.1 获取作品列表
```
GET /api/v1/works
Authorization: Bearer {token}
Query Parameters:
- page: 页码 (default: 1)
- size: 每页数量 (default: 20)
- category_id: 分类ID
- status: 状态筛选
- keyword: 搜索关键词
- sort: 排序方式 (created_at, updated_at, view_count, like_count)
- order: 排序顺序 (asc, desc)

Response:
{
    "code": 200,
    "message": "获取成功",
    "data": {
        "list": [
            {
                "id": 123,
                "title": "作品标题",
                "description": "作品描述",
                "category_id": 1,
                "tags": ["标签1", "标签2"],
                "cover_url": "https://example.com/cover.jpg",
                "status": 2,
                "visibility": 1,
                "view_count": 100,
                "like_count": 10,
                "word_count": 5000,
                "created_at": "2024-01-01T00:00:00Z",
                "updated_at": "2024-01-01T00:00:00Z",
                "published_at": "2024-01-01T00:00:00Z"
            }
        ],
        "total": 100,
        "page": 1,
        "size": 20
    }
}
```

### 4.2 创建作品
```
POST /api/v1/works
Authorization: Bearer {token}
Content-Type: application/json

{
    "title": "作品标题",
    "description": "作品描述",
    "content": "作品内容",
    "category_id": 1,
    "tags": ["标签1", "标签2"],
    "cover_url": "https://example.com/cover.jpg",
    "visibility": 1
}

Response:
{
    "code": 200,
    "message": "创建成功",
    "data": {
        "id": 123,
        "title": "作品标题",
        "status": 1,
        "created_at": "2024-01-01T00:00:00Z"
    }
}
```

### 4.3 获取作品详情
```
GET /api/v1/works/{id}
Authorization: Bearer {token}

Response:
{
    "code": 200,
    "message": "获取成功",
    "data": {
        "id": 123,
        "user_id": 456,
        "title": "作品标题",
        "description": "作品描述",
        "content": "作品内容",
        "category_id": 1,
        "tags": ["标签1", "标签2"],
        "cover_url": "https://example.com/cover.jpg",
        "status": 2,
        "visibility": 1,
        "view_count": 100,
        "like_count": 10,
        "word_count": 5000,
        "created_at": "2024-01-01T00:00:00Z",
        "updated_at": "2024-01-01T00:00:00Z",
        "published_at": "2024-01-01T00:00:00Z",
        "author": {
            "id": 456,
            "username": "author",
            "nickname": "作者昵称",
            "avatar_url": "https://example.com/avatar.jpg"
        },
        "category": {
            "id": 1,
            "name": "分类名称"
        }
    }
}
```

### 4.4 更新作品
```
PUT /api/v1/works/{id}
Authorization: Bearer {token}
Content-Type: application/json

{
    "title": "新标题",
    "description": "新描述",
    "content": "新内容",
    "category_id": 2,
    "tags": ["新标签1", "新标签2"],
    "cover_url": "https://example.com/new-cover.jpg",
    "visibility": 2
}

Response:
{
    "code": 200,
    "message": "更新成功",
    "data": {
        "id": 123,
        "version": 2,
        "updated_at": "2024-01-01T00:00:00Z"
    }
}
```

### 4.5 发布作品
```
POST /api/v1/works/{id}/publish
Authorization: Bearer {token}

Response:
{
    "code": 200,
    "message": "发布成功",
    "data": {
        "id": 123,
        "status": 2,
        "published_at": "2024-01-01T00:00:00Z"
    }
}
```

### 4.6 搜索作品
```
GET /api/v1/works/search
Authorization: Bearer {token}
Query Parameters:
- q: 搜索关键词
- category_id: 分类ID
- tags: 标签 (多个用逗号分隔)
- author: 作者用户名
- date_from: 开始日期
- date_to: 结束日期
- page: 页码
- size: 每页数量

Response:
{
    "code": 200,
    "message": "搜索成功",
    "data": {
        "list": [...],
        "total": 50,
        "page": 1,
        "size": 20,
        "took": 15 // 搜索耗时(ms)
    }
}
```

## 5. 业务逻辑

### 5.1 作品状态流转
```
草稿(1) -> 已发布(2) -> 已删除(3)
   ↑         ↓
   ←---------←
```

### 5.2 权限验证
- 作品所有者拥有所有权限
- 协作者根据权限等级进行操作
- 公开作品所有人可查看
- 私有作品仅所有者和协作者可查看

### 5.3 版本管理
- 每次保存自动创建版本
- 保留最近100个版本
- 支持版本对比和回滚

## 6. 搜索实现

### 6.1 全文搜索
- 使用Elasticsearch进行全文搜索
- 支持中文分词
- 搜索结果高亮显示

### 6.2 搜索索引
```json
{
    "mappings": {
        "properties": {
            "id": {"type": "long"},
            "title": {
                "type": "text",
                "analyzer": "ik_max_word",
                "search_analyzer": "ik_smart"
            },
            "content": {
                "type": "text",
                "analyzer": "ik_max_word",
                "search_analyzer": "ik_smart"
            },
            "tags": {"type": "keyword"},
            "category_id": {"type": "long"},
            "author": {"type": "keyword"},
            "status": {"type": "integer"},
            "visibility": {"type": "integer"},
            "created_at": {"type": "date"},
            "updated_at": {"type": "date"}
        }
    }
}
```

## 7. 性能优化

### 7.1 缓存策略
- 热门作品缓存
- 分类信息缓存
- 搜索结果缓存

### 7.2 数据库优化
- 合理设计索引
- 分页查询优化
- 读写分离

### 7.3 文件存储
- 大文件分块存储
- CDN加速
- 图片压缩

## 8. 监控指标

### 8.1 业务指标
- 作品创建数量
- 作品发布数量
- 搜索请求数量
- 用户活跃度

### 8.2 技术指标
- API响应时间
- 搜索响应时间
- 数据库查询性能
- 缓存命中率