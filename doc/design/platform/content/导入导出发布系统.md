# 导入导出发布系统设计文档

## 1. 概述

### 1.1 项目背景

导入、导出与发布是创作者内容管理的重要环节。青羽写作平台提供完整的内容流转功能：支持从多种格式导入现有作品，提供强大的导出功能将作品以多种格式交付，以及便捷的发布功能帮助用户分享作品。

### 1.2 设计目标

- **多格式导入**：支持从txt, PDF, Word, Markdown等多种格式导入现有作品
- **智能解析**：自动识别文档结构，提取章节、标题等元信息
- **多格式导出**：支持导出为txt, PDF, Word, Markdown, ePub等多种格式
- **高质量排版**：保证导出文件的排版质量和阅读体验
- **便捷发布**：支持快速发布到平台内的公开空间
- **异步处理**：对于大型文档的导入导出，采用异步任务处理，避免阻塞用户界面
- **模板化**：支持用户自定义导出模板

## 2. 技术架构

### 2.1 整体架构

```plaintext
┌─────────────────┐
│   Frontend      │ ← 导入导出发布界面
├─────────────────┤
│   Router        │ ← 路由层：/api/v1/import/*, /api/v1/export/*, /api/v1/publish/*
├─────────────────┤
│   API Layer     │ ← 导入导出发布任务接口
├─────────────────┤
│   Task Queue    │ ← 异步任务队列 (e.g., RabbitMQ)
├─────────────────┤
│   Import Worker │ ← 导入任务处理器
│   Export Worker │ ← 导出任务处理器
│   Publish Worker│ ← 发布任务处理器
├─────────────────┤
│   File Storage  │ ← 文件存储 (e.g., S3)
└─────────────────┘
```

### 2.2 模块划分

- **Frontend**：用户交互界面，展示导入导出发布选项和任务状态
- **Router**：路由层，处理导入导出发布任务的API请求
- **Import API**：接收导入请求，创建导入任务
- **Export API**：接收导出请求，创建导出任务
- **Publish API**：接收发布请求，创建发布任务
- **Task Queue**：管理任务队列，实现异步处理
- **Import Worker**：执行具体的导入操作，如文件解析、格式转换等
- **Export Worker**：执行具体的导出操作，如格式转换、排版等
- **Publish Worker**：执行具体的发布操作
- **Template Engine**：管理和应用导出模板
- **Parser Engine**：负责解析各种格式的导入文件

## 3. 功能设计

### 3.1 导入功能

- **文件上传**：支持用户上传多种格式的文档文件
- **格式识别**：自动识别文件格式并选择相应的解析器
- **内容解析**：提取文档内容、结构信息（章节、标题等）
- **预览确认**：用户可以预览解析结果并进行调整
- **项目创建**：将导入的内容创建为新的写作项目

### 3.2 导出功能

- **格式选择**：提供多种导出格式选项
- **模板选择**：允许用户选择或自定义导出模板
- **任务管理**：用户可以查看导出任务的状态和历史记录

### 3.3 发布功能

- **内容发布**：将作品发布到平台内的公开空间
- **发布设置**：设置发布权限、分类等信息
- **发布记录**：记录发布历史和状态

## 4. 数据模型

### 4.1 导入任务模型
```go
type ImportTask struct {
    ID         string    `bson:"_id,omitempty" json:"id"`
    UserID     string    `bson:"user_id" json:"userId"`
    FileName   string    `bson:"file_name" json:"fileName"`
    FileType   string    `bson:"file_type" json:"fileType"`
    FileSize   int64     `bson:"file_size" json:"fileSize"`
    FileURL    string    `bson:"file_url" json:"fileUrl"`
    Status     string    `bson:"status" json:"status"`
    ProjectID  string    `bson:"project_id,omitempty" json:"projectId,omitempty"`
    ErrorMsg   string    `bson:"error_msg,omitempty" json:"errorMsg,omitempty"`
    CreatedAt  time.Time `bson:"created_at" json:"createdAt"`
    UpdatedAt  time.Time `bson:"updated_at" json:"updatedAt"`
}
```

### 4.2 导出任务模型
```go
type ExportTask struct {
    ID         string    `bson:"_id,omitempty" json:"id"`
    UserID     string    `bson:"user_id" json:"userId"`
    DocumentID string    `bson:"document_id" json:"documentId"`
    Format     string    `bson:"format" json:"format"`
    Template   string    `bson:"template,omitempty" json:"template,omitempty"`
    Status     string    `bson:"status" json:"status"`
    FileURL    string    `bson:"file_url" json:"fileUrl"`
    ErrorMsg   string    `bson:"error_msg,omitempty" json:"errorMsg,omitempty"`
    CreatedAt  time.Time `bson:"created_at" json:"createdAt"`
    UpdatedAt  time.Time `bson:"updated_at" json:"updatedAt"`
}
```

### 4.3 发布任务模型
```go
type PublishTask struct {
    ID         string    `bson:"_id,omitempty" json:"id"`
    UserID     string    `bson:"user_id" json:"userId"`
    DocumentID string    `bson:"document_id" json:"documentId"`
    Title      string    `bson:"title" json:"title"`
    Category   string    `bson:"category,omitempty" json:"category,omitempty"`
    IsPublic   bool      `bson:"is_public" json:"isPublic"`
    Status     string    `bson:"status" json:"status"`
    PublishURL string    `bson:"publish_url,omitempty" json:"publishUrl,omitempty"`
    ErrorMsg   string    `bson:"error_msg,omitempty" json:"errorMsg,omitempty"`
    CreatedAt  time.Time `bson:"created_at" json:"createdAt"`
    UpdatedAt  time.Time `bson:"updated_at" json:"updatedAt"`
}
```

## 5. 接口设计

### 5.1 导入接口

#### POST /api/v1/import
- **功能**：创建导入任务
- **请求**：`multipart/form-data` 包含文件
- **响应**：`{ "taskId": "...", "status": "pending" }`

#### GET /api/v1/import/:taskId
- **功能**：查询导入任务状态
- **请求**：`{}`
- **响应**：`{ "status": "...", "projectId": "...", "errorMsg": "..." }`

#### GET /api/v1/import/:taskId/preview
- **功能**：预览导入内容
- **请求**：`{}`
- **响应**：`{ "content": "...", "structure": [...] }`

### 5.2 导出接口

#### POST /api/v1/export
- **功能**：创建导出任务
- **请求**：`{ "documentId": "...", "format": "pdf", "template": "..." }`
- **响应**：`{ "taskId": "...", "status": "pending" }`

#### GET /api/v1/export/:taskId
- **功能**：查询导出任务状态
- **请求**：`{}`
- **响应**：`{ "status": "...", "fileUrl": "...", "errorMsg": "..." }`

### 5.3 发布接口

#### POST /api/v1/publish
- **功能**：创建发布任务
- **请求**：`{ "documentId": "...", "title": "...", "category": "...", "isPublic": true }`
- **响应**：`{ "taskId": "...", "status": "pending" }`

#### GET /api/v1/publish/:taskId
- **功能**：查询发布任务状态
- **请求**：`{}`
- **响应**：`{ "status": "...", "publishUrl": "...", "errorMsg": "..." }`