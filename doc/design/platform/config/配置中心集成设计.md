# 配置中心集成设计

> **文档版本**: v1.0  
> **创建时间**: 2025-10-21

## 📋 文档概述

本文档设计配置中心集成方案，支持Prompt模板管理和AI配置热更新。

---

## 一、配置中心选型

### 1.1 方案对比

| 配置中心 | 优势 | 劣势 | 推荐度 |
|---------|------|------|--------|
| **Apollo** | 功能完善、界面友好、权限管理 | 较重 | ⭐⭐⭐⭐⭐ |
| **Consul** | 轻量、服务发现集成 | 功能相对简单 | ⭐⭐⭐⭐ |
| **Nacos** | 阿里系、国内文档好 | 生态相对小 | ⭐⭐⭐⭐ |

**推荐**：Apollo（功能最完善）

---

## 二、Prompt模板管理

### 2.1 模板存储结构

```yaml
# Apollo配置示例
prompts:
  creative_writing:
    continue_writing: |
      你是一位专业的写作助手。请根据以下信息继续创作：
      
      角色信息：
      {{characters}}
      
      世界观设定：
      {{settings}}
      
      前文内容：
      {{previous_content}}
      
      请继续创作，保持风格一致。
    
    dialogue_generation: |
      请为以下角色生成对话：
      
      角色A：{{character_a}}
      角色B：{{character_b}}
      
      场景：{{scene}}
      冲突：{{conflict}}
      
  analysis:
    style_analysis: |
      请分析以下文本的写作风格：
      
      {{text}}
      
      分析维度：文风、节奏、情感、语言特点
```

### 2.2 Go Template引擎集成

```go
package prompt

import (
    "bytes"
    "text/template"
)

type PromptTemplate struct {
    Name     string
    Template *template.Template
}

type PromptManager struct {
    templates map[string]*PromptTemplate
    apollo    *apollo.Client
}

func (pm *PromptManager) RenderPrompt(name string, data map[string]interface{}) (string, error) {
    tmpl, exists := pm.templates[name]
    if !exists {
        return "", fmt.Errorf("模板不存在: %s", name)
    }
    
    var buf bytes.Buffer
    if err := tmpl.Template.Execute(&buf, data); err != nil {
        return "", err
    }
    
    return buf.String(), nil
}

func (pm *PromptManager) LoadFromApollo() error {
    // 从Apollo加载模板
    config := pm.apollo.GetConfig("prompts")
    
    for name, content := range config {
        tmpl, err := template.New(name).Parse(content)
        if err != nil {
            return err
        }
        
        pm.templates[name] = &PromptTemplate{
            Name:     name,
            Template: tmpl,
        }
    }
    
    return nil
}

// 监听配置变化
func (pm *PromptManager) WatchConfigChanges() {
    pm.apollo.OnChange(func(event *apollo.ChangeEvent) {
        log.Info("Prompt模板更新", "namespace", event.Namespace)
        pm.LoadFromApollo()
    })
}
```

---

## 三、AI配置热更新

### 3.1 配置结构

```yaml
ai:
  models:
    gpt-4:
      temperature: 0.7
      max_tokens: 2000
      top_p: 0.9
    gpt-3.5-turbo:
      temperature: 0.8
      max_tokens: 1500
  
  routing:
    creative_writing: gpt-4
    dialogue: gpt-3.5-turbo
    analysis: gpt-4
  
  quotas:
    default_daily_limit: 10000
    vip_daily_limit: 50000
```

### 3.2 配置监听

```go
type AIConfigManager struct {
    config *AIConfig
    mu     sync.RWMutex
    apollo *apollo.Client
}

func (acm *AIConfigManager) GetModelConfig(model string) *ModelConfig {
    acm.mu.RLock()
    defer acm.mu.RUnlock()
    
    return acm.config.Models[model]
}

func (acm *AIConfigManager) WatchChanges() {
    acm.apollo.OnChange(func(event *apollo.ChangeEvent) {
        newConfig, err := parseAIConfig(event.NewValue)
        if err != nil {
            log.Error("解析配置失败", "error", err)
            return
        }
        
        acm.mu.Lock()
        acm.config = newConfig
        acm.mu.Unlock()
        
        log.Info("AI配置已更新")
    })
}
```

---

**文档版本**: v1.0  
**创建时间**: 2025-10-21

