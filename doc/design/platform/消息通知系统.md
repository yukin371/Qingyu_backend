# 消息通知系统设计文档

## 1. 概述

### 1.1 项目背景
消息通知系统是保持用户与平台、用户与用户之间信息同步的关键。该系统负责在特定事件发生时，向相关用户发送通知，如协作邀请、评论提醒、任务更新等。

### 1.2 设计目标
- **实时性**：保证通知的及时送达
- **多渠道**：支持站内信、邮件、Push等多种通知渠道
- **可靠性**：保证通知不丢失，支持重试机制
- **可配置**：允许用户自定义接收通知的类型和渠道
- **高吞吐**：能够处理大规模的通知发送请求

## 2. 技术架构

### 2.1 整体架构
```
┌─────────────────┐
│   Event Source  │ ← 触发通知的事件源 (e.g., 评论、@提及)
├─────────────────┤
│   Notification Service │ ← 统一的通知服务
├─────────────────┤
│   Message Queue │ ← 消息队列 (e.g., RabbitMQ)
├─────────────────┤
│   Dispatcher    │ ← 消息分发器
├─────────────────┤
│   Channel       │ ← 通知渠道 (e.g., WebSocket, Email, Push)
└─────────────────┘
```

### 2.2 模块划分
- **Notification API**：提供发送通知的接口
- **Message Queue**：作为通知任务的缓冲池
- **Dispatcher**：根据用户配置和通知类型，将消息分发到不同渠道
- **Channel Handlers**：负责与具体的通知渠道（如邮件服务、推送服务）对接

## 3. 功能设计

### 3.1 通知类型
- **系统通知**：平台公告、功能更新等
- **协作通知**：@提及、评论回复、文档分享等
- **任务通知**：任务截止日期提醒、状态变更等

### 3.2 用户配置
- **渠道选择**：用户可以选择接收通知的渠道
- **类型订阅**：用户可以订阅或退订特定类型的通知

## 4. 数据模型

### 4.1 通知模型
```go
type Notification struct {
    ID        string    `bson:"_id,omitempty" json:"id"`
    UserID    string    `bson:"user_id" json:"userId"`
    Type      string    `bson:"type" json:"type"`
    Content   string    `bson:"content" json:"content"`
    IsRead    bool      `bson:"is_read" json:"isRead"`
    CreatedAt time.Time `bson:"created_at" json:"createdAt"`
}
```

## 5. 接口设计

### 5.1 POST /api/v1/notifications
- **功能**：发送通知（内部接口）
- **请求**：`{ "userId": "...", "type": "...", "content": "..." }`

### 5.2 GET /api/v1/notifications
- **功能**：获取用户通知列表
- **请求**：`{}`
- **响应**：`{ "notifications": [ ... ] }`