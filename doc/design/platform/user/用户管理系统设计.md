# 用户管理系统设计文档

## 1. 概述

### 1.1 功能描述
用户管理系统负责处理用户的注册、登录、个人信息管理、权限控制等核心功能，是整个平台的基础服务。

### 1.2 设计原则
- **安全性**：密码加密存储，防止数据泄露
- **易用性**：简化注册流程，提供友好的用户体验
- **扩展性**：支持多种登录方式，便于后续功能扩展
- **合规性**：符合数据保护法规要求

## 2. 功能模块

### 2.1 用户注册
- 邮箱注册验证
- 用户名唯一性检查
- 密码强度验证
- 验证码机制

### 2.2 用户登录
- 用户名/邮箱登录
- 密码验证
- JWT令牌生成
- 登录状态保持

### 2.3 个人信息管理
- 基本信息编辑
- 头像上传
- 密码修改
- 账号注销

### 2.4 权限管理
- 角色定义
- 权限分配
- 访问控制

## 3. 数据模型

### 3.1 用户实体
```go
type User struct {
    ID           uint64    `json:"id" gorm:"primaryKey"`
    Username     string    `json:"username" gorm:"uniqueIndex;size:50"`
    Email        string    `json:"email" gorm:"uniqueIndex;size:100"`
    PasswordHash string    `json:"-" gorm:"size:255"`
    Nickname     string    `json:"nickname" gorm:"size:100"`
    AvatarURL    string    `json:"avatar_url" gorm:"size:255"`
    Bio          string    `json:"bio" gorm:"type:text"`
    Status       int8      `json:"status" gorm:"default:1"`
    CreatedAt    time.Time `json:"created_at"`
    UpdatedAt    time.Time `json:"updated_at"`
}
```

### 3.2 用户角色
```go
type Role struct {
    ID          uint64    `json:"id" gorm:"primaryKey"`
    Name        string    `json:"name" gorm:"size:50"`
    Description string    `json:"description" gorm:"type:text"`
    Permissions string    `json:"permissions" gorm:"type:json"`
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
}

type UserRole struct {
    UserID uint64 `json:"user_id"`
    RoleID uint64 `json:"role_id"`
}
```

## 4. API 接口

### 4.1 注册接口
```
POST /api/v1/auth/register
Content-Type: application/json

{
    "username": "string",
    "email": "string",
    "password": "string",
    "nickname": "string"
}

Response:
{
    "code": 200,
    "message": "注册成功",
    "data": {
        "user_id": 123,
        "username": "testuser"
    }
}
```

### 4.2 登录接口
```
POST /api/v1/auth/login
Content-Type: application/json

{
    "username": "string", // 用户名或邮箱
    "password": "string"
}

Response:
{
    "code": 200,
    "message": "登录成功",
    "data": {
        "token": "jwt_token_string",
        "expires_at": "2024-01-01T00:00:00Z",
        "user": {
            "id": 123,
            "username": "testuser",
            "nickname": "测试用户",
            "avatar_url": "https://example.com/avatar.jpg"
        }
    }
}
```

### 4.3 获取用户信息
```
GET /api/v1/user/profile
Authorization: Bearer {token}

Response:
{
    "code": 200,
    "message": "获取成功",
    "data": {
        "id": 123,
        "username": "testuser",
        "email": "test@example.com",
        "nickname": "测试用户",
        "avatar_url": "https://example.com/avatar.jpg",
        "bio": "这是个人简介",
        "created_at": "2024-01-01T00:00:00Z"
    }
}
```

### 4.4 更新用户信息
```
PUT /api/v1/user/profile
Authorization: Bearer {token}
Content-Type: application/json

{
    "nickname": "string",
    "bio": "string",
    "avatar_url": "string"
}

Response:
{
    "code": 200,
    "message": "更新成功"
}
```

## 5. 安全机制

### 5.1 密码安全
- 使用bcrypt算法加密密码
- 密码强度要求：至少8位，包含字母和数字
- 防止密码暴力破解

### 5.2 JWT令牌
- 令牌有效期24小时
- 包含用户ID、角色等信息
- 支持令牌刷新机制

### 5.3 访问控制
- 基于中间件的权限验证
- 接口级别的权限控制
- 资源级别的访问控制

## 6. 错误处理

### 6.1 错误码定义
- 1001: 用户名已存在
- 1002: 邮箱已存在
- 1003: 密码格式错误
- 1004: 用户不存在
- 1005: 密码错误
- 1006: 令牌无效
- 1007: 令牌过期

### 6.2 错误响应格式
```json
{
    "code": 1001,
    "message": "用户名已存在",
    "data": null
}
```

## 7. 性能优化

### 7.1 缓存策略
- 用户信息缓存（Redis）
- 权限信息缓存
- 登录状态缓存

### 7.2 数据库优化
- 用户名和邮箱建立唯一索引
- 查询优化
- 连接池管理

## 8. 测试方案

### 8.1 单元测试
- 用户注册逻辑测试
- 密码验证测试
- JWT令牌测试

### 8.2 集成测试
- API接口测试
- 数据库操作测试
- 权限验证测试

### 8.3 性能测试
- 并发登录测试
- 大量用户注册测试
- 接口响应时间测试