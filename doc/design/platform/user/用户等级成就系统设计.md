# 用户等级成就系统设计

> **文档版本**: v1.0  
> **创建时间**: 2025-10-21

## 📋 文档概述

本文档设计用户等级和成就系统，包括等级体系、经验值管理、成就解锁和特权系统。

---

## 一、等级体系设计

### 1.1 等级配置

| 等级 | 所需经验值 | 特权 |
|------|-----------|------|
| 1 | 0 | 基础功能 |
| 2 | 100 | 每日任务+2 |
| 3 | 300 | AI对话+50次/日 |
| 5 | 1000 | 自定义头像 |
| 10 | 5000 | 优先客服 |
| 20 | 20000 | 高级模板 |

### 1.2 数据模型

```go
type UserLevel struct {
    ID           string `bson:"_id" json:"id"`
    UserID       string `bson:"user_id" json:"userId"`
    Level        int    `bson:"level" json:"level"`
    Experience   int    `bson:"experience" json:"experience"` // 当前经验值
    NextLevelExp int    `bson:"next_level_exp" json:"nextLevelExp"`
    Achievements []string `bson:"achievements" json:"achievements"`
}

type Achievement struct {
    ID          string `bson:"_id" json:"id"`
    Title       string `bson:"title" json:"title"`
    Description string `bson:"description" json:"description"`
    Icon        string `bson:"icon" json:"icon"`
    Type        string `bson:"type" json:"type"` // reading, writing, social
    Condition   string `bson:"condition" json:"condition"` // JSON条件
    RewardExp   int    `bson:"reward_exp" json:"rewardExp"`
}
```

---

## 二、Service接口

```go
type UserLevelService interface {
    // 经验值管理（唯一数据源）
    AddExperience(ctx context.Context, userID string, exp int, reason string) error
    GetExperience(ctx context.Context, userID string) (int, error)
    
    // 升级检查
    CheckLevelUp(ctx context.Context, userID string) (bool, *UserLevel, error)
    
    // 成就管理
    UnlockAchievement(ctx context.Context, userID, achievementID string) error
    CheckAchievements(ctx context.Context, userID string) error
    
    // 事件处理
    OnTaskCompleted(ctx context.Context, event *TaskCompletedEvent) error
}
```

---

## 三、事件处理

```go
func (s *UserLevelServiceImpl) OnTaskCompleted(ctx context.Context, event *TaskCompletedEvent) error {
    // 增加经验值
    if err := s.AddExperience(ctx, event.UserID, event.RewardExp, fmt.Sprintf("task_%s", event.TaskID)); err != nil {
        return err
    }
    
    // 检查升级
    levelUp, newLevel, _ := s.CheckLevelUp(ctx, event.UserID)
    
    if levelUp {
        s.eventBus.PublishAsync(ctx, &UserLevelUpEvent{
            UserID:   event.UserID,
            NewLevel: newLevel.Level,
        })
    }
    
    return nil
}
```

---

**文档版本**: v1.0  
**创建时间**: 2025-10-21

