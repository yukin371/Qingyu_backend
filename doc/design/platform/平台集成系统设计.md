# 青羽写作平台集成系统设计文档

## 1. 概述

### 1.1 项目背景
青羽写作平台需要集成用户管理、作品管理等核心功能，为用户提供完整的写作创作和分享平台。本文档描述了平台集成系统的整体架构和功能设计。

### 1.2 设计目标
- **用户体系**：完整的用户注册、登录、权限管理系统
- **作品管理**：支持作品上传、查看、分类、搜索等功能
- **多用户隔离**：确保不同用户的作品数据安全隔离
- **扩展性**：支持未来功能模块的快速集成
- **高性能**：支持大量用户并发访问

## 2. 技术架构

### 2.1 技术栈
- **后端**: Go + Gin框架
- **数据库**: MongoDB
- **缓存**: Redis
- **搜索**: Elasticsearch
- **前端**: Vue 3 + TypeScript
- **构建工具**: Vite

### 2.2 架构图

```plaintext
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端应用      │    │   API网关       │    │   用户服务      │
│   (Vue 3)       │◄──►│   (Gin)         │◄──►│   (Go)          │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                       ┌─────────────────┐    ┌─────────────────┐
                       │   作品服务      │    │   文件服务      │
                       │   (Go)          │    │   (Go)          │
                       └─────────────────┘    └─────────────────┘
                                │
                       ┌─────────────────┐
                       │  Repository层   │
                       │ - 用户仓储      │
                       │ - 作品仓储      │
                       │ - 文件仓储      │
                       │ - 分类仓储      │
                       └─────────────────┘
                                │
                       ┌─────────────────┐    ┌─────────────────┐
                       │   MongoDB       │    │   Redis缓存     │
                       │   文档数据库    │    │                 │
                       └─────────────────┘    └─────────────────┘
```

### 2.3 模块划分
- **用户模块 (User)**：用户注册、登录、个人信息管理
- **认证模块 (Auth)**：JWT令牌管理、权限验证
- **作品模块 (Work)**：作品CRUD操作、分类管理
- **文件模块 (File)**：文件上传、下载、存储管理
- **搜索模块 (Search)**：作品搜索、标签检索
- **Repository模块 (Repository)**：数据持久化、查询封装、事务管理

## 3. 数据库设计

### 3.1 MongoDB集合设计

#### 3.1.1 用户集合 (users)
```javascript
{
  _id: ObjectId,
  username: String,      // 用户名，唯一
  email: String,         // 邮箱，唯一
  password: String,      // 加密密码
  avatar: String,        // 头像URL
  bio: String,          // 个人简介
  status: String,       // 账户状态：active, inactive, banned
  created_at: Date,
  updated_at: Date
}
```

#### 3.1.2 作品集合 (works)
```javascript
{
  _id: ObjectId,
  title: String,        // 作品标题
  description: String,  // 作品描述
  author_id: ObjectId,  // 作者ID，引用users._id
  category_id: ObjectId, // 分类ID，引用categories._id
  content: String,      // 作品内容
  status: String,       // 状态：draft, published, archived
  tags: [String],       // 标签数组
  view_count: Number,   // 浏览次数
  like_count: Number,   // 点赞次数
  word_count: Number,   // 字数统计
  created_at: Date,
  updated_at: Date,
  published_at: Date    // 发布时间
}
```

#### 3.1.3 分类集合 (categories)
```javascript
{
  _id: ObjectId,
  name: String,         // 分类名称
  description: String,  // 分类描述
  parent_id: ObjectId,  // 父分类ID，支持层级分类
  sort_order: Number,   // 排序权重
  created_at: Date,
  updated_at: Date
}
```

### 3.2 索引策略
```javascript
// 用户集合索引
db.users.createIndex({"username": 1}, {unique: true})
db.users.createIndex({"email": 1}, {unique: true})
db.users.createIndex({"created_at": -1})

// 作品集合索引
db.works.createIndex({"author_id": 1, "status": 1})
db.works.createIndex({"category_id": 1, "status": 1})
db.works.createIndex({"status": 1, "published_at": -1})
db.works.createIndex({"tags": 1})
db.works.createIndex({"title": "text", "description": "text", "content": "text"})

// 分类集合索引
db.categories.createIndex({"parent_id": 1})
db.categories.createIndex({"sort_order": 1})
```

## 4. API 接口设计

### 4.1 用户相关接口
- `POST /api/v1/auth/register` - 用户注册
- `POST /api/v1/auth/login` - 用户登录
- `POST /api/v1/auth/logout` - 用户登出
- `GET /api/v1/user/profile` - 获取用户信息
- `PUT /api/v1/user/profile` - 更新用户信息

### 4.2 作品相关接口
- `GET /api/v1/works` - 获取作品列表
- `POST /api/v1/works` - 创建作品
- `GET /api/v1/works/:id` - 获取作品详情
- `PUT /api/v1/works/:id` - 更新作品
- `DELETE /api/v1/works/:id` - 删除作品
- `GET /api/v1/works/search` - 搜索作品

### 4.3 文件相关接口
- `POST /api/v1/files/upload` - 文件上传
- `GET /api/v1/files/:id` - 文件下载
- `DELETE /api/v1/files/:id` - 删除文件

## 5. Repository层设计

### 5.1 Repository接口抽象
Repository层提供统一的数据访问接口，实现业务逻辑与数据存储的解耦：

```go
// 基础Repository接口
type BaseRepository interface {
    Create(ctx context.Context, entity interface{}) error
    GetByID(ctx context.Context, id string) (interface{}, error)
    Update(ctx context.Context, entity interface{}) error
    Delete(ctx context.Context, id string) error
}

// 用户Repository接口
type UserRepository interface {
    BaseRepository
    GetByUsername(ctx context.Context, username string) (*User, error)
    GetByEmail(ctx context.Context, email string) (*User, error)
    ListUsers(ctx context.Context, offset, limit int) ([]*User, error)
}

// 作品Repository接口
type WorkRepository interface {
    BaseRepository
    GetByAuthor(ctx context.Context, authorID string) ([]*Work, error)
    GetByCategory(ctx context.Context, categoryID string) ([]*Work, error)
    Search(ctx context.Context, query string) ([]*Work, error)
    UpdateViewCount(ctx context.Context, workID string) error
}
```

### 5.2 MongoDB实现
```go
type MongoUserRepository struct {
    collection *mongo.Collection
}

func (r *MongoUserRepository) Create(ctx context.Context, user *User) error {
    _, err := r.collection.InsertOne(ctx, user)
    return err
}

func (r *MongoUserRepository) GetByUsername(ctx context.Context, username string) (*User, error) {
    var user User
    err := r.collection.FindOne(ctx, bson.M{"username": username}).Decode(&user)
    return &user, err
}
```

### 5.3 事务管理
Repository层统一处理事务，确保数据一致性：

```go
type TransactionManager interface {
    WithTransaction(ctx context.Context, fn func(ctx context.Context) error) error
}

func (tm *MongoTransactionManager) WithTransaction(ctx context.Context, fn func(ctx context.Context) error) error {
    session, err := tm.client.StartSession()
    if err != nil {
        return err
    }
    defer session.EndSession(ctx)
    
    return mongo.WithSession(ctx, session, func(sc mongo.SessionContext) error {
        return session.WithTransaction(sc, func(sc mongo.SessionContext) (interface{}, error) {
            return nil, fn(sc)
        })
    })
}
```

## 6. 安全设计

### 6.1 认证机制
- 使用JWT令牌进行用户认证
- 令牌过期时间设置为24小时
- 支持刷新令牌机制

### 6.2 权限控制
- 基于角色的访问控制 (RBAC)
- 用户只能访问自己的作品
- 管理员可以管理所有用户和作品

### 6.3 数据安全
- 密码使用bcrypt加密存储
- 敏感数据传输使用HTTPS
- SQL注入防护
- XSS攻击防护

## 7. 性能优化

### 7.1 缓存策略
- Redis缓存用户会话信息
- 缓存热门作品数据
- 缓存分类和标签信息

### 7.2 数据库优化
- 合理设计索引
- 分页查询优化
- 读写分离

### 7.3 文件存储
- 支持本地存储和云存储
- 图片压缩和格式转换
- CDN加速

## 8. 部署方案

### 8.1 开发环境
- Docker容器化部署
- 本地MySQL数据库
- 本地Redis缓存

### 8.2 生产环境
- Kubernetes集群部署
- 云数据库服务
- 云存储服务
- 负载均衡

## 9. 监控和日志

### 9.1 监控指标
- API响应时间
- 数据库连接数
- 内存使用率
- 错误率统计

### 9.2 日志管理
- 结构化日志输出
- 日志分级管理
- 日志聚合和分析