# ä¹¦åŸä»“å‚¨å±‚å®ç°æ£€æµ‹æŠ¥å‘Š

## æ£€æµ‹æ—¶é—´
2025-09-30

## æ£€æµ‹èŒƒå›´
- `repository/interfaces/bookstore/BookStoreRepository_interface.go` - æ¥å£å®šä¹‰
- `repository/mongodb/bookstore/bookstore_repository_mongo.go` - MongoDB å®ç°

## æ£€æµ‹ç»“æœ

### âœ… å·²å®Œæˆå®ç°çš„æ¥å£æ–¹æ³•

#### åŸºç¡€ CRUD æ¥å£ (ç»§æ‰¿è‡ª `base.CRUDRepository`)
- [x] `Create(ctx context.Context, entity *Book) error`
- [x] `GetByID(ctx context.Context, id primitive.ObjectID) (*Book, error)`
- [x] `Update(ctx context.Context, id primitive.ObjectID, updates map[string]interface{}) error`
- [x] `Delete(ctx context.Context, id primitive.ObjectID) error`
- [x] `List(ctx context.Context, filter Filter) ([]*Book, error)`
- [x] `Count(ctx context.Context, filter Filter) (int64, error)`
- [x] `Exists(ctx context.Context, id primitive.ObjectID) (bool, error)`

#### å¥åº·æ£€æŸ¥æ¥å£ (ç»§æ‰¿è‡ª `base.HealthRepository`)
- [x] `Health(ctx context.Context) error`

#### åˆ—è¡¨æŸ¥è¯¢æ–¹æ³•
- [x] `GetByCategory(ctx context.Context, categoryID primitive.ObjectID, limit, offset int) ([]*Book, error)`
- [x] `GetByAuthor(ctx context.Context, author string, limit, offset int) ([]*Book, error)`
- [x] `GetByAuthorID(ctx context.Context, authorID primitive.ObjectID, limit, offset int) ([]*Book, error)`
- [x] `GetByStatus(ctx context.Context, status BookStatus, limit, offset int) ([]*Book, error)`
- [x] `GetRecommended(ctx context.Context, limit, offset int) ([]*Book, error)`
- [x] `GetFeatured(ctx context.Context, limit, offset int) ([]*Book, error)`
- [x] `GetHotBooks(ctx context.Context, limit, offset int) ([]*Book, error)`
- [x] `GetNewReleases(ctx context.Context, limit, offset int) ([]*Book, error)`
- [x] `GetFreeBooks(ctx context.Context, limit, offset int) ([]*Book, error)`
- [x] `GetByPriceRange(ctx context.Context, minPrice, maxPrice float64, limit, offset int) ([]*Book, error)`

#### æœç´¢æ–¹æ³•
- [x] `Search(ctx context.Context, keyword string, limit, offset int) ([]*Book, error)`
- [x] `SearchWithFilter(ctx context.Context, filter *BookFilter) ([]*Book, error)`

#### ç»Ÿè®¡æ–¹æ³•
- [x] `CountByCategory(ctx context.Context, categoryID primitive.ObjectID) (int64, error)`
- [x] `CountByAuthor(ctx context.Context, author string) (int64, error)`
- [x] `CountByStatus(ctx context.Context, status BookStatus) (int64, error)`
- [x] `CountByFilter(ctx context.Context, filter *BookFilter) (int64, error)`

#### æ‰¹é‡æ“ä½œæ–¹æ³•
- [x] `BatchUpdateStatus(ctx context.Context, bookIDs []primitive.ObjectID, status BookStatus) error`
- [x] `BatchUpdateCategory(ctx context.Context, bookIDs []primitive.ObjectID, categoryIDs []primitive.ObjectID) error`
- [x] `BatchUpdateRecommended(ctx context.Context, bookIDs []primitive.ObjectID, isRecommended bool) error`
- [x] `BatchUpdateFeatured(ctx context.Context, bookIDs []primitive.ObjectID, isFeatured bool) error`

#### äº‹åŠ¡æ”¯æŒ
- [x] `Transaction(ctx context.Context, fn func(ctx context.Context) error) error`

### ğŸ“ é¢å¤–å®ç°çš„æ–¹æ³•ï¼ˆè¶…å‡ºæ¥å£è¦æ±‚ï¼‰

ä»¥ä¸‹æ–¹æ³•è™½ç„¶ä¸åœ¨æ¥å£å®šä¹‰ä¸­ï¼Œä½†åœ¨ MongoDB å®ç°ä¸­æä¾›ï¼Œç”¨äºå†…éƒ¨ä½¿ç”¨æˆ–æ‰©å±•åŠŸèƒ½ï¼š

1. **`SearchWithPagination`** - å¸¦åˆ†é¡µå’Œè¿‡æ»¤çš„æœç´¢ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰
   ```go
   func (r *MongoBookRepository) SearchWithPagination(ctx context.Context, keyword string, filter *bookstore.BookFilter, page, pageSize int) ([]*bookstore.Book, int64, error)
   ```

2. **ç»Ÿè®¡ç›¸å…³**
   - `GetStats(ctx context.Context) (*BookStats, error)` - è·å–ä¹¦ç±ç»Ÿè®¡ä¿¡æ¯
   - `IncrementViewCount(ctx context.Context, bookID primitive.ObjectID) error` - å¢åŠ æµè§ˆé‡
   - `IncrementLikeCount(ctx context.Context, bookID primitive.ObjectID) error` - å¢åŠ ç‚¹èµæ•°
   - `IncrementCommentCount(ctx context.Context, bookID primitive.ObjectID) error` - å¢åŠ è¯„è®ºæ•°
   - `UpdateRating(ctx context.Context, bookID primitive.ObjectID, rating float64) error` - æ›´æ–°è¯„åˆ†

3. **å…¶ä»–è¾…åŠ©æ–¹æ³•**
   - `GetByTitle(ctx context.Context, title string) (*Book, error)` - æ ¹æ®æ ‡é¢˜è·å–ä¹¦ç±

## ä¿®å¤å†…å®¹

### 1. Search æ–¹æ³•ç­¾åä¿®æ­£
**åŸç­¾åï¼š**
```go
Search(ctx context.Context, keyword string, filter *bookstore.BookFilter, page, pageSize int) ([]*bookstore.Book, int64, error)
```

**ä¿®æ­£åï¼š**
```go
Search(ctx context.Context, keyword string, limit, offset int) ([]*bookstore.Book, error)
```

**è¯´æ˜ï¼š** ä¸ºäº†ç¬¦åˆæ¥å£å®šä¹‰ï¼Œå°†å¤æ‚çš„æœç´¢é€»è¾‘æ‹†åˆ†ä¸ºä¸¤ä¸ªæ–¹æ³•ï¼š
- `Search` - ç®€åŒ–ç‰ˆæœ¬ï¼Œç¬¦åˆæ¥å£å®šä¹‰
- `SearchWithPagination` - å¸¦åˆ†é¡µå’Œè¿‡æ»¤çš„å®Œæ•´ç‰ˆæœ¬ï¼Œä¾›å†…éƒ¨ä½¿ç”¨

### 2. æ·»åŠ åŸºç¡€æ¥å£æ–¹æ³•å®ç°
- å®ç°äº† `List` æ–¹æ³•ï¼Œæ”¯æŒåŸºäº `Filter` çš„æŸ¥è¯¢
- å®ç°äº† `Count` æ–¹æ³•ï¼Œæ”¯æŒåŸºäº `Filter` çš„è®¡æ•°
- å®ç°äº† `Exists` æ–¹æ³•ï¼Œåˆ¤æ–­ä¹¦ç±æ˜¯å¦å­˜åœ¨

### 3. æ–°å¢æ–¹æ³•å®ç°
- `GetByAuthorID` - æ ¹æ®ä½œè€… ID è·å–ä¹¦ç±
- `GetHotBooks` - è·å–çƒ­é—¨ä¹¦ç±
- `GetNewReleases` - è·å–æ–°ä¸Šæ¶ä¹¦ç±
- `GetFreeBooks` - è·å–å…è´¹ä¹¦ç±
- `GetByPriceRange` - æŒ‰ä»·æ ¼åŒºé—´è·å–ä¹¦ç±
- `CountByFilter` - æ ¹æ®è¿‡æ»¤å™¨ç»Ÿè®¡
- `BatchUpdateFeatured` - æ‰¹é‡æ›´æ–°ç²¾é€‰çŠ¶æ€
- `BatchUpdateRecommended` - æ‰¹é‡æ›´æ–°æ¨èçŠ¶æ€

## ç¼–è¯‘çŠ¶æ€

### âœ… ä»“å‚¨å±‚ç¼–è¯‘çŠ¶æ€
```bash
go build -v ./repository/mongodb/bookstore/...
# ç¼–è¯‘é€šè¿‡ï¼Œæ— é”™è¯¯
```

### âš ï¸ Service å±‚å¾…ä¿®å¤é—®é¢˜

è™½ç„¶ä»“å‚¨å±‚å·²å®Œå…¨å®ç°å¹¶é€šè¿‡ç¼–è¯‘ï¼Œä½† Service å±‚å­˜åœ¨ä¸€äº›è°ƒç”¨ä¸åŒ¹é…çš„é—®é¢˜ï¼š

1. **BookDetailService**
   - ç¼ºå°‘ `DecrementCommentCount` æ–¹æ³•
   - `BatchUpdateCategories` å‚æ•°ä¸åŒ¹é…

2. **BookstoreService**
   - ç¼ºå°‘ `GetFreeBooks` æ–¹æ³•
   - `Search` æ–¹æ³•è°ƒç”¨å‚æ•°ä¸åŒ¹é…
   - ä½¿ç”¨äº†æœªå®šä¹‰çš„ `GetStats` å’Œ `IncrementViewCount` æ–¹æ³•

è¿™äº›é—®é¢˜éœ€è¦åœ¨ Service å±‚è¿›è¡Œç›¸åº”çš„ä¿®å¤ã€‚

## å»ºè®®

### 1. æ¥å£è®¾è®¡å»ºè®®

å½“å‰ `BookRepository` æ¥å£æä¾›äº†åŸºç¡€çš„åˆ—è¡¨å’Œæœç´¢åŠŸèƒ½ï¼Œä½†ä¸€äº›å¸¸ç”¨çš„ç»Ÿè®¡å’Œè®¡æ•°æ–¹æ³•ï¼ˆå¦‚ `GetStats`ã€`IncrementViewCount`ï¼‰æœªåŒ…å«åœ¨æ¥å£ä¸­ã€‚å»ºè®®ï¼š

**é€‰é¡¹ Aï¼š** å°†è¿™äº›æ–¹æ³•æ·»åŠ åˆ°æ¥å£å®šä¹‰ä¸­
```go
type BookRepository interface {
    // ... ç°æœ‰æ–¹æ³•
    
    // ç»Ÿè®¡å’Œè®¡æ•°æ–¹æ³•
    GetStats(ctx context.Context) (*bookstore.BookStats, error)
    IncrementViewCount(ctx context.Context, bookID primitive.ObjectID) error
    IncrementLikeCount(ctx context.Context, bookID primitive.ObjectID) error
    IncrementCommentCount(ctx context.Context, bookID primitive.ObjectID) error
}
```

**é€‰é¡¹ Bï¼š** åˆ›å»ºç‹¬ç«‹çš„ç»Ÿè®¡æ¥å£
```go
type BookStatisticsRepository interface {
    GetStats(ctx context.Context) (*bookstore.BookStats, error)
    IncrementViewCount(ctx context.Context, bookID primitive.ObjectID) error
    IncrementLikeCount(ctx context.Context, bookID primitive.ObjectID) error
    IncrementCommentCount(ctx context.Context, bookID primitive.ObjectID) error
}
```

### 2. ä»£ç ç»„ç»‡å»ºè®®

- å°†é¢å¤–çš„è¾…åŠ©æ–¹æ³•ï¼ˆå¦‚ `GetByTitle`ï¼‰ç§»åˆ°ä¸“é—¨çš„æ‰©å±•æ¥å£ä¸­
- è€ƒè™‘ä½¿ç”¨ç»„åˆæ¨¡å¼ï¼Œå°†ä¸åŒèŒè´£çš„æ–¹æ³•åˆ†ç¦»åˆ°ä¸åŒçš„æ¥å£ä¸­
- ä¸ºå¤æ‚çš„æŸ¥è¯¢åœºæ™¯ï¼ˆå¦‚ `SearchWithPagination`ï¼‰åˆ›å»ºä¸“é—¨çš„æ¥å£æ–¹æ³•

### 3. æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**
   - ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µï¼ˆ`category_ids`ã€`author_id`ã€`status`ã€`is_recommended`ã€`is_featured`ï¼‰åˆ›å»ºç´¢å¼•
   - ä¸ºå…¨æ–‡æœç´¢å­—æ®µï¼ˆ`title`ã€`author`ã€`introduction`ï¼‰åˆ›å»ºæ–‡æœ¬ç´¢å¼•

2. **æŸ¥è¯¢ä¼˜åŒ–**
   - åœ¨ `GetHotBooks` ä¸­ä½¿ç”¨å¤åˆç´¢å¼• `{view_count: -1, rating: -1}`
   - åœ¨ `GetRecommended` å’Œ `GetFeatured` ä¸­æ·»åŠ  `status` è¿‡æ»¤ï¼Œé¿å…æ‰«æè‰ç¨¿ä¹¦ç±

3. **ç¼“å­˜ç­–ç•¥**
   - å¯¹çƒ­é—¨ã€æ¨èã€ç²¾é€‰ä¹¦ç±åˆ—è¡¨è¿›è¡Œç¼“å­˜
   - å¯¹ç»Ÿè®¡ä¿¡æ¯è¿›è¡ŒçŸ­æœŸç¼“å­˜

## æ€»ç»“

âœ… **MongoDB ä»“å‚¨å±‚å®ç°å®Œæ•´ä¸”ç¼–è¯‘é€šè¿‡**

- æ‰€æœ‰æ¥å£å®šä¹‰çš„æ–¹æ³•å‡å·²å®ç°
- é¢å¤–æä¾›äº†å¤šä¸ªè¾…åŠ©æ–¹æ³•ç”¨äºæ‰©å±•åŠŸèƒ½
- ä»£ç ç»“æ„æ¸…æ™°ï¼Œç¬¦åˆé¡¹ç›®åˆ†å±‚æ¶æ„è§„èŒƒ

âš ï¸ **Service å±‚éœ€è¦åŒæ­¥æ›´æ–°**

- éœ€è¦è°ƒæ•´ Service å±‚çš„æ–¹æ³•ç­¾åå’Œè°ƒç”¨æ–¹å¼
- éœ€è¦ä¸º Service å±‚æ·»åŠ ç¼ºå¤±çš„æ–¹æ³•å®ç°
- éœ€è¦ç»Ÿä¸€ Search æ–¹æ³•çš„å‚æ•°æ ¼å¼

ğŸ“ **æ–‡æ¡£å·²æ›´æ–°**

- ä¹¦åŸç³»ç»Ÿè®¾è®¡æ–‡æ¡£å·²æ›´æ–°ï¼Œåæ˜ æœ€æ–°çš„ä»“å‚¨å±‚è®¾è®¡
- æ·»åŠ äº†è¯¦ç»†çš„æ¥å£å®ç°æ£€æµ‹æŠ¥å‘Š
- æä¾›äº†æ€§èƒ½ä¼˜åŒ–å’Œä»£ç ç»„ç»‡çš„å»ºè®®

## åç»­å·¥ä½œ

1. ä¿®å¤ Service å±‚çš„ç¼–è¯‘é”™è¯¯
2. æ›´æ–° API å±‚ä»¥é€‚åº” Service å±‚çš„å˜æ›´
3. ç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯ä»“å‚¨å±‚å®ç°
4. è¿›è¡Œæ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
5. å®Œå–„æ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹
