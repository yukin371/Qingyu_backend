# 自动化测试总体方案（简化版）

> 适用于青羽写作后端项目的轻量级自动化测试方案

## 1. 测试策略

### 1.1 测试金字塔（简化版）
```
        E2E (5%)
    ────────────
   集成测试 (25%)
  ───────────────
  单元测试 (70%)
─────────────────
```

### 1.2 测试优先级
- **P0（必须）**: 核心业务逻辑的单元测试
- **P1（重要）**: 关键API的集成测试
- **P2（可选）**: E2E测试和边缘场景

## 2. 测试框架选择

### 2.1 Go测试工具栈
```go
// 单元测试
- testing (Go标准库)
- testify/assert (断言库)

// Mock
- testify/mock (Mock框架)
- gomock (可选)

// 集成测试
- httptest (HTTP测试)
- mongo-go-driver/mongo/integration (MongoDB测试)

// 测试覆盖率
- go test -cover
```

## 3. 测试结构

### 3.1 目录结构
```
test/
├── unit/              # 单元测试
│   ├── service/       # Service层测试
│   └── repository/    # Repository层测试
├── integration/       # 集成测试
│   ├── api/          # API测试
│   └── db/           # 数据库测试
└── testdata/         # 测试数据
    └── fixtures/     # 测试夹具
```

### 3.2 测试命名规范
```go
// 文件命名: xxx_test.go
// 函数命名: TestXxx_Scenario_ExpectedResult

// 示例
func TestUserService_Register_Success(t *testing.T)
func TestUserService_Register_DuplicateEmail_ReturnsError(t *testing.T)
```

## 4. 测试实施

### 4.1 单元测试（优先级最高）

**测试范围：**
- ✅ Service层业务逻辑
- ✅ Repository层数据操作
- ✅ 工具函数

**示例：**
```go
// service/user/user_service_test.go
func TestUserService_Register_Success(t *testing.T) {
    // Arrange
    mockRepo := new(MockUserRepository)
    service := NewUserService(mockRepo)
    user := &models.User{
        Username: "testuser",
        Email: "test@example.com",
    }
    
    mockRepo.On("Create", user).Return(nil)
    
    // Act
    err := service.Register(user)
    
    // Assert
    assert.NoError(t, err)
    mockRepo.AssertExpectations(t)
}
```

### 4.2 集成测试（中等优先级）

**测试范围：**
- ✅ API端到端流程
- ✅ 数据库操作

**示例：**
```go
// test/integration/api/user_api_test.go
func TestUserAPI_Register(t *testing.T) {
    // Setup test server
    router := setupTestRouter()
    
    // Create test request
    body := `{"username":"test","email":"test@example.com","password":"123456"}`
    req := httptest.NewRequest("POST", "/api/v1/user/register", strings.NewReader(body))
    req.Header.Set("Content-Type", "application/json")
    
    // Execute request
    w := httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    // Assert response
    assert.Equal(t, 201, w.Code)
}
```

### 4.3 测试数据管理

**策略：**
```go
// testdata/fixtures/user.go
package fixtures

func CreateTestUser() *models.User {
    return &models.User{
        Username: "testuser",
        Email: "test@example.com",
        Password: "hashed_password",
    }
}

func CreateMultipleTestUsers(count int) []*models.User {
    users := make([]*models.User, count)
    for i := 0; i < count; i++ {
        users[i] = &models.User{
            Username: fmt.Sprintf("user%d", i),
            Email: fmt.Sprintf("user%d@example.com", i),
        }
    }
    return users
}
```

## 5. 测试覆盖率目标

### 5.1 阶段性目标
```
第一阶段（当前）：
- Service层: 60%+
- Repository层: 50%+
- 整体: 40%+

第二阶段（3个月后）：
- Service层: 80%+
- Repository层: 70%+
- 整体: 60%+
```

### 5.2 覆盖率检查
```bash
# 运行测试并生成覆盖率报告
go test ./... -cover -coverprofile=coverage.out

# 查看详细覆盖率
go tool cover -html=coverage.out

# 设置覆盖率门槛（CI/CD）
go test ./... -cover -covermode=count -coverprofile=coverage.out
go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//' | \
  awk '{if ($1 < 40) exit 1}'
```

## 6. 持续集成

### 6.1 Git Hooks（本地检查）
```bash
# .git/hooks/pre-commit
#!/bin/sh
echo "Running tests..."
go test ./... -short
if [ $? -ne 0 ]; then
    echo "Tests failed. Commit aborted."
    exit 1
fi
```

### 6.2 CI配置（GitHub Actions示例）
```yaml
# .github/workflows/test.yml
name: Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Run tests
        run: |
          go test ./... -v -cover -coverprofile=coverage.out
      
      - name: Check coverage
        run: |
          go tool cover -func=coverage.out
```

## 7. 实施计划

### Phase 1: 基础建设（1-2周）
- [ ] 建立测试目录结构
- [ ] 配置测试框架和Mock工具
- [ ] 编写测试工具函数和fixtures
- [ ] 为核心Service编写单元测试

### Phase 2: 核心覆盖（2-3周）
- [ ] 完成用户模块测试
- [ ] 完成文档模块测试
- [ ] 完成AI模块测试
- [ ] 达到40%整体覆盖率

### Phase 3: 持续集成（1周）
- [ ] 配置Git Hooks
- [ ] 配置CI/CD pipeline
- [ ] 建立测试报告机制

### Phase 4: 持续优化（长期）
- [ ] 定期review测试代码
- [ ] 补充边缘场景测试
- [ ] 优化测试性能
- [ ] 提升覆盖率到60%+

## 8. 测试最佳实践

### 8.1 FIRST原则
- **Fast**: 测试应该快速运行
- **Independent**: 测试之间相互独立
- **Repeatable**: 测试结果可重复
- **Self-validating**: 测试自动验证（不需要人工检查）
- **Timely**: 及时编写测试

### 8.2 测试编写建议
```go
// ✅ Good: 清晰的测试结构
func TestUserService_Login_Success(t *testing.T) {
    // Arrange: 准备测试数据
    user := fixtures.CreateTestUser()
    
    // Act: 执行被测试的操作
    result, err := service.Login(user.Email, "password")
    
    // Assert: 验证结果
    assert.NoError(t, err)
    assert.NotNil(t, result)
    assert.Equal(t, user.ID, result.ID)
}

// ❌ Bad: 混乱的测试逻辑
func TestLogin(t *testing.T) {
    // 测试逻辑混乱，难以理解
    service.Login("test@example.com", "pass")
    // ... 各种操作混在一起
}
```

### 8.3 Mock使用建议
```go
// ✅ Good: 精确Mock
mockRepo.On("FindByEmail", "test@example.com").
    Return(&models.User{ID: "123"}, nil)

// ❌ Bad: 过度Mock
mockRepo.On("FindByEmail", mock.Anything).
    Return(mock.Anything, mock.Anything)
```

## 9. 常用命令速查

```bash
# 运行所有测试
go test ./...

# 运行指定包的测试
go test ./service/user/...

# 运行指定测试函数
go test -run TestUserService_Register

# 运行测试并显示详细输出
go test -v ./...

# 运行测试并生成覆盖率报告
go test ./... -cover -coverprofile=coverage.out

# 查看覆盖率HTML报告
go tool cover -html=coverage.out

# 只运行短测试（跳过耗时的集成测试）
go test ./... -short

# 运行测试并开启竞态检测
go test ./... -race

# 清理测试缓存
go clean -testcache
```

## 10. 参考资源

- [Go Testing官方文档](https://pkg.go.dev/testing)
- [Testify库文档](https://github.com/stretchr/testify)
- [Go测试最佳实践](https://go.dev/doc/tutorial/add-a-test)
- [表格驱动测试](https://dave.cheney.net/2019/05/07/prefer-table-driven-tests)

---

## 总结

**对于青羽项目，建议：**

✅ **立即实施：**
- 核心业务逻辑的单元测试
- 建立基础测试框架
- 配置本地测试流程

⏰ **逐步推进：**
- 集成测试
- CI/CD集成
- 提升覆盖率

❌ **暂不考虑：**
- 复杂的E2E测试
- 过度的Mock和隔离
- 100%覆盖率追求

**核心原则：** 实用为主，循序渐进，不过度设计 🎯
