# è‡ªåŠ¨åŒ–æµ‹è¯•æ€»ä½“æ–¹æ¡ˆï¼ˆç®€åŒ–ç‰ˆï¼‰

> é€‚ç”¨äºé’ç¾½å†™ä½œåç«¯é¡¹ç›®çš„è½»é‡çº§è‡ªåŠ¨åŒ–æµ‹è¯•æ–¹æ¡ˆ

## 1. æµ‹è¯•ç­–ç•¥

### 1.1 æµ‹è¯•é‡‘å­—å¡”ï¼ˆç®€åŒ–ç‰ˆï¼‰
```
        E2E (5%)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   é›†æˆæµ‹è¯• (25%)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  å•å…ƒæµ‹è¯• (70%)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

### 1.2 æµ‹è¯•ä¼˜å…ˆçº§
- **P0ï¼ˆå¿…é¡»ï¼‰**: æ ¸å¿ƒä¸šåŠ¡é€»è¾‘çš„å•å…ƒæµ‹è¯•
- **P1ï¼ˆé‡è¦ï¼‰**: å…³é”®APIçš„é›†æˆæµ‹è¯•
- **P2ï¼ˆå¯é€‰ï¼‰**: E2Eæµ‹è¯•å’Œè¾¹ç¼˜åœºæ™¯

## 2. æµ‹è¯•æ¡†æ¶é€‰æ‹©

### 2.1 Goæµ‹è¯•å·¥å…·æ ˆ
```go
// å•å…ƒæµ‹è¯•
- testing (Goæ ‡å‡†åº“)
- testify/assert (æ–­è¨€åº“)

// Mock
- testify/mock (Mockæ¡†æ¶)
- gomock (å¯é€‰)

// é›†æˆæµ‹è¯•
- httptest (HTTPæµ‹è¯•)
- mongo-go-driver/mongo/integration (MongoDBæµ‹è¯•)

// æµ‹è¯•è¦†ç›–ç‡
- go test -cover
```

## 3. æµ‹è¯•ç»“æ„

### 3.1 ç›®å½•ç»“æ„
```
test/
â”œâ”€â”€ unit/              # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ service/       # Serviceå±‚æµ‹è¯•
â”‚   â””â”€â”€ repository/    # Repositoryå±‚æµ‹è¯•
â”œâ”€â”€ integration/       # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ api/          # APIæµ‹è¯•
â”‚   â””â”€â”€ db/           # æ•°æ®åº“æµ‹è¯•
â””â”€â”€ testdata/         # æµ‹è¯•æ•°æ®
    â””â”€â”€ fixtures/     # æµ‹è¯•å¤¹å…·
```

### 3.2 æµ‹è¯•å‘½åè§„èŒƒ
```go
// æ–‡ä»¶å‘½å: xxx_test.go
// å‡½æ•°å‘½å: TestXxx_Scenario_ExpectedResult

// ç¤ºä¾‹
func TestUserService_Register_Success(t *testing.T)
func TestUserService_Register_DuplicateEmail_ReturnsError(t *testing.T)
```

## 4. æµ‹è¯•å®æ–½

### 4.1 å•å…ƒæµ‹è¯•ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰

**æµ‹è¯•èŒƒå›´ï¼š**
- âœ… Serviceå±‚ä¸šåŠ¡é€»è¾‘
- âœ… Repositoryå±‚æ•°æ®æ“ä½œ
- âœ… å·¥å…·å‡½æ•°

**ç¤ºä¾‹ï¼š**
```go
// service/user/user_service_test.go
func TestUserService_Register_Success(t *testing.T) {
    // Arrange
    mockRepo := new(MockUserRepository)
    service := NewUserService(mockRepo)
    user := &models.User{
        Username: "testuser",
        Email: "test@example.com",
    }
    
    mockRepo.On("Create", user).Return(nil)
    
    // Act
    err := service.Register(user)
    
    // Assert
    assert.NoError(t, err)
    mockRepo.AssertExpectations(t)
}
```

### 4.2 é›†æˆæµ‹è¯•ï¼ˆä¸­ç­‰ä¼˜å…ˆçº§ï¼‰

**æµ‹è¯•èŒƒå›´ï¼š**
- âœ… APIç«¯åˆ°ç«¯æµç¨‹
- âœ… æ•°æ®åº“æ“ä½œ

**ç¤ºä¾‹ï¼š**
```go
// test/integration/api/user_api_test.go
func TestUserAPI_Register(t *testing.T) {
    // Setup test server
    router := setupTestRouter()
    
    // Create test request
    body := `{"username":"test","email":"test@example.com","password":"123456"}`
    req := httptest.NewRequest("POST", "/api/v1/user/register", strings.NewReader(body))
    req.Header.Set("Content-Type", "application/json")
    
    // Execute request
    w := httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    // Assert response
    assert.Equal(t, 201, w.Code)
}
```

### 4.3 æµ‹è¯•æ•°æ®ç®¡ç†

**ç­–ç•¥ï¼š**
```go
// testdata/fixtures/user.go
package fixtures

func CreateTestUser() *models.User {
    return &models.User{
        Username: "testuser",
        Email: "test@example.com",
        Password: "hashed_password",
    }
}

func CreateMultipleTestUsers(count int) []*models.User {
    users := make([]*models.User, count)
    for i := 0; i < count; i++ {
        users[i] = &models.User{
            Username: fmt.Sprintf("user%d", i),
            Email: fmt.Sprintf("user%d@example.com", i),
        }
    }
    return users
}
```

## 5. æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

### 5.1 é˜¶æ®µæ€§ç›®æ ‡
```
ç¬¬ä¸€é˜¶æ®µï¼ˆå½“å‰ï¼‰ï¼š
- Serviceå±‚: 60%+
- Repositoryå±‚: 50%+
- æ•´ä½“: 40%+

ç¬¬äºŒé˜¶æ®µï¼ˆ3ä¸ªæœˆåï¼‰ï¼š
- Serviceå±‚: 80%+
- Repositoryå±‚: 70%+
- æ•´ä½“: 60%+
```

### 5.2 è¦†ç›–ç‡æ£€æŸ¥
```bash
# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
go test ./... -cover -coverprofile=coverage.out

# æŸ¥çœ‹è¯¦ç»†è¦†ç›–ç‡
go tool cover -html=coverage.out

# è®¾ç½®è¦†ç›–ç‡é—¨æ§›ï¼ˆCI/CDï¼‰
go test ./... -cover -covermode=count -coverprofile=coverage.out
go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//' | \
  awk '{if ($1 < 40) exit 1}'
```

## 6. æŒç»­é›†æˆ

### 6.1 Git Hooksï¼ˆæœ¬åœ°æ£€æŸ¥ï¼‰
```bash
# .git/hooks/pre-commit
#!/bin/sh
echo "Running tests..."
go test ./... -short
if [ $? -ne 0 ]; then
    echo "Tests failed. Commit aborted."
    exit 1
fi
```

### 6.2 CIé…ç½®ï¼ˆGitHub Actionsç¤ºä¾‹ï¼‰
```yaml
# .github/workflows/test.yml
name: Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Run tests
        run: |
          go test ./... -v -cover -coverprofile=coverage.out
      
      - name: Check coverage
        run: |
          go tool cover -func=coverage.out
```

## 7. å®æ–½è®¡åˆ’

### Phase 1: åŸºç¡€å»ºè®¾ï¼ˆ1-2å‘¨ï¼‰
- [ ] å»ºç«‹æµ‹è¯•ç›®å½•ç»“æ„
- [ ] é…ç½®æµ‹è¯•æ¡†æ¶å’ŒMockå·¥å…·
- [ ] ç¼–å†™æµ‹è¯•å·¥å…·å‡½æ•°å’Œfixtures
- [ ] ä¸ºæ ¸å¿ƒServiceç¼–å†™å•å…ƒæµ‹è¯•

### Phase 2: æ ¸å¿ƒè¦†ç›–ï¼ˆ2-3å‘¨ï¼‰
- [ ] å®Œæˆç”¨æˆ·æ¨¡å—æµ‹è¯•
- [ ] å®Œæˆæ–‡æ¡£æ¨¡å—æµ‹è¯•
- [ ] å®ŒæˆAIæ¨¡å—æµ‹è¯•
- [ ] è¾¾åˆ°40%æ•´ä½“è¦†ç›–ç‡

### Phase 3: æŒç»­é›†æˆï¼ˆ1å‘¨ï¼‰
- [ ] é…ç½®Git Hooks
- [ ] é…ç½®CI/CD pipeline
- [ ] å»ºç«‹æµ‹è¯•æŠ¥å‘Šæœºåˆ¶

### Phase 4: æŒç»­ä¼˜åŒ–ï¼ˆé•¿æœŸï¼‰
- [ ] å®šæœŸreviewæµ‹è¯•ä»£ç 
- [ ] è¡¥å……è¾¹ç¼˜åœºæ™¯æµ‹è¯•
- [ ] ä¼˜åŒ–æµ‹è¯•æ€§èƒ½
- [ ] æå‡è¦†ç›–ç‡åˆ°60%+

## 8. æµ‹è¯•æœ€ä½³å®è·µ

### 8.1 FIRSTåŸåˆ™
- **Fast**: æµ‹è¯•åº”è¯¥å¿«é€Ÿè¿è¡Œ
- **Independent**: æµ‹è¯•ä¹‹é—´ç›¸äº’ç‹¬ç«‹
- **Repeatable**: æµ‹è¯•ç»“æœå¯é‡å¤
- **Self-validating**: æµ‹è¯•è‡ªåŠ¨éªŒè¯ï¼ˆä¸éœ€è¦äººå·¥æ£€æŸ¥ï¼‰
- **Timely**: åŠæ—¶ç¼–å†™æµ‹è¯•

### 8.2 æµ‹è¯•ç¼–å†™å»ºè®®
```go
// âœ… Good: æ¸…æ™°çš„æµ‹è¯•ç»“æ„
func TestUserService_Login_Success(t *testing.T) {
    // Arrange: å‡†å¤‡æµ‹è¯•æ•°æ®
    user := fixtures.CreateTestUser()
    
    // Act: æ‰§è¡Œè¢«æµ‹è¯•çš„æ“ä½œ
    result, err := service.Login(user.Email, "password")
    
    // Assert: éªŒè¯ç»“æœ
    assert.NoError(t, err)
    assert.NotNil(t, result)
    assert.Equal(t, user.ID, result.ID)
}

// âŒ Bad: æ··ä¹±çš„æµ‹è¯•é€»è¾‘
func TestLogin(t *testing.T) {
    // æµ‹è¯•é€»è¾‘æ··ä¹±ï¼Œéš¾ä»¥ç†è§£
    service.Login("test@example.com", "pass")
    // ... å„ç§æ“ä½œæ··åœ¨ä¸€èµ·
}
```

### 8.3 Mockä½¿ç”¨å»ºè®®
```go
// âœ… Good: ç²¾ç¡®Mock
mockRepo.On("FindByEmail", "test@example.com").
    Return(&models.User{ID: "123"}, nil)

// âŒ Bad: è¿‡åº¦Mock
mockRepo.On("FindByEmail", mock.Anything).
    Return(mock.Anything, mock.Anything)
```

## 9. å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
go test ./...

# è¿è¡ŒæŒ‡å®šåŒ…çš„æµ‹è¯•
go test ./service/user/...

# è¿è¡ŒæŒ‡å®šæµ‹è¯•å‡½æ•°
go test -run TestUserService_Register

# è¿è¡Œæµ‹è¯•å¹¶æ˜¾ç¤ºè¯¦ç»†è¾“å‡º
go test -v ./...

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
go test ./... -cover -coverprofile=coverage.out

# æŸ¥çœ‹è¦†ç›–ç‡HTMLæŠ¥å‘Š
go tool cover -html=coverage.out

# åªè¿è¡ŒçŸ­æµ‹è¯•ï¼ˆè·³è¿‡è€—æ—¶çš„é›†æˆæµ‹è¯•ï¼‰
go test ./... -short

# è¿è¡Œæµ‹è¯•å¹¶å¼€å¯ç«æ€æ£€æµ‹
go test ./... -race

# æ¸…ç†æµ‹è¯•ç¼“å­˜
go clean -testcache
```

## 10. å‚è€ƒèµ„æº

- [Go Testingå®˜æ–¹æ–‡æ¡£](https://pkg.go.dev/testing)
- [Testifyåº“æ–‡æ¡£](https://github.com/stretchr/testify)
- [Goæµ‹è¯•æœ€ä½³å®è·µ](https://go.dev/doc/tutorial/add-a-test)
- [è¡¨æ ¼é©±åŠ¨æµ‹è¯•](https://dave.cheney.net/2019/05/07/prefer-table-driven-tests)

---

## æ€»ç»“

**å¯¹äºé’ç¾½é¡¹ç›®ï¼Œå»ºè®®ï¼š**

âœ… **ç«‹å³å®æ–½ï¼š**
- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘çš„å•å…ƒæµ‹è¯•
- å»ºç«‹åŸºç¡€æµ‹è¯•æ¡†æ¶
- é…ç½®æœ¬åœ°æµ‹è¯•æµç¨‹

â° **é€æ­¥æ¨è¿›ï¼š**
- é›†æˆæµ‹è¯•
- CI/CDé›†æˆ
- æå‡è¦†ç›–ç‡

âŒ **æš‚ä¸è€ƒè™‘ï¼š**
- å¤æ‚çš„E2Eæµ‹è¯•
- è¿‡åº¦çš„Mockå’Œéš”ç¦»
- 100%è¦†ç›–ç‡è¿½æ±‚

**æ ¸å¿ƒåŸåˆ™ï¼š** å®ç”¨ä¸ºä¸»ï¼Œå¾ªåºæ¸è¿›ï¼Œä¸è¿‡åº¦è®¾è®¡ ğŸ¯
