# 书城系统测试设计

## 1. 测试概述

### 1.1 测试目标
- **功能验证**：确保书城系统所有功能按照需求正确实现
- **性能验证**：验证系统在预期负载下的性能表现
- **稳定性验证**：确保系统在各种异常情况下的稳定性
- **安全性验证**：验证系统的安全防护措施有效性

### 1.2 测试范围
- **Model层**：数据模型的验证和约束检查
- **Repository层**：数据访问逻辑和数据库操作
- **Service层**：业务逻辑处理和数据聚合
- **API层**：HTTP接口的参数验证和响应格式
- **Router层**：路由配置和中间件功能
- **缓存层**：Redis缓存的读写和失效策略
- **榜单系统**：实时榜、周榜、月榜、新人榜的计算和更新

### 1.3 测试策略
- **单元测试**：针对各层的独立功能进行测试
- **集成测试**：验证各层之间的协作和数据流转
- **端到端测试**：模拟用户完整使用流程
- **性能测试**：验证系统性能指标
- **安全测试**：验证安全防护措施
- **缓存测试**：验证缓存策略的有效性和一致性

## 2. 测试分类

### 2.1 单元测试

#### 2.1.1 Service层测试
**测试文件**: `test/bookstore_service_test.go`

**测试覆盖范围**:
- 书籍服务功能测试
- 分类服务功能测试
- Banner服务功能测试
- 首页数据聚合测试
- 错误处理测试

**主要测试用例**:
```go
// 正常流程测试
func TestBookstoreService_GetBookByID(t *testing.T)
func TestBookstoreService_GetRecommendedBooks(t *testing.T)
func TestBookstoreService_GetHomepageData(t *testing.T)

// 异常情况测试
func TestBookstoreService_GetBookByID_NotFound(t *testing.T)
func TestBookstoreService_GetBookByID_InvalidID(t *testing.T)
func TestBookstoreService_IncrementBookView_BookNotPublished(t *testing.T)

// 业务规则测试
func TestBookstoreService_SearchBooks_EmptyKeywordAndFilter(t *testing.T)
func TestBookstoreService_GetCategoryByID_NotActive(t *testing.T)
```

**Mock策略**:
- 使用testify/mock框架创建Repository层Mock
- 模拟各种数据库操作结果
- 测试业务逻辑的正确性

#### 2.1.2 Repository层测试
**测试重点**:
- 数据库CRUD操作
- 复杂查询逻辑
- 事务处理
- 错误处理

**测试用例示例**:
```go
func TestMongoBookRepository_Create(t *testing.T)
func TestMongoBookRepository_GetByID(t *testing.T)
func TestMongoBookRepository_Search(t *testing.T)
func TestMongoBookRepository_IncrementViewCount(t *testing.T)
func TestMongoCategoryRepository_GetCategoryTree(t *testing.T)
```

#### 2.1.3 Model层测试
**测试重点**:
- 数据验证规则
- 字段约束检查
- 业务规则验证

### 2.2 集成测试

#### 2.2.1 API集成测试
**测试文件**: `test/integration/bookstore_integration_test.go`

**测试覆盖范围**:
- HTTP接口功能验证
- 请求参数验证
- 响应格式验证
- 错误处理验证
- 分页功能验证

**主要测试场景**:
```go
// 首页数据获取
func (suite *BookstoreIntegrationTestSuite) TestGetHomepage()

// 书籍相关接口
func (suite *BookstoreIntegrationTestSuite) TestGetBookByID()
func (suite *BookstoreIntegrationTestSuite) TestGetRecommendedBooks()
func (suite *BookstoreIntegrationTestSuite) TestSearchBooks()

// 分类相关接口
func (suite *BookstoreIntegrationTestSuite) TestGetCategoryTree()
func (suite *BookstoreIntegrationTestSuite) TestGetCategoryByID()

// 错误处理测试
func (suite *BookstoreIntegrationTestSuite) TestErrorHandling()
```

#### 2.2.2 数据库集成测试
**测试重点**:
- 真实数据库环境测试
- 数据一致性验证
- 事务完整性测试
- 索引性能测试

### 2.3 端到端测试

#### 2.3.1 用户场景测试
**测试场景**:
1. **新用户浏览首页**
   - 访问首页获取Banner和推荐内容
   - 浏览分类树结构
   - 查看推荐书籍列表

2. **用户搜索书籍**
   - 使用关键词搜索
   - 使用过滤条件搜索
   - 查看搜索结果分页

3. **用户查看书籍详情**
   - 点击书籍查看详情
   - 增加浏览量统计
   - 查看相关推荐

4. **用户分类浏览**
   - 选择分类查看书籍
   - 分页浏览分类下的书籍
   - 切换不同分类

## 3. 测试用例设计

### 3.1 功能测试用例

#### 3.1.1 书籍管理测试用例

| 测试用例ID | 测试场景 | 输入数据 | 预期结果 | 优先级 |
|-----------|---------|---------|---------|--------|
| TC_BOOK_001 | 获取书籍详情-正常流程 | 有效书籍ID | 返回书籍详细信息 | 高 |
| TC_BOOK_002 | 获取书籍详情-无效ID | 无效书籍ID | 返回400错误 | 高 |
| TC_BOOK_003 | 获取书籍详情-不存在 | 不存在的书籍ID | 返回404错误 | 高 |
| TC_BOOK_004 | 获取推荐书籍 | 分页参数 | 返回推荐书籍列表 | 高 |
| TC_BOOK_005 | 搜索书籍-关键词 | 搜索关键词 | 返回匹配的书籍 | 高 |
| TC_BOOK_006 | 搜索书籍-过滤器 | 分类、作者等过滤条件 | 返回过滤后的书籍 | 中 |
| TC_BOOK_007 | 增加浏览量 | 有效书籍ID | 浏览量+1 | 中 |

#### 3.1.2 分类管理测试用例

| 测试用例ID | 测试场景 | 输入数据 | 预期结果 | 优先级 |
|-----------|---------|---------|---------|--------|
| TC_CAT_001 | 获取分类树 | 无 | 返回完整分类树结构 | 高 |
| TC_CAT_002 | 获取分类详情 | 有效分类ID | 返回分类详细信息 | 高 |
| TC_CAT_003 | 根据分类获取书籍 | 分类ID和分页参数 | 返回该分类下的书籍 | 高 |
| TC_CAT_004 | 获取根分类 | 无 | 返回所有顶级分类 | 中 |

#### 3.1.3 Banner管理测试用例

| 测试用例ID | 测试场景 | 输入数据 | 预期结果 | 优先级 |
|-----------|---------|---------|---------|--------|
| TC_BAN_001 | 获取激活Banner | 数量限制 | 返回激活的Banner列表 | 高 |
| TC_BAN_002 | 增加点击次数 | 有效Banner ID | 点击次数+1 | 中 |
| TC_BAN_003 | 时间范围过滤 | 开始和结束时间 | 返回时间范围内的Banner | 低 |

### 3.2 边界测试用例

#### 3.2.1 分页边界测试

| 测试场景 | 输入参数 | 预期结果 |
|---------|---------|---------|
| 默认分页 | 无分页参数 | page=1, size=20 |
| 最小分页 | page=1, size=1 | 正常返回1条数据 |
| 最大分页 | page=1, size=100 | 正常返回最多100条数据 |
| 超大分页 | page=1, size=1000 | 限制为100条数据 |
| 无效分页 | page=0, size=-1 | 自动修正为有效值 |

#### 3.2.2 搜索边界测试

| 测试场景 | 输入参数 | 预期结果 |
|---------|---------|---------|
| 空关键词 | keyword="" | 返回400错误 |
| 超长关键词 | 1000字符关键词 | 正常搜索或截断处理 |
| 特殊字符 | 包含SQL注入字符 | 安全过滤，正常搜索 |
| 中文搜索 | 中文关键词 | 正常返回匹配结果 |

### 3.3 异常测试用例

#### 3.3.1 网络异常测试

| 测试场景 | 模拟条件 | 预期结果 |
|---------|---------|---------|
| 数据库连接超时 | 模拟数据库不可用 | 返回500错误，记录日志 |
| 网络中断 | 模拟网络异常 | 连接重试，超时处理 |
| 响应超时 | 模拟慢查询 | 超时返回，避免阻塞 |

#### 3.3.2 数据异常测试

| 测试场景 | 模拟条件 | 预期结果 |
|---------|---------|---------|
| 数据不一致 | 缓存与数据库不一致 | 以数据库为准，更新缓存 |
| 数据损坏 | 模拟数据格式错误 | 错误处理，记录日志 |
| 并发冲突 | 同时更新同一数据 | 事务处理，保证一致性 |

## 4. 性能测试

### 4.1 性能测试指标

#### 4.1.1 响应时间指标
- **首页数据获取**: < 200ms
- **书籍详情查询**: < 100ms
- **书籍搜索**: < 500ms
- **分类树获取**: < 150ms

#### 4.1.2 并发性能指标
- **并发用户数**: 1000
- **每秒请求数**: 500 QPS
- **错误率**: < 0.1%
- **CPU使用率**: < 70%
- **内存使用率**: < 80%

### 4.2 性能测试场景

#### 4.2.1 负载测试
```bash
# 使用Apache Bench进行负载测试
ab -n 10000 -c 100 http://localhost:8080/api/v1/bookstore/homepage

# 使用wrk进行压力测试
wrk -t12 -c400 -d30s http://localhost:8080/api/v1/bookstore/books/search?keyword=test
```

#### 4.2.2 压力测试
- **逐步增加并发数**: 100 -> 500 -> 1000 -> 2000
- **监控系统资源**: CPU、内存、数据库连接数
- **记录性能拐点**: 确定系统最大承载能力

#### 4.2.3 稳定性测试
- **长时间运行**: 连续运行24小时
- **内存泄漏检测**: 监控内存使用趋势
- **连接池测试**: 验证数据库连接池稳定性

### 4.3 性能优化验证

#### 4.3.1 缓存效果测试
- **缓存命中率**: > 80%
- **缓存响应时间**: < 10ms
- **缓存更新延迟**: < 100ms

#### 4.3.2 数据库优化测试
- **索引效果**: 查询时间减少 > 50%
- **查询优化**: 复杂查询时间 < 200ms
- **连接池效率**: 连接获取时间 < 10ms

## 5. 安全测试

### 5.1 输入验证测试

#### 5.1.1 SQL注入测试
```bash
# 测试搜索接口的SQL注入防护
curl "http://localhost:8080/api/v1/bookstore/books/search?keyword='; DROP TABLE books; --"

# 测试分类查询的SQL注入防护
curl "http://localhost:8080/api/v1/bookstore/categories/'; DELETE FROM categories; --"
```

#### 5.1.2 XSS攻击测试
```bash
# 测试搜索关键词的XSS防护
curl "http://localhost:8080/api/v1/bookstore/books/search?keyword=<script>alert('xss')</script>"
```

#### 5.1.3 参数篡改测试
- **ID参数篡改**: 尝试访问其他用户的数据
- **分页参数篡改**: 尝试获取超大数据集
- **排序参数篡改**: 尝试注入恶意排序条件

### 5.2 访问控制测试

#### 5.2.1 权限验证测试
- **未认证访问**: 验证公开接口可正常访问
- **认证接口测试**: 验证需要认证的接口正确拒绝未认证请求
- **权限边界测试**: 验证用户只能访问授权资源

#### 5.2.2 频率限制测试
```bash
# 测试接口频率限制
for i in {1..1000}; do
  curl "http://localhost:8080/api/v1/bookstore/books/search?keyword=test"
done
```

## 6. 测试环境

### 6.1 测试环境配置

#### 6.1.1 单元测试环境
- **Go版本**: 1.19+
- **测试框架**: testify
- **Mock框架**: testify/mock
- **覆盖率工具**: go test -cover

#### 6.1.2 集成测试环境
- **数据库**: MongoDB 4.4+
- **Web框架**: Gin
- **HTTP测试**: httptest
- **测试数据**: 预置测试数据集

#### 6.1.3 性能测试环境
- **服务器配置**: 4核8G内存
- **数据库配置**: MongoDB副本集
- **网络环境**: 千兆网络
- **监控工具**: Prometheus + Grafana

### 6.2 测试数据管理

#### 6.2.1 测试数据准备
```go
// 测试数据初始化
func setupTestData() {
    // 创建测试书籍
    testBooks := []*bookstore.Book{
        {
            Title:  "测试书籍1",
            Author: "测试作者1",
            Status: "published",
        },
        // ... 更多测试数据
    }
    
    // 创建测试分类
    testCategories := []*bookstore.Category{
        {
            Name:     "测试分类1",
            IsActive: true,
        },
        // ... 更多测试数据
    }
}
```

#### 6.2.2 测试数据清理
```go
// 测试后清理
func teardownTestData() {
    // 清理测试数据
    db.Collection("books").Drop(context.Background())
    db.Collection("categories").Drop(context.Background())
    db.Collection("banners").Drop(context.Background())
}
```

## 7. 测试执行

### 7.1 测试执行计划

#### 7.1.1 测试阶段划分
1. **开发阶段测试** (并行进行)
   - 单元测试编写和执行
   - 代码覆盖率检查
   - 静态代码分析

2. **集成测试阶段** (开发完成后)
   - API接口测试
   - 数据库集成测试
   - 端到端流程测试

3. **系统测试阶段** (集成测试通过后)
   - 性能测试
   - 安全测试
   - 稳定性测试

4. **验收测试阶段** (系统测试通过后)
   - 用户场景验证
   - 业务流程测试
   - 用户体验测试

### 7.2 测试执行命令

#### 7.2.1 单元测试执行
```bash
# 运行所有单元测试
go test ./test/... -v

# 运行特定测试文件
go test ./test/bookstore_service_test.go -v

# 生成覆盖率报告
go test ./test/... -coverprofile=coverage.out
go tool cover -html=coverage.out -o coverage.html
```

#### 7.2.2 集成测试执行
```bash
# 运行集成测试
go test ./test/integration/... -v

# 运行特定集成测试套件
go test ./test/integration/bookstore_integration_test.go -v
```

#### 7.2.3 性能测试执行
```bash
# 基准测试
go test -bench=. ./test/...

# 压力测试
ab -n 10000 -c 100 http://localhost:8080/api/v1/bookstore/homepage
```

### 7.3 持续集成

#### 7.3.1 CI/CD流水线
```yaml
# .github/workflows/test.yml
name: Test
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-go@v2
        with:
          go-version: 1.19
      - name: Run tests
        run: |
          go test ./test/... -v -coverprofile=coverage.out
          go tool cover -func=coverage.out
```

#### 7.3.2 测试报告
- **覆盖率报告**: 每次提交自动生成
- **测试结果报告**: 详细的测试执行结果
- **性能趋势报告**: 性能指标的历史趋势

## 8. 测试质量保证

### 8.1 测试覆盖率要求

#### 8.1.1 代码覆盖率指标
- **整体覆盖率**: ≥ 80%
- **Service层覆盖率**: ≥ 90%
- **Repository层覆盖率**: ≥ 85%
- **API层覆盖率**: ≥ 80%

#### 8.1.2 功能覆盖率指标
- **核心功能覆盖**: 100%
- **边界条件覆盖**: ≥ 90%
- **异常情况覆盖**: ≥ 80%
- **性能场景覆盖**: ≥ 70%

### 8.2 测试质量检查

#### 8.2.1 测试代码质量
- **测试命名规范**: 清晰描述测试场景
- **测试独立性**: 测试用例之间相互独立
- **测试可维护性**: 易于理解和修改
- **测试数据管理**: 合理的测试数据设计

#### 8.2.2 测试执行质量
- **测试稳定性**: 测试结果可重现
- **测试效率**: 测试执行时间合理
- **测试自动化**: 最大化自动化测试比例
- **测试监控**: 及时发现测试问题

## 9. 风险评估

### 9.1 测试风险

#### 9.1.1 技术风险
- **测试环境不稳定**: 可能影响测试结果准确性
- **测试数据不完整**: 可能遗漏重要测试场景
- **Mock数据不真实**: 可能与实际情况存在差异

#### 9.1.2 进度风险
- **测试时间不足**: 可能影响测试覆盖率
- **测试资源不足**: 可能影响测试深度
- **测试依赖延迟**: 可能影响测试进度

### 9.2 风险应对措施

#### 9.2.1 技术风险应对
- **环境备份**: 准备多套测试环境
- **数据完善**: 持续完善测试数据集
- **真实数据验证**: 定期使用真实数据验证

#### 9.2.2 进度风险应对
- **并行测试**: 最大化并行测试执行
- **优先级管理**: 优先测试核心功能
- **资源调配**: 及时调配测试资源

## 10. 总结

### 10.1 测试价值
- **质量保证**: 确保系统功能正确性和稳定性
- **风险控制**: 提前发现和解决潜在问题
- **性能验证**: 确保系统满足性能要求
- **安全保障**: 验证系统安全防护措施

### 10.2 持续改进
- **测试策略优化**: 根据项目特点调整测试策略
- **测试工具升级**: 采用更先进的测试工具和方法
- **测试流程改进**: 持续优化测试流程和效率
- **测试技能提升**: 提升团队测试技能和经验

通过全面的测试设计和执行，确保书城系统的高质量交付，为用户提供稳定、高效、安全的服务体验。