# 自动化测试总体方案

> **文档状态**: ✅ 完整方案  
> **创建时间**: 2025-01-01  
> **最后更新**: 2025-10-17  
> **适用范围**: 青羽写作平台后端项目

---

## 1. 需求概述

### 1.1 功能描述

建立完整的自动化测试体系，覆盖单元测试、集成测试、端到端测试，确保代码质量、降低回归风险、提高开发效率。

### 1.2 业务价值

- **提升代码质量**: 通过测试覆盖率保证代码健壮性
- **降低回归风险**: 自动化测试快速发现新代码引入的问题
- **提高开发效率**: 快速验证功能正确性，缩短开发周期
- **支持重构**: 测试作为安全网，支持代码重构和优化
- **文档作用**: 测试用例即功能文档，帮助理解代码行为

### 1.3 测试目标

- **代码覆盖率**: 核心模块达到80%以上
- **测试通过率**: 100%
- **测试执行时间**: 单元测试 < 5秒，全量测试 < 2分钟
- **自动化率**: CI/CD自动化测试达到100%

### 1.4 功能边界

**包含功能**:
- 单元测试框架和工具链
- 集成测试环境
- 测试数据管理
- CI/CD集成
- 测试覆盖率报告

**不包含功能**:
- E2E测试（后续迭代）
- 性能压力测试（独立方案）
- 安全渗透测试（独立方案）

---

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    开发阶段                              │
│  编写代码 → 编写测试 → 本地运行测试                      │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│                  代码提交 (Git)                          │
│  git push → 触发CI/CD Pipeline                          │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│              GitHub Actions (CI/CD)                     │
│  ┌───────────────────────────────────────────────┐    │
│  │  环境准备                                      │    │
│  │  - 启动MongoDB测试服务                         │    │
│  │  - 启动Redis测试服务                           │    │
│  │  - 安装依赖包                                  │    │
│  └───────────────────────────────────────────────┘    │
│                         ↓                              │
│  ┌───────────────────────────────────────────────┐    │
│  │  代码质量检查                                  │    │
│  │  - go fmt (格式检查)                           │    │
│  │  - go vet (静态分析)                           │    │
│  │  - golangci-lint (代码检查)                    │    │
│  └───────────────────────────────────────────────┘    │
│                         ↓                              │
│  ┌───────────────────────────────────────────────┐    │
│  │  运行测试                                      │    │
│  │  - 单元测试 (Service + Repository)             │    │
│  │  - 集成测试 (API + DB)                         │    │
│  │  - 竞态检测 (-race)                            │    │
│  └───────────────────────────────────────────────┘    │
│                         ↓                              │
│  ┌───────────────────────────────────────────────┐    │
│  │  覆盖率分析                                    │    │
│  │  - 生成覆盖率报告                              │    │
│  │  - 检查覆盖率阈值 (80%)                        │    │
│  │  - 上传覆盖率数据                              │    │
│  └───────────────────────────────────────────────┘    │
│                         ↓                              │
│  ┌───────────────────────────────────────────────┐    │
│  │  测试结果通知                                  │    │
│  │  - PR评论（覆盖率报告）                        │    │
│  │  - 失败通知                                    │    │
│  └───────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
```

### 2.2 模块划分

**单元测试模块 (70%)**
- Service层测试
- Repository层测试
- 工具函数测试

**集成测试模块 (25%)**
- API测试
- 数据库集成测试
- 缓存集成测试

**测试工具模块**
- 测试助手函数 (testutil)
- 测试数据工厂 (fixtures)
- Mock对象库

**CI/CD模块**
- GitHub Actions工作流
- 测试环境配置
- 覆盖率报告

---

## 3. 详细设计

### 3.1 测试框架选型

#### 3.1.1 核心框架

**Go testing (标准库)**
- 轻量级、无额外依赖
- 官方支持、稳定可靠
- 丰富的工具链支持

**testify (断言和Mock)**
- 丰富的断言函数
- 强大的Mock功能
- 社区广泛使用

**gotests (代码生成)**
- 自动生成测试模板
- 支持Table-Driven模式
- 提高测试编写效率

#### 3.1.2 辅助工具

```go
// 安装测试工具
go install github.com/cweill/gotests/gotests@latest
go install github.com/golang/mock/mockgen@latest
```

### 3.2 测试模式

#### 3.2.1 Table-Driven测试

```go
func TestUserService_CreateUser(t *testing.T) {
    tests := []struct {
        name    string
        input   *CreateUserRequest
        mock    func(*MockRepo)
        wantErr bool
    }{
        {
            name: "成功创建用户",
            input: &CreateUserRequest{
                Username: "test",
                Email: "test@example.com",
            },
            mock: func(m *MockRepo) {
                m.On("Create", mock.Anything, mock.Anything).Return(nil)
            },
            wantErr: false,
        },
        // ... 更多测试用例
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            // Arrange
            mockRepo := new(MockRepo)
            tt.mock(mockRepo)
            service := NewUserService(mockRepo)
            
            // Act
            err := service.CreateUser(context.Background(), tt.input)
            
            // Assert
            if tt.wantErr {
                assert.Error(t, err)
            } else {
                assert.NoError(t, err)
            }
            mockRepo.AssertExpectations(t)
        })
    }
}
```

#### 3.2.2 AAA模式 (Arrange-Act-Assert)

```go
func TestUserService_GetUser(t *testing.T) {
    // Arrange: 准备测试数据和依赖
    mockRepo := new(MockUserRepository)
    expectedUser := testutil.CreateTestUser()
    mockRepo.On("GetByID", mock.Anything, "123").Return(expectedUser, nil)
    service := NewUserService(mockRepo)
    
    // Act: 执行被测试的操作
    user, err := service.GetUser(context.Background(), "123")
    
    // Assert: 验证结果
    assert.NoError(t, err)
    assert.NotNil(t, user)
    assert.Equal(t, expectedUser.ID, user.ID)
    mockRepo.AssertExpectations(t)
}
```

### 3.3 测试助手库设计

#### 3.3.1 测试助手函数 (testutil)

**位置**: `test/testutil/helpers.go`

**功能**:
- 快速创建测试数据对象
- 通用断言函数
- 测试上下文创建
- 数据清理助手

**示例**:
```go
// 创建测试用户
user := testutil.CreateTestUser(
    testutil.WithUsername("test"),
    testutil.WithRole("admin"),
)

// 创建测试上下文
ctx := testutil.CreateTestContext()

// 断言用户相等
testutil.AssertUserEqual(t, expected, actual)
```

#### 3.3.2 测试数据工厂 (fixtures)

**位置**: `test/fixtures/factory.go`

**功能**:
- 批量创建测试数据
- 支持自定义字段
- 保证数据一致性

**示例**:
```go
// 创建工厂
userFactory := fixtures.NewUserFactory()

// 创建用户
user1 := userFactory.Create()
admin := userFactory.CreateAdmin()
users := userFactory.CreateBatch(10)

// 自定义用户
customUser := userFactory.Create(func(u *User) {
    u.Username = "custom"
    u.Email = "custom@test.com"
})
```

### 3.4 Mock策略

#### 3.4.1 Mock使用原则

✅ **需要Mock的场景**:
- 外部服务调用（HTTP、RPC）
- 数据库操作（单元测试）
- 文件系统操作
- 第三方SDK
- 耗时操作

❌ **不需要Mock的场景**:
- 简单数据结构
- 纯函数计算
- 工具函数
- 集成测试（使用真实依赖）

#### 3.4.2 Mock示例

```go
// 定义Mock接口
type MockUserRepository struct {
    mock.Mock
}

func (m *MockUserRepository) Create(ctx context.Context, user *User) error {
    args := m.Called(ctx, user)
    return args.Error(0)
}

// 使用Mock
mockRepo := new(MockUserRepository)
mockRepo.On("Create", mock.Anything, mock.AnythingOfType("*User")).Return(nil)
mockRepo.AssertCalled(t, "Create", mock.Anything, mock.Anything)
```

---

## 4. CI/CD集成

### 4.1 GitHub Actions配置

**文件**: `.github/workflows/test.yml`

**触发条件**:
- Push到main/dev分支
- Pull Request到main/dev分支

**执行步骤**:
1. 启动测试服务 (MongoDB, Redis)
2. 代码格式检查 (gofmt, go vet)
3. 运行测试 (带竞态检测)
4. 生成覆盖率报告
5. 检查覆盖率阈值
6. PR评论覆盖率结果

### 4.2 本地测试命令

**Makefile快捷命令**:
```bash
# 运行所有测试
make test

# 运行单元测试
make test-unit

# 运行集成测试
make test-integration

# 生成覆盖率报告
make test-coverage

# 检查覆盖率
make test-coverage-check

# 生成测试模板
make test-gen file=service/user/user_service.go

# 清理测试缓存
make test-clean
```

---

## 5. 测试覆盖率目标

### 5.1 覆盖率目标

| 模块 | 目标覆盖率 | 优先级 |
|------|-----------|--------|
| Service层 | 80% | 🔥 最高 |
| Repository层 | 70% | 🔥 最高 |
| API层 | 60% | ⭐ 高 |
| 工具函数 | 80% | ⭐ 高 |
| 总体 | 80% | 🔥 最高 |

### 5.2 质量门禁

**CI/CD质量门禁**:
- ✅ 所有测试必须通过
- ✅ 覆盖率不低于80%（警告，暂不阻塞）
- ✅ 无代码格式问题
- ✅ 无静态分析错误

**代码提交前检查**:
```bash
# 运行快速检查
make check

# 等同于
make fmt vet lint test-unit
```

---

## 6. 测试数据管理

### 6.1 测试数据策略

**数据准备**:
- 使用Factory模式创建测试数据
- 每个测试独立准备数据
- 避免测试间数据污染

**数据清理**:
- 测试完成后清理数据
- 使用`t.Cleanup()`注册清理函数
- 集成测试使用独立测试数据库

### 6.2 测试数据库

**MongoDB测试数据库**:
- 数据库名: `qingyu_test`
- 连接URI: `mongodb://test:test123@localhost:27017/qingyu_test`
- 隔离: 每个测试使用独立集合或文档

**Redis测试实例**:
- 地址: `localhost:6379`
- DB: `1`（独立于开发环境）

---

## 7. 测试实施策略

### 7.1 实施阶段

**Phase 1: 基础建设 (已完成)**
- ✅ 建立测试目录结构
- ✅ 配置测试框架和工具
- ✅ 编写测试助手函数和工厂
- ✅ 配置CI/CD

**Phase 2: 核心覆盖 (进行中)**
- 🔄 完成Service层核心模块测试
- 🔄 完成Repository层核心模块测试
- 🔄 达到40%整体覆盖率

**Phase 3: 全面覆盖 (待开始)**
- ⏳ 补充API层测试
- ⏳ 补充边缘场景测试
- ⏳ 达到80%整体覆盖率

**Phase 4: 持续优化 (长期)**
- ⏳ 定期review测试代码
- ⏳ 优化测试性能
- ⏳ 补充新功能测试

### 7.2 测试编写规范

**命名规范**:
```
Test[FunctionName]_[Scenario]_[ExpectedResult]
```

**文件组织**:
```
service/user/user_service.go
service/user/user_service_test.go  // 与源文件同目录
```

**测试结构**:
- 使用Table-Driven模式处理多场景
- 使用AAA模式组织测试逻辑
- 每个测试只验证一个功能点

---

## 8. 监控和报告

### 8.1 测试指标

**核心指标**:
- 测试通过率: 目标100%
- 代码覆盖率: 目标80%
- 测试执行时间: < 2分钟
- 测试稳定性: 无随机失败

**趋势监控**:
- 每周覆盖率趋势
- 测试数量增长
- 失败测试分析

### 8.2 覆盖率报告

**生成报告**:
```bash
# 生成HTML报告
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out -o coverage.html

# 查看总体覆盖率
go tool cover -func=coverage.out | grep total
```

**报告内容**:
- 各模块覆盖率
- 未覆盖代码行
- 覆盖率趋势

---

## 9. 最佳实践

### 9.1 测试编写原则

**FIRST原则**:
- **Fast**: 测试应该快速运行
- **Independent**: 测试之间相互独立
- **Repeatable**: 测试结果可重复
- **Self-validating**: 测试自动验证
- **Timely**: 及时编写测试

### 9.2 测试反模式

❌ **避免的反模式**:
- 测试依赖其他测试
- 测试实现细节而非行为
- 一个测试验证多个场景
- 过度使用Mock
- 测试代码重复

✅ **推荐实践**:
- 测试独立且可并行运行
- 测试公共接口和行为
- 拆分为多个独立测试
- 只Mock外部依赖
- 使用测试助手复用代码

---

## 10. 相关文档

- [测试最佳实践指南](./测试最佳实践指南.md)
- [自动化测试总体方案（简化版）](./自动化测试总体方案-简化版.md)
- [Service测试示例](../../test/examples/service_test_example.go)
- [Repository测试示例](../../test/examples/repository_test_example.go)
- [测试工具使用说明](../../test/README.md)
- [书城系统测试设计](./书城系统测试设计.md)

---

## 11. 附录

### 11.1 常用命令速查

```bash
# 测试相关
go test ./...                          # 运行所有测试
go test -v ./...                       # 详细输出
go test -short ./...                   # 跳过耗时测试
go test -race ./...                    # 竞态检测
go test -cover ./...                   # 覆盖率统计
go test -run TestName ./...            # 运行特定测试
go test -bench=. ./...                 # 运行基准测试

# 覆盖率相关
go test -coverprofile=coverage.out     # 生成覆盖率文件
go tool cover -html=coverage.out       # 查看HTML报告
go tool cover -func=coverage.out       # 查看函数覆盖率

# 性能相关
go test -bench=. -cpuprofile=cpu.prof  # CPU性能分析
go test -bench=. -memprofile=mem.prof  # 内存性能分析
go tool pprof cpu.prof                 # 查看性能分析
```

### 11.2 测试工具安装

```bash
# gotests - 测试代码生成
go install github.com/cweill/gotests/gotests@latest

# mockgen - Mock代码生成
go install github.com/golang/mock/mockgen@latest

# golangci-lint - 代码质量检查
go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
```

---

**文档维护**: 青羽后端架构团队  
**最后更新**: 2025-10-17  
**版本**: v2.0
