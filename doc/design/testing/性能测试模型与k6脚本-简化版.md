# 性能测试模型与k6脚本（简化版）

> 适用于青羽写作后端项目的轻量级性能测试方案

## 1. 什么时候需要性能测试？

### 当前阶段建议：⏸️ **暂不实施**

**理由：**
- 项目处于功能开发阶段
- 用户规模较小
- 功能稳定性优先于性能优化
- 性能测试投入产出比低

### 推荐实施时机：

✅ **以下情况出现时再考虑：**
1. 核心功能开发完成（功能稳定）
2. 准备正式上线
3. 用户反馈性能问题
4. 预期用户量快速增长
5. 进行重大架构调整前

## 2. 简化版性能测试方案

### 2.1 关键性能指标

```
响应时间：
- P95 < 200ms  (95%的请求在200ms内完成)
- P99 < 500ms  (99%的请求在500ms内完成)

吞吐量：
- QPS > 100 (每秒处理100个请求)

成功率：
- 成功率 > 99%

并发能力：
- 支持100并发用户
```

### 2.2 测试场景（仅测试核心功能）

```
场景1: 用户认证
- 用户注册
- 用户登录
- Token验证

场景2: 文档操作
- 创建文档
- 保存文档
- 读取文档列表

场景3: AI功能（最重要）
- AI文本生成
- 流式响应
```

## 3. k6脚本示例

### 3.1 安装k6

```bash
# Windows (使用Chocolatey)
choco install k6

# 或者下载安装包
# https://k6.io/docs/getting-started/installation/
```

### 3.2 基础测试脚本

```javascript
// test/performance/user_login_test.js
import http from 'k6/http';
import { check, sleep } from 'k6';

// 测试配置
export const options = {
  stages: [
    { duration: '30s', target: 10 },  // 预热：30秒到达10用户
    { duration: '1m', target: 50 },   // 负载：1分钟到达50用户
    { duration: '30s', target: 0 },   // 降压：30秒降到0用户
  ],
  thresholds: {
    http_req_duration: ['p(95)<200'],  // 95%请求小于200ms
    http_req_failed: ['rate<0.01'],    // 失败率小于1%
  },
};

const BASE_URL = 'http://localhost:8080';

// 测试场景
export default function () {
  // 1. 用户登录
  const loginPayload = JSON.stringify({
    email: 'test@example.com',
    password: 'password123',
  });

  const loginRes = http.post(`${BASE_URL}/api/v1/user/login`, loginPayload, {
    headers: { 'Content-Type': 'application/json' },
  });

  // 验证响应
  check(loginRes, {
    'login status is 200': (r) => r.status === 200,
    'login returns token': (r) => r.json('token') !== undefined,
  });

  // 模拟用户思考时间
  sleep(1);

  // 2. 获取文档列表（使用登录token）
  const token = loginRes.json('token');
  const headers = {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`,
  };

  const docsRes = http.get(`${BASE_URL}/api/v1/documents`, { headers });

  check(docsRes, {
    'docs status is 200': (r) => r.status === 200,
  });

  sleep(1);
}
```

### 3.3 压力测试脚本

```javascript
// test/performance/stress_test.js
import http from 'k6/http';
import { check } from 'k6';

export const options = {
  stages: [
    { duration: '2m', target: 100 },   // 2分钟到达100用户
    { duration: '5m', target: 100 },   // 维持100用户5分钟
    { duration: '2m', target: 200 },   // 2分钟到达200用户
    { duration: '5m', target: 200 },   // 维持200用户5分钟
    { duration: '2m', target: 0 },     // 降压
  ],
};

const BASE_URL = 'http://localhost:8080';

export default function () {
  const res = http.get(`${BASE_URL}/api/v1/health`);
  check(res, { 'status is 200': (r) => r.status === 200 });
}
```

### 3.4 AI功能测试脚本

```javascript
// test/performance/ai_generation_test.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  stages: [
    { duration: '1m', target: 10 },   // AI接口并发不宜过高
    { duration: '3m', target: 10 },
    { duration: '1m', target: 0 },
  ],
  thresholds: {
    http_req_duration: ['p(95)<5000'], // AI请求允许较长响应时间
  },
};

const BASE_URL = 'http://localhost:8080';
const TOKEN = 'your_test_token_here';

export default function () {
  const payload = JSON.stringify({
    prompt: '写一段关于春天的描述',
    model: 'gpt-3.5-turbo',
  });

  const res = http.post(`${BASE_URL}/api/v1/ai/generate`, payload, {
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${TOKEN}`,
    },
    timeout: '30s', // AI请求设置较长超时
  });

  check(res, {
    'status is 200': (r) => r.status === 200,
    'has content': (r) => r.json('content') !== undefined,
  });

  sleep(3); // AI请求间隔较长
}
```

## 4. 运行测试

### 4.1 基本命令

```bash
# 运行测试
k6 run test/performance/user_login_test.js

# 查看详细输出
k6 run --out json=results.json test/performance/user_login_test.js

# 使用环境变量
k6 run -e BASE_URL=http://localhost:8080 test/performance/user_login_test.js
```

### 4.2 查看结果

```bash
# k6运行后会显示摘要：
     ✓ login status is 200
     ✓ login returns token

     http_req_duration..............: avg=150ms min=100ms med=145ms max=250ms p(95)=180ms
     http_req_failed................: 0.00%
     http_reqs......................: 5000
     iterations.....................: 5000
     vus............................: 50
     vus_max........................: 50
```

## 5. 性能基线记录

### 5.1 建立基线

当首次运行性能测试时，记录关键指标作为基线：

```markdown
# 性能基线记录表

| 测试日期 | 场景 | 并发数 | P95响应时间 | QPS | 成功率 | 备注 |
|---------|------|--------|------------|-----|--------|------|
| 2025-10-01 | 用户登录 | 50 | 180ms | 120 | 99.9% | 初始基线 |
| 2025-10-01 | 文档创建 | 50 | 220ms | 100 | 99.5% | 初始基线 |
| 2025-10-01 | AI生成 | 10 | 3500ms | 8 | 98% | 初始基线 |
```

### 5.2 性能监控

在运行性能测试时，同时监控服务器指标：

```bash
# CPU使用率
# 内存使用率
# 数据库连接数
# MongoDB响应时间
# Redis命中率
```

## 6. 何时触发性能优化？

### 6.1 性能劣化指标

```
⚠️ 警告：以下情况需要关注性能
- P95响应时间 > 300ms
- 成功率 < 99%
- CPU使用率持续 > 70%
- 内存使用持续增长

🚨 严重：以下情况需要立即优化
- P95响应时间 > 1s
- 成功率 < 95%
- 系统出现错误或超时
```

## 7. 快速性能诊断

### 7.1 常见性能问题

```
问题：响应时间慢
可能原因：
□ 数据库查询慢（缺少索引）
□ N+1查询问题
□ 外部API调用慢
□ 未使用缓存

问题：吞吐量低
可能原因：
□ 数据库连接池太小
□ 并发处理能力不足
□ 资源竞争（锁）

问题：成功率低
可能原因：
□ 超时设置不合理
□ 资源不足（内存、连接）
□ 错误处理不当
```

### 7.2 快速优化检查清单

```
□ 数据库索引是否合理？
□ 是否使用了缓存（Redis）？
□ 数据库连接池配置是否合理？
□ 是否有慢查询？
□ 外部API是否有超时和重试机制？
□ 是否有内存泄漏？
```

## 8. 实施计划建议

### 阶段0: 当前阶段（不实施）
```
✓ 专注于功能开发
✓ 确保代码质量
✓ 建立单元测试
```

### 阶段1: 准备上线前（1周）
```
□ 安装k6工具
□ 编写核心场景测试脚本
□ 运行基础性能测试
□ 记录性能基线
```

### 阶段2: 上线后（持续）
```
□ 定期运行性能测试（每次重大更新前）
□ 监控生产环境性能指标
□ 对比性能基线，发现劣化
```

### 阶段3: 性能优化（按需）
```
□ 分析性能瓶颈
□ 实施优化措施
□ 验证优化效果
□ 更新性能基线
```

## 9. 最小化性能测试方案

**如果时间紧张，最少做这些：**

```javascript
// minimal_test.js - 最简性能测试
import http from 'k6/http';
import { check } from 'k6';

export const options = {
  vus: 50,              // 50个虚拟用户
  duration: '2m',       // 持续2分钟
};

export default function () {
  // 测试最关键的API
  const res = http.get('http://localhost:8080/api/v1/documents');
  check(res, {
    'is status 200': (r) => r.status === 200,
    'response time < 200ms': (r) => r.timings.duration < 200,
  });
}
```

```bash
# 运行最小化测试
k6 run minimal_test.js

# 只要看到：
# ✓ is status 200
# ✓ response time < 200ms
# http_req_failed: 0.00%
# 就说明基本性能OK
```

## 10. 参考资源

- [k6官方文档](https://k6.io/docs/)
- [k6测试类型](https://k6.io/docs/test-types/introduction/)
- [k6示例脚本](https://k6.io/docs/examples/)

---

## 总结

**对于青羽项目：**

❌ **现在不需要：**
- 详细的性能测试计划
- 复杂的测试场景
- 持续的性能监控

✅ **上线前需要：**
- 简单的k6脚本（上面的示例足够）
- 基本性能指标验证
- 记录性能基线

⏰ **遇到问题时：**
- 用性能测试定位瓶颈
- 验证优化效果
- 防止性能劣化

**核心原则：** 够用就好，不要过度设计 🎯
