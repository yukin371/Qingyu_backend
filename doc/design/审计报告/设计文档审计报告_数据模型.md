# 设计文档审计报告 - 数据模型层

> **审计日期**: 2025-10-21  
> **审计范围**: 全部模块（排除AI模块）  
> **审计方法**: 自底向上代码审计，从实现反推设计文档

---

## 审计概要

### 审计统计

| 统计项 | 数量 |
|--------|------|
| 模型文件总数 | 39 |
| 核心数据模型数量 | ~60+ |
| 已有设计文档 | 部分 |
| 缺失设计文档 | 大部分 |
| 设计文档完整性 | 约30% |

### 审计发现总结

**关键发现**：
1. ✅ **四层架构已实现**：Project-Node-Document-DocumentContent架构已有详细设计
2. ✅ **钱包系统已有设计**：Wallet相关模型已有完整设计文档
3. ❌ **缺少数据模型设计文档**：多数模块缺少详细的数据模型设计说明
4. ❌ **设定百科系统无设计**：Character/Location/Timeline等重要功能缺少设计
5. ❌ **阅读端数据模型设计缺失**：Ranking/Annotation/ReadingProgress等缺少设计
6. ❌ **审计模块设计缺失**：AuditRecord/SensitiveWord/ViolationRecord缺少详细设计

---

## 1. Audit模块（审核）

### 1.1 实现文件清单

| 文件路径 | 主要模型 | 设计文档状态 |
|---------|----------|-------------|
| `models/audit/audit_record.go` | `AuditRecord`, `ViolationDetail` | ❌ 缺失 |
| `models/audit/sensitive_word.go` | `SensitiveWord` | ❌ 缺失 |
| `models/audit/violation_record.go` | `ViolationRecord`, `UserViolationSummary` | ❌ 缺失 |

### 1.2 数据模型详情

#### AuditRecord（审核记录）
**实现位置**: `models/audit/audit_record.go`

**核心字段**:
- `TargetType`, `TargetID`: 审核对象类型和ID
- `Content`: 审核内容（考虑大文件存储策略）
- `Status`, `Result`: 审核状态和结果
- `RiskLevel`, `RiskScore`: 风险等级（1-5）和分数（0-100）
- `Violations`: 违规详情列表
- `ReviewerID`, `ReviewNote`: 复核人和复核说明
- `AppealStatus`: 申诉状态

**业务方法**:
- `IsApproved()`, `IsRejected()`: 审核结果判断
- `NeedsManualReview()`: 是否需要人工复核
- `CanAppeal()`: 是否可以申诉
- `AddViolation()`: 添加违规详情
- `CalculateRiskScore()`: 计算风险分数

**设计缺失**:
- ❌ 审核记录数据模型设计
- ❌ 审核工作流设计
- ❌ 风险评分算法设计

#### SensitiveWord（敏感词）
**实现位置**: `models/audit/sensitive_word.go`

**核心字段**:
- `Word`: 敏感词
- `Category`: 分类（政治、色情、暴力、赌博、毒品、邪教、侮辱、广告）
- `Level`: 严重等级（1-5）
- `Replacement`: 替换词
- `IsEnabled`: 是否启用
- `Source`, `CreatedBy`: 来源和创建人

**业务方法**:
- `IsHighRisk()`: 是否高风险（Level >= 3）
- `ShouldBan()`: 是否应该封号（Level >= 5）

**设计缺失**:
- ❌ 敏感词管理系统设计
- ❌ 敏感词分类体系设计
- ❌ 敏感词匹配算法设计

#### ViolationRecord（违规记录）
**实现位置**: `models/audit/violation_record.go`

**核心字段**:
- `UserID`: 用户ID
- `AuditRecordID`: 关联的审核记录ID
- `ViolationType`, `ViolationLevel`: 违规类型和等级
- `ViolationCount`: 违规次数（累计）
- `PenaltyType`, `PenaltyDuration`: 处罚类型和时长
- `IsPenalized`, `PenalizedAt`, `ExpiresAt`: 处罚状态和时间

**业务方法**:
- `IsActive()`: 处罚是否生效中
- `IsPermanentBan()`: 是否永久封号
- `ShouldEscalatePenalty()`: 是否应该升级处罚

**关联模型**:
- `UserViolationSummary`: 用户违规统计

**设计缺失**:
- ❌ 违规记录数据模型设计
- ❌ 处罚升级策略设计
- ❌ 用户违规统计设计

### 1.3 设计文档缺失清单

**P0 - 核心缺失**:
1. **审核系统数据模型设计** - 整合AuditRecord/SensitiveWord/ViolationRecord
2. **内容审核规则引擎设计** - 规则配置和执行
3. **敏感词管理系统设计** - 敏感词CRUD和匹配算法

**实现亮点**:
- ✅ 完整的审核状态机（pending → reviewing → approved/rejected/warning）
- ✅ 多维度风险评估（RiskLevel + RiskScore + Violations）
- ✅ 申诉机制支持
- ✅ 处罚升级策略（基于次数和等级）
- ✅ 用户违规统计聚合

---

## 2. Document模块（文档管理）

### 2.1 实现文件清单

| 文件路径 | 主要模型 | 设计文档状态 |
|---------|----------|-------------|
| `models/document/project.go` | `Project` | ✅ 已有（四层架构设计） |
| `models/document/node.go` | `Node` | ✅ 已有（四层架构设计） |
| `models/document/document.go` | `Document` | ✅ 已有（四层架构设计） |
| `models/document/document_content.go` | `DocumentContent` | ✅ 已有（四层架构设计） |
| `models/document/character.go` | `Character`, `CharacterRelation` | ❌ 缺失 |
| `models/document/location.go` | `Location`, `LocationRelation` | ❌ 缺失 |
| `models/document/timeline.go` | `Timeline`, `TimelineEvent`, `StoryTime` | ❌ 缺失 |
| `models/document/shortcut.go` | `ShortcutConfig`, `Shortcut` | ❌ 缺失 |
| `models/document/version.go` | `Version`, `Commit`, `FileRevision`, `FilePatch` | ⚠️ 部分缺失 |

### 2.2 数据模型详情

#### Project/Node/Document/DocumentContent（四层架构）
**实现位置**: `models/document/`

**设计文档状态**: ✅ **已有完整设计**
- 参考：`doc/design/core/项目四层架构CRUD设计.md`
- 覆盖：四层数据模型、GridFS集成、性能优化、API设计

#### Character（角色卡）
**实现位置**: `models/document/character.go`

**核心字段**:
- `Name`, `Alias`: 角色名称和别名
- `Summary`, `Traits`, `Background`: 摘要、性格标签、背景
- `AvatarURL`: 头像URL
- `PersonalityPrompt`, `SpeechPattern`, `CurrentState`: AI相关字段

**关联模型**:
- `CharacterRelation`: 角色关系（支持方向性）
  - `Type`: 朋友、家庭、敌人、恋人、盟友、其他
  - `Strength`: 关系强度（0-100）

**设计缺失**:
- ❌ 角色卡数据模型设计
- ❌ 角色关系图谱设计
- ❌ AI角色人格系统设计

#### Location（地点/场景）
**实现位置**: `models/document/location.go`

**核心字段**:
- `Name`, `Description`: 地点名称和描述
- `Climate`, `Culture`, `Geography`, `Atmosphere`: 气候、文化、地理、氛围
- `ParentID`: 支持层级结构
- `ImageURL`: 地点图片

**关联模型**:
- `LocationRelation`: 地点关系
  - `Type`: adjacent/contains/near/far/connected
  - `Distance`: 距离描述

**设计缺失**:
- ❌ 地点数据模型设计
- ❌ 地点层级结构设计
- ❌ 地点关系网络设计

#### Timeline（时间线）
**实现位置**: `models/document/timeline.go`

**核心字段**:
- `Name`, `Description`: 时间线名称和描述
- `StartTime`, `EndTime`: 起止时间（StoryTime类型）

**关联模型**:
- `TimelineEvent`: 时间线事件
  - `Title`, `Description`, `StoryTime`: 事件标题、描述、发生时间
  - `Duration`, `Impact`: 持续时间、影响
  - `Participants`, `LocationIDs`, `ChapterIDs`: 参与角色、相关地点、相关章节
  - `EventType`: plot/character/world/background/milestone
  - `Importance`: 重要性等级（1-10）
- `StoryTime`: 故事时间
  - 支持Year/Month/Day/Hour/Minute
  - 支持Era（纪元）、Season（季节）
  - 支持Description（时间描述）

**设计缺失**:
- ❌ 时间线数据模型设计
- ❌ 时间线事件管理设计
- ❌ 故事时间系统设计

#### Shortcut（快捷键配置）
**实现位置**: `models/document/shortcut.go`

**核心字段**:
- `UserID`: 用户ID
- `Shortcuts`: 快捷键映射（map[string]Shortcut）

**Shortcut字段**:
- `Action`, `Key`, `Description`, `Category`: 操作、按键、描述、分类
- `IsCustom`: 是否自定义

**预定义快捷键**:
- 文件操作：save, save_all, new_document, close_document
- 编辑操作：undo, redo, cut, copy, paste, select_all, find, replace
- 格式化：bold, italic, underline, strikethrough, heading1-3
- 段落：indent, outdent, bullet_list, ordered_list, blockquote
- 插入：insert_link, insert_image, insert_table, insert_code
- 视图：toggle_sidebar, toggle_preview, toggle_fullscreen, zoom_in/out/reset

**设计缺失**:
- ❌ 快捷键系统设计
- ❌ 快捷键冲突检测设计
- ❌ 快捷键自定义设计

#### Version（版本管理）
**实现位置**: `models/document/version.go`

**新架构模型** - `Version`:
- `DocumentID`, `VersionNum`: 文档ID、版本号
- `Content`, `GridFSID`: 内容/GridFS ID（大文件）
- `ContentType`, `WordCount`: 内容类型、字数
- `Comment`, `CreatedBy`: 版本说明、创建人
- `IsAutoSave`: 是否自动保存

**旧架构模型**（兼容保留）:
- `Commit`: 批量提交
- `FileRevision`: 文件修订记录
- `FilePatch`: 候选变更（补丁）
- `ConflictInfo`: 冲突信息

**设计缺失**:
- ⚠️ **新架构版本管理设计** - Version模型的详细设计
- ⚠️ **版本对比和回滚设计**
- ⚠️ **自动保存策略设计**

### 2.3 设计文档缺失清单

**P0 - 核心缺失**:
1. **设定百科数据模型详细设计** - Character/Location/Timeline整合设计
2. **版本管理详细设计** - 新架构Version模型的完整设计
3. **快捷键系统设计** - 快捷键配置和冲突检测

**实现亮点**:
- ✅ 角色关系图谱（方向性、强度）
- ✅ 地点层级结构（ParentID）
- ✅ 故事时间系统（灵活的时间表示）
- ✅ 时间线事件关联（角色、地点、章节）
- ✅ 快捷键分类管理
- ✅ 版本GridFS大文件支持

---

## 3. Reading模块（阅读端）

### 3.1 实现文件清单

| 子模块 | 文件路径 | 主要模型 | 设计文档状态 |
|--------|---------|----------|-------------|
| **Bookstore** | | | |
| | `models/reading/bookstore/banner.go` | `Banner` | ❌ 缺失 |
| | `models/reading/bookstore/book.go` | `Book` | ⚠️ 部分 |
| | `models/reading/bookstore/book_detail.go` | `BookDetail` | ⚠️ 部分 |
| | `models/reading/bookstore/book_rating.go` | `BookRating` | ❌ 缺失 |
| | `models/reading/bookstore/book_statistics.go` | `BookStatistics` | ❌ 缺失 |
| | `models/reading/bookstore/category.go` | `Category` | ⚠️ 部分 |
| | `models/reading/bookstore/chapter.go` | `Chapter` | ⚠️ 部分 |
| | `models/reading/bookstore/ranking.go` | `Ranking` | ❌ 缺失 |
| **Reader** | | | |
| | `models/reading/reader/annotation.go` | `Annotation` | ❌ 缺失 |
| | `models/reading/reader/chapter.go` | `ReaderChapter` | ⚠️ 部分 |
| | `models/reading/reader/readingprogress.go` | `ReadingProgress` | ❌ 缺失 |
| | `models/reading/reader/readingsettings.go` | `ReadingSettings` | ❌ 缺失 |

### 3.2 数据模型详情（Bookstore子模块）

#### Banner（轮播图）
**实现需要验证**: `models/reading/bookstore/banner.go`

**设计缺失**:
- ❌ 轮播图管理数据模型设计

#### Book/BookDetail（书籍）
**实现位置**: `models/reading/bookstore/book.go`, `book_detail.go`

**设计文档状态**: ⚠️ **部分已有**
- 参考：`doc/api/bookstore/书城API文档.md`（API文档，非数据模型设计）

**设计缺失**:
- ❌ 书籍数据模型详细设计
- ❌ 书籍元数据设计

#### BookRating（评分系统）
**实现需要验证**: `models/reading/bookstore/book_rating.go`

**设计缺失**:
- ❌ 评分系统数据模型设计
- ❌ 评分聚合算法设计

#### BookStatistics（书籍统计）
**实现需要验证**: `models/reading/bookstore/book_statistics.go`

**设计缺失**:
- ❌ 书籍统计数据模型设计
- ❌ 统计指标定义

#### Chapter（章节）
**实现位置**: `models/reading/bookstore/chapter.go`

**设计文档状态**: ⚠️ **部分已有**

**设计缺失**:
- ❌ 章节数据模型详细设计
- ❌ 章节内容存储策略设计

#### Ranking（榜单）
**实现需要验证**: `models/reading/bookstore/ranking.go`

**设计缺失**:
- ❌ 榜单系统数据模型设计
- ❌ 榜单更新策略设计
- ❌ 榜单调度设计

### 3.3 数据模型详情（Reader子模块）

#### Annotation（标注）
**实现需要验证**: `models/reading/reader/annotation.go`

**设计缺失**:
- ❌ 标注系统数据模型设计
- ❌ 标注位置定位设计
- ❌ 标注缓存策略设计

#### ReadingProgress（阅读进度）
**实现需要验证**: `models/reading/reader/readingprogress.go`

**设计缺失**:
- ❌ 阅读进度数据模型设计
- ❌ 进度同步策略设计

#### ReadingSettings（阅读设置）
**实现需要验证**: `models/reading/reader/readingsettings.go`

**设计缺失**:
- ❌ 阅读设置数据模型设计
- ❌ 设置同步设计

### 3.4 设计文档缺失清单

**P0 - 核心缺失**:
1. **榜单系统详细设计** - Ranking数据模型和调度
2. **评分系统设计** - BookRating数据模型和算法
3. **标注系统设计** - Annotation数据模型和缓存
4. **阅读器数据模型设计** - ReadingProgress/ReadingSettings详细设计

---

## 4. Recommendation模块（推荐）

### 4.1 实现文件清单

| 文件路径 | 主要模型 | 设计文档状态 |
|---------|----------|-------------|
| `models/recommendation/reco/behavior.go` | `Behavior` | ⚠️ 部分 |
| `models/recommendation/reco/item.go` | `Item` | ⚠️ 部分 |
| `models/recommendation/reco/profile.go` | `Profile` | ⚠️ 部分 |

### 4.2 数据模型详情

**设计文档状态**: ⚠️ **部分已有**
- 参考：`doc/design/reader/推荐算法设计.md`（算法设计，数据模型不详细）

**设计缺失**:
- ❌ 用户行为数据模型详细设计
- ❌ 推荐项数据模型详细设计
- ❌ 用户画像数据模型详细设计

---

## 5. Shared模块（共享服务）

### 5.1 实现文件清单

| 子模块 | 文件路径 | 主要模型 | 设计文档状态 |
|--------|---------|----------|-------------|
| **Admin** | `models/shared/admin/admin.go` | `Admin` | ❌ 缺失 |
| **Auth** | `models/shared/auth/role.go` | `Role` | ⚠️ 部分 |
| | `models/shared/auth/session.go` | `Session` | ❌ 缺失 |
| **Messaging** | `models/shared/messaging/message.go` | `Message` | ❌ 缺失 |
| **Recommendation** | `models/shared/recommendation/recommendation.go` | `Recommendation` | ⚠️ 部分 |
| **Storage** | `models/shared/storage/file.go` | `File` | ❌ 缺失 |
| **Wallet** | `models/shared/wallet/wallet.go` | `Wallet` | ✅ 已有 |

### 5.2 数据模型详情

#### Admin（管理员）
**实现需要验证**: `models/shared/admin/admin.go`

**设计缺失**:
- ❌ 管理员数据模型设计

#### Role（角色权限）
**实现位置**: `models/shared/auth/role.go`

**设计文档状态**: ⚠️ **部分已有**
- 参考：中间件中有权限检查逻辑，但无完整RBAC设计

**设计缺失**:
- ❌ 角色权限系统详细设计（RBAC）
- ❌ 权限模型数据设计

#### Session（会话管理）
**实现需要验证**: `models/shared/auth/session.go`

**设计缺失**:
- ❌ 会话管理系统设计
- ❌ 会话数据模型设计

#### Message（消息）
**实现需要验证**: `models/shared/messaging/message.go`

**设计缺失**:
- ❌ 消息数据模型设计
- ❌ 消息通知系统设计

#### File（文件存储）
**实现需要验证**: `models/shared/storage/file.go`

**设计缺失**:
- ❌ 文件存储数据模型设计
- ❌ 文件元数据设计

#### Wallet（钱包）
**实现位置**: `models/shared/wallet/wallet.go`

**设计文档状态**: ✅ **已有完整设计**
- 参考：`doc/design/shared/钱包服务设计.md`

### 5.3 设计文档缺失清单

**P0 - 核心缺失**:
1. **角色权限系统设计** - RBAC详细设计
2. **会话管理系统设计** - Session数据模型和生命周期
3. **消息通知系统详细设计** - Message数据模型和推送机制

---

## 6. Stats模块（统计）

### 6.1 实现文件清单

| 文件路径 | 主要模型 | 设计文档状态 |
|---------|----------|-------------|
| `models/stats/book_stats.go` | `BookStats` | ❌ 缺失 |
| `models/stats/chapter_stats.go` | `ChapterStats` | ❌ 缺失 |
| `models/stats/reader_behavior.go` | `ReaderBehavior` | ❌ 缺失 |

### 6.2 数据模型详情

**设计缺失**:
- ❌ 书籍统计数据模型设计
- ❌ 章节统计数据模型设计
- ❌ 读者行为数据模型设计
- ❌ 统计分析系统设计

---

## 7. Users模块（用户）

### 7.1 实现文件清单

| 文件路径 | 主要模型 | 设计文档状态 |
|---------|----------|-------------|
| `models/users/user.go` | `User` | ⚠️ 部分 |
| `models/users/role.go` | `Role` | ⚠️ 部分 |
| `models/users/user_filter.go` | `UserFilter` | ❌ 缺失 |

### 7.2 数据模型详情

**设计文档状态**: ⚠️ **部分已有**
- 参考：`doc/api/system/用户管理API文档.md`（API文档）
- 参考：项目开发规则中有User示例，但不完整

**设计缺失**:
- ❌ 用户数据模型完整设计
- ❌ 用户过滤器设计说明

---

## 审计总结

### 设计文档完整性评分

| 模块 | 完整性 | 评分 | 说明 |
|------|--------|------|------|
| Audit | ❌ | 0% | 完全缺失，需新建设计 |
| Document（四层架构） | ✅ | 100% | 已有完整设计 |
| Document（设定百科） | ❌ | 0% | Character/Location/Timeline缺失 |
| Document（版本管理） | ⚠️ | 40% | 旧架构有设计，新架构需补充 |
| Document（快捷键） | ❌ | 0% | 完全缺失 |
| Reading（Bookstore） | ⚠️ | 20% | API文档存在，数据模型设计缺失 |
| Reading（Reader） | ❌ | 0% | 标注/进度/设置缺失 |
| Recommendation | ⚠️ | 30% | 算法设计有，数据模型不详细 |
| Shared（Wallet） | ✅ | 100% | 已有完整设计 |
| Shared（Auth/Messaging） | ⚠️ | 20% | 部分实现，设计不完整 |
| Stats | ❌ | 0% | 完全缺失 |
| Users | ⚠️ | 40% | API文档有，数据模型设计不完整 |
| **总体评分** | **⚠️** | **~30%** | 大部分模块缺少详细数据模型设计 |

### 优先级P0缺失文档清单

基于业务重要性和使用频率，以下设计文档为P0优先级：

1. **审核系统数据模型设计** (Audit)
   - `AuditRecord` / `SensitiveWord` / `ViolationRecord`
   - 审核流程、风险评分、处罚策略

2. **设定百科数据模型详细设计** (Document)
   - `Character` / `Location` / `Timeline`
   - 角色关系图谱、地点层级、时间线事件

3. **版本管理详细设计** (Document)
   - 新架构`Version`模型
   - GridFS集成、自动保存、版本对比

4. **快捷键系统设计** (Document)
   - `ShortcutConfig` / `Shortcut`
   - 冲突检测、自定义配置

5. **榜单系统详细设计** (Reading)
   - `Ranking`数据模型
   - 榜单更新策略、调度设计

6. **评分系统设计** (Reading)
   - `BookRating`数据模型
   - 评分聚合算法

7. **标注系统设计** (Reading)
   - `Annotation`数据模型
   - 位置定位、缓存策略

8. **阅读器数据模型设计** (Reading)
   - `ReadingProgress` / `ReadingSettings`
   - 进度同步、设置同步

9. **角色权限系统设计** (Shared)
   - RBAC详细设计
   - `Role`数据模型

10. **会话管理系统设计** (Shared)
    - `Session`数据模型
    - 会话生命周期

11. **消息通知系统详细设计** (Shared)
    - `Message`数据模型
    - 推送机制

12. **统计分析系统设计** (Stats)
    - `BookStats` / `ChapterStats` / `ReaderBehavior`
    - 统计指标、聚合策略

### 实现与设计的差距

**主要差距**：
1. **实现先行，设计缺失**：多数模块已有实现代码，但缺少对应的设计文档
2. **API文档替代数据模型设计**：部分模块只有API文档，没有数据模型详细设计
3. **算法设计替代数据模型设计**：如推荐模块，有算法设计但数据模型不详细
4. **设计文档不及时更新**：如版本管理，旧架构有设计但新架构无设计

**建议**：
1. 优先补充P0缺失文档（12份）
2. 每个数据模型设计应包含：
   - 为什么需要这个模型（业务背景）
   - 数据结构定义（字段说明、类型、约束）
   - 索引策略（查询优化）
   - 数据关系（与其他模型的关联）
   - 实现参考（实际代码文件路径）
3. 设计文档应与v2.1架构对齐（模块定位、事件发布等）

---

## 下一步行动

1. ✅ **Models层审计完成** - 本报告
2. ⏭️ **Service层审计** - 审计业务服务实现
3. ⏭️ **API层审计** - 审计接口实现
4. ⏭️ **补充P0设计文档** - 创建12份核心设计文档
5. ⏭️ **生成总报告和对照表** - 汇总所有审计发现

---

**审计人**: AI Agent  
**审计完成时间**: 2025-10-21 18:30

