# ç¨¿è´¹ç»“ç®—ç³»ç»Ÿè®¾è®¡ (Monetization Module)

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
> **åˆ›å»ºæ—¶é—´**: 2025-10-21  
> **æ›´æ–°**: æ˜ç¡®ä¸Wallet Serviceçš„èŒè´£åˆ†ç¦»

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è®¾è®¡ç¨¿è´¹ç»“ç®—ç³»ç»Ÿï¼ˆMonetization Serviceï¼‰ï¼Œä¸“æ³¨äºä¸šåŠ¡é€»è¾‘å±‚çš„æ”¶ç›Šè®¡ç®—ã€åˆ†æˆæ¯”ä¾‹å’Œåˆçº¦ç®¡ç†ï¼Œä¸Wallet Serviceåä½œå®Œæˆèµ„é‡‘æ“ä½œã€‚

---

## ä¸€ã€æ¨¡å—èŒè´£

### 1.1 Monetization Service (ä¸šåŠ¡é€»è¾‘å±‚)

**èŒè´£**ï¼š
- âœ… æ”¶ç›Šè®¡ç®—ï¼ˆè®¢é˜…ã€æ‰“èµã€å¹¿å‘Šã€ç‰ˆæƒï¼‰
- âœ… åˆ†æˆæ¯”ä¾‹ç®¡ç†
- âœ… åˆçº¦ç®¡ç†
- âœ… è´¢åŠ¡æŠ¥è¡¨ç”Ÿæˆ
- âœ… æç°ç”³è¯·æµç¨‹ï¼ˆä¸šåŠ¡å®¡æ ¸ï¼‰
- âœ… ç¨åŠ¡å¤„ç†

**ä¸è´Ÿè´£**ï¼š
- âŒ ç›´æ¥ä¿®æ”¹è´¦æˆ·ä½™é¢
- âŒ äº¤æ˜“è®°å½•ç®¡ç†
- âŒ èµ„é‡‘é£æ§

### 1.2 ä¸Wallet Serviceåä½œ

```
Monetization Service (ä¸šåŠ¡å±‚)
  â”œâ”€ è®¡ç®—æ”¶ç›Šé‡‘é¢
  â”œâ”€ åº”ç”¨åˆ†æˆæ¯”ä¾‹
  â”œâ”€ å®¡æ ¸æç°ç”³è¯·
  â””â”€ è°ƒç”¨Wallet API â”€â”€â”
                       â”‚
                       â–¼
Wallet Service (æŠ€æœ¯è´¦æœ¬å±‚)
  â”œâ”€ å¢åŠ /æ‰£é™¤ä½™é¢ï¼ˆå”¯ä¸€å…¥å£ï¼‰
  â”œâ”€ è®°å½•äº¤æ˜“
  â”œâ”€ é£æ§æ£€æŸ¥
  â””â”€ å¤„ç†æç°ï¼ˆæŠ€æœ¯æ“ä½œï¼‰
```

---

## äºŒã€æ•°æ®æ¨¡å‹

### 2.1 Revenue (æ”¶ç›Šè®°å½•)

```go
type Revenue struct {
    ID          string    `bson:"_id" json:"id"`
    AuthorID    string    `bson:"author_id" json:"authorId"`
    BookID      string    `bson:"book_id" json:"bookId"`
    ChapterID   string    `bson:"chapter_id,omitempty" json:"chapterId,omitempty"`
    Source      string    `bson:"source" json:"source"` // subscription, reward, ad, copyright
    Amount      float64   `bson:"amount" json:"amount"` // åŸå§‹é‡‘é¢
    ShareRatio  float64   `bson:"share_ratio" json:"shareRatio"` // åˆ†æˆæ¯”ä¾‹
    AuthorShare float64   `bson:"author_share" json:"authorShare"` // ä½œè€…å®é™…æ”¶å…¥
    Status      string    `bson:"status" json:"status"` // pending, settled
    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`
    SettledAt   *time.Time `bson:"settled_at,omitempty" json:"settledAt,omitempty"`
}
```

### 2.2 Contract (åˆçº¦)

```go
type Contract struct {
    ID                  string    `bson:"_id" json:"id"`
    AuthorID            string    `bson:"author_id" json:"authorId"`
    Type                string    `bson:"type" json:"type"` // standard, premium, exclusive
    ShareRatio          float64   `bson:"share_ratio" json:"shareRatio"` // 0-1
    MinWithdrawalAmount float64   `bson:"min_withdrawal_amount" json:"minWithdrawalAmount"`
    StartDate           time.Time `bson:"start_date" json:"startDate"`
    EndDate             *time.Time `bson:"end_date,omitempty" json:"endDate,omitempty"`
    Status              string    `bson:"status" json:"status"`
}
```

---

## ä¸‰ã€Serviceæ¥å£

```go
package monetization

type MonetizationService interface {
    // æ”¶ç›Šè®¡ç®—
    RecordRevenue(ctx context.Context, authorID, bookID, chapterID string, amount float64) error
    CalculateRevenue(ctx context.Context, authorID string, period Period) (*RevenueReport, error)
    
    // åˆ†æˆç®¡ç†
    GetShareConfig(ctx context.Context, authorID string) (*ShareConfig, error)
    
    // åˆçº¦ç®¡ç†
    GetContract(ctx context.Context, authorID string) (*Contract, error)
    CreateContract(ctx context.Context, contract *Contract) error
    
    // æç°ç”³è¯·ï¼ˆä¸šåŠ¡å±‚ï¼‰
    RequestWithdrawal(ctx context.Context, req *WithdrawalRequest) (*WithdrawalOrder, error)
    ApproveWithdrawal(ctx context.Context, orderID, adminID string) error
    
    // è´¢åŠ¡æŠ¥è¡¨
    GenerateFinancialReport(ctx context.Context, authorID string, period Period) (*FinancialReport, error)
    
    // äº‹ä»¶å¤„ç†
    OnChapterPurchased(ctx context.Context, event *ChapterPurchasedEvent) error
}
```

---

## å››ã€ä¸šåŠ¡æµç¨‹

### 4.1 ç”¨æˆ·è´­ä¹°ç« èŠ‚

```go
func (ms *MonetizationServiceImpl) OnChapterPurchased(ctx context.Context, event *ChapterPurchasedEvent) error {
    // 1. è·å–åˆçº¦å’Œåˆ†æˆæ¯”ä¾‹
    contract, _ := ms.GetContract(ctx, event.AuthorID)
    shareRatio := contract.ShareRatio
    
    // 2. è®¡ç®—ä½œè€…æ”¶ç›Š
    authorShare := event.Amount * shareRatio
    
    // 3. è®°å½•æ”¶ç›Š
    revenue := &Revenue{
        AuthorID:    event.AuthorID,
        BookID:      event.BookID,
        ChapterID:   event.ChapterID,
        Source:      "subscription",
        Amount:      event.Amount,
        ShareRatio:  shareRatio,
        AuthorShare: authorShare,
        Status:      "pending",
    }
    
    if err := ms.revenueRepo.Create(ctx, revenue); err != nil {
        return err
    }
    
    // 4. è°ƒç”¨Wallet Serviceå¢åŠ ä½œè€…ä½™é¢ï¼ˆå”¯ä¸€å…¥å£ï¼‰
    _, err := ms.walletService.Recharge(
        ctx,
        event.AuthorID,
        authorShare,
        fmt.Sprintf("chapter_revenue_%s", event.ChapterID),
    )
    
    if err != nil {
        // æ ‡è®°æ”¶ç›Šå¤±è´¥ï¼Œåç»­è¡¥å¿
        revenue.Status = "failed"
        ms.revenueRepo.Update(ctx, revenue)
        return err
    }
    
    // 5. æ ‡è®°æ”¶ç›Šå·²ç»“ç®—
    revenue.Status = "settled"
    now := time.Now()
    revenue.SettledAt = &now
    ms.revenueRepo.Update(ctx, revenue)
    
    return nil
}
```

### 4.2 ä½œè€…æç°

```go
func (ms *MonetizationServiceImpl) RequestWithdrawal(ctx context.Context, req *WithdrawalRequest) (*WithdrawalOrder, error) {
    // 1. ä¸šåŠ¡è§„åˆ™æ£€æŸ¥
    contract, _ := ms.GetContract(ctx, req.AuthorID)
    if req.Amount < contract.MinWithdrawalAmount {
        return nil, errors.New("æç°é‡‘é¢ä¸è¶³")
    }
    
    // 2. æŸ¥è¯¢Walletä½™é¢
    balance, _ := ms.walletService.GetBalance(ctx, req.AuthorID)
    if balance < req.Amount {
        return nil, errors.New("ä½™é¢ä¸è¶³")
    }
    
    // 3. é£æ§æ£€æŸ¥ï¼ˆWalletæä¾›ï¼‰
    passed, _ := ms.walletService.CheckRiskControl(ctx, req.AuthorID, req.Amount)
    if !passed {
        return nil, errors.New("é£æ§æœªé€šè¿‡")
    }
    
    // 4. è®¡ç®—ç¨è´¹
    tax := ms.CalculateTax(ctx, req.Amount, req.AuthorID)
    
    // 5. åˆ›å»ºæç°è®¢å•
    order := &WithdrawalOrder{
        ID:        uuid.New().String(),
        AuthorID:  req.AuthorID,
        Amount:    req.Amount,
        Fee:       req.Amount * 0.01,
        Tax:       tax,
        NetAmount: req.Amount - req.Amount*0.01 - tax,
        Status:    "pending",
    }
    
    ms.orderRepo.Create(ctx, order)
    
    // 6. è°ƒç”¨Wallet Serviceå†»ç»“èµ„é‡‘
    if err := ms.walletService.FreezeForWithdrawal(ctx, req.AuthorID, req.Amount, order.ID); err != nil {
        return nil, err
    }
    
    return order, nil
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**åˆ›å»ºæ—¶é—´**: 2025-10-21

