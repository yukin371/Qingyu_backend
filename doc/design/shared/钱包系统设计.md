# 钱包系统设计

## 1. 需求概述

### 1.1 功能描述
钱包系统是青羽平台的核心支付服务，为用户提供虚拟货币管理、充值提现、消费记录、收益分成等功能。系统支持多种支付方式，确保资金安全，为阅读付费、作者收益、平台分成等业务场景提供完整的资金流转解决方案。

### 1.2 业务价值
- **资金管理**：为用户提供安全可靠的虚拟货币钱包服务
- **支付体验**：支持多种充值方式，提升用户支付体验
- **收益分配**：为作者提供透明的收益结算和提现服务
- **风控保障**：完善的风控体系，保障资金安全

### 1.3 用户场景
- 读者充值青羽币进行内容付费阅读
- 作者通过作品获得收益，提现到银行账户
- 平台根据分成规则自动分配收益
- 用户查看钱包余额、交易记录和收益明细

### 1.4 功能边界
- **包含功能**：钱包管理、充值提现、交易记录、收益分成、风控监控
- **不包含功能**：第三方支付接口对接、银行卡绑定、实名认证

## 2. 架构设计

### 2.1 整体架构
```
┌─────────────────────────────────────────────────────────┐
│                    客户端层                              │
│  阅读端 Web/App + 写作端 Web/App + 管理后台             │
├─────────────────────────────────────────────────────────┤
│                    API网关层                            │
│  统一入口 + 路由分发 + 限流熔断                         │
├─────────────────────────────────────────────────────────┤
│                   钱包服务层                            │
│  钱包管理 + 交易处理 + 收益分成 + 风控监控               │
├─────────────────────────────────────────────────────────┤
│                   外部服务层                            │
│  支付网关 + 银行接口 + 短信服务 + 风控服务               │
├─────────────────────────────────────────────────────────┤
│                    数据存储层                            │
│  MongoDB(钱包数据) + Redis(缓存) + MQ(异步处理)         │
└─────────────────────────────────────────────────────────┘
```

### 2.2 模块划分
- **钱包管理模块**：钱包创建、余额查询、状态管理
- **交易处理模块**：充值、提现、消费、转账交易处理
- **收益分成模块**：作者收益计算、平台分成、自动结算
- **风控监控模块**：异常交易检测、风险评估、限额控制

## 3. 详细设计

### 3.1 Router层设计
- **路由分组**：/api/v1/wallet
- **中间件**：身份认证、权限验证、限流、日志记录
- **路径规范**：RESTful风格，如 /wallet/balance, /wallet/transactions
- **参数处理**：JSON请求体、路径参数、查询参数验证

### 3.2 API层设计
- **接口定义**：钱包查询、充值提现、交易记录、收益查询接口
- **请求验证**：参数格式验证、业务规则验证、权限检查
- **响应格式**：统一的JSON响应结构，包含状态码、消息、数据
- **错误处理**：标准化错误码和错误信息，敏感信息脱敏

### 3.3 Service层设计
- **业务流程**：充值流程、提现流程、消费扣款、收益分成
- **数据处理**：金额计算、汇率转换、手续费计算
- **依赖服务**：支付网关、银行接口、短信服务、风控服务
- **异常处理**：业务异常统一处理和错误码映射
- **Repository交互**：通过Repository接口进行数据访问

### 3.4 Repository层设计
- **接口抽象**：WalletRepository、TransactionRepository、IncomeRepository
- **查询封装**：钱包查询、交易记录查询、收益统计查询
- **事务管理**：充值事务、提现事务、转账事务
- **缓存策略**：钱包余额缓存、热点数据缓存
- **异常处理**：数据库连接异常、查询异常统一处理
- **与Model关系**：Wallet、Transaction、Income模型的数据映射

### 3.5 Model层设计
- **数据模型**：Wallet、Transaction、Income、WithdrawRecord
- **约束规则**：用户钱包唯一、交易金额非负、状态枚举限制
- **验证逻辑**：金额格式验证、状态转换验证、业务规则验证
- **Repository接口**：定义数据访问方法签名

## 4. 数据设计

### 4.1 数据模型

#### 钱包模型 (Wallet)
```go
type Wallet struct {
    ID          string    `bson:"_id,omitempty" json:"id"`
    UserID      string    `bson:"user_id" json:"userId"`
    Balance     int64     `bson:"balance" json:"balance"`         // 余额(分)
    FrozenAmount int64    `bson:"frozen_amount" json:"frozenAmount"` // 冻结金额(分)
    TotalIncome int64     `bson:"total_income" json:"totalIncome"`   // 总收入(分)
    TotalExpense int64    `bson:"total_expense" json:"totalExpense"` // 总支出(分)
    Status      string    `bson:"status" json:"status"`           // active, frozen, closed
    Version     int64     `bson:"version" json:"version"`         // 乐观锁版本号
    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time `bson:"updated_at" json:"updatedAt"`
}
```

#### 交易记录模型 (Transaction)
```go
type Transaction struct {
    ID            string    `bson:"_id,omitempty" json:"id"`
    UserID        string    `bson:"user_id" json:"userId"`
    WalletID      string    `bson:"wallet_id" json:"walletId"`
    Type          string    `bson:"type" json:"type"`           // recharge, withdraw, consume, income
    Amount        int64     `bson:"amount" json:"amount"`       // 交易金额(分)
    Fee           int64     `bson:"fee" json:"fee"`             // 手续费(分)
    Status        string    `bson:"status" json:"status"`       // pending, success, failed, cancelled
    Description   string    `bson:"description" json:"description"`
    RelatedID     string    `bson:"related_id" json:"relatedId"` // 关联业务ID
    PaymentMethod string    `bson:"payment_method" json:"paymentMethod"` // alipay, wechat, bank
    ExternalID    string    `bson:"external_id" json:"externalId"`       // 外部交易ID
    CreatedAt     time.Time `bson:"created_at" json:"createdAt"`
    UpdatedAt     time.Time `bson:"updated_at" json:"updatedAt"`
}
```

#### 收益记录模型 (Income)
```go
type Income struct {
    ID          string    `bson:"_id,omitempty" json:"id"`
    UserID      string    `bson:"user_id" json:"userId"`
    BookID      string    `bson:"book_id" json:"bookId"`
    ChapterID   string    `bson:"chapter_id" json:"chapterId"`
    ReaderID    string    `bson:"reader_id" json:"readerId"`
    Amount      int64     `bson:"amount" json:"amount"`         // 收益金额(分)
    AuthorShare int64     `bson:"author_share" json:"authorShare"` // 作者分成(分)
    PlatformShare int64   `bson:"platform_share" json:"platformShare"` // 平台分成(分)
    SettleStatus string   `bson:"settle_status" json:"settleStatus"` // pending, settled
    SettledAt   time.Time `bson:"settled_at" json:"settledAt"`
    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`
}
```

#### 提现记录模型 (WithdrawRecord)
```go
type WithdrawRecord struct {
    ID          string    `bson:"_id,omitempty" json:"id"`
    UserID      string    `bson:"user_id" json:"userId"`
    Amount      int64     `bson:"amount" json:"amount"`         // 提现金额(分)
    Fee         int64     `bson:"fee" json:"fee"`               // 手续费(分)
    ActualAmount int64    `bson:"actual_amount" json:"actualAmount"` // 实际到账金额(分)
    BankAccount string    `bson:"bank_account" json:"bankAccount"`   // 银行账户
    BankName    string    `bson:"bank_name" json:"bankName"`         // 银行名称
    Status      string    `bson:"status" json:"status"`         // pending, processing, success, failed
    FailReason  string    `bson:"fail_reason" json:"failReason"`
    ProcessedAt time.Time `bson:"processed_at" json:"processedAt"`
    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time `bson:"updated_at" json:"updatedAt"`
}
```

### 4.2 数据关系
- Wallet 与 User：一对一关系，每个用户有一个钱包
- Transaction 与 Wallet：多对一关系，一个钱包有多个交易记录
- Income 与 User：多对一关系，一个用户有多个收益记录
- WithdrawRecord 与 User：多对一关系，一个用户有多个提现记录

### 4.3 索引策略
| 集合名称 | 索引字段 | 索引类型 | 说明 |
|---------|---------|---------|------|
| wallets | user_id | unique | 用户钱包唯一索引 |
| transactions | user_id, created_at | compound | 用户交易记录复合索引 |
| transactions | status, created_at | compound | 交易状态时间复合索引 |
| incomes | user_id, created_at | compound | 用户收益记录复合索引 |
| withdraw_records | user_id, created_at | compound | 用户提现记录复合索引 |

### 4.4 数据迁移
- 为所有现有用户创建钱包账户
- 初始化系统配置：手续费率、提现限额等
- 创建系统钱包用于平台收益

## 5. 接口设计

### 5.1 API概览

| 方法 | 路径 | 功能描述 | 权限要求 |
|-----|------|---------|---------|
| GET | /api/v1/wallet/balance | 查询钱包余额 | 用户认证 |
| POST | /api/v1/wallet/recharge | 钱包充值 | 用户认证 |
| POST | /api/v1/wallet/withdraw | 申请提现 | 用户认证 |
| GET | /api/v1/wallet/transactions | 交易记录查询 | 用户认证 |
| GET | /api/v1/wallet/incomes | 收益记录查询 | 用户认证 |
| POST | /api/v1/wallet/consume | 消费扣款 | 内部服务 |
| GET | /api/v1/wallet/statistics | 钱包统计信息 | 用户认证 |

### 5.2 请求与响应格式

#### 5.2.1 查询钱包余额 (GET /api/v1/wallet/balance)

**响应格式**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "balance": 10000,
    "frozenAmount": 500,
    "availableAmount": 9500,
    "totalIncome": 50000,
    "totalExpense": 40000,
    "currency": "CNY"
  }
}
```

#### 5.2.2 钱包充值 (POST /api/v1/wallet/recharge)

**请求参数**:
```json
{
  "amount": 10000,
  "paymentMethod": "alipay",
  "returnUrl": "https://app.qingyu.com/wallet/recharge/callback"
}
```

**响应格式**:
```json
{
  "code": 200,
  "message": "充值订单创建成功",
  "data": {
    "transactionId": "tx_123456789",
    "paymentUrl": "https://payment.gateway.com/pay?order=xxx",
    "qrCode": "data:image/png;base64,xxx",
    "expireTime": "2024-01-01T12:00:00Z"
  }
}
```

#### 5.2.3 申请提现 (POST /api/v1/wallet/withdraw)

**请求参数**:
```json
{
  "amount": 5000,
  "bankAccount": "6222021234567890",
  "bankName": "中国工商银行",
  "verifyCode": "123456"
}
```

**响应格式**:
```json
{
  "code": 200,
  "message": "提现申请提交成功",
  "data": {
    "withdrawId": "wd_123456789",
    "amount": 5000,
    "fee": 50,
    "actualAmount": 4950,
    "estimateArrivalTime": "2024-01-02T12:00:00Z"
  }
}
```

#### 5.2.4 交易记录查询 (GET /api/v1/wallet/transactions)

**请求参数**:
- page: 页码，默认1
- limit: 每页数量，默认20
- type: 交易类型，可选
- startDate: 开始日期，可选
- endDate: 结束日期，可选

**响应格式**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "total": 100,
    "page": 1,
    "limit": 20,
    "transactions": [
      {
        "id": "tx_123456789",
        "type": "recharge",
        "amount": 10000,
        "fee": 0,
        "status": "success",
        "description": "支付宝充值",
        "createdAt": "2024-01-01T10:00:00Z"
      }
    ]
  }
}
```

**状态码**:
- 200: 成功
- 400: 请求参数错误
- 401: 用户未认证
- 403: 权限不足
- 429: 请求过于频繁
- 500: 服务器错误

## 6. 安全设计

### 6.1 权限控制
- 用户只能操作自己的钱包，严格的用户身份验证
- 敏感操作需要短信验证码或支付密码
- 管理员权限分级，不同级别有不同操作权限
- API接口通过JWT Token进行身份认证

### 6.2 数据安全
- 金额数据使用分为单位存储，避免浮点数精度问题
- 敏感信息如银行账号进行加密存储
- 交易数据使用数字签名防止篡改
- 定期备份钱包数据，确保数据安全

### 6.3 风控策略
- 单日充值/提现限额控制
- 异常交易行为检测和告警
- 大额交易需要人工审核
- IP地址和设备指纹识别

### 6.4 审计日志
- 记录所有钱包操作的详细日志
- 包含用户ID、操作类型、金额、时间戳、IP地址
- 日志数据不可篡改，定期归档
- 支持审计查询和异常分析

## 7. 测试设计

### 7.1 测试策略
- 单元测试：覆盖所有Service和Repository方法
- 集成测试：测试API接口和外部服务集成
- 安全测试：权限验证、数据加密、风控规则测试
- 性能测试：高并发交易处理性能测试

### 7.2 测试用例
- 钱包操作：余额查询、充值、提现、消费扣款
- 并发控制：同时进行多个交易的一致性测试
- 异常处理：网络异常、支付失败、余额不足
- 风控测试：限额控制、异常交易检测

### 7.3 性能测试
- 并发交易：1000笔交易同时处理的性能
- 查询性能：大量交易记录的查询响应时间
- 数据库压力：高并发下的数据一致性

## 8. 部署和运维

### 8.1 部署方案
- 微服务独立部署，支持水平扩展
- 使用Docker容器化部署
- 数据库主从复制，读写分离
- Redis集群缓存，提高查询性能

### 8.2 监控指标
- 服务可用性：99.99%以上
- 交易成功率：99.9%以上
- 响应时间：查询<200ms，交易<1s
- 并发处理：支持10000+并发交易

### 8.3 日志策略
- 结构化日志记录，便于分析和检索
- 日志级别：DEBUG、INFO、WARN、ERROR
- 交易日志永久保存，其他日志保留1年
- 集中日志收集和分析

### 8.4 故障处理
- 支付网关故障：自动切换备用通道
- 数据库故障：主从切换，数据恢复
- 缓存故障：降级到数据库查询
- 服务过载：限流和熔断保护

## 9. 风险评估

### 9.1 技术风险
- 数据一致性风险：使用分布式事务和乐观锁
- 性能瓶颈风险：缓存优化和数据库分片
- 外部依赖风险：多通道备份和降级策略

### 9.2 业务风险
- 资金安全风险：多重验证和风控监控
- 欺诈交易风险：机器学习风控模型
- 合规风险：遵循金融监管要求

### 9.3 运营风险
- 大额提现风险：人工审核和分批处理
- 系统故障风险：容灾备份和快速恢复
- 数据泄露风险：数据加密和访问控制

## 10. 实施计划

### 10.1 开发阶段
- 第1-2周：基础架构搭建，数据模型设计
- 第3-4周：钱包管理和交易处理功能开发
- 第5-6周：收益分成和风控监控功能开发
- 第7-8周：API接口完善和单元测试

### 10.2 测试阶段
- 第9-10周：集成测试和安全测试
- 第11-12周：性能测试和压力测试
- 第13周：用户验收测试和问题修复

### 10.3 上线计划
- 第14周：生产环境部署和配置
- 监控告警配置和运维文档编写
- 灰度发布和全量上线
- 运营数据监控和优化调整