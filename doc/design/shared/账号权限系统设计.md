# 账号权限系统设计

## 1. 需求概述

### 1.1 功能描述
账号权限系统是青羽平台的核心基础服务，为阅读端和写作端提供统一的用户认证、授权和权限管理功能。系统支持多种注册方式、JWT身份认证、基于RBAC的权限控制和跨服务的单点登录。

### 1.2 业务价值
- **统一身份管理**：为平台所有服务提供统一的用户身份认证和管理
- **安全保障**：通过JWT Token和权限控制确保系统安全性
- **用户体验优化**：支持单点登录，提升用户使用体验
- **权限精细化管理**：基于RBAC模型实现细粒度权限控制

### 1.3 用户场景
- 新用户通过手机号或邮箱注册账号
- 用户登录后获得JWT Token进行身份认证
- 不同角色用户（Reader/Author/Admin）访问对应权限的功能
- 用户在阅读端和写作端之间无缝切换，无需重复登录

### 1.4 功能边界
- **包含功能**：用户注册登录、JWT认证、角色权限管理、单点登录、会话管理
- **不包含功能**：第三方社交登录、密码找回邮件发送、用户个人信息管理

## 2. 架构设计

### 2.1 整体架构
```
┌─────────────────────────────────────────────────────────┐
│                    客户端层                              │
│  阅读端 Web/App + 写作端 Web/App + 管理后台             │
├─────────────────────────────────────────────────────────┤
│                    API网关层                            │
│  统一入口 + 路由分发 + 负载均衡                         │
├─────────────────────────────────────────────────────────┤
│                  账号权限服务层                          │
│  认证服务 + 授权服务 + 用户管理 + 会话管理               │
├─────────────────────────────────────────────────────────┤
│                    数据存储层                            │
│  MongoDB(用户数据) + Redis(会话缓存) + JWT Token        │
└─────────────────────────────────────────────────────────┘
```

### 2.2 模块划分
- **认证模块**：用户注册、登录、JWT Token生成和验证
- **授权模块**：基于RBAC的权限检查和控制
- **用户管理模块**：用户信息CRUD、状态管理
- **会话管理模块**：会话创建、维护、销毁和超时处理

## 3. 详细设计

### 3.1 Router层设计
- **路由分组**：/api/v1/auth
- **中间件**：CORS、日志记录、限流、安全头
- **路径规范**：RESTful风格，如 /auth/register, /auth/login
- **参数处理**：JSON请求体、路径参数、查询参数

### 3.2 API层设计
- **接口定义**：用户注册、登录、Token刷新、权限验证接口
- **请求验证**：参数格式验证、业务规则验证
- **响应格式**：统一的JSON响应结构，包含状态码、消息、数据
- **错误处理**：标准化错误码和错误信息

### 3.3 Service层设计
- **业务流程**：注册流程、登录验证、Token生成、权限检查
- **数据处理**：密码加密、Token编解码、用户信息转换
- **依赖服务**：短信验证服务、邮件服务、Redis缓存服务
- **异常处理**：业务异常统一处理和错误码映射
- **Repository交互**：通过Repository接口进行数据访问

### 3.4 Repository层设计
- **接口抽象**：UserRepository、RoleRepository、PermissionRepository
- **查询封装**：用户查询、角色权限查询、会话查询
- **事务管理**：用户注册事务、权限变更事务
- **缓存策略**：用户信息缓存、权限信息缓存、会话缓存
- **异常处理**：数据库连接异常、查询异常统一处理
- **与Model关系**：User、Role、Permission模型的数据映射

### 3.5 Model层设计
- **数据模型**：User、Role、Permission、UserRole、RolePermission
- **约束规则**：用户名唯一、邮箱唯一、手机号唯一
- **验证逻辑**：密码强度验证、邮箱格式验证、手机号格式验证
- **Repository接口**：定义数据访问方法签名

## 4. 数据设计

### 4.1 数据模型

#### 用户模型 (User)
```go
type User struct {
    ID          string    `bson:"_id,omitempty" json:"id"`
    Username    string    `bson:"username" json:"username"`
    Email       string    `bson:"email" json:"email"`
    Phone       string    `bson:"phone" json:"phone"`
    Password    string    `bson:"password" json:"-"`
    Status      string    `bson:"status" json:"status"` // active, inactive, banned
    LastLoginAt time.Time `bson:"last_login_at" json:"lastLoginAt"`
    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time `bson:"updated_at" json:"updatedAt"`
}
```

#### 角色模型 (Role)
```go
type Role struct {
    ID          string    `bson:"_id,omitempty" json:"id"`
    Name        string    `bson:"name" json:"name"` // reader, author, admin
    DisplayName string    `bson:"display_name" json:"displayName"`
    Description string    `bson:"description" json:"description"`
    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time `bson:"updated_at" json:"updatedAt"`
}
```

#### 权限模型 (Permission)
```go
type Permission struct {
    ID          string    `bson:"_id,omitempty" json:"id"`
    Name        string    `bson:"name" json:"name"`
    Resource    string    `bson:"resource" json:"resource"`
    Action      string    `bson:"action" json:"action"`
    Description string    `bson:"description" json:"description"`
    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`
}
```

#### 用户角色关联 (UserRole)
```go
type UserRole struct {
    ID        string    `bson:"_id,omitempty" json:"id"`
    UserID    string    `bson:"user_id" json:"userId"`
    RoleID    string    `bson:"role_id" json:"roleId"`
    CreatedAt time.Time `bson:"created_at" json:"createdAt"`
}
```

### 4.2 数据关系
- User 与 Role：多对多关系，通过 UserRole 关联表
- Role 与 Permission：多对多关系，通过 RolePermission 关联表
- User 通过 Role 间接获得 Permission

### 4.3 索引策略
| 集合名称 | 索引字段 | 索引类型 | 说明 |
|---------|---------|---------|------|
| users | username | unique | 用户名唯一索引 |
| users | email | unique | 邮箱唯一索引 |
| users | phone | unique | 手机号唯一索引 |
| user_roles | user_id, role_id | compound | 用户角色复合索引 |
| role_permissions | role_id, permission_id | compound | 角色权限复合索引 |

### 4.4 数据迁移
- 初始化默认角色：reader、author、admin
- 初始化基础权限：读取、写作、管理权限
- 创建默认管理员账号

## 5. 接口设计

### 5.1 API概览

| 方法 | 路径 | 功能描述 | 权限要求 |
|-----|------|---------|---------|
| POST | /api/v1/auth/register | 用户注册 | 无 |
| POST | /api/v1/auth/login | 用户登录 | 无 |
| POST | /api/v1/auth/refresh | Token刷新 | 有效Token |
| POST | /api/v1/auth/logout | 用户登出 | 有效Token |
| GET | /api/v1/auth/profile | 获取用户信息 | 有效Token |
| PUT | /api/v1/auth/profile | 更新用户信息 | 有效Token |
| GET | /api/v1/auth/permissions | 获取用户权限 | 有效Token |

### 5.2 请求与响应格式

#### 5.2.1 用户注册 (POST /api/v1/auth/register)

**请求参数**:
```json
{
  "username": "string, 用户名，3-20字符",
  "email": "string, 邮箱地址",
  "phone": "string, 手机号",
  "password": "string, 密码，8-32字符",
  "verifyCode": "string, 验证码"
}
```

**响应格式**:
```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "id": "用户ID",
    "username": "用户名",
    "email": "邮箱",
    "status": "active"
  }
}
```

#### 5.2.2 用户登录 (POST /api/v1/auth/login)

**请求参数**:
```json
{
  "account": "string, 用户名/邮箱/手机号",
  "password": "string, 密码"
}
```

**响应格式**:
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "accessToken": "JWT访问令牌",
    "refreshToken": "JWT刷新令牌",
    "expiresIn": 3600,
    "user": {
      "id": "用户ID",
      "username": "用户名",
      "email": "邮箱",
      "roles": ["reader", "author"]
    }
  }
}
```

**状态码**:
- 200: 成功
- 400: 请求参数错误
- 401: 认证失败
- 429: 请求过于频繁
- 500: 服务器错误

## 6. 安全设计

### 6.1 权限控制
- 基于RBAC模型的三级权限体系：Reader/Author/Admin
- JWT Token包含用户ID、角色信息和权限范围
- API接口通过中间件进行权限验证
- 敏感操作需要二次验证

### 6.2 数据安全
- 密码使用bcrypt加密存储，加盐处理
- JWT Token使用RSA256算法签名
- 敏感数据传输使用HTTPS加密
- 用户隐私数据脱敏处理

### 6.3 输入验证
- 所有输入参数进行格式和长度验证
- SQL注入和XSS攻击防护
- 请求频率限制，防止暴力破解
- 验证码机制防止自动化攻击

### 6.4 审计日志
- 记录用户登录、登出、权限变更等关键操作
- 异常登录行为监控和告警
- 操作日志包含用户ID、IP地址、时间戳
- 日志数据定期归档和备份

## 7. 测试设计

### 7.1 测试策略
- 单元测试：覆盖所有Service和Repository方法
- 集成测试：测试API接口和数据库交互
- 安全测试：权限验证、输入验证、加密算法测试
- 性能测试：并发登录、Token验证性能测试

### 7.2 测试用例
- 用户注册：正常注册、重复注册、参数验证
- 用户登录：正常登录、错误密码、账号不存在
- Token验证：有效Token、过期Token、伪造Token
- 权限检查：有权限访问、无权限访问、角色变更

### 7.3 性能测试
- 并发登录：1000用户同时登录的响应时间
- Token验证：每秒10000次Token验证的性能
- 数据库查询：用户信息查询的响应时间优化

## 8. 部署和运维

### 8.1 部署方案
- 微服务独立部署，支持水平扩展
- 使用Docker容器化部署
- 配置Nginx负载均衡和反向代理
- Redis集群部署，保证高可用

### 8.2 监控指标
- 服务可用性：99.9%以上
- 响应时间：登录接口<500ms，验证接口<100ms
- 错误率：<0.1%
- 并发处理：支持1000+并发用户

### 8.3 日志策略
- 结构化日志记录，便于分析和检索
- 日志级别：DEBUG、INFO、WARN、ERROR
- 日志轮转：按天轮转，保留30天
- 集中日志收集：使用ELK栈

### 8.4 故障处理
- 数据库连接失败：自动重连和故障转移
- Redis缓存失败：降级到数据库查询
- Token验证失败：返回401状态码，引导重新登录
- 服务过载：启用限流和熔断机制

## 9. 风险评估

### 9.1 技术风险
- JWT Token泄露风险：设置合理的过期时间，支持Token撤销
- 数据库性能瓶颈：优化查询，使用缓存，读写分离
- 缓存雪崩风险：设置随机过期时间，多级缓存策略

### 9.2 业务风险
- 账号被盗风险：异常登录检测，二次验证机制
- 权限提升攻击：严格的权限验证，最小权限原则
- 数据泄露风险：数据加密存储，访问日志审计

### 9.3 性能风险
- 高并发登录：使用Redis缓存，数据库连接池优化
- Token验证性能：JWT本地验证，避免数据库查询
- 会话存储压力：Redis集群，会话数据压缩

## 10. 实施计划

### 10.1 开发阶段
- 第1周：基础架构搭建，数据模型设计
- 第2周：用户注册登录功能开发
- 第3周：JWT认证和权限管理开发
- 第4周：API接口完善和单元测试

### 10.2 测试阶段
- 第5周：集成测试和安全测试
- 第6周：性能测试和压力测试
- 第7周：用户验收测试和问题修复

### 10.3 上线计划
- 第8周：生产环境部署和配置
- 监控告警配置和运维文档编写
- 灰度发布和全量上线