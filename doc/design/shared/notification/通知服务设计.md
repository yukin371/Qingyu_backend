# é€šçŸ¥æœåŠ¡è®¾è®¡

> **æ¶æ„è¯´æ˜**: æœ¬æ–‡æ¡£åŸºäº**æ¨¡å—åŒ–å•ä½“æ¶æ„**è®¾è®¡ã€‚
> 
> - âœ… å½“å‰é‡‡ç”¨å•ä¸€ä»£ç åº“,ç»Ÿä¸€éƒ¨ç½²
> - âœ… é€šè¿‡æ¨¡å—åŒ–ä¿æŒæ¸…æ™°è¾¹ç•Œ
> - âœ… ä¸ºæœªæ¥å¯èƒ½çš„å¾®æœåŠ¡åŒ–é¢„ç•™ç©ºé—´
> 
> å‚è€ƒ:[å¾®æœåŠ¡æ¶æ„åˆ’åˆ†å»ºè®®](../å¾®æœåŠ¡æ¶æ„åˆ’åˆ†å»ºè®®.md)
> 
> **æ–‡æ¡£çŠ¶æ€**: âœ… MVPæ ¸å¿ƒåŠŸèƒ½  
> **åˆ›å»ºæ—¶é—´**: 2025-10-17  
> **æœ€åæ›´æ–°**: 2025-10-17  
> **å®æ–½çŠ¶æ€**: ğŸŸ¡ è¿›è¡Œä¸­ (75%)

## 1. éœ€æ±‚æ¦‚è¿°

### 1.1 åŠŸèƒ½æè¿°

é€šçŸ¥æœåŠ¡æ˜¯é’ç¾½å¹³å°çš„å…³é”®åŸºç¡€è®¾æ–½æœåŠ¡,ä¸ºä¸šåŠ¡æ¨¡å—æä¾›ç»Ÿä¸€çš„æ¶ˆæ¯é€šçŸ¥èƒ½åŠ›ã€‚ç³»ç»Ÿæ”¯æŒå¤šç§é€šçŸ¥æ¸ é“(é‚®ä»¶ã€çŸ­ä¿¡ã€ç«™å†…ä¿¡ã€æ¨é€),æä¾›æ¨¡æ¿åŒ–æ¶ˆæ¯ã€æ‰¹é‡å‘é€ã€å‘é€çŠ¶æ€è¿½è¸ªã€å¤±è´¥é‡è¯•ç­‰åŠŸèƒ½,ç¡®ä¿é‡è¦æ¶ˆæ¯èƒ½å¤ŸåŠæ—¶ã€å‡†ç¡®åœ°é€è¾¾ç”¨æˆ·ã€‚

### 1.2 ä¸šåŠ¡ä»·å€¼

- **ç”¨æˆ·è§¦è¾¾**:æä¾›å¤šæ¸ é“æ¶ˆæ¯è§¦è¾¾èƒ½åŠ›,æå‡ç”¨æˆ·æ´»è·ƒåº¦
- **åŠæ—¶é€šçŸ¥**:é‡è¦ä¸šåŠ¡äº‹ä»¶åŠæ—¶é€šçŸ¥,æå‡ç”¨æˆ·ä½“éªŒ
- **è¥é”€æ¨å¹¿**:æ”¯æŒæ‰¹é‡æ¶ˆæ¯æ¨é€,åŠ©åŠ›è¥é”€æ´»åŠ¨
- **ç³»ç»Ÿç›‘æ§**:å¼‚å¸¸å‘Šè­¦å’Œç³»ç»Ÿé€šçŸ¥,ä¿éšœç³»ç»Ÿç¨³å®šè¿è¡Œ

### 1.3 ç”¨æˆ·åœºæ™¯

- ç”¨æˆ·æ³¨å†Œåå‘é€æ¬¢è¿é‚®ä»¶å’ŒçŸ­ä¿¡éªŒè¯ç 
- ç”¨æˆ·è®¢é˜…çš„å°è¯´æ›´æ–°æ—¶å‘é€ç«™å†…é€šçŸ¥
- ä½œè€…ä½œå“å®¡æ ¸é€šè¿‡åå‘é€ç³»ç»Ÿé€šçŸ¥
- å……å€¼æˆåŠŸã€æ¶ˆè´¹æ‰£æ¬¾ç­‰äº¤æ˜“é€šçŸ¥
- æ´»åŠ¨æ¨å¹¿å’Œè¿è¥æ¶ˆæ¯æ‰¹é‡æ¨é€
- ç³»ç»Ÿå¼‚å¸¸å‘Šè­¦é€šçŸ¥ç®¡ç†å‘˜

### 1.4 åŠŸèƒ½è¾¹ç•Œ

- **åŒ…å«åŠŸèƒ½**:é‚®ä»¶é€šçŸ¥ã€çŸ­ä¿¡é€šçŸ¥ã€ç«™å†…é€šçŸ¥ã€æ¨é€é€šçŸ¥ã€æ¨¡æ¿ç®¡ç†ã€æ‰¹é‡å‘é€ã€çŠ¶æ€è¿½è¸ª
- **ä¸åŒ…å«åŠŸèƒ½**:çŸ­ä¿¡/é‚®ä»¶æœåŠ¡å•†æ¥å£å®ç°ã€æ¶ˆæ¯å†…å®¹å®¡æ ¸ã€ç”¨æˆ·åå¥½è®¾ç½®

## 2. æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„(æ¨¡å—åŒ–å•ä½“)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 é’ç¾½å†™ä½œå¹³å° (å•ä¸€åº”ç”¨)                  â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚           ä¸šåŠ¡æ¨¡å—å±‚                           â”‚    â”‚
â”‚  â”‚  ç”¨æˆ·æ¨¡å— + é˜…è¯»æ¨¡å— + é’±åŒ…æ¨¡å— + å†…å®¹æ¨¡å—      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                         â†“                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚       é€šçŸ¥æœåŠ¡æ¨¡å— (Notification Module)        â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚ é€šçŸ¥è°ƒåº¦å™¨ (Notification Scheduler)      â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - æ¶ˆæ¯æ¥æ”¶å’Œè·¯ç”±                       â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - æ¨¡æ¿æ¸²æŸ“                             â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - æ¸ é“é€‰æ‹©                             â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚ æ¸ é“é€‚é…å™¨ (Channel Adapters)            â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - é‚®ä»¶å‘é€å™¨                           â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - çŸ­ä¿¡å‘é€å™¨                           â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - ç«™å†…æ¶ˆæ¯å­˜å‚¨                         â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - æ¨é€é€šçŸ¥å‘é€å™¨                       â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚ çŠ¶æ€è¿½è¸ªå™¨ (Status Tracker)              â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - å‘é€çŠ¶æ€è®°å½•                         â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - å¤±è´¥é‡è¯•                             â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - ç»Ÿè®¡åˆ†æ                             â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                         â†“                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚         æ¶ˆæ¯é˜Ÿåˆ— (Redis Streams)               â”‚    â”‚
â”‚  â”‚  notification.email / notification.sms / ...   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                         â†“                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              æ•°æ®å­˜å‚¨å±‚                        â”‚    â”‚
â”‚  â”‚  MongoDB (æ¨¡æ¿+è®°å½•) + Redis (é˜Ÿåˆ—+ç¼“å­˜)       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¶æ„è¯´æ˜**:
- é€šçŸ¥æœåŠ¡ä½œä¸ºä¸»åº”ç”¨çš„ä¸€ä¸ªæ¨¡å—,ä¸å…¶ä»–ä¸šåŠ¡æ¨¡å—åœ¨åŒä¸€è¿›ç¨‹
- ä½¿ç”¨Redis Streamsä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—,å®ç°å¼‚æ­¥å‘é€
- é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦ä¸šåŠ¡æ¨¡å—å’Œé€šçŸ¥æ¨¡å—
- æ¸ é“é€‚é…å™¨æ¨¡å¼æ”¯æŒå¤šç§é€šçŸ¥æ–¹å¼

### 2.2 æ¨¡å—åˆ’åˆ†

- **é€šçŸ¥è°ƒåº¦æ¨¡å—**:æ¶ˆæ¯æ¥æ”¶ã€æ¨¡æ¿æ¸²æŸ“ã€æ¸ é“è·¯ç”±
- **æ¸ é“é€‚é…æ¨¡å—**:é‚®ä»¶ã€çŸ­ä¿¡ã€ç«™å†…æ¶ˆæ¯ã€æ¨é€çš„å…·ä½“å®ç°
- **æ¨¡æ¿ç®¡ç†æ¨¡å—**:æ¶ˆæ¯æ¨¡æ¿çš„å¢åˆ æ”¹æŸ¥
- **çŠ¶æ€è¿½è¸ªæ¨¡å—**:å‘é€çŠ¶æ€è®°å½•ã€å¤±è´¥é‡è¯•ã€ç»Ÿè®¡åˆ†æ

## 3. è¯¦ç»†è®¾è®¡

### 3.1 Serviceå±‚è®¾è®¡

#### 3.1.1 æ ¸å¿ƒæ¥å£

```go
// NotificationService é€šçŸ¥æœåŠ¡æ¥å£
type NotificationService interface {
    // å‘é€é‚®ä»¶é€šçŸ¥
    SendEmail(ctx context.Context, to, subject, content string) error
    
    // ä½¿ç”¨æ¨¡æ¿å‘é€é‚®ä»¶
    SendEmailWithTemplate(ctx context.Context, to, templateName string, variables map[string]string) error
    
    // å‘é€çŸ­ä¿¡é€šçŸ¥
    SendSMS(ctx context.Context, phone, content string) error
    
    // å‘é€æ¨é€é€šçŸ¥
    SendPush(ctx context.Context, userID, title, content string) error
    
    // å‘é€ç³»ç»Ÿé€šçŸ¥(ç«™å†…æ¶ˆæ¯)
    SendSystemNotification(ctx context.Context, userID, title, content string) error
    
    // æ‰¹é‡å‘é€é€šçŸ¥
    SendBatch(ctx context.Context, notifications []*Notification) error
}

// TemplateService æ¨¡æ¿ç®¡ç†æ¥å£
type TemplateService interface {
    // åˆ›å»ºæ¨¡æ¿
    CreateTemplate(ctx context.Context, template *MessageTemplate) error
    
    // è·å–æ¨¡æ¿
    GetTemplate(ctx context.Context, name string) (*MessageTemplate, error)
    
    // æ›´æ–°æ¨¡æ¿
    UpdateTemplate(ctx context.Context, name string, template *MessageTemplate) error
    
    // åˆ é™¤æ¨¡æ¿
    DeleteTemplate(ctx context.Context, name string) error
    
    // åˆ—å‡ºæ‰€æœ‰æ¨¡æ¿
    ListTemplates(ctx context.Context, filter *TemplateFilter) ([]*MessageTemplate, error)
}
```

#### 3.1.2 æœåŠ¡å®ç°

```go
// NotificationServiceImpl é€šçŸ¥æœåŠ¡å®ç°
type NotificationServiceImpl struct {
    messagingService MessagingService  // æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡
    templateStore    TemplateStore     // æ¨¡æ¿å­˜å‚¨
}

// SendEmailWithTemplate ä½¿ç”¨æ¨¡æ¿å‘é€é‚®ä»¶
func (s *NotificationServiceImpl) SendEmailWithTemplate(
    ctx context.Context, 
    to, templateName string, 
    variables map[string]string,
) error {
    // 1. è·å–æ¨¡æ¿
    template, err := s.templateStore.GetTemplate(ctx, templateName)
    if err != nil {
        return fmt.Errorf("è·å–æ¨¡æ¿å¤±è´¥: %w", err)
    }
    
    // 2. æ¸²æŸ“æ¨¡æ¿
    content := s.renderTemplate(template.Content, variables)
    subject := s.renderTemplate(template.Subject, variables)
    
    // 3. å‘é€é‚®ä»¶
    return s.SendEmail(ctx, to, subject, content)
}

// renderTemplate æ¸²æŸ“æ¨¡æ¿
func (s *NotificationServiceImpl) renderTemplate(template string, variables map[string]string) string {
    result := template
    for key, value := range variables {
        placeholder := "{{" + key + "}}"
        result = strings.ReplaceAll(result, placeholder, value)
    }
    return result
}

// SendBatch æ‰¹é‡å‘é€é€šçŸ¥
func (s *NotificationServiceImpl) SendBatch(ctx context.Context, notifications []*Notification) error {
    // åˆ†æ‰¹å‘é€,é¿å…ä¸€æ¬¡æ€§å¤„ç†è¿‡å¤šæ¶ˆæ¯
    batchSize := 100
    for i := 0; i < len(notifications); i += batchSize {
        end := i + batchSize
        if end > len(notifications) {
            end = len(notifications)
        }
        
        batch := notifications[i:end]
        for _, notification := range batch {
            // æ ¹æ®ç±»å‹é€‰æ‹©å‘é€æ–¹å¼
            switch notification.Type {
            case NotificationTypeEmail:
                s.SendEmail(ctx, notification.To, notification.Subject, notification.Content)
            case NotificationTypeSMS:
                s.SendSMS(ctx, notification.To, notification.Content)
            case NotificationTypePush:
                s.SendPush(ctx, notification.UserID, notification.Title, notification.Content)
            case NotificationTypeSystem:
                s.SendSystemNotification(ctx, notification.UserID, notification.Title, notification.Content)
            }
        }
    }
    
    return nil
}
```

### 3.2 Repositoryå±‚è®¾è®¡

```go
// NotificationRepository é€šçŸ¥è®°å½•Repository
type NotificationRepository interface {
    // ä¿å­˜é€šçŸ¥è®°å½•
    Save(ctx context.Context, notification *Notification) error
    
    // æ›´æ–°é€šçŸ¥çŠ¶æ€
    UpdateStatus(ctx context.Context, id string, status NotificationStatus) error
    
    // æŸ¥è¯¢ç”¨æˆ·é€šçŸ¥
    FindByUserID(ctx context.Context, userID string, filter *NotificationFilter) ([]*Notification, error)
    
    // æ ‡è®°ä¸ºå·²è¯»
    MarkAsRead(ctx context.Context, id string) error
    
    // æ‰¹é‡æ ‡è®°ä¸ºå·²è¯»
    MarkAllAsRead(ctx context.Context, userID string) error
    
    // è·å–æœªè¯»æ•°é‡
    CountUnread(ctx context.Context, userID string) (int64, error)
}

// TemplateRepository æ¨¡æ¿Repository
type TemplateRepository interface {
    Create(ctx context.Context, template *MessageTemplate) error
    GetByName(ctx context.Context, name string) (*MessageTemplate, error)
    Update(ctx context.Context, name string, template *MessageTemplate) error
    Delete(ctx context.Context, name string) error
    List(ctx context.Context, filter *TemplateFilter) ([]*MessageTemplate, error)
}
```

### 3.3 æ•°æ®æ¨¡å‹è®¾è®¡

```go
// é€šçŸ¥ç±»å‹
type NotificationType string

const (
    NotificationTypeEmail  NotificationType = "email"   // é‚®ä»¶
    NotificationTypeSMS    NotificationType = "sms"     // çŸ­ä¿¡
    NotificationTypePush   NotificationType = "push"    // æ¨é€
    NotificationTypeSystem NotificationType = "system"  // ç«™å†…æ¶ˆæ¯
)

// é€šçŸ¥çŠ¶æ€
type NotificationStatus string

const (
    NotificationStatusPending NotificationStatus = "pending" // å¾…å‘é€
    NotificationStatusSent    NotificationStatus = "sent"    // å·²å‘é€
    NotificationStatusFailed  NotificationStatus = "failed"  // å‘é€å¤±è´¥
    NotificationStatusRead    NotificationStatus = "read"    // å·²è¯»(ä»…ç«™å†…æ¶ˆæ¯)
)

// Notification é€šçŸ¥è®°å½•
type Notification struct {
    ID        string              `bson:"_id,omitempty" json:"id"`
    UserID    string              `bson:"user_id" json:"user_id"`           // ç”¨æˆ·ID
    Type      NotificationType    `bson:"type" json:"type"`                 // é€šçŸ¥ç±»å‹
    To        string              `bson:"to" json:"to"`                     // æ¥æ”¶åœ°å€(é‚®ç®±/æ‰‹æœºå·)
    Title     string              `bson:"title,omitempty" json:"title"`     // æ ‡é¢˜
    Subject   string              `bson:"subject,omitempty" json:"subject"` // é‚®ä»¶ä¸»é¢˜
    Content   string              `bson:"content" json:"content"`           // å†…å®¹
    Status    NotificationStatus  `bson:"status" json:"status"`             // çŠ¶æ€
    IsRead    bool                `bson:"is_read" json:"is_read"`           // æ˜¯å¦å·²è¯»
    ErrorMsg  string              `bson:"error_msg,omitempty" json:"error_msg"` // é”™è¯¯ä¿¡æ¯
    RetryCount int                `bson:"retry_count" json:"retry_count"`   // é‡è¯•æ¬¡æ•°
    Metadata  map[string]interface{} `bson:"metadata,omitempty" json:"metadata"` // å…ƒæ•°æ®
    CreatedAt time.Time           `bson:"created_at" json:"created_at"`
    UpdatedAt time.Time           `bson:"updated_at" json:"updated_at"`
    SentAt    *time.Time          `bson:"sent_at,omitempty" json:"sent_at"`
}

// MessageTemplate æ¶ˆæ¯æ¨¡æ¿
type MessageTemplate struct {
    ID          string              `bson:"_id,omitempty" json:"id"`
    Name        string              `bson:"name" json:"name"`           // æ¨¡æ¿åç§°
    Type        NotificationType    `bson:"type" json:"type"`           // é€šçŸ¥ç±»å‹
    Subject     string              `bson:"subject,omitempty" json:"subject"` // é‚®ä»¶ä¸»é¢˜æ¨¡æ¿
    Content     string              `bson:"content" json:"content"`     // å†…å®¹æ¨¡æ¿
    Variables   []string            `bson:"variables" json:"variables"` // å˜é‡åˆ—è¡¨
    Description string              `bson:"description" json:"description"` // æè¿°
    IsActive    bool                `bson:"is_active" json:"is_active"` // æ˜¯å¦å¯ç”¨
    CreatedBy   string              `bson:"created_by" json:"created_by"`
    CreatedAt   time.Time           `bson:"created_at" json:"created_at"`
    UpdatedAt   time.Time           `bson:"updated_at" json:"updated_at"`
}
```

### 3.4 APIå±‚è®¾è®¡

```go
// ç”¨æˆ·è·å–è‡ªå·±çš„é€šçŸ¥åˆ—è¡¨
GET /api/v1/notifications
Queryå‚æ•°:
- page: é¡µç 
- page_size: æ¯é¡µæ•°é‡
- type: é€šçŸ¥ç±»å‹ç­›é€‰
- is_read: æ˜¯å¦å·²è¯»

// è·å–æœªè¯»é€šçŸ¥æ•°é‡
GET /api/v1/notifications/unread-count

// æ ‡è®°é€šçŸ¥ä¸ºå·²è¯»
PUT /api/v1/notifications/:id/read

// æ ‡è®°æ‰€æœ‰é€šçŸ¥ä¸ºå·²è¯»
PUT /api/v1/notifications/read-all

// ç®¡ç†å‘˜: åˆ›å»ºæ¶ˆæ¯æ¨¡æ¿
POST /admin/api/v1/notification-templates
Body:
{
    "name": "welcome_email",
    "type": "email",
    "subject": "æ¬¢è¿åŠ å…¥é’ç¾½å¹³å°",
    "content": "å°Šæ•¬çš„{{username}},æ¬¢è¿æ‚¨...",
    "variables": ["username"],
    "description": "ç”¨æˆ·æ³¨å†Œæ¬¢è¿é‚®ä»¶"
}

// ç®¡ç†å‘˜: æ‰¹é‡å‘é€é€šçŸ¥
POST /admin/api/v1/notifications/batch
Body:
{
    "template": "activity_notice",
    "users": ["user1", "user2", ...],
    "variables": {
        "activity_name": "åŒåä¸€æ´»åŠ¨"
    }
}
```

## 4. æŠ€æœ¯å®ç°

### 4.1 æ¶ˆæ¯é˜Ÿåˆ—Topicè®¾è®¡

```go
const (
    TopicNotificationEmail  = "notification.email"   // é‚®ä»¶é€šçŸ¥é˜Ÿåˆ—
    TopicNotificationSMS    = "notification.sms"     // çŸ­ä¿¡é€šçŸ¥é˜Ÿåˆ—
    TopicNotificationPush   = "notification.push"    // æ¨é€é€šçŸ¥é˜Ÿåˆ—
    TopicNotificationSystem = "notification.system"  // ç«™å†…æ¶ˆæ¯é˜Ÿåˆ—
)
```

### 4.2 æ¶ˆæ¯å‘é€æµç¨‹

```
ä¸šåŠ¡æ¨¡å— â†’ NotificationService.SendEmail() 
    â†“
æ¸²æŸ“æ¨¡æ¿(å¦‚æœä½¿ç”¨æ¨¡æ¿)
    â†“
å‘å¸ƒæ¶ˆæ¯åˆ°Redis Streams (notification.email)
    â†“
åå°Workerè®¢é˜…é˜Ÿåˆ—
    â†“
è°ƒç”¨é‚®ä»¶æœåŠ¡å•†APIå‘é€
    â†“
è®°å½•å‘é€çŠ¶æ€åˆ°MongoDB
    â†“
å¤±è´¥é‡è¯•(æœ€å¤š3æ¬¡)
```

### 4.3 å¤±è´¥é‡è¯•æœºåˆ¶

```go
// RetryPolicy é‡è¯•ç­–ç•¥
type RetryPolicy struct {
    MaxRetries    int           // æœ€å¤§é‡è¯•æ¬¡æ•°
    RetryInterval time.Duration // é‡è¯•é—´éš”
    BackoffFactor float64       // é€€é¿å› å­(æŒ‡æ•°é€€é¿)
}

// é»˜è®¤é‡è¯•ç­–ç•¥
var DefaultRetryPolicy = RetryPolicy{
    MaxRetries:    3,
    RetryInterval: 1 * time.Minute,
    BackoffFactor: 2.0, // 1åˆ†é’Ÿ â†’ 2åˆ†é’Ÿ â†’ 4åˆ†é’Ÿ
}

// é‡è¯•é€»è¾‘
func (s *NotificationServiceImpl) retryFailedNotifications(ctx context.Context) {
    // æŸ¥è¯¢å¤±è´¥çš„é€šçŸ¥
    failedNotifications := s.repo.FindFailedNotifications(ctx, DefaultRetryPolicy.MaxRetries)
    
    for _, notification := range failedNotifications {
        // è®¡ç®—ä¸‹æ¬¡é‡è¯•æ—¶é—´(æŒ‡æ•°é€€é¿)
        nextRetryTime := notification.UpdatedAt.Add(
            time.Duration(math.Pow(DefaultRetryPolicy.BackoffFactor, float64(notification.RetryCount))) * DefaultRetryPolicy.RetryInterval,
        )
        
        if time.Now().Before(nextRetryTime) {
            continue // è¿˜æœªåˆ°é‡è¯•æ—¶é—´
        }
        
        // é‡æ–°å‘é€
        err := s.resendNotification(ctx, notification)
        if err != nil {
            // æ›´æ–°é‡è¯•æ¬¡æ•°
            s.repo.IncrementRetryCount(ctx, notification.ID)
        } else {
            // æ ‡è®°ä¸ºå·²å‘é€
            s.repo.UpdateStatus(ctx, notification.ID, NotificationStatusSent)
        }
    }
}
```

### 4.4 æ¨¡æ¿æ¸²æŸ“å¼•æ“

```go
// TemplateEngine æ¨¡æ¿æ¸²æŸ“å¼•æ“
type TemplateEngine interface {
    Render(template string, variables map[string]string) (string, error)
}

// SimpleTemplateEngine ç®€å•æ¨¡æ¿å¼•æ“(ä½¿ç”¨{{variable}}è¯­æ³•)
type SimpleTemplateEngine struct{}

func (e *SimpleTemplateEngine) Render(template string, variables map[string]string) (string, error) {
    result := template
    
    // æ›¿æ¢æ‰€æœ‰å˜é‡
    for key, value := range variables {
        placeholder := "{{" + key + "}}"
        result = strings.ReplaceAll(result, placeholder, value)
    }
    
    // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æœªæ›¿æ¢çš„å˜é‡
    if strings.Contains(result, "{{") {
        return "", errors.New("æ¨¡æ¿ä¸­å­˜åœ¨æœªæä¾›çš„å˜é‡")
    }
    
    return result, nil
}
```

### 4.5 é‚®ä»¶å‘é€é€‚é…å™¨(ç¤ºä¾‹)

```go
// EmailAdapter é‚®ä»¶å‘é€é€‚é…å™¨æ¥å£
type EmailAdapter interface {
    Send(ctx context.Context, to, subject, content string) error
}

// SMTPEmailAdapter SMTPé‚®ä»¶é€‚é…å™¨
type SMTPEmailAdapter struct {
    host     string
    port     int
    username string
    password string
    from     string
}

func (a *SMTPEmailAdapter) Send(ctx context.Context, to, subject, content string) error {
    auth := smtp.PlainAuth("", a.username, a.password, a.host)
    
    msg := []byte(fmt.Sprintf(
        "To: %s\r\n"+
            "Subject: %s\r\n"+
            "Content-Type: text/html; charset=UTF-8\r\n"+
            "\r\n"+
            "%s\r\n",
        to, subject, content,
    ))
    
    addr := fmt.Sprintf("%s:%d", a.host, a.port)
    return smtp.SendMail(addr, auth, a.from, []string{to}, msg)
}
```

## 5. æ•°æ®åº“è®¾è®¡

### 5.1 MongoDBé›†åˆ

```javascript
// notifications é›†åˆ
{
    "_id": ObjectId("..."),
    "user_id": "user123",
    "type": "email",
    "to": "user@example.com",
    "subject": "æ¬¢è¿åŠ å…¥é’ç¾½",
    "content": "å°Šæ•¬çš„ç”¨æˆ·...",
    "status": "sent",
    "is_read": false,
    "retry_count": 0,
    "created_at": ISODate("2025-10-17T10:00:00Z"),
    "sent_at": ISODate("2025-10-17T10:00:05Z")
}

// ç´¢å¼•è®¾è®¡
db.notifications.createIndex({ "user_id": 1, "created_at": -1 })
db.notifications.createIndex({ "user_id": 1, "is_read": 1 })
db.notifications.createIndex({ "status": 1, "retry_count": 1 })

// message_templates é›†åˆ
{
    "_id": ObjectId("..."),
    "name": "welcome_email",
    "type": "email",
    "subject": "æ¬¢è¿åŠ å…¥é’ç¾½å¹³å°",
    "content": "å°Šæ•¬çš„{{username}},æ¬¢è¿æ‚¨åŠ å…¥é’ç¾½...",
    "variables": ["username"],
    "description": "ç”¨æˆ·æ³¨å†Œæ¬¢è¿é‚®ä»¶",
    "is_active": true,
    "created_by": "admin",
    "created_at": ISODate("2025-10-17T10:00:00Z")
}

// ç´¢å¼•è®¾è®¡
db.message_templates.createIndex({ "name": 1 }, { unique: true })
db.message_templates.createIndex({ "type": 1, "is_active": 1 })
```

## 6. æ€§èƒ½ä¼˜åŒ–

### 6.1 å¼‚æ­¥å‘é€

- æ‰€æœ‰é€šçŸ¥é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å‘é€,é¿å…é˜»å¡ä¸šåŠ¡æµç¨‹
- ä½¿ç”¨Redis Streamsä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—,æ”¯æŒé«˜ååé‡

### 6.2 æ‰¹é‡å‘é€ä¼˜åŒ–

```go
// æ‰¹é‡å‘é€æ—¶,ä½¿ç”¨goroutineå¹¶å‘å¤„ç†
func (s *NotificationServiceImpl) SendBatch(ctx context.Context, notifications []*Notification) error {
    // å¹¶å‘æ§åˆ¶
    sem := make(chan struct{}, 10) // æœ€å¤š10ä¸ªå¹¶å‘
    var wg sync.WaitGroup
    
    for _, notification := range notifications {
        wg.Add(1)
        go func(n *Notification) {
            defer wg.Done()
            sem <- struct{}{}        // è·å–ä¿¡å·é‡
            defer func() { <-sem }() // é‡Šæ”¾ä¿¡å·é‡
            
            s.sendSingleNotification(ctx, n)
        }(notification)
    }
    
    wg.Wait()
    return nil
}
```

### 6.3 ç¼“å­˜ä¼˜åŒ–

- æ¶ˆæ¯æ¨¡æ¿ç¼“å­˜åˆ°Redis,é¿å…é¢‘ç¹æŸ¥è¯¢MongoDB
- TTLè®¾ç½®ä¸º1å°æ—¶

## 7. ç›‘æ§å’Œç»Ÿè®¡

### 7.1 ç›‘æ§æŒ‡æ ‡

- æ¯åˆ†é’Ÿå‘é€æ•°é‡(æŒ‰ç±»å‹ç»Ÿè®¡)
- å‘é€æˆåŠŸç‡
- å‘é€å¤±è´¥ç‡
- å¹³å‡å‘é€å»¶è¿Ÿ
- é˜Ÿåˆ—ç§¯å‹æ•°é‡

### 7.2 ç»Ÿè®¡æŠ¥è¡¨

```go
// NotificationStats é€šçŸ¥ç»Ÿè®¡
type NotificationStats struct {
    TotalSent     int64             // æ€»å‘é€æ•°
    SuccessCount  int64             // æˆåŠŸæ•°
    FailedCount   int64             // å¤±è´¥æ•°
    ByType        map[string]int64  // æŒ‰ç±»å‹ç»Ÿè®¡
    AvgDelay      time.Duration     // å¹³å‡å»¶è¿Ÿ
}

// GetStats è·å–ç»Ÿè®¡æ•°æ®
func (s *NotificationServiceImpl) GetStats(ctx context.Context, startTime, endTime time.Time) (*NotificationStats, error) {
    // ä»MongoDBèšåˆæŸ¥è¯¢ç»Ÿè®¡æ•°æ®
    pipeline := []bson.M{
        {"$match": bson.M{
            "created_at": bson.M{
                "$gte": startTime,
                "$lte": endTime,
            },
        }},
        {"$group": bson.M{
            "_id": "$type",
            "count": bson.M{"$sum": 1},
            "success": bson.M{"$sum": bson.M{"$cond": []interface{}{
                bson.M{"$eq": []string{"$status", "sent"}}, 1, 0,
            }}},
        }},
    }
    
    // ... æ‰§è¡ŒèšåˆæŸ¥è¯¢
}
```

## 8. å®‰å…¨è®¾è®¡

### 8.1 æƒé™æ§åˆ¶

- æ™®é€šç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„é€šçŸ¥
- ç®¡ç†å‘˜å¯ä»¥åˆ›å»ºæ¨¡æ¿å’Œæ‰¹é‡å‘é€é€šçŸ¥
- APIéœ€è¦JWTè®¤è¯

### 8.2 é˜²æ»¥ç”¨

- æ‰¹é‡å‘é€é™åˆ¶(å•æ¬¡æœ€å¤š1000æ¡)
- å‘é€é¢‘ç‡é™åˆ¶(æ¯ç”¨æˆ·æ¯å°æ—¶æœ€å¤š100æ¡)
- æ•æ„Ÿæ“ä½œéœ€è¦äºŒæ¬¡ç¡®è®¤

### 8.3 æ•°æ®è„±æ•

- è®°å½•æ—¥å¿—æ—¶è„±æ•æ‰‹æœºå·å’Œé‚®ç®±
- ä¾‹å¦‚: 138****1234, user***@example.com

## 9. MVPèŒƒå›´

### 9.1 MVPæ ¸å¿ƒåŠŸèƒ½ âœ…

- âœ… é‚®ä»¶é€šçŸ¥(SMTP)
- âœ… ç«™å†…æ¶ˆæ¯é€šçŸ¥
- âœ… æ¶ˆæ¯æ¨¡æ¿ç®¡ç†
- âœ… åŸºæœ¬çš„å¤±è´¥é‡è¯•æœºåˆ¶
- âœ… é€šçŸ¥è®°å½•æŸ¥è¯¢

### 9.2 åç»­è¿­ä»£åŠŸèƒ½ â¸ï¸

- â¸ï¸ çŸ­ä¿¡é€šçŸ¥(æ¥å…¥ç¬¬ä¸‰æ–¹æœåŠ¡å•†)
- â¸ï¸ æ¨é€é€šçŸ¥(æ¥å…¥æå…‰æ¨é€ç­‰)
- â¸ï¸ é«˜çº§æ¨¡æ¿å¼•æ“(æ”¯æŒæ¡ä»¶ã€å¾ªç¯)
- â¸ï¸ ç”¨æˆ·é€šçŸ¥åå¥½è®¾ç½®
- â¸ï¸ é€šçŸ¥ç»Ÿè®¡æŠ¥è¡¨å’Œä»ªè¡¨ç›˜

## 10. ç›¸å…³æ–‡æ¡£

- [æ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡](./æ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡.md)
- [ç®¡ç†åå°è®¾è®¡](./ç®¡ç†åå°è®¾è®¡.md)
- [å…±äº«åº•å±‚æœåŠ¡è®¾è®¡æ–‡æ¡£](./README_å…±äº«åº•å±‚æœåŠ¡è®¾è®¡æ–‡æ¡£.md)
- [é¡¹ç›®å¼€å‘è§„åˆ™](../../architecture/é¡¹ç›®å¼€å‘è§„åˆ™.md)

---

**æ–‡æ¡£ç»´æŠ¤**: é’ç¾½åç«¯æ¶æ„å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025-10-17

