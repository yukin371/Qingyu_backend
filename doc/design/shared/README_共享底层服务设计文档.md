# 共享底层服务设计文档

## 概述

共享底层服务是青羽轻量级阅读写作平台的基础设施层，为阅读端和写作端提供统一的账号管理、钱包系统、推荐服务等核心功能。这些服务采用微服务架构，确保系统的可扩展性和可维护性。

## 服务架构

`
shared/
 auth/               # 账号与权限服务
 wallet/             # 钱包系统
 recommendation/     # 推荐服务
 messaging/          # 消息队列服务
 storage/            # 文件存储服务
 admin/              # 管理后台服务
`

## 核心服务模块

### 1. 账号与权限服务 (auth)
- **用户注册**: 手机号 + 邮箱双通道注册
- **身份认证**: JWT Token + 刷新机制
- **角色管理**: Reader/Author/Admin三角色体系
- **权限控制**: 基于RBAC的细粒度权限管理
- **单点登录**: 跨服务的统一身份认证

### 2. 钱包系统 (wallet)
- **代币管理**: 充值、消费、余额查询
- **订单系统**: 雪花算法生成唯一订单号
- **支付集成**: 支持多种支付方式
- **提现服务**: 支付宝提现功能
- **交易记录**: 完整的资金流水记录
- **风控系统**: 异常交易检测和风险控制

### 3. 推荐服务 (recommendation)
- **协同过滤**: 基于用户行为的推荐算法
- **内容标签**: 基于内容特征的推荐
- **实时计算**: 在线推荐服务
- **离线训练**: 定期更新推荐模型
- **A/B测试**: 推荐策略效果评估
- **gRPC接口**: 高性能内部服务调用

### 4. 消息队列服务 (messaging)
- **事件总线**: Kafka消息队列
- **数据埋点**: 用户行为数据收集
- **实时处理**: Flink流式计算
- **数据管道**: ETL数据处理流程
- **监控告警**: 消息队列健康监控

### 5. 文件存储服务 (storage)
- **对象存储**: OSS云存储集成
- **CDN加速**: 静态资源分发
- **文件管理**: 上传、下载、删除操作
- **安全控制**: 访问权限和防盗链
- **备份策略**: 数据备份和恢复

### 6. 管理后台服务 (admin)
- **内容审核**: 书籍上线/驳回/下架管理
- **榜单管理**: 人工干预和操作日志
- **用户管理**: 用户信息和权限管理
- **财务管理**: 提现审核和风控
- **系统监控**: 服务状态和性能监控

## 技术架构

### 微服务架构
- **服务注册**: Consul/Etcd服务发现
- **负载均衡**: Nginx/HAProxy负载分发
- **API网关**: 统一入口和路由管理
- **熔断降级**: Hystrix容错机制
- **链路追踪**: Jaeger分布式追踪

### 数据存储
- **关系数据库**: MySQL主从集群
- **文档数据库**: MongoDB分片集群
- **缓存系统**: Redis集群
- **搜索引擎**: Elasticsearch集群
- **消息队列**: Kafka集群

### 监控运维
- **日志收集**: ELK日志分析栈
- **监控告警**: Prometheus + Grafana
- **容器化**: Docker + Kubernetes
- **CI/CD**: Jenkins自动化部署
- **配置管理**: Apollo配置中心

## 服务接口

### 内部服务通信
- **gRPC**: 高性能RPC调用
- **消息队列**: 异步事件通信
- **服务网格**: Istio流量管理

### 外部API接口
- **RESTful API**: 标准HTTP接口
- **GraphQL**: 灵活的数据查询
- **WebSocket**: 实时通信协议

## 相关文档

- [账号权限系统设计](./账号权限系统设计.md)
- [钱包系统设计](./钱包系统设计.md)
- [推荐服务设计](./推荐服务设计.md)
- [消息队列设计](./消息队列设计.md)
- [文件存储设计](./文件存储设计.md)
- [管理后台设计](./管理后台设计)

## 部署架构

### 开发环境
- 单机部署
- Docker Compose编排
- 本地数据库

### 测试环境
- 多服务实例
- 模拟生产环境
- 自动化测试

### 生产环境
- Kubernetes集群
- 高可用部署
- 监控告警完备

## 安全设计

### 数据安全
- 敏感数据加密存储
- 传输层TLS加密
- 数据脱敏和匿名化

### 访问控制
- OAuth2.0授权框架
- API限流和防刷
- 白名单和黑名单机制

### 审计日志
- 操作日志记录
- 安全事件监控
- 合规性审计

## 性能优化

### 缓存策略
- 多级缓存架构
- 缓存预热和更新
- 缓存穿透防护

### 数据库优化
- 读写分离
- 分库分表
- 索引优化

### 服务优化
- 连接池管理
- 异步处理
- 批量操作优化
