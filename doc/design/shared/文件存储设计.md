# 文件存储设计

## 1. 需求概述

### 1.1 功能描述

文件存储系统是青羽平台的核心基础设施服务，提供统一的文件上传、下载、管理和访问能力。系统支持多种文件类型，包括图片、音频、视频、文档等，提供文件的安全存储、快速访问、版本管理和CDN加速功能，确保文件的高可用性、安全性和访问性能。

### 1.2 业务价值

- **统一管理**：提供统一的文件存储和管理接口，简化业务开发
- **高性能访问**：通过CDN和缓存机制提供快速的文件访问体验
- **安全可靠**：多重备份和权限控制确保文件安全
- **成本优化**：智能存储策略和生命周期管理降低存储成本
- **扩展性强**：支持海量文件存储和高并发访问

### 1.3 用户场景

- 用户上传头像、封面图片和个人资料文件
- 内容创作者上传小说封面、插图和音频文件
- 系统生成的报表、日志和备份文件存储
- 移动端应用的离线资源包和更新文件
- 第三方集成的文件同步和备份需求

### 1.4 功能边界

- **包含功能**：文件上传、下载、删除、权限控制、版本管理、CDN分发
- **不包含功能**：文件内容处理、格式转换、病毒扫描

## 2. 架构设计

### 2.1 整体架构
```
┌─────────────────────────────────────────────────────────┐
│                    客户端接入层                          │
│  Web端 + 移动端 + 第三方API + 管理后台                   │
├─────────────────────────────────────────────────────────┤
│                    网关代理层                            │
│  负载均衡 + 限流控制 + 身份认证 + 协议转换               │
├─────────────────────────────────────────────────────────┤
│                   文件服务层                            │
│  上传服务 + 下载服务 + 管理服务 + 权限服务               │
├─────────────────────────────────────────────────────────┤
│                   存储抽象层                            │
│  存储适配器 + 缓存管理 + 元数据管理 + 生命周期管理       │
├─────────────────────────────────────────────────────────┤
│                   物理存储层                            │
│  本地存储 + 对象存储 + CDN + 备份存储                   │
└─────────────────────────────────────────────────────────┘
```

### 2.2 模块划分

- **文件上传模块**：分片上传、断点续传、格式验证、病毒检测
- **文件下载模块**：权限验证、缓存控制、CDN分发、访问统计
- **文件管理模块**：文件信息管理、版本控制、生命周期管理
- **权限控制模块**：访问权限、操作权限、安全策略

## 3. 详细设计

### 3.1 Router层设计

- **路由分组**：/api/v1/files
- **中间件**：身份认证、权限验证、限流、日志记录、监控统计
- **路径规范**：RESTful风格，如 /files/upload, /files/{id}/download
- **参数处理**：文件ID、上传参数、下载参数、权限参数

### 3.2 API层设计

- **接口定义**：文件上传、下载、删除、查询、权限管理接口
- **请求验证**：文件格式验证、大小限制、权限验证、频率限制
- **响应格式**：统一的JSON响应结构，包含文件信息和访问链接
- **错误处理**：上传失败重试、下载降级、权限拒绝处理

### 3.3 Service层设计

- **上传服务**：文件接收、格式验证、存储处理、元数据记录
- **下载服务**：权限验证、文件获取、缓存控制、访问日志
- **管理服务**：文件信息管理、批量操作、统计分析
- **权限服务**：访问控制、权限验证、安全策略执行
- **Repository交互**：通过Repository接口进行元数据和权限数据访问

### 3.4 Repository层设计

- **接口抽象**：FileRepository、PermissionRepository、AccessLogRepository
- **数据查询**：文件信息查询、权限查询、访问记录查询
- **缓存策略**：文件元数据缓存、权限信息缓存、热点文件缓存
- **异常处理**：数据库连接异常、查询超时处理
- **与Model关系**：File、Permission、AccessLog模型的数据映射

### 3.5 Model层设计

- **数据模型**：File、FileVersion、Permission、AccessLog
- **配置模型**：StorageConfig、CDNConfig、SecurityConfig
- **验证逻辑**：文件格式验证、权限规则验证
- **Repository接口**：定义数据访问方法签名

## 4. 数据设计

### 4.1 数据模型

#### 文件模型 (File)

```go
type File struct {
    ID              string            `bson:"_id,omitempty" json:"id"`
    FileName        string            `bson:"file_name" json:"fileName"`
    OriginalName    string            `bson:"original_name" json:"originalName"`
    FilePath        string            `bson:"file_path" json:"filePath"`
    FileSize        int64             `bson:"file_size" json:"fileSize"`
    FileType        string            `bson:"file_type" json:"fileType"`         // image, video, audio, document
    MimeType        string            `bson:"mime_type" json:"mimeType"`
    Extension       string            `bson:"extension" json:"extension"`
    MD5Hash         string            `bson:"md5_hash" json:"md5Hash"`
    SHA256Hash      string            `bson:"sha256_hash" json:"sha256Hash"`
    StorageType     string            `bson:"storage_type" json:"storageType"`   // local, oss, s3, cos
    StoragePath     string            `bson:"storage_path" json:"storagePath"`
    CDNUrl          string            `bson:"cdn_url" json:"cdnUrl"`
    ThumbnailUrl    string            `bson:"thumbnail_url" json:"thumbnailUrl"`
    Status          string            `bson:"status" json:"status"`              // uploading, active, deleted, archived
    UploadedBy      string            `bson:"uploaded_by" json:"uploadedBy"`
    Tags            []string          `bson:"tags" json:"tags"`
    Metadata        map[string]string `bson:"metadata" json:"metadata"`
    DownloadCount   int64             `bson:"download_count" json:"downloadCount"`
    LastAccessTime  time.Time         `bson:"last_access_time" json:"lastAccessTime"`
    ExpiresAt       time.Time         `bson:"expires_at" json:"expiresAt"`
    CreatedAt       time.Time         `bson:"created_at" json:"createdAt"`
    UpdatedAt       time.Time         `bson:"updated_at" json:"updatedAt"`
}
```

#### 文件版本模型 (FileVersion)

```go
type FileVersion struct {
    ID              string            `bson:"_id,omitempty" json:"id"`
    FileID          string            `bson:"file_id" json:"fileId"`
    VersionNumber   int               `bson:"version_number" json:"versionNumber"`
    FileName        string            `bson:"file_name" json:"fileName"`
    FileSize        int64             `bson:"file_size" json:"fileSize"`
    FilePath        string            `bson:"file_path" json:"filePath"`
    MD5Hash         string            `bson:"md5_hash" json:"md5Hash"`
    ChangeLog       string            `bson:"change_log" json:"changeLog"`
    CreatedBy       string            `bson:"created_by" json:"createdBy"`
    Status          string            `bson:"status" json:"status"`              // active, archived, deleted
    CreatedAt       time.Time         `bson:"created_at" json:"createdAt"`
}
```

#### 文件权限模型 (FilePermission)

```go
type FilePermission struct {
    ID              string            `bson:"_id,omitempty" json:"id"`
    FileID          string            `bson:"file_id" json:"fileId"`
    ResourceType    string            `bson:"resource_type" json:"resourceType"` // user, role, group, public
    ResourceID      string            `bson:"resource_id" json:"resourceId"`
    Permissions     []string          `bson:"permissions" json:"permissions"`    // read, write, delete, share
    ExpiresAt       time.Time         `bson:"expires_at" json:"expiresAt"`
    GrantedBy       string            `bson:"granted_by" json:"grantedBy"`
    CreatedAt       time.Time         `bson:"created_at" json:"createdAt"`
    UpdatedAt       time.Time         `bson:"updated_at" json:"updatedAt"`
}
```

#### 访问日志模型 (FileAccessLog)

```go
type FileAccessLog struct {
    ID              string            `bson:"_id,omitempty" json:"id"`
    FileID          string            `bson:"file_id" json:"fileId"`
    UserID          string            `bson:"user_id" json:"userId"`
    Action          string            `bson:"action" json:"action"`              // upload, download, view, delete
    IPAddress       string            `bson:"ip_address" json:"ipAddress"`
    UserAgent       string            `bson:"user_agent" json:"userAgent"`
    Referer         string            `bson:"referer" json:"referer"`
    ResponseSize    int64             `bson:"response_size" json:"responseSize"`
    ResponseTime    int64             `bson:"response_time" json:"responseTime"` // milliseconds
    Status          string            `bson:"status" json:"status"`              // success, failed, denied
    ErrorMessage    string            `bson:"error_message" json:"errorMessage"`
    CreatedAt       time.Time         `bson:"created_at" json:"createdAt"`
}
```

#### 存储配置模型 (StorageConfig)

```go
type StorageConfig struct {
    ID              string            `bson:"_id,omitempty" json:"id"`
    StorageType     string            `bson:"storage_type" json:"storageType"`   // local, oss, s3, cos
    Name            string            `bson:"name" json:"name"`
    Config          map[string]string `bson:"config" json:"config"`
    IsDefault       bool              `bson:"is_default" json:"isDefault"`
    MaxFileSize     int64             `bson:"max_file_size" json:"maxFileSize"`
    AllowedTypes    []string          `bson:"allowed_types" json:"allowedTypes"`
    Status          string            `bson:"status" json:"status"`              // active, inactive
    CreatedAt       time.Time         `bson:"created_at" json:"createdAt"`
    UpdatedAt       time.Time         `bson:"updated_at" json:"updatedAt"`
}
```

### 4.2 数据关系

- File 与 FileVersion：一对多关系，一个文件可有多个版本
- File 与 FilePermission：一对多关系，一个文件可有多个权限设置
- File 与 FileAccessLog：一对多关系，一个文件有多条访问记录
- StorageConfig 与 File：一对多关系，一个存储配置对应多个文件

### 4.3 索引策略

| 集合名称 | 索引字段 | 索引类型 | 说明 |
|---------|---------|---------|------|
| files | md5_hash | unique | 文件MD5唯一索引 |
| files | uploaded_by, created_at | compound | 上传者时间复合索引 |
| files | file_type, status | compound | 文件类型状态复合索引 |
| files | tags | multikey | 标签多键索引 |
| file_versions | file_id, version_number | compound | 文件版本复合索引 |
| file_permissions | file_id, resource_type, resource_id | compound | 文件权限复合索引 |
| file_access_logs | file_id, created_at | compound | 文件访问日志复合索引 |
| file_access_logs | user_id, action, created_at | compound | 用户操作日志复合索引 |
| storage_configs | storage_type, is_default | compound | 存储类型默认配置复合索引 |

### 4.4 数据迁移

- 从现有文件系统迁移文件元数据和存储路径
- 历史访问日志的清理和归档策略
- 权限数据的初始化和验证

## 5. 接口设计

### 5.1 API概览

| 方法 | 路径 | 功能描述 | 权限要求 |
|-----|------|---------|---------|
| POST | /api/v1/files/upload | 上传文件 | 用户认证 |
| POST | /api/v1/files/multipart/init | 初始化分片上传 | 用户认证 |
| POST | /api/v1/files/multipart/upload | 上传文件分片 | 用户认证 |
| POST | /api/v1/files/multipart/complete | 完成分片上传 | 用户认证 |
| GET | /api/v1/files/{id} | 获取文件信息 | 文件权限 |
| GET | /api/v1/files/{id}/download | 下载文件 | 文件权限 |
| DELETE | /api/v1/files/{id} | 删除文件 | 文件权限 |
| POST | /api/v1/files/{id}/permissions | 设置文件权限 | 文件所有者 |
| GET | /api/v1/files/{id}/versions | 获取文件版本列表 | 文件权限 |
| GET | /api/v1/files/search | 搜索文件 | 用户认证 |

### 5.2 请求与响应格式

#### 5.2.1 上传文件 (POST /api/v1/files/upload)

**请求参数**:

```
Content-Type: multipart/form-data

file: [文件二进制数据]
fileName: "example.jpg"
fileType: "image"
tags: "avatar,profile"
isPublic: false
expiresIn: 86400
```

**响应格式**:

```json
{
  "code": 200,
  "message": "文件上传成功",
  "data": {
    "fileId": "file_123456789",
    "fileName": "example.jpg",
    "fileSize": 1024000,
    "fileType": "image",
    "mimeType": "image/jpeg",
    "md5Hash": "d41d8cd98f00b204e9800998ecf8427e",
    "downloadUrl": "https://cdn.example.com/files/file_123456789",
    "thumbnailUrl": "https://cdn.example.com/thumbnails/file_123456789",
    "uploadedAt": "2024-01-15T10:30:00Z"
  }
}
```

#### 5.2.2 初始化分片上传 (POST /api/v1/files/multipart/init)

**请求参数**:

```json
{
  "fileName": "large_video.mp4",
  "fileSize": 104857600,
  "fileType": "video",
  "mimeType": "video/mp4",
  "chunkSize": 5242880,
  "md5Hash": "d41d8cd98f00b204e9800998ecf8427e"
}
```

**响应格式**:

```json
{
  "code": 200,
  "message": "分片上传初始化成功",
  "data": {
    "uploadId": "upload_123456789",
    "fileId": "file_123456789",
    "chunkCount": 20,
    "chunkSize": 5242880,
    "uploadUrls": [
      {
        "chunkIndex": 1,
        "uploadUrl": "https://api.example.com/files/multipart/upload?uploadId=upload_123456789&chunkIndex=1"
      }
    ]
  }
}
```

#### 5.2.3 获取文件信息 (GET /api/v1/files/{id})

**请求参数**:

- id: 文件ID
- includeVersions: 是否包含版本信息，可选
- includePermissions: 是否包含权限信息，可选

**响应格式**:

```json
{
  "code": 200,
  "message": "获取文件信息成功",
  "data": {
    "fileId": "file_123456789",
    "fileName": "example.jpg",
    "originalName": "my_photo.jpg",
    "fileSize": 1024000,
    "fileType": "image",
    "mimeType": "image/jpeg",
    "extension": "jpg",
    "md5Hash": "d41d8cd98f00b204e9800998ecf8427e",
    "downloadUrl": "https://cdn.example.com/files/file_123456789",
    "thumbnailUrl": "https://cdn.example.com/thumbnails/file_123456789",
    "tags": ["avatar", "profile"],
    "downloadCount": 156,
    "lastAccessTime": "2024-01-15T09:30:00Z",
    "uploadedBy": "user_123456",
    "createdAt": "2024-01-15T10:30:00Z",
    "updatedAt": "2024-01-15T10:30:00Z"
  }
}
```

#### 5.2.4 搜索文件 (GET /api/v1/files/search)

**请求参数**:

- keyword: 搜索关键词，可选
- fileType: 文件类型过滤，可选
- tags: 标签过滤，可选
- uploadedBy: 上传者过滤，可选
- startDate: 开始日期，可选
- endDate: 结束日期，可选
- page: 页码，默认1
- pageSize: 每页大小，默认20

**响应格式**:

```json
{
  "code": 200,
  "message": "搜索文件成功",
  "data": {
    "files": [
      {
        "fileId": "file_123456789",
        "fileName": "example.jpg",
        "fileSize": 1024000,
        "fileType": "image",
        "downloadUrl": "https://cdn.example.com/files/file_123456789",
        "thumbnailUrl": "https://cdn.example.com/thumbnails/file_123456789",
        "createdAt": "2024-01-15T10:30:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 156,
      "totalPages": 8
    }
  }
}
```

**状态码**:

- 200: 成功
- 400: 请求参数错误
- 401: 认证失败
- 403: 权限不足
- 404: 文件不存在
- 413: 文件过大
- 415: 不支持的文件类型
- 500: 服务器错误

## 6. 存储策略设计

### 6.1 存储类型

- **本地存储**：开发环境和小规模部署使用
- **对象存储**：生产环境主要存储方案（阿里云OSS、腾讯云COS、AWS S3）
- **CDN存储**：静态资源加速和全球分发
- **备份存储**：冷备份和灾难恢复

### 6.2 存储策略

- **热数据**：频繁访问的文件存储在高性能存储
- **温数据**：中等访问频率的文件存储在标准存储
- **冷数据**：低访问频率的文件存储在归档存储
- **生命周期管理**：自动转换存储类型和清理过期文件

### 6.3 分片上传

- **大文件分片**：超过阈值的文件自动分片上传
- **断点续传**：支持网络中断后的续传功能
- **并发上传**：多个分片并发上传提高速度
- **完整性校验**：分片和整体文件的完整性验证

### 6.4 缓存策略

- **元数据缓存**：文件信息和权限数据缓存
- **内容缓存**：小文件和热点文件内容缓存
- **CDN缓存**：静态资源的全球缓存分发
- **缓存更新**：文件更新时的缓存失效策略

## 7. 安全设计

### 7.1 访问控制

- **身份认证**：基于Token的用户身份验证
- **权限管理**：细粒度的文件访问权限控制
- **临时授权**：支持临时访问链接和时效性控制
- **IP限制**：基于IP地址的访问控制

### 7.2 数据安全

- **文件加密**：敏感文件的加密存储和传输
- **完整性校验**：文件上传和下载的完整性验证
- **病毒扫描**：文件上传时的安全扫描
- **水印保护**：图片和视频的水印添加

### 7.3 传输安全

- **HTTPS传输**：所有文件传输使用HTTPS加密
- **签名验证**：API请求的数字签名验证
- **防盗链**：Referer和Token验证防止盗链
- **限流保护**：防止恶意大量下载和上传

## 8. 测试设计

### 8.1 测试策略

- 单元测试：覆盖所有核心模块和Service方法
- 集成测试：测试文件上传、下载和管理流程
- 性能测试：大文件上传下载和高并发访问测试
- 安全测试：权限控制和安全防护测试

### 8.2 测试用例

- **功能测试**：文件上传、下载、删除、权限管理
- **性能测试**：上传下载速度、并发处理能力
- **安全测试**：权限验证、防盗链、病毒扫描
- **兼容性测试**：不同文件格式和客户端兼容性

### 8.3 监控指标

- **性能指标**：上传下载速度、响应时间、吞吐量
- **可用性指标**：服务可用性、错误率、成功率
- **资源指标**：存储使用量、带宽使用量、CDN命中率
- **安全指标**：异常访问、权限拒绝、病毒检测

## 9. 部署和运维

### 9.1 部署方案

- **微服务部署**：文件服务独立部署和扩展
- **容器化部署**：使用Docker和Kubernetes部署
- **多区域部署**：跨区域部署提高访问速度
- **灰度发布**：新版本的渐进式发布和回滚

### 9.2 监控告警

- **实时监控**：文件服务性能和状态实时监控
- **告警机制**：异常情况的及时告警和通知
- **可视化面板**：监控数据的图表展示和分析
- **日志收集**：集中化的日志收集和分析

### 9.3 运维管理

- **配置管理**：存储配置和CDN配置的动态管理
- **备份恢复**：文件数据的备份和灾难恢复
- **性能调优**：根据访问模式进行性能优化
- **容量规划**：基于业务增长的存储容量规划

## 10. 风险评估

### 10.1 技术风险

- **数据丢失风险**：通过多重备份和冗余存储降低风险
- **性能瓶颈风险**：CDN加速和缓存优化
- **存储成本风险**：生命周期管理和存储优化

### 10.2 业务风险

- **版权风险**：文件版权验证和侵权处理机制
- **存储容量风险**：容量监控和扩展策略
- **访问性能风险**：CDN和缓存策略优化

### 10.3 安全风险

- **数据泄露风险**：权限控制和加密保护
- **恶意上传风险**：文件类型限制和病毒扫描
- **盗链风险**：防盗链机制和访问控制

## 11. 实施计划

### 11.1 基础建设阶段

- 第1-2周：技术选型和架构设计
- 第3-4周：基础框架搭建和存储适配器开发
- 第5-6周：文件上传和下载功能实现

### 11.2 功能完善阶段
- 第7-8周：分片上传和权限控制功能
- 第9-10周：CDN集成和缓存优化
- 第11-12周：监控告警和管理界面开发

### 11.3 上线部署阶段
- 第13周：生产环境部署和配置
- 第14周：灰度发布和功能验证
- 第15周：全量上线和运维交接