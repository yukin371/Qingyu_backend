# 用户验证设计

> **版本**: v1.0  
> **创建日期**: 2025-10-21  
> **状态**: ✅ 已实现，补充设计文档

---

## 1. 设计概述

### 1.1 业务价值

- 用户注册验证（邮箱、用户名）
- 密码强度验证
- 防止恶意注册

### 1.2 实现情况

**已实现**：
- UserValidator：`pkg/validator/user_validator.go`
- 基础验证逻辑集成在UserService

---

## 2. 验证规则设计

### 2.1 用户名验证

```go
type UsernameValidator struct {
    MinLength int  // 最小长度：3
    MaxLength int  // 最大长度：50
    Pattern   *regexp.Regexp  // 允许：字母、数字、下划线
}

func ValidateUsername(username string) error {
    // 1. 长度验证
    if len(username) < 3 || len(username) > 50 {
        return errors.New("用户名长度必须在3-50之间")
    }
    
    // 2. 格式验证（字母、数字、下划线）
    pattern := regexp.MustCompile(`^[a-zA-Z0-9_]+$`)
    if !pattern.MatchString(username) {
        return errors.New("用户名只能包含字母、数字和下划线")
    }
    
    // 3. 敏感词过滤
    if containsSensitiveWord(username) {
        return errors.New("用户名包含敏感词")
    }
    
    // 4. 保留词检查
    reservedWords := []string{"admin", "system", "root", "qingyu"}
    for _, word := range reservedWords {
        if strings.ToLower(username) == word {
            return errors.New("该用户名不可用")
        }
    }
    
    return nil
}
```

### 2.2 邮箱验证

```go
func ValidateEmail(email string) error {
    // 1. 格式验证
    pattern := regexp.MustCompile(`^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$`)
    if !pattern.MatchString(email) {
        return errors.New("邮箱格式不正确")
    }
    
    // 2. 域名白名单（可选）
    allowedDomains := []string{"gmail.com", "qq.com", "163.com", "outlook.com"}
    domain := getDomain(email)
    if !contains(allowedDomains, domain) && !isValidDomain(domain) {
        return errors.New("不支持的邮箱域名")
    }
    
    return nil
}
```

### 2.3 密码强度验证

```go
type PasswordStrength string

const (
    Weak   PasswordStrength = "weak"
    Medium PasswordStrength = "medium"
    Strong PasswordStrength = "strong"
)

func ValidatePassword(password string) (PasswordStrength, error) {
    // 1. 长度验证
    if len(password) < 6 {
        return Weak, errors.New("密码长度不能少于6位")
    }
    
    if len(password) > 100 {
        return Weak, errors.New("密码长度不能超过100位")
    }
    
    // 2. 强度评分
    score := 0
    
    // 包含小写字母
    if regexp.MustCompile(`[a-z]`).MatchString(password) {
        score++
    }
    
    // 包含大写字母
    if regexp.MustCompile(`[A-Z]`).MatchString(password) {
        score++
    }
    
    // 包含数字
    if regexp.MustCompile(`[0-9]`).MatchString(password) {
        score++
    }
    
    // 包含特殊字符
    if regexp.MustCompile(`[!@#$%^&*()_+\-=\[\]{};:'",.<>?]`).MatchString(password) {
        score++
    }
    
    // 长度加分
    if len(password) >= 12 {
        score++
    }
    
    // 3. 判定强度
    var strength PasswordStrength
    if score >= 4 {
        strength = Strong
    } else if score >= 3 {
        strength = Medium
    } else {
        strength = Weak
    }
    
    // 4. 弱密码拒绝
    if strength == Weak {
        return Weak, errors.New("密码强度太弱，请包含大小写字母、数字或特殊字符")
    }
    
    // 5. 常见密码检查
    commonPasswords := []string{"123456", "password", "qwerty", "111111"}
    for _, common := range commonPasswords {
        if strings.ToLower(password) == common {
            return Weak, errors.New("不能使用常见密码")
        }
    }
    
    return strength, nil
}
```

---

## 3. 防止恶意注册设计

### 3.1 IP频率限制

```go
type RateLimiter struct {
    cache cache.Cache
}

func (l *RateLimiter) CheckRegistrationRate(ip string) error {
    key := "register:ip:" + ip
    
    // 获取1小时内的注册次数
    count, _ := l.cache.Get(key)
    if count != nil && count.(int) >= 5 {
        return errors.New("注册过于频繁，请稍后再试")
    }
    
    // 增加计数
    l.cache.Increment(key, 1, 1*time.Hour)
    
    return nil
}
```

### 3.2 邮箱验证码

```go
type EmailVerification struct {
    Email      string
    Code       string
    ExpiresAt  time.Time
    Verified   bool
}

func SendVerificationCode(email string) error {
    // 1. 生成6位验证码
    code := generateRandomCode(6)
    
    // 2. 保存到缓存（5分钟有效）
    key := "verification:email:" + email
    cache.Set(key, code, 5*time.Minute)
    
    // 3. 发送邮件
    emailService.Send(email, "验证码", "您的验证码是："+code)
    
    return nil
}

func VerifyCode(email string, code string) error {
    key := "verification:email:" + email
    
    cached, err := cache.Get(key)
    if err != nil || cached == nil {
        return errors.New("验证码已过期")
    }
    
    if cached.(string) != code {
        return errors.New("验证码错误")
    }
    
    // 验证成功后删除
    cache.Delete(key)
    
    return nil
}
```

---

## 4. UserValidator服务

### 4.1 核心接口

```go
type UserValidator interface {
    // ValidateUsername 验证用户名
    ValidateUsername(username string) error
    
    // ValidateEmail 验证邮箱
    ValidateEmail(email string) error
    
    // ValidatePassword 验证密码
    ValidatePassword(password string) (PasswordStrength, error)
    
    // CheckUniqueUsername 检查用户名唯一性
    CheckUniqueUsername(ctx context.Context, username string) error
    
    // CheckUniqueEmail 检查邮箱唯一性
    CheckUniqueEmail(ctx context.Context, email string) error
    
    // CheckRegistrationRate 检查注册频率
    CheckRegistrationRate(ip string) error
}
```

---

## 5. 集成到UserService

```go
func (s *UserService) CreateUser(ctx context.Context, req *CreateUserRequest) error {
    // 1. 用户名验证
    if err := s.validator.ValidateUsername(req.Username); err != nil {
        return err
    }
    
    // 2. 邮箱验证
    if err := s.validator.ValidateEmail(req.Email); err != nil {
        return err
    }
    
    // 3. 密码强度验证
    strength, err := s.validator.ValidatePassword(req.Password)
    if err != nil {
        return err
    }
    
    // 4. 唯一性验证
    if err := s.validator.CheckUniqueUsername(ctx, req.Username); err != nil {
        return errors.New("用户名已被使用")
    }
    
    if err := s.validator.CheckUniqueEmail(ctx, req.Email); err != nil {
        return errors.New("邮箱已被注册")
    }
    
    // 5. IP频率检查
    ip := req.ClientIP
    if err := s.validator.CheckRegistrationRate(ip); err != nil {
        return err
    }
    
    // 6. 创建用户
    // ...
    
    return nil
}
```

---

## 6. 与v2.1架构的关系

```
Shared Module
  └─ UserValidator
      ├─ UsernameValidator
      ├─ EmailValidator
      ├─ PasswordValidator
      └─ RateLimiter
```

---

## 7. 实现参考

**代码文件**：
- `pkg/validator/user_validator.go` - 用户验证器
- `service/user/user_service.go` - 集成验证逻辑

---

**文档状态**: ✅ 已完成  
**优先级**: P0

