# 安全审计设计

> **架构说明**: 本文档基于**模块化单体架构**设计。
> 
> - ✅ 当前采用单一代码库,统一部署
> - ✅ 通过模块化保持清晰边界
> - ✅ 为未来可能的微服务化预留空间
> 
> 参考:[微服务架构划分建议](../微服务架构划分建议.md)
> 
> **文档状态**: ⏸️ 后续迭代  
> **创建时间**: 2025-10-17  
> **最后更新**: 2025-10-17  
> **实施状态**: 🔴 未开始 (0%)

## 1. 需求概述

### 1.1 功能描述

安全审计系统是青羽平台的安全保障基础设施,负责记录和追踪系统中的关键操作、安全事件和异常行为。系统提供完整的操作日志记录、审计追踪、异常检测、合规报告等功能,确保平台安全可控、行为可追溯、问题可定位。

### 1.2 业务价值

- **安全保障**:记录关键操作,及时发现和追踪安全问题
- **合规要求**:满足数据安全和隐私保护的法律法规要求
- **问题定位**:通过审计日志快速定位问题和责任人
- **运营分析**:分析用户行为和系统使用情况,优化运营策略

### 1.3 用户场景

- 管理员查看用户登录记录和异常登录告警
- 运营人员查看内容审核操作日志
- 财务人员查看订单和交易操作记录
- 安全人员分析异常行为和潜在风险
- 审计人员生成合规报告

### 1.4 功能边界

- **包含功能**:操作日志记录、审计追踪、异常检测、合规报告、日志查询分析
- **不包含功能**:实时入侵检测(IDS)、漏洞扫描、安全加固

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    业务层                                │
│  用户操作 + 管理员操作 + 系统事件                         │
└─────────────────────────────────────────────────────────┘
                         ↓ (产生审计事件)
┌─────────────────────────────────────────────────────────┐
│                  审计拦截器                              │
│  - 中间件拦截                                           │
│  - AOP切面拦截                                          │
│  - 服务层埋点                                           │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│                审计服务层                                │
│  AuditService                                           │
│  ├─ RecordAudit (记录审计日志)                         │
│  ├─ QueryAudit (查询审计日志)                          │
│  ├─ DetectAnomaly (异常检测)                           │
│  └─ GenerateReport (生成报告)                          │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│                  消息队列                                │
│  audit.log / audit.security / audit.operation           │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│              审计日志处理器                              │
│  - 日志过滤和清洗                                       │
│  - 敏感数据脱敏                                         │
│  - 异常规则匹配                                         │
│  - 持久化存储                                           │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│                  存储层                                  │
│  MongoDB (审计日志) + Elasticsearch (全文搜索)           │
└─────────────────────────────────────────────────────────┘
```

### 2.2 审计分类

- **登录审计**:登录、登出、密码修改、异常登录
- **操作审计**:创建、修改、删除关键数据
- **权限审计**:权限变更、角色分配
- **财务审计**:充值、消费、提现、收益分配
- **内容审核**:审核通过、驳回、下架
- **系统审计**:配置变更、系统错误、性能告警

## 3. 详细设计

### 3.1 Service层接口

```go
// AuditService 审计服务接口
type AuditService interface {
    // 记录审计日志
    RecordAudit(ctx context.Context, audit *AuditLog) error
    
    // 批量记录
    RecordAuditBatch(ctx context.Context, audits []*AuditLog) error
    
    // 查询审计日志
    QueryAudit(ctx context.Context, filter *AuditFilter) ([]*AuditLog, error)
    
    // 分页查询
    QueryAuditWithPagination(ctx context.Context, filter *AuditFilter, pagination *Pagination) (*PagedResult[AuditLog], error)
    
    // 统计审计日志
    CountAudit(ctx context.Context, filter *AuditFilter) (int64, error)
    
    // 导出审计报告
    ExportAuditReport(ctx context.Context, filter *AuditFilter, format string) ([]byte, error)
    
    // 异常检测
    DetectAnomalies(ctx context.Context, userID string, timeRange TimeRange) ([]*Anomaly, error)
}
```

### 3.2 数据模型

```go
// 审计事件类型
type AuditEventType string

const (
    // 登录相关
    AuditEventLogin          AuditEventType = "login"           // 登录
    AuditEventLogout         AuditEventType = "logout"          // 登出
    AuditEventPasswordChange AuditEventType = "password_change" // 密码修改
    AuditEventLoginFailed    AuditEventType = "login_failed"    // 登录失败
    
    // 数据操作
    AuditEventCreate         AuditEventType = "create"          // 创建
    AuditEventUpdate         AuditEventType = "update"          // 更新
    AuditEventDelete         AuditEventType = "delete"          // 删除
    AuditEventView           AuditEventType = "view"            // 查看
    
    // 权限操作
    AuditEventRoleAssign     AuditEventType = "role_assign"     // 角色分配
    AuditEventPermissionGrant AuditEventType = "permission_grant" // 权限授予
    
    // 财务操作
    AuditEventRecharge       AuditEventType = "recharge"        // 充值
    AuditEventConsume        AuditEventType = "consume"         // 消费
    AuditEventWithdraw       AuditEventType = "withdraw"        // 提现
    
    // 内容审核
    AuditEventContentReview  AuditEventType = "content_review"  // 内容审核
    AuditEventContentApprove AuditEventType = "content_approve" // 审核通过
    AuditEventContentReject  AuditEventType = "content_reject"  // 审核驳回
)

// 审计级别
type AuditLevel string

const (
    AuditLevelInfo     AuditLevel = "info"     // 信息
    AuditLevelWarning  AuditLevel = "warning"  // 警告
    AuditLevelError    AuditLevel = "error"    // 错误
    AuditLevelCritical AuditLevel = "critical" // 严重
)

// AuditLog 审计日志
type AuditLog struct {
    ID          string         `bson:"_id,omitempty" json:"id"`
    EventType   AuditEventType `bson:"event_type" json:"event_type"`     // 事件类型
    Level       AuditLevel     `bson:"level" json:"level"`               // 审计级别
    UserID      string         `bson:"user_id" json:"user_id"`           // 操作用户ID
    Username    string         `bson:"username" json:"username"`         // 操作用户名
    ResourceType string        `bson:"resource_type" json:"resource_type"` // 资源类型
    ResourceID  string         `bson:"resource_id" json:"resource_id"`   // 资源ID
    Action      string         `bson:"action" json:"action"`             // 操作动作
    Description string         `bson:"description" json:"description"`   // 操作描述
    IPAddress   string         `bson:"ip_address" json:"ip_address"`     // IP地址
    UserAgent   string         `bson:"user_agent" json:"user_agent"`     // 用户代理
    RequestID   string         `bson:"request_id" json:"request_id"`     // 请求ID
    SessionID   string         `bson:"session_id" json:"session_id"`     // 会话ID
    Method      string         `bson:"method" json:"method"`             // HTTP方法
    Path        string         `bson:"path" json:"path"`                 // 请求路径
    StatusCode  int            `bson:"status_code" json:"status_code"`   // 响应状态码
    Duration    int64          `bson:"duration" json:"duration"`         // 处理时长(ms)
    Changes     map[string]interface{} `bson:"changes,omitempty" json:"changes"` // 数据变更
    Metadata    map[string]interface{} `bson:"metadata,omitempty" json:"metadata"` // 元数据
    CreatedAt   time.Time      `bson:"created_at" json:"created_at"`
}

// Anomaly 异常事件
type Anomaly struct {
    ID          string              `json:"id"`
    Type        string              `json:"type"`          // 异常类型
    Severity    string              `json:"severity"`      // 严重程度
    UserID      string              `json:"user_id"`
    Description string              `json:"description"`   // 异常描述
    Evidence    []string            `json:"evidence"`      // 证据(审计日志ID)
    Status      string              `json:"status"`        // 状态(pending/confirmed/false_positive)
    DetectedAt  time.Time           `json:"detected_at"`
    ResolvedAt  *time.Time          `json:"resolved_at,omitempty"`
}
```

### 3.3 审计拦截器

```go
// AuditMiddleware 审计中间件
func AuditMiddleware(auditService AuditService) gin.HandlerFunc {
    return func(c *gin.Context) {
        startTime := time.Now()
        
        // 记录请求信息
        requestID := uuid.New().String()
        c.Set("request_id", requestID)
        
        // 执行请求
        c.Next()
        
        // 记录审计日志
        userID, _ := c.Get("user_id")
        username, _ := c.Get("username")
        
        audit := &AuditLog{
            RequestID:   requestID,
            UserID:      userID.(string),
            Username:    username.(string),
            IPAddress:   c.ClientIP(),
            UserAgent:   c.Request.UserAgent(),
            Method:      c.Request.Method,
            Path:        c.Request.URL.Path,
            StatusCode:  c.Writer.Status(),
            Duration:    time.Since(startTime).Milliseconds(),
            CreatedAt:   time.Now(),
        }
        
        // 异步记录(不阻塞请求)
        go auditService.RecordAudit(context.Background(), audit)
    }
}
```

### 3.4 关键操作审计

```go
// 记录数据变更审计
func RecordDataChangeAudit(ctx context.Context, auditService AuditService, 
    eventType AuditEventType, resourceType, resourceID string, 
    oldData, newData interface{}) error {
    
    // 计算变更内容
    changes := calculateChanges(oldData, newData)
    
    // 获取当前用户信息
    userID := ctx.Value("user_id").(string)
    username := ctx.Value("username").(string)
    
    audit := &AuditLog{
        EventType:    eventType,
        Level:        AuditLevelInfo,
        UserID:       userID,
        Username:     username,
        ResourceType: resourceType,
        ResourceID:   resourceID,
        Action:       string(eventType),
        Description:  fmt.Sprintf("用户 %s %s了 %s", username, eventType, resourceType),
        Changes:      changes,
        CreatedAt:    time.Now(),
    }
    
    return auditService.RecordAudit(ctx, audit)
}

// 示例:用户修改书籍信息时记录审计
func (s *BookService) UpdateBook(ctx context.Context, bookID string, updates map[string]interface{}) error {
    // 1. 获取旧数据
    oldBook, err := s.bookRepo.GetByID(ctx, bookID)
    if err != nil {
        return err
    }
    
    // 2. 更新数据库
    err = s.bookRepo.Update(ctx, bookID, updates)
    if err != nil {
        return err
    }
    
    // 3. 获取新数据
    newBook, _ := s.bookRepo.GetByID(ctx, bookID)
    
    // 4. 记录审计日志
    RecordDataChangeAudit(ctx, s.auditService, AuditEventUpdate, "book", bookID, oldBook, newBook)
    
    return nil
}
```

### 3.5 异常检测

```go
// 异常检测规则
type AnomalyDetector struct {
    auditRepo AuditRepository
}

// DetectAnomalies 检测异常
func (d *AnomalyDetector) DetectAnomalies(ctx context.Context, userID string, timeRange TimeRange) ([]*Anomaly, error) {
    var anomalies []*Anomaly
    
    // 1. 检测异地登录
    locations := d.detectMultiLocationLogin(ctx, userID, timeRange)
    if len(locations) > 0 {
        anomalies = append(anomalies, &Anomaly{
            Type:        "multi_location_login",
            Severity:    "high",
            UserID:      userID,
            Description: fmt.Sprintf("检测到用户在%d个不同地点登录", len(locations)),
            DetectedAt:  time.Now(),
        })
    }
    
    // 2. 检测频繁登录失败
    failedLogins := d.countFailedLogins(ctx, userID, timeRange)
    if failedLogins > 5 {
        anomalies = append(anomalies, &Anomaly{
            Type:        "frequent_login_failed",
            Severity:    "medium",
            UserID:      userID,
            Description: fmt.Sprintf("检测到%d次登录失败", failedLogins),
            DetectedAt:  time.Now(),
        })
    }
    
    // 3. 检测异常操作频率
    operationCount := d.countOperations(ctx, userID, timeRange)
    if operationCount > 1000 { // 假设阈值
        anomalies = append(anomalies, &Anomaly{
            Type:        "high_operation_frequency",
            Severity:    "low",
            UserID:      userID,
            Description: fmt.Sprintf("检测到异常高的操作频率: %d次", operationCount),
            DetectedAt:  time.Now(),
        })
    }
    
    // 4. 检测异常金额操作
    largeTransactions := d.detectLargeTransactions(ctx, userID, timeRange)
    if len(largeTransactions) > 0 {
        anomalies = append(anomalies, &Anomaly{
            Type:        "large_transaction",
            Severity:    "high",
            UserID:      userID,
            Description: "检测到大额交易",
            Evidence:    largeTransactions,
            DetectedAt:  time.Now(),
        })
    }
    
    return anomalies, nil
}
```

### 3.6 敏感数据脱敏

```go
// 审计日志脱敏处理
func (s *AuditServiceImpl) sanitizeAuditLog(audit *AuditLog) {
    // 脱敏IP地址(保留前3段)
    if audit.IPAddress != "" {
        parts := strings.Split(audit.IPAddress, ".")
        if len(parts) == 4 {
            audit.IPAddress = fmt.Sprintf("%s.%s.%s.***", parts[0], parts[1], parts[2])
        }
    }
    
    // 脱敏敏感字段
    if audit.Changes != nil {
        sensitiveFields := []string{"password", "id_card", "bank_account", "phone"}
        for _, field := range sensitiveFields {
            if _, exists := audit.Changes[field]; exists {
                audit.Changes[field] = "***"
            }
        }
    }
    
    // 脱敏UserAgent(移除详细版本号)
    audit.UserAgent = simplifyUserAgent(audit.UserAgent)
}
```

## 4. API接口设计

```go
// 管理员:查询审计日志
GET /admin/api/v1/audits
Query参数:
- event_type: 事件类型
- user_id: 用户ID
- resource_type: 资源类型
- start_time: 开始时间
- end_time: 结束时间
- page: 页码
- page_size: 每页数量

// 管理员:导出审计报告
GET /admin/api/v1/audits/export
Query参数:
- format: 导出格式(csv/excel/pdf)
- ... (同上)

// 管理员:查看异常事件
GET /admin/api/v1/anomalies
Query参数:
- type: 异常类型
- severity: 严重程度
- status: 状态

// 管理员:处理异常事件
PUT /admin/api/v1/anomalies/:id
Body:
{
    "status": "confirmed",
    "action": "block_user",
    "notes": "确认为恶意行为,封禁用户"
}
```

## 5. 数据库设计

### 5.1 MongoDB集合

```javascript
// audit_logs 集合
{
    "_id": ObjectId("..."),
    "event_type": "login",
    "level": "info",
    "user_id": "user_123",
    "username": "zhangsan",
    "resource_type": "user",
    "resource_id": "user_123",
    "action": "login",
    "description": "用户登录",
    "ip_address": "192.168.1.***",
    "user_agent": "Chrome 118",
    "request_id": "req_abc123",
    "session_id": "session_xyz",
    "method": "POST",
    "path": "/api/v1/auth/login",
    "status_code": 200,
    "duration": 235,
    "created_at": ISODate("2025-10-17T10:00:00Z")
}

// 索引设计
db.audit_logs.createIndex({ "user_id": 1, "created_at": -1 })
db.audit_logs.createIndex({ "event_type": 1, "created_at": -1 })
db.audit_logs.createIndex({ "resource_type": 1, "resource_id": 1 })
db.audit_logs.createIndex({ "created_at": -1 })
db.audit_logs.createIndex({ "request_id": 1 }, { unique: true })

// TTL索引(自动删除90天前的日志)
db.audit_logs.createIndex({ "created_at": 1 }, { expireAfterSeconds: 7776000 })

// anomalies 集合
{
    "_id": ObjectId("..."),
    "type": "multi_location_login",
    "severity": "high",
    "user_id": "user_123",
    "description": "检测到用户在3个不同地点登录",
    "evidence": ["log_1", "log_2", "log_3"],
    "status": "pending",
    "detected_at": ISODate("2025-10-17T10:00:00Z")
}

// 索引设计
db.anomalies.createIndex({ "user_id": 1, "detected_at": -1 })
db.anomalies.createIndex({ "type": 1, "severity": 1 })
db.anomalies.createIndex({ "status": 1 })
```

### 5.2 Elasticsearch索引(可选,用于全文搜索)

```json
{
  "mappings": {
    "properties": {
      "event_type": { "type": "keyword" },
      "level": { "type": "keyword" },
      "user_id": { "type": "keyword" },
      "username": { "type": "keyword" },
      "description": { "type": "text" },
      "ip_address": { "type": "ip" },
      "created_at": { "type": "date" }
    }
  }
}
```

## 6. 性能优化

### 6.1 异步记录

- 审计日志通过消息队列异步写入,不阻塞业务流程
- 批量写入MongoDB,提高写入效率

### 6.2 日志分级存储

- 热数据(最近7天):MongoDB
- 温数据(7-90天):MongoDB(压缩)
- 冷数据(90天以上):归档到对象存储或删除

### 6.3 查询优化

- 合理的索引设计
- 使用Elasticsearch进行复杂查询和全文搜索
- 查询结果缓存(短时间缓存)

## 7. 合规要求

### 7.1 数据保留

- 关键操作日志至少保留6个月
- 财务相关日志至少保留3年
- 支持法律要求的日志调取

### 7.2 数据保护

- 敏感数据脱敏处理
- 审计日志加密存储
- 审计日志访问控制(仅管理员可查看)

### 7.3 审计完整性

- 审计日志不可篡改
- 审计日志完整性校验(哈希值)
- 定期备份审计日志

## 8. MVP范围

### 8.1 MVP核心功能 ❌

**注意**: 安全审计属于后续迭代功能,MVP阶段暂不实施

### 8.2 后续迭代功能 ⏸️

- ⏸️ 基础审计日志记录
- ⏸️ 审计日志查询和导出
- ⏸️ 异常检测规则引擎
- ⏸️ 审计报告生成
- ⏸️ 实时告警

## 9. 相关文档

- [管理后台设计](./管理后台设计.md)
- [会话管理设计](./会话管理设计.md)
- [安全设计与威胁建模](../security/安全设计与威胁建模.md)
- [日志规范与ELK Stack落地](../ops/日志规范与ELK Stack落地.md)

---

**文档维护**: 青羽后端架构团队  
**最后更新**: 2025-10-17

