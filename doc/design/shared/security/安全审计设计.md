# å®‰å…¨å®¡è®¡è®¾è®¡

> **æ¶æ„è¯´æ˜**: æœ¬æ–‡æ¡£åŸºäº**æ¨¡å—åŒ–å•ä½“æ¶æ„**è®¾è®¡ã€‚
> 
> - âœ… å½“å‰é‡‡ç”¨å•ä¸€ä»£ç åº“,ç»Ÿä¸€éƒ¨ç½²
> - âœ… é€šè¿‡æ¨¡å—åŒ–ä¿æŒæ¸…æ™°è¾¹ç•Œ
> - âœ… ä¸ºæœªæ¥å¯èƒ½çš„å¾®æœåŠ¡åŒ–é¢„ç•™ç©ºé—´
> 
> å‚è€ƒ:[å¾®æœåŠ¡æ¶æ„åˆ’åˆ†å»ºè®®](../å¾®æœåŠ¡æ¶æ„åˆ’åˆ†å»ºè®®.md)
> 
> **æ–‡æ¡£çŠ¶æ€**: â¸ï¸ åç»­è¿­ä»£  
> **åˆ›å»ºæ—¶é—´**: 2025-10-17  
> **æœ€åæ›´æ–°**: 2025-10-17  
> **å®æ–½çŠ¶æ€**: ğŸ”´ æœªå¼€å§‹ (0%)

## 1. éœ€æ±‚æ¦‚è¿°

### 1.1 åŠŸèƒ½æè¿°

å®‰å…¨å®¡è®¡ç³»ç»Ÿæ˜¯é’ç¾½å¹³å°çš„å®‰å…¨ä¿éšœåŸºç¡€è®¾æ–½,è´Ÿè´£è®°å½•å’Œè¿½è¸ªç³»ç»Ÿä¸­çš„å…³é”®æ“ä½œã€å®‰å…¨äº‹ä»¶å’Œå¼‚å¸¸è¡Œä¸ºã€‚ç³»ç»Ÿæä¾›å®Œæ•´çš„æ“ä½œæ—¥å¿—è®°å½•ã€å®¡è®¡è¿½è¸ªã€å¼‚å¸¸æ£€æµ‹ã€åˆè§„æŠ¥å‘Šç­‰åŠŸèƒ½,ç¡®ä¿å¹³å°å®‰å…¨å¯æ§ã€è¡Œä¸ºå¯è¿½æº¯ã€é—®é¢˜å¯å®šä½ã€‚

### 1.2 ä¸šåŠ¡ä»·å€¼

- **å®‰å…¨ä¿éšœ**:è®°å½•å…³é”®æ“ä½œ,åŠæ—¶å‘ç°å’Œè¿½è¸ªå®‰å…¨é—®é¢˜
- **åˆè§„è¦æ±‚**:æ»¡è¶³æ•°æ®å®‰å…¨å’Œéšç§ä¿æŠ¤çš„æ³•å¾‹æ³•è§„è¦æ±‚
- **é—®é¢˜å®šä½**:é€šè¿‡å®¡è®¡æ—¥å¿—å¿«é€Ÿå®šä½é—®é¢˜å’Œè´£ä»»äºº
- **è¿è¥åˆ†æ**:åˆ†æç”¨æˆ·è¡Œä¸ºå’Œç³»ç»Ÿä½¿ç”¨æƒ…å†µ,ä¼˜åŒ–è¿è¥ç­–ç•¥

### 1.3 ç”¨æˆ·åœºæ™¯

- ç®¡ç†å‘˜æŸ¥çœ‹ç”¨æˆ·ç™»å½•è®°å½•å’Œå¼‚å¸¸ç™»å½•å‘Šè­¦
- è¿è¥äººå‘˜æŸ¥çœ‹å†…å®¹å®¡æ ¸æ“ä½œæ—¥å¿—
- è´¢åŠ¡äººå‘˜æŸ¥çœ‹è®¢å•å’Œäº¤æ˜“æ“ä½œè®°å½•
- å®‰å…¨äººå‘˜åˆ†æå¼‚å¸¸è¡Œä¸ºå’Œæ½œåœ¨é£é™©
- å®¡è®¡äººå‘˜ç”Ÿæˆåˆè§„æŠ¥å‘Š

### 1.4 åŠŸèƒ½è¾¹ç•Œ

- **åŒ…å«åŠŸèƒ½**:æ“ä½œæ—¥å¿—è®°å½•ã€å®¡è®¡è¿½è¸ªã€å¼‚å¸¸æ£€æµ‹ã€åˆè§„æŠ¥å‘Šã€æ—¥å¿—æŸ¥è¯¢åˆ†æ
- **ä¸åŒ…å«åŠŸèƒ½**:å®æ—¶å…¥ä¾µæ£€æµ‹(IDS)ã€æ¼æ´æ‰«æã€å®‰å…¨åŠ å›º

## 2. æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸šåŠ¡å±‚                                â”‚
â”‚  ç”¨æˆ·æ“ä½œ + ç®¡ç†å‘˜æ“ä½œ + ç³»ç»Ÿäº‹ä»¶                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“ (äº§ç”Ÿå®¡è®¡äº‹ä»¶)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å®¡è®¡æ‹¦æˆªå™¨                              â”‚
â”‚  - ä¸­é—´ä»¶æ‹¦æˆª                                           â”‚
â”‚  - AOPåˆ‡é¢æ‹¦æˆª                                          â”‚
â”‚  - æœåŠ¡å±‚åŸ‹ç‚¹                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                å®¡è®¡æœåŠ¡å±‚                                â”‚
â”‚  AuditService                                           â”‚
â”‚  â”œâ”€ RecordAudit (è®°å½•å®¡è®¡æ—¥å¿—)                         â”‚
â”‚  â”œâ”€ QueryAudit (æŸ¥è¯¢å®¡è®¡æ—¥å¿—)                          â”‚
â”‚  â”œâ”€ DetectAnomaly (å¼‚å¸¸æ£€æµ‹)                           â”‚
â”‚  â””â”€ GenerateReport (ç”ŸæˆæŠ¥å‘Š)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ¶ˆæ¯é˜Ÿåˆ—                                â”‚
â”‚  audit.log / audit.security / audit.operation           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å®¡è®¡æ—¥å¿—å¤„ç†å™¨                              â”‚
â”‚  - æ—¥å¿—è¿‡æ»¤å’Œæ¸…æ´—                                       â”‚
â”‚  - æ•æ„Ÿæ•°æ®è„±æ•                                         â”‚
â”‚  - å¼‚å¸¸è§„åˆ™åŒ¹é…                                         â”‚
â”‚  - æŒä¹…åŒ–å­˜å‚¨                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å­˜å‚¨å±‚                                  â”‚
â”‚  MongoDB (å®¡è®¡æ—¥å¿—) + Elasticsearch (å…¨æ–‡æœç´¢)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å®¡è®¡åˆ†ç±»

- **ç™»å½•å®¡è®¡**:ç™»å½•ã€ç™»å‡ºã€å¯†ç ä¿®æ”¹ã€å¼‚å¸¸ç™»å½•
- **æ“ä½œå®¡è®¡**:åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤å…³é”®æ•°æ®
- **æƒé™å®¡è®¡**:æƒé™å˜æ›´ã€è§’è‰²åˆ†é…
- **è´¢åŠ¡å®¡è®¡**:å……å€¼ã€æ¶ˆè´¹ã€æç°ã€æ”¶ç›Šåˆ†é…
- **å†…å®¹å®¡æ ¸**:å®¡æ ¸é€šè¿‡ã€é©³å›ã€ä¸‹æ¶
- **ç³»ç»Ÿå®¡è®¡**:é…ç½®å˜æ›´ã€ç³»ç»Ÿé”™è¯¯ã€æ€§èƒ½å‘Šè­¦

## 3. è¯¦ç»†è®¾è®¡

### 3.1 Serviceå±‚æ¥å£

```go
// AuditService å®¡è®¡æœåŠ¡æ¥å£
type AuditService interface {
    // è®°å½•å®¡è®¡æ—¥å¿—
    RecordAudit(ctx context.Context, audit *AuditLog) error
    
    // æ‰¹é‡è®°å½•
    RecordAuditBatch(ctx context.Context, audits []*AuditLog) error
    
    // æŸ¥è¯¢å®¡è®¡æ—¥å¿—
    QueryAudit(ctx context.Context, filter *AuditFilter) ([]*AuditLog, error)
    
    // åˆ†é¡µæŸ¥è¯¢
    QueryAuditWithPagination(ctx context.Context, filter *AuditFilter, pagination *Pagination) (*PagedResult[AuditLog], error)
    
    // ç»Ÿè®¡å®¡è®¡æ—¥å¿—
    CountAudit(ctx context.Context, filter *AuditFilter) (int64, error)
    
    // å¯¼å‡ºå®¡è®¡æŠ¥å‘Š
    ExportAuditReport(ctx context.Context, filter *AuditFilter, format string) ([]byte, error)
    
    // å¼‚å¸¸æ£€æµ‹
    DetectAnomalies(ctx context.Context, userID string, timeRange TimeRange) ([]*Anomaly, error)
}
```

### 3.2 æ•°æ®æ¨¡å‹

```go
// å®¡è®¡äº‹ä»¶ç±»å‹
type AuditEventType string

const (
    // ç™»å½•ç›¸å…³
    AuditEventLogin          AuditEventType = "login"           // ç™»å½•
    AuditEventLogout         AuditEventType = "logout"          // ç™»å‡º
    AuditEventPasswordChange AuditEventType = "password_change" // å¯†ç ä¿®æ”¹
    AuditEventLoginFailed    AuditEventType = "login_failed"    // ç™»å½•å¤±è´¥
    
    // æ•°æ®æ“ä½œ
    AuditEventCreate         AuditEventType = "create"          // åˆ›å»º
    AuditEventUpdate         AuditEventType = "update"          // æ›´æ–°
    AuditEventDelete         AuditEventType = "delete"          // åˆ é™¤
    AuditEventView           AuditEventType = "view"            // æŸ¥çœ‹
    
    // æƒé™æ“ä½œ
    AuditEventRoleAssign     AuditEventType = "role_assign"     // è§’è‰²åˆ†é…
    AuditEventPermissionGrant AuditEventType = "permission_grant" // æƒé™æˆäºˆ
    
    // è´¢åŠ¡æ“ä½œ
    AuditEventRecharge       AuditEventType = "recharge"        // å……å€¼
    AuditEventConsume        AuditEventType = "consume"         // æ¶ˆè´¹
    AuditEventWithdraw       AuditEventType = "withdraw"        // æç°
    
    // å†…å®¹å®¡æ ¸
    AuditEventContentReview  AuditEventType = "content_review"  // å†…å®¹å®¡æ ¸
    AuditEventContentApprove AuditEventType = "content_approve" // å®¡æ ¸é€šè¿‡
    AuditEventContentReject  AuditEventType = "content_reject"  // å®¡æ ¸é©³å›
)

// å®¡è®¡çº§åˆ«
type AuditLevel string

const (
    AuditLevelInfo     AuditLevel = "info"     // ä¿¡æ¯
    AuditLevelWarning  AuditLevel = "warning"  // è­¦å‘Š
    AuditLevelError    AuditLevel = "error"    // é”™è¯¯
    AuditLevelCritical AuditLevel = "critical" // ä¸¥é‡
)

// AuditLog å®¡è®¡æ—¥å¿—
type AuditLog struct {
    ID          string         `bson:"_id,omitempty" json:"id"`
    EventType   AuditEventType `bson:"event_type" json:"event_type"`     // äº‹ä»¶ç±»å‹
    Level       AuditLevel     `bson:"level" json:"level"`               // å®¡è®¡çº§åˆ«
    UserID      string         `bson:"user_id" json:"user_id"`           // æ“ä½œç”¨æˆ·ID
    Username    string         `bson:"username" json:"username"`         // æ“ä½œç”¨æˆ·å
    ResourceType string        `bson:"resource_type" json:"resource_type"` // èµ„æºç±»å‹
    ResourceID  string         `bson:"resource_id" json:"resource_id"`   // èµ„æºID
    Action      string         `bson:"action" json:"action"`             // æ“ä½œåŠ¨ä½œ
    Description string         `bson:"description" json:"description"`   // æ“ä½œæè¿°
    IPAddress   string         `bson:"ip_address" json:"ip_address"`     // IPåœ°å€
    UserAgent   string         `bson:"user_agent" json:"user_agent"`     // ç”¨æˆ·ä»£ç†
    RequestID   string         `bson:"request_id" json:"request_id"`     // è¯·æ±‚ID
    SessionID   string         `bson:"session_id" json:"session_id"`     // ä¼šè¯ID
    Method      string         `bson:"method" json:"method"`             // HTTPæ–¹æ³•
    Path        string         `bson:"path" json:"path"`                 // è¯·æ±‚è·¯å¾„
    StatusCode  int            `bson:"status_code" json:"status_code"`   // å“åº”çŠ¶æ€ç 
    Duration    int64          `bson:"duration" json:"duration"`         // å¤„ç†æ—¶é•¿(ms)
    Changes     map[string]interface{} `bson:"changes,omitempty" json:"changes"` // æ•°æ®å˜æ›´
    Metadata    map[string]interface{} `bson:"metadata,omitempty" json:"metadata"` // å…ƒæ•°æ®
    CreatedAt   time.Time      `bson:"created_at" json:"created_at"`
}

// Anomaly å¼‚å¸¸äº‹ä»¶
type Anomaly struct {
    ID          string              `json:"id"`
    Type        string              `json:"type"`          // å¼‚å¸¸ç±»å‹
    Severity    string              `json:"severity"`      // ä¸¥é‡ç¨‹åº¦
    UserID      string              `json:"user_id"`
    Description string              `json:"description"`   // å¼‚å¸¸æè¿°
    Evidence    []string            `json:"evidence"`      // è¯æ®(å®¡è®¡æ—¥å¿—ID)
    Status      string              `json:"status"`        // çŠ¶æ€(pending/confirmed/false_positive)
    DetectedAt  time.Time           `json:"detected_at"`
    ResolvedAt  *time.Time          `json:"resolved_at,omitempty"`
}
```

### 3.3 å®¡è®¡æ‹¦æˆªå™¨

```go
// AuditMiddleware å®¡è®¡ä¸­é—´ä»¶
func AuditMiddleware(auditService AuditService) gin.HandlerFunc {
    return func(c *gin.Context) {
        startTime := time.Now()
        
        // è®°å½•è¯·æ±‚ä¿¡æ¯
        requestID := uuid.New().String()
        c.Set("request_id", requestID)
        
        // æ‰§è¡Œè¯·æ±‚
        c.Next()
        
        // è®°å½•å®¡è®¡æ—¥å¿—
        userID, _ := c.Get("user_id")
        username, _ := c.Get("username")
        
        audit := &AuditLog{
            RequestID:   requestID,
            UserID:      userID.(string),
            Username:    username.(string),
            IPAddress:   c.ClientIP(),
            UserAgent:   c.Request.UserAgent(),
            Method:      c.Request.Method,
            Path:        c.Request.URL.Path,
            StatusCode:  c.Writer.Status(),
            Duration:    time.Since(startTime).Milliseconds(),
            CreatedAt:   time.Now(),
        }
        
        // å¼‚æ­¥è®°å½•(ä¸é˜»å¡è¯·æ±‚)
        go auditService.RecordAudit(context.Background(), audit)
    }
}
```

### 3.4 å…³é”®æ“ä½œå®¡è®¡

```go
// è®°å½•æ•°æ®å˜æ›´å®¡è®¡
func RecordDataChangeAudit(ctx context.Context, auditService AuditService, 
    eventType AuditEventType, resourceType, resourceID string, 
    oldData, newData interface{}) error {
    
    // è®¡ç®—å˜æ›´å†…å®¹
    changes := calculateChanges(oldData, newData)
    
    // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
    userID := ctx.Value("user_id").(string)
    username := ctx.Value("username").(string)
    
    audit := &AuditLog{
        EventType:    eventType,
        Level:        AuditLevelInfo,
        UserID:       userID,
        Username:     username,
        ResourceType: resourceType,
        ResourceID:   resourceID,
        Action:       string(eventType),
        Description:  fmt.Sprintf("ç”¨æˆ· %s %säº† %s", username, eventType, resourceType),
        Changes:      changes,
        CreatedAt:    time.Now(),
    }
    
    return auditService.RecordAudit(ctx, audit)
}

// ç¤ºä¾‹:ç”¨æˆ·ä¿®æ”¹ä¹¦ç±ä¿¡æ¯æ—¶è®°å½•å®¡è®¡
func (s *BookService) UpdateBook(ctx context.Context, bookID string, updates map[string]interface{}) error {
    // 1. è·å–æ—§æ•°æ®
    oldBook, err := s.bookRepo.GetByID(ctx, bookID)
    if err != nil {
        return err
    }
    
    // 2. æ›´æ–°æ•°æ®åº“
    err = s.bookRepo.Update(ctx, bookID, updates)
    if err != nil {
        return err
    }
    
    // 3. è·å–æ–°æ•°æ®
    newBook, _ := s.bookRepo.GetByID(ctx, bookID)
    
    // 4. è®°å½•å®¡è®¡æ—¥å¿—
    RecordDataChangeAudit(ctx, s.auditService, AuditEventUpdate, "book", bookID, oldBook, newBook)
    
    return nil
}
```

### 3.5 å¼‚å¸¸æ£€æµ‹

```go
// å¼‚å¸¸æ£€æµ‹è§„åˆ™
type AnomalyDetector struct {
    auditRepo AuditRepository
}

// DetectAnomalies æ£€æµ‹å¼‚å¸¸
func (d *AnomalyDetector) DetectAnomalies(ctx context.Context, userID string, timeRange TimeRange) ([]*Anomaly, error) {
    var anomalies []*Anomaly
    
    // 1. æ£€æµ‹å¼‚åœ°ç™»å½•
    locations := d.detectMultiLocationLogin(ctx, userID, timeRange)
    if len(locations) > 0 {
        anomalies = append(anomalies, &Anomaly{
            Type:        "multi_location_login",
            Severity:    "high",
            UserID:      userID,
            Description: fmt.Sprintf("æ£€æµ‹åˆ°ç”¨æˆ·åœ¨%dä¸ªä¸åŒåœ°ç‚¹ç™»å½•", len(locations)),
            DetectedAt:  time.Now(),
        })
    }
    
    // 2. æ£€æµ‹é¢‘ç¹ç™»å½•å¤±è´¥
    failedLogins := d.countFailedLogins(ctx, userID, timeRange)
    if failedLogins > 5 {
        anomalies = append(anomalies, &Anomaly{
            Type:        "frequent_login_failed",
            Severity:    "medium",
            UserID:      userID,
            Description: fmt.Sprintf("æ£€æµ‹åˆ°%dæ¬¡ç™»å½•å¤±è´¥", failedLogins),
            DetectedAt:  time.Now(),
        })
    }
    
    // 3. æ£€æµ‹å¼‚å¸¸æ“ä½œé¢‘ç‡
    operationCount := d.countOperations(ctx, userID, timeRange)
    if operationCount > 1000 { // å‡è®¾é˜ˆå€¼
        anomalies = append(anomalies, &Anomaly{
            Type:        "high_operation_frequency",
            Severity:    "low",
            UserID:      userID,
            Description: fmt.Sprintf("æ£€æµ‹åˆ°å¼‚å¸¸é«˜çš„æ“ä½œé¢‘ç‡: %dæ¬¡", operationCount),
            DetectedAt:  time.Now(),
        })
    }
    
    // 4. æ£€æµ‹å¼‚å¸¸é‡‘é¢æ“ä½œ
    largeTransactions := d.detectLargeTransactions(ctx, userID, timeRange)
    if len(largeTransactions) > 0 {
        anomalies = append(anomalies, &Anomaly{
            Type:        "large_transaction",
            Severity:    "high",
            UserID:      userID,
            Description: "æ£€æµ‹åˆ°å¤§é¢äº¤æ˜“",
            Evidence:    largeTransactions,
            DetectedAt:  time.Now(),
        })
    }
    
    return anomalies, nil
}
```

### 3.6 æ•æ„Ÿæ•°æ®è„±æ•

```go
// å®¡è®¡æ—¥å¿—è„±æ•å¤„ç†
func (s *AuditServiceImpl) sanitizeAuditLog(audit *AuditLog) {
    // è„±æ•IPåœ°å€(ä¿ç•™å‰3æ®µ)
    if audit.IPAddress != "" {
        parts := strings.Split(audit.IPAddress, ".")
        if len(parts) == 4 {
            audit.IPAddress = fmt.Sprintf("%s.%s.%s.***", parts[0], parts[1], parts[2])
        }
    }
    
    // è„±æ•æ•æ„Ÿå­—æ®µ
    if audit.Changes != nil {
        sensitiveFields := []string{"password", "id_card", "bank_account", "phone"}
        for _, field := range sensitiveFields {
            if _, exists := audit.Changes[field]; exists {
                audit.Changes[field] = "***"
            }
        }
    }
    
    // è„±æ•UserAgent(ç§»é™¤è¯¦ç»†ç‰ˆæœ¬å·)
    audit.UserAgent = simplifyUserAgent(audit.UserAgent)
}
```

## 4. APIæ¥å£è®¾è®¡

```go
// ç®¡ç†å‘˜:æŸ¥è¯¢å®¡è®¡æ—¥å¿—
GET /admin/api/v1/audits
Queryå‚æ•°:
- event_type: äº‹ä»¶ç±»å‹
- user_id: ç”¨æˆ·ID
- resource_type: èµ„æºç±»å‹
- start_time: å¼€å§‹æ—¶é—´
- end_time: ç»“æŸæ—¶é—´
- page: é¡µç 
- page_size: æ¯é¡µæ•°é‡

// ç®¡ç†å‘˜:å¯¼å‡ºå®¡è®¡æŠ¥å‘Š
GET /admin/api/v1/audits/export
Queryå‚æ•°:
- format: å¯¼å‡ºæ ¼å¼(csv/excel/pdf)
- ... (åŒä¸Š)

// ç®¡ç†å‘˜:æŸ¥çœ‹å¼‚å¸¸äº‹ä»¶
GET /admin/api/v1/anomalies
Queryå‚æ•°:
- type: å¼‚å¸¸ç±»å‹
- severity: ä¸¥é‡ç¨‹åº¦
- status: çŠ¶æ€

// ç®¡ç†å‘˜:å¤„ç†å¼‚å¸¸äº‹ä»¶
PUT /admin/api/v1/anomalies/:id
Body:
{
    "status": "confirmed",
    "action": "block_user",
    "notes": "ç¡®è®¤ä¸ºæ¶æ„è¡Œä¸º,å°ç¦ç”¨æˆ·"
}
```

## 5. æ•°æ®åº“è®¾è®¡

### 5.1 MongoDBé›†åˆ

```javascript
// audit_logs é›†åˆ
{
    "_id": ObjectId("..."),
    "event_type": "login",
    "level": "info",
    "user_id": "user_123",
    "username": "zhangsan",
    "resource_type": "user",
    "resource_id": "user_123",
    "action": "login",
    "description": "ç”¨æˆ·ç™»å½•",
    "ip_address": "192.168.1.***",
    "user_agent": "Chrome 118",
    "request_id": "req_abc123",
    "session_id": "session_xyz",
    "method": "POST",
    "path": "/api/v1/auth/login",
    "status_code": 200,
    "duration": 235,
    "created_at": ISODate("2025-10-17T10:00:00Z")
}

// ç´¢å¼•è®¾è®¡
db.audit_logs.createIndex({ "user_id": 1, "created_at": -1 })
db.audit_logs.createIndex({ "event_type": 1, "created_at": -1 })
db.audit_logs.createIndex({ "resource_type": 1, "resource_id": 1 })
db.audit_logs.createIndex({ "created_at": -1 })
db.audit_logs.createIndex({ "request_id": 1 }, { unique: true })

// TTLç´¢å¼•(è‡ªåŠ¨åˆ é™¤90å¤©å‰çš„æ—¥å¿—)
db.audit_logs.createIndex({ "created_at": 1 }, { expireAfterSeconds: 7776000 })

// anomalies é›†åˆ
{
    "_id": ObjectId("..."),
    "type": "multi_location_login",
    "severity": "high",
    "user_id": "user_123",
    "description": "æ£€æµ‹åˆ°ç”¨æˆ·åœ¨3ä¸ªä¸åŒåœ°ç‚¹ç™»å½•",
    "evidence": ["log_1", "log_2", "log_3"],
    "status": "pending",
    "detected_at": ISODate("2025-10-17T10:00:00Z")
}

// ç´¢å¼•è®¾è®¡
db.anomalies.createIndex({ "user_id": 1, "detected_at": -1 })
db.anomalies.createIndex({ "type": 1, "severity": 1 })
db.anomalies.createIndex({ "status": 1 })
```

### 5.2 Elasticsearchç´¢å¼•(å¯é€‰,ç”¨äºå…¨æ–‡æœç´¢)

```json
{
  "mappings": {
    "properties": {
      "event_type": { "type": "keyword" },
      "level": { "type": "keyword" },
      "user_id": { "type": "keyword" },
      "username": { "type": "keyword" },
      "description": { "type": "text" },
      "ip_address": { "type": "ip" },
      "created_at": { "type": "date" }
    }
  }
}
```

## 6. æ€§èƒ½ä¼˜åŒ–

### 6.1 å¼‚æ­¥è®°å½•

- å®¡è®¡æ—¥å¿—é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å†™å…¥,ä¸é˜»å¡ä¸šåŠ¡æµç¨‹
- æ‰¹é‡å†™å…¥MongoDB,æé«˜å†™å…¥æ•ˆç‡

### 6.2 æ—¥å¿—åˆ†çº§å­˜å‚¨

- çƒ­æ•°æ®(æœ€è¿‘7å¤©):MongoDB
- æ¸©æ•°æ®(7-90å¤©):MongoDB(å‹ç¼©)
- å†·æ•°æ®(90å¤©ä»¥ä¸Š):å½’æ¡£åˆ°å¯¹è±¡å­˜å‚¨æˆ–åˆ é™¤

### 6.3 æŸ¥è¯¢ä¼˜åŒ–

- åˆç†çš„ç´¢å¼•è®¾è®¡
- ä½¿ç”¨Elasticsearchè¿›è¡Œå¤æ‚æŸ¥è¯¢å’Œå…¨æ–‡æœç´¢
- æŸ¥è¯¢ç»“æœç¼“å­˜(çŸ­æ—¶é—´ç¼“å­˜)

## 7. åˆè§„è¦æ±‚

### 7.1 æ•°æ®ä¿ç•™

- å…³é”®æ“ä½œæ—¥å¿—è‡³å°‘ä¿ç•™6ä¸ªæœˆ
- è´¢åŠ¡ç›¸å…³æ—¥å¿—è‡³å°‘ä¿ç•™3å¹´
- æ”¯æŒæ³•å¾‹è¦æ±‚çš„æ—¥å¿—è°ƒå–

### 7.2 æ•°æ®ä¿æŠ¤

- æ•æ„Ÿæ•°æ®è„±æ•å¤„ç†
- å®¡è®¡æ—¥å¿—åŠ å¯†å­˜å‚¨
- å®¡è®¡æ—¥å¿—è®¿é—®æ§åˆ¶(ä»…ç®¡ç†å‘˜å¯æŸ¥çœ‹)

### 7.3 å®¡è®¡å®Œæ•´æ€§

- å®¡è®¡æ—¥å¿—ä¸å¯ç¯¡æ”¹
- å®¡è®¡æ—¥å¿—å®Œæ•´æ€§æ ¡éªŒ(å“ˆå¸Œå€¼)
- å®šæœŸå¤‡ä»½å®¡è®¡æ—¥å¿—

## 8. MVPèŒƒå›´

### 8.1 MVPæ ¸å¿ƒåŠŸèƒ½ âŒ

**æ³¨æ„**: å®‰å…¨å®¡è®¡å±äºåç»­è¿­ä»£åŠŸèƒ½,MVPé˜¶æ®µæš‚ä¸å®æ–½

### 8.2 åç»­è¿­ä»£åŠŸèƒ½ â¸ï¸

- â¸ï¸ åŸºç¡€å®¡è®¡æ—¥å¿—è®°å½•
- â¸ï¸ å®¡è®¡æ—¥å¿—æŸ¥è¯¢å’Œå¯¼å‡º
- â¸ï¸ å¼‚å¸¸æ£€æµ‹è§„åˆ™å¼•æ“
- â¸ï¸ å®¡è®¡æŠ¥å‘Šç”Ÿæˆ
- â¸ï¸ å®æ—¶å‘Šè­¦

## 9. ç›¸å…³æ–‡æ¡£

- [ç®¡ç†åå°è®¾è®¡](./ç®¡ç†åå°è®¾è®¡.md)
- [ä¼šè¯ç®¡ç†è®¾è®¡](./ä¼šè¯ç®¡ç†è®¾è®¡.md)
- [å®‰å…¨è®¾è®¡ä¸å¨èƒå»ºæ¨¡](../security/å®‰å…¨è®¾è®¡ä¸å¨èƒå»ºæ¨¡.md)
- [æ—¥å¿—è§„èŒƒä¸ELK Stackè½åœ°](../ops/æ—¥å¿—è§„èŒƒä¸ELK Stackè½åœ°.md)

---

**æ–‡æ¡£ç»´æŠ¤**: é’ç¾½åç«¯æ¶æ„å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025-10-17

