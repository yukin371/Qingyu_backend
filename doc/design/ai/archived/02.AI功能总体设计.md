> ⚠️ **文档状态**: 已归档（2025-10-21）
> 
> 本文档基于v2.0架构设计，已被新的v2.1架构取代。
> 
> **替代文档**: v2.1架构中的AI模块章节
> 
> 详见：[青羽平台模块化架构设计v2.1](../../青羽平台模块化架构设计v2.1.md)

---

# AI功能设计

## 1. 需求概述

### 1.1 功能描述
青语小说创作平台的AI功能模块，为用户提供智能创作辅助服务，包括文本生成、内容分析、对话系统、上下文管理等核心功能。

### 1.2 业务价值
- **提升创作效率**：通过AI辅助减少创作时间，提高内容质量
- **降低创作门槛**：为新手作者提供智能指导和灵感支持
- **增强用户体验**：提供个性化、智能化的创作工具
- **商业价值**：通过AI服务增加平台竞争力和用户粘性

### 1.3 用户场景
- **内容生成**：用户输入提示词，AI生成相关文本内容
- **续写辅助**：基于已有内容，AI提供续写建议
- **内容优化**：AI分析并优化用户的文本内容
- **智能对话**：用户与AI进行创作相关的对话交流
- **上下文管理**：AI维护小说创作的上下文信息

### 1.4 功能边界
- **支持功能**：文本生成、分析、优化、对话、上下文管理
- **不支持功能**：图像生成、音频处理、视频制作
- **技术限制**：依赖第三方AI服务，受其API限制约束
- **使用限制**：需要用户认证，有使用频率和配额限制

## 2. 架构设计

### 2.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   客户端应用    │    │   Web前端       │    │   移动端应用    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   API网关       │
                    │  (Gin Router)   │
                    └─────────────────┘
                                 │
                    ┌─────────────────┐
                    │   中间件层      │
                    │ - 认证中间件    │
                    │ - 限流中间件    │
                    │ - 日志中间件    │
                    └─────────────────┘
                                 │
                    ┌─────────────────┐
                    │   AI API层      │
                    │ - 文本生成API   │
                    │ - 内容分析API   │
                    │ - 对话API       │
                    │ - 上下文API     │
                    └─────────────────┘
                                 │
                    ┌─────────────────┐
                    │   AI服务层      │
                    │ - AI服务管理    │
                    │ - 上下文服务    │
                    │ - 适配器管理    │
                    └─────────────────┘
                                 │
                    ┌─────────────────┐
                    │  Repository层   │
                    │ - AI配置仓储    │
                    │ - 对话仓储      │
                    │ - 上下文仓储    │
                    └─────────────────┘
                                 │
         ┌───────────────────────┼───────────────────────┐
         │                       │                       │
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   适配器层      │    │   缓存层        │    │   数据库层      │
│ - OpenAI适配器  │    │ - Redis缓存     │    │ - MongoDB       │
│ - Claude适配器  │    │ - 响应缓存      │    │ - 配置数据      │
│ - 百度适配器    │    │ - 配额缓存      │    │ - 日志数据      │
│ - Gemini适配器  │    │ - 上下文缓存    │    │ - 上下文数据    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │
┌─────────────────┐
│  外部AI服务     │
│ - OpenAI API    │
│ - Claude API    │
│ - 百度文心API   │
│ - 通义千问API   │
│ - Gemini API    │
└─────────────────┘
```

### 2.2 模块划分
- **Router层**：路由注册、中间件配置、请求分发
- **API层**：HTTP请求处理、参数验证、响应格式化
- **Service层**：业务逻辑处理、数据转换、外部服务调用
- **Repository层**：数据持久化、查询封装、事务管理
- **Model层**：数据模型定义、数据验证、业务实体

### 2.3 数据流向
1. 客户端发送HTTP请求到API网关
2. 中间件层进行认证、限流、日志记录
3. API层验证请求参数，调用Service层
4. Service层处理业务逻辑，通过Repository层访问数据
5. Repository层封装数据库操作，通过适配器调用外部AI服务
6. 适配器层统一处理不同AI服务商的接口差异
7. 响应数据经过缓存层优化后返回给客户端

### 2.4 技术选型
- **Web框架**：Gin Web Framework
- **数据库**：MongoDB（文档存储）
- **缓存**：Redis（响应缓存、会话缓存）
- **配置管理**：Viper
- **认证**：JWT Token
- **日志**：Logrus
- **AI服务**：OpenAI、Claude、百度文心一言、阿里通义千问、Google Gemini

## 3. 详细设计

### 3.1 Router层设计
- **路由分组**：/api/v1/ai
- **中间件**：认证中间件、限流中间件、CORS中间件、日志中间件
- **路径规范**：RESTful风格，使用复数名词
- **参数处理**：路径参数、查询参数、请求体参数

**路由配置**：
```go
// ai_router.go
func InitAIRouter(router *gin.RouterGroup) {
    aiGroup := router.Group("/ai")
    aiGroup.Use(middleware.JWTAuth(), middleware.RateLimit(), middleware.Logger())
    
    // 内容生成相关
    aiGroup.POST("/generate", aiApi.GenerateContent)
    aiGroup.POST("/continue", aiApi.ContinueWriting)
    aiGroup.POST("/optimize", aiApi.OptimizeText)
    aiGroup.POST("/analyze", aiApi.AnalyzeContent)
    aiGroup.POST("/outline", aiApi.GenerateOutline)
    
    // 对话相关
    aiGroup.POST("/chat/start", chatApi.StartChat)
    aiGroup.POST("/chat/continue", chatApi.ContinueChat)
    aiGroup.GET("/chat/sessions", chatApi.ListChatSessions)
    aiGroup.GET("/chat/history/:sessionId", chatApi.GetChatHistory)
    aiGroup.PUT("/chat/sessions/:sessionId", chatApi.UpdateChatSession)
    aiGroup.DELETE("/chat/sessions/:sessionId", chatApi.DeleteChatSession)
    
    // 上下文管理
    aiGroup.GET("/context/:projectId", contextApi.GetNovelContext)
    aiGroup.POST("/context/memory", contextApi.CreateNovelMemory)
    aiGroup.PUT("/context/memory/:memoryId", contextApi.UpdateNovelMemory)
    aiGroup.DELETE("/context/memory/:memoryId", contextApi.DeleteNovelMemory)
}
```

### 3.2 API层设计
- **接口定义**：HTTP方法、路径、参数
- **请求验证**：参数校验规则、数据格式验证
- **响应格式**：统一的JSON响应结构
- **错误处理**：错误码、错误信息、异常捕获

**统一响应格式**：
```go
type APIResponse struct {
    Code      int         `json:"code"`
    Message   string      `json:"message"`
    Data      interface{} `json:"data,omitempty"`
    Timestamp int64       `json:"timestamp"`
}
```

**主要API接口**：
1. **文本生成接口**：POST /api/v1/ai/generate
2. **内容续写接口**：POST /api/v1/ai/continue
3. **文本优化接口**：POST /api/v1/ai/optimize
4. **内容分析接口**：POST /api/v1/ai/analyze
5. **大纲生成接口**：POST /api/v1/ai/outline
6. **开始对话接口**：POST /api/v1/ai/chat/start
7. **继续对话接口**：POST /api/v1/ai/chat/continue
8. **获取上下文接口**：GET /api/v1/ai/context/:projectId

### 3.3 Service层设计
- **业务流程**：核心业务逻辑步骤
- **数据处理**：输入输出数据转换
- **依赖服务**：Repository层、外部AI API、缓存服务
- **异常处理**：业务异常、系统异常、网络异常

**核心服务组件**：
```go
type AIService struct {
    contextRepository  ContextRepository
    chatRepository     ChatRepository
    configRepository   ConfigRepository
    externalAPIService *ExternalAPIService
    adapterManager     *AdapterManager
    cacheService       *CacheService
}
```

**主要业务流程**：
1. **内容生成流程**：参数验证 → 上下文构建 → AI调用 → 结果处理 → 缓存存储
2. **对话流程**：会话管理 → 历史加载 → AI对话 → 消息存储 → 会话更新
3. **上下文管理流程**：上下文检索 → 相关性分析 → 动态构建 → 缓存优化

### 3.4 Repository层设计
- **接口抽象**：定义数据访问接口，实现数据库无关性
- **实现分离**：具体数据库实现与业务逻辑分离
- **事务管理**：统一的事务处理和回滚机制
- **查询优化**：复杂查询的封装和优化

**核心Repository接口**：
```go
type AIConfigRepository interface {
    GetProvider(ctx context.Context, name string) (*AIProvider, error)
    ListProviders(ctx context.Context) ([]*AIProvider, error)
    CreateProvider(ctx context.Context, provider *AIProvider) error
    UpdateProvider(ctx context.Context, provider *AIProvider) error
    DeleteProvider(ctx context.Context, id string) error
}

type ChatRepository interface {
    CreateSession(ctx context.Context, session *ChatSession) error
    GetSession(ctx context.Context, id string) (*ChatSession, error)
    ListSessions(ctx context.Context, userID string) ([]*ChatSession, error)
    CreateMessage(ctx context.Context, message *ChatMessage) error
    GetMessages(ctx context.Context, sessionID string) ([]*ChatMessage, error)
}

type ContextRepository interface {
    SaveContext(ctx context.Context, context *AIContext) error
    GetContext(ctx context.Context, projectID string) (*AIContext, error)
    UpdateContext(ctx context.Context, context *AIContext) error
    DeleteContext(ctx context.Context, projectID string) error
}
```

### 3.5 Model层设计
- **数据模型**：结构体定义、字段类型
- **数据库映射**：集合名称、字段映射
- **约束规则**：必填、唯一、长度限制
- **索引设计**：查询优化、性能考虑

**核心数据模型**：
```go
// AI服务提供商配置
type AIProvider struct {
    ID        primitive.ObjectID `bson:"_id,omitempty" json:"id"`
    Name      string             `bson:"name" json:"name"`
    APIKey    string             `bson:"api_key" json:"-"`
    BaseURL   string             `bson:"base_url" json:"base_url"`
    Enabled   bool               `bson:"enabled" json:"enabled"`
    CreatedAt time.Time          `bson:"created_at" json:"created_at"`
    UpdatedAt time.Time          `bson:"updated_at" json:"updated_at"`
}

// AI模型配置
type AIModel struct {
    ID          primitive.ObjectID `bson:"_id,omitempty" json:"id"`
    Provider    string             `bson:"provider" json:"provider"`
    Name        string             `bson:"name" json:"name"`
    Type        string             `bson:"type" json:"type"`
    MaxTokens   int                `bson:"max_tokens" json:"max_tokens"`
    Enabled     bool               `bson:"enabled" json:"enabled"`
    Description string             `bson:"description" json:"description"`
    CreatedAt   time.Time          `bson:"created_at" json:"created_at"`
    UpdatedAt   time.Time          `bson:"updated_at" json:"updated_at"`
}

// 对话会话
type ChatSession struct {
    ID          primitive.ObjectID `bson:"_id,omitempty" json:"id"`
    UserID      primitive.ObjectID `bson:"user_id" json:"user_id"`
    Title       string             `bson:"title" json:"title"`
    ProjectID   primitive.ObjectID `bson:"project_id,omitempty" json:"project_id,omitempty"`
    Status      string             `bson:"status" json:"status"`
    CreatedAt   time.Time          `bson:"created_at" json:"created_at"`
    UpdatedAt   time.Time          `bson:"updated_at" json:"updated_at"`
}

// 对话消息
type ChatMessage struct {
    ID        primitive.ObjectID `bson:"_id,omitempty" json:"id"`
    SessionID primitive.ObjectID `bson:"session_id" json:"session_id"`
    Role      string             `bson:"role" json:"role"`
    Content   string             `bson:"content" json:"content"`
    Timestamp time.Time          `bson:"timestamp" json:"timestamp"`
}
```

## 4. 数据设计

### 4.1 数据模型
详见上述Model层设计中的核心数据模型定义。

### 4.2 数据关系
- **用户 ↔ 对话会话**：一对多关系
- **对话会话 ↔ 对话消息**：一对多关系
- **项目 ↔ 对话会话**：一对多关系（可选）
- **AI提供商 ↔ AI模型**：一对多关系

### 4.3 索引策略
```javascript
// ai_providers集合
db.ai_providers.createIndex({"name": 1}, {"unique": true})
db.ai_providers.createIndex({"enabled": 1})

// ai_models集合
db.ai_models.createIndex({"provider": 1, "name": 1}, {"unique": true})
db.ai_models.createIndex({"enabled": 1})
db.ai_models.createIndex({"type": 1})

// chat_sessions集合
db.chat_sessions.createIndex({"user_id": 1, "created_at": -1})
db.chat_sessions.createIndex({"project_id": 1})
db.chat_sessions.createIndex({"status": 1})

// chat_messages集合
db.chat_messages.createIndex({"session_id": 1, "timestamp": 1})
db.chat_messages.createIndex({"role": 1})
```

### 4.4 数据迁移
- **版本升级**：使用MongoDB的迁移脚本
- **数据转换**：保持向后兼容性
- **回滚策略**：备份原始数据，支持快速回滚

## 5. 接口设计

### 5.1 API规范
遵循项目API设计规范，使用RESTful风格，统一JSON响应格式。

### 5.2 请求示例

#### 文本生成接口
```http
POST /api/v1/ai/generate
Authorization: Bearer <token>
Content-Type: application/json

{
  "prompt": "请写一段关于春天的描述",
  "max_tokens": 500,
  "temperature": 0.7,
  "model": "gpt-4"
}
```

#### 响应示例
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": "gen_123456789",
    "content": "春天来了，万物复苏...",
    "usage": {
      "prompt_tokens": 15,
      "completion_tokens": 120,
      "total_tokens": 135
    }
  },
  "timestamp": 1703123456789
}
```

### 5.3 错误处理
```json
{
  "code": 4001,
  "message": "参数验证失败",
  "data": {
    "errors": [
      {
        "field": "prompt",
        "message": "提示词不能为空"
      }
    ]
  },
  "timestamp": 1703123456789
}
```

### 5.4 性能要求
- **响应时间**：普通请求 < 2s，流式响应首字节 < 500ms
- **并发处理**：支持1000+并发请求
- **可用性**：99.9%服务可用性
- **限流**：用户级别100次/分钟，IP级别500次/分钟

## 6. 安全设计

### 6.1 权限控制
- **访问权限**：基于JWT Token的用户认证
- **操作权限**：基于用户角色的功能权限控制
- **资源权限**：用户只能访问自己的对话会话和上下文

### 6.2 数据安全
- **敏感数据处理**：API密钥加密存储，不在日志中记录
- **数据传输**：HTTPS加密传输
- **数据存储**：敏感字段加密存储

### 6.3 输入验证
- **参数校验**：严格的参数类型和格式验证
- **内容过滤**：敏感内容检测和过滤
- **SQL注入防护**：使用参数化查询

### 6.4 审计日志
- **操作记录**：记录所有API调用和关键操作
- **访问日志**：记录用户访问行为
- **错误日志**：记录系统错误和异常

## 7. 测试设计

### 7.1 测试策略
- **单元测试**：覆盖率 > 80%，使用Go testing包和testify
- **集成测试**：API接口测试、数据库集成测试
- **端到端测试**：完整业务流程测试

### 7.2 测试用例
- **正常流程**：标准的AI生成、对话、上下文管理流程
- **边界条件**：空参数、超长文本、特殊字符
- **异常情况**：网络错误、AI服务不可用、认证失败
- **性能测试**：并发请求、大数据量处理

### 7.3 性能测试
- **负载测试**：模拟正常用户负载
- **压力测试**：测试系统极限承载能力
- **稳定性测试**：长时间运行稳定性

### 7.4 安全测试
- **认证测试**：JWT Token验证
- **授权测试**：权限控制验证
- **输入验证测试**：恶意输入防护

## 8. 部署和运维

### 8.1 部署方案
- **容器化部署**：使用Docker容器
- **编排工具**：Kubernetes或Docker Compose
- **环境隔离**：开发、测试、生产环境分离
- **配置管理**：环境变量和配置文件管理

### 8.2 监控指标
- **业务指标**：API调用量、成功率、响应时间
- **系统指标**：CPU、内存、磁盘、网络使用率
- **错误指标**：错误率、异常统计
- **用户指标**：活跃用户数、使用频率

### 8.3 日志策略
- **日志级别**：DEBUG、INFO、WARN、ERROR
- **日志格式**：结构化JSON格式
- **日志轮转**：按大小和时间轮转
- **日志聚合**：集中式日志管理

### 8.4 故障处理
- **监控告警**：关键指标异常告警
- **故障转移**：AI服务故障自动切换
- **降级策略**：服务不可用时的降级方案
- **恢复流程**：故障恢复的标准流程

## 9. 风险评估

### 9.1 技术风险
- **AI服务依赖**：外部AI服务不稳定或不可用
- **性能瓶颈**：高并发下的性能问题
- **数据一致性**：分布式环境下的数据一致性

**应对措施**：
- 多AI服务商支持，实现故障转移
- 缓存优化和负载均衡
- 事务管理和数据校验

### 9.2 业务风险
- **内容质量**：AI生成内容质量不稳定
- **用户体验**：响应时间过长影响用户体验
- **成本控制**：AI服务调用成本过高

**应对措施**：
- 内容质量评估和优化
- 性能优化和缓存策略
- 使用配额和限流控制成本

### 9.3 安全风险
- **数据泄露**：用户数据和API密钥泄露
- **恶意攻击**：DDoS攻击、恶意请求
- **权限绕过**：认证和授权机制被绕过

**应对措施**：
- 数据加密和访问控制
- 限流和防护机制
- 安全审计和漏洞扫描

## 10. 实施计划

### 10.1 开发阶段
- **第一阶段**（2周）：基础架构搭建、核心API开发
- **第二阶段**（2周）：AI适配器开发、对话功能实现
- **第三阶段**（1周）：上下文管理、性能优化
- **第四阶段**（1周）：测试、文档完善

### 10.2 测试阶段
- **单元测试**（1周）：各模块单元测试
- **集成测试**（1周）：系统集成测试
- **性能测试**（3天）：负载和压力测试
- **安全测试**（2天）：安全漏洞测试

### 10.3 上线计划
- **灰度发布**：小范围用户测试
- **监控部署**：监控和告警系统部署
- **正式发布**：全量用户发布
- **运维支持**：7x24小时运维支持

### 10.4 后续优化
- **功能完善**：根据用户反馈完善功能
- **性能优化**：持续的性能监控和优化
- **新功能开发**：图像生成、语音合成等新功能
- **AI模型升级**：跟进最新的AI模型和技术