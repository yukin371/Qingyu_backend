# Go API 扩展设计

> **文档版本**: v1.0
> **创建时间**: 2025-10-27
> **实施状态**: 设计阶段
> **负责人**: AI架构组

---

## 📋 文档概述

本文档设计 Go 后端新增的 AI 相关 API 接口和设定百科 API。

---

## 一、AI 相关 API

### 1.1 AI Proxy API

```go
// api/v1/ai/ai_api.go
package ai

import (
    "github.com/gin-gonic/gin"
    "qingyu_backend/service"
)

type AIApi struct {
    aiProxyService service.AIProxyService
}

// GenerateText 生成文本
// @Summary 生成文本
// @Tags AI
// @Accept json
// @Produce json
// @Param request body GenerateRequest true "生成请求"
// @Success 200 {object} response.Response
// @Router /api/v1/ai/generate [post]
func (a *AIApi) GenerateText(c *gin.Context) {
    var req GenerateRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.ValidationError(c, err)
        return
    }
    
    userID := c.GetString("user_id")
    
    result, err := a.aiProxyService.GenerateText(c.Request.Context(), &req, userID)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, result)
}

// GenerateTextStream 流式生成文本
// @Summary 流式生成文本（SSE）
// @Tags AI
// @Accept json
// @Produce text/event-stream
// @Router /api/v1/ai/generate/stream [post]
func (a *AIApi) GenerateTextStream(c *gin.Context) {
    var req GenerateRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.ValidationError(c, err)
        return
    }
    
    userID := c.GetString("user_id")
    
    // 设置 SSE 响应头
    c.Header("Content-Type", "text/event-stream")
    c.Header("Cache-Control", "no-cache")
    c.Header("Connection", "keep-alive")
    
    // 流式响应
    streamChan, err := a.aiProxyService.GenerateTextStream(c.Request.Context(), &req, userID)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    c.Stream(func(w io.Writer) bool {
        if chunk, ok := <-streamChan; ok {
            c.SSEvent("message", chunk.Content)
            return true
        }
        return false
    })
}

// ExecuteAgent 执行 Agent
// @Summary 执行 AI Agent
// @Tags AI
// @Accept json
// @Produce json
// @Param request body AgentExecuteRequest true "Agent 执行请求"
// @Success 200 {object} response.Response
// @Router /api/v1/ai/agent/execute [post]
func (a *AIApi) ExecuteAgent(c *gin.Context) {
    var req AgentExecuteRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.ValidationError(c, err)
        return
    }
    
    userID := c.GetString("user_id")
    req.UserID = userID
    
    result, err := a.aiProxyService.ExecuteAgent(c.Request.Context(), &req)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, result)
}

// RAGSearch RAG 检索
// @Summary RAG 知识库检索
// @Tags AI
// @Accept json
// @Produce json
// @Param query query string true "查询文本"
// @Param project_id query string true "项目 ID"
// @Param top_k query int false "返回结果数" default(5)
// @Success 200 {object} response.Response
// @Router /api/v1/ai/rag/search [get]
func (a *AIApi) RAGSearch(c *gin.Context) {
    query := c.Query("query")
    projectID := c.Query("project_id")
    topK := c.DefaultQuery("top_k", "5")
    
    userID := c.GetString("user_id")
    
    req := &RAGSearchRequest{
        Query:     query,
        UserID:    userID,
        ProjectID: projectID,
        TopK:      parseInt(topK),
    }
    
    result, err := a.aiProxyService.RAGSearch(c.Request.Context(), req)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, result)
}

// ExecutePipeline 执行 A2A 创作流水线
// @Summary 执行创作流水线
// @Tags AI
// @Accept json
// @Produce json
// @Param request body PipelineRequest true "流水线请求"
// @Success 200 {object} response.Response
// @Router /api/v1/ai/pipeline/execute [post]
func (a *AIApi) ExecutePipeline(c *gin.Context) {
    var req PipelineRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.ValidationError(c, err)
        return
    }
    
    userID := c.GetString("user_id")
    req.UserID = userID
    
    result, err := a.aiProxyService.ExecutePipeline(c.Request.Context(), &req)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, result)
}
```

### 1.2 AI 请求/响应模型

```go
// models/ai/requests.go
package ai

type GenerateRequest struct {
    Prompt      string            `json:"prompt" validate:"required"`
    Model       string            `json:"model"`
    Temperature float32           `json:"temperature"`
    MaxTokens   int               `json:"maxTokens"`
    ProjectID   string            `json:"projectId"`
    Context     map[string]string `json:"context"`
}

type AgentExecuteRequest struct {
    AgentType  string            `json:"agentType" validate:"required"` // creative, outline, character
    Task       string            `json:"task" validate:"required"`
    ProjectID  string            `json:"projectId" validate:"required"`
    UserID     string            `json:"-"` // 从 context 获取
    Parameters map[string]string `json:"parameters"`
}

type RAGSearchRequest struct {
    Query        string   `json:"query" validate:"required"`
    UserID       string   `json:"-"`
    ProjectID    string   `json:"projectId" validate:"required"`
    ContentTypes []string `json:"contentTypes"`
    TopK         int      `json:"topK"`
    EnableRerank bool     `json:"enableRerank"`
}

type PipelineRequest struct {
    UserRequirement string            `json:"userRequirement" validate:"required"`
    ProjectID       string            `json:"projectId" validate:"required"`
    UserID          string            `json:"-"`
    Config          map[string]string `json:"config"`
}
```

---

## 二、设定百科 API

### 2.1 Character API

```go
// api/v1/writer/character_api.go
package writer

import (
    "github.com/gin-gonic/gin"
    "qingyu_backend/service/writer"
)

type CharacterApi struct {
    characterService writer.CharacterService
}

// CreateCharacter 创建角色
// @Summary 创建角色卡
// @Tags Character
// @Accept json
// @Produce json
// @Param request body CreateCharacterRequest true "角色数据"
// @Success 200 {object} response.Response{data=models.Character}
// @Router /api/v1/projects/{projectId}/characters [post]
func (a *CharacterApi) CreateCharacter(c *gin.Context) {
    projectID := c.Param("projectId")
    
    var req CreateCharacterRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.ValidationError(c, err)
        return
    }
    
    userID := c.GetString("user_id")
    
    character, err := a.characterService.Create(c.Request.Context(), projectID, userID, &req)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, character)
}

// ListCharacters 列出角色
// @Summary 列出项目的所有角色
// @Tags Character
// @Produce json
// @Param projectId path string true "项目 ID"
// @Success 200 {object} response.Response{data=[]models.Character}
// @Router /api/v1/projects/{projectId}/characters [get]
func (a *CharacterApi) ListCharacters(c *gin.Context) {
    projectID := c.Param("projectId")
    
    characters, err := a.characterService.List(c.Request.Context(), projectID)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, characters)
}

// GetCharacter 获取角色详情
// @Router /api/v1/projects/{projectId}/characters/{characterId} [get]
func (a *CharacterApi) GetCharacter(c *gin.Context) {
    projectID := c.Param("projectId")
    characterID := c.Param("characterId")
    
    character, err := a.characterService.GetByID(c.Request.Context(), characterID, projectID)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, character)
}

// UpdateCharacter 更新角色
// @Router /api/v1/projects/{projectId}/characters/{characterId} [put]
func (a *CharacterApi) UpdateCharacter(c *gin.Context) {
    projectID := c.Param("projectId")
    characterID := c.Param("characterId")
    
    var req UpdateCharacterRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.ValidationError(c, err)
        return
    }
    
    character, err := a.characterService.Update(c.Request.Context(), characterID, projectID, &req)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, character)
}

// DeleteCharacter 删除角色
// @Router /api/v1/projects/{projectId}/characters/{characterId} [delete]
func (a *CharacterApi) DeleteCharacter(c *gin.Context) {
    projectID := c.Param("projectId")
    characterID := c.Param("characterId")
    
    err := a.characterService.Delete(c.Request.Context(), characterID, projectID)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, gin.H{"deleted": true})
}
```

### 2.2 Timeline API

```go
// api/v1/writer/timeline_api.go
package writer

type TimelineApi struct {
    timelineService writer.TimelineService
}

// CreateTimeline 创建时间线
// @Router /api/v1/projects/{projectId}/timelines [post]
func (a *TimelineApi) CreateTimeline(c *gin.Context) {
    // 实现类似 Character API
}

// CreateTimelineEvent 创建时间线事件
// @Router /api/v1/projects/{projectId}/timeline-events [post]
func (a *TimelineApi) CreateTimelineEvent(c *gin.Context) {
    // ...
}

// ListTimelineEvents 列出时间线事件
// @Router /api/v1/projects/{projectId}/timeline-events [get]
func (a *TimelineApi) ListTimelineEvents(c *gin.Context) {
    // ...
}
```

### 2.3 Outline API（基于 Node）

```go
// api/v1/writer/outline_api.go
package writer

type OutlineApi struct {
    nodeService writer.NodeService
}

// CreateOutlineNode 创建大纲节点
// @Router /api/v1/projects/{projectId}/nodes [post]
func (a *OutlineApi) CreateOutlineNode(c *gin.Context) {
    projectID := c.Param("projectId")
    
    var req CreateNodeRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.ValidationError(c, err)
        return
    }
    
    req.Type = "outline"
    req.ProjectID = projectID
    
    node, err := a.nodeService.Create(c.Request.Context(), &req)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, node)
}

// ListOutlineNodes 列出大纲节点
// @Router /api/v1/projects/{projectId}/nodes [get]
func (a *OutlineApi) ListOutlineNodes(c *gin.Context) {
    projectID := c.Param("projectId")
    parentID := c.Query("parentId")
    
    nodes, err := a.nodeService.ListByParent(c.Request.Context(), projectID, parentID, "outline")
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, nodes)
}

// MoveNode 移动节点
// @Router /api/v1/projects/{projectId}/nodes/{nodeId}/move [post]
func (a *OutlineApi) MoveNode(c *gin.Context) {
    nodeID := c.Param("nodeId")
    
    var req MoveNodeRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.ValidationError(c, err)
        return
    }
    
    err := a.nodeService.Move(c.Request.Context(), nodeID, req.ParentID, req.Order)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, gin.H{"moved": true})
}
```

### 2.4 WorldSetting API

```go
// api/v1/writer/world_setting_api.go
package writer

type WorldSettingApi struct {
    worldSettingService writer.WorldSettingService
}

// CreateWorldSetting 创建世界观设定
// @Router /api/v1/projects/{projectId}/world-settings [post]
func (a *WorldSettingApi) CreateWorldSetting(c *gin.Context) {
    projectID := c.Param("projectId")
    
    var req CreateWorldSettingRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.ValidationError(c, err)
        return
    }
    
    setting, err := a.worldSettingService.Create(c.Request.Context(), projectID, &req)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, setting)
}

// ListWorldSettings 列出世界观设定
// @Router /api/v1/projects/{projectId}/world-settings [get]
func (a *WorldSettingApi) ListWorldSettings(c *gin.Context) {
    projectID := c.Param("projectId")
    category := c.Query("category")
    
    settings, err := a.worldSettingService.List(c.Request.Context(), projectID, category)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, settings)
}
```

---

## 三、路由注册

### 3.1 AI 路由

```go
// router/ai/ai_router.go
package ai

import (
    "github.com/gin-gonic/gin"
    "qingyu_backend/api/v1/ai"
    "qingyu_backend/middleware"
)

func InitAIRoutes(group *gin.RouterGroup, aiApi *ai.AIApi) {
    aiGroup := group.Group("/ai")
    aiGroup.Use(middleware.JWTAuth()) // 需要认证
    
    {
        // 生成
        aiGroup.POST("/generate", aiApi.GenerateText)
        aiGroup.POST("/generate/stream", aiApi.GenerateTextStream)
        
        // Agent
        aiGroup.POST("/agent/execute", aiApi.ExecuteAgent)
        aiGroup.POST("/agent/execute/stream", aiApi.ExecuteAgentStream)
        
        // RAG
        aiGroup.GET("/rag/search", aiApi.RAGSearch)
        
        // Pipeline
        aiGroup.POST("/pipeline/execute", aiApi.ExecutePipeline)
        aiGroup.POST("/pipeline/execute/stream", aiApi.ExecutePipelineStream)
    }
}
```

### 3.2 Writer 路由

```go
// router/writer/writer_router.go
package writer

import (
    "github.com/gin-gonic/gin"
    "qingyu_backend/api/v1/writer"
    "qingyu_backend/middleware"
)

func InitWriterRoutes(group *gin.RouterGroup, apis *writer.WriterApis) {
    projectGroup := group.Group("/projects/:projectId")
    projectGroup.Use(middleware.JWTAuth())
    
    {
        // 角色
        projectGroup.POST("/characters", apis.CharacterApi.CreateCharacter)
        projectGroup.GET("/characters", apis.CharacterApi.ListCharacters)
        projectGroup.GET("/characters/:characterId", apis.CharacterApi.GetCharacter)
        projectGroup.PUT("/characters/:characterId", apis.CharacterApi.UpdateCharacter)
        projectGroup.DELETE("/characters/:characterId", apis.CharacterApi.DeleteCharacter)
        
        // 角色关系
        projectGroup.POST("/character-relations", apis.RelationApi.CreateRelation)
        projectGroup.GET("/character-relations", apis.RelationApi.ListRelations)
        
        // 时间线
        projectGroup.POST("/timelines", apis.TimelineApi.CreateTimeline)
        projectGroup.GET("/timelines", apis.TimelineApi.ListTimelines)
        projectGroup.POST("/timeline-events", apis.TimelineApi.CreateTimelineEvent)
        projectGroup.GET("/timeline-events", apis.TimelineApi.ListTimelineEvents)
        
        // 大纲（Node）
        projectGroup.POST("/nodes", apis.OutlineApi.CreateOutlineNode)
        projectGroup.GET("/nodes", apis.OutlineApi.ListOutlineNodes)
        projectGroup.GET("/nodes/:nodeId", apis.OutlineApi.GetOutlineNode)
        projectGroup.PUT("/nodes/:nodeId", apis.OutlineApi.UpdateOutlineNode)
        projectGroup.DELETE("/nodes/:nodeId", apis.OutlineApi.DeleteOutlineNode)
        projectGroup.POST("/nodes/:nodeId/move", apis.OutlineApi.MoveNode)
        
        // 世界观设定
        projectGroup.POST("/world-settings", apis.WorldSettingApi.CreateWorldSetting)
        projectGroup.GET("/world-settings", apis.WorldSettingApi.ListWorldSettings)
    }
}
```

---

## 四、总结

本文档设计了 Go API 扩展：

**AI API**：
- ✅ 生成 API（文本生成、流式生成）
- ✅ Agent API（Agent 执行、流式执行）
- ✅ RAG API（知识库检索）
- ✅ Pipeline API（A2A 流水线）

**设定百科 API**：
- ✅ Character API（角色 CRUD）
- ✅ Timeline API（时间线 CRUD）
- ✅ Outline API（大纲 CRUD、节点移动）
- ✅ WorldSetting API（世界观设定 CRUD）

**路由注册**：
- ✅ AI 路由组
- ✅ Writer 路由组

---

**文档版本**: v1.0
**创建时间**: 2025-10-27
**维护者**: AI架构组
