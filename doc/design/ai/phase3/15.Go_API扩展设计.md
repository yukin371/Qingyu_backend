# Go API æ‰©å±•è®¾è®¡

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **åˆ›å»ºæ—¶é—´**: 2025-10-27
> **å®æ–½çŠ¶æ€**: è®¾è®¡é˜¶æ®µ
> **è´Ÿè´£äºº**: AIæ¶æ„ç»„

---

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è®¾è®¡ Go åç«¯æ–°å¢çš„ AI ç›¸å…³ API æ¥å£å’Œè®¾å®šç™¾ç§‘ APIã€‚

---

## ä¸€ã€AI ç›¸å…³ API

### 1.1 AI Proxy API

```go
// api/v1/ai/ai_api.go
package ai

import (
    "github.com/gin-gonic/gin"
    "qingyu_backend/service"
)

type AIApi struct {
    aiProxyService service.AIProxyService
}

// GenerateText ç”Ÿæˆæ–‡æœ¬
// @Summary ç”Ÿæˆæ–‡æœ¬
// @Tags AI
// @Accept json
// @Produce json
// @Param request body GenerateRequest true "ç”Ÿæˆè¯·æ±‚"
// @Success 200 {object} response.Response
// @Router /api/v1/ai/generate [post]
func (a *AIApi) GenerateText(c *gin.Context) {
    var req GenerateRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.ValidationError(c, err)
        return
    }
    
    userID := c.GetString("user_id")
    
    result, err := a.aiProxyService.GenerateText(c.Request.Context(), &req, userID)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, result)
}

// GenerateTextStream æµå¼ç”Ÿæˆæ–‡æœ¬
// @Summary æµå¼ç”Ÿæˆæ–‡æœ¬ï¼ˆSSEï¼‰
// @Tags AI
// @Accept json
// @Produce text/event-stream
// @Router /api/v1/ai/generate/stream [post]
func (a *AIApi) GenerateTextStream(c *gin.Context) {
    var req GenerateRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.ValidationError(c, err)
        return
    }
    
    userID := c.GetString("user_id")
    
    // è®¾ç½® SSE å“åº”å¤´
    c.Header("Content-Type", "text/event-stream")
    c.Header("Cache-Control", "no-cache")
    c.Header("Connection", "keep-alive")
    
    // æµå¼å“åº”
    streamChan, err := a.aiProxyService.GenerateTextStream(c.Request.Context(), &req, userID)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    c.Stream(func(w io.Writer) bool {
        if chunk, ok := <-streamChan; ok {
            c.SSEvent("message", chunk.Content)
            return true
        }
        return false
    })
}

// ExecuteAgent æ‰§è¡Œ Agent
// @Summary æ‰§è¡Œ AI Agent
// @Tags AI
// @Accept json
// @Produce json
// @Param request body AgentExecuteRequest true "Agent æ‰§è¡Œè¯·æ±‚"
// @Success 200 {object} response.Response
// @Router /api/v1/ai/agent/execute [post]
func (a *AIApi) ExecuteAgent(c *gin.Context) {
    var req AgentExecuteRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.ValidationError(c, err)
        return
    }
    
    userID := c.GetString("user_id")
    req.UserID = userID
    
    result, err := a.aiProxyService.ExecuteAgent(c.Request.Context(), &req)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, result)
}

// RAGSearch RAG æ£€ç´¢
// @Summary RAG çŸ¥è¯†åº“æ£€ç´¢
// @Tags AI
// @Accept json
// @Produce json
// @Param query query string true "æŸ¥è¯¢æ–‡æœ¬"
// @Param project_id query string true "é¡¹ç›® ID"
// @Param top_k query int false "è¿”å›ç»“æœæ•°" default(5)
// @Success 200 {object} response.Response
// @Router /api/v1/ai/rag/search [get]
func (a *AIApi) RAGSearch(c *gin.Context) {
    query := c.Query("query")
    projectID := c.Query("project_id")
    topK := c.DefaultQuery("top_k", "5")
    
    userID := c.GetString("user_id")
    
    req := &RAGSearchRequest{
        Query:     query,
        UserID:    userID,
        ProjectID: projectID,
        TopK:      parseInt(topK),
    }
    
    result, err := a.aiProxyService.RAGSearch(c.Request.Context(), req)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, result)
}

// ExecutePipeline æ‰§è¡Œ A2A åˆ›ä½œæµæ°´çº¿
// @Summary æ‰§è¡Œåˆ›ä½œæµæ°´çº¿
// @Tags AI
// @Accept json
// @Produce json
// @Param request body PipelineRequest true "æµæ°´çº¿è¯·æ±‚"
// @Success 200 {object} response.Response
// @Router /api/v1/ai/pipeline/execute [post]
func (a *AIApi) ExecutePipeline(c *gin.Context) {
    var req PipelineRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.ValidationError(c, err)
        return
    }
    
    userID := c.GetString("user_id")
    req.UserID = userID
    
    result, err := a.aiProxyService.ExecutePipeline(c.Request.Context(), &req)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, result)
}
```

### 1.2 AI è¯·æ±‚/å“åº”æ¨¡å‹

```go
// models/ai/requests.go
package ai

type GenerateRequest struct {
    Prompt      string            `json:"prompt" validate:"required"`
    Model       string            `json:"model"`
    Temperature float32           `json:"temperature"`
    MaxTokens   int               `json:"maxTokens"`
    ProjectID   string            `json:"projectId"`
    Context     map[string]string `json:"context"`
}

type AgentExecuteRequest struct {
    AgentType  string            `json:"agentType" validate:"required"` // creative, outline, character
    Task       string            `json:"task" validate:"required"`
    ProjectID  string            `json:"projectId" validate:"required"`
    UserID     string            `json:"-"` // ä» context è·å–
    Parameters map[string]string `json:"parameters"`
}

type RAGSearchRequest struct {
    Query        string   `json:"query" validate:"required"`
    UserID       string   `json:"-"`
    ProjectID    string   `json:"projectId" validate:"required"`
    ContentTypes []string `json:"contentTypes"`
    TopK         int      `json:"topK"`
    EnableRerank bool     `json:"enableRerank"`
}

type PipelineRequest struct {
    UserRequirement string            `json:"userRequirement" validate:"required"`
    ProjectID       string            `json:"projectId" validate:"required"`
    UserID          string            `json:"-"`
    Config          map[string]string `json:"config"`
}
```

---

## äºŒã€è®¾å®šç™¾ç§‘ API

### 2.1 Character API

```go
// api/v1/writer/character_api.go
package writer

import (
    "github.com/gin-gonic/gin"
    "qingyu_backend/service/writer"
)

type CharacterApi struct {
    characterService writer.CharacterService
}

// CreateCharacter åˆ›å»ºè§’è‰²
// @Summary åˆ›å»ºè§’è‰²å¡
// @Tags Character
// @Accept json
// @Produce json
// @Param request body CreateCharacterRequest true "è§’è‰²æ•°æ®"
// @Success 200 {object} response.Response{data=models.Character}
// @Router /api/v1/projects/{projectId}/characters [post]
func (a *CharacterApi) CreateCharacter(c *gin.Context) {
    projectID := c.Param("projectId")
    
    var req CreateCharacterRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.ValidationError(c, err)
        return
    }
    
    userID := c.GetString("user_id")
    
    character, err := a.characterService.Create(c.Request.Context(), projectID, userID, &req)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, character)
}

// ListCharacters åˆ—å‡ºè§’è‰²
// @Summary åˆ—å‡ºé¡¹ç›®çš„æ‰€æœ‰è§’è‰²
// @Tags Character
// @Produce json
// @Param projectId path string true "é¡¹ç›® ID"
// @Success 200 {object} response.Response{data=[]models.Character}
// @Router /api/v1/projects/{projectId}/characters [get]
func (a *CharacterApi) ListCharacters(c *gin.Context) {
    projectID := c.Param("projectId")
    
    characters, err := a.characterService.List(c.Request.Context(), projectID)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, characters)
}

// GetCharacter è·å–è§’è‰²è¯¦æƒ…
// @Router /api/v1/projects/{projectId}/characters/{characterId} [get]
func (a *CharacterApi) GetCharacter(c *gin.Context) {
    projectID := c.Param("projectId")
    characterID := c.Param("characterId")
    
    character, err := a.characterService.GetByID(c.Request.Context(), characterID, projectID)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, character)
}

// UpdateCharacter æ›´æ–°è§’è‰²
// @Router /api/v1/projects/{projectId}/characters/{characterId} [put]
func (a *CharacterApi) UpdateCharacter(c *gin.Context) {
    projectID := c.Param("projectId")
    characterID := c.Param("characterId")
    
    var req UpdateCharacterRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.ValidationError(c, err)
        return
    }
    
    character, err := a.characterService.Update(c.Request.Context(), characterID, projectID, &req)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, character)
}

// DeleteCharacter åˆ é™¤è§’è‰²
// @Router /api/v1/projects/{projectId}/characters/{characterId} [delete]
func (a *CharacterApi) DeleteCharacter(c *gin.Context) {
    projectID := c.Param("projectId")
    characterID := c.Param("characterId")
    
    err := a.characterService.Delete(c.Request.Context(), characterID, projectID)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, gin.H{"deleted": true})
}
```

### 2.2 Timeline API

```go
// api/v1/writer/timeline_api.go
package writer

type TimelineApi struct {
    timelineService writer.TimelineService
}

// CreateTimeline åˆ›å»ºæ—¶é—´çº¿
// @Router /api/v1/projects/{projectId}/timelines [post]
func (a *TimelineApi) CreateTimeline(c *gin.Context) {
    // å®ç°ç±»ä¼¼ Character API
}

// CreateTimelineEvent åˆ›å»ºæ—¶é—´çº¿äº‹ä»¶
// @Router /api/v1/projects/{projectId}/timeline-events [post]
func (a *TimelineApi) CreateTimelineEvent(c *gin.Context) {
    // ...
}

// ListTimelineEvents åˆ—å‡ºæ—¶é—´çº¿äº‹ä»¶
// @Router /api/v1/projects/{projectId}/timeline-events [get]
func (a *TimelineApi) ListTimelineEvents(c *gin.Context) {
    // ...
}
```

### 2.3 Outline APIï¼ˆåŸºäº Nodeï¼‰

```go
// api/v1/writer/outline_api.go
package writer

type OutlineApi struct {
    nodeService writer.NodeService
}

// CreateOutlineNode åˆ›å»ºå¤§çº²èŠ‚ç‚¹
// @Router /api/v1/projects/{projectId}/nodes [post]
func (a *OutlineApi) CreateOutlineNode(c *gin.Context) {
    projectID := c.Param("projectId")
    
    var req CreateNodeRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.ValidationError(c, err)
        return
    }
    
    req.Type = "outline"
    req.ProjectID = projectID
    
    node, err := a.nodeService.Create(c.Request.Context(), &req)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, node)
}

// ListOutlineNodes åˆ—å‡ºå¤§çº²èŠ‚ç‚¹
// @Router /api/v1/projects/{projectId}/nodes [get]
func (a *OutlineApi) ListOutlineNodes(c *gin.Context) {
    projectID := c.Param("projectId")
    parentID := c.Query("parentId")
    
    nodes, err := a.nodeService.ListByParent(c.Request.Context(), projectID, parentID, "outline")
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, nodes)
}

// MoveNode ç§»åŠ¨èŠ‚ç‚¹
// @Router /api/v1/projects/{projectId}/nodes/{nodeId}/move [post]
func (a *OutlineApi) MoveNode(c *gin.Context) {
    nodeID := c.Param("nodeId")
    
    var req MoveNodeRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.ValidationError(c, err)
        return
    }
    
    err := a.nodeService.Move(c.Request.Context(), nodeID, req.ParentID, req.Order)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, gin.H{"moved": true})
}
```

### 2.4 WorldSetting API

```go
// api/v1/writer/world_setting_api.go
package writer

type WorldSettingApi struct {
    worldSettingService writer.WorldSettingService
}

// CreateWorldSetting åˆ›å»ºä¸–ç•Œè§‚è®¾å®š
// @Router /api/v1/projects/{projectId}/world-settings [post]
func (a *WorldSettingApi) CreateWorldSetting(c *gin.Context) {
    projectID := c.Param("projectId")
    
    var req CreateWorldSettingRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        response.ValidationError(c, err)
        return
    }
    
    setting, err := a.worldSettingService.Create(c.Request.Context(), projectID, &req)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, setting)
}

// ListWorldSettings åˆ—å‡ºä¸–ç•Œè§‚è®¾å®š
// @Router /api/v1/projects/{projectId}/world-settings [get]
func (a *WorldSettingApi) ListWorldSettings(c *gin.Context) {
    projectID := c.Param("projectId")
    category := c.Query("category")
    
    settings, err := a.worldSettingService.List(c.Request.Context(), projectID, category)
    if err != nil {
        response.Error(c, err)
        return
    }
    
    response.Success(c, settings)
}
```

---

## ä¸‰ã€è·¯ç”±æ³¨å†Œ

### 3.1 AI è·¯ç”±

```go
// router/ai/ai_router.go
package ai

import (
    "github.com/gin-gonic/gin"
    "qingyu_backend/api/v1/ai"
    "qingyu_backend/middleware"
)

func InitAIRoutes(group *gin.RouterGroup, aiApi *ai.AIApi) {
    aiGroup := group.Group("/ai")
    aiGroup.Use(middleware.JWTAuth()) // éœ€è¦è®¤è¯
    
    {
        // ç”Ÿæˆ
        aiGroup.POST("/generate", aiApi.GenerateText)
        aiGroup.POST("/generate/stream", aiApi.GenerateTextStream)
        
        // Agent
        aiGroup.POST("/agent/execute", aiApi.ExecuteAgent)
        aiGroup.POST("/agent/execute/stream", aiApi.ExecuteAgentStream)
        
        // RAG
        aiGroup.GET("/rag/search", aiApi.RAGSearch)
        
        // Pipeline
        aiGroup.POST("/pipeline/execute", aiApi.ExecutePipeline)
        aiGroup.POST("/pipeline/execute/stream", aiApi.ExecutePipelineStream)
    }
}
```

### 3.2 Writer è·¯ç”±

```go
// router/writer/writer_router.go
package writer

import (
    "github.com/gin-gonic/gin"
    "qingyu_backend/api/v1/writer"
    "qingyu_backend/middleware"
)

func InitWriterRoutes(group *gin.RouterGroup, apis *writer.WriterApis) {
    projectGroup := group.Group("/projects/:projectId")
    projectGroup.Use(middleware.JWTAuth())
    
    {
        // è§’è‰²
        projectGroup.POST("/characters", apis.CharacterApi.CreateCharacter)
        projectGroup.GET("/characters", apis.CharacterApi.ListCharacters)
        projectGroup.GET("/characters/:characterId", apis.CharacterApi.GetCharacter)
        projectGroup.PUT("/characters/:characterId", apis.CharacterApi.UpdateCharacter)
        projectGroup.DELETE("/characters/:characterId", apis.CharacterApi.DeleteCharacter)
        
        // è§’è‰²å…³ç³»
        projectGroup.POST("/character-relations", apis.RelationApi.CreateRelation)
        projectGroup.GET("/character-relations", apis.RelationApi.ListRelations)
        
        // æ—¶é—´çº¿
        projectGroup.POST("/timelines", apis.TimelineApi.CreateTimeline)
        projectGroup.GET("/timelines", apis.TimelineApi.ListTimelines)
        projectGroup.POST("/timeline-events", apis.TimelineApi.CreateTimelineEvent)
        projectGroup.GET("/timeline-events", apis.TimelineApi.ListTimelineEvents)
        
        // å¤§çº²ï¼ˆNodeï¼‰
        projectGroup.POST("/nodes", apis.OutlineApi.CreateOutlineNode)
        projectGroup.GET("/nodes", apis.OutlineApi.ListOutlineNodes)
        projectGroup.GET("/nodes/:nodeId", apis.OutlineApi.GetOutlineNode)
        projectGroup.PUT("/nodes/:nodeId", apis.OutlineApi.UpdateOutlineNode)
        projectGroup.DELETE("/nodes/:nodeId", apis.OutlineApi.DeleteOutlineNode)
        projectGroup.POST("/nodes/:nodeId/move", apis.OutlineApi.MoveNode)
        
        // ä¸–ç•Œè§‚è®¾å®š
        projectGroup.POST("/world-settings", apis.WorldSettingApi.CreateWorldSetting)
        projectGroup.GET("/world-settings", apis.WorldSettingApi.ListWorldSettings)
    }
}
```

---

## å››ã€æ€»ç»“

æœ¬æ–‡æ¡£è®¾è®¡äº† Go API æ‰©å±•ï¼š

**AI API**ï¼š
- âœ… ç”Ÿæˆ APIï¼ˆæ–‡æœ¬ç”Ÿæˆã€æµå¼ç”Ÿæˆï¼‰
- âœ… Agent APIï¼ˆAgent æ‰§è¡Œã€æµå¼æ‰§è¡Œï¼‰
- âœ… RAG APIï¼ˆçŸ¥è¯†åº“æ£€ç´¢ï¼‰
- âœ… Pipeline APIï¼ˆA2A æµæ°´çº¿ï¼‰

**è®¾å®šç™¾ç§‘ API**ï¼š
- âœ… Character APIï¼ˆè§’è‰² CRUDï¼‰
- âœ… Timeline APIï¼ˆæ—¶é—´çº¿ CRUDï¼‰
- âœ… Outline APIï¼ˆå¤§çº² CRUDã€èŠ‚ç‚¹ç§»åŠ¨ï¼‰
- âœ… WorldSetting APIï¼ˆä¸–ç•Œè§‚è®¾å®š CRUDï¼‰

**è·¯ç”±æ³¨å†Œ**ï¼š
- âœ… AI è·¯ç”±ç»„
- âœ… Writer è·¯ç”±ç»„

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025-10-27
**ç»´æŠ¤è€…**: AIæ¶æ„ç»„
