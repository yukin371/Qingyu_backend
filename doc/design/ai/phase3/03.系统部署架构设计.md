# ç³»ç»Ÿéƒ¨ç½²æ¶æ„è®¾è®¡

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **åˆ›å»ºæ—¶é—´**: 2025-10-27
> **å®æ–½çŠ¶æ€**: è®¾è®¡é˜¶æ®µ
> **è´Ÿè´£äºº**: AIæ¶æ„ç»„

---

## ä¸€ã€éƒ¨ç½²æ¶æ„æ€»è§ˆ

### 1.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Nginx (Load Balancer)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Go Backend (3x)   â”‚                 â”‚ Python AI (3x)    â”‚
â”‚  - Gin API         â”‚â—„â”€â”€â”€gRPCâ”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ - FastAPI         â”‚
â”‚  - AI Proxy        â”‚                 â”‚ - LangGraph       â”‚
â”‚  - Business Logic  â”‚                 â”‚ - RAG Engine      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                        â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚                   MongoDB Cluster                 â”‚
    â”‚              - Primary + 2 Secondaries            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                  Milvus (Vector DB)               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚               Redis (Cache + Session)             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€Docker é•œåƒæ„å»º

### 2.1 Go Backend Dockerfile

```dockerfile
# docker/Dockerfile.go
FROM golang:1.21-alpine AS builder

WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY go.mod go.sum ./
RUN go mod download

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»º
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o server ./cmd/server

# è¿è¡Œé•œåƒ
FROM alpine:latest

RUN apk --no-cache add ca-certificates tzdata

WORKDIR /app

# å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶å’Œé…ç½®
COPY --from=builder /app/server .
COPY --from=builder /app/config ./config

# è®¾ç½®æ—¶åŒº
ENV TZ=Asia/Shanghai

EXPOSE 8080

CMD ["./server"]
```

### 2.2 Python AI Service Dockerfile

```dockerfile
# docker/Dockerfile.python
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .

# å®‰è£… Python ä¾èµ–
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶æºä»£ç 
COPY . .

# ç”Ÿæˆ Proto æ–‡ä»¶
RUN python -m grpc_tools.protoc \
    -I./proto \
    --python_out=./src/proto \
    --grpc_python_out=./src/proto \
    ./proto/*.proto

EXPOSE 8081 50051

CMD ["python", "src/main.py"]
```

---

## ä¸‰ã€Docker Compose ç¼–æ’

### 3.1 å®Œæ•´éƒ¨ç½²é…ç½®

```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  # Nginx è´Ÿè½½å‡è¡¡
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - go-backend
      - python-ai
    networks:
      - qingyu-network
    restart: always

  # Go åç«¯æœåŠ¡ï¼ˆ3 ä¸ªå®ä¾‹ï¼‰
  go-backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.go
    environment:
      - APP_ENV=production
      - MONGODB_URI=mongodb://mongodb-primary:27017,mongodb-secondary1:27017,mongodb-secondary2:27017/qingyu?replicaSet=rs0
      - REDIS_ADDR=redis:6379
      - AI_SERVICE_URL=python-ai:50051
    depends_on:
      - mongodb-primary
      - redis
    networks:
      - qingyu-network
    deploy:
      replicas: 3
      restart_policy:
        condition: on-failure
        max_attempts: 3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Python AI æœåŠ¡ï¼ˆ3 ä¸ªå®ä¾‹ï¼‰
  python-ai:
    build:
      context: ./python_ai
      dockerfile: docker/Dockerfile.python
    environment:
      - APP_ENV=production
      - MONGODB_URI=mongodb://mongodb-primary:27017/qingyu
      - MILVUS_HOST=milvus-standalone
      - MILVUS_PORT=19530
      - REDIS_URL=redis://redis:6379/0
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GO_API_URL=http://go-backend:8080
    depends_on:
      - mongodb-primary
      - milvus-standalone
      - redis
    networks:
      - qingyu-network
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '2'
          memory: 4G
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8081/health')"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MongoDB ä¸»èŠ‚ç‚¹
  mongodb-primary:
    image: mongo:7.0
    command: mongod --replSet rs0 --bind_ip_all
    volumes:
      - mongodb-primary-data:/data/db
    networks:
      - qingyu-network
    restart: always

  # MongoDB ä»èŠ‚ç‚¹ 1
  mongodb-secondary1:
    image: mongo:7.0
    command: mongod --replSet rs0 --bind_ip_all
    volumes:
      - mongodb-secondary1-data:/data/db
    networks:
      - qingyu-network
    restart: always

  # MongoDB ä»èŠ‚ç‚¹ 2
  mongodb-secondary2:
    image: mongo:7.0
    command: mongod --replSet rs0 --bind_ip_all
    volumes:
      - mongodb-secondary2-data:/data/db
    networks:
      - qingyu-network
    restart: always

  # Milvus å‘é‡æ•°æ®åº“
  milvus-standalone:
    image: milvusdb/milvus:v2.3.0
    command: milvus run standalone
    environment:
      - ETCD_ENDPOINTS=etcd:2379
      - MINIO_ADDRESS=minio:9000
    volumes:
      - milvus-data:/var/lib/milvus
    networks:
      - qingyu-network
    depends_on:
      - etcd
      - minio
    restart: always

  # Etcdï¼ˆMilvus ä¾èµ–ï¼‰
  etcd:
    image: quay.io/coreos/etcd:v3.5.5
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
    volumes:
      - etcd-data:/etcd
    networks:
      - qingyu-network
    restart: always

  # MinIOï¼ˆMilvus å­˜å‚¨ï¼‰
  minio:
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    environment:
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
    command: server /minio_data
    volumes:
      - minio-data:/minio_data
    networks:
      - qingyu-network
    restart: always

  # Redis
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - qingyu-network
    restart: always

  # Prometheus (ç›‘æ§)
  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    networks:
      - qingyu-network
    restart: always

  # Grafana (å¯è§†åŒ–)
  grafana:
    image: grafana/grafana:latest
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana-data:/var/lib/grafana
      - ./docker/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
    ports:
      - "3000:3000"
    networks:
      - qingyu-network
    depends_on:
      - prometheus
    restart: always

networks:
  qingyu-network:
    driver: bridge

volumes:
  mongodb-primary-data:
  mongodb-secondary1-data:
  mongodb-secondary2-data:
  milvus-data:
  etcd-data:
  minio-data:
  redis-data:
  prometheus-data:
  grafana-data:
```

---

## å››ã€Nginx é…ç½®

```nginx
# docker/nginx/nginx.conf
upstream go_backend {
    least_conn;
    server go-backend-1:8080;
    server go-backend-2:8080;
    server go-backend-3:8080;
}

upstream python_ai {
    least_conn;
    server python-ai-1:8081;
    server python-ai-2:8081;
    server python-ai-3:8081;
}

server {
    listen 80;
    server_name api.qingyu.com;

    location /api/v1/ai/ {
        proxy_pass http://python_ai;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        
        # SSE æ”¯æŒ
        proxy_buffering off;
        proxy_cache off;
    }

    location / {
        proxy_pass http://go_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

---

## äº”ã€éƒ¨ç½²è„šæœ¬

### 5.1 éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash
# scripts/deploy.sh

set -e

echo "ğŸš€ Starting deployment..."

# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 2. æ„å»ºé•œåƒ
echo "ğŸ“¦ Building Docker images..."
docker-compose -f docker-compose.prod.yml build

# 3. åœæ­¢æ—§å®¹å™¨
echo "ğŸ›‘ Stopping old containers..."
docker-compose -f docker-compose.prod.yml down

# 4. å¯åŠ¨æ–°å®¹å™¨
echo "ğŸš€ Starting new containers..."
docker-compose -f docker-compose.prod.yml up -d

# 5. ç­‰å¾…æœåŠ¡å°±ç»ª
echo "â³ Waiting for services to be ready..."
sleep 30

# 6. å¥åº·æ£€æŸ¥
echo "ğŸ¥ Health check..."
curl -f http://localhost:80/health || exit 1

echo "âœ… Deployment completed successfully!"
```

### 5.2 å›æ»šè„šæœ¬

```bash
#!/bin/bash
# scripts/rollback.sh

set -e

echo "ğŸ”„ Rolling back to previous version..."

# 1. åœæ­¢å½“å‰å®¹å™¨
docker-compose -f docker-compose.prod.yml down

# 2. åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
git checkout HEAD~1

# 3. é‡æ–°éƒ¨ç½²
./scripts/deploy.sh

echo "âœ… Rollback completed!"
```

---

## å…­ã€é…ç½®ç®¡ç†

### 6.1 ç¯å¢ƒå˜é‡ç®¡ç†

```bash
# .env.production
APP_ENV=production

# MongoDB
MONGODB_URI=mongodb://mongodb-primary:27017,mongodb-secondary1:27017,mongodb-secondary2:27017/qingyu?replicaSet=rs0

# Redis
REDIS_ADDR=redis:6379

# Milvus
MILVUS_HOST=milvus-standalone
MILVUS_PORT=19530

# AI Service
OPENAI_API_KEY=sk-xxx
AI_SERVICE_URL=python-ai:50051

# JWT
JWT_SECRET=your-secret-key

# Monitoring
PROMETHEUS_ADDR=prometheus:9090
```

---

## ä¸ƒã€æ€»ç»“

æœ¬æ–‡æ¡£è®¾è®¡äº†å®Œæ•´çš„éƒ¨ç½²æ¶æ„ï¼š

- âœ… Docker é•œåƒæ„å»ºï¼ˆGo + Pythonï¼‰
- âœ… Docker Compose ç¼–æ’
- âœ… è´Ÿè½½å‡è¡¡ï¼ˆNginxï¼‰
- âœ… MongoDB é›†ç¾¤ï¼ˆ1 Primary + 2 Secondaryï¼‰
- âœ… Milvus å‘é‡æ•°æ®åº“
- âœ… Redis ç¼“å­˜
- âœ… ç›‘æ§ï¼ˆPrometheus + Grafanaï¼‰
- âœ… éƒ¨ç½²å’Œå›æ»šè„šæœ¬

**éƒ¨ç½²ç‰¹æ€§**ï¼š
- æœåŠ¡é«˜å¯ç”¨ï¼ˆ3 å‰¯æœ¬ï¼‰
- æ•°æ®æŒä¹…åŒ–
- å¥åº·æ£€æŸ¥
- è‡ªåŠ¨é‡å¯

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025-10-27
**ç»´æŠ¤è€…**: AIæ¶æ„ç»„
