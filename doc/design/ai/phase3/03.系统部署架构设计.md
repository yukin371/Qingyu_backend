# 系统部署架构设计

> **文档版本**: v1.0
> **创建时间**: 2025-10-27
> **实施状态**: 设计阶段
> **负责人**: AI架构组

---

## 一、部署架构总览

### 1.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                   Nginx (Load Balancer)                  │
└───────┬──────────────────────────────────────────┬──────┘
        │                                          │
┌───────▼────────────┐                 ┌──────────▼────────┐
│  Go Backend (3x)   │                 │ Python AI (3x)    │
│  - Gin API         │◄───gRPC────────►│ - FastAPI         │
│  - AI Proxy        │                 │ - LangGraph       │
│  - Business Logic  │                 │ - RAG Engine      │
└────────┬───────────┘                 └──────────┬────────┘
         │                                        │
    ┌────▼────────────────────────────────────────▼────┐
    │                   MongoDB Cluster                 │
    │              - Primary + 2 Secondaries            │
    └──────────────────────────────────────────────────┘
                             │
    ┌────────────────────────▼──────────────────────────┐
    │                  Milvus (Vector DB)               │
    └───────────────────────────────────────────────────┘
                             │
    ┌────────────────────────▼──────────────────────────┐
    │               Redis (Cache + Session)             │
    └───────────────────────────────────────────────────┘
```

---

## 二、Docker 镜像构建

### 2.1 Go Backend Dockerfile

```dockerfile
# docker/Dockerfile.go
FROM golang:1.21-alpine AS builder

WORKDIR /app

# 复制依赖文件
COPY go.mod go.sum ./
RUN go mod download

# 复制源代码
COPY . .

# 构建
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o server ./cmd/server

# 运行镜像
FROM alpine:latest

RUN apk --no-cache add ca-certificates tzdata

WORKDIR /app

# 复制可执行文件和配置
COPY --from=builder /app/server .
COPY --from=builder /app/config ./config

# 设置时区
ENV TZ=Asia/Shanghai

EXPOSE 8080

CMD ["./server"]
```

### 2.2 Python AI Service Dockerfile

```dockerfile
# docker/Dockerfile.python
FROM python:3.11-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.txt .

# 安装 Python 依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制源代码
COPY . .

# 生成 Proto 文件
RUN python -m grpc_tools.protoc \
    -I./proto \
    --python_out=./src/proto \
    --grpc_python_out=./src/proto \
    ./proto/*.proto

EXPOSE 8081 50051

CMD ["python", "src/main.py"]
```

---

## 三、Docker Compose 编排

### 3.1 完整部署配置

```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  # Nginx 负载均衡
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - go-backend
      - python-ai
    networks:
      - qingyu-network
    restart: always

  # Go 后端服务（3 个实例）
  go-backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.go
    environment:
      - APP_ENV=production
      - MONGODB_URI=mongodb://mongodb-primary:27017,mongodb-secondary1:27017,mongodb-secondary2:27017/qingyu?replicaSet=rs0
      - REDIS_ADDR=redis:6379
      - AI_SERVICE_URL=python-ai:50051
    depends_on:
      - mongodb-primary
      - redis
    networks:
      - qingyu-network
    deploy:
      replicas: 3
      restart_policy:
        condition: on-failure
        max_attempts: 3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Python AI 服务（3 个实例）
  python-ai:
    build:
      context: ./python_ai
      dockerfile: docker/Dockerfile.python
    environment:
      - APP_ENV=production
      - MONGODB_URI=mongodb://mongodb-primary:27017/qingyu
      - MILVUS_HOST=milvus-standalone
      - MILVUS_PORT=19530
      - REDIS_URL=redis://redis:6379/0
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GO_API_URL=http://go-backend:8080
    depends_on:
      - mongodb-primary
      - milvus-standalone
      - redis
    networks:
      - qingyu-network
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '2'
          memory: 4G
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8081/health')"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MongoDB 主节点
  mongodb-primary:
    image: mongo:7.0
    command: mongod --replSet rs0 --bind_ip_all
    volumes:
      - mongodb-primary-data:/data/db
    networks:
      - qingyu-network
    restart: always

  # MongoDB 从节点 1
  mongodb-secondary1:
    image: mongo:7.0
    command: mongod --replSet rs0 --bind_ip_all
    volumes:
      - mongodb-secondary1-data:/data/db
    networks:
      - qingyu-network
    restart: always

  # MongoDB 从节点 2
  mongodb-secondary2:
    image: mongo:7.0
    command: mongod --replSet rs0 --bind_ip_all
    volumes:
      - mongodb-secondary2-data:/data/db
    networks:
      - qingyu-network
    restart: always

  # Milvus 向量数据库
  milvus-standalone:
    image: milvusdb/milvus:v2.3.0
    command: milvus run standalone
    environment:
      - ETCD_ENDPOINTS=etcd:2379
      - MINIO_ADDRESS=minio:9000
    volumes:
      - milvus-data:/var/lib/milvus
    networks:
      - qingyu-network
    depends_on:
      - etcd
      - minio
    restart: always

  # Etcd（Milvus 依赖）
  etcd:
    image: quay.io/coreos/etcd:v3.5.5
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
    volumes:
      - etcd-data:/etcd
    networks:
      - qingyu-network
    restart: always

  # MinIO（Milvus 存储）
  minio:
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    environment:
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
    command: server /minio_data
    volumes:
      - minio-data:/minio_data
    networks:
      - qingyu-network
    restart: always

  # Redis
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - qingyu-network
    restart: always

  # Prometheus (监控)
  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    networks:
      - qingyu-network
    restart: always

  # Grafana (可视化)
  grafana:
    image: grafana/grafana:latest
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana-data:/var/lib/grafana
      - ./docker/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
    ports:
      - "3000:3000"
    networks:
      - qingyu-network
    depends_on:
      - prometheus
    restart: always

networks:
  qingyu-network:
    driver: bridge

volumes:
  mongodb-primary-data:
  mongodb-secondary1-data:
  mongodb-secondary2-data:
  milvus-data:
  etcd-data:
  minio-data:
  redis-data:
  prometheus-data:
  grafana-data:
```

---

## 四、Nginx 配置

```nginx
# docker/nginx/nginx.conf
upstream go_backend {
    least_conn;
    server go-backend-1:8080;
    server go-backend-2:8080;
    server go-backend-3:8080;
}

upstream python_ai {
    least_conn;
    server python-ai-1:8081;
    server python-ai-2:8081;
    server python-ai-3:8081;
}

server {
    listen 80;
    server_name api.qingyu.com;

    location /api/v1/ai/ {
        proxy_pass http://python_ai;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        
        # SSE 支持
        proxy_buffering off;
        proxy_cache off;
    }

    location / {
        proxy_pass http://go_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

---

## 五、部署脚本

### 5.1 部署脚本

```bash
#!/bin/bash
# scripts/deploy.sh

set -e

echo "🚀 Starting deployment..."

# 1. 拉取最新代码
git pull origin main

# 2. 构建镜像
echo "📦 Building Docker images..."
docker-compose -f docker-compose.prod.yml build

# 3. 停止旧容器
echo "🛑 Stopping old containers..."
docker-compose -f docker-compose.prod.yml down

# 4. 启动新容器
echo "🚀 Starting new containers..."
docker-compose -f docker-compose.prod.yml up -d

# 5. 等待服务就绪
echo "⏳ Waiting for services to be ready..."
sleep 30

# 6. 健康检查
echo "🏥 Health check..."
curl -f http://localhost:80/health || exit 1

echo "✅ Deployment completed successfully!"
```

### 5.2 回滚脚本

```bash
#!/bin/bash
# scripts/rollback.sh

set -e

echo "🔄 Rolling back to previous version..."

# 1. 停止当前容器
docker-compose -f docker-compose.prod.yml down

# 2. 切换到上一个版本
git checkout HEAD~1

# 3. 重新部署
./scripts/deploy.sh

echo "✅ Rollback completed!"
```

---

## 六、配置管理

### 6.1 环境变量管理

```bash
# .env.production
APP_ENV=production

# MongoDB
MONGODB_URI=mongodb://mongodb-primary:27017,mongodb-secondary1:27017,mongodb-secondary2:27017/qingyu?replicaSet=rs0

# Redis
REDIS_ADDR=redis:6379

# Milvus
MILVUS_HOST=milvus-standalone
MILVUS_PORT=19530

# AI Service
OPENAI_API_KEY=sk-xxx
AI_SERVICE_URL=python-ai:50051

# JWT
JWT_SECRET=your-secret-key

# Monitoring
PROMETHEUS_ADDR=prometheus:9090
```

---

## 七、总结

本文档设计了完整的部署架构：

- ✅ Docker 镜像构建（Go + Python）
- ✅ Docker Compose 编排
- ✅ 负载均衡（Nginx）
- ✅ MongoDB 集群（1 Primary + 2 Secondary）
- ✅ Milvus 向量数据库
- ✅ Redis 缓存
- ✅ 监控（Prometheus + Grafana）
- ✅ 部署和回滚脚本

**部署特性**：
- 服务高可用（3 副本）
- 数据持久化
- 健康检查
- 自动重启

---

**文档版本**: v1.0
**创建时间**: 2025-10-27
**维护者**: AI架构组
