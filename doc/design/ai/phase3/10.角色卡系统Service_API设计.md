# 角色卡系统 Service/API 设计

> **文档版本**: v1.0
> **创建时间**: 2025-10-27
> **实施状态**: 设计阶段
> **负责人**: AI架构组

---

## 📋 文档概述

本文档设计角色卡系统的 Service 层和 API 层，包括 CRUD 操作、关系管理和 AI 生成集成。

---

## 一、Service 接口定义

### 1.1 CharacterService 接口

```go
// service/interfaces/character_service.go
package interfaces

import (
    "context"
    "qingyu_backend/models/writer"
)

type CharacterService interface {
    // 基础 CRUD
    Create(ctx context.Context, projectID, userID string, req *CreateCharacterRequest) (*writer.Character, error)
    GetByID(ctx context.Context, characterID, projectID string) (*writer.Character, error)
    List(ctx context.Context, projectID string, options *ListOptions) ([]*writer.Character, error)
    Update(ctx context.Context, characterID, projectID string, req *UpdateCharacterRequest) (*writer.Character, error)
    Delete(ctx context.Context, characterID, projectID string) error
    
    // AI 生成
    GenerateCharacter(ctx context.Context, projectID, userID string, req *GenerateCharacterRequest) (*writer.Character, error)
    RegenerateField(ctx context.Context, characterID, fieldName string) error
    
    // 关系管理
    CreateRelation(ctx context.Context, projectID string, req *CreateRelationRequest) (*writer.CharacterRelation, error)
    ListRelations(ctx context.Context, projectID string, characterID *string) ([]*writer.CharacterRelation, error)
    DeleteRelation(ctx context.Context, relationID, projectID string) error
    
    // 分析和建议
    AnalyzeCharacter(ctx context.Context, characterID string) (*CharacterAnalysis, error)
    GetSuggestions(ctx context.Context, characterID string) ([]string, error)
}

type CreateCharacterRequest struct {
    Name              string                 `json:"name" validate:"required"`
    Alias             []string               `json:"alias"`
    Summary           string                 `json:"summary"`
    Traits            []string               `json:"traits"`
    Background        string                 `json:"background"`
    PersonalityPrompt string                 `json:"personalityPrompt"`
    SpeechPattern     string                 `json:"speechPattern"`
    AIGenerated       bool                   `json:"aiGenerated"`
    GenerationPrompt  string                 `json:"generationPrompt"`
}

type UpdateCharacterRequest struct {
    Name              *string   `json:"name"`
    Alias             *[]string `json:"alias"`
    Summary           *string   `json:"summary"`
    Traits            *[]string `json:"traits"`
    Background        *string   `json:"background"`
    PersonalityPrompt *string   `json:"personalityPrompt"`
    SpeechPattern     *string   `json:"speechPattern"`
}

type GenerateCharacterRequest struct {
    Prompt      string            `json:"prompt" validate:"required"`
    Role        string            `json:"role"` // protagonist, supporting, antagonist
    Constraints map[string]string `json:"constraints"`
}

type CharacterAnalysis struct {
    PersonalityType string   `json:"personalityType"`
    Archetype       string   `json:"archetype"`
    Strengths       []string `json:"strengths"`
    Weaknesses      []string `json:"weaknesses"`
    Conflicts       []string `json:"conflicts"`
}

type CreateRelationRequest struct {
    FromID   string `json:"fromId" validate:"required"`
    ToID     string `json:"toId" validate:"required"`
    Type     string `json:"type" validate:"required"`
    Strength int    `json:"strength"`
    Notes    string `json:"notes"`
}
```

---

## 二、Service 实现

### 2.1 CharacterServiceImpl

```go
// service/writer/character_service_impl.go
package writer

import (
    "context"
    "time"
    "qingyu_backend/models/writer"
    "qingyu_backend/repository/interfaces"
    "qingyu_backend/service/events"
    "qingyu_backend/pkg/errors"
)

type CharacterServiceImpl struct {
    characterRepo interfaces.CharacterRepository
    relationRepo  interfaces.CharacterRelationRepository
    eventBus      events.EventBus
    aiProxy       AIProxyService
}

func NewCharacterService(
    characterRepo interfaces.CharacterRepository,
    relationRepo interfaces.CharacterRelationRepository,
    eventBus events.EventBus,
    aiProxy AIProxyService,
) *CharacterServiceImpl {
    return &CharacterServiceImpl{
        characterRepo: characterRepo,
        relationRepo:  relationRepo,
        eventBus:      eventBus,
        aiProxy:       aiProxy,
    }
}

func (s *CharacterServiceImpl) Create(
    ctx context.Context,
    projectID, userID string,
    req *CreateCharacterRequest,
) (*writer.Character, error) {
    // 1. 验证项目权限
    // ... (省略)
    
    // 2. 构建角色对象
    character := &writer.Character{
        ProjectID:         projectID,
        Name:              req.Name,
        Alias:             req.Alias,
        Summary:           req.Summary,
        Traits:            req.Traits,
        Background:        req.Background,
        PersonalityPrompt: req.PersonalityPrompt,
        SpeechPattern:     req.SpeechPattern,
        AIGenerated:       req.AIGenerated,
        GenerationPrompt:  req.GenerationPrompt,
        CreatedAt:         time.Now(),
        UpdatedAt:         time.Now(),
    }
    
    // 3. 保存到数据库
    if err := s.characterRepo.Create(ctx, character); err != nil {
        return nil, errors.NewDatabaseError("create character failed", err)
    }
    
    // 4. 发布事件（触发向量化）
    s.eventBus.Publish(&events.CharacterCreatedEvent{
        CharacterID: character.ID,
        ProjectID:   projectID,
        UserID:      userID,
    })
    
    return character, nil
}

func (s *CharacterServiceImpl) GetByID(
    ctx context.Context,
    characterID, projectID string,
) (*writer.Character, error) {
    character, err := s.characterRepo.FindByID(ctx, characterID)
    if err != nil {
        return nil, errors.NewNotFoundError("character not found", err)
    }
    
    // 验证项目权限
    if character.ProjectID != projectID {
        return nil, errors.NewAuthError("no permission")
    }
    
    return character, nil
}

func (s *CharacterServiceImpl) List(
    ctx context.Context,
    projectID string,
    options *ListOptions,
) ([]*writer.Character, error) {
    return s.characterRepo.FindByProjectID(ctx, projectID, options)
}

func (s *CharacterServiceImpl) GenerateCharacter(
    ctx context.Context,
    projectID, userID string,
    req *GenerateCharacterRequest,
) (*writer.Character, error) {
    // 1. 调用 AI Proxy 生成角色
    aiReq := &AIAgentRequest{
        AgentType: "character",
        Task:      req.Prompt,
        ProjectID: projectID,
        UserID:    userID,
        Parameters: map[string]string{
            "role": req.Role,
        },
    }
    
    aiResult, err := s.aiProxy.ExecuteAgent(ctx, aiReq)
    if err != nil {
        return nil, errors.NewExternalError("AI generation failed", err)
    }
    
    // 2. 解析 AI 结果并创建角色
    characterData := parseAICharacterResult(aiResult)
    
    createReq := &CreateCharacterRequest{
        Name:             characterData.Name,
        Traits:           characterData.Traits,
        Background:       characterData.Background,
        AIGenerated:      true,
        GenerationPrompt: req.Prompt,
    }
    
    return s.Create(ctx, projectID, userID, createReq)
}

func (s *CharacterServiceImpl) CreateRelation(
    ctx context.Context,
    projectID string,
    req *CreateRelationRequest,
) (*writer.CharacterRelation, error) {
    // 1. 验证两个角色是否存在
    _, err := s.GetByID(ctx, req.FromID, projectID)
    if err != nil {
        return nil, err
    }
    
    _, err = s.GetByID(ctx, req.ToID, projectID)
    if err != nil {
        return nil, err
    }
    
    // 2. 创建关系
    relation := &writer.CharacterRelation{
        ProjectID: projectID,
        FromID:    req.FromID,
        ToID:      req.ToID,
        Type:      req.Type,
        Strength:  req.Strength,
        Notes:     req.Notes,
        CreatedAt: time.Now(),
        UpdatedAt: time.Now(),
    }
    
    if err := s.relationRepo.Create(ctx, relation); err != nil {
        return nil, errors.NewDatabaseError("create relation failed", err)
    }
    
    return relation, nil
}

func (s *CharacterServiceImpl) AnalyzeCharacter(
    ctx context.Context,
    characterID string,
) (*CharacterAnalysis, error) {
    // 调用 AI 分析角色
    character, err := s.characterRepo.FindByID(ctx, characterID)
    if err != nil {
        return nil, err
    }
    
    // 构建分析 Prompt
    prompt := fmt.Sprintf("分析角色：%s\n性格：%s\n背景：%s",
        character.Name,
        strings.Join(character.Traits, ", "),
        character.Background,
    )
    
    aiResult, err := s.aiProxy.GenerateText(ctx, &GenerateRequest{
        Prompt: prompt,
        Model:  "gpt-4-turbo",
    })
    
    // 解析分析结果
    analysis := parseCharacterAnalysis(aiResult)
    
    // 保存到角色模型
    character.PersonalityAnalysis = analysis.PersonalityType
    character.ArchetypeType = analysis.Archetype
    s.characterRepo.Update(ctx, character)
    
    return analysis, nil
}
```

---

## 三、事件驱动索引

### 3.1 Character 事件处理器

```go
// service/events/handlers/character_handler.go
package handlers

import (
    "context"
    "qingyu_backend/service/events"
    "qingyu_backend/core/rag"
)

type CharacterEventHandler struct {
    vectorizationEngine *rag.VectorizationEngine
}

func (h *CharacterEventHandler) Handle(event events.Event) error {
    switch e := event.(type) {
    case *events.CharacterCreatedEvent:
        return h.handleCreated(e)
    case *events.CharacterUpdatedEvent:
        return h.handleUpdated(e)
    case *events.CharacterDeletedEvent:
        return h.handleDeleted(e)
    }
    return nil
}

func (h *CharacterEventHandler) handleCreated(event *events.CharacterCreatedEvent) error {
    // 向量化角色数据
    return h.vectorizationEngine.VectorizeCharacter(
        context.Background(),
        event.CharacterID,
        event.ProjectID,
    )
}
```

---

## 四、总结

本文档设计了角色卡系统的完整实现：

- ✅ CharacterService 接口定义
- ✅ CharacterServiceImpl 实现
- ✅ 基础 CRUD 操作
- ✅ AI 生成角色集成
- ✅ 角色关系管理
- ✅ 事件驱动向量化

---

**文档版本**: v1.0
**创建时间**: 2025-10-27
**维护者**: AI架构组
