# è§’è‰²å¡ç³»ç»Ÿ Service/API è®¾è®¡

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **åˆ›å»ºæ—¶é—´**: 2025-10-27
> **å®æ–½çŠ¶æ€**: è®¾è®¡é˜¶æ®µ
> **è´Ÿè´£äºº**: AIæ¶æ„ç»„

---

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è®¾è®¡è§’è‰²å¡ç³»ç»Ÿçš„ Service å±‚å’Œ API å±‚ï¼ŒåŒ…æ‹¬ CRUD æ“ä½œã€å…³ç³»ç®¡ç†å’Œ AI ç”Ÿæˆé›†æˆã€‚

---

## ä¸€ã€Service æ¥å£å®šä¹‰

### 1.1 CharacterService æ¥å£

```go
// service/interfaces/character_service.go
package interfaces

import (
    "context"
    "qingyu_backend/models/writer"
)

type CharacterService interface {
    // åŸºç¡€ CRUD
    Create(ctx context.Context, projectID, userID string, req *CreateCharacterRequest) (*writer.Character, error)
    GetByID(ctx context.Context, characterID, projectID string) (*writer.Character, error)
    List(ctx context.Context, projectID string, options *ListOptions) ([]*writer.Character, error)
    Update(ctx context.Context, characterID, projectID string, req *UpdateCharacterRequest) (*writer.Character, error)
    Delete(ctx context.Context, characterID, projectID string) error
    
    // AI ç”Ÿæˆ
    GenerateCharacter(ctx context.Context, projectID, userID string, req *GenerateCharacterRequest) (*writer.Character, error)
    RegenerateField(ctx context.Context, characterID, fieldName string) error
    
    // å…³ç³»ç®¡ç†
    CreateRelation(ctx context.Context, projectID string, req *CreateRelationRequest) (*writer.CharacterRelation, error)
    ListRelations(ctx context.Context, projectID string, characterID *string) ([]*writer.CharacterRelation, error)
    DeleteRelation(ctx context.Context, relationID, projectID string) error
    
    // åˆ†æå’Œå»ºè®®
    AnalyzeCharacter(ctx context.Context, characterID string) (*CharacterAnalysis, error)
    GetSuggestions(ctx context.Context, characterID string) ([]string, error)
}

type CreateCharacterRequest struct {
    Name              string                 `json:"name" validate:"required"`
    Alias             []string               `json:"alias"`
    Summary           string                 `json:"summary"`
    Traits            []string               `json:"traits"`
    Background        string                 `json:"background"`
    PersonalityPrompt string                 `json:"personalityPrompt"`
    SpeechPattern     string                 `json:"speechPattern"`
    AIGenerated       bool                   `json:"aiGenerated"`
    GenerationPrompt  string                 `json:"generationPrompt"`
}

type UpdateCharacterRequest struct {
    Name              *string   `json:"name"`
    Alias             *[]string `json:"alias"`
    Summary           *string   `json:"summary"`
    Traits            *[]string `json:"traits"`
    Background        *string   `json:"background"`
    PersonalityPrompt *string   `json:"personalityPrompt"`
    SpeechPattern     *string   `json:"speechPattern"`
}

type GenerateCharacterRequest struct {
    Prompt      string            `json:"prompt" validate:"required"`
    Role        string            `json:"role"` // protagonist, supporting, antagonist
    Constraints map[string]string `json:"constraints"`
}

type CharacterAnalysis struct {
    PersonalityType string   `json:"personalityType"`
    Archetype       string   `json:"archetype"`
    Strengths       []string `json:"strengths"`
    Weaknesses      []string `json:"weaknesses"`
    Conflicts       []string `json:"conflicts"`
}

type CreateRelationRequest struct {
    FromID   string `json:"fromId" validate:"required"`
    ToID     string `json:"toId" validate:"required"`
    Type     string `json:"type" validate:"required"`
    Strength int    `json:"strength"`
    Notes    string `json:"notes"`
}
```

---

## äºŒã€Service å®ç°

### 2.1 CharacterServiceImpl

```go
// service/writer/character_service_impl.go
package writer

import (
    "context"
    "time"
    "qingyu_backend/models/writer"
    "qingyu_backend/repository/interfaces"
    "qingyu_backend/service/events"
    "qingyu_backend/pkg/errors"
)

type CharacterServiceImpl struct {
    characterRepo interfaces.CharacterRepository
    relationRepo  interfaces.CharacterRelationRepository
    eventBus      events.EventBus
    aiProxy       AIProxyService
}

func NewCharacterService(
    characterRepo interfaces.CharacterRepository,
    relationRepo interfaces.CharacterRelationRepository,
    eventBus events.EventBus,
    aiProxy AIProxyService,
) *CharacterServiceImpl {
    return &CharacterServiceImpl{
        characterRepo: characterRepo,
        relationRepo:  relationRepo,
        eventBus:      eventBus,
        aiProxy:       aiProxy,
    }
}

func (s *CharacterServiceImpl) Create(
    ctx context.Context,
    projectID, userID string,
    req *CreateCharacterRequest,
) (*writer.Character, error) {
    // 1. éªŒè¯é¡¹ç›®æƒé™
    // ... (çœç•¥)
    
    // 2. æ„å»ºè§’è‰²å¯¹è±¡
    character := &writer.Character{
        ProjectID:         projectID,
        Name:              req.Name,
        Alias:             req.Alias,
        Summary:           req.Summary,
        Traits:            req.Traits,
        Background:        req.Background,
        PersonalityPrompt: req.PersonalityPrompt,
        SpeechPattern:     req.SpeechPattern,
        AIGenerated:       req.AIGenerated,
        GenerationPrompt:  req.GenerationPrompt,
        CreatedAt:         time.Now(),
        UpdatedAt:         time.Now(),
    }
    
    // 3. ä¿å­˜åˆ°æ•°æ®åº“
    if err := s.characterRepo.Create(ctx, character); err != nil {
        return nil, errors.NewDatabaseError("create character failed", err)
    }
    
    // 4. å‘å¸ƒäº‹ä»¶ï¼ˆè§¦å‘å‘é‡åŒ–ï¼‰
    s.eventBus.Publish(&events.CharacterCreatedEvent{
        CharacterID: character.ID,
        ProjectID:   projectID,
        UserID:      userID,
    })
    
    return character, nil
}

func (s *CharacterServiceImpl) GetByID(
    ctx context.Context,
    characterID, projectID string,
) (*writer.Character, error) {
    character, err := s.characterRepo.FindByID(ctx, characterID)
    if err != nil {
        return nil, errors.NewNotFoundError("character not found", err)
    }
    
    // éªŒè¯é¡¹ç›®æƒé™
    if character.ProjectID != projectID {
        return nil, errors.NewAuthError("no permission")
    }
    
    return character, nil
}

func (s *CharacterServiceImpl) List(
    ctx context.Context,
    projectID string,
    options *ListOptions,
) ([]*writer.Character, error) {
    return s.characterRepo.FindByProjectID(ctx, projectID, options)
}

func (s *CharacterServiceImpl) GenerateCharacter(
    ctx context.Context,
    projectID, userID string,
    req *GenerateCharacterRequest,
) (*writer.Character, error) {
    // 1. è°ƒç”¨ AI Proxy ç”Ÿæˆè§’è‰²
    aiReq := &AIAgentRequest{
        AgentType: "character",
        Task:      req.Prompt,
        ProjectID: projectID,
        UserID:    userID,
        Parameters: map[string]string{
            "role": req.Role,
        },
    }
    
    aiResult, err := s.aiProxy.ExecuteAgent(ctx, aiReq)
    if err != nil {
        return nil, errors.NewExternalError("AI generation failed", err)
    }
    
    // 2. è§£æ AI ç»“æœå¹¶åˆ›å»ºè§’è‰²
    characterData := parseAICharacterResult(aiResult)
    
    createReq := &CreateCharacterRequest{
        Name:             characterData.Name,
        Traits:           characterData.Traits,
        Background:       characterData.Background,
        AIGenerated:      true,
        GenerationPrompt: req.Prompt,
    }
    
    return s.Create(ctx, projectID, userID, createReq)
}

func (s *CharacterServiceImpl) CreateRelation(
    ctx context.Context,
    projectID string,
    req *CreateRelationRequest,
) (*writer.CharacterRelation, error) {
    // 1. éªŒè¯ä¸¤ä¸ªè§’è‰²æ˜¯å¦å­˜åœ¨
    _, err := s.GetByID(ctx, req.FromID, projectID)
    if err != nil {
        return nil, err
    }
    
    _, err = s.GetByID(ctx, req.ToID, projectID)
    if err != nil {
        return nil, err
    }
    
    // 2. åˆ›å»ºå…³ç³»
    relation := &writer.CharacterRelation{
        ProjectID: projectID,
        FromID:    req.FromID,
        ToID:      req.ToID,
        Type:      req.Type,
        Strength:  req.Strength,
        Notes:     req.Notes,
        CreatedAt: time.Now(),
        UpdatedAt: time.Now(),
    }
    
    if err := s.relationRepo.Create(ctx, relation); err != nil {
        return nil, errors.NewDatabaseError("create relation failed", err)
    }
    
    return relation, nil
}

func (s *CharacterServiceImpl) AnalyzeCharacter(
    ctx context.Context,
    characterID string,
) (*CharacterAnalysis, error) {
    // è°ƒç”¨ AI åˆ†æè§’è‰²
    character, err := s.characterRepo.FindByID(ctx, characterID)
    if err != nil {
        return nil, err
    }
    
    // æ„å»ºåˆ†æ Prompt
    prompt := fmt.Sprintf("åˆ†æè§’è‰²ï¼š%s\næ€§æ ¼ï¼š%s\nèƒŒæ™¯ï¼š%s",
        character.Name,
        strings.Join(character.Traits, ", "),
        character.Background,
    )
    
    aiResult, err := s.aiProxy.GenerateText(ctx, &GenerateRequest{
        Prompt: prompt,
        Model:  "gpt-4-turbo",
    })
    
    // è§£æåˆ†æç»“æœ
    analysis := parseCharacterAnalysis(aiResult)
    
    // ä¿å­˜åˆ°è§’è‰²æ¨¡å‹
    character.PersonalityAnalysis = analysis.PersonalityType
    character.ArchetypeType = analysis.Archetype
    s.characterRepo.Update(ctx, character)
    
    return analysis, nil
}
```

---

## ä¸‰ã€äº‹ä»¶é©±åŠ¨ç´¢å¼•

### 3.1 Character äº‹ä»¶å¤„ç†å™¨

```go
// service/events/handlers/character_handler.go
package handlers

import (
    "context"
    "qingyu_backend/service/events"
    "qingyu_backend/core/rag"
)

type CharacterEventHandler struct {
    vectorizationEngine *rag.VectorizationEngine
}

func (h *CharacterEventHandler) Handle(event events.Event) error {
    switch e := event.(type) {
    case *events.CharacterCreatedEvent:
        return h.handleCreated(e)
    case *events.CharacterUpdatedEvent:
        return h.handleUpdated(e)
    case *events.CharacterDeletedEvent:
        return h.handleDeleted(e)
    }
    return nil
}

func (h *CharacterEventHandler) handleCreated(event *events.CharacterCreatedEvent) error {
    // å‘é‡åŒ–è§’è‰²æ•°æ®
    return h.vectorizationEngine.VectorizeCharacter(
        context.Background(),
        event.CharacterID,
        event.ProjectID,
    )
}
```

---

## å››ã€æ€»ç»“

æœ¬æ–‡æ¡£è®¾è®¡äº†è§’è‰²å¡ç³»ç»Ÿçš„å®Œæ•´å®ç°ï¼š

- âœ… CharacterService æ¥å£å®šä¹‰
- âœ… CharacterServiceImpl å®ç°
- âœ… åŸºç¡€ CRUD æ“ä½œ
- âœ… AI ç”Ÿæˆè§’è‰²é›†æˆ
- âœ… è§’è‰²å…³ç³»ç®¡ç†
- âœ… äº‹ä»¶é©±åŠ¨å‘é‡åŒ–

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025-10-27
**ç»´æŠ¤è€…**: AIæ¶æ„ç»„
