# 时间线系统 Service/API 设计

> **文档版本**: v1.0
> **创建时间**: 2025-10-27
> **实施状态**: 设计阶段
> **负责人**: AI架构组

---

## 一、Service 接口定义

```go
// service/interfaces/timeline_service.go
package interfaces

type TimelineService interface {
    // Timeline CRUD
    CreateTimeline(ctx context.Context, projectID string, req *CreateTimelineRequest) (*writer.Timeline, error)
    GetTimeline(ctx context.Context, timelineID, projectID string) (*writer.Timeline, error)
    ListTimelines(ctx context.Context, projectID string) ([]*writer.Timeline, error)
    DeleteTimeline(ctx context.Context, timelineID, projectID string) error
    
    // Timeline Event CRUD
    CreateEvent(ctx context.Context, projectID string, req *CreateTimelineEventRequest) (*writer.TimelineEvent, error)
    GetEvent(ctx context.Context, eventID, projectID string) (*writer.TimelineEvent, error)
    ListEvents(ctx context.Context, timelineID string, options *ListOptions) ([]*writer.TimelineEvent, error)
    UpdateEvent(ctx context.Context, eventID, projectID string, req *UpdateTimelineEventRequest) (*writer.TimelineEvent, error)
    DeleteEvent(ctx context.Context, eventID, projectID string) error
    
    // AI 生成
    GenerateTimeline(ctx context.Context, projectID string, req *GenerateTimelineRequest) (*writer.Timeline, error)
    GenerateEvents(ctx context.Context, timelineID string, req *GenerateEventsRequest) ([]*writer.TimelineEvent, error)
    
    // 可视化数据
    GetTimelineVisualization(ctx context.Context, timelineID string) (*TimelineVisualization, error)
}

type CreateTimelineRequest struct {
    Name        string `json:"name" validate:"required"`
    Description string `json:"description"`
}

type CreateTimelineEventRequest struct {
    TimelineID   string                 `json:"timelineId" validate:"required"`
    Title        string                 `json:"title" validate:"required"`
    Description  string                 `json:"description"`
    EventType    string                 `json:"eventType"` // plot, character, milestone
    Importance   int                    `json:"importance"`
    Participants []string               `json:"participants"` // Character IDs
    StoryTime    map[string]interface{} `json:"storyTime"`
}

type GenerateEventsRequest struct {
    BaseOnOutline bool              `json:"baseOnOutline"`
    Characters    []string          `json:"characters"`
    EventCount    int               `json:"eventCount"`
    Constraints   map[string]string `json:"constraints"`
}

type TimelineVisualization struct {
    Events      []*TimelineEventNode `json:"events"`
    Connections []*EventConnection   `json:"connections"`
}

type TimelineEventNode struct {
    ID          string   `json:"id"`
    Title       string   `json:"title"`
    StoryTime   string   `json:"storyTime"`
    EventType   string   `json:"eventType"`
    Importance  int      `json:"importance"`
    Characters  []string `json:"characters"`
}

type EventConnection struct {
    FromEventID string `json:"fromEventId"`
    ToEventID   string `json:"toEventId"`
    Type        string `json:"type"` // sequential, causal, parallel
}
```

---

## 二、Service 实现

```go
// service/writer/timeline_service_impl.go
package writer

type TimelineServiceImpl struct {
    timelineRepo      interfaces.TimelineRepository
    timelineEventRepo interfaces.TimelineEventRepository
    characterRepo     interfaces.CharacterRepository
    eventBus          events.EventBus
    aiProxy           AIProxyService
}

func (s *TimelineServiceImpl) CreateTimeline(
    ctx context.Context,
    projectID string,
    req *CreateTimelineRequest,
) (*writer.Timeline, error) {
    timeline := &writer.Timeline{
        ProjectID:   projectID,
        Name:        req.Name,
        Description: req.Description,
        CreatedAt:   time.Now(),
        UpdatedAt:   time.Now(),
    }
    
    if err := s.timelineRepo.Create(ctx, timeline); err != nil {
        return nil, errors.NewDatabaseError("create timeline failed", err)
    }
    
    return timeline, nil
}

func (s *TimelineServiceImpl) CreateEvent(
    ctx context.Context,
    projectID string,
    req *CreateTimelineEventRequest,
) (*writer.TimelineEvent, error) {
    // 1. 验证 Timeline 存在
    timeline, err := s.timelineRepo.FindByID(ctx, req.TimelineID)
    if err != nil {
        return nil, errors.NewNotFoundError("timeline not found", err)
    }
    
    if timeline.ProjectID != projectID {
        return nil, errors.NewAuthError("no permission")
    }
    
    // 2. 验证参与角色存在
    for _, charID := range req.Participants {
        _, err := s.characterRepo.FindByID(ctx, charID)
        if err != nil {
            return nil, errors.NewNotFoundError(fmt.Sprintf("character %s not found", charID), err)
        }
    }
    
    // 3. 创建事件
    event := &writer.TimelineEvent{
        ProjectID:    projectID,
        TimelineID:   req.TimelineID,
        Title:        req.Title,
        Description:  req.Description,
        EventType:    req.EventType,
        Importance:   req.Importance,
        Participants: req.Participants,
        StoryTime:    req.StoryTime,
        CreatedAt:    time.Now(),
        UpdatedAt:    time.Now(),
    }
    
    if err := s.timelineEventRepo.Create(ctx, event); err != nil {
        return nil, errors.NewDatabaseError("create timeline event failed", err)
    }
    
    // 4. 发布事件
    s.eventBus.Publish(&events.TimelineEventCreatedEvent{
        EventID:   event.ID,
        ProjectID: projectID,
    })
    
    return event, nil
}

func (s *TimelineServiceImpl) GenerateEvents(
    ctx context.Context,
    timelineID string,
    req *GenerateEventsRequest,
) ([]*writer.TimelineEvent, error) {
    // 1. 获取上下文（大纲、角色）
    timeline, _ := s.timelineRepo.FindByID(ctx, timelineID)
    
    // 2. 调用 AI 生成事件
    aiReq := &AIAgentRequest{
        AgentType: "plot",
        Task:      "生成时间线事件",
        ProjectID: timeline.ProjectID,
        Parameters: map[string]string{
            "timelineId":  timelineID,
            "eventCount":  fmt.Sprintf("%d", req.EventCount),
            "baseOutline": fmt.Sprintf("%t", req.BaseOnOutline),
        },
    }
    
    aiResult, err := s.aiProxy.ExecuteAgent(ctx, aiReq)
    if err != nil {
        return nil, errors.NewExternalError("AI generation failed", err)
    }
    
    // 3. 解析并创建事件
    generatedEvents := parseAITimelineEvents(aiResult)
    
    var createdEvents []*writer.TimelineEvent
    for _, eventData := range generatedEvents {
        createReq := &CreateTimelineEventRequest{
            TimelineID:   timelineID,
            Title:        eventData.Title,
            Description:  eventData.Description,
            EventType:    eventData.EventType,
            Importance:   eventData.Importance,
            Participants: eventData.Participants,
            StoryTime:    eventData.StoryTime,
        }
        
        event, err := s.CreateEvent(ctx, timeline.ProjectID, createReq)
        if err == nil {
            createdEvents = append(createdEvents, event)
        }
    }
    
    return createdEvents, nil
}

func (s *TimelineServiceImpl) GetTimelineVisualization(
    ctx context.Context,
    timelineID string,
) (*TimelineVisualization, error) {
    // 1. 获取所有事件
    events, err := s.timelineEventRepo.FindByTimelineID(ctx, timelineID, nil)
    if err != nil {
        return nil, err
    }
    
    // 2. 构建可视化数据
    var nodes []*TimelineEventNode
    for _, event := range events {
        nodes = append(nodes, &TimelineEventNode{
            ID:         event.ID,
            Title:      event.Title,
            StoryTime:  formatStoryTime(event.StoryTime),
            EventType:  event.EventType,
            Importance: event.Importance,
            Characters: event.Participants,
        })
    }
    
    // 3. 分析事件连接（基于时间顺序、因果关系）
    connections := analyzeEventConnections(events)
    
    return &TimelineVisualization{
        Events:      nodes,
        Connections: connections,
    }, nil
}
```

---

## 三、事件驱动索引

```go
// service/events/handlers/timeline_event_handler.go
package handlers

type TimelineEventHandler struct {
    vectorizationEngine *rag.VectorizationEngine
}

func (h *TimelineEventHandler) Handle(event events.Event) error {
    switch e := event.(type) {
    case *events.TimelineEventCreatedEvent:
        return h.handleEventCreated(e)
    }
    return nil
}

func (h *TimelineEventHandler) handleEventCreated(event *events.TimelineEventCreatedEvent) error {
    return h.vectorizationEngine.VectorizeTimelineEvent(
        context.Background(),
        event.EventID,
        event.ProjectID,
    )
}
```

---

## 四、总结

本文档设计了时间线系统的完整实现：

- ✅ TimelineService 接口定义
- ✅ Timeline 和 TimelineEvent CRUD
- ✅ AI 生成时间线事件
- ✅ 时间线可视化数据
- ✅ 事件驱动向量化

---

**文档版本**: v1.0
**创建时间**: 2025-10-27
**维护者**: AI架构组
