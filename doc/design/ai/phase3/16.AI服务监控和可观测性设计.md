# AI 服务监控和可观测性设计

> **文档版本**: v1.0
> **创建时间**: 2025-10-27
> **实施状态**: 设计阶段
> **负责人**: AI架构组

---

## 一、Prometheus 指标设计

### 1.1 AI Agent 指标

```python
# src/core/monitoring/metrics.py
from prometheus_client import Counter, Histogram, Gauge, Info

# Agent 执行指标
agent_executions_total = Counter(
    'ai_agent_executions_total',
    'Total number of agent executions',
    ['agent_type', 'status']  # creative/outline/character, success/failure
)

agent_execution_duration_seconds = Histogram(
    'ai_agent_execution_duration_seconds',
    'Agent execution duration in seconds',
    ['agent_type'],
    buckets=[1, 5, 10, 30, 60, 120, 300]
)

# Token 使用统计
tokens_used_total = Counter(
    'ai_tokens_used_total',
    'Total tokens used',
    ['model', 'operation']  # gpt-4/gpt-3.5, generation/rag/analysis
)

tokens_cost_total = Counter(
    'ai_tokens_cost_total',
    'Total cost in USD',
    ['model']
)

# 工具调用统计
tool_calls_total = Counter(
    'ai_tool_calls_total',
    'Total number of tool calls',
    ['tool_name', 'status']
)

tool_call_duration_seconds = Histogram(
    'ai_tool_call_duration_seconds',
    'Tool call duration',
    ['tool_name'],
    buckets=[0.1, 0.5, 1, 2, 5, 10]
)

# RAG 检索指标
rag_searches_total = Counter(
    'ai_rag_searches_total',
    'Total RAG searches',
    ['project_id', 'content_type']
)

rag_search_duration_seconds = Histogram(
    'ai_rag_search_duration_seconds',
    'RAG search duration',
    buckets=[0.1, 0.5, 1, 2, 5]
)

rag_cache_hits_total = Counter(
    'ai_rag_cache_hits_total',
    'RAG cache hits',
    ['project_id']
)

rag_results_count = Histogram(
    'ai_rag_results_count',
    'Number of RAG results returned',
    buckets=[1, 3, 5, 10, 20]
)

# 向量化指标
vectorization_total = Counter(
    'ai_vectorization_total',
    'Total vectorizations',
    ['content_type', 'status']
)

vectorization_duration_seconds = Histogram(
    'ai_vectorization_duration_seconds',
    'Vectorization duration',
    ['content_type']
)

# 当前活跃指标
active_agent_executions = Gauge(
    'ai_active_agent_executions',
    'Currently active agent executions'
)

# 服务信息
ai_service_info = Info(
    'ai_service',
    'AI service information'
)
ai_service_info.info({
    'version': '1.0.0',
    'python_version': '3.11',
    'langchain_version': '0.1.0'
})
```

### 1.2 指标装饰器

```python
# src/core/monitoring/decorators.py
import time
from functools import wraps
from .metrics import (
    agent_executions_total,
    agent_execution_duration_seconds,
    active_agent_executions,
    tool_calls_total,
    tool_call_duration_seconds
)

def track_agent_execution(agent_type: str):
    """追踪 Agent 执行"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            active_agent_executions.inc()
            start_time = time.time()
            
            try:
                result = await func(*args, **kwargs)
                
                duration = time.time() - start_time
                agent_executions_total.labels(agent_type=agent_type, status='success').inc()
                agent_execution_duration_seconds.labels(agent_type=agent_type).observe(duration)
                
                return result
                
            except Exception as e:
                agent_executions_total.labels(agent_type=agent_type, status='failure').inc()
                raise
                
            finally:
                active_agent_executions.dec()
        
        return wrapper
    return decorator


def track_tool_call(tool_name: str):
    """追踪工具调用"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            start_time = time.time()
            
            try:
                result = await func(*args, **kwargs)
                
                duration = time.time() - start_time
                tool_calls_total.labels(tool_name=tool_name, status='success').inc()
                tool_call_duration_seconds.labels(tool_name=tool_name).observe(duration)
                
                return result
                
            except Exception as e:
                tool_calls_total.labels(tool_name=tool_name, status='failure').inc()
                raise
        
        return wrapper
    return decorator


# 使用示例
@track_agent_execution("creative")
async def creative_agent_node(state: CreativeAgentState) -> CreativeAgentState:
    # ... Agent 逻辑
    pass
```

---

## 二、日志规范

### 2.1 结构化日志

```python
# src/utils/logging.py
import logging
import json
from typing import Any, Dict

class StructuredLogger:
    """结构化日志"""
    
    def __init__(self, name: str):
        self.logger = logging.getLogger(name)
        self.logger.setLevel(logging.INFO)
        
        # JSON 格式输出
        handler = logging.StreamHandler()
        handler.setFormatter(JsonFormatter())
        self.logger.addHandler(handler)
    
    def info(self, message: str, **kwargs):
        """Info 日志"""
        self.logger.info(message, extra={"fields": kwargs})
    
    def error(self, message: str, **kwargs):
        """Error 日志"""
        self.logger.error(message, extra={"fields": kwargs}, exc_info=True)
    
    def warning(self, message: str, **kwargs):
        """Warning 日志"""
        self.logger.warning(message, extra={"fields": kwargs})


class JsonFormatter(logging.Formatter):
    """JSON 格式化器"""
    
    def format(self, record: logging.LogRecord) -> str:
        log_data = {
            "timestamp": self.formatTime(record, self.datefmt),
            "level": record.levelname,
            "logger": record.name,
            "message": record.getMessage(),
            "module": record.module,
            "function": record.funcName,
            "line": record.lineno,
        }
        
        # 添加额外字段
        if hasattr(record, 'fields'):
            log_data.update(record.fields)
        
        # 添加异常信息
        if record.exc_info:
            log_data["exception"] = self.formatException(record.exc_info)
        
        return json.dumps(log_data)


# 全局日志实例
def get_logger(name: str) -> StructuredLogger:
    return StructuredLogger(name)
```

### 2.2 日志使用示例

```python
# 使用日志
from utils.logging import get_logger

logger = get_logger(__name__)

# Info 日志
logger.info(
    "Agent execution started",
    agent_type="creative",
    user_id="user-123",
    project_id="proj-456",
    trace_id="trace-789"
)

# Error 日志
logger.error(
    "Tool call failed",
    tool_name="character_tool",
    error_type="connection_error",
    user_id="user-123"
)
```

---

## 三、调用链追踪

### 3.1 Trace ID 传递

```python
# src/core/tracing/context.py
import contextvars
import uuid

# 上下文变量
trace_id_var = contextvars.ContextVar('trace_id', default=None)
user_id_var = contextvars.ContextVar('user_id', default=None)

def get_trace_id() -> str:
    """获取 Trace ID"""
    trace_id = trace_id_var.get()
    if not trace_id:
        trace_id = str(uuid.uuid4())
        trace_id_var.set(trace_id)
    return trace_id

def set_trace_id(trace_id: str):
    """设置 Trace ID"""
    trace_id_var.set(trace_id)

def get_user_id() -> str:
    """获取 User ID"""
    return user_id_var.get()

def set_user_id(user_id: str):
    """设置 User ID"""
    user_id_var.set(user_id)
```

### 3.2 FastAPI 中间件

```python
# src/api/middleware/tracing.py
from fastapi import Request
from core.tracing.context import set_trace_id, set_user_id

async def tracing_middleware(request: Request, call_next):
    """追踪中间件"""
    # 从 Header 获取或生成 Trace ID
    trace_id = request.headers.get('X-Trace-ID') or str(uuid.uuid4())
    set_trace_id(trace_id)
    
    # 获取 User ID（如果已认证）
    user_id = request.headers.get('X-User-ID')
    if user_id:
        set_user_id(user_id)
    
    # 添加到响应头
    response = await call_next(request)
    response.headers['X-Trace-ID'] = trace_id
    
    return response
```

---

## 四、告警配置

### 4.1 Prometheus 告警规则

```yaml
# docker/prometheus/alerts.yml
groups:
  - name: ai_service_alerts
    interval: 30s
    rules:
      # Agent 执行失败率过高
      - alert: HighAgentFailureRate
        expr: |
          rate(ai_agent_executions_total{status="failure"}[5m]) 
          / 
          rate(ai_agent_executions_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High agent failure rate"
          description: "Agent {{ $labels.agent_type }} failure rate is {{ $value | humanizePercentage }}"
      
      # Agent 执行时间过长
      - alert: SlowAgentExecution
        expr: |
          histogram_quantile(0.95, rate(ai_agent_execution_duration_seconds_bucket[5m])) > 60
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Slow agent execution"
          description: "95th percentile of {{ $labels.agent_type }} execution is {{ $value }}s"
      
      # Token 使用量异常
      - alert: HighTokenUsage
        expr: |
          rate(ai_tokens_used_total[1h]) > 100000
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "High token usage"
          description: "Token usage is {{ $value }} tokens/hour"
      
      # RAG 缓存命中率低
      - alert: LowRAGCacheHitRate
        expr: |
          rate(ai_rag_cache_hits_total[5m]) 
          / 
          rate(ai_rag_searches_total[5m]) < 0.3
        for: 10m
        labels:
          severity: info
        annotations:
          summary: "Low RAG cache hit rate"
          description: "Cache hit rate is {{ $value | humanizePercentage }}"
      
      # 服务不可用
      - alert: AIServiceDown
        expr: up{job="python-ai"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "AI Service is down"
          description: "AI Service has been down for more than 1 minute"
```

---

## 五、Grafana 仪表盘

### 5.1 仪表盘配置

```json
{
  "dashboard": {
    "title": "AI Service Monitoring",
    "panels": [
      {
        "title": "Agent Executions",
        "targets": [
          {
            "expr": "rate(ai_agent_executions_total[5m])",
            "legendFormat": "{{agent_type}} - {{status}}"
          }
        ]
      },
      {
        "title": "Agent Execution Duration (p95)",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(ai_agent_execution_duration_seconds_bucket[5m]))",
            "legendFormat": "{{agent_type}}"
          }
        ]
      },
      {
        "title": "Token Usage",
        "targets": [
          {
            "expr": "rate(ai_tokens_used_total[1h])",
            "legendFormat": "{{model}} - {{operation}}"
          }
        ]
      },
      {
        "title": "RAG Performance",
        "targets": [
          {
            "expr": "rate(ai_rag_searches_total[5m])",
            "legendFormat": "Searches"
          },
          {
            "expr": "rate(ai_rag_cache_hits_total[5m])",
            "legendFormat": "Cache Hits"
          }
        ]
      },
      {
        "title": "Tool Calls",
        "targets": [
          {
            "expr": "rate(ai_tool_calls_total[5m])",
            "legendFormat": "{{tool_name}} - {{status}}"
          }
        ]
      }
    ]
  }
}
```

---

## 六、性能监控

### 6.1 Go Backend 监控

```go
// middleware/prometheus_middleware.go
package middleware

import (
    "github.com/gin-gonic/gin"
    "github.com/prometheus/client_golang/prometheus"
)

var (
    httpRequestsTotal = prometheus.NewCounterVec(
        prometheus.CounterOpts{
            Name: "http_requests_total",
            Help: "Total HTTP requests",
        },
        []string{"method", "endpoint", "status"},
    )
    
    httpRequestDuration = prometheus.NewHistogramVec(
        prometheus.HistogramOpts{
            Name:    "http_request_duration_seconds",
            Help:    "HTTP request duration",
            Buckets: []float64{0.01, 0.05, 0.1, 0.5, 1, 2, 5},
        },
        []string{"method", "endpoint"},
    )
    
    aiProxyRequests = prometheus.NewCounterVec(
        prometheus.CounterOpts{
            Name: "ai_proxy_requests_total",
            Help: "Total AI proxy requests",
        },
        []string{"operation", "status"},
    )
)

func PrometheusMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        start := time.Now()
        
        c.Next()
        
        duration := time.Since(start).Seconds()
        
        httpRequestsTotal.WithLabelValues(
            c.Request.Method,
            c.FullPath(),
            strconv.Itoa(c.Writer.Status()),
        ).Inc()
        
        httpRequestDuration.WithLabelValues(
            c.Request.Method,
            c.FullPath(),
        ).Observe(duration)
    }
}
```

---

## 七、总结

本文档设计了完整的监控和可观测性方案：

**Prometheus 指标**：
- ✅ Agent 执行指标（次数、时长、状态）
- ✅ Token 使用统计
- ✅ 工具调用统计
- ✅ RAG 检索性能
- ✅ 向量化指标

**日志系统**：
- ✅ 结构化日志（JSON 格式）
- ✅ 调用链追踪（Trace ID）
- ✅ 统一日志格式

**告警**：
- ✅ Agent 失败率告警
- ✅ 执行时间告警
- ✅ Token 使用告警
- ✅ 服务可用性告警

**可视化**：
- ✅ Grafana 仪表盘
- ✅ 实时监控图表

---

**文档版本**: v1.0
**创建时间**: 2025-10-27
**维护者**: AI架构组
