# AI 增强字段和数据模型设计

> **文档版本**: v1.0
> **创建时间**: 2025-10-27
> **实施状态**: 设计阶段
> **负责人**: AI架构组

---

## 📋 文档概述

本文档设计现有数据模型的 AI 增强字段扩展和新增的 AI 相关数据模型。

---

## 一、现有模型扩展

### 1.1 Character 模型扩展

```go
// models/writer/character.go - 扩展字段
type Character struct {
    // ... 现有字段 ...
    
    // ===== AI 增强字段 =====
    
    // AI 生成相关
    AIGenerated         bool                   `bson:"ai_generated" json:"aiGenerated"`                   // 是否由 AI 生成
    GenerationPrompt    string                 `bson:"generation_prompt,omitempty" json:"generationPrompt,omitempty"` // 生成提示词
    GenerationMetadata  map[string]interface{} `bson:"generation_metadata,omitempty" json:"generationMetadata,omitempty"` // 生成元数据
    
    // AI 分析结果
    PersonalityAnalysis string                 `bson:"personality_analysis,omitempty" json:"personalityAnalysis,omitempty"` // 性格分析
    ArchetypeType       string                 `bson:"archetype_type,omitempty" json:"archetypeType,omitempty"`            // 人物原型
    
    // AI 建议
    AISuggestions       []string               `bson:"ai_suggestions,omitempty" json:"aiSuggestions,omitempty"`             // AI 建议
    
    // 向量化
    EmbeddingVector     []float32              `bson:"embedding_vector,omitempty" json:"-"`                                 // 向量（不返回前端）
    EmbeddingModel      string                 `bson:"embedding_model,omitempty" json:"-"`                                  // 向量模型
    LastVectorizedAt    *time.Time             `bson:"last_vectorized_at,omitempty" json:"-"`                               // 最后向量化时间
}
```

### 1.2 Node（大纲）模型扩展

```go
// models/writer/node.go - 扩展字段
type Node struct {
    // ... 现有字段 ...
    
    // ===== AI 增强字段 =====
    
    // AI 生成
    AIGenerated        bool                   `bson:"ai_generated" json:"aiGenerated"`
    GenerationPrompt   string                 `bson:"generation_prompt,omitempty" json:"generationPrompt,omitempty"`
    
    // AI 总结和分析
    AISummary          string                 `bson:"ai_summary,omitempty" json:"aiSummary,omitempty"`                    // AI 生成的摘要
    KeyPlotPoints      []string               `bson:"key_plot_points,omitempty" json:"keyPlotPoints,omitempty"`           // 关键情节点
    
    // AI 建议
    AISuggestions      []AISuggestion         `bson:"ai_suggestions,omitempty" json:"aiSuggestions,omitempty"`
    
    // 向量化
    EmbeddingVector    []float32              `bson:"embedding_vector,omitempty" json:"-"`
    LastVectorizedAt   *time.Time             `bson:"last_vectorized_at,omitempty" json:"-"`
}

type AISuggestion struct {
    Type        string    `bson:"type" json:"type"`                 // plot, character, pacing
    Suggestion  string    `bson:"suggestion" json:"suggestion"`
    Confidence  float32   `bson:"confidence" json:"confidence"`     // 0-1
    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`
}
```

### 1.3 Timeline 模型扩展

```go
// models/writer/timeline.go - 扩展字段
type Timeline struct {
    // ... 现有字段 ...
    
    // ===== AI 增强字段 =====
    AIGenerated      bool       `bson:"ai_generated" json:"aiGenerated"`
    AISuggestedEvents []string  `bson:"ai_suggested_events,omitempty" json:"aiSuggestedEvents,omitempty"` // AI 建议的事件 ID
}

type TimelineEvent struct {
    // ... 现有字段 ...
    
    // ===== AI 增强字段 =====
    AIGenerated      bool                   `bson:"ai_generated" json:"aiGenerated"`
    GenerationPrompt string                 `bson:"generation_prompt,omitempty" json:"generationPrompt,omitempty"`
    
    // AI 分析
    ConflictAnalysis string                 `bson:"conflict_analysis,omitempty" json:"conflictAnalysis,omitempty"`
    ImpactScore      float32                `bson:"impact_score,omitempty" json:"impactScore,omitempty"` // 0-10
    
    // 向量化
    EmbeddingVector  []float32              `bson:"embedding_vector,omitempty" json:"-"`
}
```

---

## 二、新增模型

### 2.1 WorldSetting（世界观设定）

```go
// models/writer/world_setting.go
package writer

import "time"

type WorldSetting struct {
    ID          string                 `bson:"_id,omitempty" json:"id"`
    ProjectID   string                 `bson:"project_id" json:"projectId"`
    
    // 基本信息
    Name        string                 `bson:"name" json:"name"`
    Category    string                 `bson:"category" json:"category"` // world, magic, technology, social, history
    Description string                 `bson:"description" json:"description"`
    
    // 详细设定
    Details     map[string]interface{} `bson:"details,omitempty" json:"details,omitempty"`
    Tags        []string               `bson:"tags,omitempty" json:"tags,omitempty"`
    
    // 关联
    RelatedCharacters []string          `bson:"related_characters,omitempty" json:"relatedCharacters,omitempty"`
    RelatedLocations  []string          `bson:"related_locations,omitempty" json:"relatedLocations,omitempty"`
    
    // AI 增强
    AIGenerated       bool              `bson:"ai_generated" json:"aiGenerated"`
    GenerationPrompt  string            `bson:"generation_prompt,omitempty" json:"generationPrompt,omitempty"`
    AISuggestions     []string          `bson:"ai_suggestions,omitempty" json:"aiSuggestions,omitempty"`
    
    // 向量化
    EmbeddingVector   []float32         `bson:"embedding_vector,omitempty" json:"-"`
    
    // 元数据
    CreatedAt   time.Time              `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time              `bson:"updated_at" json:"updatedAt"`
}
```

### 2.2 Location（地点）

```go
// models/writer/location.go
package writer

import "time"

type Location struct {
    ID          string    `bson:"_id,omitempty" json:"id"`
    ProjectID   string    `bson:"project_id" json:"projectId"`
    
    // 基本信息
    Name        string    `bson:"name" json:"name"`
    Type        string    `bson:"type" json:"type"` // city, building, natural, magical
    Description string    `bson:"description" json:"description"`
    
    // 地理信息
    ParentLocationID *string               `bson:"parent_location_id,omitempty" json:"parentLocationId,omitempty"`
    Coordinates      *GeographicCoordinates `bson:"coordinates,omitempty" json:"coordinates,omitempty"`
    MapData          map[string]interface{} `bson:"map_data,omitempty" json:"mapData,omitempty"`
    
    // 特性
    Features    []string               `bson:"features,omitempty" json:"features,omitempty"`
    Climate     string                 `bson:"climate,omitempty" json:"climate,omitempty"`
    Population  int                    `bson:"population,omitempty" json:"population,omitempty"`
    
    // 关联
    RelatedCharacters []string          `bson:"related_characters,omitempty" json:"relatedCharacters,omitempty"`
    RelatedEvents     []string          `bson:"related_events,omitempty" json:"relatedEvents,omitempty"`
    
    // AI 增强
    AIGenerated       bool              `bson:"ai_generated" json:"aiGenerated"`
    EmbeddingVector   []float32         `bson:"embedding_vector,omitempty" json:"-"`
    
    CreatedAt   time.Time              `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time              `bson:"updated_at" json:"updatedAt"`
}

type GeographicCoordinates struct {
    X float64 `bson:"x" json:"x"`
    Y float64 `bson:"y" json:"y"`
}
```

### 2.3 Item（道具/物品）

```go
// models/writer/item.go
package writer

import "time"

type Item struct {
    ID          string    `bson:"_id,omitempty" json:"id"`
    ProjectID   string    `bson:"project_id" json:"projectId"`
    
    // 基本信息
    Name        string    `bson:"name" json:"name"`
    Type        string    `bson:"type" json:"type"` // weapon, artifact, consumable, quest_item
    Description string    `bson:"description" json:"description"`
    
    // 属性
    Rarity      string                 `bson:"rarity,omitempty" json:"rarity,omitempty"` // common, rare, epic, legendary
    Properties  map[string]interface{} `bson:"properties,omitempty" json:"properties,omitempty"`
    
    // 历史和来源
    Origin      string                 `bson:"origin,omitempty" json:"origin,omitempty"`
    History     string                 `bson:"history,omitempty" json:"history,omitempty"`
    
    // 关联
    CurrentOwner *string               `bson:"current_owner,omitempty" json:"currentOwner,omitempty"` // Character ID
    RelatedEvents []string             `bson:"related_events,omitempty" json:"relatedEvents,omitempty"`
    
    // AI 增强
    AIGenerated  bool                  `bson:"ai_generated" json:"aiGenerated"`
    EmbeddingVector []float32          `bson:"embedding_vector,omitempty" json:"-"`
    
    CreatedAt   time.Time              `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time              `bson:"updated_at" json:"updatedAt"`
}
```

### 2.4 AIGenerationTask（AI 生成任务）

```go
// models/ai/generation_task.go
package ai

import "time"

type AIGenerationTask struct {
    ID        string    `bson:"_id,omitempty" json:"id"`
    UserID    string    `bson:"user_id" json:"userId"`
    ProjectID string    `bson:"project_id" json:"projectId"`
    
    // 任务信息
    TaskType   string                 `bson:"task_type" json:"taskType"` // outline, character, plot, content
    Prompt     string                 `bson:"prompt" json:"prompt"`
    Parameters map[string]interface{} `bson:"parameters,omitempty" json:"parameters,omitempty"`
    
    // 状态
    Status      string    `bson:"status" json:"status"` // pending, running, completed, failed
    Progress    int       `bson:"progress" json:"progress"` // 0-100
    
    // 结果
    Result      map[string]interface{} `bson:"result,omitempty" json:"result,omitempty"`
    Error       string                 `bson:"error,omitempty" json:"error,omitempty"`
    
    // 性能指标
    TokensUsed  int       `bson:"tokens_used,omitempty" json:"tokensUsed,omitempty"`
    Duration    int       `bson:"duration,omitempty" json:"duration,omitempty"` // 毫秒
    
    // 元数据
    AgentWorkflowID string    `bson:"agent_workflow_id,omitempty" json:"agentWorkflowId,omitempty"`
    
    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time `bson:"updated_at" json:"updatedAt"`
    CompletedAt *time.Time `bson:"completed_at,omitempty" json:"completedAt,omitempty"`
}
```

### 2.5 VectorDocument（向量文档）

```go
// models/ai/vector_document.go
package ai

import "time"

type VectorDocument struct {
    ID          string    `bson:"_id,omitempty" json:"id"`
    ProjectID   string    `bson:"project_id" json:"projectId"`
    UserID      string    `bson:"user_id" json:"userId"`
    
    // 内容
    ContentType string    `bson:"content_type" json:"contentType"` // character, outline, timeline, setting
    ContentID   string    `bson:"content_id" json:"contentId"`     // 源数据 ID
    ChunkText   string    `bson:"chunk_text" json:"chunkText"`     // 分块文本
    ChunkIndex  int       `bson:"chunk_index" json:"chunkIndex"`
    
    // 向量
    EmbeddingVector []float32 `bson:"embedding_vector" json:"-"` // 存储在 Milvus
    VectorID        int64     `bson:"vector_id,omitempty" json:"vectorId,omitempty"` // Milvus 向量 ID
    
    // 元数据
    Metadata    map[string]interface{} `bson:"metadata,omitempty" json:"metadata,omitempty"`
    
    // 状态
    Indexed     bool      `bson:"indexed" json:"indexed"`
    
    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time `bson:"updated_at" json:"updatedAt"`
}
```

---

## 三、MongoDB 索引设计

### 3.1 Character 索引

```javascript
// 创建索引
db.characters.createIndex({ "project_id": 1, "ai_generated": 1 });
db.characters.createIndex({ "project_id": 1, "last_vectorized_at": 1 });
db.characters.createIndex({ "archetype_type": 1 });
```

### 3.2 WorldSetting 索引

```javascript
db.world_settings.createIndex({ "project_id": 1, "category": 1 });
db.world_settings.createIndex({ "tags": 1 });
db.world_settings.createIndex({ "project_id": 1, "ai_generated": 1 });
```

### 3.3 VectorDocument 索引

```javascript
db.vector_documents.createIndex({ "project_id": 1, "content_type": 1 });
db.vector_documents.createIndex({ "content_id": 1 });
db.vector_documents.createIndex({ "indexed": 1 });
```

### 3.4 AIGenerationTask 索引

```javascript
db.ai_generation_tasks.createIndex({ "user_id": 1, "status": 1 });
db.ai_generation_tasks.createIndex({ "project_id": 1, "task_type": 1 });
db.ai_generation_tasks.createIndex({ "created_at": -1 });
```

---

## 四、数据迁移策略

### 4.1 迁移脚本

```go
// migration/add_ai_fields.go
package migration

import (
    "context"
    "go.mongodb.org/mongo-driver/bson"
    "go.mongodb.org/mongo-driver/mongo"
)

func AddAIFields(db *mongo.Database) error {
    ctx := context.Background()
    
    // 1. 为现有 Character 添加 AI 字段
    _, err := db.Collection("characters").UpdateMany(
        ctx,
        bson.M{},
        bson.M{
            "$set": bson.M{
                "ai_generated": false,
                "ai_suggestions": []string{},
            },
        },
    )
    if err != nil {
        return err
    }
    
    // 2. 为现有 Node 添加 AI 字段
    _, err = db.Collection("nodes").UpdateMany(
        ctx,
        bson.M{},
        bson.M{
            "$set": bson.M{
                "ai_generated": false,
                "ai_suggestions": []interface{}{},
            },
        },
    )
    
    return err
}
```

---

## 五、总结

本文档设计了 AI 增强的数据模型：

**现有模型扩展**：
- ✅ Character: AI 生成标识、生成元数据、性格分析、向量
- ✅ Node: AI 摘要、关键情节点、建议、向量
- ✅ Timeline/TimelineEvent: AI 生成、冲突分析、向量

**新增模型**：
- ✅ WorldSetting: 世界观设定
- ✅ Location: 地点管理
- ✅ Item: 道具/物品
- ✅ AIGenerationTask: AI 生成任务追踪
- ✅ VectorDocument: 向量文档

**索引设计**：
- ✅ 完整的索引策略

---

**文档版本**: v1.0
**创建时间**: 2025-10-27
**维护者**: AI架构组
