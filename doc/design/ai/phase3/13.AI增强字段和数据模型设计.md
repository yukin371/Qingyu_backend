# AI å¢å¼ºå­—æ®µå’Œæ•°æ®æ¨¡å‹è®¾è®¡

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **åˆ›å»ºæ—¶é—´**: 2025-10-27
> **å®æ–½çŠ¶æ€**: è®¾è®¡é˜¶æ®µ
> **è´Ÿè´£äºº**: AIæ¶æ„ç»„

---

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è®¾è®¡ç°æœ‰æ•°æ®æ¨¡å‹çš„ AI å¢å¼ºå­—æ®µæ‰©å±•å’Œæ–°å¢çš„ AI ç›¸å…³æ•°æ®æ¨¡å‹ã€‚

---

## ä¸€ã€ç°æœ‰æ¨¡å‹æ‰©å±•

### 1.1 Character æ¨¡å‹æ‰©å±•

```go
// models/writer/character.go - æ‰©å±•å­—æ®µ
type Character struct {
    // ... ç°æœ‰å­—æ®µ ...
    
    // ===== AI å¢å¼ºå­—æ®µ =====
    
    // AI ç”Ÿæˆç›¸å…³
    AIGenerated         bool                   `bson:"ai_generated" json:"aiGenerated"`                   // æ˜¯å¦ç”± AI ç”Ÿæˆ
    GenerationPrompt    string                 `bson:"generation_prompt,omitempty" json:"generationPrompt,omitempty"` // ç”Ÿæˆæç¤ºè¯
    GenerationMetadata  map[string]interface{} `bson:"generation_metadata,omitempty" json:"generationMetadata,omitempty"` // ç”Ÿæˆå…ƒæ•°æ®
    
    // AI åˆ†æç»“æœ
    PersonalityAnalysis string                 `bson:"personality_analysis,omitempty" json:"personalityAnalysis,omitempty"` // æ€§æ ¼åˆ†æ
    ArchetypeType       string                 `bson:"archetype_type,omitempty" json:"archetypeType,omitempty"`            // äººç‰©åŸå‹
    
    // AI å»ºè®®
    AISuggestions       []string               `bson:"ai_suggestions,omitempty" json:"aiSuggestions,omitempty"`             // AI å»ºè®®
    
    // å‘é‡åŒ–
    EmbeddingVector     []float32              `bson:"embedding_vector,omitempty" json:"-"`                                 // å‘é‡ï¼ˆä¸è¿”å›å‰ç«¯ï¼‰
    EmbeddingModel      string                 `bson:"embedding_model,omitempty" json:"-"`                                  // å‘é‡æ¨¡å‹
    LastVectorizedAt    *time.Time             `bson:"last_vectorized_at,omitempty" json:"-"`                               // æœ€åå‘é‡åŒ–æ—¶é—´
}
```

### 1.2 Nodeï¼ˆå¤§çº²ï¼‰æ¨¡å‹æ‰©å±•

```go
// models/writer/node.go - æ‰©å±•å­—æ®µ
type Node struct {
    // ... ç°æœ‰å­—æ®µ ...
    
    // ===== AI å¢å¼ºå­—æ®µ =====
    
    // AI ç”Ÿæˆ
    AIGenerated        bool                   `bson:"ai_generated" json:"aiGenerated"`
    GenerationPrompt   string                 `bson:"generation_prompt,omitempty" json:"generationPrompt,omitempty"`
    
    // AI æ€»ç»“å’Œåˆ†æ
    AISummary          string                 `bson:"ai_summary,omitempty" json:"aiSummary,omitempty"`                    // AI ç”Ÿæˆçš„æ‘˜è¦
    KeyPlotPoints      []string               `bson:"key_plot_points,omitempty" json:"keyPlotPoints,omitempty"`           // å…³é”®æƒ…èŠ‚ç‚¹
    
    // AI å»ºè®®
    AISuggestions      []AISuggestion         `bson:"ai_suggestions,omitempty" json:"aiSuggestions,omitempty"`
    
    // å‘é‡åŒ–
    EmbeddingVector    []float32              `bson:"embedding_vector,omitempty" json:"-"`
    LastVectorizedAt   *time.Time             `bson:"last_vectorized_at,omitempty" json:"-"`
}

type AISuggestion struct {
    Type        string    `bson:"type" json:"type"`                 // plot, character, pacing
    Suggestion  string    `bson:"suggestion" json:"suggestion"`
    Confidence  float32   `bson:"confidence" json:"confidence"`     // 0-1
    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`
}
```

### 1.3 Timeline æ¨¡å‹æ‰©å±•

```go
// models/writer/timeline.go - æ‰©å±•å­—æ®µ
type Timeline struct {
    // ... ç°æœ‰å­—æ®µ ...
    
    // ===== AI å¢å¼ºå­—æ®µ =====
    AIGenerated      bool       `bson:"ai_generated" json:"aiGenerated"`
    AISuggestedEvents []string  `bson:"ai_suggested_events,omitempty" json:"aiSuggestedEvents,omitempty"` // AI å»ºè®®çš„äº‹ä»¶ ID
}

type TimelineEvent struct {
    // ... ç°æœ‰å­—æ®µ ...
    
    // ===== AI å¢å¼ºå­—æ®µ =====
    AIGenerated      bool                   `bson:"ai_generated" json:"aiGenerated"`
    GenerationPrompt string                 `bson:"generation_prompt,omitempty" json:"generationPrompt,omitempty"`
    
    // AI åˆ†æ
    ConflictAnalysis string                 `bson:"conflict_analysis,omitempty" json:"conflictAnalysis,omitempty"`
    ImpactScore      float32                `bson:"impact_score,omitempty" json:"impactScore,omitempty"` // 0-10
    
    // å‘é‡åŒ–
    EmbeddingVector  []float32              `bson:"embedding_vector,omitempty" json:"-"`
}
```

---

## äºŒã€æ–°å¢æ¨¡å‹

### 2.1 WorldSettingï¼ˆä¸–ç•Œè§‚è®¾å®šï¼‰

```go
// models/writer/world_setting.go
package writer

import "time"

type WorldSetting struct {
    ID          string                 `bson:"_id,omitempty" json:"id"`
    ProjectID   string                 `bson:"project_id" json:"projectId"`
    
    // åŸºæœ¬ä¿¡æ¯
    Name        string                 `bson:"name" json:"name"`
    Category    string                 `bson:"category" json:"category"` // world, magic, technology, social, history
    Description string                 `bson:"description" json:"description"`
    
    // è¯¦ç»†è®¾å®š
    Details     map[string]interface{} `bson:"details,omitempty" json:"details,omitempty"`
    Tags        []string               `bson:"tags,omitempty" json:"tags,omitempty"`
    
    // å…³è”
    RelatedCharacters []string          `bson:"related_characters,omitempty" json:"relatedCharacters,omitempty"`
    RelatedLocations  []string          `bson:"related_locations,omitempty" json:"relatedLocations,omitempty"`
    
    // AI å¢å¼º
    AIGenerated       bool              `bson:"ai_generated" json:"aiGenerated"`
    GenerationPrompt  string            `bson:"generation_prompt,omitempty" json:"generationPrompt,omitempty"`
    AISuggestions     []string          `bson:"ai_suggestions,omitempty" json:"aiSuggestions,omitempty"`
    
    // å‘é‡åŒ–
    EmbeddingVector   []float32         `bson:"embedding_vector,omitempty" json:"-"`
    
    // å…ƒæ•°æ®
    CreatedAt   time.Time              `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time              `bson:"updated_at" json:"updatedAt"`
}
```

### 2.2 Locationï¼ˆåœ°ç‚¹ï¼‰

```go
// models/writer/location.go
package writer

import "time"

type Location struct {
    ID          string    `bson:"_id,omitempty" json:"id"`
    ProjectID   string    `bson:"project_id" json:"projectId"`
    
    // åŸºæœ¬ä¿¡æ¯
    Name        string    `bson:"name" json:"name"`
    Type        string    `bson:"type" json:"type"` // city, building, natural, magical
    Description string    `bson:"description" json:"description"`
    
    // åœ°ç†ä¿¡æ¯
    ParentLocationID *string               `bson:"parent_location_id,omitempty" json:"parentLocationId,omitempty"`
    Coordinates      *GeographicCoordinates `bson:"coordinates,omitempty" json:"coordinates,omitempty"`
    MapData          map[string]interface{} `bson:"map_data,omitempty" json:"mapData,omitempty"`
    
    // ç‰¹æ€§
    Features    []string               `bson:"features,omitempty" json:"features,omitempty"`
    Climate     string                 `bson:"climate,omitempty" json:"climate,omitempty"`
    Population  int                    `bson:"population,omitempty" json:"population,omitempty"`
    
    // å…³è”
    RelatedCharacters []string          `bson:"related_characters,omitempty" json:"relatedCharacters,omitempty"`
    RelatedEvents     []string          `bson:"related_events,omitempty" json:"relatedEvents,omitempty"`
    
    // AI å¢å¼º
    AIGenerated       bool              `bson:"ai_generated" json:"aiGenerated"`
    EmbeddingVector   []float32         `bson:"embedding_vector,omitempty" json:"-"`
    
    CreatedAt   time.Time              `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time              `bson:"updated_at" json:"updatedAt"`
}

type GeographicCoordinates struct {
    X float64 `bson:"x" json:"x"`
    Y float64 `bson:"y" json:"y"`
}
```

### 2.3 Itemï¼ˆé“å…·/ç‰©å“ï¼‰

```go
// models/writer/item.go
package writer

import "time"

type Item struct {
    ID          string    `bson:"_id,omitempty" json:"id"`
    ProjectID   string    `bson:"project_id" json:"projectId"`
    
    // åŸºæœ¬ä¿¡æ¯
    Name        string    `bson:"name" json:"name"`
    Type        string    `bson:"type" json:"type"` // weapon, artifact, consumable, quest_item
    Description string    `bson:"description" json:"description"`
    
    // å±æ€§
    Rarity      string                 `bson:"rarity,omitempty" json:"rarity,omitempty"` // common, rare, epic, legendary
    Properties  map[string]interface{} `bson:"properties,omitempty" json:"properties,omitempty"`
    
    // å†å²å’Œæ¥æº
    Origin      string                 `bson:"origin,omitempty" json:"origin,omitempty"`
    History     string                 `bson:"history,omitempty" json:"history,omitempty"`
    
    // å…³è”
    CurrentOwner *string               `bson:"current_owner,omitempty" json:"currentOwner,omitempty"` // Character ID
    RelatedEvents []string             `bson:"related_events,omitempty" json:"relatedEvents,omitempty"`
    
    // AI å¢å¼º
    AIGenerated  bool                  `bson:"ai_generated" json:"aiGenerated"`
    EmbeddingVector []float32          `bson:"embedding_vector,omitempty" json:"-"`
    
    CreatedAt   time.Time              `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time              `bson:"updated_at" json:"updatedAt"`
}
```

### 2.4 AIGenerationTaskï¼ˆAI ç”Ÿæˆä»»åŠ¡ï¼‰

```go
// models/ai/generation_task.go
package ai

import "time"

type AIGenerationTask struct {
    ID        string    `bson:"_id,omitempty" json:"id"`
    UserID    string    `bson:"user_id" json:"userId"`
    ProjectID string    `bson:"project_id" json:"projectId"`
    
    // ä»»åŠ¡ä¿¡æ¯
    TaskType   string                 `bson:"task_type" json:"taskType"` // outline, character, plot, content
    Prompt     string                 `bson:"prompt" json:"prompt"`
    Parameters map[string]interface{} `bson:"parameters,omitempty" json:"parameters,omitempty"`
    
    // çŠ¶æ€
    Status      string    `bson:"status" json:"status"` // pending, running, completed, failed
    Progress    int       `bson:"progress" json:"progress"` // 0-100
    
    // ç»“æœ
    Result      map[string]interface{} `bson:"result,omitempty" json:"result,omitempty"`
    Error       string                 `bson:"error,omitempty" json:"error,omitempty"`
    
    // æ€§èƒ½æŒ‡æ ‡
    TokensUsed  int       `bson:"tokens_used,omitempty" json:"tokensUsed,omitempty"`
    Duration    int       `bson:"duration,omitempty" json:"duration,omitempty"` // æ¯«ç§’
    
    // å…ƒæ•°æ®
    AgentWorkflowID string    `bson:"agent_workflow_id,omitempty" json:"agentWorkflowId,omitempty"`
    
    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time `bson:"updated_at" json:"updatedAt"`
    CompletedAt *time.Time `bson:"completed_at,omitempty" json:"completedAt,omitempty"`
}
```

### 2.5 VectorDocumentï¼ˆå‘é‡æ–‡æ¡£ï¼‰

```go
// models/ai/vector_document.go
package ai

import "time"

type VectorDocument struct {
    ID          string    `bson:"_id,omitempty" json:"id"`
    ProjectID   string    `bson:"project_id" json:"projectId"`
    UserID      string    `bson:"user_id" json:"userId"`
    
    // å†…å®¹
    ContentType string    `bson:"content_type" json:"contentType"` // character, outline, timeline, setting
    ContentID   string    `bson:"content_id" json:"contentId"`     // æºæ•°æ® ID
    ChunkText   string    `bson:"chunk_text" json:"chunkText"`     // åˆ†å—æ–‡æœ¬
    ChunkIndex  int       `bson:"chunk_index" json:"chunkIndex"`
    
    // å‘é‡
    EmbeddingVector []float32 `bson:"embedding_vector" json:"-"` // å­˜å‚¨åœ¨ Milvus
    VectorID        int64     `bson:"vector_id,omitempty" json:"vectorId,omitempty"` // Milvus å‘é‡ ID
    
    // å…ƒæ•°æ®
    Metadata    map[string]interface{} `bson:"metadata,omitempty" json:"metadata,omitempty"`
    
    // çŠ¶æ€
    Indexed     bool      `bson:"indexed" json:"indexed"`
    
    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time `bson:"updated_at" json:"updatedAt"`
}
```

---

## ä¸‰ã€MongoDB ç´¢å¼•è®¾è®¡

### 3.1 Character ç´¢å¼•

```javascript
// åˆ›å»ºç´¢å¼•
db.characters.createIndex({ "project_id": 1, "ai_generated": 1 });
db.characters.createIndex({ "project_id": 1, "last_vectorized_at": 1 });
db.characters.createIndex({ "archetype_type": 1 });
```

### 3.2 WorldSetting ç´¢å¼•

```javascript
db.world_settings.createIndex({ "project_id": 1, "category": 1 });
db.world_settings.createIndex({ "tags": 1 });
db.world_settings.createIndex({ "project_id": 1, "ai_generated": 1 });
```

### 3.3 VectorDocument ç´¢å¼•

```javascript
db.vector_documents.createIndex({ "project_id": 1, "content_type": 1 });
db.vector_documents.createIndex({ "content_id": 1 });
db.vector_documents.createIndex({ "indexed": 1 });
```

### 3.4 AIGenerationTask ç´¢å¼•

```javascript
db.ai_generation_tasks.createIndex({ "user_id": 1, "status": 1 });
db.ai_generation_tasks.createIndex({ "project_id": 1, "task_type": 1 });
db.ai_generation_tasks.createIndex({ "created_at": -1 });
```

---

## å››ã€æ•°æ®è¿ç§»ç­–ç•¥

### 4.1 è¿ç§»è„šæœ¬

```go
// migration/add_ai_fields.go
package migration

import (
    "context"
    "go.mongodb.org/mongo-driver/bson"
    "go.mongodb.org/mongo-driver/mongo"
)

func AddAIFields(db *mongo.Database) error {
    ctx := context.Background()
    
    // 1. ä¸ºç°æœ‰ Character æ·»åŠ  AI å­—æ®µ
    _, err := db.Collection("characters").UpdateMany(
        ctx,
        bson.M{},
        bson.M{
            "$set": bson.M{
                "ai_generated": false,
                "ai_suggestions": []string{},
            },
        },
    )
    if err != nil {
        return err
    }
    
    // 2. ä¸ºç°æœ‰ Node æ·»åŠ  AI å­—æ®µ
    _, err = db.Collection("nodes").UpdateMany(
        ctx,
        bson.M{},
        bson.M{
            "$set": bson.M{
                "ai_generated": false,
                "ai_suggestions": []interface{}{},
            },
        },
    )
    
    return err
}
```

---

## äº”ã€æ€»ç»“

æœ¬æ–‡æ¡£è®¾è®¡äº† AI å¢å¼ºçš„æ•°æ®æ¨¡å‹ï¼š

**ç°æœ‰æ¨¡å‹æ‰©å±•**ï¼š
- âœ… Character: AI ç”Ÿæˆæ ‡è¯†ã€ç”Ÿæˆå…ƒæ•°æ®ã€æ€§æ ¼åˆ†æã€å‘é‡
- âœ… Node: AI æ‘˜è¦ã€å…³é”®æƒ…èŠ‚ç‚¹ã€å»ºè®®ã€å‘é‡
- âœ… Timeline/TimelineEvent: AI ç”Ÿæˆã€å†²çªåˆ†æã€å‘é‡

**æ–°å¢æ¨¡å‹**ï¼š
- âœ… WorldSetting: ä¸–ç•Œè§‚è®¾å®š
- âœ… Location: åœ°ç‚¹ç®¡ç†
- âœ… Item: é“å…·/ç‰©å“
- âœ… AIGenerationTask: AI ç”Ÿæˆä»»åŠ¡è¿½è¸ª
- âœ… VectorDocument: å‘é‡æ–‡æ¡£

**ç´¢å¼•è®¾è®¡**ï¼š
- âœ… å®Œæ•´çš„ç´¢å¼•ç­–ç•¥

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025-10-27
**ç»´æŠ¤è€…**: AIæ¶æ„ç»„
