# RAGäº‹ä»¶é©±åŠ¨ç´¢å¼•è®¾è®¡

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¶é—´**: 2025-10-21

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è®¾è®¡RAGç³»ç»Ÿçš„äº‹ä»¶é©±åŠ¨ç´¢å¼•æœºåˆ¶ï¼Œé€šè¿‡è®¢é˜…æ–‡æ¡£äº‹ä»¶è‡ªåŠ¨è§¦å‘å‘é‡åŒ–å’Œç´¢å¼•æ›´æ–°ã€‚

---

## ä¸€ã€äº‹ä»¶è§¦å‘æœºåˆ¶

### 1.1 è®¢é˜…çš„äº‹ä»¶ç±»å‹

| äº‹ä»¶ | è§¦å‘æ—¶æœº | RAGæ“ä½œ |
|------|---------|---------|
| `document.version_created` | æ–‡æ¡£ç‰ˆæœ¬åˆ›å»º | å‘é‡åŒ–æ–‡æ¡£å†…å®¹ |
| `character.created` | è§’è‰²åˆ›å»º | å‘é‡åŒ–è§’è‰²ä¿¡æ¯ |
| `character.updated` | è§’è‰²æ›´æ–° | æ›´æ–°å‘é‡ç´¢å¼• |
| `setting.updated` | è®¾å®šæ›´æ–° | æ›´æ–°è®¾å®šç´¢å¼• |
| `outline.created` | å¤§çº²åˆ›å»º | ç´¢å¼•å¤§çº²ç»“æ„ |
| `chat.session_created` | èŠå¤©ä¼šè¯åˆ›å»º | å‡†å¤‡çŸ¥è¯†åº“ |

### 1.2 äº‹ä»¶å¤„ç†å™¨å®ç°

```python
class DocumentVersionCreatedHandler(EventHandler):
    """æ–‡æ¡£ç‰ˆæœ¬åˆ›å»ºäº‹ä»¶å¤„ç†å™¨"""
    
    def __init__(self, rag_service: RAGService):
        self.rag_service = rag_service
    
    async def handle(self, event: Event):
        """å¤„ç†æ–‡æ¡£åˆ›å»ºäº‹ä»¶"""
        data = event.data
        
        # 1. è·å–æ–‡æ¡£å†…å®¹
        document = Document(
            id=data['version_id'],
            user_id=data.get('user_id'),
            project_id=data['project_id'],
            content=data['content'],
            content_type=data['content_type']
        )
        
        # 2. å¼‚æ­¥å‘é‡åŒ–
        await self.rag_service.vectorize_document(document)
        
        logger.info(f"æ–‡æ¡£å·²ç´¢å¼•: {document.id}")
```

---

## äºŒã€å¼‚æ­¥å‘é‡åŒ–é˜Ÿåˆ—

### 2.1 RabbitMQé˜Ÿåˆ—è®¾è®¡

```python
class RAGIndexQueue:
    """RAGç´¢å¼•é˜Ÿåˆ—"""
    
    def __init__(self, rabbitmq_url: str):
        self.connection = pika.BlockingConnection(pika.URLParameters(rabbitmq_url))
        self.channel = self.connection.channel()
        
        # å£°æ˜é˜Ÿåˆ—
        self.channel.queue_declare(
            queue='rag.vectorize',
            durable=True,
            arguments={
                'x-max-priority': 10,  # æ”¯æŒä¼˜å…ˆçº§
                'x-message-ttl': 3600000,  # 1å°æ—¶TTL
                'x-dead-letter-exchange': 'rag.dlx'  # æ­»ä¿¡é˜Ÿåˆ—
            }
        )
    
    def publish(self, document: Document, priority: int = 5):
        """å‘å¸ƒå‘é‡åŒ–ä»»åŠ¡"""
        message = {
            'document_id': document.id,
            'content': document.content,
            'content_type': document.content_type
        }
        
        self.channel.basic_publish(
            exchange='',
            routing_key='rag.vectorize',
            body=json.dumps(message),
            properties=pika.BasicProperties(
                delivery_mode=2,  # æŒä¹…åŒ–
                priority=priority
            )
        )
```

---

## ä¸‰ã€å¢é‡ç´¢å¼•ç­–ç•¥

### 3.1 å¢é‡æ›´æ–°

```python
class IncrementalIndexer:
    """å¢é‡ç´¢å¼•å™¨"""
    
    async def update_document(self, document_id: str, new_content: str):
        """å¢é‡æ›´æ–°æ–‡æ¡£"""
        # 1. åˆ é™¤æ—§ç´¢å¼•
        await self.kb_manager.delete_document(document_id)
        
        # 2. åˆ›å»ºæ–°ç´¢å¼•
        document = Document(id=document_id, content=new_content)
        await self.kb_manager.index_document(document)
```

### 3.2 æ‰¹é‡ç´¢å¼•

```python
async def batch_index_documents(documents: List[Document]):
    """æ‰¹é‡ç´¢å¼•"""
    for batch in chunked(documents, batch_size=100):
        embeddings = embedding_engine.encode([d.content for d in batch])
        await vector_db.batch_insert(batch, embeddings)
```

---

## å››ã€å¤±è´¥é‡è¯•æœºåˆ¶

### 4.1 é‡è¯•ç­–ç•¥

```python
from tenacity import retry, stop_after_attempt, wait_exponential

class VectorizationWorker:
    """å‘é‡åŒ–å·¥ä½œè€…"""
    
    @retry(
        stop=stop_after_attempt(3),
        wait=wait_exponential(multiplier=1, min=4, max=10)
    )
    async def vectorize(self, document: Document):
        """å‘é‡åŒ–ï¼ˆå¸¦é‡è¯•ï¼‰"""
        try:
            await self.rag_service.vectorize_document(document)
        except Exception as e:
            logger.error(f"å‘é‡åŒ–å¤±è´¥: {e}")
            raise
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2025-10-21

