# Agentå·¥å…·è°ƒç”¨é›†æˆè®¾è®¡

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¶é—´**: 2025-10-21  
> **å®æ–½çŠ¶æ€**: è®¾è®¡é˜¶æ®µ

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è®¾è®¡Python Agentå¦‚ä½•å›è°ƒGo APIå®ç°å·¥å…·è°ƒç”¨ï¼ŒåŒ…æ‹¬è®¤è¯æˆæƒä¼ é€’ã€å‚æ•°åºåˆ—åŒ–ã€è¶…æ—¶é‡è¯•ã€æƒé™æ§åˆ¶ç­‰å…³é”®æœºåˆ¶ã€‚

## ğŸ¯ è®¾è®¡ç›®æ ‡

1. **å®‰å…¨å›è°ƒ**ï¼šAgentè°ƒç”¨Go APIæ—¶å¿…é¡»é€šè¿‡è®¤è¯å’Œæƒé™æ£€æŸ¥
2. **å‚æ•°æ ‡å‡†åŒ–**ï¼šç»Ÿä¸€çš„Toolæ¥å£å’Œå‚æ•°Schema
3. **å®¹é”™æœºåˆ¶**ï¼šè¶…æ—¶æ§åˆ¶ã€é‡è¯•ç­–ç•¥ã€é”™è¯¯æ¢å¤
4. **å®¡è®¡æ—¥å¿—**ï¼šå®Œæ•´çš„å·¥å…·è°ƒç”¨è®°å½•å’Œå®¡è®¡
5. **æƒé™éš”ç¦»**ï¼šå·¥å…·çº§åˆ«å’Œç”¨æˆ·çº§åˆ«çš„æƒé™æ§åˆ¶

---

## ä¸€ã€å·¥å…·è°ƒç”¨æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Python AI Agent Service                      â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚      Creative Agent                          â”‚        â”‚
â”‚  â”‚                                               â”‚        â”‚
â”‚  â”‚  1. ç†è§£ä»»åŠ¡ï¼š"åˆ›å»ºè§’è‰²å¡-æ—é£"              â”‚        â”‚
â”‚  â”‚  2. è§„åˆ’æ­¥éª¤ï¼š[è°ƒç”¨CharacterTool.create]     â”‚        â”‚
â”‚  â”‚  3. æ‰§è¡Œæ­¥éª¤                                  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                     â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚      Tool Execution Engine                   â”‚        â”‚
â”‚  â”‚                                               â”‚        â”‚
â”‚  â”‚  1. è·å–å·¥å…·ï¼šCharacterTool                  â”‚        â”‚
â”‚  â”‚  2. éªŒè¯å‚æ•°                                  â”‚        â”‚
â”‚  â”‚  3. æ„å»ºHTTPè¯·æ±‚                              â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                     â”‚                                     â”‚
â”‚                     â”‚ HTTP POST                           â”‚
â”‚                     â”‚ /api/v1/projects/{id}/characters   â”‚
â”‚                     â”‚                                     â”‚
â”‚                     â”‚ Headers:                            â”‚
â”‚                     â”‚   Authorization: Bearer {token}    â”‚
â”‚                     â”‚   X-Agent-Call-ID: {uuid}          â”‚
â”‚                     â”‚   X-User-ID: {user_id}             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Go Backend Service                        â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚       Middleware Chain                       â”‚          â”‚
â”‚  â”‚                                               â”‚          â”‚
â”‚  â”‚  1. JWTéªŒè¯ï¼ˆè¯†åˆ«ç”¨æˆ·ï¼‰                      â”‚          â”‚
â”‚  â”‚  2. Agentè°ƒç”¨è¯†åˆ«ï¼ˆX-Agent-Call-IDï¼‰         â”‚          â”‚
â”‚  â”‚  3. æƒé™æ£€æŸ¥ï¼ˆç”¨æˆ·+å·¥å…·æƒé™ï¼‰                â”‚          â”‚
â”‚  â”‚  4. å®¡è®¡æ—¥å¿—è®°å½•                              â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                     â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚       Character API Handler                  â”‚          â”‚
â”‚  â”‚                                               â”‚          â”‚
â”‚  â”‚  1. å‚æ•°éªŒè¯                                  â”‚          â”‚
â”‚  â”‚  2. è°ƒç”¨CharacterService                      â”‚          â”‚
â”‚  â”‚  3. åˆ›å»ºè§’è‰²å¡                                â”‚          â”‚
â”‚  â”‚  4. è¿”å›ç»“æœ                                  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                     â”‚                                       â”‚
â”‚                     â”‚ Response                              â”‚
â”‚                     â”‚ {                                     â”‚
â”‚                     â”‚   "id": "char-001",                   â”‚
â”‚                     â”‚   "name": "æ—é£",                     â”‚
â”‚                     â”‚   ...                                 â”‚
â”‚                     â”‚ }                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Python AI Agent Service                        â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚      Tool Execution Engine                   â”‚          â”‚
â”‚  â”‚                                               â”‚          â”‚
â”‚  â”‚  4. è§£æå“åº”                                  â”‚          â”‚
â”‚  â”‚  5. è¿”å›ToolCallç»“æœ                          â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                     â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚      Creative Agent                          â”‚          â”‚
â”‚  â”‚                                               â”‚          â”‚
â”‚  â”‚  4. æ¥æ”¶å·¥å…·ç»“æœ                              â”‚          â”‚
â”‚  â”‚  5. ç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤                          â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€è®¤è¯æˆæƒè®¾è®¡

### 2.1 Tokenä¼ é€’æœºåˆ¶

```python
# Pythonç«¯ï¼šHTTP Clienté…ç½®
class GoAPIClient:
    """Go APIå®¢æˆ·ç«¯"""
    
    def __init__(self, base_url: str, auth_token: str):
        self.base_url = base_url
        self.auth_token = auth_token  # JWT Token
        self.session = aiohttp.ClientSession()
    
    async def call_api(
        self,
        method: str,
        endpoint: str,
        data: Dict[str, Any] = None,
        params: Dict[str, Any] = None,
        user_id: str = None,
        agent_call_id: str = None
    ) -> Dict[str, Any]:
        """è°ƒç”¨Go API"""
        
        # æ„å»ºheaders
        headers = {
            'Authorization': f'Bearer {self.auth_token}',
            'Content-Type': 'application/json',
        }
        
        # Agentè°ƒç”¨æ ‡è¯†
        if agent_call_id:
            headers['X-Agent-Call-ID'] = agent_call_id
        
        # ç”¨æˆ·ID
        if user_id:
            headers['X-User-ID'] = user_id
        
        url = f"{self.base_url}{endpoint}"
        
        async with self.session.request(
            method=method,
            url=url,
            json=data,
            params=params,
            headers=headers,
            timeout=aiohttp.ClientTimeout(total=30)
        ) as response:
            if response.status >= 400:
                error_data = await response.json()
                raise APIError(
                    status=response.status,
                    message=error_data.get('message', 'APIè°ƒç”¨å¤±è´¥'),
                    details=error_data.get('error')
                )
            
            return await response.json()
```

### 2.2 Goç«¯ä¸­é—´ä»¶

```go
// middleware/agent_call.go
package middleware

// AgentCallMiddleware Agentè°ƒç”¨è¯†åˆ«ä¸­é—´ä»¶
func AgentCallMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        agentCallID := c.GetHeader("X-Agent-Call-ID")
        
        if agentCallID != "" {
            // æ ‡è®°ä¸ºAgentè°ƒç”¨
            c.Set("is_agent_call", true)
            c.Set("agent_call_id", agentCallID)
            
            // è®°å½•Agentè°ƒç”¨æ—¥å¿—
            log.Info("Agentå·¥å…·è°ƒç”¨",
                "call_id", agentCallID,
                "user_id", c.GetString("user_id"),
                "path", c.Request.URL.Path,
                "method", c.Request.Method,
            )
        }
        
        c.Next()
    }
}

// ToolPermissionMiddleware å·¥å…·æƒé™æ£€æŸ¥ä¸­é—´ä»¶
func ToolPermissionMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        // åªå¯¹Agentè°ƒç”¨è¿›è¡Œå·¥å…·æƒé™æ£€æŸ¥
        if !c.GetBool("is_agent_call") {
            c.Next()
            return
        }
        
        userID := c.GetString("user_id")
        toolName := c.GetString("tool_name") // ç”±å…·ä½“APIè®¾ç½®
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™ä½¿ç”¨è¯¥å·¥å…·
        hasPermission, err := checkToolPermission(c.Request.Context(), userID, toolName)
        if err != nil {
            c.JSON(500, gin.H{"error": "æƒé™æ£€æŸ¥å¤±è´¥"})
            c.Abort()
            return
        }
        
        if !hasPermission {
            c.JSON(403, gin.H{"error": "æ— æƒé™ä½¿ç”¨è¯¥å·¥å…·"})
            c.Abort()
            return
        }
        
        c.Next()
    }
}
```

---

## ä¸‰ã€å·¥å…·æ¥å£æ ‡å‡†åŒ–

### 3.1 Pythonç«¯ToolåŸºç±»

```python
from abc import ABC, abstractmethod
from typing import Any, Dict
from pydantic import BaseModel, validator
import json

class ToolParameter(BaseModel):
    """å·¥å…·å‚æ•°å®šä¹‰"""
    name: str
    type: str  # 'string', 'number', 'boolean', 'object', 'array'
    description: str
    required: bool = False
    default: Any = None
    
class ToolMetadata(BaseModel):
    """å·¥å…·å…ƒæ•°æ®"""
    name: str
    description: str
    parameters: List[ToolParameter]
    category: str
    requires_auth: bool = True
    api_endpoint: str
    http_method: str = 'POST'

class Tool(ABC):
    """å·¥å…·åŸºç±»"""
    
    def __init__(self, metadata: ToolMetadata, go_api_client: GoAPIClient):
        self.metadata = metadata
        self.api_client = go_api_client
    
    def validate_parameters(self, params: Dict[str, Any]) -> bool:
        """éªŒè¯å‚æ•°"""
        for param in self.metadata.parameters:
            if param.required and param.name not in params:
                raise ValueError(f"ç¼ºå°‘å¿…éœ€å‚æ•°: {param.name}")
            
            if param.name in params:
                # ç±»å‹æ£€æŸ¥
                value = params[param.name]
                if not self._check_type(value, param.type):
                    raise ValueError(f"å‚æ•° {param.name} ç±»å‹é”™è¯¯ï¼ŒæœŸæœ› {param.type}")
        
        return True
    
    def _check_type(self, value: Any, expected_type: str) -> bool:
        """æ£€æŸ¥ç±»å‹"""
        type_map = {
            'string': str,
            'number': (int, float),
            'boolean': bool,
            'object': dict,
            'array': list
        }
        expected = type_map.get(expected_type)
        return isinstance(value, expected) if expected else False
    
    async def execute(
        self,
        params: Dict[str, Any],
        user_id: str = None,
        agent_call_id: str = None
    ) -> Any:
        """æ‰§è¡Œå·¥å…·"""
        # 1. éªŒè¯å‚æ•°
        self.validate_parameters(params)
        
        # 2. å‡†å¤‡APIè°ƒç”¨
        endpoint = self._build_endpoint(params)
        request_data = self._build_request_data(params)
        
        # 3. è°ƒç”¨Go API
        try:
            response = await self.api_client.call_api(
                method=self.metadata.http_method,
                endpoint=endpoint,
                data=request_data,
                user_id=user_id,
                agent_call_id=agent_call_id
            )
            
            # 4. è§£æå“åº”
            return self._parse_response(response)
            
        except APIError as e:
            # é”™è¯¯å¤„ç†
            raise ToolExecutionError(
                tool_name=self.metadata.name,
                error=str(e),
                status_code=e.status
            )
    
    @abstractmethod
    def _build_endpoint(self, params: Dict[str, Any]) -> str:
        """æ„å»ºAPIç«¯ç‚¹ï¼ˆå­ç±»å®ç°ï¼‰"""
        pass
    
    @abstractmethod
    def _build_request_data(self, params: Dict[str, Any]) -> Dict[str, Any]:
        """æ„å»ºè¯·æ±‚æ•°æ®ï¼ˆå­ç±»å®ç°ï¼‰"""
        pass
    
    def _parse_response(self, response: Dict[str, Any]) -> Any:
        """è§£æå“åº”ï¼ˆå¯è¢«å­ç±»è¦†ç›–ï¼‰"""
        return response.get('data')
```

### 3.2 å…·ä½“å·¥å…·å®ç°ç¤ºä¾‹

```python
class CharacterTool(Tool):
    """è§’è‰²å¡å·¥å…·"""
    
    def __init__(self, go_api_client: GoAPIClient):
        metadata = ToolMetadata(
            name="character_tool",
            description="ç®¡ç†è§’è‰²å¡ç‰‡",
            parameters=[
                ToolParameter(
                    name="action",
                    type="string",
                    description="æ“ä½œç±»å‹: create, update, get, list",
                    required=True
                ),
                ToolParameter(
                    name="project_id",
                    type="string",
                    description="é¡¹ç›®ID",
                    required=True
                ),
                ToolParameter(
                    name="character_id",
                    type="string",
                    description="è§’è‰²IDï¼ˆupdate/getæ—¶éœ€è¦ï¼‰",
                    required=False
                ),
                ToolParameter(
                    name="character_data",
                    type="object",
                    description="è§’è‰²æ•°æ®",
                    required=False
                )
            ],
            category="writing",
            api_endpoint="/api/v1/projects/{project_id}/characters",
            http_method="POST"
        )
        super().__init__(metadata, go_api_client)
    
    def _build_endpoint(self, params: Dict[str, Any]) -> str:
        """æ„å»ºAPIç«¯ç‚¹"""
        project_id = params['project_id']
        action = params['action']
        
        if action == 'create':
            return f"/api/v1/projects/{project_id}/characters"
        elif action == 'get':
            character_id = params.get('character_id')
            return f"/api/v1/projects/{project_id}/characters/{character_id}"
        elif action == 'list':
            return f"/api/v1/projects/{project_id}/characters"
        elif action == 'update':
            character_id = params.get('character_id')
            return f"/api/v1/projects/{project_id}/characters/{character_id}"
    
    def _build_request_data(self, params: Dict[str, Any]) -> Dict[str, Any]:
        """æ„å»ºè¯·æ±‚æ•°æ®"""
        action = params['action']
        
        if action in ['create', 'update']:
            return params.get('character_data', {})
        
        return {}
```

---

## å››ã€è¶…æ—¶ä¸é‡è¯•ç­–ç•¥

### 4.1 è¶…æ—¶æ§åˆ¶

```python
class ToolExecutionEngine:
    """å·¥å…·æ‰§è¡Œå¼•æ“"""
    
    def __init__(
        self,
        api_client: GoAPIClient,
        default_timeout: int = 30,
        max_retries: int = 3
    ):
        self.api_client = api_client
        self.default_timeout = default_timeout
        self.max_retries = max_retries
    
    async def execute_with_timeout(
        self,
        tool: Tool,
        params: Dict[str, Any],
        timeout: int = None,
        **kwargs
    ) -> Any:
        """å¸¦è¶…æ—¶æ§åˆ¶çš„å·¥å…·æ‰§è¡Œ"""
        timeout = timeout or self.default_timeout
        
        try:
            return await asyncio.wait_for(
                tool.execute(params, **kwargs),
                timeout=timeout
            )
        except asyncio.TimeoutError:
            raise ToolExecutionError(
                tool_name=tool.metadata.name,
                error=f"å·¥å…·æ‰§è¡Œè¶…æ—¶ï¼ˆ{timeout}ç§’ï¼‰"
            )
```

### 4.2 é‡è¯•æœºåˆ¶

```python
from tenacity import (
    retry,
    stop_after_attempt,
    wait_exponential,
    retry_if_exception_type
)

class ToolExecutionEngine:
    
    @retry(
        stop=stop_after_attempt(3),  # æœ€å¤šé‡è¯•3æ¬¡
        wait=wait_exponential(multiplier=1, min=1, max=10),  # æŒ‡æ•°é€€é¿
        retry=retry_if_exception_type((aiohttp.ClientError, asyncio.TimeoutError))
    )
    async def execute_with_retry(
        self,
        tool: Tool,
        params: Dict[str, Any],
        **kwargs
    ) -> Any:
        """å¸¦é‡è¯•çš„å·¥å…·æ‰§è¡Œ"""
        return await tool.execute(params, **kwargs)
```

---

## äº”ã€æƒé™æ§åˆ¶è®¾è®¡

### 5.1 å·¥å…·æƒé™æ¨¡å‹

```go
// models/shared/auth/tool_permission.go
package auth

type ToolPermission struct {
    ID       string   `bson:"_id" json:"id"`
    ToolName string   `bson:"tool_name" json:"toolName"` // å·¥å…·åç§°
    UserID   string   `bson:"user_id" json:"userId"`     // ç”¨æˆ·ID
    Actions  []string `bson:"actions" json:"actions"`    // å…è®¸çš„æ“ä½œ: create, read, update, delete
    Enabled  bool     `bson:"enabled" json:"enabled"`
    ExpiresAt *time.Time `bson:"expires_at,omitempty" json:"expiresAt,omitempty"`
    CreatedAt time.Time `bson:"created_at" json:"createdAt"`
}

type ToolAccessLog struct {
    ID          string    `bson:"_id" json:"id"`
    ToolName    string    `bson:"tool_name" json:"toolName"`
    UserID      string    `bson:"user_id" json:"userId"`
    AgentCallID string    `bson:"agent_call_id" json:"agentCallId"`
    Action      string    `bson:"action" json:"action"`
    Parameters  string    `bson:"parameters" json:"parameters"` // JSON
    Success     bool      `bson:"success" json:"success"`
    Error       string    `bson:"error,omitempty" json:"error,omitempty"`
    Duration    int64     `bson:"duration" json:"duration"` // æ¯«ç§’
    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`
}
```

### 5.2 æƒé™æ£€æŸ¥Service

```go
package auth

type ToolPermissionService interface {
    // æ£€æŸ¥å·¥å…·æƒé™
    CheckToolPermission(ctx context.Context, userID, toolName, action string) (bool, error)
    
    // æˆäºˆå·¥å…·æƒé™
    GrantToolPermission(ctx context.Context, userID, toolName string, actions []string) error
    
    // æ’¤é”€å·¥å…·æƒé™
    RevokeToolPermission(ctx context.Context, userID, toolName string) error
    
    // è®°å½•å·¥å…·è®¿é—®æ—¥å¿—
    LogToolAccess(ctx context.Context, log *ToolAccessLog) error
}

type ToolPermissionServiceImpl struct {
    permissionRepo ToolPermissionRepository
    logRepo        ToolAccessLogRepository
}

func (s *ToolPermissionServiceImpl) CheckToolPermission(
    ctx context.Context,
    userID, toolName, action string,
) (bool, error) {
    // 1. æŸ¥è¯¢æƒé™
    permission, err := s.permissionRepo.GetByUserAndTool(ctx, userID, toolName)
    if err != nil {
        return false, err
    }
    
    if permission == nil {
        return false, nil
    }
    
    // 2. æ£€æŸ¥æ˜¯å¦å¯ç”¨
    if !permission.Enabled {
        return false, nil
    }
    
    // 3. æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    if permission.ExpiresAt != nil && time.Now().After(*permission.ExpiresAt) {
        return false, nil
    }
    
    // 4. æ£€æŸ¥æ“ä½œæƒé™
    for _, allowedAction := range permission.Actions {
        if allowedAction == action || allowedAction == "*" {
            return true, nil
        }
    }
    
    return false, nil
}
```

---

## å…­ã€å®¡è®¡æ—¥å¿—

### 6.1 æ—¥å¿—è®°å½•ä¸­é—´ä»¶

```go
// middleware/tool_audit.go
package middleware

func ToolAuditMiddleware(toolPermissionService auth.ToolPermissionService) gin.HandlerFunc {
    return func(c *gin.Context) {
        if !c.GetBool("is_agent_call") {
            c.Next()
            return
        }
        
        start := time.Now()
        
        // æ‰§è¡Œè¯·æ±‚
        c.Next()
        
        duration := time.Since(start)
        
        // è®°å½•å®¡è®¡æ—¥å¿—
        log := &auth.ToolAccessLog{
            ID:          uuid.New().String(),
            ToolName:    c.GetString("tool_name"),
            UserID:      c.GetString("user_id"),
            AgentCallID: c.GetString("agent_call_id"),
            Action:      c.Request.Method,
            Success:     c.Writer.Status() < 400,
            Duration:    duration.Milliseconds(),
            CreatedAt:   time.Now(),
        }
        
        if c.Writer.Status() >= 400 {
            if err, exists := c.Get("error"); exists {
                log.Error = fmt.Sprintf("%v", err)
            }
        }
        
        // å¼‚æ­¥è®°å½•æ—¥å¿—
        go func() {
            ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
            defer cancel()
            
            if err := toolPermissionService.LogToolAccess(ctx, log); err != nil {
                logger.Error("è®°å½•å·¥å…·è®¿é—®æ—¥å¿—å¤±è´¥", "error", err)
            }
        }()
    }
}
```

---

## ä¸ƒã€é”™è¯¯å¤„ç†

### 7.1 Pythonç«¯é”™è¯¯ç±»å‹

```python
class ToolExecutionError(Exception):
    """å·¥å…·æ‰§è¡Œé”™è¯¯"""
    
    def __init__(self, tool_name: str, error: str, status_code: int = 500):
        self.tool_name = tool_name
        self.error = error
        self.status_code = status_code
        super().__init__(f"Tool {tool_name} execution failed: {error}")

class APIError(Exception):
    """APIè°ƒç”¨é”™è¯¯"""
    
    def __init__(self, status: int, message: str, details: str = None):
        self.status = status
        self.message = message
        self.details = details
        super().__init__(f"API Error {status}: {message}")
```

### 7.2 é”™è¯¯æ¢å¤ç­–ç•¥

```python
class ToolExecutionEngine:
    
    async def execute_with_fallback(
        self,
        tool: Tool,
        params: Dict[str, Any],
        fallback_value: Any = None,
        **kwargs
    ) -> Any:
        """å¸¦é™çº§çš„å·¥å…·æ‰§è¡Œ"""
        try:
            return await self.execute_with_retry(tool, params, **kwargs)
        except ToolExecutionError as e:
            logger.error(f"å·¥å…·æ‰§è¡Œå¤±è´¥ï¼Œä½¿ç”¨é™çº§å€¼: {e}")
            return fallback_value
```

---

## å…«ã€å®æ–½å»ºè®®

### 8.1 å¼€å‘æ­¥éª¤

1. **é˜¶æ®µ1ï¼šåŸºç¡€æ¡†æ¶**ï¼ˆ3å¤©ï¼‰
   - Python GoAPIClientå®ç°
   - Go Agentè°ƒç”¨ä¸­é—´ä»¶
   - åŸºç¡€Toolç±»å’ŒToolRegistry

2. **é˜¶æ®µ2ï¼šæƒé™ç³»ç»Ÿ**ï¼ˆ2å¤©ï¼‰
   - ToolPermissionæ•°æ®æ¨¡å‹
   - ToolPermissionServiceå®ç°
   - æƒé™æ£€æŸ¥ä¸­é—´ä»¶

3. **é˜¶æ®µ3ï¼šå®¡è®¡æ—¥å¿—**ï¼ˆ1å¤©ï¼‰
   - ToolAccessLogæ•°æ®æ¨¡å‹
   - å®¡è®¡æ—¥å¿—ä¸­é—´ä»¶
   - æ—¥å¿—æŸ¥è¯¢API

4. **é˜¶æ®µ4ï¼šé”™è¯¯å¤„ç†**ï¼ˆ1å¤©ï¼‰
   - é‡è¯•æœºåˆ¶
   - é™çº§ç­–ç•¥
   - é”™è¯¯æ—¥å¿—

5. **é˜¶æ®µ5ï¼šæµ‹è¯•**ï¼ˆ2å¤©ï¼‰
   - å•å…ƒæµ‹è¯•
   - é›†æˆæµ‹è¯•
   - æ€§èƒ½æµ‹è¯•

### 8.2 æŠ€æœ¯é£é™©

| é£é™© | ç­‰çº§ | åº”å¯¹æªæ–½ |
|------|------|---------|
| ç½‘ç»œå»¶è¿Ÿ | ä¸­ | å¼‚æ­¥è°ƒç”¨ã€è¶…æ—¶æ§åˆ¶ |
| æƒé™æ¼æ´ | é«˜ | å¤šå±‚æƒé™æ£€æŸ¥ã€å®¡è®¡æ—¥å¿— |
| è°ƒç”¨å¤±è´¥ | ä¸­ | é‡è¯•æœºåˆ¶ã€é™çº§ç­–ç•¥ |
| å¹¶å‘é—®é¢˜ | ä¸­ | è¿æ¥æ± ã€é™æµæ§åˆ¶ |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2025-10-21  
**è´Ÿè´£äºº**: æ¶æ„ç»„  
**å®¡æ ¸çŠ¶æ€**: å¾…è¯„å®¡

