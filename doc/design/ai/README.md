# AI模块设计文档

> **架构版本**: v2.1  
> **最后更新**: 2025-10-21  
> **架构特性**: Go/Python混合架构 + Agent系统 + RAG增强 + 强制流式接口

## 📋 概述

本目录包含青羽平台AI模块的完整设计文档。基于v2.1架构，AI模块采用**Go/Python混合架构**：
- **Go层**：高并发API代理、流式响应、熔断限流
- **Python层**：AI核心逻辑、Agent引擎、RAG检索、工具调用

## 🏗️ 架构概览

```
┌──────────────────────────────────────────┐
│      Go Backend (Gin 服务)               │
│  ┌────────────────────────────────┐      │
│  │  AI Proxy Service (Go)         │      │
│  │  - HTTP API接口                │      │
│  │  - 请求验证和转发              │      │
│  │  - 流式响应代理(SSE)           │      │
│  │  - 熔断器和限流                │      │
│  │  - 错误转换                    │      │
│  └──────────┬─────────────────────┘      │
└─────────────┼────────────────────────────┘
              │ gRPC/HTTP
┌─────────────▼────────────────────────────┐
│    Python AI Agent Service (FastAPI)     │
│  ┌────────────────────────────────┐      │
│  │  AI Agent核心逻辑              │      │
│  │  - Agent引擎                   │      │
│  │  - 工具调用执行                │      │
│  │  - RAG检索增强                 │      │
│  │  - Prompt处理                  │      │
│  │  - 向量数据库(Milvus/Qdrant)   │      │
│  └────────────────────────────────┘      │
└──────────────────────────────────────────┘
```

## 📚 当前有效文档

### 核心架构设计

#### 1. [Agent框架技术选型对比](./agent/Agent框架技术选型对比.md) 🔥 **推荐阅读**
**文档内容**：
- LangChain vs **LangGraph** vs AutoGen vs CrewAI vs MetaGPT vs Semantic Kernel 详细对比
- **最终推荐：LangGraph** 作为青羽平台的Agent引擎 🏆
  - ✅ 图状工作流（StateGraph）完美支持复杂创作流程
  - ✅ 继承LangChain全部生态（工具、RAG、LLM适配器）
  - ✅ 显式状态管理，便于调试和持久化
- 各框架优劣势分析（GitHub星数、生态、适用场景）
- 青羽项目需求匹配度评估
- 为什么LangGraph优于纯LangChain

**适用场景**：
- 技术选型决策参考
- 理解框架差异和适用场景
- 团队技术培训

#### 2. [Python AI Agent系统架构设计](./agent/07.Python_AI_Agent系统架构设计.md) 🔥 **已更新为LangGraph**
**文档内容**：
- **Agent框架设计（基于LangGraph）** ✅
  - StateGraph状态图工作流
  - 条件路由、循环控制、分支逻辑
  - ToolNode工具调用集成
  - Checkpointer状态持久化
- 专业Agent（创作、分析、审核、助手）
- 工具调用框架（继承LangChain工具生态）
- Agent协作机制（子图嵌套）
- Agent记忆系统（State + Checkpointer）
- **附录：LangGraph完整实现示例** 📖

**适用场景**：
- Python AI服务整体架构设计
- LangGraph开发实战
- 复杂工作流编排
- 工具系统集成

#### 3. [Go AI代理层设计](./agent/08.Go_AI代理层设计.md)
**文档内容**：
- Go代理服务架构
- gRPC客户端设计
- 流式响应代理（SSE）
- 熔断器和限流器
- 错误转换和处理

**适用场景**：
- Go API层开发
- 流式接口实现
- 性能优化和容错

#### 4. [Agent工具调用集成设计](./agent/09.Agent工具调用集成设计.md)
**文档内容**：
- 工具注册框架
- 写作工具集成（大纲、角色卡、时间线等）
- 工具执行引擎
- 权限控制
- 错误处理

**适用场景**：
- 工具开发和集成
- 权限设计
- 工具调用链路

### RAG检索增强系统

#### 5. [RAG检索增强系统设计](./rag/10.RAG检索增强系统设计.md)
**文档内容**：
- 向量化引擎（文本预处理、分块、编码）
- 知识库管理（用户私有、平台公共、外部知识）
- 向量检索引擎（语义检索、混合检索、重排序）
- RAG工作流引擎
- 应用场景（智能续写、设定问答、阅读助手）

**适用场景**：
- RAG系统开发
- 知识库建设
- 智能检索实现

#### 6. [RAG事件驱动索引设计](./rag/11.RAG事件驱动索引设计.md)
**文档内容**：
- 事件触发机制（文档创建、角色更新等）
- 异步向量化队列（RabbitMQ）
- 增量索引策略
- 失败重试机制

**适用场景**：
- 向量化自动触发
- 索引更新机制
- 异步任务处理

### 接口规范

#### 7. [AI流式接口规范](./streaming/12.AI流式接口规范.md)
**文档内容**：
- 强制流式接口规范
- SSE实现规范
- 前端集成示例（EventSource）
- 性能优化（chunk大小、推送频率）
- 错误处理和连接保活

**适用场景**：
- API开发
- 前端对接
- 性能调优

## 📝 待补充文档

以下文档需要补充，以完善AI模块设计：

### 1. AI适配器管理设计
**内容方向**：
- 多AI提供商适配（OpenAI、Claude、Gemini、文心一言、通义千问等）
- 适配器工厂模式
- 负载均衡和故障转移
- 健康检查机制

**参考**：可从 [`archived/03.AI设配器模块.md`](./archived/03.AI设配器模块.md) 提取有效内容

### 2. AI配额管理设计
**内容方向**：
- Token配额控制
- 成本统计和预警
- 用户级别配额
- 配额策略配置

### 3. AI上下文管理设计（RAG版本）
**内容方向**：
- 基于RAG的上下文管理
- 对话历史索引
- 上下文压缩策略
- 长对话支持

**参考**：可从 [`archived/06.AI上下文管理设计.md`](./archived/06.AI上下文管理设计.md) 提取有效内容并重构

## 🗂️ 归档文档

v2.0架构的历史文档已归档到 [`archived/`](./archived/) 目录：

| 文档 | 归档原因 | 替代文档 |
|------|---------|---------|
| `01.AI服务架构设计.md` | 基于单体Go架构 | 07 + 08 |
| `02.AI功能总体设计.md` | 基于旧架构 | v2.1架构文档 |
| `03.AI设配器模块.md` | 适配器设计已整合 | 08 |
| `04.AI聊天功能设计.md` | 旧对话模式 | 12 + Agent系统 |
| `05.AI流式响应设计.md` | 旧流式实现 | 12 |
| `06.AI上下文管理设计.md` | 未集成RAG | 10 |

**查看归档文档**：[归档说明](./archived/README.md)

## 🚀 开发指南

### 新功能开发流程

1. **需求分析**：明确AI功能需求和应用场景
2. **架构设计**：确定使用Go还是Python实现，或两者协作
3. **接口设计**：定义API接口（强制使用流式）
4. **详细设计**：完成各层详细设计
5. **编码实现**：
   - Python端：Agent逻辑、工具开发、RAG集成
   - Go端：API代理、流式转发、错误处理
6. **测试验证**：单元测试、集成测试、性能测试
7. **文档更新**：同步更新设计文档

### AI功能开发最佳实践

#### Go层（API代理）
```go
// ✅ 推荐：流式代理
func (api *AIApi) GenerateText(c *gin.Context) {
    // 1. 参数验证
    // 2. 调用Python服务（gRPC）
    // 3. 流式转发（SSE）
    // 4. 错误处理
}
```

#### Python层（AI核心）
```python
# ✅ 推荐：Agent + 工具调用
async def intelligent_writing(request: WritingRequest):
    # 1. Agent理解任务
    # 2. RAG检索相关设定
    # 3. 工具调用（大纲、角色卡等）
    # 4. 流式生成
    yield chunk
```

### 关键技术要求

1. **强制流式接口**：所有AI生成接口必须使用流式响应
2. **事件驱动**：文档更新触发向量化索引
3. **工具调用**：Agent能调用写作端工具
4. **RAG增强**：智能检索用户设定和知识库

## 📖 相关文档

### 架构总览
- [青羽平台模块化架构设计v2.1](../青羽平台模块化架构设计v2.1.md) - AI模块在整体架构中的定位

### 重构规划
- [模块边界优化方案](../重构规划/模块边界优化方案.md) - AI Module Go/Python分层
- [架构重构总结v3.0](../重构规划/架构重构总结v3.0.md) - 架构升级说明

### 相关模块
- [写作端模块](../writing/) - AI写作助手的业务场景
- [事件驱动架构](../core/事件驱动架构设计.md) - RAG索引触发机制
- [配置中心集成](../platform/配置中心集成设计.md) - Prompt模板管理

## 🔧 技术栈

### Go技术栈
- **Web框架**：Gin
- **gRPC**：Google gRPC
- **流式响应**：SSE (Server-Sent Events)
- **熔断器**：hystrix-go / gobreaker
- **限流器**：golang.org/x/time/rate

### Python技术栈 🔥 **已更新**
- **Web框架**：FastAPI
- **Agent框架**：**LangGraph** 🏆（图状工作流 + 继承LangChain全部生态）
  - StateGraph：状态图工作流引擎
  - ToolNode：工具调用节点
  - Checkpointer：状态持久化
  - 完全兼容LangChain工具、RAG、LLM适配器
- **向量数据库**：Milvus / Qdrant
- **向量模型**：BGE-large-zh-v1.5 / OpenAI Embeddings
- **异步处理**：asyncio、RabbitMQ

## 📞 联系方式

**文档维护者**：青羽AI架构组  
**最后更新**：2025-10-21  
**架构版本**：v2.1
