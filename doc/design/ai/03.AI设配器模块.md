# AI 适配器模块

## 概述

AI 适配器模块为青语智能写作系统提供了统一的多厂商AI服务接入能力。通过适配器模式，系统可以无缝集成多个AI服务提供商，包括OpenAI、Claude、Google Gemini、百度文心一言、阿里通义千问等。

## 架构设计

### 核心组件

1. **AIAdapter 接口** (`adapter_interface.go`)
   - 定义了统一的AI服务接口
   - 包含文本生成、对话完成、图像生成等方法
   - 提供健康检查和模型信息查询功能

2. **适配器管理器** (`manager.go`)
   - 统一管理所有AI适配器实例
   - 支持动态适配器选择和负载均衡
   - 提供适配器健康监控功能

3. **错误处理和重试机制** (`retry.go`)
   - 实现指数退避重试策略
   - 提供熔断器保护机制
   - 支持限流控制

4. **具体适配器实现**
   - `openai.go` - OpenAI 适配器
   - `claude.go` - Anthropic Claude 适配器
   - `gemini.go` - Google Gemini 适配器
   - `wenxin.go` - 百度文心一言适配器
   - `qwen.go` - 阿里通义千问适配器

## 功能特性

### 1. 统一接口
所有适配器都实现相同的 `AIAdapter` 接口，确保上层服务调用的一致性：

```go
type AIAdapter interface {
    GetName() string
    GetSupportedModels() []string
    TextGeneration(ctx context.Context, req *TextGenerationRequest) (*TextGenerationResponse, error)
    ChatCompletion(ctx context.Context, req *ChatCompletionRequest) (*ChatCompletionResponse, error)
    TextGenerationStream(ctx context.Context, req *TextGenerationRequest) (<-chan *TextGenerationResponse, error)
    ImageGeneration(ctx context.Context, req *ImageGenerationRequest) (*ImageGenerationResponse, error)
    HealthCheck(ctx context.Context) error
}
```

### 2. 智能路由
适配器管理器支持多种路由策略：
- **默认提供商**: 使用配置中指定的默认AI服务
- **模型匹配**: 根据请求的模型自动选择合适的适配器
- **优先级排序**: 按配置的优先级选择可用适配器

### 3. 错误处理
完善的错误处理机制：
- **重试策略**: 对临时性错误进行自动重试
- **熔断保护**: 防止故障服务影响整体性能
- **限流控制**: 避免超出API调用限制

### 4. 配置管理
支持灵活的多厂商配置：

```go
type ExternalAPIConfig struct {
    DefaultProvider string                    `yaml:"defaultProvider"`
    Providers       map[string]*ProviderConfig `yaml:"providers"`
}

type ProviderConfig struct {
    Name            string   `yaml:"name"`
    APIKey          string   `yaml:"apiKey"`
    SecretKey       string   `yaml:"secretKey,omitempty"`
    BaseURL         string   `yaml:"baseURL"`
    DefaultModel    string   `yaml:"defaultModel"`
    SupportedModels []string `yaml:"supportedModels"`
    Enabled         bool     `yaml:"enabled"`
    Priority        int      `yaml:"priority"`
}
```

## 使用示例

### 1. 初始化适配器管理器

```go
// 加载配置
cfg := config.LoadConfig()

// 创建适配器管理器
manager := adapter.NewAdapterManager(&cfg.AI.ExternalAPI)
```

### 2. 使用默认适配器

```go
// 获取默认适配器
adapter, err := manager.GetDefaultAdapter()
if err != nil {
    return err
}

// 进行文本生成
response, err := adapter.TextGeneration(ctx, &adapter.TextGenerationRequest{
    Model:       "gpt-3.5-turbo",
    Prompt:      "写一段关于春天的描述",
    MaxTokens:   500,
    Temperature: 0.7,
})
```

### 3. 指定特定适配器

```go
// 使用Claude适配器
response, err := manager.TextGeneration(ctx, "claude", &adapter.TextGenerationRequest{
    Model:   "claude-3-sonnet",
    Prompt:  "分析这段文本的情感倾向",
    MaxTokens: 300,
})
```

### 4. 自动选择适配器

```go
// 根据模型自动选择适配器
response, err := manager.AutoTextGeneration(ctx, &adapter.TextGenerationRequest{
    Model:   "gpt-4",  // 系统会自动选择支持gpt-4的适配器
    Prompt:  "生成一个故事大纲",
    MaxTokens: 1000,
})
```

## 扩展新适配器

要添加新的AI服务提供商，只需：

1. 实现 `AIAdapter` 接口
2. 在适配器管理器中注册新适配器
3. 更新配置文件添加新提供商配置

示例：

```go
// 新适配器实现
type NewAIAdapter struct {
    apiKey  string
    baseURL string
    client  *http.Client
}

func (a *NewAIAdapter) GetName() string {
    return "newai"
}

// 实现其他接口方法...

// 在管理器中注册
func (m *AdapterManager) initializeAdapters() {
    // ... 现有适配器初始化
    
    case "newai":
        adapter = NewNewAIAdapter(providerConfig.APIKey, providerConfig.BaseURL)
}
```

## 错误类型

系统定义了标准的错误类型：

- `ErrorTypeInvalidRequest` - 请求参数无效
- `ErrorTypeAuthentication` - 认证失败
- `ErrorTypeRateLimit` - 请求频率限制
- `ErrorTypeTimeout` - 请求超时
- `ErrorTypeNetworkError` - 网络错误
- `ErrorTypeServiceUnavailable` - 服务不可用
- `ErrorTypeInvalidResponse` - 响应格式无效
- `ErrorTypeNotImplemented` - 功能未实现
- `ErrorTypeUnknown` - 未知错误

## 监控和日志

适配器模块提供了完善的监控功能：

- **健康检查**: 定期检查所有适配器的可用性
- **性能指标**: 记录请求延迟、成功率等指标
- **错误统计**: 统计各类错误的发生频率
- **使用量统计**: 跟踪各适配器的使用情况

## 最佳实践

1. **配置管理**: 使用环境变量管理敏感信息如API密钥
2. **错误处理**: 合理设置重试次数和超时时间
3. **性能优化**: 根据实际需求调整并发数和缓存策略
4. **安全考虑**: 定期轮换API密钥，使用HTTPS传输
5. **监控告警**: 设置适当的监控指标和告警阈值

## 配置示例

```yaml
ai:
  externalAPI:
    defaultProvider: "openai"
    providers:
      openai:
        name: "OpenAI"
        apiKey: "${OPENAI_API_KEY}"
        baseURL: "https://api.openai.com/v1"
        defaultModel: "gpt-3.5-turbo"
        supportedModels:
          - "gpt-4"
          - "gpt-3.5-turbo"
          - "text-davinci-003"
        enabled: true
        priority: 1
      
      claude:
        name: "Anthropic Claude"
        apiKey: "${CLAUDE_API_KEY}"
        baseURL: "https://api.anthropic.com"
        defaultModel: "claude-3-sonnet"
        supportedModels:
          - "claude-3-opus"
          - "claude-3-sonnet"
          - "claude-3-haiku"
        enabled: true
        priority: 2
```

## 总结

AI适配器模块为青语智能写作系统提供了强大而灵活的多厂商AI服务集成能力。通过统一的接口设计、智能的路由策略和完善的错误处理机制，确保了系统的稳定性和可扩展性。