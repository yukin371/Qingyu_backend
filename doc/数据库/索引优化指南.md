# æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–æŒ‡å—

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **åˆ›å»ºæ—¥æœŸ**: 2025-01-06
> **é€‚ç”¨æ•°æ®åº“**: MongoDB

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•å¯¹é’ç¾½å¹³å°çš„MongoDBæ•°æ®åº“è¿›è¡Œç´¢å¼•ä¼˜åŒ–ï¼Œä»¥æå‡æŸ¥è¯¢æ€§èƒ½ã€‚

## ğŸ¯ ç´¢å¼•ä¼˜åŒ–åŸåˆ™

### 1. ç´¢å¼•é€‰æ‹©åŸåˆ™

- **é«˜æŸ¥è¯¢é¢‘ç‡çš„å­—æ®µ**ä¼˜å…ˆå»ºç«‹ç´¢å¼•
- **æ’åºå­—æ®µ**éœ€è¦å»ºç«‹ç´¢å¼•
- **ç»„åˆæŸ¥è¯¢**ä½¿ç”¨å¤åˆç´¢å¼•
- **é¿å…è¿‡åº¦ç´¢å¼•**ï¼ˆå½±å“å†™å…¥æ€§èƒ½ï¼‰

### 2. å¤åˆç´¢å¼•é¡ºåº

```javascript
// æ­£ç¡®çš„å¤åˆç´¢å¼•é¡ºåº
db.collection.createIndex({
    status: 1,        // ç­‰å€¼æŸ¥è¯¢åœ¨å‰
    created_at: -1,    // èŒƒå›´æŸ¥è¯¢åœ¨å
    category: 1        // æ’åºå­—æ®µæœ€å
})

// é”™è¯¯çš„å¤åˆç´¢å¼•é¡ºåº
db.collection.createIndex({
    created_at: -1,    // èŒƒå›´æŸ¥è¯¢åœ¨å‰
    status: 1,
    category: 1
})
```

### 3. ç´¢å¼•ç±»å‹

| ç±»å‹ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|------|------|---------|
| å•å­—æ®µç´¢å¼• | å•ä¸ªå­—æ®µç´¢å¼• | ç®€å•æŸ¥è¯¢ |
| å¤åˆç´¢å¼• | å¤šä¸ªå­—æ®µç»„åˆç´¢å¼• | ç»„åˆæŸ¥è¯¢ |
| å”¯ä¸€ç´¢å¼• | ä¿è¯å­—æ®µå”¯ä¸€æ€§ | å”¯ä¸€çº¦æŸ |
| ç¨€ç–ç´¢å¼• | åªç´¢å¼•å­˜åœ¨çš„æ–‡æ¡£ | å¯é€‰å­—æ®µ |
| TTLç´¢å¼• | è‡ªåŠ¨è¿‡æœŸæ–‡æ¡£ | ä¸´æ—¶æ•°æ® |
| å…¨æ–‡ç´¢å¼• | æ–‡æœ¬æœç´¢ | å†…å®¹æœç´¢ |
| åœ°ç†ç©ºé—´ç´¢å¼• | ä½ç½®æŸ¥è¯¢ | åœ°ç†ä½ç½® |

## ğŸ“Š ç´¢å¼•ä¼˜åŒ–æ¸…å•

### 1. ç”¨æˆ·è¡¨ (users)

```javascript
// 1. åŸºç¡€ç´¢å¼•
db.users.createIndex({ email: 1 }, { unique: true })
db.users.createIndex({ username: 1 }, { unique: true })
db.users.createIndex({ phone: 1 }, { unique: true, sparse: true })

// 2. æŸ¥è¯¢ç´¢å¼•
db.users.createIndex({ status: 1, created_at: -1 })
db.users.createIndex({ roles: 1 })
db.users.createIndex({ last_login_at: -1 })

// 3. æ–‡æœ¬ç´¢å¼•ï¼ˆæœç´¢ï¼‰
db.users.createIndex({ nickname: "text", bio: "text" })

// 4. TTLç´¢å¼•ï¼ˆå¯†ç é‡ç½®ä»¤ç‰Œè‡ªåŠ¨è¿‡æœŸï¼‰
db.password_resets.createIndex({ expires_at: 1 }, { expireAfterSeconds: 0 })
```

### 2. ä¹¦ç±è¡¨ (books)

```javascript
// 1. åŸºç¡€ç´¢å¼•
db.books.createIndex({ author_id: 1 })
db.books.createIndex({ status: 1 })
db.books.createIndex({ category: 1 })
db.books.createIndex({ is_completed: 1 })
db.books.createIndex({ created_at: -1 })
db.books.createIndex({ updated_at: -1 })

// 2. å¤åˆç´¢å¼•ï¼ˆå¸¸ç”¨æŸ¥è¯¢ï¼‰
db.books.createIndex({ status: 1, created_at: -1 })
db.books.createIndex({ status: 1, category: 1, rating: -1 })
db.books.createIndex({ author_id: 1, status: 1, created_at: -1 })
db.books.createIndex({ category: 1, is_completed: 1, rating: -1 })

// 3. å…¨æ–‡ç´¢å¼•ï¼ˆæœç´¢ï¼‰
db.books.createIndex({
    title: "text",
    description: "text",
    tags: "text"
}, {
    weights: {
        title: 10,
        description: 5,
        tags: 3
    },
    name: "book_text_search"
})

// 4. ç»Ÿè®¡ç´¢å¼•
db.books.createIndex({ view_count: -1 })
db.books.createIndex({ read_count: -1 })
db.books.createIndex({ collect_count: -1 })
db.books.createIndex({ rating: -1 })
```

### 3. ç« èŠ‚è¡¨ (chapters)

```javascript
// 1. åŸºç¡€ç´¢å¼•
db.chapters.createIndex({ book_id: 1 })
db.chapters.createIndex({ status: 1 })
db.chapters.createIndex({ is_published: 1 })
db.chapters.createIndex({ chapter_number: 1 })
db.chapters.createIndex({ created_at: -1 })

// 2. å¤åˆç´¢å¼•
db.chapters.createIndex({ book_id: 1, chapter_number: 1 })
db.chapters.createIndex({ book_id: 1, status: 1, chapter_number: 1 })
db.chapters.createIndex({ book_id: 1, is_published: 1, created_at: -1 })

// 3. å…¨æ–‡ç´¢å¼•
db.chapters.createIndex({ title: "text", content: "text" })
```

### 4. é˜…è¯»è¿›åº¦è¡¨ (reading_progress)

```javascript
// 1. åŸºç¡€ç´¢å¼•
db.reading_progress.createIndex({ user_id: 1 })
db.reading_progress.createIndex({ book_id: 1 })
db.reading_progress.createIndex({ chapter_id: 1 })
db.reading_progress.createIndex({ updated_at: -1 })

// 2. å¤åˆç´¢å¼•ï¼ˆæœ€æ–°é˜…è¯»ï¼‰
db.reading_progress.createIndex({ user_id: 1, updated_at: -1 })

// 3. å”¯ä¸€ç´¢å¼•ï¼ˆæ¯ä¸ªç”¨æˆ·æ¯æœ¬ä¹¦åªæœ‰ä¸€ä¸ªè¿›åº¦ï¼‰
db.reading_progress.createIndex({
    user_id: 1,
    book_id: 1
}, {
    unique: true
})
```

### 5. ä¹¦æ¶è¡¨ (bookshelf)

```javascript
// 1. åŸºç¡€ç´¢å¼•
db.bookshelf.createIndex({ user_id: 1 })
db.bookshelf.createIndex({ book_id: 1 })
db.bookshelf.createIndex({ reading_status: 1 })
db.bookshelf.createIndex({ is_favorite: 1 })
db.bookshelf.createIndex({ last_read_at: -1 })

// 2. å¤åˆç´¢å¼•
db.bookshelf.createIndex({ user_id: 1, reading_status: 1, last_read_at: -1 })
db.bookshelf.createIndex({ user_id: 1, is_favorite: 1, created_at: -1 })
db.bookshelf.createIndex({ user_id: 1, rating: -1 })

// 3. å”¯ä¸€ç´¢å¼•
db.bookshelf.createIndex({
    user_id: 1,
    book_id: 1
}, {
    unique: true
})
```

### 6. è¯„è®ºè¡¨ (comments)

```javascript
// 1. åŸºç¡€ç´¢å¼•
db.comments.createIndex({ user_id: 1 })
db.comments.createIndex({ target_type: 1 })
db.comments.createIndex({ target_id: 1 })
db.comments.createIndex({ status: 1 })
db.comments.createIndex({ created_at: -1 })

// 2. å¤åˆç´¢å¼•ï¼ˆè¯„è®ºåˆ—è¡¨ï¼‰
db.comments.createIndex({
    target_type: 1,
    target_id: 1,
    status: 1,
    created_at: -1
})

// 3. åµŒå¥—è¯„è®ºç´¢å¼•
db.comments.createIndex({ parent_id: 1 })
db.comments.createIndex({ root_id: 1 })

// 4. çƒ­é—¨è¯„è®ºç´¢å¼•
db.comments.createIndex({
    target_type: 1,
    target_id: 1,
    like_count: -1,
    created_at: -1
})
```

### 7. äº¤æ˜“è¡¨ (transactions)

```javascript
// 1. åŸºç¡€ç´¢å¼•
db.transactions.createIndex({ user_id: 1 })
db.transactions.createIndex({ type: 1 })
db.transactions.createIndex({ status: 1 })
db.transactions.createIndex({ created_at: -1 })

// 2. å¤åˆç´¢å¼•ï¼ˆäº¤æ˜“è®°å½•ï¼‰
db.transactions.createIndex({
    user_id: 1,
    type: 1,
    created_at: -1
})

db.transactions.createIndex({
    user_id: 1,
    status: 1,
    created_at: -1
})

// 3. è®¢å•ç´¢å¼•
db.transactions.createIndex({ order_id: 1 })
```

### 8. æ”¶è—è¡¨ (collections)

```javascript
// 1. åŸºç¡€ç´¢å¼•
db.collections.createIndex({ user_id: 1 })
db.collections.createIndex({ target_type: 1 })
db.collections.createIndex({ target_id: 1 })
db.collections.createIndex({ created_at: -1 })

// 2. å¤åˆç´¢å¼•
db.collections.createIndex({
    user_id: 1,
    target_type: 1,
    created_at: -1
})

// 3. å”¯ä¸€ç´¢å¼•
db.collections.createIndex({
    user_id: 1,
    target_type: 1,
    target_id: 1
}, {
    unique: true
})
```

### 9. å…³æ³¨è¡¨ (follows)

```javascript
// 1. åŸºç¡€ç´¢å¼•
db.follows.createIndex({ follower_id: 1 })
db.follows.createIndex({ following_id: 1 })
db.follows.createIndex({ created_at: -1 })

// 2. å¤åˆç´¢å¼•
db.follows.createIndex({
    follower_id: 1,
    created_at: -1
})

db.follows.createIndex({
    following_id: 1,
    created_at: -1
})

// 3. å”¯ä¸€ç´¢å¼•
db.follows.createIndex({
    follower_id: 1,
    following_id: 1
}, {
    unique: true
})
```

### 10. ç‚¹èµè¡¨ (likes)

```javascript
// 1. åŸºç¡€ç´¢å¼•
db.likes.createIndex({ user_id: 1 })
db.likes.createIndex({ target_type: 1 })
db.likes.createIndex({ target_id: 1 })
db.likes.createIndex({ created_at: -1 })

// 2. å”¯ä¸€ç´¢å¼•
db.likes.createIndex({
    user_id: 1,
    target_type: 1,
    target_id: 1
}, {
    unique: true
})
```

## ğŸ”§ ç´¢å¼•ç®¡ç†è„šæœ¬

### åˆ›å»ºæ‰€æœ‰ç´¢å¼•

```javascript
// scripts/create_indexes.js
// ä½¿ç”¨æ–¹æ³•ï¼šmongosh qingyu < scripts/create_indexes.js

// ç”¨æˆ·è¡¨ç´¢å¼•
print("åˆ›å»ºç”¨æˆ·è¡¨ç´¢å¼•...");
db.users.createIndex({ email: 1 }, { unique: true });
db.users.createIndex({ username: 1 }, { unique: true });
db.users.createIndex({ phone: 1 }, { unique: true, sparse: true });
db.users.createIndex({ status: 1, created_at: -1 });
db.users.createIndex({ roles: 1 });
db.users.createIndex({ nickname: "text", bio: "text" });

// ä¹¦ç±è¡¨ç´¢å¼•
print("åˆ›å»ºä¹¦ç±è¡¨ç´¢å¼•...");
db.books.createIndex({ author_id: 1 });
db.books.createIndex({ status: 1 });
db.books.createIndex({ category: 1 });
db.books.createIndex({ is_completed: 1 });
db.books.createIndex({ created_at: -1 });
db.books.createIndex({ updated_at: -1 });
db.books.createIndex({ status: 1, created_at: -1 });
db.books.createIndex({ status: 1, category: 1, rating: -1 });
db.books.createIndex({ author_id: 1, status: 1, created_at: -1 });
db.books.createIndex({ title: "text", description: "text", tags: "text" });
db.books.createIndex({ view_count: -1 });
db.books.createIndex({ rating: -1 });

// ç« èŠ‚è¡¨ç´¢å¼•
print("åˆ›å»ºç« èŠ‚è¡¨ç´¢å¼•...");
db.chapters.createIndex({ book_id: 1 });
db.chapters.createIndex({ chapter_number: 1 });
db.chapters.createIndex({ status: 1, is_published: 1 });
db.chapters.createIndex({ book_id: 1, chapter_number: 1 });
db.chapters.createIndex({ book_id: 1, status: 1, chapter_number: 1 });

// å…¶ä»–è¡¨çš„ç´¢å¼•...
// (ç»§ç»­æ·»åŠ å…¶ä»–è¡¨çš„ç´¢å¼•åˆ›å»ºè¯­å¥)

print("æ‰€æœ‰ç´¢å¼•åˆ›å»ºå®Œæˆï¼");
```

### æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ

```javascript
// æŸ¥çœ‹ç´¢å¼•ç»Ÿè®¡
db.books.aggregate([
    { $indexStats: {} }
])

// æŸ¥çœ‹æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’
db.books.find({ category: "novel", status: "published" }).explain("executionStats")

// æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
db.books.find({ category: "novel", status: "published" }).hint({ category: 1, status: 1 }).explain("executionStats")
```

### åˆ é™¤æœªä½¿ç”¨çš„ç´¢å¼•

```javascript
// åˆ é™¤ç´¢å¼•
db.books.dropIndex("old_index_name")

// æŸ¥çœ‹æ‰€æœ‰ç´¢å¼•
db.books.getIndexes()
```

## ğŸ“ˆ ç´¢å¼•ä¼˜åŒ–æ•ˆæœéªŒè¯

### 1. æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”

```javascript
// ä½¿ç”¨explainåˆ†ææŸ¥è¯¢
db.books.find({
    category: "novel",
    status: "published",
    rating: { $gte: 4.0 }
}).explain("executionStats")

// å…³æ³¨ä»¥ä¸‹æŒ‡æ ‡ï¼š
// - executionTimeMillis: æ‰§è¡Œæ—¶é—´
// - totalDocsExamined: æ‰«ææ–‡æ¡£æ•°
// - indexUsed: ä½¿ç”¨çš„ç´¢å¼•
```

### 2. ç´¢å¼•å¤§å°ç›‘æ§

```javascript
// æŸ¥çœ‹ç´¢å¼•å¤§å°
db.books.stats().indexSizes

// æŸ¥çœ‹é›†åˆæ€»å¤§å°
db.books.totalSize()
```

### 3. æ…¢æŸ¥è¯¢åˆ†æ

```javascript
// å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
db.setProfilingLevel(1, { slowms: 100 })  // è®°å½•è¶…è¿‡100msçš„æŸ¥è¯¢

// æŸ¥çœ‹æ…¢æŸ¥è¯¢
db.system.profile.find().sort({ ts: -1 }).limit(10)
```

## âœ… ç´¢å¼•ä¼˜åŒ–æ£€æŸ¥æ¸…å•

- [ ] æ‰€æœ‰å¸¸ç”¨æŸ¥è¯¢å­—æ®µéƒ½æœ‰ç´¢å¼•
- [ ] å¤åˆç´¢å¼•é¡ºåºæ­£ç¡®
- [ ] å”¯ä¸€çº¦æŸæ­£ç¡®è®¾ç½®
- [ ] å…¨æ–‡ç´¢å¼•é…ç½®åˆç†
- [ ] å®šæœŸæ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
- [ ] åˆ é™¤æœªä½¿ç”¨çš„ç´¢å¼•
- [ ] ç›‘æ§æ…¢æŸ¥è¯¢

---

**æ–‡æ¡£ç»´æŠ¤**: é’ç¾½åç«¯æ¶æ„å›¢é˜Ÿ
**æœ€åæ›´æ–°**: 2025-01-06
