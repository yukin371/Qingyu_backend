# 测试架构设计规范

**版本**: v2.0
**更新**: 2026-01-08
**状态**: ✅ 正式实施

---

## 一、测试金字塔

```
           ┌─────────────┐
           │   E2E Tests │  (10%)
           │  端到端测试  │
           └─────────────┘
         ┌─────────────────┐
         │ Integration Tests│  (30%)
         │    集成测试       │
         └─────────────────┘
     ┌─────────────────────────┐
     │      Unit Tests         │  (60%)
     │       单元测试           │
     └─────────────────────────┘
```

**分层原则**：
- **单元测试（60%）**：快速、隔离、大量
- **集成测试（30%）**：关键流程、跨层交互
- **E2E测试（10%）**：核心业务场景

---

## 二、单元测试

### 2.1 位置和命名

**位置**：与被测代码同目录
**命名**：`{filename}_test.go`

**示例**：
```
service/bookstore/bookstore_service.go
service/bookstore/bookstore_service_test.go
```

### 2.2 测试结构

```go
package bookstore

import (
    "testing"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"
)

func TestBookstoreService_GetBooks(t *testing.T) {
    // Arrange
    mockRepo := new(MockBookRepository)
    service := NewBookstoreService(mockRepo)

    mockRepo.On("FindWithFilter", mock.Anything, mock.Anything).Return(books, int64(10), nil)

    // Act
    result, total, err := service.GetBooks(context.Background(), 1, 20)

    // Assert
    assert.NoError(t, err)
    assert.NotNil(t, result)
    assert.Equal(t, int64(10), total)
    mockRepo.AssertExpectations(t)
}
```

### 2.3 Mock使用

**统一Mock接口**：
```go
import testMock "Qingyu_backend/service/mock"

mockRepo := new(testMock.MockBookRepository)
```

**设置期望**：
```go
mockRepo.On("GetByID", mock.Anything, "book123").Return(book, nil)
mockRepo.On("GetByID", mock.Anything, "invalid").Return(nil, errors.New("not found"))
```

---

## 三、集成测试

### 3.1 位置和命名

**位置**：`test/integration/`
**命名**：
- 场景测试：`scenario_{module}_test.go`
- 流程测试：`{module}_flow_test.go`
- API测试：`{module}_api_test.go`

### 3.2 TestHelper使用

```go
helper := integration.NewTestHelper(t, router)

// 认证
token := helper.LoginTestUser()

// 请求
w := helper.DoAuthRequest("POST", "/api/v1/books", reqBody, token)

// 断言
response := helper.AssertSuccess(w, 201, "创建失败")
```

### 3.3 测试场景

**完整业务流程**：
```go
func TestBookPurchaseFlow(t *testing.T) {
    helper := integration.NewTestHelper(t, router)
    token := helper.LoginTestUser()

    // 1. 浏览书籍
    w := helper.DoRequest("GET", "/api/v1/books", nil, "")
    books := helper.AssertSuccess(w, 200, "获取书籍失败")

    // 2. 查看详情
    bookID := books[0]["id"].(string)
    w = helper.DoRequest("GET", "/api/v1/books/"+bookID, nil, "")
    helper.AssertSuccess(w, 200, "获取详情失败")

    // 3. 加入书架
    reqBody := map[string]interface{}{"book_id": bookID}
    w = helper.DoAuthRequest("POST", "/api/v1/reader/bookshelf", reqBody, token)
    helper.AssertSuccess(w, 201, "加入书架失败")

    // 4. 购买章节
    w = helper.DoAuthRequest("POST", "/api/v1/books/"+bookID+"/chapters/1/purchase", nil, token)
    helper.AssertSuccess(w, 200, "购买失败")
}
```

---

## 四、测试覆盖

### 4.1 覆盖率目标

| 层次 | 目标覆盖率 | 优先级 |
|------|-----------|--------|
| Repository层 | ≥80% | P0 |
| Service层 | ≥80% | P0 |
| API层 | ≥60% | P1 |
| 核心业务 | 100% | P0 |

### 4.2 覆盖率检查

**生成覆盖率报告**：
```bash
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out -o coverage.html
```

**查看覆盖率**：
```bash
go test -cover ./...
```

---

## 五、测试规范

### 5.1 AAA模式

```go
func TestExample(t *testing.T) {
    // Arrange（准备）
    input := "test"
    expected := "TEST"

    // Act（执行）
    result := strings.ToUpper(input)

    // Assert（断言）
    assert.Equal(t, expected, result)
}
```

### 5.2 表格驱动测试

```go
func TestValidateEmail(t *testing.T) {
    tests := []struct {
        name    string
        email   string
        wantErr bool
    }{
        {"valid email", "test@example.com", false},
        {"invalid email", "invalid", true},
        {"empty email", "", true},
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            err := ValidateEmail(tt.email)
            if tt.wantErr {
                assert.Error(t, err)
            } else {
                assert.NoError(t, err)
            }
        })
    }
}
```

### 5.3 测试命名

**清晰表达测试意图**：
- ✅ `TestUserService_CreateUser_Success`
- ✅ `TestUserService_CreateUser_DuplicateEmail_ReturnError`
- ❌ `TestUserService1`

---

## 六、Mock规范

### 6.1 使用统一Mock

**位置**：`service/mock/`

**导入**：
```go
import testMock "Qingyu_backend/service/mock"
```

**使用**：
```go
mockRepo := new(testMock.MockBookRepository)
```

### 6.2 Mock期望

**设置期望**：
```go
mockRepo.On("GetByID", mock.Anything, "book123").Return(book, nil).Once()
```

**验证调用**：
```go
mockRepo.AssertCalled(t, "GetByID", mock.Anything, "book123")
mockRepo.AssertNumberOfCalls(t, "GetByID", 1)
mockRepo.AssertExpectations(t)
```

---

## 七、测试数据

### 7.1 测试数据管理

**使用test_helper**：
```go
helper.GetTestBook()
helper.GetTestUser()
helper.CreateTestBook(book)
helper.CleanupTestData()
```

### 7.2 数据隔离

**每个测试独立**：
```go
func TestExample(t *testing.T) {
    // Setup
    testDB := setupTestDB()
    defer cleanupTestDB(testDB)

    // Test
    // ...
}
```

---

## 八、性能测试

### 8.1 基准测试

```go
func BenchmarkBookService_GetBooks(b *testing.B) {
    service := setupService()

    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        service.GetBooks(context.Background(), 1, 20)
    }
}
```

**运行基准测试**：
```bash
go test -bench=. -benchmem
```

### 8.2 性能指标

**响应时间**：
- P50 < 100ms
- P95 < 500ms
- P99 < 1000ms

**并发测试**：
```go
func TestConcurrentAccess(t *testing.T) {
    service := setupService()
    var wg sync.WaitGroup

    for i := 0; i < 100; i++ {
        wg.Add(1)
        go func() {
            defer wg.Done()
            service.GetBooks(context.Background(), 1, 20)
        }()
    }

    wg.Wait()
}
```

---

## 九、测试CI/CD

### 9.1 GitHub Actions

```yaml
name: Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Run tests
        run: |
          go test -v -race -coverprofile=coverage.out ./...
          go tool cover -html=coverage.out -o coverage.html

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.out
```

### 9.2 测试检查

**PR前检查**：
- 所有测试通过
- 覆盖率不下降
- 无竞态条件

---

## 十、最佳实践

### 10.1 测试原则

✅ **推荐**：
- 测试行为而非实现
- 保持测试简单
- 测试应该快速
- 测试应该独立
- 使用有意义的断言消息

❌ **避免**：
- 测试私有方法
- 测试第三方库
- 脆弱的测试
- 重复的测试代码
- 过度使用Mock

### 10.2 测试维护

**定期Review**：
- 删除过时的测试
- 合并重复的测试
- 更新测试数据
- 优化慢速测试

**持续改进**：
- 监控测试覆盖率
- 分析测试失败原因
- 优化测试执行时间
- 改进测试质量

---

**相关文档**：
- [架构设计规范](../architecture/架构设计规范.md)
- [工程规范](../engineering/软件工程规范.md)
