# 监控指标使用指南

> **文档版本**: v1.0
> **创建日期**: 2025-01-06
> **适用范围**: 青羽平台所有模块

## 📋 概述

本文档说明如何在业务代码中使用Prometheus监控指标。监控指标已定义在 `pkg/metrics/metrics.go` 和 `pkg/metrics/prometheus.go` 中。

## 🎯 已定义的监控指标

### 1. HTTP请求指标

```go
// 记录HTTP请求
metrics.GetMetrics().RecordHttpRequest(
    method,      // "GET", "POST", etc.
    path,        // "/api/v1/books"
    status,      // 200, 400, 500, etc.
    duration,    // 请求耗时
    requestSize, // 请求大小（字节）
    responseSize,// 响应大小（字节）
)
```

**自动记录**：已在 `PrometheusMiddleware` 中自动记录

### 2. 数据库连接池指标

```go
// 更新数据库连接池指标
metrics.GetMetrics().UpdateDbPoolMetrics(
    database,     // "mongodb", "redis"
    total,        // 总连接数
    idle,         // 空闲连接数
    waitDuration, // 等待连接的时长
)

// 记录数据库查询
metrics.GetMetrics().RecordDbQuery(
    database,   // "mongodb"
    operation,  // "find", "insert", "update", "delete"
    duration,   // 查询耗时
    success,    // 是否成功
)
```

**手动记录**：需要在数据库操作后调用

### 3. 缓存指标

```go
// 记录缓存命中
metrics.GetMetrics().RecordCacheHit("redis")

// 记录缓存未命中
metrics.GetMetrics().RecordCacheMiss("redis")

// 记录缓存操作
metrics.GetMetrics().RecordCacheOperation("redis", "get", duration)
```

### 4. 业务指标

#### 用户指标

```go
// 记录用户注册
metrics.GetMetrics().RecordUserRegistration("email")    // 来源：email, phone, oauth
metrics.GetMetrics().RecordUserLogin("password")      // 方式：password, oauth
```

#### 书籍指标

```go
// 记录书籍发布
metrics.GetMetrics().RecordBookPublish("novel")       // 分类：novel, prose, poetry等

// 记录书籍更新
metrics.GetMetrics().RecordBookUpdate("novel")

// 记录章节发布
metrics.GetMetrics().RecordChapterPublish("draft")    // 状态：draft, published
```

#### 内容阅读指标

```go
// 记录内容阅读
metrics.GetMetrics().RecordContentRead("chapter")     // 类型：chapter, book, article
```

#### 社交指标

```go
// 记录评论创建
metrics.GetMetrics().RecordCommentCreate("book")      // 类型：book, chapter, review
```

#### 支付指标

```go
// 记录支付成功
metrics.GetMetrics().RecordPaymentSuccess("chapter")  // 类型：chapter, vip, wallet

// 记录支付失败
metrics.GetMetrics().RecordPaymentFailed("chapter", "insufficient_balance")
```

#### VIP订阅指标

```go
// 记录VIP订阅
metrics.GetMetrics().RecordVipSubscription("month", "30")  // plan, duration
```

### 5. 系统资源指标

```go
// 更新系统内存
metrics.GetMetrics().UpdateSystemMemory(used, total)

// 更新系统CPU
metrics.GetMetrics().UpdateSystemCPU(45.5)  // 百分比

// 更新goroutine数量
metrics.GetMetrics().UpdateGoroutineCount(1250)
```

## 🔧 集成示例

### 示例1：在API中使用业务指标

```go
package api

import (
    "qingyu/pkg/metrics"
    "github.com/gin-gonic/gin"
)

type BookAPI struct {
    bookService service.BookService
}

func (api *BookAPI) CreateBook(c *gin.Context) {
    var req CreateBookRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        shared.BadRequest(c, "参数错误", err.Error())
        return
    }

    // 创建书籍
    book, err := api.bookService.CreateBook(c, &req)
    if err != nil {
        shared.InternalError(c, "创建书籍失败", err)
        return
    }

    // 📊 记录业务指标：书籍发布
    metrics.GetMetrics().RecordBookPublish(string(book.Category))

    shared.Success(c, http.StatusOK, "创建成功", book)
}
```

### 示例2：在Service中使用数据库指标

```go
package service

import (
    "qingyu/pkg/metrics"
    "context"
    "time"
)

type BookService struct {
    repo repository.BookRepository
    ctx  context.Context
}

func (s *BookService) GetBook(id string) (*Book, error) {
    start := time.Now()
    book, err := s.repo.FindByID(s.ctx, id)
    duration := time.Since(start)

    // 📊 记录数据库查询指标
    metrics.GetMetrics().RecordDbQuery("mongodb", "find", duration, err == nil)

    if err != nil {
        return nil, err
    }
    return book, nil
}
```

### 示例3：在Repository中使用缓存指标

```go
package repository

import (
    "qingyu/pkg/metrics"
    "context"
    "time"
)

type BookRepository struct {
    cache *redis.Client
    mongo *mongo.Client
}

func (r *BookRepository) FindByID(ctx context.Context, id string) (*Book, error) {
    start := time.Now()

    // 先查缓存
    val, err := r.cache.Get(ctx, "book:"+id).Result()
    if err == nil {
        // 📊 记录缓存命中
        metrics.GetMetrics().RecordCacheHit("redis")
        metrics.GetMetrics().RecordCacheOperation("redis", "get", time.Since(start))
        return unmarshalBook(val)
    }

    // 📊 记录缓存未命中
    metrics.GetMetrics().RecordCacheMiss("redis")

    // 查数据库
    book, err := r.findFromMongo(ctx, id)
    if err != nil {
        return nil, err
    }

    // 写入缓存
    r.cache.Set(ctx, "book:"+id, marshalBook(book), time.Hour)
    return book, nil
}
```

### 示例4：在支付API中使用支付指标

```go
package api

import (
    "qingyu/pkg/metrics"
    "github.com/gin-gonic/gin"
)

type PaymentAPI struct {
    walletService service.WalletService
}

func (api *PaymentAPI) PurchaseChapter(c *gin.Context) {
    var req PurchaseRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        shared.BadRequest(c, "参数错误", err.Error())
        return
    }

    // 执行支付
    err := api.walletService.PurchaseChapter(c, req.ChapterID, req.UserID)
    if err != nil {
        // 📊 记录支付失败
        metrics.GetMetrics().RecordPaymentFailed("chapter", err.Error())
        shared.InternalError(c, "支付失败", err)
        return
    }

    // 📊 记录支付成功
    metrics.GetMetrics().RecordPaymentSuccess("chapter")

    shared.Success(c, http.StatusOK, "购买成功", nil)
}
```

### 示例5：创建定时任务更新系统指标

```go
package main

import (
    "qingyu/pkg/metrics"
    "runtime"
    "time"
)

func StartMetricsCollector() {
    ticker := time.NewTicker(10 * time.Second)
    go func() {
        for range ticker.C {
            collectSystemMetrics()
        }
    }()
}

func collectSystemMetrics() {
    var m runtime.MemStats
    runtime.ReadMemStats(&m)

    // 更新内存使用
    metrics.GetMetrics().UpdateSystemMemory(m.HeapInuse, m.HeapSys)

    // 更新goroutine数量
    metrics.GetMetrics().UpdateGoroutineCount(runtime.NumGoroutine())
}
```

## 📊 在main.go中集成

```go
package main

import (
    "qingyu/pkg/metrics"
    "qingyu/pkg/middleware"
    "github.com/gin-gonic/gin"
)

func main() {
    // 1. 初始化监控指标
    metrics.GetMetrics() // 初始化全局指标实例

    // 2. 启动系统指标收集器
    go StartMetricsCollector()

    // 3. 创建路由
    router := gin.Default()

    // 4. 应用监控中间件
    router.Use(
        middleware.PrometheusMiddleware(),  // 自动记录HTTP请求指标
        // ... 其他中间件
    )

    // 5. 注册监控端点
    router.GET("/metrics", metrics.GinMetricsHandler())

    // 6. 启动服务
    router.Run(":8080")
}
```

## 🔍 查看监控指标

### 通过curl查看

```bash
# 查看所有指标
curl http://localhost:8080/metrics

# 查看特定指标
curl http://localhost:8080/metrics | grep user_registrations_total
curl http://localhost:8080/metrics | grep book_publish_total
curl http://localhost:8080/metrics | grep db_query_duration_seconds
```

### 在Grafana中查看

推荐创建以下Dashboard面板：

1. **HTTP请求面板**
   - `http_requests_total`: HTTP请求总数
   - `http_request_duration_seconds`: HTTP请求响应时间

2. **数据库面板**
   - `db_pool_connections`: 数据库连接数
   - `db_query_duration_seconds`: 数据库查询耗时
   - `db_queries_total`: 数据库查询总数

3. **缓存面板**
   - `cache_hits_total`: 缓存命中数
   - `cache_misses_total`: 缓存未命中数
   - 计算缓存命中率：`cache_hits_total / (cache_hits_total + cache_misses_total)`

4. **业务面板**
   - `user_registrations_total`: 用户注册数
   - `book_publish_total`: 书籍发布数
   - `payment_success_total`: 支付成功数

5. **系统资源面板**
   - `system_memory_usage_bytes`: 内存使用
   - `system_cpu_usage_percent`: CPU使用
   - `goroutine_count`: Goroutine数量

## 📈 告警规则示例

### Prometheus告警规则

```yaml
# prometheus-alerts.yml
groups:
  - name: qingyu_alerts
    interval: 30s
    rules:
      # 高错误率告警
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "API错误率过高"
          description: "{{ $labels.path }} 错误率超过5%"

      # 慢查询告警
      - alert: SlowDatabaseQuery
        expr: histogram_quantile(0.95, db_query_duration_seconds) > 1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "数据库查询过慢"
          description: "{{ $labels.collection }} 95%查询耗时超过1秒"

      # 内存使用告警
      - alert: HighMemoryUsage
        expr: system_memory_usage_bytes{type="used"} / system_memory_usage_bytes{type="total"} > 0.9
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "内存使用率过高"
          description: "内存使用率超过90%"

      # 支付失败率告警
      - alert: HighPaymentFailureRate
        expr: rate(payment_failed_total[5m]) / rate(payment_success_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "支付失败率过高"
          description: "支付失败率超过10%"
```

## ✅ 检查清单

在使用监控指标时，请确保：

- [ ] HTTP请求指标由中间件自动记录
- [ ] 数据库查询在关键操作后记录
- [ ] 缓存命中/未命中正确记录
- [ ] 业务指标在关键操作后记录
- [ ] 系统指标由定时任务定期更新
- [ ] Prometheus正确抓取/metrics端点
- [ ] Grafana Dashboard配置完整
- [ ] 告警规则配置合理

---

**文档维护**: 青羽后端架构团队
**最后更新**: 2025-01-06
