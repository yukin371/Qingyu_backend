# æµ‹è¯•æœ€ä½³å®è·µ

**ç‰ˆæœ¬**: 1.0  
**æ›´æ–°æ—¥æœŸ**: 2025-10-17  
**ç»´æŠ¤è€…**: é’ç¾½åç«¯å›¢é˜Ÿ

---

## ğŸ“– æ¦‚è¿°

æœ¬æ–‡æ¡£æ±‡æ€»é’ç¾½åç«¯æµ‹è¯•çš„æœ€ä½³å®è·µã€å¸¸è§é™·é˜±å’Œè§£å†³æ–¹æ¡ˆï¼Œå¸®åŠ©å›¢é˜Ÿç¼–å†™é«˜è´¨é‡çš„æµ‹è¯•ä»£ç ã€‚

---

## 1. æµ‹è¯•é‡‘å­—å¡”åŸåˆ™

```
        /\
       /  \      E2E Tests (å°‘é‡)
      /â”€â”€â”€â”€\     
     /      \    Integration Tests (é€‚é‡)
    /â”€â”€â”€â”€â”€â”€â”€â”€\   
   /          \  Unit Tests (å¤§é‡)
  /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\ 
```

### æ¨èæ¯”ä¾‹

- **å•å…ƒæµ‹è¯•**: 70%
- **é›†æˆæµ‹è¯•**: 20%
- **ç«¯åˆ°ç«¯æµ‹è¯•**: 10%

### åŸå› 

- å•å…ƒæµ‹è¯•å¿«é€Ÿã€ç¨³å®šã€æ˜“è°ƒè¯•
- é›†æˆæµ‹è¯•è¦†ç›–ç»„ä»¶äº¤äº’
- ç«¯åˆ°ç«¯æµ‹è¯•éªŒè¯ç”¨æˆ·æµç¨‹

---

## 2. æµ‹è¯•å‘½åè§„èŒƒ

### âœ… å¥½çš„å‘½å

```go
// æ¨¡å¼ï¼šTestServiceName_MethodName_Scenario_ExpectedResult
func TestUserService_Register_WithValidData_ReturnsUser(t *testing.T) {}
func TestUserService_Register_WithDuplicateEmail_ReturnsError(t *testing.T) {}
func TestUserService_Login_WithInvalidPassword_ReturnsAuthError(t *testing.T) {}

// é›†æˆæµ‹è¯•
func TestUserRepository_Create_Integration(t *testing.T) {}

// ç«¯åˆ°ç«¯æµ‹è¯•
func TestE2E_UserRegistrationAndLogin(t *testing.T) {}

// åŸºå‡†æµ‹è¯•
func BenchmarkUserService_Register(b *testing.B) {}
```

### âŒ ä¸å¥½çš„å‘½å

```go
func TestRegister(t *testing.T) {}         // å¤ªæ¨¡ç³Š
func Test1(t *testing.T) {}               // æ— æ„ä¹‰
func TestUserServiceRegister(t *testing.T) {} // ç¼ºå°‘åœºæ™¯æè¿°
```

---

## 3. AAAæµ‹è¯•æ¨¡å¼

### Arrange - Act - Assert

```go
func TestUserService_Register_Success(t *testing.T) {
    // ===== Arrange (å‡†å¤‡) =====
    mockRepo := new(MockUserRepository)
    service := NewUserService(mockRepo)
    
    req := &RegisterRequest{
        Username: "testuser",
        Email:    "test@example.com",
        Password: "password123",
    }
    
    mockRepo.On("Create", mock.Anything).Return(nil)
    
    // ===== Act (æ‰§è¡Œ) =====
    resp, err := service.Register(context.Background(), req)
    
    // ===== Assert (æ–­è¨€) =====
    assert.NoError(t, err)
    assert.NotNil(t, resp)
    assert.Equal(t, "testuser", resp.Username)
    mockRepo.AssertExpectations(t)
}
```

---

## 4. Mockä½¿ç”¨æœ€ä½³å®è·µ

### 4.1 ä½¿ç”¨æ¥å£

âœ… **DO**:
```go
// å®šä¹‰æ¥å£
type UserRepository interface {
    Create(ctx context.Context, user *User) error
    GetByEmail(ctx context.Context, email string) (*User, error)
}

// Serviceä¾èµ–æ¥å£
type UserService struct {
    repo UserRepository  // æ¥å£ç±»å‹
}

// æµ‹è¯•æ—¶Mockæ¥å£
type MockUserRepository struct {
    mock.Mock
}
```

âŒ **DON'T**:
```go
// Serviceç›´æ¥ä¾èµ–å…·ä½“å®ç°
type UserService struct {
    repo *MongoUserRepository  // å…·ä½“ç±»å‹ï¼Œéš¾ä»¥æµ‹è¯•
}
```

### 4.2 ç²¾ç¡®çš„MockæœŸæœ›

âœ… **DO**:
```go
// ç²¾ç¡®åŒ¹é…å‚æ•°
mockRepo.On("Create", mock.MatchedBy(func(user *User) bool {
    return user.Email == "test@example.com" &&
           user.Username == "testuser"
})).Return(nil)

// éªŒè¯è°ƒç”¨æ¬¡æ•°
mockRepo.AssertNumberOfCalls(t, "Create", 1)
```

âŒ **DON'T**:
```go
// è¿‡äºå®½æ¾çš„åŒ¹é…
mockRepo.On("Create", mock.Anything).Return(nil)  // ä»»ä½•å‚æ•°éƒ½æ¥å—
```

### 4.3 æ¸…ç†Mock

```go
func TestUserService_MultipleTests(t *testing.T) {
    tests := []struct {
        name string
        test func(*testing.T)
    }{
        {"Test1", testCase1},
        {"Test2", testCase2},
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            // æ¯ä¸ªå­æµ‹è¯•åˆ›å»ºæ–°çš„Mock
            mockRepo := new(MockUserRepository)
            defer mockRepo.AssertExpectations(t)
            
            tt.test(t)
        })
    }
}
```

---

## 5. è¡¨é©±åŠ¨æµ‹è¯•

### âœ… å¥½çš„è¡¨é©±åŠ¨æµ‹è¯•

```go
func TestUserService_Register_ValidationErrors(t *testing.T) {
    tests := []struct {
        name        string
        request     *RegisterRequest
        expectError string
    }{
        {
            name: "ç©ºç”¨æˆ·å",
            request: &RegisterRequest{
                Username: "",
                Email:    "test@example.com",
                Password: "password123",
            },
            expectError: "ç”¨æˆ·åä¸èƒ½ä¸ºç©º",
        },
        {
            name: "æ— æ•ˆé‚®ç®±æ ¼å¼",
            request: &RegisterRequest{
                Username: "testuser",
                Email:    "invalid-email",
                Password: "password123",
            },
            expectError: "é‚®ç®±æ ¼å¼æ— æ•ˆ",
        },
        {
            name: "å¯†ç å¤ªçŸ­",
            request: &RegisterRequest{
                Username: "testuser",
                Email:    "test@example.com",
                Password: "123",
            },
            expectError: "å¯†ç è‡³å°‘6ä½",
        },
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            // Arrange
            service := NewUserService(nil)
            
            // Act
            _, err := service.Register(context.Background(), tt.request)
            
            // Assert
            assert.Error(t, err)
            assert.Contains(t, err.Error(), tt.expectError)
        })
    }
}
```

### ä¼˜åŠ¿

- âœ… å‡å°‘ä»£ç é‡å¤
- âœ… æ˜“äºæ·»åŠ æ–°æµ‹è¯•ç”¨ä¾‹
- âœ… æµ‹è¯•ç”¨ä¾‹æ¸…æ™°å¯è¯»
- âœ… å¤±è´¥æ—¶å‡†ç¡®å®šä½é—®é¢˜

---

## 6. æµ‹è¯•éš”ç¦»

### 6.1 æ•°æ®éš”ç¦»

âœ… **DO**:
```go
func TestUserRepository_Create(t *testing.T) {
    // æ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®
    user := &User{
        ID:       uuid.New(),  // å”¯ä¸€ID
        Username: "testuser_" + uuid.New().String(),  // å”¯ä¸€ç”¨æˆ·å
        Email:    fmt.Sprintf("test_%s@example.com", uuid.New().String()),
    }
    
    err := repo.Create(context.Background(), user)
    assert.NoError(t, err)
    
    // æµ‹è¯•ç»“æŸåæ¸…ç†
    defer repo.Delete(context.Background(), user.ID)
}
```

âŒ **DON'T**:
```go
// å¤šä¸ªæµ‹è¯•å…±äº«ç›¸åŒæ•°æ®
var globalUser = &User{
    Username: "testuser",  // å›ºå®šå€¼ä¼šå†²çª
    Email:    "test@example.com",
}
```

### 6.2 çŠ¶æ€éš”ç¦»

âœ… **DO**:
```go
func TestService_Method(t *testing.T) {
    // æ¯ä¸ªæµ‹è¯•åˆ›å»ºæ–°å®ä¾‹
    service := NewService()
    // æµ‹è¯•é€»è¾‘
}
```

âŒ **DON'T**:
```go
// å…¨å±€å˜é‡ä¼šå¯¼è‡´æµ‹è¯•ç›¸äº’å½±å“
var globalService = NewService()

func TestService_Method1(t *testing.T) {
    globalService.DoSomething()  // ä¿®æ”¹å…¨å±€çŠ¶æ€
}

func TestService_Method2(t *testing.T) {
    // ä¾èµ–Method1çš„çŠ¶æ€ï¼Œä¸ç¨³å®š
}
```

---

## 7. æµ‹è¯•æ•°æ®ç®¡ç†

### 7.1 ä½¿ç”¨å·¥å‚æ¨¡å¼

```go
// test/fixtures/user_factory.go
type UserFactory struct {
    counter int
}

func NewUserFactory() *UserFactory {
    return &UserFactory{counter: 0}
}

func (f *UserFactory) Create() *User {
    f.counter++
    return &User{
        ID:       uuid.New(),
        Username: fmt.Sprintf("user%d", f.counter),
        Email:    fmt.Sprintf("user%d@example.com", f.counter),
        Status:   "active",
    }
}

func (f *UserFactory) CreateAdmin() *User {
    user := f.Create()
    user.Role = "admin"
    return user
}

func (f *UserFactory) CreateBatch(count int) []*User {
    users := make([]*User, count)
    for i := 0; i < count; i++ {
        users[i] = f.Create()
    }
    return users
}
```

### 7.2 ä½¿ç”¨Builderæ¨¡å¼

```go
type UserBuilder struct {
    user *User
}

func NewUserBuilder() *UserBuilder {
    return &UserBuilder{
        user: &User{
            ID:     uuid.New(),
            Status: "active",
        },
    }
}

func (b *UserBuilder) WithUsername(username string) *UserBuilder {
    b.user.Username = username
    return b
}

func (b *UserBuilder) WithEmail(email string) *UserBuilder {
    b.user.Email = email
    return b
}

func (b *UserBuilder) AsAdmin() *UserBuilder {
    b.user.Role = "admin"
    return b
}

func (b *UserBuilder) Build() *User {
    return b.user
}

// ä½¿ç”¨
user := NewUserBuilder().
    WithUsername("testuser").
    WithEmail("test@example.com").
    AsAdmin().
    Build()
```

---

## 8. é”™è¯¯å¤„ç†æµ‹è¯•

### 8.1 æµ‹è¯•æ‰€æœ‰é”™è¯¯è·¯å¾„

```go
func TestUserService_Register(t *testing.T) {
    tests := []struct {
        name        string
        setup       func(*MockUserRepository)
        expectError bool
        errorMsg    string
    }{
        {
            name: "æˆåŠŸæ³¨å†Œ",
            setup: func(m *MockUserRepository) {
                m.On("ExistsByEmail", mock.Anything).Return(false, nil)
                m.On("Create", mock.Anything).Return(nil)
            },
            expectError: false,
        },
        {
            name: "é‚®ç®±å·²å­˜åœ¨",
            setup: func(m *MockUserRepository) {
                m.On("ExistsByEmail", mock.Anything).Return(true, nil)
            },
            expectError: true,
            errorMsg:    "é‚®ç®±å·²è¢«æ³¨å†Œ",
        },
        {
            name: "æ•°æ®åº“é”™è¯¯",
            setup: func(m *MockUserRepository) {
                m.On("ExistsByEmail", mock.Anything).Return(false, errors.New("db error"))
            },
            expectError: true,
            errorMsg:    "db error",
        },
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            mockRepo := new(MockUserRepository)
            tt.setup(mockRepo)
            
            service := NewUserService(mockRepo)
            _, err := service.Register(context.Background(), &RegisterRequest{})
            
            if tt.expectError {
                assert.Error(t, err)
                assert.Contains(t, err.Error(), tt.errorMsg)
            } else {
                assert.NoError(t, err)
            }
        })
    }
}
```

---

## 9. å¹¶å‘æµ‹è¯•

### 9.1 æµ‹è¯•ç«æ€æ¡ä»¶

```go
func TestCache_ConcurrentAccess(t *testing.T) {
    cache := NewCache()
    
    // å¹¶å‘å†™å…¥
    var wg sync.WaitGroup
    for i := 0; i < 100; i++ {
        wg.Add(1)
        go func(key int) {
            defer wg.Done()
            cache.Set(fmt.Sprintf("key%d", key), key)
        }(i)
    }
    wg.Wait()
    
    // å¹¶å‘è¯»å–
    for i := 0; i < 100; i++ {
        wg.Add(1)
        go func(key int) {
            defer wg.Done()
            val, _ := cache.Get(fmt.Sprintf("key%d", key))
            assert.Equal(t, key, val)
        }(i)
    }
    wg.Wait()
}
```

### 9.2 ä½¿ç”¨ç«æ€æ£€æµ‹å™¨

```bash
# è¿è¡Œæµ‹è¯•æ—¶å¯ç”¨ç«æ€æ£€æµ‹
go test -race ./...

# åœ¨CI/CDä¸­å¼ºåˆ¶ä½¿ç”¨
go test -race -short ./...
```

---

## 10. æµ‹è¯•è¦†ç›–ç‡

### 10.1 ç›®æ ‡è¦†ç›–ç‡

| ç»„ä»¶ | æœ€ä½è¦†ç›–ç‡ | æ¨èè¦†ç›–ç‡ |
|------|----------|----------|
| æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ | 80% | 90%+ |
| Serviceå±‚ | 75% | 85% |
| Repositoryå±‚ | 70% | 85% |
| APIå±‚ | 60% | 75% |
| å·¥å…·å‡½æ•° | 80% | 95% |

### 10.2 ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

```bash
# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
go test -coverprofile=coverage.out ./...

# æŸ¥çœ‹è¦†ç›–ç‡
go tool cover -func=coverage.out

# ç”ŸæˆHTMLæŠ¥å‘Š
go tool cover -html=coverage.out -o coverage.html

# åªæ˜¾ç¤ºæœªè¦†ç›–çš„ä»£ç 
go tool cover -html=coverage.out | grep -v "100.0%"
```

### 10.3 è¦†ç›–ç‡ä¸æ˜¯ä¸€åˆ‡

âš ï¸ **è­¦å‘Š**ï¼š
- 100%è¦†ç›–ç‡ â‰  æ²¡æœ‰bug
- å…³æ³¨æµ‹è¯•è´¨é‡ï¼Œä¸åªæ˜¯æ•°é‡
- æµ‹è¯•è¾¹ç•Œæ¡ä»¶å’Œé”™è¯¯è·¯å¾„

---

## 11. å¸¸è§é™·é˜±å’Œè§£å†³æ–¹æ¡ˆ

### 11.1 æ—¶é—´ä¾èµ–

âŒ **é—®é¢˜**:
```go
func TestCreateUser(t *testing.T) {
    user := CreateUser()
    
    // è¿™ä¸ªæµ‹è¯•ä¼šåœ¨è·¨åˆå¤œæ—¶å¤±è´¥
    assert.Equal(t, time.Now().Day(), user.CreatedAt.Day())
}
```

âœ… **è§£å†³**:
```go
// ä½¿ç”¨æ—¶é—´æ³¨å…¥
type Clock interface {
    Now() time.Time
}

type UserService struct {
    clock Clock
}

// æµ‹è¯•æ—¶ä½¿ç”¨å›ºå®šæ—¶é’Ÿ
type FixedClock struct {
    fixedTime time.Time
}

func (c *FixedClock) Now() time.Time {
    return c.fixedTime
}
```

### 11.2 éšæœºæ€§

âŒ **é—®é¢˜**:
```go
func TestRandomFunction(t *testing.T) {
    result := GenerateRandomString(10)
    assert.Equal(t, "randomtext", result)  // ä¸ç¨³å®š
}
```

âœ… **è§£å†³**:
```go
// æ³¨å…¥éšæœºæº
func GenerateRandomString(length int, rand *rand.Rand) string {
    // ä½¿ç”¨æ³¨å…¥çš„éšæœºæº
}

// æµ‹è¯•æ—¶ä½¿ç”¨å›ºå®šç§å­
func TestRandomFunction(t *testing.T) {
    rand := rand.New(rand.NewSource(42))  // å›ºå®šç§å­
    result := GenerateRandomString(10, rand)
    assert.Equal(t, "expectedval", result)
}
```

### 11.3 å¤–éƒ¨ä¾èµ–

âŒ **é—®é¢˜**:
```go
func TestSendEmail(t *testing.T) {
    // ä¾èµ–çœŸå®çš„é‚®ä»¶æœåŠ¡ï¼Œä¸ç¨³å®š
    err := SendEmail("test@example.com", "subject", "body")
    assert.NoError(t, err)
}
```

âœ… **è§£å†³**:
```go
// ä½¿ç”¨Mock
type EmailService interface {
    Send(to, subject, body string) error
}

type MockEmailService struct {
    mock.Mock
}

func (m *MockEmailService) Send(to, subject, body string) error {
    args := m.Called(to, subject, body)
    return args.Error(0)
}
```

---

## 12. CI/CDé›†æˆ

### 12.1 GitHub Actionsç¤ºä¾‹

```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v2
      
      - name: Setup Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.21
      
      - name: Cache dependencies
        uses: actions/cache@v2
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
      
      - name: Run tests
        run: |
          go test -v -race -coverprofile=coverage.out ./...
          go tool cover -func=coverage.out
      
      - name: Upload coverage
        uses: codecov/codecov-action@v2
        with:
          files: ./coverage.out
          flags: unittests
```

---

## 13. æµ‹è¯•æ–‡æ¡£

### 13.1 æ–‡æ¡£åŒ–å¤æ‚æµ‹è¯•

```go
// TestUserService_Register_ComplexScenario æµ‹è¯•ç”¨æˆ·æ³¨å†Œçš„å¤æ‚åœºæ™¯
//
// æµ‹è¯•æ­¥éª¤ï¼š
// 1. éªŒè¯é‚®ç®±å”¯ä¸€æ€§æ£€æŸ¥
// 2. å¯†ç åŠ å¯†
// 3. åˆ›å»ºç”¨æˆ·è®°å½•
// 4. å‘é€æ¬¢è¿é‚®ä»¶
// 5. åˆ›å»ºåˆå§‹é’±åŒ…
//
// é¢„æœŸç»“æœï¼š
// - ç”¨æˆ·æˆåŠŸåˆ›å»º
// - é‚®ä»¶å·²å‘é€
// - é’±åŒ…å·²åˆå§‹åŒ–ä¸º0ä½™é¢
func TestUserService_Register_ComplexScenario(t *testing.T) {
    // æµ‹è¯•å®ç°
}
```

---

## 14. æµ‹è¯•ç»´æŠ¤

### 14.1 å®šæœŸæ¸…ç†

- âœ… åˆ é™¤è¿‡æ—¶çš„æµ‹è¯•
- âœ… é‡æ„é‡å¤çš„æµ‹è¯•ä»£ç 
- âœ… æ›´æ–°æµ‹è¯•ä»¥åæ˜ ä¸šåŠ¡å˜åŒ–
- âœ… ä¿®å¤flakyæµ‹è¯•ï¼ˆä¸ç¨³å®šæµ‹è¯•ï¼‰

### 14.2 æµ‹è¯•å®¡æŸ¥æ¸…å•

- [ ] æµ‹è¯•å‘½åæ¸…æ™°æè¿°åœºæ™¯
- [ ] ä½¿ç”¨AAAæ¨¡å¼ç»„ç»‡ä»£ç 
- [ ] Mockè®¾ç½®å’ŒéªŒè¯æ­£ç¡®
- [ ] æµ‹è¯•æ•°æ®ç‹¬ç«‹ä¸”å¯é‡å¤
- [ ] è¦†ç›–æ­£å¸¸å’Œå¼‚å¸¸è·¯å¾„
- [ ] æ¸…ç†æµ‹è¯•æ•°æ®
- [ ] æ²¡æœ‰ç¡¬ç¼–ç å€¼
- [ ] æµ‹è¯•è¿è¡Œå¿«é€Ÿç¨³å®š

---

## ğŸ“š ç›¸å…³èµ„æº

- [æµ‹è¯•ç»„ç»‡è§„èŒƒ](./æµ‹è¯•ç»„ç»‡è§„èŒƒ.md)
- [APIæµ‹è¯•æŒ‡å—](./APIæµ‹è¯•æŒ‡å—.md)
- [æ€§èƒ½æµ‹è¯•è§„èŒƒ](./æ€§èƒ½æµ‹è¯•è§„èŒƒ.md)
- [å…±äº«æœåŠ¡æµ‹è¯•æ–‡æ¡£](./å…±äº«æœåŠ¡æµ‹è¯•æ–‡æ¡£.md)
- [Go Testingæ–‡æ¡£](https://golang.org/pkg/testing/)
- [Testifyæ–‡æ¡£](https://github.com/stretchr/testify)

---

**æœ€åæ›´æ–°**: 2025-10-17  
**ç»´æŠ¤è€…**: é’ç¾½åç«¯å›¢é˜Ÿ

