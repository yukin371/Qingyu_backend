# 共享服务测试文档

## 📋 文档概述

本文档详细描述了青羽平台共享底层服务的测试策略、测试用例设计和测试执行指南。共享服务包括账号权限系统、钱包系统、推荐服务、文件存储服务、消息队列服务和管理后台服务等核心模块。

## 🎯 测试目标

### 主要目标
- **功能正确性**：确保所有服务功能按照设计规范正确实现
- **性能达标**：验证服务在预期负载下的性能表现
- **安全可靠**：确保服务的安全性和数据保护机制
- **稳定性保证**：验证服务在各种异常情况下的稳定性
- **集成兼容**：确保各服务间的集成和兼容性

### 质量指标
- **代码覆盖率**：单元测试覆盖率 ≥ 80%
- **接口测试覆盖率**：API接口测试覆盖率 = 100%
- **性能指标**：响应时间 ≤ 200ms，并发处理能力 ≥ 1000 QPS
- **可用性指标**：服务可用性 ≥ 99.9%
- **错误率指标**：系统错误率 ≤ 0.1%

## 🏗️ 测试架构

### 测试层次结构
```
┌─────────────────────────────────────────────────────────┐
│                    端到端测试 (E2E)                      │
│  完整业务流程测试 + 用户场景验证                         │
├─────────────────────────────────────────────────────────┤
│                    集成测试 (Integration)               │
│  服务间集成 + 数据库集成 + 外部服务集成                  │
├─────────────────────────────────────────────────────────┤
│                    接口测试 (API)                       │
│  RESTful API + gRPC接口 + WebSocket连接                │
├─────────────────────────────────────────────────────────┤
│                    单元测试 (Unit)                      │
│  Service层 + Repository层 + Model层                    │
├─────────────────────────────────────────────────────────┤
│                    性能测试 (Performance)               │
│  压力测试 + 负载测试 + 并发测试                          │
└─────────────────────────────────────────────────────────┘
```

### 测试环境配置
- **开发环境 (Dev)**：开发人员本地测试环境
- **测试环境 (Test)**：专用测试环境，模拟生产配置
- **预发环境 (Staging)**：生产前验证环境
- **生产环境 (Prod)**：生产环境监控和验证

## 🧪 测试策略

### 1. 单元测试策略

#### 测试范围
- **Service层测试**：业务逻辑验证、异常处理、边界条件
- **Repository层测试**：数据访问逻辑、查询优化、事务处理
- **Model层测试**：数据验证、序列化反序列化、业务规则

#### 测试原则
- **隔离性**：使用Mock对象隔离外部依赖
- **可重复性**：测试结果应该可重复和一致
- **快速执行**：单个测试用例执行时间 < 100ms
- **清晰命名**：测试方法名清晰描述测试场景

#### Mock策略
```go
// 示例：使用testify/mock进行依赖隔离
type MockUserRepository struct {
    mock.Mock
}

func (m *MockUserRepository) GetByID(ctx context.Context, id primitive.ObjectID) (*User, error) {
    args := m.Called(ctx, id)
    return args.Get(0).(*User), args.Error(1)
}
```

### 2. 集成测试策略

#### 测试范围
- **数据库集成**：MongoDB连接、事务处理、数据一致性
- **缓存集成**：Redis连接、缓存策略、数据同步
- **消息队列集成**：Kafka消息发送接收、消费者组管理
- **外部服务集成**：第三方API调用、服务降级

#### 测试环境
- **容器化测试**：使用Docker Compose搭建测试环境
- **数据隔离**：每个测试用例使用独立的测试数据
- **环境清理**：测试完成后自动清理测试数据

### 3. 接口测试策略

#### 测试工具
- **单元测试框架**：Go testing + testify
- **HTTP测试**：httptest包进行API测试
- **gRPC测试**：grpc-go测试工具
- **WebSocket测试**：gorilla/websocket测试

#### 测试内容
- **请求参数验证**：必填参数、参数格式、参数范围
- **响应格式验证**：响应结构、数据类型、状态码
- **业务逻辑验证**：业务规则、数据处理、状态变更
- **异常处理验证**：错误码、错误信息、异常恢复

### 4. 性能测试策略

#### 测试类型
- **压力测试**：测试系统在极限负载下的表现
- **负载测试**：测试系统在预期负载下的性能
- **并发测试**：测试系统的并发处理能力
- **稳定性测试**：长时间运行的稳定性验证

#### 测试工具
- **Go基准测试**：使用go test -bench进行性能测试
- **压力测试工具**：使用wrk、ab等工具进行压力测试
- **监控工具**：使用pprof进行性能分析

## 📊 各服务测试用例

### 1. 账号权限系统测试

#### 1.1 用户注册测试
```go
// 测试用例：用户注册成功
func TestAuthService_Register_Success(t *testing.T) {
    // 测试数据准备
    username := "testuser"
    email := "test@example.com"
    password := "password123"
    
    // Mock设置
    userRepo.On("GetByUsername", ctx, username).Return(nil, errors.New("user not found"))
    userRepo.On("GetByEmail", ctx, email).Return(nil, errors.New("email not found"))
    userRepo.On("Create", ctx, mock.AnythingOfType("*User")).Return(nil)
    
    // 执行测试
    user, err := authService.Register(ctx, username, email, password)
    
    // 结果验证
    assert.NoError(t, err)
    assert.NotNil(t, user)
    assert.Equal(t, username, user.Username)
    assert.Equal(t, email, user.Email)
    assert.Equal(t, "active", user.Status)
}
```

#### 1.2 用户登录测试
- **正常登录**：用户名密码正确，返回JWT Token
- **登录失败**：用户名不存在、密码错误、账号被锁定
- **Token验证**：Token有效性、过期处理、刷新机制

#### 1.3 权限验证测试
- **角色权限**：用户角色权限验证、权限继承
- **资源权限**：资源访问权限、操作权限验证
- **权限缓存**：权限信息缓存、缓存更新机制

### 2. 钱包系统测试

#### 2.1 钱包创建测试
```go
// 测试用例：创建钱包成功
func TestWalletService_CreateWallet_Success(t *testing.T) {
    userID := primitive.NewObjectID()
    
    walletRepo.On("Create", ctx, mock.AnythingOfType("*Wallet")).Return(nil)
    
    wallet, err := walletService.CreateWallet(ctx, userID)
    
    assert.NoError(t, err)
    assert.NotNil(t, wallet)
    assert.Equal(t, userID, wallet.UserID)
    assert.Equal(t, int64(0), wallet.Balance)
    assert.Equal(t, "active", wallet.Status)
}
```

#### 2.2 充值功能测试
- **正常充值**：充值金额有效、支付成功、余额更新
- **充值失败**：金额无效、支付失败、重复充值
- **充值记录**：交易记录创建、状态更新、通知发送

#### 2.3 消费功能测试
- **正常消费**：余额充足、消费成功、余额扣减
- **消费失败**：余额不足、金额无效、账户冻结
- **消费记录**：交易记录、消费明细、统计更新

#### 2.4 提现功能测试
- **提现申请**：提现金额验证、手续费计算、申请创建
- **提现审核**：审核流程、状态更新、通知机制
- **提现处理**：资金转账、到账确认、记录更新

### 3. 推荐服务测试

#### 3.1 个性化推荐测试
```go
// 测试用例：个性化推荐成功
func TestRecommendationService_GetPersonalizedRecommendations_Success(t *testing.T) {
    userID := primitive.NewObjectID()
    limit := 5
    
    userProfile := &UserProfile{
        UserID: userID,
        Categories: []string{"小说", "漫画"},
        Tags: []string{"玄幻", "都市"},
    }
    
    expectedContents := []*Content{
        {Title: "测试小说1", Category: "小说"},
        {Title: "测试漫画1", Category: "漫画"},
    }
    
    userProfileRepo.On("GetByUserID", ctx, userID).Return(userProfile, nil)
    contentRepo.On("GetByCategory", ctx, "小说", mock.AnythingOfType("int")).Return(expectedContents[:1], nil)
    contentRepo.On("GetByCategory", ctx, "漫画", mock.AnythingOfType("int")).Return(expectedContents[1:], nil)
    
    recommendations, err := recommendationService.GetPersonalizedRecommendations(ctx, userID, limit)
    
    assert.NoError(t, err)
    assert.NotNil(t, recommendations)
    assert.Len(t, recommendations, 2)
}
```

#### 3.2 协同过滤测试
- **相似用户**：相似用户发现、相似度计算、推荐生成
- **相似内容**：内容相似度、特征匹配、推荐排序
- **冷启动**：新用户推荐、新内容推荐、默认策略

#### 3.3 推荐效果测试
- **点击率**：推荐内容点击率统计、效果评估
- **转化率**：推荐转化率、用户满意度、业务指标
- **A/B测试**：推荐策略对比、效果分析、策略优化

### 4. 文件存储服务测试

#### 4.1 文件上传测试
```go
// 测试用例：文件上传成功
func TestStorageService_UploadFile_Success(t *testing.T) {
    userID := primitive.NewObjectID()
    content := strings.NewReader("test file content")
    
    req := &UploadRequest{
        FileName: "test.txt",
        ContentType: "text/plain",
        FileSize: 17,
        Content: content,
        UserID: userID,
    }
    
    fileRepo.On("GetByHash", ctx, mock.AnythingOfType("string")).Return(nil, errors.New("not found"))
    storageProvider.On("Upload", ctx, mock.AnythingOfType("string"), content, "text/plain").Return("https://cdn.example.com/test.txt", nil)
    fileRepo.On("Create", ctx, mock.AnythingOfType("*File")).Return(nil)
    
    file, err := storageService.UploadFile(ctx, req)
    
    assert.NoError(t, err)
    assert.NotNil(t, file)
    assert.Equal(t, "test.txt", file.OriginalName)
    assert.Equal(t, int64(17), file.FileSize)
}
```

#### 4.2 文件下载测试
- **权限验证**：文件访问权限、用户身份验证
- **文件获取**：文件存在性、文件完整性、下载链接
- **下载统计**：下载次数、下载记录、访问日志

#### 4.3 文件管理测试
- **文件删除**：权限验证、文件删除、存储清理
- **文件版本**：版本创建、版本管理、版本回滚
- **文件权限**：权限设置、权限验证、权限继承

### 5. 消息队列服务测试

#### 5.1 主题管理测试
```go
// 测试用例：创建主题成功
func TestMessagingService_CreateTopic_Success(t *testing.T) {
    name := "test-topic"
    partitions := int32(3)
    replicas := int16(1)
    config := map[string]string{"retention.ms": "86400000"}
    
    topicRepo.On("GetByName", ctx, name).Return(nil, errors.New("not found"))
    broker.On("CreateTopic", ctx, name, partitions, replicas).Return(nil)
    topicRepo.On("Create", ctx, mock.AnythingOfType("*Topic")).Return(nil)
    
    topic, err := messagingService.CreateTopic(ctx, name, partitions, replicas, config)
    
    assert.NoError(t, err)
    assert.NotNil(t, topic)
    assert.Equal(t, name, topic.Name)
    assert.Equal(t, partitions, topic.Partitions)
}
```

#### 5.2 消息发布测试
- **消息发送**：消息格式、发送成功、确认机制
- **消息持久化**：消息存储、持久化策略、数据恢复
- **消息路由**：分区策略、负载均衡、消息顺序

#### 5.3 消息消费测试
- **消费者组**：消费者组管理、负载均衡、故障转移
- **消息处理**：消息消费、处理确认、重试机制
- **消费监控**：消费进度、延迟监控、性能指标

### 6. 管理后台服务测试

#### 6.1 管理员管理测试
```go
// 测试用例：创建管理员成功
func TestAdminService_CreateAdminUser_Success(t *testing.T) {
    username := "admin"
    email := "admin@example.com"
    password := "password123"
    realName := "管理员"
    roles := []string{"super_admin"}
    createdBy := "system"
    
    adminUserRepo.On("GetByUsername", ctx, username).Return(nil, errors.New("not found"))
    adminUserRepo.On("Create", ctx, mock.AnythingOfType("*AdminUser")).Return(nil)
    
    adminUser, err := adminService.CreateAdminUser(ctx, username, email, password, realName, roles, createdBy)
    
    assert.NoError(t, err)
    assert.NotNil(t, adminUser)
    assert.Equal(t, username, adminUser.Username)
    assert.Equal(t, "active", adminUser.Status)
}
```

#### 6.2 操作日志测试
- **日志记录**：操作记录、请求响应、执行时间
- **日志查询**：条件查询、分页查询、统计分析
- **日志审计**：安全审计、合规检查、异常监控

#### 6.3 系统配置测试
- **配置管理**：配置读取、配置更新、配置验证
- **配置权限**：编辑权限、访问控制、操作审计
- **配置生效**：配置热更新、缓存刷新、通知机制

#### 6.4 数据统计测试
- **统计计算**：数据聚合、指标计算、趋势分析
- **报表生成**：报表数据、图表展示、导出功能
- **实时监控**：实时数据、监控告警、性能指标

## 🚀 性能测试

### 1. 基准测试

#### 1.1 服务性能基准
```go
// 基准测试示例：用户登录性能
func BenchmarkAuthService_Login(b *testing.B) {
    // 测试准备
    authService := setupAuthService()
    username := "testuser"
    password := "password123"
    
    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        _, _, err := authService.Login(context.Background(), username, password)
        if err != nil {
            b.Fatal(err)
        }
    }
}
```

#### 1.2 数据库操作性能
- **查询性能**：单表查询、关联查询、聚合查询
- **写入性能**：单条插入、批量插入、事务写入
- **缓存性能**：缓存命中率、缓存更新、缓存失效

### 2. 压力测试

#### 2.1 API接口压力测试
```bash
# 使用wrk进行压力测试
wrk -t12 -c400 -d30s --script=login.lua http://localhost:8080/api/v1/auth/login

# 测试脚本示例 (login.lua)
wrk.method = "POST"
wrk.body = '{"username":"testuser","password":"password123"}'
wrk.headers["Content-Type"] = "application/json"
```

#### 2.2 并发测试场景
- **用户注册并发**：大量用户同时注册、用户名冲突处理
- **钱包操作并发**：并发充值消费、余额一致性、事务隔离
- **文件上传并发**：大文件上传、并发上传、存储压力

### 3. 性能指标

#### 3.1 响应时间指标
| 服务 | 平均响应时间 | 95%响应时间 | 99%响应时间 |
|------|-------------|-------------|-------------|
| 账号权限 | < 50ms | < 100ms | < 200ms |
| 钱包系统 | < 100ms | < 200ms | < 500ms |
| 推荐服务 | < 200ms | < 500ms | < 1000ms |
| 文件存储 | < 100ms | < 300ms | < 1000ms |
| 消息队列 | < 10ms | < 50ms | < 100ms |
| 管理后台 | < 200ms | < 500ms | < 1000ms |

#### 3.2 吞吐量指标
| 服务 | 目标QPS | 峰值QPS | 并发用户数 |
|------|---------|---------|-----------|
| 账号权限 | 1000 | 2000 | 5000 |
| 钱包系统 | 500 | 1000 | 2000 |
| 推荐服务 | 2000 | 5000 | 10000 |
| 文件存储 | 200 | 500 | 1000 |
| 消息队列 | 10000 | 50000 | 20000 |
| 管理后台 | 100 | 200 | 500 |

## 🔧 测试工具和环境

### 1. 测试框架和工具

#### 1.1 Go测试工具
```go
// 主要依赖包
import (
    "testing"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"
    "github.com/stretchr/testify/suite"
)
```

#### 1.2 数据库测试工具
- **MongoDB测试**：使用mongo-go-driver测试工具
- **Redis测试**：使用miniredis进行内存Redis测试
- **事务测试**：使用testcontainers进行集成测试

#### 1.3 HTTP测试工具
```go
// HTTP测试示例
func TestUserAPI_Register(t *testing.T) {
    router := setupRouter()
    
    reqBody := `{"username":"testuser","email":"test@example.com","password":"password123"}`
    req, _ := http.NewRequest("POST", "/api/v1/auth/register", strings.NewReader(reqBody))
    req.Header.Set("Content-Type", "application/json")
    
    w := httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    assert.Equal(t, 200, w.Code)
    
    var response map[string]interface{}
    json.Unmarshal(w.Body.Bytes(), &response)
    assert.Equal(t, "success", response["status"])
}
```

### 2. 测试环境配置

#### 2.1 Docker测试环境
```yaml
# docker-compose.test.yml
version: '3.8'
services:
  mongodb:
    image: mongo:5.0
    environment:
      MONGO_INITDB_ROOT_USERNAME: test
      MONGO_INITDB_ROOT_PASSWORD: test123
    ports:
      - "27017:27017"
  
  redis:
    image: redis:6.2
    ports:
      - "6379:6379"
  
  kafka:
    image: confluentinc/cp-kafka:latest
    environment:
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
    ports:
      - "9092:9092"
```

#### 2.2 测试配置文件
```yaml
# config.test.yaml
database:
  mongodb:
    uri: "mongodb://test:test123@localhost:27017/qingyu_test"
  redis:
    addr: "localhost:6379"
    password: ""
    db: 1

kafka:
  brokers: ["localhost:9092"]
  
logging:
  level: "debug"
  output: "stdout"
```

### 3. CI/CD集成

#### 3.1 GitHub Actions配置
```yaml
# .github/workflows/test.yml
name: Test
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:5.0
        env:
          MONGO_INITDB_ROOT_USERNAME: test
          MONGO_INITDB_ROOT_PASSWORD: test123
        ports:
          - 27017:27017
      redis:
        image: redis:6.2
        ports:
          - 6379:6379
    
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-go@v2
      with:
        go-version: 1.19
    
    - name: Run tests
      run: |
        go mod download
        go test -v -race -coverprofile=coverage.out ./...
        go tool cover -html=coverage.out -o coverage.html
    
    - name: Upload coverage
      uses: codecov/codecov-action@v1
      with:
        file: ./coverage.out
```

## 📈 测试报告和监控

### 1. 测试报告格式

#### 1.1 单元测试报告
```bash
# 生成测试报告
go test -v -coverprofile=coverage.out ./...
go tool cover -html=coverage.out -o coverage.html

# 测试覆盖率统计
go tool cover -func=coverage.out
```

#### 1.2 性能测试报告
```bash
# 基准测试报告
go test -bench=. -benchmem -cpuprofile=cpu.prof -memprofile=mem.prof

# 性能分析
go tool pprof cpu.prof
go tool pprof mem.prof
```

### 2. 持续监控

#### 2.1 测试指标监控
- **测试通过率**：单元测试、集成测试、接口测试通过率
- **代码覆盖率**：代码覆盖率趋势、覆盖率目标达成
- **性能指标**：响应时间、吞吐量、资源使用率

#### 2.2 质量门禁
- **覆盖率门禁**：代码覆盖率 ≥ 80%
- **性能门禁**：响应时间 ≤ 200ms，QPS ≥ 1000
- **安全门禁**：安全漏洞扫描、依赖安全检查

## 🎯 测试执行指南

### 1. 本地测试执行

#### 1.1 环境准备
```bash
# 启动测试环境
docker-compose -f docker-compose.test.yml up -d

# 等待服务启动
sleep 30

# 运行数据库迁移
go run cmd/migrate/main.go
```

#### 1.2 测试执行
```bash
# 运行所有测试
make test

# 运行单元测试
make test-unit

# 运行集成测试
make test-integration

# 运行性能测试
make test-benchmark

# 生成测试报告
make test-report
```

### 2. 测试数据管理

#### 2.1 测试数据准备
```go
// 测试数据工厂
func CreateTestUser() *User {
    return &User{
        ID:       primitive.NewObjectID(),
        Username: "testuser_" + generateRandomString(8),
        Email:    "test_" + generateRandomString(8) + "@example.com",
        Status:   "active",
        CreatedAt: time.Now(),
    }
}

func CreateTestWallet(userID primitive.ObjectID) *Wallet {
    return &Wallet{
        ID:      primitive.NewObjectID(),
        UserID:  userID,
        Balance: 1000,
        Status:  "active",
        CreatedAt: time.Now(),
    }
}
```

#### 2.2 测试数据清理
```go
// 测试清理函数
func cleanupTestData(t *testing.T, db *mongo.Database) {
    collections := []string{"users", "wallets", "transactions", "files"}
    
    for _, collection := range collections {
        _, err := db.Collection(collection).DeleteMany(context.Background(), bson.M{})
        if err != nil {
            t.Logf("Failed to cleanup collection %s: %v", collection, err)
        }
    }
}
```

### 3. 测试最佳实践

#### 3.1 测试编写规范
- **命名规范**：Test[Function]_[Scenario]_[ExpectedResult]
- **结构清晰**：Arrange-Act-Assert模式
- **独立性**：测试用例间相互独立，无依赖关系
- **可读性**：测试代码清晰易懂，注释完整

#### 3.2 Mock使用规范
```go
// Mock使用示例
func TestUserService_GetUser_Success(t *testing.T) {
    // Arrange
    userRepo := new(MockUserRepository)
    userService := NewUserService(userRepo)
    
    userID := primitive.NewObjectID()
    expectedUser := &User{
        ID: userID,
        Username: "testuser",
        Status: "active",
    }
    
    userRepo.On("GetByID", mock.Anything, userID).Return(expectedUser, nil)
    
    // Act
    user, err := userService.GetUser(context.Background(), userID)
    
    // Assert
    assert.NoError(t, err)
    assert.Equal(t, expectedUser, user)
    userRepo.AssertExpectations(t)
}
```

#### 3.3 错误处理测试
```go
// 错误场景测试
func TestUserService_GetUser_NotFound(t *testing.T) {
    userRepo := new(MockUserRepository)
    userService := NewUserService(userRepo)
    
    userID := primitive.NewObjectID()
    userRepo.On("GetByID", mock.Anything, userID).Return(nil, errors.New("user not found"))
    
    user, err := userService.GetUser(context.Background(), userID)
    
    assert.Error(t, err)
    assert.Nil(t, user)
    assert.Contains(t, err.Error(), "user not found")
    userRepo.AssertExpectations(t)
}
```

## 📋 总结

本测试文档为青羽平台共享服务提供了完整的测试策略和实施指南。通过系统化的测试方法，确保服务的质量、性能和可靠性。

### 关键要点
1. **全面覆盖**：从单元测试到端到端测试的完整覆盖
2. **质量保证**：通过自动化测试确保代码质量
3. **性能验证**：通过性能测试确保系统性能达标
4. **持续改进**：通过监控和反馈持续优化测试策略

### 下一步计划
1. **测试自动化**：完善CI/CD流程中的自动化测试
2. **测试工具优化**：引入更多测试工具提升测试效率
3. **测试数据管理**：建立完善的测试数据管理机制
4. **测试培训**：为开发团队提供测试最佳实践培训