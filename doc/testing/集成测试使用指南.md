# 青羽后端 - 集成测试使用指南

## 概述

本指南介绍如何使用青羽后端的集成测试套件，包括数据准备、测试执行和结果验证。

## 测试环境

### 系统要求

- Go 1.21+
- MongoDB 4.4+
- Redis 6.0+（可选）
- Windows 或 Linux 操作系统

### 配置要求

确保以下配置文件正确：

- `config/config.yaml` - 开发环境配置
- `config/config.test.yaml` - 测试环境配置

## 快速开始

### 方法1：使用一键测试脚本（推荐）

```batch
# Windows
scripts\testing\run_integration_tests.bat

# 按提示选择：
# 1. 是否准备测试数据（首次运行选yes）
# 2. 选择要执行的测试场景（1-8）
```

### 方法2：手动执行

#### 步骤1：准备测试数据

```batch
# 1. 清理旧数据
scripts\testing\cleanup_test_data.bat

# 2. 导入测试用户
go run scripts\testing\import_test_users.go

# 3. 导入小说数据
scripts\testing\import_novels.bat
```

#### 步骤2：启动服务器

```batch
go run cmd/server/main.go
```

#### 步骤3：执行测试

```batch
# 执行单个测试
go test -v ./test/integration/scenario_bookstore_test.go

# 执行所有集成测试
go test -v ./test/integration/scenario_*.go
```

## 测试场景

### 1. 书城流程测试 (scenario_bookstore_test.go)

**测试内容**：
- 获取书城首页数据
- 获取分类树
- 获取推荐和精选书籍
- 获取活动Banner
- 获取各类榜单（实时榜、周榜、月榜、新人榜）

**预期结果**：
- 所有API返回200状态码
- 数据结构正确
- 分类、推荐、榜单数据完整

**执行命令**：
```batch
go test -v ./test/integration/scenario_bookstore_test.go
```

### 2. 搜索功能测试 (scenario_search_test.go)

**测试内容**：
- 按标题关键词搜索
- 按作者搜索
- 组合搜索（关键词+作者）
- 排序功能（最新、最热、字数）
- 分页功能
- 无结果场景

**预期结果**：
- 搜索结果准确
- 排序和分页正常
- 错误处理正确

**执行命令**：
```batch
go test -v ./test/integration/scenario_search_test.go
```

### 3. 阅读流程测试 (scenario_reading_test.go)

**测试内容**：
- 获取书籍详情
- 获取章节列表
- 阅读章节内容
- 保存阅读进度
- 添加书签和笔记
- 管理个人书架

**前置条件**：
- 需要登录测试用户
- 数据库中有书籍数据

**执行命令**：
```batch
go test -v ./test/integration/scenario_reading_test.go
```

### 4. AI生成测试 (scenario_ai_generation_test.go)

**测试内容**：
- 文本续写功能
- 文本改写功能
- 文本扩写功能
- 文本润色功能
- Token使用统计
- 错误处理（空文本、超长文本）

**前置条件**：
- 配置有效的Gemini API Key
- 网络连接正常

**配置说明**：
在 `config/config.yaml` 中配置：
```yaml
external_api:
  default_provider: "gemini"
  providers:
    gemini:
      name: "gemini"
      api_key: "YOUR_GEMINI_API_KEY"
      base_url: "https://generativelanguage.googleapis.com"
      enabled: true
```

**执行命令**：
```batch
go test -v ./test/integration/scenario_ai_generation_test.go
```

### 5. 认证流程测试 (scenario_auth_test.go)

**测试内容**：
- 普通用户登录
- VIP用户登录
- 管理员登录
- Token验证
- 权限控制
- 用户注册
- 错误处理（错误密码、不存在用户）

**预期结果**：
- 不同角色登录成功
- Token正确生成和验证
- 权限控制有效

**执行命令**：
```batch
go test -v ./test/integration/scenario_auth_test.go
```

### 6. 写作流程测试 (scenario_writing_test.go)

**测试内容**：
- 创建写作项目
- 获取项目列表
- 创建文档
- 保存草稿
- 版本管理
- 发布文档

**前置条件**：
- 需要登录测试用户

**执行命令**：
```batch
go test -v ./test/integration/scenario_writing_test.go
```

### 7. 互动功能测试 (scenario_interaction_test.go)

**测试内容**：
- 收藏书籍
- 发表评论
- 点赞/取消点赞
- 阅读历史
- 个人书架

**前置条件**：
- 需要登录测试用户
- 数据库中有书籍数据

**执行命令**：
```batch
go test -v ./test/integration/scenario_interaction_test.go
```

## 测试账号

所有测试账号由 `import_test_users.go` 自动创建：

| 角色 | 用户名 | 邮箱 | 密码 | 用途 |
|-----|-------|------|------|-----|
| 管理员 | admin | admin@qingyu.com | Admin@123456 | 管理员功能测试 |
| VIP用户 | vip_user01 | vip01@qingyu.com | Vip@123456 | VIP权限测试 |
| VIP用户 | vip_user02 | vip02@qingyu.com | Vip@123456 | VIP权限测试 |
| 普通用户 | test_user01 | test01@qingyu.com | Test@123456 | 普通用户测试 |
| 普通用户 | test_user02 | test02@qingyu.com | Test@123456 | 普通用户测试 |
| 普通用户 | test_user03 | test03@qingyu.com | Test@123456 | 普通用户测试 |
| 普通用户 | test_user04 | test04@qingyu.com | Test@123456 | 普通用户测试 |
| 普通用户 | test_user05 | test05@qingyu.com | Test@123456 | 普通用户测试 |

## 测试数据

### 小说数据

- **来源**：CNNovel125K数据集
- **数量**：100本小说（约3000章）
- **文件**：`data/novels_100.json`
- **导入脚本**：`scripts/testing/import_novels.bat`

### 数据清理

如需重新开始测试，执行：

```batch
scripts\testing\cleanup_test_data.bat
```

⚠️ **警告**：此操作会删除所有测试数据！

## 常见问题

### Q1: 测试失败，提示"无法连接到服务器"

**解决方法**：
1. 确保服务器正在运行：`go run cmd/server/main.go`
2. 检查端口8080是否被占用
3. 检查防火墙设置

### Q2: 测试失败，提示"数据库中没有书籍"

**解决方法**：
1. 运行数据导入脚本：`scripts\testing\import_novels.bat`
2. 检查MongoDB连接配置
3. 确认数据文件 `data/novels_100.json` 存在

### Q3: AI测试失败，提示"API调用失败"

**解决方法**：
1. 检查Gemini API Key是否正确配置
2. 检查网络连接
3. 确认API配额未超限

### Q4: 登录测试失败，提示"用户不存在"

**解决方法**：
1. 运行用户导入脚本：`go run scripts\testing\import_test_users.go`
2. 检查数据库连接
3. 确认用户集合中有测试用户

### Q5: 如何跳过某些测试？

**方法1**：使用一键测试脚本，选择特定测试场景

**方法2**：在代码中添加skip：
```go
if testing.Short() {
    t.Skip("跳过集成测试")
}
```

然后运行：
```batch
go test -short ./test/integration/...
```

### Q6: 测试运行很慢怎么办？

**优化建议**：
1. 单独运行特定测试场景
2. 使用本地MongoDB而非Docker
3. 减少导入的测试数据量
4. 检查网络连接（特别是AI测试）

## 测试报告

测试完成后，可以生成测试报告：

```batch
# 生成测试报告
go test -v ./test/integration/scenario_*.go > test_report.txt 2>&1

# 查看报告
type test_report.txt
```

## 持续集成

集成测试可以集成到CI/CD流程：

```yaml
# GitHub Actions 示例
name: Integration Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:4.4
        ports:
          - 27017:27017
    
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-go@v2
        with:
          go-version: 1.21
      
      - name: Prepare test data
        run: |
          go run scripts/testing/import_test_users.go
          bash scripts/testing/import_novels.sh
      
      - name: Run integration tests
        run: go test -v ./test/integration/...
```

## 技术支持

如遇问题，请参考：

- [项目架构文档](../architecture/)
- [API文档](../api/)
- [问题追踪](https://github.com/your-org/qingyu-backend/issues)

---

**最后更新**：2025-10-24  
**维护者**：青羽后端测试团队

