# é›†æˆæµ‹è¯•ç¤ºä¾‹è¯´æ˜

**åˆ›å»ºæ—¥æœŸ**: 2025-10-27  
**æµ‹è¯•ç­–ç•¥**: åŸºäºRepository(90%) + Service(88%)çš„æ‰å®åŸºç¡€

---

## ğŸ¯ é›†æˆæµ‹è¯•ç›®æ ‡

é›†æˆæµ‹è¯•ç”¨äºéªŒè¯ï¼š
1. å¤šä¸ªå±‚çº§ï¼ˆAPI â†’ Service â†’ Repository â†’ Databaseï¼‰çš„åä½œ
2. ç«¯åˆ°ç«¯çš„ä¸šåŠ¡æµç¨‹
3. æ•°æ®ä¸€è‡´æ€§
4. çœŸå®åœºæ™¯ä¸‹çš„ç³»ç»Ÿè¡Œä¸º

---

## ğŸ“ ç¤ºä¾‹1: è¯„è®º+ç‚¹èµå®Œæ•´æµç¨‹

### æµ‹è¯•åœºæ™¯

```go
func TestIntegration_CommentAndLikeFlow(t *testing.T) {
    /*
    æµ‹è¯•æµç¨‹:
    1. ç”¨æˆ·Aå‘è¡¨è¯„è®º
    2. ç”¨æˆ·Bç‚¹èµè¯¥è¯„è®º
    3. éªŒè¯è¯„è®ºç‚¹èµæ•°å¢åŠ 
    4. ç”¨æˆ·Bå–æ¶ˆç‚¹èµ
    5. éªŒè¯è¯„è®ºç‚¹èµæ•°å‡å°‘
    6. ç”¨æˆ·Aåˆ é™¤è¯„è®º
    7. éªŒè¯è¯„è®ºå·²åˆ é™¤ï¼ˆè½¯åˆ é™¤ï¼‰
    */
    
    // Setup - åˆ›å»ºæµ‹è¯•ç¯å¢ƒ
    ctx := context.Background()
    testDB := setupTestDatabase(t)
    defer cleanupTestDatabase(t, testDB)
    
    // åˆ›å»ºServiceï¼ˆä½¿ç”¨çœŸå®çš„Repositoryï¼‰
    commentRepo := mongodb.NewMongoCommentRepository(testDB)
    likeRepo := mongodb.NewMongoLikeRepository(testDB)
    sensitiveRepo := mongodb.NewMongoSensitiveWordRepository(testDB)
    eventBus := events.NewSimpleEventBus()
    
    commentService := reading.NewCommentService(commentRepo, sensitiveRepo, eventBus)
    likeService := reading.NewLikeService(likeRepo, commentRepo, eventBus)
    
    // Test Data
    userA := "user_alice"
    userB := "user_bob"
    bookID := "book_test_123"
    
    // Step 1: ç”¨æˆ·Aå‘è¡¨è¯„è®º
    t.Log("Step 1: ç”¨æˆ·Aå‘è¡¨è¯„è®º")
    comment, err := commentService.PublishComment(
        ctx,
        userA,
        bookID,
        "",
        "è¿™æ˜¯ä¸€æ¡æµ‹è¯•è¯„è®ºï¼Œå†…å®¹å……å®æœ‰ä»·å€¼",
        5,
    )
    require.NoError(t, err)
    require.NotNil(t, comment)
    require.NotEmpty(t, comment.ID.Hex())
    assert.Equal(t, 0, comment.LikeCount)
    t.Logf("âœ“ è¯„è®ºå·²åˆ›å»ºï¼ŒID: %s", comment.ID.Hex())
    
    commentID := comment.ID.Hex()
    
    // Step 2: ç”¨æˆ·Bç‚¹èµè¯¥è¯„è®º
    t.Log("Step 2: ç”¨æˆ·Bç‚¹èµè¯„è®º")
    err = likeService.LikeComment(ctx, userB, commentID)
    require.NoError(t, err)
    t.Logf("âœ“ ç”¨æˆ·Bç‚¹èµæˆåŠŸ")
    
    // Step 3: éªŒè¯è¯„è®ºç‚¹èµæ•°å¢åŠ 
    t.Log("Step 3: éªŒè¯ç‚¹èµæ•°")
    updatedComment, err := commentRepo.GetByID(ctx, commentID)
    require.NoError(t, err)
    assert.Equal(t, 1, updatedComment.LikeCount)
    t.Logf("âœ“ è¯„è®ºç‚¹èµæ•°: %d", updatedComment.LikeCount)
    
    // éªŒè¯ç‚¹èµè®°å½•å­˜åœ¨
    isLiked, err := likeRepo.IsLiked(ctx, userB, reader.LikeTargetTypeComment, commentID)
    require.NoError(t, err)
    assert.True(t, isLiked)
    t.Logf("âœ“ ç‚¹èµè®°å½•å·²ä¿å­˜")
    
    // Step 4: ç”¨æˆ·Bå–æ¶ˆç‚¹èµ
    t.Log("Step 4: ç”¨æˆ·Bå–æ¶ˆç‚¹èµ")
    err = likeService.UnlikeComment(ctx, userB, commentID)
    require.NoError(t, err)
    t.Logf("âœ“ å–æ¶ˆç‚¹èµæˆåŠŸ")
    
    // Step 5: éªŒè¯è¯„è®ºç‚¹èµæ•°å‡å°‘
    t.Log("Step 5: éªŒè¯ç‚¹èµæ•°å‡å°‘")
    finalComment, err := commentRepo.GetByID(ctx, commentID)
    require.NoError(t, err)
    assert.Equal(t, 0, finalComment.LikeCount)
    t.Logf("âœ“ è¯„è®ºç‚¹èµæ•°: %d", finalComment.LikeCount)
    
    // éªŒè¯ç‚¹èµè®°å½•å·²åˆ é™¤
    isLikedAfter, err := likeRepo.IsLiked(ctx, userB, reader.LikeTargetTypeComment, commentID)
    require.NoError(t, err)
    assert.False(t, isLikedAfter)
    t.Logf("âœ“ ç‚¹èµè®°å½•å·²åˆ é™¤")
    
    // Step 6: ç”¨æˆ·Aåˆ é™¤è¯„è®º
    t.Log("Step 6: ç”¨æˆ·Aåˆ é™¤è¯„è®º")
    err = commentService.DeleteComment(ctx, userA, commentID)
    require.NoError(t, err)
    t.Logf("âœ“ è¯„è®ºå·²åˆ é™¤")
    
    // Step 7: éªŒè¯è¯„è®ºçŠ¶æ€
    t.Log("Step 7: éªŒè¯è½¯åˆ é™¤")
    deletedComment, err := commentRepo.GetByID(ctx, commentID)
    require.NoError(t, err)
    assert.Equal(t, "deleted", deletedComment.Status)
    t.Logf("âœ“ è¯„è®ºçŠ¶æ€: %s", deletedComment.Status)
    
    t.Log("======================================")
    t.Log("âœ… é›†æˆæµ‹è¯•é€šè¿‡ï¼šè¯„è®º+ç‚¹èµå®Œæ•´æµç¨‹")
    t.Log("======================================")
}
```

### æµ‹è¯•éªŒè¯ç‚¹

âœ… **æ•°æ®ä¸€è‡´æ€§**:
- ç‚¹èµåè¯„è®ºçš„like_countæ­£ç¡®å¢åŠ 
- å–æ¶ˆç‚¹èµålike_countæ­£ç¡®å‡å°‘
- ç‚¹èµè®°å½•ä¸è¯„è®ºè®¡æ•°åŒæ­¥

âœ… **ä¸šåŠ¡é€»è¾‘**:
- è¯„è®ºåˆ›å»ºæˆåŠŸ
- ç‚¹èµ/å–æ¶ˆç‚¹èµæ“ä½œæ­£ç¡®
- è½¯åˆ é™¤åŠŸèƒ½æ­£å¸¸

âœ… **è·¨Serviceäº¤äº’**:
- LikeServiceæ­£ç¡®è°ƒç”¨CommentRepositoryæ›´æ–°è®¡æ•°
- æ•°æ®åœ¨å¤šä¸ªRepositoryä¹‹é—´ä¿æŒä¸€è‡´

---

## ğŸ“ ç¤ºä¾‹2: å¹‚ç­‰æ€§éªŒè¯

### æµ‹è¯•åœºæ™¯

```go
func TestIntegration_LikeIdempotency(t *testing.T) {
    /*
    æµ‹è¯•å¹‚ç­‰æ€§:
    1. ç”¨æˆ·ç‚¹èµä¹¦ç±
    2. ç”¨æˆ·é‡å¤ç‚¹èµï¼ˆåº”è¯¥ä¸æŠ¥é”™ï¼‰
    3. éªŒè¯åªæœ‰ä¸€æ¡ç‚¹èµè®°å½•
    4. ç”¨æˆ·å–æ¶ˆç‚¹èµ
    5. ç”¨æˆ·é‡å¤å–æ¶ˆç‚¹èµï¼ˆåº”è¯¥ä¸æŠ¥é”™ï¼‰
    6. éªŒè¯ç‚¹èµè®°å½•å·²åˆ é™¤
    */
    
    ctx := context.Background()
    testDB := setupTestDatabase(t)
    defer cleanupTestDatabase(t, testDB)
    
    // åˆ›å»ºService
    likeRepo := mongodb.NewMongoLikeRepository(testDB)
    commentRepo := mongodb.NewMongoCommentRepository(testDB)
    eventBus := events.NewSimpleEventBus()
    likeService := reading.NewLikeService(likeRepo, commentRepo, eventBus)
    
    userID := "user_test"
    bookID := "book_test_456"
    
    // Step 1: ç¬¬ä¸€æ¬¡ç‚¹èµ
    t.Log("Step 1: ç¬¬ä¸€æ¬¡ç‚¹èµ")
    err := likeService.LikeBook(ctx, userID, bookID)
    require.NoError(t, err)
    t.Logf("âœ“ ç¬¬ä¸€æ¬¡ç‚¹èµæˆåŠŸ")
    
    // Step 2: é‡å¤ç‚¹èµï¼ˆå¹‚ç­‰ï¼‰
    t.Log("Step 2: é‡å¤ç‚¹èµ")
    err = likeService.LikeBook(ctx, userID, bookID)
    require.NoError(t, err) // ä¸åº”è¯¥æŠ¥é”™
    t.Logf("âœ“ é‡å¤ç‚¹èµä¸æŠ¥é”™ï¼ˆå¹‚ç­‰æ€§ï¼‰")
    
    // Step 3: éªŒè¯åªæœ‰ä¸€æ¡è®°å½•
    t.Log("Step 3: éªŒè¯ç‚¹èµè®°å½•")
    count, err := likeRepo.CountUserLikes(ctx, userID)
    require.NoError(t, err)
    assert.Equal(t, int64(1), count)
    t.Logf("âœ“ ç‚¹èµè®°å½•æ•°: %d", count)
    
    // Step 4: å–æ¶ˆç‚¹èµ
    t.Log("Step 4: å–æ¶ˆç‚¹èµ")
    err = likeService.UnlikeBook(ctx, userID, bookID)
    require.NoError(t, err)
    t.Logf("âœ“ å–æ¶ˆç‚¹èµæˆåŠŸ")
    
    // Step 5: é‡å¤å–æ¶ˆç‚¹èµï¼ˆå¹‚ç­‰ï¼‰
    t.Log("Step 5: é‡å¤å–æ¶ˆç‚¹èµ")
    err = likeService.UnlikeBook(ctx, userID, bookID)
    require.NoError(t, err) // ä¸åº”è¯¥æŠ¥é”™
    t.Logf("âœ“ é‡å¤å–æ¶ˆç‚¹èµä¸æŠ¥é”™ï¼ˆå¹‚ç­‰æ€§ï¼‰")
    
    // Step 6: éªŒè¯è®°å½•å·²åˆ é™¤
    t.Log("Step 6: éªŒè¯è®°å½•å·²åˆ é™¤")
    countAfter, err := likeRepo.CountUserLikes(ctx, userID)
    require.NoError(t, err)
    assert.Equal(t, int64(0), countAfter)
    t.Logf("âœ“ ç‚¹èµè®°å½•æ•°: %d", countAfter)
    
    t.Log("======================================")
    t.Log("âœ… é›†æˆæµ‹è¯•é€šè¿‡ï¼šå¹‚ç­‰æ€§éªŒè¯")
    t.Log("======================================")
}
```

### å¹‚ç­‰æ€§éªŒè¯ç‚¹

âœ… **é‡å¤ç‚¹èµ**:
- ç¬¬ä¸€æ¬¡ç‚¹èµæˆåŠŸ
- ç¬¬äºŒæ¬¡ç‚¹èµä¸æŠ¥é”™
- åªåˆ›å»ºä¸€æ¡ç‚¹èµè®°å½•

âœ… **é‡å¤å–æ¶ˆç‚¹èµ**:
- ç¬¬ä¸€æ¬¡å–æ¶ˆæˆåŠŸ
- ç¬¬äºŒæ¬¡å–æ¶ˆä¸æŠ¥é”™
- ç‚¹èµè®°å½•è¢«æ­£ç¡®åˆ é™¤

---

## ğŸ“ ç¤ºä¾‹3: æ•æ„Ÿè¯è¿‡æ»¤

### æµ‹è¯•åœºæ™¯

```go
func TestIntegration_SensitiveWordFilter(t *testing.T) {
    /*
    æµ‹è¯•æ•æ„Ÿè¯è¿‡æ»¤:
    1. æ·»åŠ æ•æ„Ÿè¯åˆ°æ•°æ®åº“
    2. å‘è¡¨åŒ…å«æ•æ„Ÿè¯çš„è¯„è®º
    3. éªŒè¯è¯„è®ºè¢«æ‹’ç»æˆ–è¿›å…¥å¾…å®¡æ ¸
    4. å‘è¡¨æ­£å¸¸è¯„è®º
    5. éªŒè¯è¯„è®ºé€šè¿‡
    */
    
    ctx := context.Background()
    testDB := setupTestDatabase(t)
    defer cleanupTestDatabase(t, testDB)
    
    // åˆ›å»ºService
    commentRepo := mongodb.NewMongoCommentRepository(testDB)
    sensitiveRepo := mongodb.NewMongoSensitiveWordRepository(testDB)
    eventBus := events.NewSimpleEventBus()
    commentService := reading.NewCommentService(commentRepo, sensitiveRepo, eventBus)
    
    // Step 1: æ·»åŠ æ•æ„Ÿè¯
    t.Log("Step 1: æ·»åŠ æ•æ„Ÿè¯")
    sensitiveWord := &audit.SensitiveWord{
        Word:      "è¿è§„è¯",
        Level:     2,
        IsEnabled: true,
    }
    err := sensitiveRepo.Create(ctx, sensitiveWord)
    require.NoError(t, err)
    t.Logf("âœ“ æ•æ„Ÿè¯å·²æ·»åŠ ")
    
    // Step 2: å‘è¡¨åŒ…å«æ•æ„Ÿè¯çš„è¯„è®º
    t.Log("Step 2: å‘è¡¨åŒ…å«æ•æ„Ÿè¯çš„è¯„è®º")
    badComment, err := commentService.PublishComment(
        ctx,
        "user_test",
        "book_123",
        "",
        "è¿™æ¡è¯„è®ºåŒ…å«è¿è§„è¯çš„å†…å®¹",
        4,
    )
    require.NoError(t, err) // åˆ›å»ºæˆåŠŸï¼Œä½†çŠ¶æ€ä¸ºrejected
    assert.NotEqual(t, "approved", badComment.Status)
    assert.Contains(t, []string{"rejected", "pending"}, badComment.Status)
    t.Logf("âœ“ è¯„è®ºçŠ¶æ€: %s", badComment.Status)
    
    // Step 3: å‘è¡¨æ­£å¸¸è¯„è®º
    t.Log("Step 3: å‘è¡¨æ­£å¸¸è¯„è®º")
    goodComment, err := commentService.PublishComment(
        ctx,
        "user_test",
        "book_123",
        "",
        "è¿™æ˜¯ä¸€æ¡æ­£å¸¸çš„è¯„è®ºå†…å®¹ï¼Œæ²¡æœ‰é—®é¢˜",
        5,
    )
    require.NoError(t, err)
    assert.Equal(t, "approved", goodComment.Status)
    t.Logf("âœ“ è¯„è®ºçŠ¶æ€: %s", goodComment.Status)
    
    t.Log("======================================")
    t.Log("âœ… é›†æˆæµ‹è¯•é€šè¿‡ï¼šæ•æ„Ÿè¯è¿‡æ»¤")
    t.Log("======================================")
}
```

---

## ğŸ› ï¸ æµ‹è¯•è¾…åŠ©å‡½æ•°

### æ•°æ®åº“è®¾ç½®

```go
func setupTestDatabase(t *testing.T) *mongo.Database {
    // è¿æ¥åˆ°æµ‹è¯•MongoDB
    client, err := mongo.Connect(context.Background(), options.Client().ApplyURI("mongodb://localhost:27017"))
    require.NoError(t, err)
    
    // åˆ›å»ºç‹¬ç«‹çš„æµ‹è¯•æ•°æ®åº“ï¼ˆä½¿ç”¨æ—¶é—´æˆ³ï¼‰
    dbName := fmt.Sprintf("qingyu_integration_test_%d", time.Now().Unix())
    testDB := client.Database(dbName)
    
    t.Logf("âœ“ æµ‹è¯•æ•°æ®åº“å·²åˆ›å»º: %s", dbName)
    
    return testDB
}

func cleanupTestDatabase(t *testing.T, db *mongo.Database) {
    err := db.Drop(context.Background())
    if err != nil {
        t.Logf("âš  æ¸…ç†æµ‹è¯•æ•°æ®åº“å¤±è´¥: %v", err)
    } else {
        t.Logf("âœ“ æµ‹è¯•æ•°æ®åº“å·²æ¸…ç†: %s", db.Name())
    }
}
```

---

## ğŸ“Š é›†æˆæµ‹è¯•vså•å…ƒæµ‹è¯•

| ç‰¹æ€§ | Repositoryå±‚ | Serviceå±‚ | é›†æˆæµ‹è¯• |
|------|-------------|----------|---------|
| **æ•°æ®åº“** | çœŸå®MongoDB | Mock Repository | çœŸå®MongoDB |
| **ä¾èµ–** | çœŸå®è¿æ¥ | Mock | çœŸå®Service |
| **æµ‹è¯•å†…å®¹** | DBæ“ä½œ | ä¸šåŠ¡é€»è¾‘ | ç«¯åˆ°ç«¯æµç¨‹ |
| **é€Ÿåº¦** | ä¸­ç­‰ | å¿« | è¾ƒæ…¢ |
| **éš”ç¦»æ€§** | ç‹¬ç«‹DB | å®Œå…¨éš”ç¦» | ç‹¬ç«‹DB |
| **è¦†ç›–èŒƒå›´** | æ•°æ®å±‚ | é€»è¾‘å±‚ | å…¨æ ˆ |

---

## ğŸ¯ è¿è¡Œå»ºè®®

### å¼€å‘é˜¶æ®µ
```bash
# å¿«é€Ÿè¿è¡Œå•å…ƒæµ‹è¯•ï¼ˆServiceå±‚ï¼‰
go test ./test/service/... -v

# è¿è¡ŒRepositoryæµ‹è¯•
go test ./test/repository/... -v
```

### é›†æˆé˜¶æ®µ
```bash
# è¿è¡Œé›†æˆæµ‹è¯•
go test ./test/integration/... -v -timeout 5m

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
go test ./test/... -v -timeout 10m
```

### CI/CD
```bash
# å®Œæ•´æµ‹è¯• + è¦†ç›–ç‡
go test ./... -cover -coverprofile=coverage.out
go tool cover -html=coverage.out -o coverage.html
```

---

## âœ… æµ‹è¯•å®Œæˆæ ‡å‡†

é›†æˆæµ‹è¯•åº”è¯¥éªŒè¯ï¼š

- [ ] å®Œæ•´çš„ä¸šåŠ¡æµç¨‹ï¼ˆè¯„è®ºâ†’ç‚¹èµâ†’åˆ é™¤ï¼‰
- [ ] æ•°æ®ä¸€è‡´æ€§ï¼ˆå¤šä¸ªRepositoryä¹‹é—´ï¼‰
- [ ] å¹‚ç­‰æ€§ï¼ˆé‡å¤æ“ä½œä¸å‡ºé”™ï¼‰
- [ ] ä¸šåŠ¡è§„åˆ™ï¼ˆæ•æ„Ÿè¯è¿‡æ»¤ï¼‰
- [ ] æƒé™æ§åˆ¶ï¼ˆç”¨æˆ·åªèƒ½æ“ä½œè‡ªå·±çš„æ•°æ®ï¼‰
- [ ] äº‹ä»¶å‘å¸ƒï¼ˆæ“ä½œè§¦å‘äº‹ä»¶ï¼‰
- [ ] é”™è¯¯å¤„ç†ï¼ˆå¼‚å¸¸æƒ…å†µå¤„ç†æ­£ç¡®ï¼‰

---

## ğŸ“š å‚è€ƒ

- `test/repository/` - Repositoryå±‚æµ‹è¯•ç¤ºä¾‹
- `test/service/` - Serviceå±‚æµ‹è¯•ç¤ºä¾‹
- `test/integration/reader_api_integration_test.go` - ç°æœ‰é›†æˆæµ‹è¯•

---

**åˆ›å»ºæ—¶é—´**: 2025-10-27  
**é€‚ç”¨é¡¹ç›®**: Qingyu Backend  
**æµ‹è¯•ç­–ç•¥**: Repository + Service + Integration

