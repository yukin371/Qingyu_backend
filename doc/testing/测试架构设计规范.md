# 测试架构设计规范

**版本**: 1.0  
**创建时间**: 2025-10-25  
**状态**: ✅ 正式发布

---

## 一、概述

### 1.1 目标

本文档定义青羽写作后端服务的测试架构设计规范，确保测试代码的质量、可维护性和可扩展性。

### 1.2 适用范围

- 所有新编写的测试代码
- 正在重构的现有测试
- 测试工具和测试基础设施的开发

### 1.3 核心原则

1. **分层清晰**：测试按层级组织，职责明确
2. **可维护性**：测试代码易于理解和修改
3. **独立性**：测试之间相互独立，不相互影响
4. **可重复性**：测试结果稳定可重复
5. **高效性**：测试执行快速，反馈及时

---

## 二、测试分层架构

### 2.1 测试金字塔

```
           ┌─────────────┐
           │   E2E Tests │  (10%)
           │  端到端测试  │
           └─────────────┘
         ┌─────────────────┐
         │ Integration Tests│  (30%)
         │    集成测试       │
         └─────────────────┘
     ┌─────────────────────────┐
     │      Unit Tests         │  (60%)
     │       单元测试           │
     └─────────────────────────┘
```

**分层原则**：
- **单元测试（60%）**：快速、隔离、大量
- **集成测试（30%）**：关键流程、跨层交互
- **E2E测试（10%）**：核心业务场景、端到端验证

### 2.2 各层测试详解

#### 2.2.1 单元测试（Unit Tests）

**位置**：与被测代码同目录或 `test/` 目录下

**命名规范**：`*_test.go`

**测试范围**：
- **Repository层**：数据访问逻辑、查询构建、错误处理
- **Service层**：业务逻辑、参数验证、异常处理
- **Models层**：数据结构、方法、验证规则

**特点**：
- ✅ 使用Mock依赖（Repository、EventBus等）
- ✅ 测试单一功能点
- ✅ 快速执行（< 1秒）
- ✅ 不依赖外部资源（数据库、网络等）

**示例**：
```go
// test/service/collection_service_test.go
func TestCollectionService_AddToCollection(t *testing.T) {
    // 使用Mock Repository
    mockRepo := mocks.NewMockCollectionRepository(t)
    mockEventBus := mocks.NewMockEventBus(t)
    
    service := NewCollectionService(mockRepo, mockEventBus)
    
    // 测试正常添加
    mockRepo.EXPECT().FindByUserAndBook(userID, bookID).Return(nil, nil)
    mockRepo.EXPECT().Create(mock.Anything).Return(collection, nil)
    
    result, err := service.AddToCollection(ctx, userID, bookID, "", "", nil, false)
    
    assert.NoError(t, err)
    assert.NotNil(t, result)
}
```

#### 2.2.2 集成测试（Integration Tests）

**位置**：`test/integration/`

**命名规范**：
- 场景测试：`scenario_*.go`
- 流程测试：`*_flow_test.go`
- API测试：`*_api_test.go`

**测试范围**：
- **API层 → Service层 → Repository层**：完整的请求响应流程
- **多个Service交互**：跨服务的业务流程
- **数据库操作**：真实数据库的增删改查

**特点**：
- ✅ 使用真实的数据库连接
- ✅ 测试完整的业务流程
- ✅ 验证各层协作是否正常
- ✅ 执行时间适中（1-10秒）

**示例**：
```go
// test/integration/scenario_collection_test.go
func TestCollectionScenario(t *testing.T) {
    helper := integration.NewTestHelper(t, router)
    token := helper.LoginTestUser()
    bookID := helper.GetTestBook()
    
    t.Run("添加收藏", func(t *testing.T) {
        reqBody := map[string]interface{}{
            "book_id": bookID,
            "note": "测试笔记",
        }
        
        w := helper.DoAuthRequest("POST", integration.ReaderCollectionsPath, reqBody, token)
        helper.AssertSuccess(w, 201, "添加收藏失败")
    })
}
```

#### 2.2.3 端到端测试（E2E Tests）

**位置**：`test/integration/` 或 `test/e2e/`

**命名规范**：`e2e_*.go` 或 `*_e2e_test.go`

**测试范围**：
- **完整用户流程**：从注册到使用核心功能
- **跨模块交互**：阅读、写作、书城等模块协作
- **真实用户场景**：模拟实际用户操作

**特点**：
- ✅ 测试完整的用户旅程
- ✅ 验证系统整体功能
- ✅ 包含认证、权限等所有环节
- ✅ 执行时间较长（10-60秒）

**示例**：
```go
// test/integration/e2e_user_lifecycle_test.go
func TestUserLifecycle(t *testing.T) {
    // 1. 用户注册
    // 2. 用户登录
    // 3. 浏览书城
    // 4. 添加到书架
    // 5. 开始阅读
    // 6. 添加书签
    // 7. 收藏书籍
    // 8. 发表评论
}
```

---

## 三、测试基础设施

### 3.1 TestHelper框架

**位置**：`test/integration/helpers.go`

**核心职责**：
1. **认证管理**：统一的登录和token管理
2. **HTTP请求**：简化请求构造和发送
3. **响应断言**：详细的错误诊断信息
4. **数据库操作**：测试数据获取和清理
5. **日志记录**：结构化的测试日志

**架构图**：
```
┌─────────────────────────────────────┐
│        TestHelper 框架              │
├─────────────────────────────────────┤
│  ┌──────────────────────────────┐  │
│  │   认证模块 (Auth Module)      │  │
│  │  - LoginUser()               │  │
│  │  - LoginTestUser()           │  │
│  └──────────────────────────────┘  │
│  ┌──────────────────────────────┐  │
│  │   HTTP模块 (HTTP Module)     │  │
│  │  - DoRequest()               │  │
│  │  - DoAuthRequest()           │  │
│  └──────────────────────────────┘  │
│  ┌──────────────────────────────┐  │
│  │   断言模块 (Assert Module)    │  │
│  │  - AssertSuccess()           │  │
│  │  - AssertError()             │  │
│  └──────────────────────────────┘  │
│  ┌──────────────────────────────┐  │
│  │   数据库模块 (DB Module)      │  │
│  │  - GetTestBook()             │  │
│  │  - CleanupTestData()         │  │
│  └──────────────────────────────┘  │
│  ┌──────────────────────────────┐  │
│  │   日志模块 (Log Module)       │  │
│  │  - LogSuccess()              │  │
│  │  - LogError()                │  │
│  └──────────────────────────────┘  │
└─────────────────────────────────────┘
```

**详细文档**：参见 `test/integration/README_TestHelper使用指南.md`

### 3.2 路径常量管理

**位置**：`test/integration/helpers.go`

**设计原则**：
- ✅ 集中定义所有API路径
- ✅ 按模块分组
- ✅ 使用描述性命名
- ✅ 支持版本管理

**示例**：
```go
const (
    // 基础路径
    APIBasePath = "/api/v1"
    
    // 认证相关
    LoginPath    = APIBasePath + "/login"
    RegisterPath = APIBasePath + "/register"
    
    // 阅读器相关
    ReaderBooksPath       = APIBasePath + "/reader/books"
    ReaderCollectionsPath = APIBasePath + "/reader/collections"
    
    // 书城相关
    BookstoreHomePath = APIBasePath + "/bookstore/homepage"
)
```

### 3.3 测试数据管理

**策略**：

#### 3.3.1 数据准备策略

**A. 预置测试数据**（推荐用于集成测试）
- 使用数据迁移脚本导入
- 稳定、可重复
- 适合多个测试共享

**B. 动态创建数据**（推荐用于单元测试）
- 测试中临时创建
- 完全隔离
- 测试结束后清理

**C. 测试工厂模式**
- 使用Factory函数创建测试数据
- 支持自定义参数
- 自动管理生命周期

**示例**：
```go
// 预置数据使用
bookID := helper.GetTestBook()

// 动态创建
bookID := factory.CreateTestBook(t, "测试书籍")
defer factory.CleanupTestBook(t, bookID)

// 工厂模式
book := factory.NewBookBuilder().
    WithTitle("测试书籍").
    WithAuthor("测试作者").
    Build(t)
```

#### 3.3.2 数据清理策略

**原则**：
- ✅ 每个测试独立清理自己的数据
- ✅ 使用 `defer` 确保清理执行
- ✅ 清理失败不应导致测试失败（只记录警告）

**示例**：
```go
func TestExample(t *testing.T) {
    helper := integration.NewTestHelper(t, router)
    
    // 测试开始时清理可能的遗留数据
    helper.CleanupTestData("collections", "reading_progress")
    
    // 测试结束时清理
    defer helper.CleanupTestData("collections", "reading_progress")
    
    // 测试逻辑...
}
```

### 3.4 Mock服务

**使用场景**：
- 单元测试中隔离外部依赖
- 测试异常情况和边界条件
- 加速测试执行

**Mock策略**：

| 依赖类型 | Mock方式 | 工具 |
|---------|---------|------|
| Repository | 接口Mock | testify/mock |
| EventBus | 接口Mock | testify/mock |
| 外部API | HTTP Mock | httptest |
| 数据库 | 容器或内存DB | docker/sqlite |

**示例**：
```go
// Repository Mock
mockRepo := mocks.NewMockCollectionRepository(t)
mockRepo.EXPECT().
    FindByUserAndBook(userID, bookID).
    Return(nil, nil).
    Once()

// HTTP Mock
mockServer := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
    w.WriteHeader(http.StatusOK)
    json.NewEncoder(w).Encode(mockResponse)
}))
defer mockServer.Close()
```

---

## 四、测试组织原则

### 4.1 文件组织

```
test/
├── api/                    # API层测试
│   ├── reader/
│   │   ├── collection_api_test.go
│   │   └── like_api_test.go
│   └── bookstore/
│       └── bookstore_api_test.go
├── service/                # Service层测试
│   ├── collection_service_test.go
│   └── reading_service_test.go
├── repository/             # Repository层测试
│   ├── mongodb/
│   │   ├── collection_repository_test.go
│   │   └── book_repository_test.go
│   └── mock/
│       └── mock_repository.go
├── integration/            # 集成测试
│   ├── helpers.go          # TestHelper框架
│   ├── scenario_auth_test.go
│   ├── scenario_collection_test.go
│   ├── scenario_reading_test.go
│   └── e2e_user_lifecycle_test.go
├── testutil/               # 测试工具
│   ├── factory.go          # 测试数据工厂
│   └── fixtures.go         # 测试固件
└── README.md
```

### 4.2 测试命名规范

#### 4.2.1 文件命名

| 测试类型 | 命名规范 | 示例 |
|---------|---------|------|
| 单元测试 | `*_test.go` | `collection_service_test.go` |
| 集成测试（场景） | `scenario_*.go` | `scenario_collection_test.go` |
| 集成测试（流程） | `*_flow_test.go` | `reading_flow_test.go` |
| E2E测试 | `e2e_*.go` | `e2e_user_lifecycle_test.go` |
| 性能测试 | `*_benchmark_test.go` | `api_benchmark_test.go` |

#### 4.2.2 测试函数命名

**格式**：`Test<被测单元>_<测试场景>`

**示例**：
```go
// 好的命名
func TestCollectionService_AddToCollection_Success(t *testing.T)
func TestCollectionService_AddToCollection_AlreadyCollected(t *testing.T)
func TestCollectionService_AddToCollection_BookNotFound(t *testing.T)

// 不好的命名
func TestAdd(t *testing.T)
func TestCollection1(t *testing.T)
```

#### 4.2.3 子测试命名

**格式**：使用描述性中文或英文

**示例**：
```go
func TestCollectionScenario(t *testing.T) {
    t.Run("添加收藏", func(t *testing.T) { ... })
    t.Run("重复收藏检测", func(t *testing.T) { ... })
    t.Run("获取收藏列表", func(t *testing.T) { ... })
}
```

### 4.3 测试隔离策略

#### 4.3.1 数据隔离

**原则**：
- ✅ 每个测试使用独立的测试数据
- ✅ 不依赖其他测试的执行结果
- ✅ 测试可以以任意顺序执行

**方法**：
```go
// 方法1：使用唯一标识
userID := "test_user_" + uuid.New().String()

// 方法2：使用测试名称
testBookID := "test_book_" + t.Name()

// 方法3：使用时间戳
projectTitle := "测试项目_" + time.Now().Format("20060102150405")
```

#### 4.3.2 环境隔离

**测试数据库**：
- 开发：`qingyu_dev`
- 测试：`qingyu_test`
- 生产：`qingyu_prod`

**配置隔离**：
```go
// test/integration/setup.go
func setupTestEnvironment(t *testing.T) {
    // 加载测试配置
    cfg, err := config.LoadConfig("../../config.test.yaml")
    require.NoError(t, err)
    
    // 确保使用测试数据库
    assert.Contains(t, cfg.Database.Name, "test")
}
```

### 4.4 数据清理模式

#### 4.4.1 测试前清理

```go
func TestExample(t *testing.T) {
    helper := integration.NewTestHelper(t, router)
    
    // 清理可能的遗留数据
    helper.CleanupTestData("collections")
    
    // 测试逻辑...
}
```

#### 4.4.2 测试后清理

```go
func TestExample(t *testing.T) {
    helper := integration.NewTestHelper(t, router)
    
    // 确保测试后清理
    defer helper.CleanupTestData("collections")
    
    // 测试逻辑...
}
```

#### 4.4.3 批量清理

```go
func TestSuite(t *testing.T) {
    // 整个测试套件结束后清理
    defer func() {
        helper := integration.NewTestHelper(t, router)
        helper.CleanupTestData("collections", "reading_progress", "bookmarks")
    }()
    
    t.Run("测试1", func(t *testing.T) { ... })
    t.Run("测试2", func(t *testing.T) { ... })
}
```

---

## 五、测试覆盖率目标

### 5.1 覆盖率标准

| 层级 | 目标覆盖率 | 最低要求 | 优先级 |
|-----|----------|---------|--------|
| Repository层 | 80%+ | 70% | 🔴 高 |
| Service层 | 75%+ | 65% | 🔴 高 |
| API层 | 70%+ | 60% | 🟡 中 |
| Models层 | 60%+ | 50% | 🟢 低 |
| 总体 | 75%+ | 65% | 🔴 高 |

### 5.2 覆盖率监控

**工具**：
- `go test -cover`：基础覆盖率
- `go test -coverprofile`：详细报告
- `go tool cover -html`：可视化报告

**示例**：
```bash
# 运行测试并生成覆盖率报告
go test ./... -coverprofile=coverage.out

# 查看总体覆盖率
go tool cover -func=coverage.out

# 生成HTML报告
go tool cover -html=coverage.out -o coverage.html
```

### 5.3 关键路径100%覆盖

**必须100%覆盖的代码**：
- ✅ 认证和授权逻辑
- ✅ 支付和交易逻辑
- ✅ 数据验证和安全检查
- ✅ 错误处理和异常恢复
- ✅ 核心业务流程

---

## 六、测试最佳实践

### 6.1 测试编写原则

#### 6.1.1 AAA模式

```go
func TestExample(t *testing.T) {
    // Arrange（准备）
    helper := integration.NewTestHelper(t, router)
    token := helper.LoginTestUser()
    bookID := helper.GetTestBook()
    
    // Act（执行）
    w := helper.DoAuthRequest("POST", path, reqBody, token)
    
    // Assert（断言）
    helper.AssertSuccess(w, 201, "添加收藏失败")
}
```

#### 6.1.2 单一职责

```go
// ✅ 好的做法：每个测试只验证一个场景
func TestAddCollection_Success(t *testing.T) { ... }
func TestAddCollection_AlreadyCollected(t *testing.T) { ... }
func TestAddCollection_BookNotFound(t *testing.T) { ... }

// ❌ 不好的做法：一个测试验证多个场景
func TestAddCollection(t *testing.T) {
    // 测试成功
    // 测试重复收藏
    // 测试书籍不存在
}
```

#### 6.1.3 清晰的错误信息

```go
// ✅ 好的做法
helper.AssertSuccess(w, 201, 
    "添加收藏失败 - 用户ID: %s, 书籍ID: %s", 
    userID, bookID)

// ❌ 不好的做法
assert.Equal(t, 201, w.Code)
```

### 6.2 性能考虑

#### 6.2.1 测试执行时间

| 测试类型 | 目标时间 | 最大时间 | 建议 |
|---------|---------|---------|------|
| 单元测试 | < 100ms | < 1s | 使用Mock |
| 集成测试 | < 5s | < 30s | 优化数据准备 |
| E2E测试 | < 30s | < 2min | 选择关键场景 |

#### 6.2.2 并行执行

```go
// 适合并行的测试
func TestExample(t *testing.T) {
    t.Parallel()  // 标记为可并行执行
    
    // 测试逻辑...
}
```

#### 6.2.3 测试数据复用

```go
// 使用SetupSuite一次性准备共享数据
func setupTestData(t *testing.T) {
    // 导入测试书籍（多个测试共享）
    // 创建测试用户（多个测试共享）
}
```

### 6.3 常见陷阱

#### 6.3.1 测试依赖顺序

```go
// ❌ 不好：测试2依赖测试1的执行结果
func TestCreateCollection(t *testing.T) {
    // 创建收藏，collectionID保存到全局变量
}

func TestUpdateCollection(t *testing.T) {
    // 使用全局变量中的collectionID
}

// ✅ 好：每个测试独立
func TestUpdateCollection(t *testing.T) {
    // 在测试内创建必要的收藏数据
    collectionID := createTestCollection(t)
    // 更新收藏
}
```

#### 6.3.2 硬编码数据

```go
// ❌ 不好：硬编码ID
bookID := "507f1f77bcf86cd799439011"

// ✅ 好：从数据库获取或动态创建
bookID := helper.GetTestBook()
```

#### 6.3.3 忽略错误

```go
// ❌ 不好：忽略可能的错误
result, _ := service.GetCollection(ctx, id)

// ✅ 好：明确处理错误
result, err := service.GetCollection(ctx, id)
require.NoError(t, err)
```

---

## 七、测试环境

### 7.1 本地开发环境

**要求**：
- Go 1.21+
- MongoDB 6.0+（测试数据库）
- Redis（可选）

**配置**：
```yaml
# config.test.yaml
database:
  host: localhost
  port: 27017
  name: qingyu_test
  username: test_user
  password: test_pass
```

### 7.2 CI/CD环境

**Docker Compose配置**：
```yaml
# docker-compose.test.yml
services:
  mongodb-test:
    image: mongo:6.0
    environment:
      MONGO_INITDB_DATABASE: qingyu_test
    ports:
      - "27018:27017"
```

**CI流程**：
1. 启动测试数据库
2. 导入测试数据
3. 运行测试
4. 生成覆盖率报告
5. 清理环境

---

## 八、持续改进

### 8.1 测试审查清单

- [ ] 测试命名清晰描述
- [ ] 测试独立不依赖其他测试
- [ ] 使用TestHelper而非手动构造请求
- [ ] 错误信息详细具体
- [ ] 数据正确清理
- [ ] 避免硬编码值
- [ ] 测试覆盖正常和异常场景

### 8.2 定期回顾

**每季度**：
- 审查测试覆盖率趋势
- 识别不稳定的测试
- 优化慢速测试
- 更新测试文档

### 8.3 团队培训

**培训内容**：
- TestHelper使用指南
- 测试编写最佳实践
- Mock使用技巧
- 测试调试方法

---

## 九、参考资料

### 9.1 内部文档

- `test/integration/README_TestHelper使用指南.md` - TestHelper详细使用
- `doc/testing/测试工具设计文档.md` - 测试工具设计
- `doc/testing/测试组织规范.md` - 测试组织标准

### 9.2 外部参考

- [Go Testing Best Practices](https://go.dev/doc/tutorial/add-a-test)
- [Testify Documentation](https://github.com/stretchr/testify)
- [Testing Strategies in Go](https://golang.org/doc/code.html#Testing)

---

## 十、版本历史

| 版本 | 日期 | 变更内容 | 作者 |
|-----|------|---------|------|
| 1.0 | 2025-10-25 | 初始版本发布 | 后端团队 |

---

**维护者**：后端开发团队  
**审核者**：技术负责人  
**问题反馈**：请在项目仓库提Issue

