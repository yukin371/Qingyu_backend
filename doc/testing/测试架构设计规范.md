# æµ‹è¯•æ¶æ„è®¾è®¡è§„èŒƒ

**ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¶é—´**: 2025-10-25  
**çŠ¶æ€**: âœ… æ­£å¼å‘å¸ƒ

---

## ä¸€ã€æ¦‚è¿°

### 1.1 ç›®æ ‡

æœ¬æ–‡æ¡£å®šä¹‰é’ç¾½å†™ä½œåç«¯æœåŠ¡çš„æµ‹è¯•æ¶æ„è®¾è®¡è§„èŒƒï¼Œç¡®ä¿æµ‹è¯•ä»£ç çš„è´¨é‡ã€å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

### 1.2 é€‚ç”¨èŒƒå›´

- æ‰€æœ‰æ–°ç¼–å†™çš„æµ‹è¯•ä»£ç 
- æ­£åœ¨é‡æ„çš„ç°æœ‰æµ‹è¯•
- æµ‹è¯•å·¥å…·å’Œæµ‹è¯•åŸºç¡€è®¾æ–½çš„å¼€å‘

### 1.3 æ ¸å¿ƒåŸåˆ™

1. **åˆ†å±‚æ¸…æ™°**ï¼šæµ‹è¯•æŒ‰å±‚çº§ç»„ç»‡ï¼ŒèŒè´£æ˜ç¡®
2. **å¯ç»´æŠ¤æ€§**ï¼šæµ‹è¯•ä»£ç æ˜“äºç†è§£å’Œä¿®æ”¹
3. **ç‹¬ç«‹æ€§**ï¼šæµ‹è¯•ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œä¸ç›¸äº’å½±å“
4. **å¯é‡å¤æ€§**ï¼šæµ‹è¯•ç»“æœç¨³å®šå¯é‡å¤
5. **é«˜æ•ˆæ€§**ï¼šæµ‹è¯•æ‰§è¡Œå¿«é€Ÿï¼Œåé¦ˆåŠæ—¶

---

## äºŒã€æµ‹è¯•åˆ†å±‚æ¶æ„

### 2.1 æµ‹è¯•é‡‘å­—å¡”

```
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚   E2E Tests â”‚  (10%)
           â”‚  ç«¯åˆ°ç«¯æµ‹è¯•  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Integration Testsâ”‚  (30%)
         â”‚    é›†æˆæµ‹è¯•       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚      Unit Tests         â”‚  (60%)
     â”‚       å•å…ƒæµ‹è¯•           â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åˆ†å±‚åŸåˆ™**ï¼š
- **å•å…ƒæµ‹è¯•ï¼ˆ60%ï¼‰**ï¼šå¿«é€Ÿã€éš”ç¦»ã€å¤§é‡
- **é›†æˆæµ‹è¯•ï¼ˆ30%ï¼‰**ï¼šå…³é”®æµç¨‹ã€è·¨å±‚äº¤äº’
- **E2Eæµ‹è¯•ï¼ˆ10%ï¼‰**ï¼šæ ¸å¿ƒä¸šåŠ¡åœºæ™¯ã€ç«¯åˆ°ç«¯éªŒè¯

### 2.2 å„å±‚æµ‹è¯•è¯¦è§£

#### 2.2.1 å•å…ƒæµ‹è¯•ï¼ˆUnit Testsï¼‰

**ä½ç½®**ï¼šä¸è¢«æµ‹ä»£ç åŒç›®å½•æˆ– `test/` ç›®å½•ä¸‹

**å‘½åè§„èŒƒ**ï¼š`*_test.go`

**æµ‹è¯•èŒƒå›´**ï¼š
- **Repositoryå±‚**ï¼šæ•°æ®è®¿é—®é€»è¾‘ã€æŸ¥è¯¢æ„å»ºã€é”™è¯¯å¤„ç†
- **Serviceå±‚**ï¼šä¸šåŠ¡é€»è¾‘ã€å‚æ•°éªŒè¯ã€å¼‚å¸¸å¤„ç†
- **Modelså±‚**ï¼šæ•°æ®ç»“æ„ã€æ–¹æ³•ã€éªŒè¯è§„åˆ™

**ç‰¹ç‚¹**ï¼š
- âœ… ä½¿ç”¨Mockä¾èµ–ï¼ˆRepositoryã€EventBusç­‰ï¼‰
- âœ… æµ‹è¯•å•ä¸€åŠŸèƒ½ç‚¹
- âœ… å¿«é€Ÿæ‰§è¡Œï¼ˆ< 1ç§’ï¼‰
- âœ… ä¸ä¾èµ–å¤–éƒ¨èµ„æºï¼ˆæ•°æ®åº“ã€ç½‘ç»œç­‰ï¼‰

**ç¤ºä¾‹**ï¼š
```go
// test/service/collection_service_test.go
func TestCollectionService_AddToCollection(t *testing.T) {
    // ä½¿ç”¨Mock Repository
    mockRepo := mocks.NewMockCollectionRepository(t)
    mockEventBus := mocks.NewMockEventBus(t)
    
    service := NewCollectionService(mockRepo, mockEventBus)
    
    // æµ‹è¯•æ­£å¸¸æ·»åŠ 
    mockRepo.EXPECT().FindByUserAndBook(userID, bookID).Return(nil, nil)
    mockRepo.EXPECT().Create(mock.Anything).Return(collection, nil)
    
    result, err := service.AddToCollection(ctx, userID, bookID, "", "", nil, false)
    
    assert.NoError(t, err)
    assert.NotNil(t, result)
}
```

#### 2.2.2 é›†æˆæµ‹è¯•ï¼ˆIntegration Testsï¼‰

**ä½ç½®**ï¼š`test/integration/`

**å‘½åè§„èŒƒ**ï¼š
- åœºæ™¯æµ‹è¯•ï¼š`scenario_*.go`
- æµç¨‹æµ‹è¯•ï¼š`*_flow_test.go`
- APIæµ‹è¯•ï¼š`*_api_test.go`

**æµ‹è¯•èŒƒå›´**ï¼š
- **APIå±‚ â†’ Serviceå±‚ â†’ Repositoryå±‚**ï¼šå®Œæ•´çš„è¯·æ±‚å“åº”æµç¨‹
- **å¤šä¸ªServiceäº¤äº’**ï¼šè·¨æœåŠ¡çš„ä¸šåŠ¡æµç¨‹
- **æ•°æ®åº“æ“ä½œ**ï¼šçœŸå®æ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥

**ç‰¹ç‚¹**ï¼š
- âœ… ä½¿ç”¨çœŸå®çš„æ•°æ®åº“è¿æ¥
- âœ… æµ‹è¯•å®Œæ•´çš„ä¸šåŠ¡æµç¨‹
- âœ… éªŒè¯å„å±‚åä½œæ˜¯å¦æ­£å¸¸
- âœ… æ‰§è¡Œæ—¶é—´é€‚ä¸­ï¼ˆ1-10ç§’ï¼‰

**ç¤ºä¾‹**ï¼š
```go
// test/integration/scenario_collection_test.go
func TestCollectionScenario(t *testing.T) {
    helper := integration.NewTestHelper(t, router)
    token := helper.LoginTestUser()
    bookID := helper.GetTestBook()
    
    t.Run("æ·»åŠ æ”¶è—", func(t *testing.T) {
        reqBody := map[string]interface{}{
            "book_id": bookID,
            "note": "æµ‹è¯•ç¬”è®°",
        }
        
        w := helper.DoAuthRequest("POST", integration.ReaderCollectionsPath, reqBody, token)
        helper.AssertSuccess(w, 201, "æ·»åŠ æ”¶è—å¤±è´¥")
    })
}
```

#### 2.2.3 ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆE2E Testsï¼‰

**ä½ç½®**ï¼š`test/integration/` æˆ– `test/e2e/`

**å‘½åè§„èŒƒ**ï¼š`e2e_*.go` æˆ– `*_e2e_test.go`

**æµ‹è¯•èŒƒå›´**ï¼š
- **å®Œæ•´ç”¨æˆ·æµç¨‹**ï¼šä»æ³¨å†Œåˆ°ä½¿ç”¨æ ¸å¿ƒåŠŸèƒ½
- **è·¨æ¨¡å—äº¤äº’**ï¼šé˜…è¯»ã€å†™ä½œã€ä¹¦åŸç­‰æ¨¡å—åä½œ
- **çœŸå®ç”¨æˆ·åœºæ™¯**ï¼šæ¨¡æ‹Ÿå®é™…ç”¨æˆ·æ“ä½œ

**ç‰¹ç‚¹**ï¼š
- âœ… æµ‹è¯•å®Œæ•´çš„ç”¨æˆ·æ—…ç¨‹
- âœ… éªŒè¯ç³»ç»Ÿæ•´ä½“åŠŸèƒ½
- âœ… åŒ…å«è®¤è¯ã€æƒé™ç­‰æ‰€æœ‰ç¯èŠ‚
- âœ… æ‰§è¡Œæ—¶é—´è¾ƒé•¿ï¼ˆ10-60ç§’ï¼‰

**ç¤ºä¾‹**ï¼š
```go
// test/integration/e2e_user_lifecycle_test.go
func TestUserLifecycle(t *testing.T) {
    // 1. ç”¨æˆ·æ³¨å†Œ
    // 2. ç”¨æˆ·ç™»å½•
    // 3. æµè§ˆä¹¦åŸ
    // 4. æ·»åŠ åˆ°ä¹¦æ¶
    // 5. å¼€å§‹é˜…è¯»
    // 6. æ·»åŠ ä¹¦ç­¾
    // 7. æ”¶è—ä¹¦ç±
    // 8. å‘è¡¨è¯„è®º
}
```

---

## ä¸‰ã€æµ‹è¯•åŸºç¡€è®¾æ–½

### 3.1 TestHelperæ¡†æ¶

**ä½ç½®**ï¼š`test/integration/helpers.go`

**æ ¸å¿ƒèŒè´£**ï¼š
1. **è®¤è¯ç®¡ç†**ï¼šç»Ÿä¸€çš„ç™»å½•å’Œtokenç®¡ç†
2. **HTTPè¯·æ±‚**ï¼šç®€åŒ–è¯·æ±‚æ„é€ å’Œå‘é€
3. **å“åº”æ–­è¨€**ï¼šè¯¦ç»†çš„é”™è¯¯è¯Šæ–­ä¿¡æ¯
4. **æ•°æ®åº“æ“ä½œ**ï¼šæµ‹è¯•æ•°æ®è·å–å’Œæ¸…ç†
5. **æ—¥å¿—è®°å½•**ï¼šç»“æ„åŒ–çš„æµ‹è¯•æ—¥å¿—

**æ¶æ„å›¾**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        TestHelper æ¡†æ¶              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   è®¤è¯æ¨¡å— (Auth Module)      â”‚  â”‚
â”‚  â”‚  - LoginUser()               â”‚  â”‚
â”‚  â”‚  - LoginTestUser()           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   HTTPæ¨¡å— (HTTP Module)     â”‚  â”‚
â”‚  â”‚  - DoRequest()               â”‚  â”‚
â”‚  â”‚  - DoAuthRequest()           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   æ–­è¨€æ¨¡å— (Assert Module)    â”‚  â”‚
â”‚  â”‚  - AssertSuccess()           â”‚  â”‚
â”‚  â”‚  - AssertError()             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   æ•°æ®åº“æ¨¡å— (DB Module)      â”‚  â”‚
â”‚  â”‚  - GetTestBook()             â”‚  â”‚
â”‚  â”‚  - CleanupTestData()         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   æ—¥å¿—æ¨¡å— (Log Module)       â”‚  â”‚
â”‚  â”‚  - LogSuccess()              â”‚  â”‚
â”‚  â”‚  - LogError()                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯¦ç»†æ–‡æ¡£**ï¼šå‚è§ `test/integration/README_TestHelperä½¿ç”¨æŒ‡å—.md`

### 3.2 è·¯å¾„å¸¸é‡ç®¡ç†

**ä½ç½®**ï¼š`test/integration/helpers.go`

**è®¾è®¡åŸåˆ™**ï¼š
- âœ… é›†ä¸­å®šä¹‰æ‰€æœ‰APIè·¯å¾„
- âœ… æŒ‰æ¨¡å—åˆ†ç»„
- âœ… ä½¿ç”¨æè¿°æ€§å‘½å
- âœ… æ”¯æŒç‰ˆæœ¬ç®¡ç†

**ç¤ºä¾‹**ï¼š
```go
const (
    // åŸºç¡€è·¯å¾„
    APIBasePath = "/api/v1"
    
    // è®¤è¯ç›¸å…³
    LoginPath    = APIBasePath + "/login"
    RegisterPath = APIBasePath + "/register"
    
    // é˜…è¯»å™¨ç›¸å…³
    ReaderBooksPath       = APIBasePath + "/reader/books"
    ReaderCollectionsPath = APIBasePath + "/reader/collections"
    
    // ä¹¦åŸç›¸å…³
    BookstoreHomePath = APIBasePath + "/bookstore/homepage"
)
```

### 3.3 æµ‹è¯•æ•°æ®ç®¡ç†

**ç­–ç•¥**ï¼š

#### 3.3.1 æ•°æ®å‡†å¤‡ç­–ç•¥

**A. é¢„ç½®æµ‹è¯•æ•°æ®**ï¼ˆæ¨èç”¨äºé›†æˆæµ‹è¯•ï¼‰
- ä½¿ç”¨æ•°æ®è¿ç§»è„šæœ¬å¯¼å…¥
- ç¨³å®šã€å¯é‡å¤
- é€‚åˆå¤šä¸ªæµ‹è¯•å…±äº«

**B. åŠ¨æ€åˆ›å»ºæ•°æ®**ï¼ˆæ¨èç”¨äºå•å…ƒæµ‹è¯•ï¼‰
- æµ‹è¯•ä¸­ä¸´æ—¶åˆ›å»º
- å®Œå…¨éš”ç¦»
- æµ‹è¯•ç»“æŸåæ¸…ç†

**C. æµ‹è¯•å·¥å‚æ¨¡å¼**
- ä½¿ç”¨Factoryå‡½æ•°åˆ›å»ºæµ‹è¯•æ•°æ®
- æ”¯æŒè‡ªå®šä¹‰å‚æ•°
- è‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ

**ç¤ºä¾‹**ï¼š
```go
// é¢„ç½®æ•°æ®ä½¿ç”¨
bookID := helper.GetTestBook()

// åŠ¨æ€åˆ›å»º
bookID := factory.CreateTestBook(t, "æµ‹è¯•ä¹¦ç±")
defer factory.CleanupTestBook(t, bookID)

// å·¥å‚æ¨¡å¼
book := factory.NewBookBuilder().
    WithTitle("æµ‹è¯•ä¹¦ç±").
    WithAuthor("æµ‹è¯•ä½œè€…").
    Build(t)
```

#### 3.3.2 æ•°æ®æ¸…ç†ç­–ç•¥

**åŸåˆ™**ï¼š
- âœ… æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹æ¸…ç†è‡ªå·±çš„æ•°æ®
- âœ… ä½¿ç”¨ `defer` ç¡®ä¿æ¸…ç†æ‰§è¡Œ
- âœ… æ¸…ç†å¤±è´¥ä¸åº”å¯¼è‡´æµ‹è¯•å¤±è´¥ï¼ˆåªè®°å½•è­¦å‘Šï¼‰

**ç¤ºä¾‹**ï¼š
```go
func TestExample(t *testing.T) {
    helper := integration.NewTestHelper(t, router)
    
    // æµ‹è¯•å¼€å§‹æ—¶æ¸…ç†å¯èƒ½çš„é—ç•™æ•°æ®
    helper.CleanupTestData("collections", "reading_progress")
    
    // æµ‹è¯•ç»“æŸæ—¶æ¸…ç†
    defer helper.CleanupTestData("collections", "reading_progress")
    
    // æµ‹è¯•é€»è¾‘...
}
```

### 3.4 MockæœåŠ¡

**ä½¿ç”¨åœºæ™¯**ï¼š
- å•å…ƒæµ‹è¯•ä¸­éš”ç¦»å¤–éƒ¨ä¾èµ–
- æµ‹è¯•å¼‚å¸¸æƒ…å†µå’Œè¾¹ç•Œæ¡ä»¶
- åŠ é€Ÿæµ‹è¯•æ‰§è¡Œ

**Mockç­–ç•¥**ï¼š

| ä¾èµ–ç±»å‹ | Mockæ–¹å¼ | å·¥å…· |
|---------|---------|------|
| Repository | æ¥å£Mock | testify/mock |
| EventBus | æ¥å£Mock | testify/mock |
| å¤–éƒ¨API | HTTP Mock | httptest |
| æ•°æ®åº“ | å®¹å™¨æˆ–å†…å­˜DB | docker/sqlite |

**ç¤ºä¾‹**ï¼š
```go
// Repository Mock
mockRepo := mocks.NewMockCollectionRepository(t)
mockRepo.EXPECT().
    FindByUserAndBook(userID, bookID).
    Return(nil, nil).
    Once()

// HTTP Mock
mockServer := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
    w.WriteHeader(http.StatusOK)
    json.NewEncoder(w).Encode(mockResponse)
}))
defer mockServer.Close()
```

---

## å››ã€æµ‹è¯•ç»„ç»‡åŸåˆ™

### 4.1 æ–‡ä»¶ç»„ç»‡

```
test/
â”œâ”€â”€ api/                    # APIå±‚æµ‹è¯•
â”‚   â”œâ”€â”€ reader/
â”‚   â”‚   â”œâ”€â”€ collection_api_test.go
â”‚   â”‚   â””â”€â”€ like_api_test.go
â”‚   â””â”€â”€ bookstore/
â”‚       â””â”€â”€ bookstore_api_test.go
â”œâ”€â”€ service/                # Serviceå±‚æµ‹è¯•
â”‚   â”œâ”€â”€ collection_service_test.go
â”‚   â””â”€â”€ reading_service_test.go
â”œâ”€â”€ repository/             # Repositoryå±‚æµ‹è¯•
â”‚   â”œâ”€â”€ mongodb/
â”‚   â”‚   â”œâ”€â”€ collection_repository_test.go
â”‚   â”‚   â””â”€â”€ book_repository_test.go
â”‚   â””â”€â”€ mock/
â”‚       â””â”€â”€ mock_repository.go
â”œâ”€â”€ integration/            # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ helpers.go          # TestHelperæ¡†æ¶
â”‚   â”œâ”€â”€ scenario_auth_test.go
â”‚   â”œâ”€â”€ scenario_collection_test.go
â”‚   â”œâ”€â”€ scenario_reading_test.go
â”‚   â””â”€â”€ e2e_user_lifecycle_test.go
â”œâ”€â”€ testutil/               # æµ‹è¯•å·¥å…·
â”‚   â”œâ”€â”€ factory.go          # æµ‹è¯•æ•°æ®å·¥å‚
â”‚   â””â”€â”€ fixtures.go         # æµ‹è¯•å›ºä»¶
â””â”€â”€ README.md
```

### 4.2 æµ‹è¯•å‘½åè§„èŒƒ

#### 4.2.1 æ–‡ä»¶å‘½å

| æµ‹è¯•ç±»å‹ | å‘½åè§„èŒƒ | ç¤ºä¾‹ |
|---------|---------|------|
| å•å…ƒæµ‹è¯• | `*_test.go` | `collection_service_test.go` |
| é›†æˆæµ‹è¯•ï¼ˆåœºæ™¯ï¼‰ | `scenario_*.go` | `scenario_collection_test.go` |
| é›†æˆæµ‹è¯•ï¼ˆæµç¨‹ï¼‰ | `*_flow_test.go` | `reading_flow_test.go` |
| E2Eæµ‹è¯• | `e2e_*.go` | `e2e_user_lifecycle_test.go` |
| æ€§èƒ½æµ‹è¯• | `*_benchmark_test.go` | `api_benchmark_test.go` |

#### 4.2.2 æµ‹è¯•å‡½æ•°å‘½å

**æ ¼å¼**ï¼š`Test<è¢«æµ‹å•å…ƒ>_<æµ‹è¯•åœºæ™¯>`

**ç¤ºä¾‹**ï¼š
```go
// å¥½çš„å‘½å
func TestCollectionService_AddToCollection_Success(t *testing.T)
func TestCollectionService_AddToCollection_AlreadyCollected(t *testing.T)
func TestCollectionService_AddToCollection_BookNotFound(t *testing.T)

// ä¸å¥½çš„å‘½å
func TestAdd(t *testing.T)
func TestCollection1(t *testing.T)
```

#### 4.2.3 å­æµ‹è¯•å‘½å

**æ ¼å¼**ï¼šä½¿ç”¨æè¿°æ€§ä¸­æ–‡æˆ–è‹±æ–‡

**ç¤ºä¾‹**ï¼š
```go
func TestCollectionScenario(t *testing.T) {
    t.Run("æ·»åŠ æ”¶è—", func(t *testing.T) { ... })
    t.Run("é‡å¤æ”¶è—æ£€æµ‹", func(t *testing.T) { ... })
    t.Run("è·å–æ”¶è—åˆ—è¡¨", func(t *testing.T) { ... })
}
```

### 4.3 æµ‹è¯•éš”ç¦»ç­–ç•¥

#### 4.3.1 æ•°æ®éš”ç¦»

**åŸåˆ™**ï¼š
- âœ… æ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„æµ‹è¯•æ•°æ®
- âœ… ä¸ä¾èµ–å…¶ä»–æµ‹è¯•çš„æ‰§è¡Œç»“æœ
- âœ… æµ‹è¯•å¯ä»¥ä»¥ä»»æ„é¡ºåºæ‰§è¡Œ

**æ–¹æ³•**ï¼š
```go
// æ–¹æ³•1ï¼šä½¿ç”¨å”¯ä¸€æ ‡è¯†
userID := "test_user_" + uuid.New().String()

// æ–¹æ³•2ï¼šä½¿ç”¨æµ‹è¯•åç§°
testBookID := "test_book_" + t.Name()

// æ–¹æ³•3ï¼šä½¿ç”¨æ—¶é—´æˆ³
projectTitle := "æµ‹è¯•é¡¹ç›®_" + time.Now().Format("20060102150405")
```

#### 4.3.2 ç¯å¢ƒéš”ç¦»

**æµ‹è¯•æ•°æ®åº“**ï¼š
- å¼€å‘ï¼š`qingyu_dev`
- æµ‹è¯•ï¼š`qingyu_test`
- ç”Ÿäº§ï¼š`qingyu_prod`

**é…ç½®éš”ç¦»**ï¼š
```go
// test/integration/setup.go
func setupTestEnvironment(t *testing.T) {
    // åŠ è½½æµ‹è¯•é…ç½®
    cfg, err := config.LoadConfig("../../config.test.yaml")
    require.NoError(t, err)
    
    // ç¡®ä¿ä½¿ç”¨æµ‹è¯•æ•°æ®åº“
    assert.Contains(t, cfg.Database.Name, "test")
}
```

### 4.4 æ•°æ®æ¸…ç†æ¨¡å¼

#### 4.4.1 æµ‹è¯•å‰æ¸…ç†

```go
func TestExample(t *testing.T) {
    helper := integration.NewTestHelper(t, router)
    
    // æ¸…ç†å¯èƒ½çš„é—ç•™æ•°æ®
    helper.CleanupTestData("collections")
    
    // æµ‹è¯•é€»è¾‘...
}
```

#### 4.4.2 æµ‹è¯•åæ¸…ç†

```go
func TestExample(t *testing.T) {
    helper := integration.NewTestHelper(t, router)
    
    // ç¡®ä¿æµ‹è¯•åæ¸…ç†
    defer helper.CleanupTestData("collections")
    
    // æµ‹è¯•é€»è¾‘...
}
```

#### 4.4.3 æ‰¹é‡æ¸…ç†

```go
func TestSuite(t *testing.T) {
    // æ•´ä¸ªæµ‹è¯•å¥—ä»¶ç»“æŸåæ¸…ç†
    defer func() {
        helper := integration.NewTestHelper(t, router)
        helper.CleanupTestData("collections", "reading_progress", "bookmarks")
    }()
    
    t.Run("æµ‹è¯•1", func(t *testing.T) { ... })
    t.Run("æµ‹è¯•2", func(t *testing.T) { ... })
}
```

---

## äº”ã€æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

### 5.1 è¦†ç›–ç‡æ ‡å‡†

| å±‚çº§ | ç›®æ ‡è¦†ç›–ç‡ | æœ€ä½è¦æ±‚ | ä¼˜å…ˆçº§ |
|-----|----------|---------|--------|
| Repositoryå±‚ | 80%+ | 70% | ğŸ”´ é«˜ |
| Serviceå±‚ | 75%+ | 65% | ğŸ”´ é«˜ |
| APIå±‚ | 70%+ | 60% | ğŸŸ¡ ä¸­ |
| Modelså±‚ | 60%+ | 50% | ğŸŸ¢ ä½ |
| æ€»ä½“ | 75%+ | 65% | ğŸ”´ é«˜ |

### 5.2 è¦†ç›–ç‡ç›‘æ§

**å·¥å…·**ï¼š
- `go test -cover`ï¼šåŸºç¡€è¦†ç›–ç‡
- `go test -coverprofile`ï¼šè¯¦ç»†æŠ¥å‘Š
- `go tool cover -html`ï¼šå¯è§†åŒ–æŠ¥å‘Š

**ç¤ºä¾‹**ï¼š
```bash
# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
go test ./... -coverprofile=coverage.out

# æŸ¥çœ‹æ€»ä½“è¦†ç›–ç‡
go tool cover -func=coverage.out

# ç”ŸæˆHTMLæŠ¥å‘Š
go tool cover -html=coverage.out -o coverage.html
```

### 5.3 å…³é”®è·¯å¾„100%è¦†ç›–

**å¿…é¡»100%è¦†ç›–çš„ä»£ç **ï¼š
- âœ… è®¤è¯å’Œæˆæƒé€»è¾‘
- âœ… æ”¯ä»˜å’Œäº¤æ˜“é€»è¾‘
- âœ… æ•°æ®éªŒè¯å’Œå®‰å…¨æ£€æŸ¥
- âœ… é”™è¯¯å¤„ç†å’Œå¼‚å¸¸æ¢å¤
- âœ… æ ¸å¿ƒä¸šåŠ¡æµç¨‹

---

## å…­ã€æµ‹è¯•æœ€ä½³å®è·µ

### 6.1 æµ‹è¯•ç¼–å†™åŸåˆ™

#### 6.1.1 AAAæ¨¡å¼

```go
func TestExample(t *testing.T) {
    // Arrangeï¼ˆå‡†å¤‡ï¼‰
    helper := integration.NewTestHelper(t, router)
    token := helper.LoginTestUser()
    bookID := helper.GetTestBook()
    
    // Actï¼ˆæ‰§è¡Œï¼‰
    w := helper.DoAuthRequest("POST", path, reqBody, token)
    
    // Assertï¼ˆæ–­è¨€ï¼‰
    helper.AssertSuccess(w, 201, "æ·»åŠ æ”¶è—å¤±è´¥")
}
```

#### 6.1.2 å•ä¸€èŒè´£

```go
// âœ… å¥½çš„åšæ³•ï¼šæ¯ä¸ªæµ‹è¯•åªéªŒè¯ä¸€ä¸ªåœºæ™¯
func TestAddCollection_Success(t *testing.T) { ... }
func TestAddCollection_AlreadyCollected(t *testing.T) { ... }
func TestAddCollection_BookNotFound(t *testing.T) { ... }

// âŒ ä¸å¥½çš„åšæ³•ï¼šä¸€ä¸ªæµ‹è¯•éªŒè¯å¤šä¸ªåœºæ™¯
func TestAddCollection(t *testing.T) {
    // æµ‹è¯•æˆåŠŸ
    // æµ‹è¯•é‡å¤æ”¶è—
    // æµ‹è¯•ä¹¦ç±ä¸å­˜åœ¨
}
```

#### 6.1.3 æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

```go
// âœ… å¥½çš„åšæ³•
helper.AssertSuccess(w, 201, 
    "æ·»åŠ æ”¶è—å¤±è´¥ - ç”¨æˆ·ID: %s, ä¹¦ç±ID: %s", 
    userID, bookID)

// âŒ ä¸å¥½çš„åšæ³•
assert.Equal(t, 201, w.Code)
```

### 6.2 æ€§èƒ½è€ƒè™‘

#### 6.2.1 æµ‹è¯•æ‰§è¡Œæ—¶é—´

| æµ‹è¯•ç±»å‹ | ç›®æ ‡æ—¶é—´ | æœ€å¤§æ—¶é—´ | å»ºè®® |
|---------|---------|---------|------|
| å•å…ƒæµ‹è¯• | < 100ms | < 1s | ä½¿ç”¨Mock |
| é›†æˆæµ‹è¯• | < 5s | < 30s | ä¼˜åŒ–æ•°æ®å‡†å¤‡ |
| E2Eæµ‹è¯• | < 30s | < 2min | é€‰æ‹©å…³é”®åœºæ™¯ |

#### 6.2.2 å¹¶è¡Œæ‰§è¡Œ

```go
// é€‚åˆå¹¶è¡Œçš„æµ‹è¯•
func TestExample(t *testing.T) {
    t.Parallel()  // æ ‡è®°ä¸ºå¯å¹¶è¡Œæ‰§è¡Œ
    
    // æµ‹è¯•é€»è¾‘...
}
```

#### 6.2.3 æµ‹è¯•æ•°æ®å¤ç”¨

```go
// ä½¿ç”¨SetupSuiteä¸€æ¬¡æ€§å‡†å¤‡å…±äº«æ•°æ®
func setupTestData(t *testing.T) {
    // å¯¼å…¥æµ‹è¯•ä¹¦ç±ï¼ˆå¤šä¸ªæµ‹è¯•å…±äº«ï¼‰
    // åˆ›å»ºæµ‹è¯•ç”¨æˆ·ï¼ˆå¤šä¸ªæµ‹è¯•å…±äº«ï¼‰
}
```

### 6.3 å¸¸è§é™·é˜±

#### 6.3.1 æµ‹è¯•ä¾èµ–é¡ºåº

```go
// âŒ ä¸å¥½ï¼šæµ‹è¯•2ä¾èµ–æµ‹è¯•1çš„æ‰§è¡Œç»“æœ
func TestCreateCollection(t *testing.T) {
    // åˆ›å»ºæ”¶è—ï¼ŒcollectionIDä¿å­˜åˆ°å…¨å±€å˜é‡
}

func TestUpdateCollection(t *testing.T) {
    // ä½¿ç”¨å…¨å±€å˜é‡ä¸­çš„collectionID
}

// âœ… å¥½ï¼šæ¯ä¸ªæµ‹è¯•ç‹¬ç«‹
func TestUpdateCollection(t *testing.T) {
    // åœ¨æµ‹è¯•å†…åˆ›å»ºå¿…è¦çš„æ”¶è—æ•°æ®
    collectionID := createTestCollection(t)
    // æ›´æ–°æ”¶è—
}
```

#### 6.3.2 ç¡¬ç¼–ç æ•°æ®

```go
// âŒ ä¸å¥½ï¼šç¡¬ç¼–ç ID
bookID := "507f1f77bcf86cd799439011"

// âœ… å¥½ï¼šä»æ•°æ®åº“è·å–æˆ–åŠ¨æ€åˆ›å»º
bookID := helper.GetTestBook()
```

#### 6.3.3 å¿½ç•¥é”™è¯¯

```go
// âŒ ä¸å¥½ï¼šå¿½ç•¥å¯èƒ½çš„é”™è¯¯
result, _ := service.GetCollection(ctx, id)

// âœ… å¥½ï¼šæ˜ç¡®å¤„ç†é”™è¯¯
result, err := service.GetCollection(ctx, id)
require.NoError(t, err)
```

---

## ä¸ƒã€æµ‹è¯•ç¯å¢ƒ

### 7.1 æœ¬åœ°å¼€å‘ç¯å¢ƒ

**è¦æ±‚**ï¼š
- Go 1.21+
- MongoDB 6.0+ï¼ˆæµ‹è¯•æ•°æ®åº“ï¼‰
- Redisï¼ˆå¯é€‰ï¼‰

**é…ç½®**ï¼š
```yaml
# config.test.yaml
database:
  host: localhost
  port: 27017
  name: qingyu_test
  username: test_user
  password: test_pass
```

### 7.2 CI/CDç¯å¢ƒ

**Docker Composeé…ç½®**ï¼š
```yaml
# docker-compose.test.yml
services:
  mongodb-test:
    image: mongo:6.0
    environment:
      MONGO_INITDB_DATABASE: qingyu_test
    ports:
      - "27018:27017"
```

**CIæµç¨‹**ï¼š
1. å¯åŠ¨æµ‹è¯•æ•°æ®åº“
2. å¯¼å…¥æµ‹è¯•æ•°æ®
3. è¿è¡Œæµ‹è¯•
4. ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
5. æ¸…ç†ç¯å¢ƒ

---

## å…«ã€æŒç»­æ”¹è¿›

### 8.1 æµ‹è¯•å®¡æŸ¥æ¸…å•

- [ ] æµ‹è¯•å‘½åæ¸…æ™°æè¿°
- [ ] æµ‹è¯•ç‹¬ç«‹ä¸ä¾èµ–å…¶ä»–æµ‹è¯•
- [ ] ä½¿ç”¨TestHelperè€Œéæ‰‹åŠ¨æ„é€ è¯·æ±‚
- [ ] é”™è¯¯ä¿¡æ¯è¯¦ç»†å…·ä½“
- [ ] æ•°æ®æ­£ç¡®æ¸…ç†
- [ ] é¿å…ç¡¬ç¼–ç å€¼
- [ ] æµ‹è¯•è¦†ç›–æ­£å¸¸å’Œå¼‚å¸¸åœºæ™¯

### 8.2 å®šæœŸå›é¡¾

**æ¯å­£åº¦**ï¼š
- å®¡æŸ¥æµ‹è¯•è¦†ç›–ç‡è¶‹åŠ¿
- è¯†åˆ«ä¸ç¨³å®šçš„æµ‹è¯•
- ä¼˜åŒ–æ…¢é€Ÿæµ‹è¯•
- æ›´æ–°æµ‹è¯•æ–‡æ¡£

### 8.3 å›¢é˜ŸåŸ¹è®­

**åŸ¹è®­å†…å®¹**ï¼š
- TestHelperä½¿ç”¨æŒ‡å—
- æµ‹è¯•ç¼–å†™æœ€ä½³å®è·µ
- Mockä½¿ç”¨æŠ€å·§
- æµ‹è¯•è°ƒè¯•æ–¹æ³•

---

## ä¹ã€å‚è€ƒèµ„æ–™

### 9.1 å†…éƒ¨æ–‡æ¡£

- `test/integration/README_TestHelperä½¿ç”¨æŒ‡å—.md` - TestHelperè¯¦ç»†ä½¿ç”¨
- `doc/testing/æµ‹è¯•å·¥å…·è®¾è®¡æ–‡æ¡£.md` - æµ‹è¯•å·¥å…·è®¾è®¡
- `doc/testing/æµ‹è¯•ç»„ç»‡è§„èŒƒ.md` - æµ‹è¯•ç»„ç»‡æ ‡å‡†

### 9.2 å¤–éƒ¨å‚è€ƒ

- [Go Testing Best Practices](https://go.dev/doc/tutorial/add-a-test)
- [Testify Documentation](https://github.com/stretchr/testify)
- [Testing Strategies in Go](https://golang.org/doc/code.html#Testing)

---

## åã€ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | ä½œè€… |
|-----|------|---------|------|
| 1.0 | 2025-10-25 | åˆå§‹ç‰ˆæœ¬å‘å¸ƒ | åç«¯å›¢é˜Ÿ |

---

**ç»´æŠ¤è€…**ï¼šåç«¯å¼€å‘å›¢é˜Ÿ  
**å®¡æ ¸è€…**ï¼šæŠ€æœ¯è´Ÿè´£äºº  
**é—®é¢˜åé¦ˆ**ï¼šè¯·åœ¨é¡¹ç›®ä»“åº“æIssue

