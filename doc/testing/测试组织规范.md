# æµ‹è¯•ç»„ç»‡è§„èŒƒ

**ç‰ˆæœ¬**: 1.0  
**æ›´æ–°æ—¥æœŸ**: 2025-10-17  
**ç»´æŠ¤è€…**: é’ç¾½åç«¯å›¢é˜Ÿ

---

## ğŸ“š æµ‹è¯•åˆ†ç±»å’Œç»„ç»‡åŸåˆ™

æœ¬é¡¹ç›®é‡‡ç”¨ **Go ç¤¾åŒºæœ€ä½³å®è·µ**ï¼Œå°†æµ‹è¯•æŒ‰ç±»å‹åˆ†ç±»å­˜æ”¾ï¼š

```
é’ç¾½åç«¯æµ‹è¯•ç»“æ„
â”œâ”€â”€ æºä»£ç ç›®å½• (service/, pkg/, middleware/ ç­‰)
â”‚   â”œâ”€â”€ xxx.go
â”‚   â””â”€â”€ xxx_test.go                    âœ… å•å…ƒæµ‹è¯•ï¼ˆWhite-boxï¼‰
â”‚
â””â”€â”€ test/                               âœ… ç‹¬ç«‹æµ‹è¯•ç›®å½•
    â”œâ”€â”€ integration/                    âœ… é›†æˆæµ‹è¯•ï¼ˆBlack-boxï¼‰
    â”œâ”€â”€ performance/                    âœ… æ€§èƒ½æµ‹è¯•
    â”œâ”€â”€ api/                            âœ… APIæµ‹è¯•
    â”œâ”€â”€ examples/                       âœ… æµ‹è¯•ç¤ºä¾‹
    â”œâ”€â”€ fixtures/                       âœ… æµ‹è¯•æ•°æ®å·¥å‚
    â””â”€â”€ testutil/                       âœ… æµ‹è¯•å·¥å…·å‡½æ•°
```

---

## 1. å•å…ƒæµ‹è¯•ï¼ˆUnit Testsï¼‰

### ä½ç½®è§„åˆ™
âœ… **æ”¾åœ¨æºä»£ç åŒç›®å½•ä¸‹**ï¼Œæ–‡ä»¶åä¸º `xxx_test.go`

```
service/ai/
â”œâ”€â”€ ai_service.go
â”œâ”€â”€ ai_service_test.go          â† å•å…ƒæµ‹è¯•
â”œâ”€â”€ chat_service.go
â””â”€â”€ chat_service_test.go        â† å•å…ƒæµ‹è¯•
```

### ç‰¹ç‚¹
- **åŒ…å**: ä¸æºä»£ç ç›¸åŒï¼ˆå¦‚ `package ai`ï¼‰
- **è®¿é—®æƒé™**: å¯ä»¥æµ‹è¯•**ç§æœ‰æ–¹æ³•å’Œå˜é‡**
- **æµ‹è¯•æ–¹å¼**: White-box testingï¼ˆç™½ç›’æµ‹è¯•ï¼‰
- **ä¾èµ–**: ä½¿ç”¨ Mock éš”ç¦»å¤–éƒ¨ä¾èµ–
- **è¿è¡Œé€Ÿåº¦**: å¿«é€Ÿï¼ˆæ¯«ç§’çº§ï¼‰

### é€‚ç”¨åœºæ™¯
- âœ… æµ‹è¯•æœåŠ¡å†…éƒ¨ä¸šåŠ¡é€»è¾‘
- âœ… æµ‹è¯•ç§æœ‰è¾…åŠ©å‡½æ•°
- âœ… æµ‹è¯•æ•°æ®è½¬æ¢å’ŒéªŒè¯
- âœ… æµ‹è¯•é”™è¯¯å¤„ç†é€»è¾‘
- âœ… ä½¿ç”¨ Mock éš”ç¦»ä¾èµ–çš„æµ‹è¯•

### ç¤ºä¾‹
```go
// service/ai/chat_service_test.go
package ai

import (
    "testing"
    "github.com/stretchr/testify/mock"
)

// å¯ä»¥æµ‹è¯•ç§æœ‰æ–¹æ³•
func TestChatService_buildSystemPrompt(t *testing.T) {
    service := &ChatService{}
    
    // buildSystemPrompt æ˜¯ç§æœ‰æ–¹æ³•ï¼Œåªåœ¨åŒåŒ…å†…å¯è§
    prompt := service.buildSystemPrompt("novel", "project-123")
    
    assert.Contains(t, prompt, "å°è¯´åˆ›ä½œåŠ©æ‰‹")
}

// ä½¿ç”¨ Mock æµ‹è¯•
func TestChatService_StartChat(t *testing.T) {
    mockRepo := &MockChatRepository{}
    mockAI := &MockAIService{}
    
    service := &ChatService{
        repository: mockRepo,
        aiService:  mockAI,
    }
    
    mockAI.On("GenerateContent", ...).Return(...)
    // æµ‹è¯•é€»è¾‘
}
```

---

## 2. é›†æˆæµ‹è¯•ï¼ˆIntegration Testsï¼‰

### ä½ç½®è§„åˆ™
âœ… **æ”¾åœ¨ `test/integration/` ç›®å½•ä¸‹**

```
test/integration/
â”œâ”€â”€ version_service_integration_test.go
â”œâ”€â”€ ai_chat_e2e_test.go
â”œâ”€â”€ user_api_integration_test.go
â””â”€â”€ shared_services_integration_test.go
```

### ç‰¹ç‚¹
- **åŒ…å**: `package integration_test`ï¼ˆç‹¬ç«‹åŒ…ï¼‰
- **è®¿é—®æƒé™**: åªèƒ½è®¿é—®**å…¬å¼€API**
- **æµ‹è¯•æ–¹å¼**: Black-box testingï¼ˆé»‘ç›’æµ‹è¯•ï¼‰
- **ä¾èµ–**: ä½¿ç”¨**çœŸå®çš„å¤–éƒ¨ä¾èµ–**ï¼ˆæ•°æ®åº“ã€ç¼“å­˜ç­‰ï¼‰
- **è¿è¡Œé€Ÿåº¦**: è¾ƒæ…¢ï¼ˆç§’çº§ï¼‰

### é€‚ç”¨åœºæ™¯
- âœ… æµ‹è¯•å¤šä¸ªç»„ä»¶çš„äº¤äº’
- âœ… æµ‹è¯•å®Œæ•´çš„ä¸šåŠ¡æµç¨‹ï¼ˆç«¯åˆ°ç«¯ï¼‰
- âœ… æµ‹è¯•æ•°æ®åº“æ“ä½œ
- âœ… æµ‹è¯•APIæ¥å£
- âœ… éœ€è¦çœŸå®ç¯å¢ƒçš„æµ‹è¯•

### ç¤ºä¾‹
```go
// test/integration/version_service_integration_test.go
package integration_test

import (
    "testing"
    "Qingyu_backend/service/project"
    "Qingyu_backend/global"
)

func TestVersionService_UpdateContentWithVersion_Integration(t *testing.T) {
    // è¿æ¥çœŸå®çš„MongoDB
    // æµ‹è¯•å®Œæ•´çš„ç‰ˆæœ¬æ§åˆ¶æµç¨‹
    
    svc := &project.VersionService{}
    
    // çœŸå®çš„æ•°æ®åº“æ“ä½œ
    rev, err := svc.UpdateContentWithVersion(...)
    
    // éªŒè¯æ•°æ®åº“ä¸­çš„å®é™…çŠ¶æ€
    var content model.DocumentContent
    global.DB.Collection("document_contents").FindOne(...)
}
```

### å‘½åçº¦å®š
- æ–‡ä»¶åä»¥ `_integration_test.go` ç»“å°¾
- æˆ–ä½¿ç”¨ `_e2e_test.go` è¡¨ç¤ºç«¯åˆ°ç«¯æµ‹è¯•
- æµ‹è¯•å‡½æ•°ä½¿ç”¨æè¿°æ€§åç§°ï¼š`TestXXX_Scenario_Integration`

---

## 3. æ€§èƒ½æµ‹è¯•ï¼ˆBenchmark Testsï¼‰

### ä½ç½®è§„åˆ™
âœ… **æ”¾åœ¨ `test/performance/` ç›®å½•ä¸‹**

```
test/performance/
â”œâ”€â”€ ai_benchmark_test.go
â””â”€â”€ bookstore_benchmark_test.go
```

### ç‰¹ç‚¹
- ä½¿ç”¨ `func BenchmarkXXX(b *testing.B)` æ ¼å¼
- æµ‹é‡æ€§èƒ½æŒ‡æ ‡ï¼ˆCPUã€å†…å­˜ã€æ—¶é—´ï¼‰
- ä¸ä¸šåŠ¡æµ‹è¯•åˆ†ç¦»

### ç¤ºä¾‹
```go
// test/performance/ai_benchmark_test.go
package performance_test

func BenchmarkAIService_GenerateContent(b *testing.B) {
    service := setupAIService()
    
    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        service.GenerateContent(...)
    }
}
```

### è¿è¡Œæ–¹å¼
```bash
# è¿è¡Œæ€§èƒ½æµ‹è¯•
go test -bench=. ./test/performance/...

# ç”ŸæˆCPUåˆ†æ
go test -bench=. -cpuprofile=cpu.prof ./test/performance/...
```

---

## 4. APIæµ‹è¯•

### ä½ç½®è§„åˆ™
âœ… **æ”¾åœ¨ `test/api/` ç›®å½•ä¸‹**

```
test/api/
â”œâ”€â”€ bookstore_api_test.go
â”œâ”€â”€ reader_api_test.go
â””â”€â”€ book_rating_api_test.go
```

### ç‰¹ç‚¹
- æµ‹è¯•HTTP APIç«¯ç‚¹
- é€šå¸¸ä½¿ç”¨ `httptest` åŒ…
- éªŒè¯è¯·æ±‚/å“åº”æ ¼å¼

---

## ğŸ¯ æµ‹è¯•è¿è¡ŒæŒ‡å—

### è¿è¡Œæ‰€æœ‰æµ‹è¯•
```bash
go test ./...
```

### åªè¿è¡Œå•å…ƒæµ‹è¯•
```bash
# è¿è¡Œæºä»£ç ç›®å½•ä¸‹çš„æµ‹è¯•
go test ./service/...
go test ./pkg/...
go test ./middleware/...
```

### åªè¿è¡Œé›†æˆæµ‹è¯•
```bash
go test ./test/integration/...
```

### åªè¿è¡Œæ€§èƒ½æµ‹è¯•
```bash
go test -bench=. ./test/performance/...
```

### åªè¿è¡ŒAPIæµ‹è¯•
```bash
go test ./test/api/...
```

### è¿è¡Œç‰¹å®šæµ‹è¯•
```bash
# è¿è¡Œç‰¹å®šæµ‹è¯•å‡½æ•°
go test -run TestChatService_StartChat ./service/ai/

# è¿è¡Œé›†æˆæµ‹è¯•ä¸­çš„ç‰¹å®šæµ‹è¯•
go test -run TestVersionService_Integration ./test/integration/
```

### è¯¦ç»†è¾“å‡º
```bash
go test -v ./...
```

### æµ‹è¯•è¦†ç›–ç‡
```bash
# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
go test -cover ./...

# ç”Ÿæˆè¯¦ç»†è¦†ç›–ç‡HTMLæŠ¥å‘Š
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out
```

---

## ğŸ“‹ æµ‹è¯•ç¼–å†™æ¸…å•

### å•å…ƒæµ‹è¯•æ¸…å•
- [ ] æµ‹è¯•å‡½æ•°å‘½åæ¸…æ™°ï¼š`TestServiceName_MethodName_Scenario`
- [ ] ä½¿ç”¨ AAA æ¨¡å¼ï¼šArrange, Act, Assert
- [ ] Mock æ‰€æœ‰å¤–éƒ¨ä¾èµ–
- [ ] æµ‹è¯•æ­£å¸¸æµç¨‹å’Œé”™è¯¯æµç¨‹
- [ ] æµ‹è¯•è¾¹ç•Œæ¡ä»¶
- [ ] æ¯ä¸ªæµ‹è¯•ä¸“æ³¨ä¸€ä¸ªåœºæ™¯

### é›†æˆæµ‹è¯•æ¸…å•
- [ ] æ·»åŠ  `_integration` æˆ– `_e2e` åç¼€
- [ ] ä½¿ç”¨ `TestMain` è®¾ç½®å’Œæ¸…ç†ç¯å¢ƒ
- [ ] åœ¨æµ‹è¯•å‰/åæ¸…ç†æ•°æ®
- [ ] ä½¿ç”¨çœŸå®çš„é…ç½®å’Œè¿æ¥
- [ ] æµ‹è¯•å®Œæ•´çš„ä¸šåŠ¡æµç¨‹
- [ ] è€ƒè™‘æµ‹è¯•æ•°æ®éš”ç¦»

---

## ğŸ”§ æµ‹è¯•å·¥å…·å’Œè¾…åŠ©

### Mock æ¡†æ¶
ä½¿ç”¨ [testify/mock](https://github.com/stretchr/testify):
```go
import "github.com/stretchr/testify/mock"

type MockRepository struct {
    mock.Mock
}

func (m *MockRepository) GetByID(id string) (*Model, error) {
    args := m.Called(id)
    return args.Get(0).(*Model), args.Error(1)
}
```

### æµ‹è¯•å·¥å…·å‡½æ•°
ä½äº `test/testutil/`:
- `CreateTestContext()`: åˆ›å»ºæµ‹è¯•ä¸Šä¸‹æ–‡
- `CreateTestDocument()`: åˆ›å»ºæµ‹è¯•æ–‡æ¡£
- `AssertUserEqual()`: è‡ªå®šä¹‰æ–­è¨€

### æµ‹è¯•æ•°æ®å·¥å‚
ä½äº `test/fixtures/`:
```go
factory := fixtures.NewUserFactory()
user := factory.Create()
admin := factory.CreateAdmin()
users := factory.CreateBatch(10)
```

---

## âš ï¸ å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ

### é”™è¯¯1: æ— æ³•è®¿é—®ç§æœ‰æ–¹æ³•
```
âŒ undefined: privateMethod

åŸå› ï¼šæµ‹è¯•æ–‡ä»¶ä½¿ç”¨äº† package xxx_test è€Œé package xxx
è§£å†³ï¼šå•å…ƒæµ‹è¯•ä½¿ç”¨ç›¸åŒçš„åŒ…åï¼Œæˆ–å°†æ–¹æ³•æ”¹ä¸ºå…¬å¼€
```

### é”™è¯¯2: å¯¼å…¥å¾ªç¯
```
âŒ import cycle not allowed

åŸå› ï¼šæµ‹è¯•åŒ…å¯¼å…¥äº†ä¾èµ–å®ƒçš„åŒ…
è§£å†³ï¼šé‡æ„ä»£ç ç»“æ„ï¼Œä½¿ç”¨æ¥å£è§£è€¦
```

### é”™è¯¯3: å¹¶å‘æµ‹è¯•å¤±è´¥
```
è§£å†³ï¼šä½¿ç”¨ t.Parallel() æˆ– test/integration/ ä¸‹çš„ç‹¬ç«‹æµ‹è¯•
```

---

## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| ç±»å‹ | æœ€ä½è¦†ç›–ç‡ | æ¨èè¦†ç›–ç‡ |
|------|----------|----------|
| æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ | 80% | 90%+ |
| Repositoryå±‚ | 70% | 85% |
| Serviceå±‚ | 75% | 90% |
| APIå±‚ | 60% | 80% |
| å·¥å…·å‡½æ•° | 80% | 95% |

---

## ğŸ“š å‚è€ƒèµ„æº

- [Go Testingå®˜æ–¹æ–‡æ¡£](https://golang.org/pkg/testing/)
- [Testifyæ–‡æ¡£](https://github.com/stretchr/testify)
- [Goæµ‹è¯•æœ€ä½³å®è·µ](https://dave.cheney.net/2019/05/07/prefer-table-driven-tests)
- [æµ‹è¯•é‡‘å­—å¡”](https://martinfowler.com/articles/practical-test-pyramid.html)

---

## ğŸ”„ æµ‹è¯•ç­–ç•¥æ¼”è¿›

### å½“å‰é˜¶æ®µï¼ˆ2025-Q4ï¼‰
- âœ… å»ºç«‹æµ‹è¯•ç»„ç»‡è§„èŒƒ
- âœ… ç§»åŠ¨é›†æˆæµ‹è¯•åˆ°ç‹¬ç«‹ç›®å½•
- âœ… è¡¥å……å…³é”®è·¯å¾„çš„å•å…ƒæµ‹è¯•

### ä¸‹ä¸€é˜¶æ®µï¼ˆ2026-Q1ï¼‰
- ğŸ“ æé«˜æµ‹è¯•è¦†ç›–ç‡åˆ°80%+
- ğŸ“ æ·»åŠ æ›´å¤šé›†æˆæµ‹è¯•
- ğŸ“ å»ºç«‹CI/CDè‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹

### é•¿æœŸç›®æ ‡ï¼ˆ2026-Q2+ï¼‰
- ğŸ“ å®ç°å¥‘çº¦æµ‹è¯•ï¼ˆContract Testingï¼‰
- ğŸ“ æ·»åŠ æ··æ²Œå·¥ç¨‹æµ‹è¯•
- ğŸ“ æ€§èƒ½å›å½’æµ‹è¯•è‡ªåŠ¨åŒ–

---

**æœ€åæ›´æ–°**: 2025-10-17  
**ç»´æŠ¤è€…**: é’ç¾½åç«¯å›¢é˜Ÿ
