# 测试组织规范

**版本**: 1.0  
**更新日期**: 2025-10-17  
**维护者**: 青羽后端团队

---

## 📚 测试分类和组织原则

本项目采用 **Go 社区最佳实践**，将测试按类型分类存放：

```
青羽后端测试结构
├── 源代码目录 (service/, pkg/, middleware/ 等)
│   ├── xxx.go
│   └── xxx_test.go                    ✅ 单元测试（White-box）
│
└── test/                               ✅ 独立测试目录
    ├── integration/                    ✅ 集成测试（Black-box）
    ├── performance/                    ✅ 性能测试
    ├── api/                            ✅ API测试
    ├── examples/                       ✅ 测试示例
    ├── fixtures/                       ✅ 测试数据工厂
    └── testutil/                       ✅ 测试工具函数
```

---

## 1. 单元测试（Unit Tests）

### 位置规则
✅ **放在源代码同目录下**，文件名为 `xxx_test.go`

```
service/ai/
├── ai_service.go
├── ai_service_test.go          ← 单元测试
├── chat_service.go
└── chat_service_test.go        ← 单元测试
```

### 特点
- **包名**: 与源代码相同（如 `package ai`）
- **访问权限**: 可以测试**私有方法和变量**
- **测试方式**: White-box testing（白盒测试）
- **依赖**: 使用 Mock 隔离外部依赖
- **运行速度**: 快速（毫秒级）

### 适用场景
- ✅ 测试服务内部业务逻辑
- ✅ 测试私有辅助函数
- ✅ 测试数据转换和验证
- ✅ 测试错误处理逻辑
- ✅ 使用 Mock 隔离依赖的测试

### 示例
```go
// service/ai/chat_service_test.go
package ai

import (
    "testing"
    "github.com/stretchr/testify/mock"
)

// 可以测试私有方法
func TestChatService_buildSystemPrompt(t *testing.T) {
    service := &ChatService{}
    
    // buildSystemPrompt 是私有方法，只在同包内可见
    prompt := service.buildSystemPrompt("novel", "project-123")
    
    assert.Contains(t, prompt, "小说创作助手")
}

// 使用 Mock 测试
func TestChatService_StartChat(t *testing.T) {
    mockRepo := &MockChatRepository{}
    mockAI := &MockAIService{}
    
    service := &ChatService{
        repository: mockRepo,
        aiService:  mockAI,
    }
    
    mockAI.On("GenerateContent", ...).Return(...)
    // 测试逻辑
}
```

---

## 2. 集成测试（Integration Tests）

### 位置规则
✅ **放在 `test/integration/` 目录下**

```
test/integration/
├── version_service_integration_test.go
├── ai_chat_e2e_test.go
├── user_api_integration_test.go
└── shared_services_integration_test.go
```

### 特点
- **包名**: `package integration_test`（独立包）
- **访问权限**: 只能访问**公开API**
- **测试方式**: Black-box testing（黑盒测试）
- **依赖**: 使用**真实的外部依赖**（数据库、缓存等）
- **运行速度**: 较慢（秒级）

### 适用场景
- ✅ 测试多个组件的交互
- ✅ 测试完整的业务流程（端到端）
- ✅ 测试数据库操作
- ✅ 测试API接口
- ✅ 需要真实环境的测试

### 示例
```go
// test/integration/version_service_integration_test.go
package integration_test

import (
    "testing"
    "Qingyu_backend/service/project"
    "Qingyu_backend/global"
)

func TestVersionService_UpdateContentWithVersion_Integration(t *testing.T) {
    // 连接真实的MongoDB
    // 测试完整的版本控制流程
    
    svc := &project.VersionService{}
    
    // 真实的数据库操作
    rev, err := svc.UpdateContentWithVersion(...)
    
    // 验证数据库中的实际状态
    var content model.DocumentContent
    global.DB.Collection("document_contents").FindOne(...)
}
```

### 命名约定
- 文件名以 `_integration_test.go` 结尾
- 或使用 `_e2e_test.go` 表示端到端测试
- 测试函数使用描述性名称：`TestXXX_Scenario_Integration`

---

## 3. 性能测试（Benchmark Tests）

### 位置规则
✅ **放在 `test/performance/` 目录下**

```
test/performance/
├── ai_benchmark_test.go
└── bookstore_benchmark_test.go
```

### 特点
- 使用 `func BenchmarkXXX(b *testing.B)` 格式
- 测量性能指标（CPU、内存、时间）
- 与业务测试分离

### 示例
```go
// test/performance/ai_benchmark_test.go
package performance_test

func BenchmarkAIService_GenerateContent(b *testing.B) {
    service := setupAIService()
    
    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        service.GenerateContent(...)
    }
}
```

### 运行方式
```bash
# 运行性能测试
go test -bench=. ./test/performance/...

# 生成CPU分析
go test -bench=. -cpuprofile=cpu.prof ./test/performance/...
```

---

## 4. API测试

### 位置规则
✅ **放在 `test/api/` 目录下**

```
test/api/
├── bookstore_api_test.go
├── reader_api_test.go
└── book_rating_api_test.go
```

### 特点
- 测试HTTP API端点
- 通常使用 `httptest` 包
- 验证请求/响应格式

---

## 🎯 测试运行指南

### 运行所有测试
```bash
go test ./...
```

### 只运行单元测试
```bash
# 运行源代码目录下的测试
go test ./service/...
go test ./pkg/...
go test ./middleware/...
```

### 只运行集成测试
```bash
go test ./test/integration/...
```

### 只运行性能测试
```bash
go test -bench=. ./test/performance/...
```

### 只运行API测试
```bash
go test ./test/api/...
```

### 运行特定测试
```bash
# 运行特定测试函数
go test -run TestChatService_StartChat ./service/ai/

# 运行集成测试中的特定测试
go test -run TestVersionService_Integration ./test/integration/
```

### 详细输出
```bash
go test -v ./...
```

### 测试覆盖率
```bash
# 生成覆盖率报告
go test -cover ./...

# 生成详细覆盖率HTML报告
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out
```

---

## 📋 测试编写清单

### 单元测试清单
- [ ] 测试函数命名清晰：`TestServiceName_MethodName_Scenario`
- [ ] 使用 AAA 模式：Arrange, Act, Assert
- [ ] Mock 所有外部依赖
- [ ] 测试正常流程和错误流程
- [ ] 测试边界条件
- [ ] 每个测试专注一个场景

### 集成测试清单
- [ ] 添加 `_integration` 或 `_e2e` 后缀
- [ ] 使用 `TestMain` 设置和清理环境
- [ ] 在测试前/后清理数据
- [ ] 使用真实的配置和连接
- [ ] 测试完整的业务流程
- [ ] 考虑测试数据隔离

---

## 🔧 测试工具和辅助

### Mock 框架
使用 [testify/mock](https://github.com/stretchr/testify):
```go
import "github.com/stretchr/testify/mock"

type MockRepository struct {
    mock.Mock
}

func (m *MockRepository) GetByID(id string) (*Model, error) {
    args := m.Called(id)
    return args.Get(0).(*Model), args.Error(1)
}
```

### 测试工具函数
位于 `test/testutil/`:
- `CreateTestContext()`: 创建测试上下文
- `CreateTestDocument()`: 创建测试文档
- `AssertUserEqual()`: 自定义断言

### 测试数据工厂
位于 `test/fixtures/`:
```go
factory := fixtures.NewUserFactory()
user := factory.Create()
admin := factory.CreateAdmin()
users := factory.CreateBatch(10)
```

---

## ⚠️ 常见错误和解决方案

### 错误1: 无法访问私有方法
```
❌ undefined: privateMethod

原因：测试文件使用了 package xxx_test 而非 package xxx
解决：单元测试使用相同的包名，或将方法改为公开
```

### 错误2: 导入循环
```
❌ import cycle not allowed

原因：测试包导入了依赖它的包
解决：重构代码结构，使用接口解耦
```

### 错误3: 并发测试失败
```
解决：使用 t.Parallel() 或 test/integration/ 下的独立测试
```

---

## 📊 测试覆盖率目标

| 类型 | 最低覆盖率 | 推荐覆盖率 |
|------|----------|----------|
| 核心业务逻辑 | 80% | 90%+ |
| Repository层 | 70% | 85% |
| Service层 | 75% | 90% |
| API层 | 60% | 80% |
| 工具函数 | 80% | 95% |

---

## 📚 参考资源

- [Go Testing官方文档](https://golang.org/pkg/testing/)
- [Testify文档](https://github.com/stretchr/testify)
- [Go测试最佳实践](https://dave.cheney.net/2019/05/07/prefer-table-driven-tests)
- [测试金字塔](https://martinfowler.com/articles/practical-test-pyramid.html)

---

## 🔄 测试策略演进

### 当前阶段（2025-Q4）
- ✅ 建立测试组织规范
- ✅ 移动集成测试到独立目录
- ✅ 补充关键路径的单元测试

### 下一阶段（2026-Q1）
- 📝 提高测试覆盖率到80%+
- 📝 添加更多集成测试
- 📝 建立CI/CD自动化测试流程

### 长期目标（2026-Q2+）
- 📝 实现契约测试（Contract Testing）
- 📝 添加混沌工程测试
- 📝 性能回归测试自动化

---

**最后更新**: 2025-10-17  
**维护者**: 青羽后端团队
