# Go后端与Python AI微服务 - 测试执行说明

> **创建日期**: 2025-10-31  
> **状态**: ✅ 测试环境已就绪

---

## 📝 执行摘要

本文档提供 Go 后端与 Python AI 微服务 gRPC 集成测试的完整执行说明。

**测试准备工作已完成**:
- ✅ 创建了完整的测试脚本
- ✅ 创建了 Go 集成测试代码
- ✅ 创建了详细的测试文档
- ✅ 验证了代码编译无误

**下一步**: 运行测试（需要 GOOGLE_API_KEY）

---

## 🎯 测试准备清单

### 已完成 ✅

1. **测试脚本**
   - ✅ `scripts/testing/test_grpc_integration.bat` - 一键集成测试
   - ✅ `scripts/testing/run_grpc_tests.bat` - Go 测试运行器
   - ✅ `scripts/testing/README_gRPC测试.md` - 脚本使用说明

2. **测试代码**
   - ✅ `test/integration/grpc_ai_service_test.go` - Go 集成测试套件
   - ✅ 包含 7 个完整测试用例
   - ✅ 代码编译通过，无语法错误

3. **测试文档**
   - ✅ `doc/testing/gRPC集成测试指南.md` - 完整测试指南
   - ✅ `doc/testing/gRPC集成测试快速启动.md` - 快速上手
   - ✅ `doc/testing/gRPC测试结果示例.md` - 测试结果参考

4. **现有资源**
   - ✅ Python AI 服务已实现（`python_ai_service/`）
   - ✅ Go 客户端已实现（`service/ai/phase3_client.go`）
   - ✅ Protobuf 定义完整（`python_ai_service/proto/ai_service.proto`）
   - ✅ Protobuf 生成代码存在（`pkg/grpc/pb/`）

### 待执行 ⏳

5. **环境配置**
   - ⏳ 设置 GOOGLE_API_KEY 环境变量
   - ⏳ 安装 Python 依赖（如未安装）
   - ⏳ 验证 Go 依赖（go mod tidy）

6. **测试执行**
   - ⏳ 启动 Python AI 服务
   - ⏳ 运行 Python 客户端测试
   - ⏳ 运行 Go 客户端测试
   - ⏳ 生成测试报告

---

## 🚀 立即开始测试

### 方式一：一键测试（推荐）

```bash
# 1. 设置 API Key
set GOOGLE_API_KEY=your_google_api_key_here

# 2. 运行集成测试（自动化）
scripts\testing\test_grpc_integration.bat
```

### 方式二：手动测试

#### 步骤 1: 环境准备

```bash
# 设置 API Key
set GOOGLE_API_KEY=your_google_api_key_here

# 安装 Python 依赖
cd python_ai_service
pip install -r requirements.txt
cd ..

# 验证 Go 依赖
go mod tidy
```

#### 步骤 2: 启动服务

```bash
# 新终端窗口 1 - 启动 Python AI 服务
cd python_ai_service
python run_grpc_server.py
```

#### 步骤 3: 运行测试

```bash
# 新终端窗口 2 - Python 客户端测试
cd python_ai_service
python tests\test_grpc_phase3.py

# 新终端窗口 3 - Go 客户端测试
go run cmd\test_phase3_grpc\main.go --addr localhost:50051

# 或运行完整测试套件
go test -v -timeout 300s ./test/integration -run TestGRPC
```

---

## 📋 测试用例列表

### Python 客户端测试

| # | 测试用例 | 说明 | 预期时间 |
|---|---------|------|---------|
| 1 | test_health_check | 健康检查 | < 0.1秒 |
| 2 | test_generate_outline | 大纲生成 | 8-12秒 |
| 3 | test_generate_characters | 角色生成 | 10-15秒 |
| 4 | test_generate_plot | 情节生成 | 12-18秒 |
| 5 | test_creative_workflow | 完整工作流 | 30-45秒 |

**总计**: 5 个测试用例，预计耗时 60-90秒

### Go 客户端测试

| # | 测试用例 | 说明 | 预期时间 |
|---|---------|------|---------|
| 1 | TestGRPCConnection | 连接测试 | < 0.1秒 |
| 2 | TestGenerateOutline | 大纲生成 | 8-12秒 |
| 3 | TestGenerateCharacters | 角色生成 | 10-15秒 |
| 4 | TestGeneratePlot | 情节生成 | 12-18秒 |
| 5 | TestCompleteWorkflow | 完整工作流 | 30-45秒 |
| 6 | TestConcurrentRequests | 并发测试 | 15-25秒 |
| 7 | TestErrorHandling | 错误处理 | < 1秒 |

**总计**: 7 个测试用例，预计耗时 75-110秒

**两端总测试时间**: 约 2-3 分钟

---

## 📊 预期测试结果

### 成功标准

所有测试应该：
- ✅ 无错误和异常
- ✅ 所有断言通过
- ✅ 响应时间在预期范围内
- ✅ 数据结构完整有效

### Python 测试输出示例

```
========================================
✅ 所有测试通过!
========================================
```

### Go 测试输出示例

```
========================================
✅ 测试完成
========================================
```

---

## 🔍 测试验证点

### 功能验证

- [ ] gRPC 连接建立成功
- [ ] 健康检查返回 "healthy"
- [ ] 大纲生成包含完整章节信息
- [ ] 角色生成包含性格和背景
- [ ] 情节生成包含时间线事件
- [ ] 完整工作流依次完成三个阶段
- [ ] 并发请求全部成功
- [ ] 错误处理返回明确错误信息

### 性能验证

- [ ] 健康检查 < 0.1秒
- [ ] 大纲生成 < 15秒
- [ ] 角色生成 < 20秒
- [ ] 情节生成 < 25秒
- [ ] 完整工作流 < 60秒
- [ ] 内存消耗 < 1GB
- [ ] CPU 使用 < 50%

### 数据验证

- [ ] 响应数据结构正确
- [ ] 必填字段不为空
- [ ] 数据类型匹配 Proto 定义
- [ ] 中文内容正常显示
- [ ] Token 消耗在合理范围

---

## ❌ 常见问题处理

### 问题 1: API Key 未设置

**症状**: 
```
ERROR: GOOGLE_API_KEY environment variable is not set
```

**解决**:
```bash
set GOOGLE_API_KEY=your_actual_api_key
```

### 问题 2: 连接失败

**症状**:
```
failed to connect to all addresses
```

**检查**:
1. Python 服务是否启动
2. 端口 50051 是否可用
3. 防火墙是否阻止连接

**解决**:
```bash
# 检查端口
netstat -ano | findstr :50051

# 启动服务
cd python_ai_service
python run_grpc_server.py
```

### 问题 3: 依赖缺失

**症状**:
```
ModuleNotFoundError: No module named 'grpc'
```

**解决**:
```bash
cd python_ai_service
pip install -r requirements.txt
```

### 问题 4: 超时错误

**症状**:
```
context deadline exceeded
```

**原因**: 
- LLM API 响应慢
- 网络延迟
- 服务器负载高

**解决**: 增加超时时间或重试

---

## 📈 测试报告模板

### 测试执行记录

**执行日期**: YYYY-MM-DD  
**执行人**: XXX  
**测试环境**: 开发环境

### 测试结果

| 测试项 | Python | Go | 状态 | 备注 |
|-------|--------|----|------|------|
| 连接测试 | ✅ | ✅ | 通过 | - |
| 大纲生成 | ✅ | ✅ | 通过 | - |
| 角色生成 | ✅ | ✅ | 通过 | - |
| 情节生成 | ✅ | ✅ | 通过 | - |
| 完整工作流 | ✅ | ✅ | 通过 | - |
| 并发测试 | N/A | ✅ | 通过 | - |
| 错误处理 | N/A | ✅ | 通过 | - |

**通过率**: XX%  
**总耗时**: XX 秒

### 性能数据

| 指标 | 数值 |
|-----|------|
| 平均响应时间 | XX 秒 |
| 最大内存使用 | XX MB |
| CPU 峰值 | XX% |
| Token 消耗 | XX |

### 问题和建议

1. **发现的问题**: XXX
2. **优化建议**: XXX
3. **后续计划**: XXX

---

## 📖 相关文档

### 测试文档

- [gRPC集成测试指南](./gRPC集成测试指南.md)
- [gRPC集成测试快速启动](./gRPC集成测试快速启动.md)
- [gRPC测试结果示例](./gRPC测试结果示例.md)
- [测试脚本说明](../../scripts/testing/README_gRPC测试.md)

### 技术文档

- [Phase3 gRPC README](../../python_ai_service/PHASE3_GRPC_README.md)
- [gRPC 集成指南](../../python_ai_service/GRPC_INTEGRATION_GUIDE.md)
- [Proto 定义](../../python_ai_service/proto/ai_service.proto)

### 实现代码

- [Go 客户端](../../service/ai/phase3_client.go)
- [Python 服务端](../../python_ai_service/src/grpc_service/server.py)
- [Go 集成测试](../../test/integration/grpc_ai_service_test.go)

---

## 🎯 下一步行动

### 立即执行

1. **设置环境变量**
   ```bash
   set GOOGLE_API_KEY=your_api_key
   ```

2. **运行一键测试**
   ```bash
   scripts\testing\test_grpc_integration.bat
   ```

3. **查看测试结果**
   - 检查控制台输出
   - 验证所有测试通过
   - 记录性能数据

### 测试通过后

1. **更新文档** - 记录实际测试结果
2. **代码审查** - 确保代码质量
3. **集成到主服务** - 在 Service 层集成客户端
4. **添加监控** - 配置监控和告警
5. **准备生产** - 配置生产环境参数

---

## 📝 执行检查清单

### 测试前

- [ ] GOOGLE_API_KEY 已设置
- [ ] Python 依赖已安装
- [ ] Go 依赖已更新
- [ ] 端口 50051 可用
- [ ] 网络连接正常

### 测试中

- [ ] Python 服务启动成功
- [ ] Python 测试全部通过
- [ ] Go 测试全部通过
- [ ] 记录性能数据
- [ ] 截图保存结果

### 测试后

- [ ] 停止 Python 服务
- [ ] 清理临时文件
- [ ] 更新测试文档
- [ ] 提交测试报告
- [ ] 规划后续优化

---

## 🆘 需要帮助？

### 技术支持

- **文档目录**: `doc/testing/`
- **脚本目录**: `scripts/testing/`
- **测试代码**: `test/integration/`

### 问题排查

1. 查看 [常见问题](#-常见问题处理)
2. 检查 Python 服务日志
3. 查看 Go 测试输出
4. 参考 [测试指南](./gRPC集成测试指南.md#故障排查)

---

**文档版本**: v1.0  
**创建日期**: 2025-10-31  
**最后更新**: 2025-10-31  
**维护者**: 青羽后端架构团队

---

## ✅ 总结

**测试环境已就绪！**

所有必要的测试脚本、测试代码和测试文档都已创建完成。

**现在可以执行测试**:
```bash
# 设置 API Key
set GOOGLE_API_KEY=your_api_key

# 运行测试
scripts\testing\test_grpc_integration.bat
```

祝测试顺利！🚀

