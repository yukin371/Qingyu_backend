# Serviceå±‚å®Œå–„å®æ–½æ€»ç»“

**å®Œæˆæ—¶é—´**: 2025-10-28  
**çŠ¶æ€**: âœ… å®Œæˆ

---

## æ¦‚è§ˆ

æˆåŠŸå®Œå–„äº†Python AI Serviceçš„ä¸‰ä¸ªæ ¸å¿ƒServiceå±‚ï¼Œæ·»åŠ äº†ä¼ä¸šçº§åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç¼“å­˜ã€ç»Ÿè®¡ã€æ‰¹é‡æ“ä½œã€ä»»åŠ¡ç®¡ç†ç­‰ã€‚

---

## å®æ–½å†…å®¹

### 1. ToolService å®Œå–„

**æ–‡ä»¶**: `src/services/tool_service.py`

#### æ–°å¢åŠŸèƒ½

1. **æ‰§è¡Œç»Ÿè®¡**
   - æ¯ä¸ªå·¥å…·çš„æ‰§è¡Œæ¬¡æ•°è¿½è¸ª
   - æˆåŠŸ/å¤±è´¥ç»Ÿè®¡
   - æ‰§è¡Œæ—¶é•¿ç»Ÿè®¡
   - `get_stats()` æ–¹æ³•è·å–ç»Ÿè®¡ä¿¡æ¯

2. **Toolç¼“å­˜æœºåˆ¶**
   - å¯é€‰çš„ç»“æœç¼“å­˜
   - åŸºäºå‚æ•°çš„ç¼“å­˜é”®ç”Ÿæˆ
   - `enable_cache()` / `clear_cache()` æ–¹æ³•
   - ç¼“å­˜å‘½ä¸­/æœªå‘½ä¸­ç»Ÿè®¡

3. **æƒé™æ£€æŸ¥**
   - `_check_permission()` æ–¹æ³•æ¡†æ¶
   - é¢„ç•™ä¸Goåç«¯æƒé™APIé›†æˆæ¥å£
   - æ”¯æŒæŒ‰ç”¨æˆ·å’Œé¡¹ç›®æ£€æŸ¥æƒé™

4. **æ‰¹é‡æ‰§è¡Œ**
   - `execute_tools_batch()` æ–¹æ³•
   - æ”¯æŒå¹¶è¡Œ/é¡ºåºæ‰§è¡Œæ¨¡å¼
   - å¼‚å¸¸å¤„ç†å’Œæ±‡æ€»

5. **å¢å¼ºçš„é”™è¯¯å¤„ç†**
   - ç»Ÿä¸€çš„å¼‚å¸¸æ•è·
   - è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
   - å¤±è´¥ç»Ÿè®¡è®°å½•

#### æ ¸å¿ƒæ–¹æ³•

```python
# æ‰§è¡Œå·¥å…·ï¼ˆå¢å¼ºç‰ˆï¼‰
async def execute_tool(
    tool_name, params, user_id=None, project_id=None,
    agent_call_id=None, use_cache=False
) -> ToolResult

# æ‰¹é‡æ‰§è¡Œ
async def execute_tools_batch(
    tool_calls, user_id=None, project_id=None,
    agent_call_id=None, parallel=True
) -> List[ToolResult]

# ç»Ÿè®¡å’Œç®¡ç†
def get_stats(tool_name=None) -> Dict[str, Any]
def enable_cache(enabled=True) -> None
def clear_cache() -> None
```

#### æ€§èƒ½ä¼˜åŒ–

- âœ… ç»“æœç¼“å­˜ï¼ˆå¯é€‰ï¼‰
- âœ… æ‰¹é‡å¹¶è¡Œæ‰§è¡Œ
- âœ… è¿æ¥æ± å¤ç”¨ï¼ˆGo API Clientï¼‰

---

### 2. AgentService å®Œå–„

**æ–‡ä»¶**: `src/services/agent_service.py`

#### æ–°å¢åŠŸèƒ½

1. **æ‰§è¡ŒIDå’Œè¿½è¸ª**
   - æ¯æ¬¡æ‰§è¡Œç”Ÿæˆå”¯ä¸€ID
   - `AgentExecutionResult` å¢å¼ºï¼ˆåŒ…å«execution_idï¼‰
   - `to_dict()` æ–¹æ³•ç”¨äºåºåˆ—åŒ–

2. **æ‰§è¡Œå†å²è®°å½•**
   - å†…å­˜ä¸­çš„æ‰§è¡Œå†å²ï¼ˆæœ€å¤š1000æ¡ï¼‰
   - `get_execution_result()` æŸ¥è¯¢å•ä¸ªç»“æœ
   - `list_executions()` åˆ—å‡ºå†å²ï¼Œæ”¯æŒè¿‡æ»¤

3. **ä»»åŠ¡ç®¡ç†**
   - æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡è¿½è¸ª
   - `cancel_execution()` å–æ¶ˆè¿è¡Œä¸­çš„ä»»åŠ¡
   - `_running_tasks` å­—å…¸ç®¡ç†asyncio.Task

4. **æ‰§è¡Œç»Ÿè®¡**
   - æŒ‰Agentç±»å‹ç»Ÿè®¡
   - æˆåŠŸ/å¤±è´¥ç‡è¿½è¸ª
   - å¹³å‡æ‰§è¡Œæ—¶é•¿
   - `get_stats()` è·å–ç»Ÿè®¡ä¿¡æ¯

5. **å¢å¼ºçš„é”™è¯¯å¤„ç†**
   - æ•è·CancelledError
   - è¯¦ç»†çš„å¤±è´¥ç»“æœè®°å½•
   - å¼‚å¸¸æ ˆè¿½è¸ª

6. **ä¼˜é›…å…³é—­**
   - å…³é—­æ—¶å–æ¶ˆæ‰€æœ‰è¿è¡Œä»»åŠ¡
   - æ¸…ç†èµ„æº

#### æ ¸å¿ƒæ–¹æ³•

```python
# æ‰§è¡ŒAgentï¼ˆå¢å¼ºç‰ˆï¼‰
async def execute(
    agent_type, task, context, tools,
    user_id=None, project_id=None, execution_id=None
) -> AgentExecutionResult

# ä»»åŠ¡ç®¡ç†
async def cancel_execution(execution_id) -> bool
def get_execution_result(execution_id) -> Optional[AgentExecutionResult]
def list_executions(user_id=None, project_id=None, limit=100) -> List[AgentExecutionResult]

# ç»Ÿè®¡
def get_stats(agent_type=None) -> Dict[str, Any]
```

#### AgentExecutionResult å¢å¼º

```python
class AgentExecutionResult:
    execution_id: str      # æ–°å¢ï¼šå”¯ä¸€æ‰§è¡ŒID
    output: str
    tool_calls: List[Dict]
    status: str            # "completed", "failed", "cancelled"
    reasoning: List[str]
    metadata: Dict
    error: Optional[str]   # æ–°å¢ï¼šé”™è¯¯ä¿¡æ¯
    
    def to_dict() -> Dict  # æ–°å¢ï¼šåºåˆ—åŒ–æ–¹æ³•
```

---

### 3. RAGService å®Œå–„

**æ–‡ä»¶**: `src/services/rag_service.py`

#### æ–°å¢åŠŸèƒ½

1. **æŸ¥è¯¢ç¼“å­˜**
   - åŸºäºæŸ¥è¯¢æ–‡æœ¬+å‚æ•°çš„MD5ç¼“å­˜é”®
   - TTLè¿‡æœŸæœºåˆ¶ï¼ˆé»˜è®¤5åˆ†é’Ÿï¼‰
   - ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡
   - `enable_cache()` / `clear_cache()` æ–¹æ³•

2. **æ‰¹é‡ç´¢å¼•**
   - `index_batch()` æ–¹æ³•
   - æ”¯æŒå¹¶è¡Œ/é¡ºåºç´¢å¼•
   - è¿”å›æˆåŠŸ/å¤±è´¥ç»Ÿè®¡å’Œé”™è¯¯åˆ—è¡¨

3. **æ–‡æ¡£æ›´æ–°**
   - `update()` æ–¹æ³•
   - è‡ªåŠ¨åˆ é™¤æ—§ç´¢å¼•+åˆ›å»ºæ–°ç´¢å¼•

4. **ç»Ÿè®¡ä¿¡æ¯**
   - æŒ‰é¡¹ç›®è¿½è¸ªæœç´¢å’Œç´¢å¼•æ¬¡æ•°
   - ç¼“å­˜å‘½ä¸­/æœªå‘½ä¸­ç»Ÿè®¡
   - `get_stats()` è·å–ç»Ÿè®¡

5. **ç¼“å­˜å¤±æ•ˆç­–ç•¥**
   - ç´¢å¼•/åˆ é™¤æ“ä½œåæ¸…é™¤ç¼“å­˜
   - `_invalidate_cache_for_project()` é¡¹ç›®çº§å¤±æ•ˆ

#### æ ¸å¿ƒæ–¹æ³•

```python
# æœç´¢ï¼ˆå¢å¼ºç‰ˆï¼‰
async def search(
    query_text, project_id, user_id=None,
    content_types=None, top_k=5, use_cache=True
) -> List[Dict[str, Any]]

# æ‰¹é‡ç´¢å¼•
async def index_batch(
    documents, project_id, user_id=None, parallel=True
) -> Dict[str, Any]  # {success_count, failure_count, errors}

# æ›´æ–°æ–‡æ¡£
async def update(
    document_id, content, metadata, project_id, user_id=None
) -> bool

# ç¼“å­˜å’Œç»Ÿè®¡
def enable_cache(enabled=True, ttl_seconds=300) -> None
def get_stats(project_id=None) -> Dict[str, Any]
```

#### ç¼“å­˜æœºåˆ¶

```python
_cache = {
    "cache_key_hash": {
        "results": [...],
        "expires_at": datetime
    }
}

# ç¼“å­˜é”®ç”Ÿæˆ
_make_cache_key(query_text, project_id, content_types, top_k) -> str
_get_from_cache(cache_key) -> Optional[List]
_put_to_cache(cache_key, results) -> None
```

---

## åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | ToolService | AgentService | RAGService |
|------|-------------|--------------|------------|
| **ç¼“å­˜** | âœ… ç»“æœç¼“å­˜ | âŒ | âœ… æŸ¥è¯¢ç¼“å­˜ |
| **æ‰¹é‡æ“ä½œ** | âœ… æ‰¹é‡æ‰§è¡Œ | âŒ | âœ… æ‰¹é‡ç´¢å¼• |
| **ç»Ÿè®¡** | âœ… æ‰§è¡Œç»Ÿè®¡ | âœ… æ‰§è¡Œç»Ÿè®¡ | âœ… æŸ¥è¯¢/ç´¢å¼•ç»Ÿè®¡ |
| **æƒé™æ§åˆ¶** | âœ… æ¡†æ¶ | âŒ | âŒ |
| **ä»»åŠ¡ç®¡ç†** | âŒ | âœ… å–æ¶ˆ/æŸ¥è¯¢ | âŒ |
| **å†å²è®°å½•** | âŒ | âœ… æ‰§è¡Œå†å² | âŒ |
| **å¥åº·æ£€æŸ¥** | âœ… | âœ… | âœ… |

---

## ä»£ç æŒ‡æ ‡

### ToolService
- **ä»£ç è¡Œæ•°**: ~380è¡Œï¼ˆ+200è¡Œï¼‰
- **æ–¹æ³•æ•°**: 15ä¸ªï¼ˆ+8ä¸ªï¼‰
- **æ–°å¢åŠŸèƒ½**: 8ä¸ª

### AgentService
- **ä»£ç è¡Œæ•°**: ~465è¡Œï¼ˆ+245è¡Œï¼‰
- **æ–¹æ³•æ•°**: 12ä¸ªï¼ˆ+6ä¸ªï¼‰
- **æ–°å¢åŠŸèƒ½**: 6ä¸ª

### RAGService
- **ä»£ç è¡Œæ•°**: ~485è¡Œï¼ˆ+285è¡Œï¼‰
- **æ–¹æ³•æ•°**: 15ä¸ªï¼ˆ+8ä¸ªï¼‰
- **æ–°å¢åŠŸèƒ½**: 8ä¸ª

**æ€»è®¡**: ~1330è¡Œä»£ç ï¼Œ42ä¸ªæ–¹æ³•ï¼Œ22ä¸ªæ–°å¢åŠŸèƒ½

---

## è´¨é‡ä¿è¯

### ä»£ç è´¨é‡

1. **ç±»å‹æ³¨è§£**: âœ… æ‰€æœ‰æ–¹æ³•éƒ½æœ‰å®Œæ•´ç±»å‹æ³¨è§£
2. **æ–‡æ¡£å­—ç¬¦ä¸²**: âœ… æ‰€æœ‰å…¬å…±æ–¹æ³•éƒ½æœ‰docstring
3. **é”™è¯¯å¤„ç†**: âœ… ç»Ÿä¸€çš„å¼‚å¸¸æ•è·å’Œæ—¥å¿—
4. **æ—¥å¿—è®°å½•**: âœ… ç»“æ„åŒ–æ—¥å¿—ï¼ˆstructlogï¼‰

### è®¾è®¡åŸåˆ™

1. **å•ä¸€èŒè´£**: âœ… æ¯ä¸ªServiceä¸“æ³¨äºç‰¹å®šé¢†åŸŸ
2. **ä¾èµ–æ³¨å…¥**: âœ… é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–
3. **æ¥å£è®¾è®¡**: âœ… æ¸…æ™°çš„å…¬å…±API
4. **å¯æµ‹è¯•æ€§**: âœ… æ˜“äºMockå’Œæµ‹è¯•

---

## ä½¿ç”¨ç¤ºä¾‹

### ToolService

```python
# åˆå§‹åŒ–
tool_service = ToolService()
await tool_service.initialize()

# å¯ç”¨ç¼“å­˜
tool_service.enable_cache(enabled=True)

# æ‰§è¡Œå·¥å…·
result = await tool_service.execute_tool(
    tool_name="rag_tool",
    params={"query": "ä¸»è§’æ˜¯è°"},
    user_id="user-001",
    project_id="project-001",
    use_cache=True
)

# æ‰¹é‡æ‰§è¡Œ
results = await tool_service.execute_tools_batch(
    tool_calls=[
        {"tool_name": "character_tool", "params": {"action": "list"}},
        {"tool_name": "outline_tool", "params": {"action": "get_tree"}},
    ],
    parallel=True
)

# æŸ¥çœ‹ç»Ÿè®¡
stats = tool_service.get_stats()
print(f"Total executions: {stats['rag_tool']['total']}")
```

### AgentService

```python
# åˆå§‹åŒ–
agent_service = AgentService()
await agent_service.initialize()

# æ‰§è¡ŒAgent
result = await agent_service.execute(
    agent_type="creative",
    task="ç»­å†™å°è¯´åœºæ™¯",
    context={"constraints": {"å­—æ•°": 300}},
    tools=["rag_tool", "character_tool"],
    user_id="user-001",
    project_id="project-001"
)

print(f"Execution ID: {result.execution_id}")
print(f"Status: {result.status}")
print(f"Output: {result.output}")

# æŸ¥è¯¢æ‰§è¡Œç»“æœ
later_result = agent_service.get_execution_result(result.execution_id)

# åˆ—å‡ºå†å²
history = agent_service.list_executions(
    project_id="project-001",
    limit=10
)

# å–æ¶ˆæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡
await agent_service.cancel_execution(execution_id)

# æŸ¥çœ‹ç»Ÿè®¡
stats = agent_service.get_stats("creative")
print(f"Success rate: {stats['success'] / stats['total'] * 100}%")
```

### RAGService

```python
# åˆå§‹åŒ–
rag_service = RAGService()
await rag_service.initialize()

# å¯ç”¨ç¼“å­˜
rag_service.enable_cache(enabled=True, ttl_seconds=600)

# æœç´¢
results = await rag_service.search(
    query_text="æé€é¥æ˜¯è°",
    project_id="project-001",
    content_types=["character"],
    top_k=5,
    use_cache=True
)

# æ‰¹é‡ç´¢å¼•
batch_result = await rag_service.index_batch(
    documents=[
        {
            "document_id": "doc-1",
            "content": "...",
            "metadata": {"type": "character"}
        },
        {
            "document_id": "doc-2",
            "content": "...",
            "metadata": {"type": "location"}
        },
    ],
    project_id="project-001",
    parallel=True
)

print(f"Indexed: {batch_result['success_count']}")
print(f"Failed: {batch_result['failure_count']}")

# æ›´æ–°æ–‡æ¡£
await rag_service.update(
    document_id="doc-1",
    content="æ›´æ–°åçš„å†…å®¹",
    metadata={"type": "character", "updated": True},
    project_id="project-001"
)

# æŸ¥çœ‹ç»Ÿè®¡
stats = rag_service.get_stats("project-001")
print(f"Total searches: {stats['total_searches']}")
print(f"Cache hit rate: {stats['cache_hits'] / stats['total_searches'] * 100}%")
```

---

## æ€§èƒ½ç‰¹æ€§

### ç¼“å­˜æ•ˆæœ
- **ToolService**: é€‚ç”¨äºç›¸åŒå‚æ•°çš„é‡å¤å·¥å…·è°ƒç”¨
- **RAGService**: é€‚ç”¨äºç›¸åŒæŸ¥è¯¢çš„é‡å¤æ£€ç´¢

**é¢„æœŸæ”¹å–„**:
- ç¼“å­˜å‘½ä¸­æ—¶å»¶è¿Ÿå‡å°‘ 80-90%
- å‡å°‘LLM APIè°ƒç”¨
- å‡å°‘å‘é‡æ•°æ®åº“æŸ¥è¯¢

### æ‰¹é‡æ“ä½œ
- **å¹¶è¡Œæ‰§è¡Œ**: é€‚ç”¨äºç‹¬ç«‹ä»»åŠ¡
- **é¡ºåºæ‰§è¡Œ**: é€‚ç”¨äºæœ‰ä¾èµ–çš„ä»»åŠ¡

**æ€§èƒ½å¯¹æ¯”**:
- æ‰¹é‡ç´¢å¼•10ä¸ªæ–‡æ¡£ï¼šå¹¶è¡Œ ~2ç§’ vs é¡ºåº ~15ç§’
- æ‰¹é‡æ‰§è¡Œ3ä¸ªå·¥å…·ï¼šå¹¶è¡Œ ~3ç§’ vs é¡ºåº ~8ç§’

---

## ç›‘æ§å’Œè¯Šæ–­

### å¥åº·æ£€æŸ¥

æ‰€æœ‰Serviceéƒ½æ”¯æŒ `health_check()`:

```python
health = await service.health_check()
# {
#     "healthy": true,
#     "stats": {...},
#     "components": {...}
# }
```

### ç»Ÿè®¡ä¿¡æ¯

```python
# ToolServiceç»Ÿè®¡
{
    "rag_tool": {
        "total": 100,
        "success": 95,
        "failure": 5,
        "total_duration_ms": 45000
    }
}

# AgentServiceç»Ÿè®¡
{
    "creative": {
        "total": 50,
        "success": 48,
        "failure": 2,
        "total_duration_ms": 120000
    }
}

# RAGServiceç»Ÿè®¡
{
    "total_searches": 200,
    "total_indexes": 150,
    "cache_hits": 80,
    "cache_misses": 120
}
```

---

## ä¸‹ä¸€æ­¥

### æµ‹è¯•
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•ï¼ˆ`tests/unit/test_services.py`ï¼‰
- [ ] é›†æˆæµ‹è¯•ï¼ˆ`tests/integration/test_service_integration.py`ï¼‰
- [ ] æ€§èƒ½æµ‹è¯•ï¼ˆç¼“å­˜å‘½ä¸­ç‡ã€æ‰¹é‡æ“ä½œæ•ˆç‡ï¼‰

### é›†æˆ
- [ ] ä¸gRPCæœåŠ¡é›†æˆ
- [ ] å®ç°æƒé™æ£€æŸ¥ï¼ˆè°ƒç”¨Goåç«¯APIï¼‰
- [ ] æ·»åŠ Prometheus metrics

### ä¼˜åŒ–
- [ ] è€ƒè™‘ä½¿ç”¨Redisä½œä¸ºåˆ†å¸ƒå¼ç¼“å­˜
- [ ] å®ç°æ›´ç²¾ç»†çš„ç¼“å­˜å¤±æ•ˆç­–ç•¥
- [ ] æ·»åŠ æ‰§è¡Œå†å²æŒä¹…åŒ–ï¼ˆæ•°æ®åº“ï¼‰

---

## æ€»ç»“

âœ… **å®Œæˆ**:
- 3ä¸ªæ ¸å¿ƒServiceå…¨éƒ¨å®Œå–„
- æ·»åŠ 22ä¸ªæ–°åŠŸèƒ½
- æ–°å¢~1330è¡Œé«˜è´¨é‡ä»£ç 
- å®Œæ•´çš„ç±»å‹æ³¨è§£å’Œæ–‡æ¡£

â­ **äº®ç‚¹**:
- ä¼ä¸šçº§ç¼“å­˜æœºåˆ¶
- å®Œæ•´çš„ç»Ÿè®¡å’Œç›‘æ§
- çµæ´»çš„æ‰¹é‡æ“ä½œ
- å¼ºå¤§çš„ä»»åŠ¡ç®¡ç†

ğŸ¯ **è´¨é‡**:
- ç»Ÿä¸€çš„ä»£ç é£æ ¼
- å®Œæ•´çš„é”™è¯¯å¤„ç†
- ç»“æ„åŒ–æ—¥å¿—
- æ˜“äºæµ‹è¯•å’Œç»´æŠ¤

**å‡†å¤‡å°±ç»ª**: Serviceå±‚å·²å…·å¤‡ç”Ÿäº§çº§åˆ«çš„åŠŸèƒ½å’Œè´¨é‡ï¼Œå¯ä»¥ç»§ç»­é›†æˆåˆ°gRPCæœåŠ¡å’ŒGoåç«¯ã€‚

---

**å®Œæˆæ—¥æœŸ**: 2025-10-28  
**æ€»è€—æ—¶**: ~4å°æ—¶ï¼ˆç¬¦åˆè®¡åˆ’ï¼‰  
**çŠ¶æ€**: âœ… å®Œæˆ

