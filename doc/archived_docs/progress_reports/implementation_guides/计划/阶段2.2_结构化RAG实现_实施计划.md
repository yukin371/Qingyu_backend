# é˜¶æ®µ 2.2ï¼šç»“æ„åŒ–RAGå®ç° - å®æ–½è®¡åˆ’

**æ—¥æœŸ**: 2025-10-28  
**çŠ¶æ€**: ğŸš§ è¿›è¡Œä¸­  
**é¢„è®¡æ—¶é—´**: Week 3ï¼ˆ3-4å°æ—¶ï¼‰

---

## ğŸ¯ ç›®æ ‡

åœ¨é˜¶æ®µ2.1å‘é‡åŒ–å¼•æ“çš„åŸºç¡€ä¸Šï¼Œå®ç°å®Œæ•´çš„RAGï¼ˆRetrieval Augmented Generationï¼‰ç³»ç»Ÿï¼ŒåŒ…æ‹¬æ£€ç´¢ã€é‡æ’åºã€ä¸Šä¸‹æ–‡ç»„è£…å’Œå¼•ç”¨æ ‡æ³¨ã€‚

---

## ğŸ“‹ æ ¸å¿ƒä»»åŠ¡

### ä»»åŠ¡ 1: RAGPipeline æ ¸å¿ƒç±»ï¼ˆ60åˆ†é’Ÿï¼‰

#### 1.1 åˆ›å»ºRAGPipeline
**æ–‡ä»¶**: `python_ai_service/src/rag/rag_pipeline.py`ï¼ˆæ–°å»ºï¼‰

**æ ¸å¿ƒèŒè´£**:
- ç«¯åˆ°ç«¯RAGæµç¨‹ç¼–æ’
- ç»Ÿä¸€çš„æ£€ç´¢æ¥å£
- ä¸Šä¸‹æ–‡ç»„è£…
- å¼•ç”¨æ ‡æ³¨

**æ ¸å¿ƒæ–¹æ³•**:
```python
class RAGPipeline:
    def __init__(
        self,
        embedding_manager: EmbeddingManager,
        milvus_client: MilvusClient,
        reranker: Optional[Reranker] = None
    ):
        """åˆå§‹åŒ–RAG Pipeline"""
        
    async def retrieve(
        self,
        query: str,
        top_k: int = 5,
        filters: Optional[Dict] = None
    ) -> List[RetrievalResult]:
        """æ£€ç´¢ç›¸å…³æ–‡æ¡£"""
        
    async def retrieve_and_rerank(
        self,
        query: str,
        top_k: int = 5,
        rerank_top_k: int = 3
    ) -> List[RetrievalResult]:
        """æ£€ç´¢å¹¶é‡æ’åº"""
        
    async def build_context(
        self,
        results: List[RetrievalResult],
        max_tokens: int = 2000
    ) -> str:
        """æ„å»ºRAGä¸Šä¸‹æ–‡"""
        
    async def retrieve_with_context(
        self,
        query: str,
        top_k: int = 5,
        max_tokens: int = 2000
    ) -> RAGContext:
        """å®Œæ•´RAGæµç¨‹ï¼ˆæ£€ç´¢+ä¸Šä¸‹æ–‡ï¼‰"""
```

#### 1.2 æ•°æ®ç»“æ„å®šä¹‰
**æ–‡ä»¶**: `python_ai_service/src/rag/schemas.py`ï¼ˆæ–°å»ºï¼‰

```python
@dataclass
class RetrievalResult:
    """æ£€ç´¢ç»“æœ"""
    id: str
    text: str
    score: float
    source: str
    document_id: str
    chunk_id: int
    metadata: Dict[str, Any]
    
@dataclass
class RAGContext:
    """RAGä¸Šä¸‹æ–‡"""
    query: str
    context: str
    sources: List[RetrievalResult]
    total_tokens: int
    metadata: Dict[str, Any]
```

---

### ä»»åŠ¡ 2: Reranker é‡æ’åºï¼ˆ45åˆ†é’Ÿï¼‰

#### 2.1 åˆ›å»ºRerankeræ¥å£
**æ–‡ä»¶**: `python_ai_service/src/rag/reranker.py`ï¼ˆæ–°å»ºï¼‰

**å®ç°ç­–ç•¥**:
- **Cross-Encoder Reranker** - ä½¿ç”¨äº¤å‰ç¼–ç å™¨æ¨¡å‹
- **BM25 Reranker** - åŸºäºå…³é”®è¯çš„é‡æ’åºï¼ˆå¯é€‰ï¼‰
- **Reciprocal Rank Fusion** - èåˆå¤šç§æ’åºç»“æœ

**æ ¸å¿ƒæ–¹æ³•**:
```python
class CrossEncoderReranker:
    def __init__(self, model_name: str = "BAAI/bge-reranker-large"):
        """åˆå§‹åŒ–é‡æ’åºæ¨¡å‹"""
        
    async def rerank(
        self,
        query: str,
        documents: List[str],
        top_k: int = 5
    ) -> List[Tuple[int, float]]:
        """
        é‡æ’åºæ–‡æ¡£
        
        Returns:
            [(doc_index, score), ...]
        """
        
    def get_scores(
        self,
        query: str,
        documents: List[str]
    ) -> List[float]:
        """è·å–ç›¸å…³æ€§åˆ†æ•°"""
```

#### 2.2 å®ç°RRFèåˆ
**æ–‡ä»¶**: `python_ai_service/src/rag/fusion.py`ï¼ˆæ–°å»ºï¼‰

```python
class ReciprocalRankFusion:
    """å€’æ•°æ’åèåˆï¼ˆRRFï¼‰"""
    
    def fuse(
        self,
        rankings: List[List[Tuple[str, float]]],
        k: int = 60
    ) -> List[Tuple[str, float]]:
        """
        èåˆå¤šä¸ªæ’åºç»“æœ
        
        RRF Score = sum(1 / (k + rank_i))
        """
```

---

### ä»»åŠ¡ 3: æ··åˆæ£€ç´¢ï¼ˆ40åˆ†é’Ÿï¼‰

#### 3.1 å®ç°BM25æ£€ç´¢
**æ–‡ä»¶**: `python_ai_service/src/rag/bm25_retriever.py`ï¼ˆæ–°å»ºï¼‰

```python
from rank_bm25 import BM25Okapi

class BM25Retriever:
    """BM25å…³é”®è¯æ£€ç´¢"""
    
    def __init__(self):
        self.corpus: List[str] = []
        self.bm25: Optional[BM25Okapi] = None
        self.doc_ids: List[str] = []
        
    def index_documents(
        self,
        documents: List[Dict[str, Any]]
    ):
        """ç´¢å¼•æ–‡æ¡£"""
        
    def search(
        self,
        query: str,
        top_k: int = 10
    ) -> List[Tuple[str, float]]:
        """BM25æ£€ç´¢"""
```

#### 3.2 å®ç°æ··åˆæ£€ç´¢å™¨
**æ–‡ä»¶**: `python_ai_service/src/rag/hybrid_retriever.py`ï¼ˆæ–°å»ºï¼‰

```python
class HybridRetriever:
    """æ··åˆæ£€ç´¢å™¨ï¼ˆå‘é‡ + BM25ï¼‰"""
    
    def __init__(
        self,
        vector_retriever: MilvusClient,
        bm25_retriever: BM25Retriever,
        fusion_method: str = "rrf"  # rrf, weighted
    ):
        """åˆå§‹åŒ–æ··åˆæ£€ç´¢å™¨"""
        
    async def search(
        self,
        query: str,
        top_k: int = 5,
        vector_weight: float = 0.7,
        bm25_weight: float = 0.3
    ) -> List[RetrievalResult]:
        """æ··åˆæ£€ç´¢"""
```

---

### ä»»åŠ¡ 4: ä¸Šä¸‹æ–‡ç»„è£…ï¼ˆ30åˆ†é’Ÿï¼‰

#### 4.1 å®ç°ä¸Šä¸‹æ–‡æ„å»ºå™¨
**æ–‡ä»¶**: `python_ai_service/src/rag/context_builder.py`ï¼ˆæ–°å»ºï¼‰

**æ ¸å¿ƒåŠŸèƒ½**:
- Tokenè®¡æ•°ï¼ˆä½¿ç”¨tiktokenï¼‰
- æ™ºèƒ½æˆªæ–­ï¼ˆä¿ç•™å®Œæ•´å¥å­ï¼‰
- ä¸Šä¸‹æ–‡æ¨¡æ¿
- å¼•ç”¨æ ‡æ³¨

```python
class ContextBuilder:
    """ä¸Šä¸‹æ–‡æ„å»ºå™¨"""
    
    def __init__(self, model: str = "gpt-3.5-turbo"):
        self.encoding = tiktoken.encoding_for_model(model)
        
    def count_tokens(self, text: str) -> int:
        """è®¡ç®—tokenæ•°é‡"""
        
    def build_context(
        self,
        query: str,
        results: List[RetrievalResult],
        max_tokens: int = 2000,
        template: Optional[str] = None
    ) -> str:
        """æ„å»ºä¸Šä¸‹æ–‡"""
        
    def add_citations(
        self,
        context: str,
        results: List[RetrievalResult]
    ) -> str:
        """æ·»åŠ å¼•ç”¨æ ‡æ³¨"""
```

#### 4.2 ä¸Šä¸‹æ–‡æ¨¡æ¿

**é»˜è®¤æ¨¡æ¿**:
```
åŸºäºä»¥ä¸‹å‚è€ƒèµ„æ–™å›ç­”é—®é¢˜ï¼š

[èµ„æ–™1] æ¥æºï¼š{source}
{text}

[èµ„æ–™2] æ¥æºï¼š{source}
{text}

...

é—®é¢˜ï¼š{query}

è¯·åŸºäºä¸Šè¿°èµ„æ–™å›ç­”ï¼Œå¹¶åœ¨å›ç­”ä¸­æ ‡æ³¨å¼•ç”¨æ¥æºï¼ˆå¦‚[1]ã€[2]ï¼‰ã€‚
```

---

### ä»»åŠ¡ 5: å¼•ç”¨æ ‡æ³¨ï¼ˆ25åˆ†é’Ÿï¼‰

#### 5.1 å®ç°Citationç®¡ç†
**æ–‡ä»¶**: `python_ai_service/src/rag/citation.py`ï¼ˆæ–°å»ºï¼‰

```python
@dataclass
class Citation:
    """å¼•ç”¨ä¿¡æ¯"""
    index: int
    source: str
    document_id: str
    chunk_id: int
    text_snippet: str
    
class CitationManager:
    """å¼•ç”¨ç®¡ç†å™¨"""
    
    def extract_citations(
        self,
        response: str
    ) -> List[int]:
        """ä»å›å¤ä¸­æå–å¼•ç”¨æ ‡è®° [1], [2]..."""
        
    def format_citations(
        self,
        results: List[RetrievalResult]
    ) -> str:
        """æ ¼å¼åŒ–å¼•ç”¨åˆ—è¡¨"""
        
    def validate_citations(
        self,
        response: str,
        num_sources: int
    ) -> bool:
        """éªŒè¯å¼•ç”¨æ˜¯å¦æœ‰æ•ˆ"""
```

---

### ä»»åŠ¡ 6: é…ç½®ç®¡ç†ï¼ˆ10åˆ†é’Ÿï¼‰

#### 6.1 æ›´æ–°é…ç½®
**æ–‡ä»¶**: `python_ai_service/src/core/config.py`

**æ–°å¢é…ç½®é¡¹**:
```python
class Settings(BaseSettings):
    # RAGé…ç½®
    rag_top_k: int = 5
    rag_rerank_top_k: int = 3
    rag_max_context_tokens: int = 2000
    rag_use_reranker: bool = True
    rag_use_hybrid_search: bool = False
    
    # Rerankeré…ç½®
    reranker_model: str = "BAAI/bge-reranker-large"
    reranker_batch_size: int = 32
    
    # æ··åˆæ£€ç´¢é…ç½®
    hybrid_vector_weight: float = 0.7
    hybrid_bm25_weight: float = 0.3
    hybrid_fusion_method: str = "rrf"  # rrf, weighted
```

---

### ä»»åŠ¡ 7: æµ‹è¯•ä¸æ–‡æ¡£ï¼ˆ40åˆ†é’Ÿï¼‰

#### 7.1 å•å…ƒæµ‹è¯•
**æ–‡ä»¶**: `python_ai_service/tests/test_rag_pipeline.py`ï¼ˆæ–°å»ºï¼‰

**æµ‹è¯•ç”¨ä¾‹**:
- æµ‹è¯•åŸºç¡€æ£€ç´¢
- æµ‹è¯•é‡æ’åº
- æµ‹è¯•ä¸Šä¸‹æ–‡æ„å»º
- æµ‹è¯•å¼•ç”¨æ ‡æ³¨
- æµ‹è¯•å®Œæ•´RAGæµç¨‹

#### 7.2 é›†æˆæµ‹è¯•
**æ–‡ä»¶**: `python_ai_service/tests/test_hybrid_retrieval.py`ï¼ˆæ–°å»ºï¼‰

**æµ‹è¯•åœºæ™¯**:
- å‘é‡æ£€ç´¢vs BM25æ£€ç´¢
- æ··åˆæ£€ç´¢å‡†ç¡®æ€§
- RRFèåˆæ•ˆæœ

#### 7.3 æ€§èƒ½æµ‹è¯•
**æµ‹è¯•æŒ‡æ ‡**:
- æ£€ç´¢å»¶è¿Ÿï¼ˆP50, P95, P99ï¼‰
- é‡æ’åºå»¶è¿Ÿ
- ç«¯åˆ°ç«¯RAGå»¶è¿Ÿ
- å†…å­˜å ç”¨

#### 7.4 ä¸­æ–‡æ–‡æ¡£
**æ–‡ä»¶**: `doc/implementation/00è¿›åº¦æŒ‡å¯¼/é˜¶æ®µ2.2_ç»“æ„åŒ–RAGå®ç°_å®æ–½æŠ¥å‘Š.md`ï¼ˆæ–°å»ºï¼‰

**æ–‡æ¡£ç»“æ„**:
```markdown
# é˜¶æ®µ 2.2ï¼šç»“æ„åŒ–RAGå®ç°å®æ–½æŠ¥å‘Š

## å®æ–½æ¦‚è§ˆ
## RAGPipelineè®¾è®¡
## Rerankeré›†æˆ
## æ··åˆæ£€ç´¢
## ä¸Šä¸‹æ–‡ç»„è£…
## å¼•ç”¨æ ‡æ³¨
## ä½¿ç”¨æŒ‡å—
## æ€§èƒ½æµ‹è¯•ç»“æœ
## åç»­è§„åˆ’
```

---

## ğŸ—‚ï¸ æ–‡ä»¶æ¸…å•

### æ–°å»ºæ–‡ä»¶ï¼ˆ9ä¸ªï¼‰
1. `python_ai_service/src/rag/rag_pipeline.py` - RAG Pipeline
2. `python_ai_service/src/rag/schemas.py` - æ•°æ®ç»“æ„
3. `python_ai_service/src/rag/reranker.py` - é‡æ’åºå™¨
4. `python_ai_service/src/rag/fusion.py` - æ’åºèåˆ
5. `python_ai_service/src/rag/bm25_retriever.py` - BM25æ£€ç´¢
6. `python_ai_service/src/rag/hybrid_retriever.py` - æ··åˆæ£€ç´¢
7. `python_ai_service/src/rag/context_builder.py` - ä¸Šä¸‹æ–‡æ„å»º
8. `python_ai_service/src/rag/citation.py` - å¼•ç”¨ç®¡ç†
9. `python_ai_service/tests/test_rag_pipeline.py` - RAGæµ‹è¯•

### æ›´æ–°æ–‡ä»¶ï¼ˆ1ä¸ªï¼‰
10. `python_ai_service/src/core/config.py` - é…ç½®æ›´æ–°

### æ–‡æ¡£æ–‡ä»¶ï¼ˆ1ä¸ªï¼‰
11. `doc/implementation/00è¿›åº¦æŒ‡å¯¼/é˜¶æ®µ2.2_ç»“æ„åŒ–RAGå®ç°_å®æ–½æŠ¥å‘Š.md`

---

## â±ï¸ æ—¶é—´åˆ†é…

| ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | ä¼˜å…ˆçº§ |
|------|---------|-------|
| 1. RAGPipelineæ ¸å¿ƒç±» | 60åˆ†é’Ÿ | P0 |
| 2. Rerankeré‡æ’åº | 45åˆ†é’Ÿ | P1 |
| 3. æ··åˆæ£€ç´¢ | 40åˆ†é’Ÿ | P1 |
| 4. ä¸Šä¸‹æ–‡ç»„è£… | 30åˆ†é’Ÿ | P0 |
| 5. å¼•ç”¨æ ‡æ³¨ | 25åˆ†é’Ÿ | P1 |
| 6. é…ç½®ç®¡ç† | 10åˆ†é’Ÿ | P0 |
| 7. æµ‹è¯•ä¸æ–‡æ¡£ | 40åˆ†é’Ÿ | P0 |
| **æ€»è®¡** | **3.5å°æ—¶** | |

---

## âœ… éªŒæ”¶æ ‡å‡†

- [ ] RAGPipelineæ”¯æŒå®Œæ•´çš„æ£€ç´¢æµç¨‹
- [ ] Rerankeræ­£ç¡®æå‡æ£€ç´¢å‡†ç¡®ç‡
- [ ] æ··åˆæ£€ç´¢ç»“åˆå‘é‡å’Œå…³é”®è¯
- [ ] ä¸Šä¸‹æ–‡æ„å»ºç¬¦åˆtokené™åˆ¶
- [ ] å¼•ç”¨æ ‡æ³¨æ ¼å¼æ­£ç¡®
- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] æ£€ç´¢å‡†ç¡®ç‡æå‡20%+ï¼ˆå¯¹æ¯”çº¯å‘é‡æ£€ç´¢ï¼‰
- [ ] P95å»¶è¿Ÿ<500ms
- [ ] ä¸­æ–‡æ–‡æ¡£å®Œæ•´æ¸…æ™°

---

## ğŸ”§ æŠ€æœ¯è¦ç‚¹

### RAGæµç¨‹

```
ç”¨æˆ·æŸ¥è¯¢
   â†“
1. å‘é‡åŒ–æŸ¥è¯¢
   â†“
2. å‘é‡æ£€ç´¢ï¼ˆtop_k=10ï¼‰
   â†“
3. [å¯é€‰] BM25æ£€ç´¢ + èåˆ
   â†“
4. [å¯é€‰] Rerankeré‡æ’åºï¼ˆtop_k=5ï¼‰
   â†“
5. æ„å»ºä¸Šä¸‹æ–‡ï¼ˆæ·»åŠ å¼•ç”¨ï¼‰
   â†“
6. è¿”å›RAGContext
```

### RerankeråŸç†

Cross-Encoderç›´æ¥å¯¹(query, doc)å¯¹æ‰“åˆ†ï¼Œæ¯”Bi-Encoderæ›´å‡†ç¡®ï¼š

```python
# Bi-Encoder (å‘é‡æ£€ç´¢)
query_vec = encode(query)
doc_vec = encode(doc)
score = cosine(query_vec, doc_vec)

# Cross-Encoder (é‡æ’åº)
score = cross_encode([query, doc])  # æ›´å‡†ç¡®ä½†æ›´æ…¢
```

### æ··åˆæ£€ç´¢

RRFï¼ˆReciprocal Rank Fusionï¼‰:

```python
RRF_score(d) = sum(1 / (k + rank_i(d)))

# ç¤ºä¾‹
# å‘é‡æ£€ç´¢: [doc1, doc3, doc2]  ranks=[1,2,3]
# BM25æ£€ç´¢: [doc2, doc1, doc4]  ranks=[1,2,3]
# 
# RRFåˆ†æ•°:
# doc1: 1/(60+1) + 1/(60+2) = 0.0328
# doc2: 1/(60+3) + 1/(60+1) = 0.0322
# doc3: 1/(60+2) + 0         = 0.0161
# doc4: 0       + 1/(60+3)   = 0.0159
#
# æœ€ç»ˆæ’åº: [doc1, doc2, doc3, doc4]
```

---

## ğŸ“Š é¢„æœŸæˆæœ

**ä»£ç é‡**: ~1500è¡Œ
- RAGPipeline: ~300è¡Œ
- Reranker: ~200è¡Œ
- æ··åˆæ£€ç´¢: ~300è¡Œ
- ä¸Šä¸‹æ–‡æ„å»º: ~200è¡Œ
- å¼•ç”¨ç®¡ç†: ~150è¡Œ
- æµ‹è¯•: ~350è¡Œ

**æ€§èƒ½æå‡**:
- æ£€ç´¢å‡†ç¡®ç‡ï¼š+20%ï¼ˆä½¿ç”¨Rerankerï¼‰
- å¬å›ç‡ï¼š+15%ï¼ˆä½¿ç”¨æ··åˆæ£€ç´¢ï¼‰
- ç”¨æˆ·æ»¡æ„åº¦ï¼šæ˜¾è‘—æå‡ï¼ˆæœ‰å¼•ç”¨æ¥æºï¼‰

**åŠŸèƒ½å®Œå–„åº¦**:
- æ£€ç´¢ç­–ç•¥ï¼š3ç§ï¼ˆå‘é‡ã€BM25ã€æ··åˆï¼‰
- é‡æ’åºï¼šCross-Encoder
- ä¸Šä¸‹æ–‡ï¼šæ™ºèƒ½æˆªæ–­ã€å¼•ç”¨æ ‡æ³¨
- èåˆæ–¹æ³•ï¼šRRF

---

## ğŸš€ ä¸‹ä¸€æ­¥

å®Œæˆé˜¶æ®µ2.2åï¼Œå°†è¿›å…¥ï¼š

**é˜¶æ®µ 2.3ï¼šäº‹ä»¶é©±åŠ¨ç´¢å¼•æ›´æ–°**ï¼ˆWeek 4ï¼‰
- EventBusé›†æˆ
- ç›‘å¬æ–‡æ¡£å˜æ›´äº‹ä»¶
- è‡ªåŠ¨å¢é‡ç´¢å¼•
- ç´¢å¼•ç‰ˆæœ¬æ§åˆ¶

---

**åˆ›å»ºæ—¥æœŸ**: 2025-10-28  
**é¢„è®¡å®Œæˆ**: 2025-10-28  
**ç»´æŠ¤è€…**: é’ç¾½åç«¯æ¶æ„å›¢é˜Ÿ

