# Task 4: è‡ªåŠ¨ä¿å­˜åŠŸèƒ½å®æ–½æ–¹æ¡ˆ

**æ—¥æœŸ**: 2025-10-29 æ·±å¤œ  
**çŠ¶æ€**: ğŸ”„ è¿›è¡Œä¸­  
**é¢„è®¡å·¥æœŸ**: 1.5å¤©ï¼ˆå‹ç¼©åˆ°4å°æ—¶ï¼‰

---

## ğŸ“Š ç°çŠ¶åˆ†æ

### å·²æœ‰åŸºç¡€

âœ… **DocumentContentRepository**ï¼ˆå®Œæ•´ï¼‰:
- `GetByDocumentID()` - è·å–æ–‡æ¡£å†…å®¹
- `UpdateWithVersion()` - ä¹è§‚é”ç‰ˆæœ¬æ›´æ–°
- `Create()` - åˆ›å»ºæ–‡æ¡£å†…å®¹

âœ… **DocumentService**ï¼ˆéƒ¨åˆ†å®Œæˆï¼‰:
- `AutoSaveDocument()` - å·²å®ç°æ¡†æ¶ï¼Œä½†æœ‰TODO
- `GetDocumentContent()` - å·²å®ç°æ¡†æ¶ï¼Œä½†è¿”å›ç©º
- `UpdateDocumentContent()` - å·²å®ç°æ¡†æ¶ï¼Œä½†æœªä¿å­˜

âœ… **DTOå’ŒAPI**:
- `AutoSaveRequest/Response` - å·²å®šä¹‰
- `SaveStatusResponse` - å·²å®šä¹‰
- `DocumentContentResponse` - å·²å®šä¹‰

### å¾…ä¿®å¤çš„é—®é¢˜

âŒ **DocumentServiceæœªæ³¨å…¥DocumentContentRepository**:
- å½“å‰åªæ³¨å…¥äº† `documentRepo` å’Œ `projectRepo`
- éœ€è¦æ³¨å…¥ `DocumentContentRepository`

âŒ **AutoSaveDocument**ï¼ˆ606-693è¡Œï¼‰:
- TODOï¼ˆ668è¡Œï¼‰ï¼šå†…å®¹æœªä¿å­˜åˆ°DocumentContenté›†åˆ
- TODOï¼ˆ642è¡Œï¼‰ï¼šç‰ˆæœ¬å†²çªæ£€æµ‹ç®€åŒ–å¤„ç†
- ç¼ºå°‘çœŸå®ç‰ˆæœ¬å·è·å–

âŒ **GetDocumentContent**ï¼ˆ723-767è¡Œï¼‰:
- TODOï¼ˆ756è¡Œï¼‰ï¼šå†…å®¹è·å–è¿”å›ç©ºå­—ç¬¦ä¸²

âŒ **UpdateDocumentContent**ï¼ˆ770-836è¡Œï¼‰:
- TODOï¼ˆ820è¡Œï¼‰ï¼šå†…å®¹ä¿å­˜æœªå®ç°
- TODOï¼ˆ803è¡Œï¼‰ï¼šç‰ˆæœ¬å†²çªæ£€æµ‹æœªå®ç°

---

## ğŸ¯ å®æ–½ç­–ç•¥

é‡‡ç”¨**æ¸è¿›å¼ä¿®å¤**ç­–ç•¥ï¼š

**Phase 1ï¼ˆæ ¸å¿ƒï¼‰**: å®ŒæˆåŸºç¡€è‡ªåŠ¨ä¿å­˜ï¼ˆ2å°æ—¶ï¼‰
- æ³¨å…¥DocumentContentRepository
- å®Œå–„AutoSaveDocumentä¿å­˜é€»è¾‘
- å®ç°GetDocumentContentè·å–é€»è¾‘
- å®ç°UpdateDocumentContentä¿å­˜é€»è¾‘
- ç‰ˆæœ¬æ§åˆ¶ï¼ˆä¹è§‚é”ï¼‰

**Phase 2ï¼ˆå¯é€‰ï¼‰**: é«˜çº§åŠŸèƒ½ï¼ˆå»¶ååˆ°Phase 4ï¼‰
- å®šæ—¶è§¦å‘ï¼ˆä¾èµ–å‰ç«¯ï¼‰
- å˜åŒ–æ£€æµ‹ï¼ˆä¾èµ–å‰ç«¯ï¼‰
- ç‰ˆæœ¬å†å²è®°å½•
- å†²çªè§£å†³UI

---

## ğŸ“‹ è¯¦ç»†å®æ–½æ­¥éª¤

### Step 1: æ³¨å…¥DocumentContentRepositoryï¼ˆ30åˆ†é’Ÿï¼‰

**ä¿®æ”¹æ–‡ä»¶**: `service/document/document_service.go`

**1.1 æ·»åŠ å­—æ®µ**:
```go
type DocumentService struct {
    documentRepo        writingRepo.DocumentRepository
    documentContentRepo writingRepo.DocumentContentRepository  // æ–°å¢
    projectRepo         writingRepo.ProjectRepository
    eventBus            base.EventBus
    serviceName         string
    version             string
}
```

**1.2 ä¿®æ”¹æ„é€ å‡½æ•°**:
```go
func NewDocumentService(
    documentRepo writingRepo.DocumentRepository,
    documentContentRepo writingRepo.DocumentContentRepository,  // æ–°å¢å‚æ•°
    projectRepo writingRepo.ProjectRepository,
    eventBus base.EventBus,
) *DocumentService
```

**1.3 æ›´æ–°æœåŠ¡æ³¨å†Œ**ï¼ˆç¨åå¤„ç†ï¼‰

---

### Step 2: å®Œå–„AutoSaveDocumentï¼ˆ1å°æ—¶ï¼‰

**å½“å‰é—®é¢˜**ï¼ˆ606-693è¡Œï¼‰:
- å†…å®¹æœªä¿å­˜åˆ°DocumentContent
- ç‰ˆæœ¬æ§åˆ¶ç®€åŒ–

**å®æ–½æ–¹æ¡ˆ**:

```go
func (s *DocumentService) AutoSaveDocument(ctx context.Context, req *AutoSaveRequest) (*AutoSaveResponse, error) {
    // ... å‰ç½®éªŒè¯ï¼ˆå·²å®Œæˆï¼‰...

    // 4. è·å–æˆ–åˆ›å»ºDocumentContent
    content, err := s.documentContentRepo.GetByDocumentID(ctx, req.DocumentID)
    if err != nil {
        return nil, err
    }
    
    if content == nil {
        // é¦–æ¬¡ä¿å­˜ï¼Œåˆ›å»ºæ–°DocumentContent
        content = &writer.DocumentContent{
            DocumentID: req.DocumentID,
            Content:    req.Content,
            Version:    1,
        }
        err = s.documentContentRepo.Create(ctx, content)
    } else {
        // æ›´æ–°ç°æœ‰å†…å®¹ï¼ˆå¸¦ç‰ˆæœ¬æ£€æµ‹ï¼‰
        expectedVersion := req.CurrentVersion
        if expectedVersion == 0 {
            expectedVersion = content.Version
        }
        
        err = s.documentContentRepo.UpdateWithVersion(
            ctx,
            req.DocumentID,
            req.Content,
            expectedVersion,
        )
        
        if err != nil {
            // ç‰ˆæœ¬å†²çª
            return &AutoSaveResponse{
                Saved:       false,
                HasConflict: true,
                NewVersion:  content.Version,
            }, nil
        }
        
        // æ›´æ–°æˆåŠŸåé‡æ–°è·å–æœ€æ–°å†…å®¹
        content, _ = s.documentContentRepo.GetByDocumentID(ctx, req.DocumentID)
    }
    
    // 5. è®¡ç®—å­—æ•°å¹¶æ›´æ–°Documentå…ƒæ•°æ®
    wordCount := len([]rune(req.Content))
    updates := map[string]interface{}{
        "word_count": wordCount,
        "updated_at": time.Now(),
    }
    s.documentRepo.Update(ctx, req.DocumentID, updates)
    
    // 6. å‘å¸ƒäº‹ä»¶ï¼ˆå·²æœ‰ï¼‰
    
    // 7. è¿”å›å“åº”
    return &AutoSaveResponse{
        Saved:       true,
        NewVersion:  content.Version,
        WordCount:   wordCount,
        SavedAt:     time.Now(),
        HasConflict: false,
    }, nil
}
```

**å…³é”®æ”¹è¿›**:
- âœ… å®é™…ä¿å­˜å†…å®¹åˆ°DocumentContent
- âœ… ä½¿ç”¨UpdateWithVersionå®ç°ä¹è§‚é”
- âœ… ç‰ˆæœ¬å†²çªæ—¶è¿”å›HasConflict=true
- âœ… é¦–æ¬¡ä¿å­˜æ—¶è‡ªåŠ¨åˆ›å»ºDocumentContent

---

### Step 3: å®Œå–„GetDocumentContentï¼ˆ30åˆ†é’Ÿï¼‰

**å½“å‰é—®é¢˜**ï¼ˆ723-767è¡Œï¼‰:
- è¿”å›ç©ºå­—ç¬¦ä¸²

**å®æ–½æ–¹æ¡ˆ**:

```go
func (s *DocumentService) GetDocumentContent(ctx context.Context, documentID string) (*DocumentContentResponse, error) {
    // ... å‰ç½®éªŒè¯ï¼ˆå·²å®Œæˆï¼‰...
    
    // 4. è·å–å†…å®¹
    content, err := s.documentContentRepo.GetByDocumentID(ctx, documentID)
    if err != nil {
        return nil, pkgErrors.NewServiceError(s.serviceName, pkgErrors.ServiceErrorInternal, "æŸ¥è¯¢æ–‡æ¡£å†…å®¹å¤±è´¥", "", err)
    }
    
    actualContent := ""
    version := 1
    if content != nil {
        actualContent = content.Content
        version = content.Version
    }
    
    // 5. è¿”å›å†…å®¹å“åº”
    return &DocumentContentResponse{
        DocumentID: documentID,
        Content:    actualContent,
        Version:    version,
        WordCount:  doc.WordCount,
        UpdatedAt:  doc.UpdatedAt,
    }, nil
}
```

**å…³é”®æ”¹è¿›**:
- âœ… ä»DocumentContentRepositoryå®é™…è·å–å†…å®¹
- âœ… è¿”å›çœŸå®ç‰ˆæœ¬å·
- âœ… å¤„ç†DocumentContentä¸å­˜åœ¨çš„æƒ…å†µ

---

### Step 4: å®Œå–„UpdateDocumentContentï¼ˆ30åˆ†é’Ÿï¼‰

**å½“å‰é—®é¢˜**ï¼ˆ770-836è¡Œï¼‰:
- å†…å®¹æœªä¿å­˜
- ç‰ˆæœ¬å†²çªæ£€æµ‹æœªå®ç°

**å®æ–½æ–¹æ¡ˆ**:

```go
func (s *DocumentService) UpdateDocumentContent(ctx context.Context, req *UpdateContentRequest) error {
    // ... å‰ç½®éªŒè¯ï¼ˆå·²å®Œæˆï¼‰...
    
    // 4. ç‰ˆæœ¬å†²çªæ£€æµ‹
    if req.Version > 0 {
        content, err := s.documentContentRepo.GetByDocumentID(ctx, req.DocumentID)
        if err != nil {
            return pkgErrors.NewServiceError(s.serviceName, pkgErrors.ServiceErrorInternal, "æŸ¥è¯¢æ–‡æ¡£å†…å®¹å¤±è´¥", "", err)
        }
        
        if content != nil && content.Version != req.Version {
            return pkgErrors.NewServiceError(s.serviceName, pkgErrors.ServiceErrorBusiness, "ç‰ˆæœ¬å†²çªï¼Œè¯·åˆ·æ–°åé‡è¯•", "", nil)
        }
    }
    
    // 5. ä¿å­˜å†…å®¹
    err := s.documentContentRepo.UpdateWithVersion(ctx, req.DocumentID, req.Content, req.Version)
    if err != nil {
        if err.Error() == "ç‰ˆæœ¬å†²çªï¼Œè¯·é‡æ–°è·å–æœ€æ–°å†…å®¹" {
            return pkgErrors.NewServiceError(s.serviceName, pkgErrors.ServiceErrorBusiness, "ç‰ˆæœ¬å†²çªï¼Œè¯·åˆ·æ–°åé‡è¯•", "", err)
        }
        return pkgErrors.NewServiceError(s.serviceName, pkgErrors.ServiceErrorInternal, "ä¿å­˜å†…å®¹å¤±è´¥", "", err)
    }
    
    // 6. è®¡ç®—å­—æ•°å¹¶æ›´æ–°æ–‡æ¡£å…ƒæ•°æ®
    wordCount := len([]rune(req.Content))
    updates := map[string]interface{}{
        "word_count": wordCount,
        "updated_at": time.Now(),
    }
    s.documentRepo.Update(ctx, req.DocumentID, updates)
    
    // 7. å‘å¸ƒäº‹ä»¶ï¼ˆå·²æœ‰ï¼‰
    
    return nil
}
```

**å…³é”®æ”¹è¿›**:
- âœ… å®é™…ä¿å­˜å†…å®¹åˆ°DocumentContentRepository
- âœ… ç‰ˆæœ¬å†²çªæ£€æµ‹å’Œè¿”å›
- âœ… ä½¿ç”¨UpdateWithVersionä¿è¯åŸå­æ€§

---

### Step 5: æ›´æ–°æœåŠ¡æ³¨å†Œï¼ˆ30åˆ†é’Ÿï¼‰

**éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶**:
- `cmd/server/main.go` æˆ–
- `core/server.go`

**ä¿®æ”¹å†…å®¹**:
```go
// åˆ›å»ºDocumentContentRepository
documentContentRepo := factory.CreateDocumentContentRepository()

// æ³¨å…¥åˆ°DocumentService
documentService := document.NewDocumentService(
    documentRepo,
    documentContentRepo,  // æ–°å¢
    projectRepo,
    eventBus,
)
```

---

## â±ï¸ æ—¶é—´åˆ†é…

| æ­¥éª¤ | é¢„è®¡æ—¶é—´ | è¯´æ˜ |
|-----|---------|------|
| Step 1: æ³¨å…¥Repository | 30åˆ†é’Ÿ | ä¿®æ”¹ç»“æ„å’Œæ„é€ å‡½æ•° |
| Step 2: AutoSaveDocument | 1å°æ—¶ | æ ¸å¿ƒä¿å­˜é€»è¾‘ |
| Step 3: GetDocumentContent | 30åˆ†é’Ÿ | è·å–å†…å®¹ |
| Step 4: UpdateDocumentContent | 30åˆ†é’Ÿ | æ›´æ–°å†…å®¹ |
| Step 5: æœåŠ¡æ³¨å†Œ | 30åˆ†é’Ÿ | é›†æˆåˆ°ç³»ç»Ÿ |
| Step 6: æµ‹è¯•ä¿®å¤ | 30åˆ†é’Ÿ | Lintå’ŒåŸºç¡€æµ‹è¯• |
| **æ€»è®¡** | **4å°æ—¶** | **å‹ç¼©å®æ–½** |

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] AutoSaveDocumentå®é™…ä¿å­˜å†…å®¹åˆ°DocumentContent
- [ ] GetDocumentContentè¿”å›çœŸå®å†…å®¹
- [ ] UpdateDocumentContentå®é™…æ›´æ–°å†…å®¹
- [ ] ç‰ˆæœ¬å†²çªæ£€æµ‹æ­£å¸¸å·¥ä½œ
- [ ] é¦–æ¬¡ä¿å­˜è‡ªåŠ¨åˆ›å»ºDocumentContent

### è´¨é‡éªŒæ”¶
- [ ] 0 linté”™è¯¯
- [ ] 0ç¼–è¯‘é”™è¯¯
- [ ] æœåŠ¡æ³¨å†Œæ­£å¸¸
- [ ] åŸºç¡€åŠŸèƒ½æµ‹è¯•é€šè¿‡

### å»¶ååŠŸèƒ½
- â¸ï¸ å®šæ—¶è§¦å‘ï¼ˆå‰ç«¯å®ç°ï¼‰
- â¸ï¸ å˜åŒ–æ£€æµ‹ï¼ˆå‰ç«¯å®ç°ï¼‰
- â¸ï¸ ç‰ˆæœ¬å†å²UIï¼ˆPhase 4ï¼‰
- â¸ï¸ å†²çªè§£å†³UIï¼ˆPhase 4ï¼‰

---

## ğŸ“ å®æ–½è®°å½•

**å¼€å§‹æ—¶é—´**: 2025-10-29 æ·±å¤œ  
**é¢„è®¡å®Œæˆ**: 2025-10-30 å‡Œæ™¨

**ä¸‹ä¸€æ­¥**: Step 1 - æ³¨å…¥DocumentContentRepository

