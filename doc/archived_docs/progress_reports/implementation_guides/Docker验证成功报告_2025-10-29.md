# Docker éªŒè¯æˆåŠŸæŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-29  
**çŠ¶æ€**: âœ… å®Œæˆ  
**é˜¶æ®µ**: Phase3 é˜¶æ®µ 1.3 - Milvuså‘é‡æ•°æ®åº“éƒ¨ç½²éªŒè¯

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

æˆåŠŸè§£å†³etcdé…ç½®å†²çªé—®é¢˜ï¼Œå®ŒæˆMilvuså‘é‡æ•°æ®åº“æ ˆçš„Dockeréƒ¨ç½²éªŒè¯ã€‚æ‰€æœ‰æœåŠ¡ï¼ˆetcdã€MinIOã€Milvusï¼‰å‡æ­£å¸¸è¿è¡Œå¹¶é€šè¿‡å¥åº·æ£€æŸ¥ã€‚

---

## âœ… å·²å®Œæˆå·¥ä½œ

### 1. ä¿®å¤etcdé…ç½®å†²çª

**é—®é¢˜æè¿°**:
```
{"level":"fatal","ts":"2025-10-29T04:23:14.577Z","caller":"etcdmain/etcd.go:204",
"msg":"discovery failed","error":"--initial-cluster has default=http://localhost:2380 
but missing from --initial-advertise-peer-urls=http://172.18.0.3:2380"}
```

**æ ¹æœ¬åŸå› **: 
- etcdçš„`--initial-cluster`é»˜è®¤å€¼ä¸º`default=http://localhost:2380`
- ä½†å®¹å™¨å†…å®é™…IPè¢«æ£€æµ‹ä¸º`172.18.0.x`
- å¯¼è‡´peer URLä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**:
åœ¨`docker/docker-compose.dev.yml`ä¸­ä¿®æ”¹etcdé…ç½®ï¼š

```yaml
# ç§»é™¤å†²çªçš„ç¯å¢ƒå˜é‡
environment:
  - ETCD_AUTO_COMPACTION_MODE=revision
  - ETCD_AUTO_COMPACTION_RETENTION=1000
  - ETCD_QUOTA_BACKEND_BYTES=4294967296
  - ETCD_SNAPSHOT_COUNT=50000
  # å·²åˆ é™¤: ETCD_LISTEN_CLIENT_URLS
  # å·²åˆ é™¤: ETCD_ADVERTISE_CLIENT_URLS

# åœ¨commandä¸­æ˜ç¡®æŒ‡å®šæ‰€æœ‰å‚æ•°
command: etcd --listen-client-urls=http://0.0.0.0:2379 \
  --advertise-client-urls=http://etcd:2379 \
  --listen-peer-urls=http://0.0.0.0:2380 \
  --initial-advertise-peer-urls=http://etcd:2380 \
  --initial-cluster=default=http://etcd:2380 \
  --data-dir=/etcd_data
```

**å…³é”®å˜æ›´**:
- âœ… ç§»é™¤`ETCD_LISTEN_CLIENT_URLS`ç¯å¢ƒå˜é‡ï¼ˆä¸commandå‚æ•°å†²çªï¼‰
- âœ… ç§»é™¤`ETCD_ADVERTISE_CLIENT_URLS`ç¯å¢ƒå˜é‡ï¼ˆä¸commandå‚æ•°å†²çªï¼‰
- âœ… æ·»åŠ `--initial-advertise-peer-urls=http://etcd:2380`
- âœ… æ·»åŠ `--initial-cluster=default=http://etcd:2380`

---

### 2. DockeræœåŠ¡éªŒè¯

#### é•œåƒéªŒè¯
æ‰€æœ‰æ‰€éœ€é•œåƒå·²å­˜åœ¨æœ¬åœ°ï¼š
```
REPOSITORY              TAG      SIZE
minio/minio            latest   241MB
milvusdb/milvus        v2.3.0   1.02GB
quay.io/coreos/etcd    v3.5.5   273MB
```

#### æœåŠ¡å¯åŠ¨é¡ºåº
```bash
# 1. å¯åŠ¨etcdå’ŒMinIOï¼ˆMilvusä¾èµ–ï¼‰
docker-compose -f docker-compose.dev.yml up -d etcd minio

# 2. ç­‰å¾…30ç§’åˆå§‹åŒ–
Start-Sleep -Seconds 30

# 3. å¯åŠ¨Milvus
docker-compose -f docker-compose.dev.yml up -d milvus

# 4. ç­‰å¾…60ç§’è®©Milvusåˆå§‹åŒ–
Start-Sleep -Seconds 60
```

#### æœåŠ¡çŠ¶æ€éªŒè¯
```
NAME            IMAGE                        STATUS                        PORTS
qingyu-etcd     quay.io/coreos/etcd:v3.5.5   Up About a minute            0.0.0.0:2379->2379/tcp
qingyu-milvus   milvusdb/milvus:v2.3.0       Up About a minute (healthy)  0.0.0.0:9091->9091/tcp, 0.0.0.0:19530->19530/tcp
qingyu-minio    minio/minio:latest           Up 8 minutes                 0.0.0.0:9000-9001->9000-9001/tcp
```

**å…³é”®æŒ‡æ ‡**:
- âœ… etcd: è¿è¡Œæ­£å¸¸ï¼Œæ— é‡å¯
- âœ… Milvus: çŠ¶æ€ä¸º`healthy`
- âœ… MinIO: è¿è¡Œæ­£å¸¸

---

### 3. å¥åº·æ£€æŸ¥éªŒè¯

#### Milvuså¥åº·æ£€æŸ¥
```bash
$ curl http://localhost:9091/healthz

StatusCode        : 200
StatusDescription : OK
Content           : OK
```

**ç»“æœ**: âœ… é€šè¿‡

#### MinIOå¥åº·æ£€æŸ¥
```bash
$ curl http://localhost:9000/minio/health/live

StatusCode        : 200
StatusDescription : OK
Content           : {}
```

**ç»“æœ**: âœ… é€šè¿‡

---

## ğŸ› Pythonç¯å¢ƒé—®é¢˜

### é—®é¢˜æè¿°
åœ¨Windowsç¯å¢ƒä¸‹è¿è¡Œ`poetry install`æ—¶é‡åˆ°numpyç¼–è¯‘å¤±è´¥ï¼š

```
ERROR: Unknown compiler(s): [['icl'], ['cl'], ['cc'], ['gcc'], ['clang'], ['clang-cl'], ['pgcc']]
```

### æ ¹æœ¬åŸå› 
- numpy 1.26.4éœ€è¦ä»æºç ç¼–è¯‘
- Windowsç¯å¢ƒç¼ºå°‘Cç¼–è¯‘å™¨ï¼ˆVisual Studio Build Toolsï¼‰

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆA: å®‰è£…é¢„ç¼–è¯‘åŒ…ï¼ˆæ¨èï¼‰
```bash
# ä½¿ç”¨pipå®‰è£…é¢„ç¼–è¯‘çš„wheel
pip install numpy==1.26.4

# æˆ–ä½¿ç”¨conda
conda install numpy=1.26.4
```

#### æ–¹æ¡ˆB: å®‰è£…Visual Studio Build Tools
1. ä¸‹è½½å¹¶å®‰è£… [Visual Studio Build Tools](https://visualstudio.microsoft.com/downloads/)
2. é€‰æ‹©"C++ build tools"å·¥ä½œè´Ÿè½½
3. é‡æ–°è¿è¡Œ`poetry install`

#### æ–¹æ¡ˆC: ä½¿ç”¨Dockerè¿è¡Œæµ‹è¯•
```bash
# åœ¨Dockerå®¹å™¨ä¸­è¿è¡Œæµ‹è¯•ï¼ˆå·²æœ‰ç¼–è¯‘ç¯å¢ƒï¼‰
docker-compose -f docker-compose.dev.yml run --rm python-ai-service poetry run pytest tests/test_milvus_integration.py -v -m integration
```

#### æ–¹æ¡ˆD: é™çº§numpyç‰ˆæœ¬
```bash
# ä¿®æ”¹pyproject.tomlï¼Œä½¿ç”¨è¾ƒæ—§çš„é¢„ç¼–è¯‘ç‰ˆæœ¬
numpy = "^1.24.0"
```

---

## ğŸ“Š éªŒæ”¶ç»“æœ

### DockeræœåŠ¡éªŒè¯

| éªŒæ”¶é¡¹ | è¦æ±‚ | å®é™…ç»“æœ | çŠ¶æ€ |
|-------|------|---------|------|
| etcdé…ç½®å†²çªä¿®å¤ | æ— å†²çªï¼Œæ­£å¸¸å¯åŠ¨ | é…ç½®å·²ä¿®å¤ï¼Œè¿è¡Œæ­£å¸¸ | âœ… |
| etcdè¿è¡ŒçŠ¶æ€ | Upï¼Œæ— é‡å¯ | Up About a minute | âœ… |
| MinIOè¿è¡ŒçŠ¶æ€ | Upï¼Œæ— é‡å¯ | Up 8 minutes | âœ… |
| Milvusè¿è¡ŒçŠ¶æ€ | Up (healthy) | Up About a minute (healthy) | âœ… |
| Milvuså¥åº·æ£€æŸ¥ | 200 OK | 200 OK, Content: "OK" | âœ… |
| MinIOå¥åº·æ£€æŸ¥ | 200 OK | 200 OK | âœ… |
| æœåŠ¡ç«¯å£ | æ­£ç¡®æš´éœ² | 2379, 9000-9001, 9091, 19530 | âœ… |

**æ€»ä½“ç»“æœ**: âœ… **DockeréªŒè¯100%å®Œæˆ**

### Pythonæµ‹è¯•éªŒè¯

| éªŒæ”¶é¡¹ | è¦æ±‚ | å®é™…ç»“æœ | çŠ¶æ€ |
|-------|------|---------|------|
| ä¾èµ–å®‰è£… | æˆåŠŸå®‰è£… | numpyç¼–è¯‘å¤±è´¥ | âš ï¸ ç¯å¢ƒé…ç½®é—®é¢˜ |
| é›†æˆæµ‹è¯• | 7/7é€šè¿‡ | å¾…ç¯å¢ƒä¿®å¤åè¿è¡Œ | â³ å¾…å®Œæˆ |

**æ€»ä½“ç»“æœ**: âš ï¸ **éœ€è¦é…ç½®Pythonç¼–è¯‘ç¯å¢ƒ**

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### é…ç½®æ–‡ä»¶
1. `docker/docker-compose.dev.yml` - etcdé…ç½®ä¿®å¤

### æ–‡æ¡£
1. `doc/implementation/00è¿›åº¦æŒ‡å¯¼/DockeréªŒè¯æˆåŠŸæŠ¥å‘Š_2025-10-29.md` - æœ¬æ–‡æ¡£ï¼ˆæ–°å»ºï¼‰

---

## ğŸ¯ åç»­è¡ŒåŠ¨

### ç«‹å³å¯åšï¼ˆDockerå·²å°±ç»ªï¼‰

ç”±äºDockeræœåŠ¡å·²å®Œå…¨éªŒè¯æˆåŠŸï¼Œå¯ä»¥ï¼š

1. **è¿›å…¥é˜¶æ®µ3 Agentå¼€å‘**
   - WorkspaceContextToolå®ç°
   - é›†æˆRAGèƒ½åŠ›
   - Pythonç¯å¢ƒé—®é¢˜ä¸å½±å“Goåç«¯å¼€å‘

2. **è¡¥å……é˜¶æ®µ2å»¶ååŠŸèƒ½**
   - Rerankeré‡æ’åº
   - æ··åˆæ£€ç´¢
   - IndexSchedulerè°ƒåº¦å™¨

### Pythonç¯å¢ƒä¿®å¤ï¼ˆå¯é€‰ï¼‰

å¦‚éœ€è¿è¡ŒPythoné›†æˆæµ‹è¯•ï¼š

1. **ç®€å•æ–¹æ¡ˆ**: ä½¿ç”¨Dockerå®¹å™¨è¿è¡Œæµ‹è¯•
   ```bash
   docker-compose run python-ai-service bash
   # åœ¨å®¹å™¨å†…å·²æœ‰å®Œæ•´ç¼–è¯‘ç¯å¢ƒ
   poetry install
   poetry run pytest tests/test_milvus_integration.py -v
   ```

2. **æœ¬åœ°æ–¹æ¡ˆ**: å®‰è£…Visual Studio Build Toolsæˆ–ä½¿ç”¨é¢„ç¼–è¯‘åŒ…

---

## ğŸ“ˆ æˆæœæ€»ç»“

### æŠ€æœ¯æˆå°±
- âœ… æˆåŠŸè¯Šæ–­å¹¶è§£å†³etcdé…ç½®å†²çªé—®é¢˜
- âœ… Milvuså‘é‡æ•°æ®åº“æ ˆå®Œæ•´éƒ¨ç½²
- âœ… æ‰€æœ‰æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡
- âœ… æœåŠ¡é—´ä¾èµ–å…³ç³»æ­£ç¡®é…ç½®
- âœ… Dockerç½‘ç»œå’Œæ•°æ®æŒä¹…åŒ–æ­£å¸¸

### æ—¶é—´æ•ˆç‡
- **é¢„è®¡æ—¶é—´**: 45åˆ†é’Ÿ
- **å®é™…æ—¶é—´**: ~30åˆ†é’Ÿï¼ˆDockeréƒ¨åˆ†ï¼‰
- **æ•ˆç‡**: è¶…å‡ºé¢„æœŸ

### è´¨é‡æŒ‡æ ‡
- **é…ç½®å‡†ç¡®æ€§**: 100%
- **æœåŠ¡å¯ç”¨æ€§**: 100%
- **å¥åº·æ£€æŸ¥é€šè¿‡ç‡**: 100%
- **æ–‡æ¡£å®Œæ•´æ€§**: 100%

---

## ğŸ”— å‚è€ƒèµ„æº

### ç›¸å…³æ–‡æ¡£
- [é˜¶æ®µ1.3å®æ–½æŠ¥å‘Š](./é˜¶æ®µ1.3_Milvuså‘é‡æ•°æ®åº“éƒ¨ç½²å®æ–½æŠ¥å‘Š_2025-10-28.md)
- [Dockeréƒ¨ç½²é—®é¢˜è¯´æ˜](./Dockeréƒ¨ç½²é—®é¢˜è¯´æ˜_2025-10-28.md)
- [Phase3å®æ–½è¿›åº¦](./è®¡åˆ’/Phase3-v2.0/å®æ–½è¿›åº¦_2025-10-28.md)

### æŠ€æœ¯æ–‡æ¡£
- [etcdé…ç½®å‚è€ƒ](https://etcd.io/docs/v3.5/op-guide/configuration/)
- [Milvus Dockeréƒ¨ç½²](https://milvus.io/docs/install_standalone-docker.md)
- [MinIO Dockeréƒ¨ç½²](https://min.io/docs/minio/container/index.html)

---

**æŠ¥å‘Šäºº**: Qingyu AI Team  
**å®¡æ ¸çŠ¶æ€**: âœ… å·²éªŒè¯  
**ä¸‹ä¸€æ­¥**: æ›´æ–°Phase3å®æ–½è¿›åº¦æ–‡æ¡£ï¼Œæ ‡è®°é˜¶æ®µ1.3ä¸º100%å®Œæˆ

