# å…ƒè°ƒåº¦å™¨å®ŒæˆæŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-29  
**çŠ¶æ€**: âœ… å®Œæˆ  
**ç‰ˆæœ¬**: v1.0

---

## å®Œæˆæ‘˜è¦

æˆåŠŸå®ç°äº†**å…ƒè°ƒåº¦å™¨ï¼ˆMetaSchedulerï¼‰**ï¼Œå®Œæˆäº†åæ€å¾ªç¯çš„æœ€åä¸€å—æ‹¼å›¾ï¼å…ƒè°ƒåº¦å™¨æ™ºèƒ½åˆ†æè¯Šæ–­æŠ¥å‘Šï¼Œç”Ÿæˆä¿®æ­£è®¡åˆ’ï¼Œå®ç°äº†Agentç³»ç»Ÿçš„è‡ªæˆ‘ä¿®æ­£èƒ½åŠ›ã€‚

### æ ¸å¿ƒæˆæœ
âœ… å®ç°MetaScheduleræ ¸å¿ƒé€»è¾‘  
âœ… å®ç°CorrectionPromptBuilder  
âœ… æ™ºèƒ½Agentå®šä½ç®—æ³•  
âœ… ä¿®æ­£ç­–ç•¥é€‰æ‹©é€»è¾‘  
âœ… è¿­ä»£æ§åˆ¶å’Œé™çº§æœºåˆ¶  
âœ… 6/6æµ‹è¯•é€šè¿‡ï¼ˆ100%ï¼‰  
âœ… åˆ›å»ºBaseAgentV2ç®€åŒ–åŸºç±»

---

## æ¶æ„è®¾è®¡

### 1. åæ€å¾ªç¯å®Œæ•´æµç¨‹

```
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  ç”¨æˆ·è¾“å…¥ä»»åŠ¡        â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   PlannerAgent               â”‚
              â”‚   - åˆ†æéœ€æ±‚                 â”‚
              â”‚   - ç”Ÿæˆæ‰§è¡Œè®¡åˆ’              â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   SpecializedAgents          â”‚
              â”‚   - OutlineAgent             â”‚
              â”‚   - CharacterAgent           â”‚
              â”‚   - PlotAgent                â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   ReviewAgentV2 âœ…           â”‚
              â”‚   - æ·±åº¦è¯Šæ–­                 â”‚
              â”‚   - æ ¹å› åˆ†æ                 â”‚
              â”‚   - ç”ŸæˆDiagnosticReport     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ è´¨é‡åˆ†æ•° >= 80ï¼Ÿâ”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                     YES â”‚       â”‚ NO
                         â†“       â†“
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  å®Œæˆ   â”‚  â”‚  MetaScheduler âœ…   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  - è§£æè¯Šæ–­æŠ¥å‘Š     â”‚
                                â”‚  - æ™ºèƒ½å®šä½Agent    â”‚
                                â”‚  - ç”Ÿæˆä¿®æ­£Prompt   â”‚
                                â”‚  - å†³å®šä¿®æ­£ç­–ç•¥     â”‚
                                â”‚  - è¿­ä»£æ§åˆ¶         â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â†“
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ è¿­ä»£æ¬¡æ•° < 3ï¼Ÿ  â”‚
                                  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                                  YES â”‚        â”‚ NO
                                      â†“        â†“
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ SpecializedAgentâ”‚  â”‚äººå·¥å®¡æ ¸  â”‚
                        â”‚ (é‡æ–°æ‰§è¡Œ)      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ ReviewAgentV2  â”‚
                        â”‚ (å†æ¬¡å®¡æ ¸)     â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                            (å¾ªç¯ç›´åˆ°é€šè¿‡)
```

### 2. æ ¸å¿ƒç»„ä»¶

```
å…ƒè°ƒåº¦å™¨ç³»ç»Ÿ
â”œâ”€â”€ agents/meta/
â”‚   â”œâ”€â”€ meta_scheduler.py            # MetaSchedulerä¸»é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ execute()               # ä¸»æ‰§è¡Œå‡½æ•°
â”‚   â”‚   â”œâ”€â”€ _determine_affected_agents()    # å®šä½Agent
â”‚   â”‚   â”œâ”€â”€ _determine_correction_mode()    # å†³å®šä¿®æ­£æ¨¡å¼
â”‚   â”‚   â”œâ”€â”€ _determine_restart_agent()      # ç¡®å®šé‡å¯Agent
â”‚   â”‚   â”œâ”€â”€ _clear_affected_outputs()       # æ¸…ç†è¾“å‡º
â”‚   â”‚   â””â”€â”€ _handle_max_iterations_reached() # é™çº§å¤„ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ correction_prompt_builder.py # Promptæ„å»ºå™¨
â”‚   â”‚   â”œâ”€â”€ build_correction_prompt()       # æ„å»ºå•ä¸ªPrompt
â”‚   â”‚   â””â”€â”€ build_batch_correction_prompts() # æ‰¹é‡æ„å»º
â”‚   â”‚
â”‚   â””â”€â”€ __init__.py
â”‚
â”œâ”€â”€ agents/base_agent_v2.py         # ç®€åŒ–çš„AgentåŸºç±»
â”‚
â””â”€â”€ tests/
    â””â”€â”€ test_meta_scheduler.py       # æµ‹è¯•å¥—ä»¶ï¼ˆ6ä¸ªæµ‹è¯•ï¼‰
```

---

## åŠŸèƒ½ç‰¹æ€§

### 1. MetaScheduler - æ™ºèƒ½è°ƒåº¦æ ¸å¿ƒ

**æ ¸å¿ƒèŒè´£**:
1. âœ… è§£æDiagnosticReport
2. âœ… æ™ºèƒ½å®šä½éœ€è¦ä¿®æ­£çš„Agent
3. âœ… ç”Ÿæˆå¢å¼ºçš„ä¿®æ­£Prompt
4. âœ… å†³å®šä¿®æ­£èŒƒå›´ï¼ˆå…¨é‡ vs å¢é‡ï¼‰
5. âœ… ç®¡ç†è¿­ä»£æ¬¡æ•°å’Œè‡ªåŠ¨é™çº§

**æ™ºèƒ½å®šä½ç®—æ³•**:
```python
def _determine_affected_agents(diagnostic_report):
    # 1. ä¼˜å…ˆä½¿ç”¨æŠ¥å‘Šä¸­æ˜ç¡®æŒ‡å®šçš„Agent
    affected_agents = diagnostic_report.affected_agents
    
    # 2. å¦‚æœæ²¡æœ‰ï¼Œä½¿ç”¨å¯å‘å¼è§„åˆ™
    if not affected_agents:
        for issue in diagnostic_report.issues:
            if "character" in issue.sub_category:
                agents.add("character_agent")
            if "outline" in issue.sub_category:
                agents.add("outline_agent")
            if "plot" in issue.sub_category:
                agents.add("plot_agent")
    
    # 3. é»˜è®¤ä½¿ç”¨outline_agent
    return affected_agents or ["outline_agent"]
```

**ä¿®æ­£æ¨¡å¼å†³ç­–**:
```python
def _determine_correction_mode(diagnostic_report, state):
    # 1. å¦‚æœç­–ç•¥æ˜¯REGENERATE â†’ regenerate
    if diagnostic_report.correction_strategy == REGENERATE:
        return "regenerate"
    
    # 2. å¦‚æœæœ‰ä¸¥é‡é—®é¢˜ â†’ regenerate
    if diagnostic_report.has_critical_issues():
        return "regenerate"
    
    # 3. å¦‚æœè´¨é‡åˆ†æ•°å¤ªä½(<60) â†’ regenerate
    if diagnostic_report.quality_score < 60:
        return "regenerate"
    
    # 4. å¦åˆ™ â†’ incremental
    return "incremental"
```

**è¿­ä»£æ§åˆ¶**:
```python
def execute(state):
    iteration_count = state.get("iteration_count", 0)
    max_iterations = state.get("max_iterations", 3)
    
    # è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•° â†’ å‡çº§åˆ°äººå·¥å®¡æ ¸
    if iteration_count >= max_iterations:
        return {
            **state,
            "current_step": "human_review",
            "warnings": ["è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼Œéœ€è¦äººå·¥ä»‹å…¥"]
        }
    
    # æ­£å¸¸å¤„ç†...
    return {
        **state,
        "iteration_count": iteration_count + 1,
        # ...
    }
```

### 2. CorrectionPromptBuilder - Promptå·¥ç¨‹

**Promptç»“æ„**:
```markdown
# ä¿®æ­£ä»»åŠ¡

**ä¿®æ­£æ¨¡å¼**: å¢é‡ä¿®å¤

## è¯Šæ–­æ‘˜è¦
- è´¨é‡åˆ†æ•°: 65/100
- é—®é¢˜æ€»æ•°: 2
- ä¸¥é‡é—®é¢˜: 0
- é«˜ä¼˜å…ˆçº§é—®é¢˜: 1

## ä¿®æ­£æŒ‡ä»¤

### æŒ‡ä»¤ 1: CREATE
**æè¿°**: åˆ›å»ºè§’è‰²'æå››'ï¼Œè®¾å®šä¸ºï¼šé…è§’ï¼Œä¸»è§’çš„æŒšå‹ï¼Œæ€§æ ¼å¼€æœ—ä½†æœ‰äº›å†²åŠ¨ã€‚
**å‚æ•°**:
```json
{
  "name": "æå››",
  "role_type": "supporting",
  "traits": ["å¼€æœ—", "å†²åŠ¨", "å¿ è¯š"]
}
```
**ä¼˜å…ˆçº§**: 8/10
**é—®é¢˜æ ¹å› **: è§’è‰²ç”ŸæˆAgentæœªæ£€æµ‹åˆ°å¤§çº²ä¸­æåŠçš„è§’è‰²
**å½±å“**: å¯¼è‡´æƒ…èŠ‚æ— æ³•å±•å¼€ï¼Œè§’è‰²å…³ç³»ä¸æ˜ç¡®

---

## ä¿®æ­£è¦æ±‚
1. **é’ˆå¯¹æ€§ä¿®æ­£**: åªä¿®æ”¹æœ‰é—®é¢˜çš„éƒ¨åˆ†
2. **ä¿æŒä¸€è‡´æ€§**: ç¡®ä¿ä¸å…¶ä»–éƒ¨åˆ†ä¿æŒä¸€è‡´
3. **è´¨é‡æå‡**: ä¸ä»…è§£å†³é—®é¢˜ï¼Œè¿˜è¦æå‡æ•´ä½“è´¨é‡
4. **éªŒè¯å®Œæ•´æ€§**: ç¡®ä¿ä¿®æ­£åå†…å®¹å®Œæ•´ä¸”é€»è¾‘è‡ªæ´½

## å®¡æ ¸æ¨ç†è¿‡ç¨‹ï¼ˆä¾›å‚è€ƒï¼‰
- æ£€æŸ¥å¤§çº²èŠ‚ç‚¹ï¼šå‘ç°ç¬¬ä¸‰ç« æåŠ'æå››'
- æ£€æŸ¥è§’è‰²åˆ—è¡¨ï¼šæœªæ‰¾åˆ°'æå››'çš„å®šä¹‰
- åˆ†æå½±å“ï¼šæƒ…èŠ‚éœ€è¦è¯¥è§’è‰²ï¼Œå±äºé«˜ä¼˜å…ˆçº§é—®é¢˜
- ç¡®å®šä¿®æ­£ç­–ç•¥ï¼šå¢é‡ä¿®å¤æ¯”å…¨é‡é‡æ–°ç”Ÿæˆæ›´é«˜æ•ˆ

## æ”¹è¿›å»ºè®®
- å»ºè®®åœ¨è§’è‰²ç”Ÿæˆé˜¶æ®µï¼Œæå–å¤§çº²ä¸­æ‰€æœ‰æåŠçš„è§’è‰²åç§°è¿›è¡Œäº¤å‰éªŒè¯
```

**æ‰¹é‡æ„å»º**:
```python
prompts = CorrectionPromptBuilder.build_batch_correction_prompts(
    affected_agents=["character_agent", "outline_agent"],
    diagnostic_report=report,
    original_outputs={"character_agent": {...}},
    correction_mode="incremental"
)
# è¿”å›: {"character_agent": "...", "outline_agent": "..."}
```

### 3. BaseAgentV2 - ç®€åŒ–çš„AgentåŸºç±»

**è®¾è®¡ç†å¿µ**:
- v1çš„BaseAgentå¤ªå¤æ‚ï¼Œæœ‰å¾ˆå¤šæ—§ç‰ˆæœ¬çš„é€»è¾‘
- v2.0çš„Agentéœ€è¦æ›´ç®€å•ã€çµæ´»çš„åŸºç±»
- åªå®šä¹‰å¿…è¦çš„æ¥å£ï¼Œä¸å¼ºåˆ¶å†…éƒ¨å®ç°

**æ ¸å¿ƒæ¥å£**:
```python
class BaseAgentV2(ABC):
    @abstractmethod
    def get_runnable(self) -> Runnable:
        """è·å–LangChain Runnable"""
        pass
    
    @abstractmethod
    async def execute(self, state: PipelineStateV2):
        """æ‰§è¡ŒAgenté€»è¾‘"""
        pass
```

**ä¼˜åŠ¿**:
- âœ… ç®€å•ï¼šåªæœ‰2ä¸ªæŠ½è±¡æ–¹æ³•
- âœ… çµæ´»ï¼šä¸å¼ºåˆ¶ç‰¹å®šçš„å®ç°ç»†èŠ‚
- âœ… é€šç”¨ï¼šé€‚ç”¨äºæ‰€æœ‰v2.0 Agent
- âœ… æ¸…æ™°ï¼šèŒè´£æ˜ç¡®ï¼Œæ˜“äºç†è§£

---

## æµ‹è¯•ç»“æœ

| æµ‹è¯•é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|-------|------|------|
| test_correction_prompt_builder | âœ… PASSED | Promptæ„å»ºå™¨æµ‹è¯• |
| test_batch_correction_prompts | âœ… PASSED | æ‰¹é‡Promptæ„å»ºæµ‹è¯• |
| test_meta_scheduler_initialization | âœ… PASSED | åˆå§‹åŒ–æµ‹è¯• |
| test_meta_scheduler_basic_execution | âœ… PASSED | åŸºæœ¬æ‰§è¡Œæµ‹è¯• |
| test_meta_scheduler_max_iterations | âœ… PASSED | æœ€å¤§è¿­ä»£æ¬¡æ•°æµ‹è¯• |
| test_meta_scheduler_regenerate_mode | âœ… PASSED | å…¨é‡é‡ç”Ÿæˆæ¨¡å¼æµ‹è¯• |

**æ€»è®¡**: 6/6 é€šè¿‡ âœ…  
**æ‰§è¡Œæ—¶é—´**: 4.42ç§’  
**é€šè¿‡ç‡**: 100%

---

## ä½¿ç”¨æŒ‡å—

### 1. åˆ›å»ºMetaScheduler

```python
from agents.meta import MetaScheduler

# åˆ›å»ºå®ä¾‹
scheduler = MetaScheduler(
    max_iterations=3,                # æœ€å¤§è¿­ä»£æ¬¡æ•°
    auto_downgrade_threshold=0.3,    # è‡ªåŠ¨é™çº§é˜ˆå€¼
)
```

### 2. æ‰§è¡Œå…ƒè°ƒåº¦

```python
from agents.states.pipeline_state_v2 import PipelineStateV2

# å‡†å¤‡çŠ¶æ€ï¼ˆåŒ…å«DiagnosticReportï¼‰
state: PipelineStateV2 = {
    "review_report": diagnostic_report.model_dump(),
    "iteration_count": 0,
    "max_iterations": 3,
    # ... å…¶ä»–å­—æ®µ
}

# æ‰§è¡Œå…ƒè°ƒåº¦
result_state = await scheduler.execute(state)

# è·å–ç»“æœ
print(f"è¿­ä»£æ¬¡æ•°: {result_state['iteration_count']}")
print(f"ä¿®æ­£æ¨¡å¼: {result_state['correction_mode']}")
print(f"é‡å¯Agent: {result_state['current_step']}")
print(f"å—å½±å“Agent: {result_state['affected_agents']}")
print(f"ä¿®æ­£Prompt: {result_state['correction_prompts']}")
```

### 3. é›†æˆåˆ°å·¥ä½œæµ

```python
# LangGraphå·¥ä½œæµé›†æˆ
from langgraph.graph import StateGraph, END

workflow = StateGraph(PipelineStateV2)

# æ·»åŠ å®¡æ ¸èŠ‚ç‚¹
workflow.add_node("review", review_agent_node)

# æ·»åŠ å…ƒè°ƒåº¦èŠ‚ç‚¹
workflow.add_node("meta_scheduler", meta_scheduler_node)

# æ·»åŠ æ¡ä»¶è·¯ç”±
def after_review_router(state):
    if state["review_passed"]:
        return "completed"
    else:
        return "meta_scheduler"

workflow.add_conditional_edges(
    "review",
    after_review_router,
    {
        "completed": END,
        "meta_scheduler": "meta_scheduler"
    }
)

# å…ƒè°ƒåº¦åè·¯ç”±åˆ°å…·ä½“Agent
def after_meta_scheduler_router(state):
    if state["current_step"] == "human_review":
        return "human_review"
    else:
        return state["current_step"]  # "character_agent", "outline_agent"ç­‰

workflow.add_conditional_edges(
    "meta_scheduler",
    after_meta_scheduler_router,
    {
        "human_review": "human_review_node",
        "outline_agent": "outline_agent_node",
        "character_agent": "character_agent_node",
        "plot_agent": "plot_agent_node",
    }
)
```

---

## æ ¸å¿ƒä¼˜åŠ¿

### 1. æ™ºèƒ½å®šä½ vs ç›²ç›®é‡è¯•
**ä¹‹å‰**: å…¨éƒ¨é‡æ–°ç”Ÿæˆ  
**ç°åœ¨**: ç²¾å‡†å®šä½é—®é¢˜Agentï¼Œåªä¿®æ­£æœ‰é—®é¢˜çš„éƒ¨åˆ†

### 2. å¢é‡ä¿®å¤ vs å…¨é‡é‡ç”Ÿæˆ
**ä¹‹å‰**: ä»»ä½•é—®é¢˜éƒ½å…¨é‡é‡ç”Ÿæˆ  
**ç°åœ¨**: æ ¹æ®é—®é¢˜ä¸¥é‡ç¨‹åº¦æ™ºèƒ½é€‰æ‹©ï¼š
- è´¨é‡åˆ†æ•°<60æˆ–æœ‰criticalé—®é¢˜ â†’ å…¨é‡é‡ç”Ÿæˆ
- è´¨é‡åˆ†æ•°60-80ï¼Œé—®é¢˜æ˜ç¡® â†’ å¢é‡ä¿®å¤
- è´¨é‡åˆ†æ•°>80 â†’ æ— éœ€ä¿®æ­£

### 3. ç»“æ„åŒ–Prompt vs ç®€å•æç¤º
**ä¹‹å‰**: "è¯·ä¿®æ­£è§’è‰²ä¿¡æ¯"  
**ç°åœ¨**: å®Œæ•´çš„ä¿®æ­£è®¡åˆ’ï¼ŒåŒ…æ‹¬ï¼š
- è¯Šæ–­æ‘˜è¦
- å…·ä½“æŒ‡ä»¤ï¼ˆcreate/update/deleteï¼‰
- ç»“æ„åŒ–å‚æ•°
- é—®é¢˜æ ¹å› 
- å½±å“åˆ†æ
- æ¨ç†è¿‡ç¨‹
- æ”¹è¿›å»ºè®®

### 4. è¿­ä»£æ§åˆ¶ vs æ— é™å¾ªç¯
**ä¹‹å‰**: å¯èƒ½æ— é™é‡è¯•  
**ç°åœ¨**: 
- æœ€å¤§è¿­ä»£æ¬¡æ•°é™åˆ¶ï¼ˆé»˜è®¤3æ¬¡ï¼‰
- è¾¾åˆ°ä¸Šé™è‡ªåŠ¨å‡çº§åˆ°äººå·¥å®¡æ ¸
- é¿å…æ— æ•ˆé‡è¯•

### 5. å¯è¿½æº¯æ€§
- å®Œæ•´çš„reasoning_chain
- æ¯æ¬¡è¿­ä»£çš„å†³ç­–è®°å½•
- ä¿®æ­£Promptå†å²
- ä¾¿äºè°ƒè¯•å’Œä¼˜åŒ–

---

## æŠ€æœ¯äº®ç‚¹

### 1. Agentä¼˜å…ˆçº§æœºåˆ¶
```python
AGENT_PRIORITY = [
    "outline_agent",      # æœ€é«˜ä¼˜å…ˆçº§ï¼ˆåŸºç¡€ï¼‰
    "character_agent",    # æ¬¡é«˜ï¼ˆä¾èµ–å¤§çº²ï¼‰
    "plot_agent",         # ä¸­ç­‰ï¼ˆä¾èµ–è§’è‰²å’Œå¤§çº²ï¼‰
    "worldview_agent",    # ä½ï¼ˆè¾…åŠ©ï¼‰
    "style_agent",        # æœ€ä½ï¼ˆè¡¨é¢ï¼‰
]
```

ä¼˜åŠ¿ï¼šä»åŸºç¡€åˆ°è¡¨é¢ï¼Œç¡®ä¿ä¿®æ­£é¡ºåºåˆç†

### 2. å¯å‘å¼è§„åˆ™
åŸºäºé—®é¢˜ç±»åˆ«è‡ªåŠ¨æ¨æ–­å—å½±å“çš„Agentï¼š
- `character` in sub_category â†’ character_agent
- `outline` in sub_category â†’ outline_agent
- `plot` in sub_category â†’ plot_agent

### 3. çŠ¶æ€æ¸…ç†
å…¨é‡é‡ç”Ÿæˆæ—¶è‡ªåŠ¨æ¸…ç†å—å½±å“Agentçš„è¾“å‡ºï¼š
```python
def _clear_affected_outputs(state, affected_agents):
    for agent_name in affected_agents:
        output_key = f"{agent_name}_output"
        if output_key in state:
            del state[output_key]
```

### 4. é™çº§ç­–ç•¥
- è¿­ä»£æ¬¡æ•°è¶…é™ â†’ äººå·¥å®¡æ ¸
- æ— æ³•ç¡®å®šå—å½±å“Agent â†’ å®Œæˆï¼ˆé¿å…æ­»å¾ªç¯ï¼‰
- æ— å®¡æ ¸æŠ¥å‘Š â†’ å®Œæˆ

### 5. çµæ´»çš„Promptå·¥ç¨‹
- æ”¯æŒä¸¤ç§æ¨¡å¼ï¼ˆregenerate/incrementalï¼‰
- è‡ªåŠ¨åŒ…å«ç›¸å…³è¯Šæ–­ä¿¡æ¯
- ç»“æ„åŒ–å‚æ•°å’Œè‡ªç„¶è¯­è¨€æŒ‡ä»¤ç»“åˆ
- åŒ…å«æ¨ç†è¿‡ç¨‹å’Œæ”¹è¿›å»ºè®®

---

## å®æ–½æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒæ–‡ä»¶
- âœ… `src/agents/meta/meta_scheduler.py` - MetaSchedulerå®ç°
- âœ… `src/agents/meta/correction_prompt_builder.py` - Promptæ„å»ºå™¨
- âœ… `src/agents/meta/__init__.py` - æ¨¡å—å¯¼å‡º

### åŸºç¡€æ¶æ„
- âœ… `src/agents/base_agent_v2.py` - ç®€åŒ–çš„AgentåŸºç±»

### æµ‹è¯•æ–‡ä»¶
- âœ… `tests/test_meta_scheduler.py` - å®Œæ•´æµ‹è¯•å¥—ä»¶ï¼ˆ6ä¸ªæµ‹è¯•ï¼‰

### æ›´æ–°æ–‡ä»¶
- âœ… `src/agents/review/__init__.py` - æ·»åŠ CorrectionInstructionå¯¼å‡º
- âœ… `src/agents/review/review_agent_v2.py` - ä½¿ç”¨BaseAgentV2
- âœ… `src/agents/meta/meta_scheduler.py` - ä½¿ç”¨BaseAgentV2

---

## åæ€å¾ªç¯å®Œæ•´æ€§

ç°åœ¨æ•´ä¸ªåæ€å¾ªç¯å·²ç»å®Œå…¨å®ç°ï¼

```
1. SpecializedAgentç”Ÿæˆå†…å®¹
           â†“
2. ReviewAgentV2æ·±åº¦è¯Šæ–­ âœ…
   - ç”ŸæˆDiagnosticReport
   - é—®é¢˜æ ¹å› åˆ†æ
   - ä¿®æ­£æŒ‡ä»¤ç”Ÿæˆ
           â†“
3. MetaScheduleræ™ºèƒ½è°ƒåº¦ âœ…
   - è§£æè¯Šæ–­æŠ¥å‘Š
   - å®šä½é—®é¢˜Agent
   - ç”Ÿæˆä¿®æ­£Prompt
   - å†³å®šä¿®æ­£ç­–ç•¥
   - è¿­ä»£æ§åˆ¶
           â†“
4. SpecializedAgenté‡æ–°æ‰§è¡Œ
   ï¼ˆä½¿ç”¨ä¿®æ­£Promptï¼‰
           â†“
5. ReviewAgentV2å†æ¬¡å®¡æ ¸
           â†“
ï¼ˆå¾ªç¯ç›´åˆ°è´¨é‡è¾¾æ ‡æˆ–è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼‰
```

---

## åç»­å·¥ä½œ

### å·²å®Œæˆ âœ…
1. WorkspaceContextTool - ä¸Šä¸‹æ–‡æ„ŸçŸ¥
2. BaseAgentæ¡†æ¶å‡çº§ - PipelineStateV2
3. MCPå·¥å…·æ¡†æ¶ - æ ‡å‡†åŒ–å·¥å…·æ¥å£
4. å¢å¼ºå®¡æ ¸Agent - DiagnosticReport
5. **å…ƒè°ƒåº¦å™¨ - æ™ºèƒ½ä¿®æ­£è·¯ç”±** â† å½“å‰

### ä¸‹ä¸€æ­¥ ğŸ“‹
6. **ä¸“ä¸šAgent - OutlineAgentã€CharacterAgentã€PlotAgent** â† å³å°†å¼€å§‹
7. LangGraphå·¥ä½œæµ - åæ€å¾ªç¯è·¯ç”±
8. é›†æˆæµ‹è¯•å’Œä¼˜åŒ–

---

## å‚è€ƒæ–‡æ¡£

**è®¾è®¡æ–‡æ¡£**:
- `doc/design/ai/phase3/05.A2Aåˆ›ä½œæµæ°´çº¿Agentè®¾è®¡_v2.0_æ™ºèƒ½åä½œç”Ÿæ€.md`

**å®æ–½æ–‡æ¡£**:
- `doc/implementation/00è¿›åº¦æŒ‡å¯¼/å¢å¼ºå®¡æ ¸Agentå®ŒæˆæŠ¥å‘Š_2025-10-29.md`
- `doc/implementation/00è¿›åº¦æŒ‡å¯¼/MCPå·¥å…·æ¡†æ¶å®ŒæˆæŠ¥å‘Š_2025-10-29.md`

**ä»£ç ç¤ºä¾‹**:
- `tests/test_meta_scheduler.py` - å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-29  
**æŠ¥å‘Šäºº**: Qingyu AI Team  
**çŠ¶æ€**: âœ… åæ€å¾ªç¯æ ¸å¿ƒç»„ä»¶å…¨éƒ¨å®Œæˆ







