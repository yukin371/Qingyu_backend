# æ¶æ„å†—ä½™å­—æ®µå®¡è®¡æŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-17  
**é—®é¢˜**: Documentæ¨¡å‹ä¸­å­˜åœ¨å†—ä½™å­—æ®µï¼Œè¿åäº†å†…å®¹ä¸å…ƒæ•°æ®åˆ†ç¦»çš„æ¶æ„è®¾è®¡

---

## ä¸€ã€æ¶æ„è®¾è®¡åˆ†æ

### æ­£ç¡®çš„æ¶æ„è®¾è®¡

é¡¹ç›®é‡‡ç”¨äº†**å†…å®¹ä¸å…ƒæ•°æ®åˆ†ç¦»**çš„ä¼˜ç§€æ¶æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Document (å…ƒæ•°æ®)             â”‚
â”‚  - ID, ProjectID, Title             â”‚
â”‚  - Type, Level, Order, Status       â”‚
â”‚  - CharacterIDs, LocationIDs        â”‚
â”‚  - PlotThreads, KeyPoints           â”‚
â”‚  - CreatedAt, UpdatedAt             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 1:1
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    DocumentContent (å†…å®¹)            â”‚
â”‚  - DocumentID                       â”‚
â”‚  - Content (å®é™…æ–‡æœ¬)                â”‚
â”‚  - Version (ä¹è§‚é”ç‰ˆæœ¬å·)            â”‚
â”‚  - WordCount, CharCount             â”‚
â”‚  - GridFSID (å¤§æ–‡ä»¶æ”¯æŒ)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 1:N
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Version (å†å²ç‰ˆæœ¬)            â”‚
â”‚  - DocumentID                       â”‚
â”‚  - VersionNum, Content              â”‚
â”‚  - Comment, CreatedBy               â”‚
â”‚  - IsAutoSave                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶æ„ä¼˜åŠ¿

1. **æ€§èƒ½ä¼˜åŒ–**: åˆ—è¡¨æŸ¥è¯¢ä¸åŠ è½½å†…å®¹ï¼Œå‡å°‘æ•°æ®ä¼ è¾“
2. **å¤§æ–‡ä»¶æ”¯æŒ**: DocumentContent æ”¯æŒ GridFS å­˜å‚¨
3. **å¹¶å‘æ§åˆ¶**: DocumentContent.Version å®ç°ä¹è§‚é”
4. **ç‰ˆæœ¬ç®¡ç†**: Version è¡¨å•ç‹¬å­˜å‚¨å†å²ç‰ˆæœ¬
5. **èŒè´£åˆ†ç¦»**: Document ä¸“æ³¨äºå…ƒæ•°æ®å’Œç»„ç»‡ç»“æ„

---

## äºŒã€å†—ä½™å­—æ®µè¯†åˆ«

### âŒ é”™è¯¯æ·»åŠ çš„å­—æ®µ

åœ¨ `models/document/document.go` ä¸­ï¼š

```go
type Document struct {
    // ... å…¶ä»–æ­£ç¡®å­—æ®µ
    
    // âŒ å†—ä½™å­—æ®µ - åº”è¯¥åœ¨ DocumentContent ä¸­
    Content string `bson:"content,omitempty" json:"content,omitempty"` // ç¬¬20è¡Œ
    Version int    `bson:"version" json:"version"`                     // ç¬¬21è¡Œ
    
    // âœ… è¿™ä¸ªå­—æ®µæ˜¯åˆç†çš„ï¼ˆä»DocumentContentåŒæ­¥çš„ç»Ÿè®¡ä¿¡æ¯ï¼‰
    WordCount int `bson:"word_count" json:"wordCount"` // ç¬¬24è¡Œ
}
```

### ä¸ºä»€ä¹ˆè¿™äº›å­—æ®µæ˜¯å†—ä½™çš„ï¼Ÿ

1. **Content å­—æ®µ**:
   - å·²åœ¨ `DocumentContent.Content` ä¸­å®šä¹‰
   - è¿åäº†å†…å®¹ä¸å…ƒæ•°æ®åˆ†ç¦»åŸåˆ™
   - ä¼šå¯¼è‡´æ•°æ®å†—ä½™å’Œä¸ä¸€è‡´

2. **Version å­—æ®µ**:
   - å·²åœ¨ `DocumentContent.Version` ä¸­å®šä¹‰
   - ç”¨äºä¹è§‚é”æ§åˆ¶
   - åº”è¯¥åªåœ¨å†…å®¹æ›´æ–°æ—¶ä½¿ç”¨

---

## ä¸‰ã€é”™è¯¯ä½¿ç”¨åœºæ™¯å®¡è®¡

### ğŸ”´ å‘ç°çš„é”™è¯¯ä½¿ç”¨ï¼ˆéœ€è¦ä¿®å¤ï¼‰

#### 1. service/ai/context_service.go (2å¤„)

**é”™è¯¯ä»£ç **:
```go
// ç¬¬84è¡Œ
chapterInfo := &ai.ChapterInfo{
    Content: doc.Content,  // âŒ é”™è¯¯ï¼šåº”è¯¥æŸ¥è¯¢ DocumentContent
    // ...
}

// ç¬¬106è¡Œ
func (s *ContextService) generateChapterSummary(doc *document.Document) string {
    content := strings.TrimSpace(doc.Content)  // âŒ é”™è¯¯
    // ...
}
```

**æ­£ç¡®åšæ³•**:
```go
// åº”è¯¥å…ˆæŸ¥è¯¢ DocumentContent
docContent, err := s.documentContentRepo.GetByDocumentID(ctx, doc.ID)
if err != nil {
    return err
}

chapterInfo := &ai.ChapterInfo{
    Content: docContent.Content,  // âœ… æ­£ç¡®
    // ...
}
```

#### 2. service/project/version_service.go (3å¤„)

**é”™è¯¯ä»£ç **:
```go
// ç¬¬84è¡Œ
var f model.Document
if err := fileCol().FindOne(ctx, bson.M{"project_id": projectID, "node_id": nodeID}).Decode(&f); err != nil {
    return nil, err
}

// ç¬¬90è¡Œ
next := f.Version + 1  // âŒ é”™è¯¯ï¼šåº”è¯¥ä» DocumentContent è·å–

// ç¬¬96è¡Œ
snapshot, storageRef, err := s.StoreSnapshot(f.Content, projectID, nodeID, next)  // âŒ é”™è¯¯
```

**æ­£ç¡®åšæ³•**:
```go
// åº”è¯¥æŸ¥è¯¢ DocumentContent
var docContent model.DocumentContent
if err := contentCol().FindOne(ctx, bson.M{"document_id": documentID}).Decode(&docContent); err != nil {
    return nil, err
}

next := docContent.Version + 1  // âœ… æ­£ç¡®
snapshot, storageRef, err := s.StoreSnapshot(docContent.Content, projectID, nodeID, next)  // âœ… æ­£ç¡®
```

#### 3. service/project/document_service.go (1å¤„)

**é”™è¯¯ä»£ç **:
```go
// ç¬¬115-120è¡Œ
updateDoc := bson.M{
    "$set": bson.M{
        "title":      update.Title,
        "content":    update.Content,  // âŒ é”™è¯¯ï¼šåº”è¯¥æ›´æ–° DocumentContent è¡¨
        "updated_at": update.UpdatedAt,
    },
}
```

**æ­£ç¡®åšæ³•**:
```go
// åˆ†åˆ«æ›´æ–° Document å’Œ DocumentContent
// æ›´æ–° Document å…ƒæ•°æ®
updateDoc := bson.M{
    "$set": bson.M{
        "title":      update.Title,
        "updated_at": update.UpdatedAt,
    },
}

// æ›´æ–° DocumentContent å†…å®¹ï¼ˆå¸¦ä¹è§‚é”ï¼‰
if update.Content != "" {
    err := s.documentContentRepo.UpdateWithVersion(ctx, documentID, update.Content, expectedVersion)
    if err != nil {
        return err
    }
}
```

---

## å››ã€æµ‹è¯•ä»£ç å®¡è®¡

### âš ï¸ æµ‹è¯•å·¥å…·ä»£ç ä¹Ÿå—å½±å“

#### test/testutil/helpers.go

```go
// CreateTestDocument åˆ›å»ºæµ‹è¯•æ–‡æ¡£
func CreateTestDocument(projectID string, opts ...DocumentOption) *document.Document {
    doc := &document.Document{
        // ...
        Type:    document.TypeChapter,  // âœ… å·²ä¿®å¤
        Version: 1,                     // âŒ åº”è¯¥ç§»é™¤
    }
    return doc
}
```

#### test/fixtures/factory.go

```go
func (f *DocumentFactory) Create(projectID string, opts ...func(*document.Document)) *document.Document {
    doc := &document.Document{
        // ...
        Type:    document.TypeChapter,  // âœ… å·²ä¿®å¤
        Version: 1,                     // âŒ åº”è¯¥ç§»é™¤
    }
    return doc
}
```

---

## äº”ã€ä¿®å¤è®¡åˆ’

### ç¬¬ä¸€æ­¥ï¼šç§»é™¤å†—ä½™å­—æ®µ âœ… å¾…æ‰§è¡Œ

```go
// models/document/document.go
type Document struct {
    // ... ä¿ç•™çš„å­—æ®µ
    
    // âŒ åˆ é™¤è¿™ä¸¤è¡Œ
    // Content string `bson:"content,omitempty" json:"content,omitempty"`
    // Version int    `bson:"version" json:"version"`
    
    // âœ… ä¿ç•™ç»Ÿè®¡å­—æ®µï¼ˆè¿™æ˜¯åˆç†çš„ï¼Œç”¨äºåˆ—è¡¨å±•ç¤ºï¼‰
    WordCount int `bson:"word_count" json:"wordCount"`
}
```

### ç¬¬äºŒæ­¥ï¼šä¿®å¤ Service å±‚ â³ å¾…æ‰§è¡Œ

1. **ContextService**: æ·»åŠ  DocumentContentRepository ä¾èµ–
2. **VersionService**: æŸ¥è¯¢ DocumentContent è€Œé Document
3. **DocumentService**: åˆ†åˆ«æ›´æ–°å…ƒæ•°æ®å’Œå†…å®¹

### ç¬¬ä¸‰æ­¥ï¼šä¿®å¤æµ‹è¯•ä»£ç  â³ å¾…æ‰§è¡Œ

1. ç§»é™¤æµ‹è¯•å·¥å…·ä¸­çš„ Version å­—æ®µè®¾ç½®
2. æ›´æ–°å·¥å‚å‡½æ•°
3. æ·»åŠ  DocumentContent ç›¸å…³çš„æµ‹è¯•å·¥å…·

### ç¬¬å››æ­¥ï¼šæ·»åŠ ç¼ºå¤±çš„ Repository â³ å¾…æ‰§è¡Œ

éœ€è¦ç¡®ä¿å­˜åœ¨ `DocumentContentRepository` æ¥å£å’Œå®ç°ï¼š
- `GetByDocumentID(ctx, documentID)`
- `UpdateWithVersion(ctx, documentID, content, expectedVersion)`
- `Create(ctx, documentContent)`

---

## å…­ã€å½±å“èŒƒå›´è¯„ä¼°

### ğŸ”´ é«˜å½±å“ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

1. âœ… **ç¼–è¯‘é”™è¯¯**: ç§»é™¤å­—æ®µåï¼Œç›´æ¥è®¿é—® `doc.Content` å’Œ `doc.Version` å°†æŠ¥é”™
2. âš ï¸ **ä¸šåŠ¡é€»è¾‘**: ç‰ˆæœ¬æ§åˆ¶é€»è¾‘å¯èƒ½å¤±æ•ˆ
3. âš ï¸ **æ•°æ®ä¸€è‡´æ€§**: å¦‚æœå·²æœ‰æ•°æ®åœ¨ Document ä¸­å­˜å‚¨äº† content å’Œ version

### âš ï¸ ä¸­ç­‰å½±å“

1. **æµ‹è¯•ä»£ç **: éœ€è¦æ›´æ–°æ‰€æœ‰æµ‹è¯•å·¥å…·å’Œ Mock
2. **APIå“åº”**: å¦‚æœAPIè¿”å›äº† Document å¯¹è±¡ï¼Œå“åº”ç»“æ„ä¼šå˜åŒ–
3. **å‰ç«¯é€‚é…**: å‰ç«¯å¯èƒ½éœ€è¦è°ƒæ•´æ•°æ®è·å–é€»è¾‘

### âœ… ä½å½±å“

1. **æ–°åŠŸèƒ½å¼€å‘**: æ›´æ¸…æ™°çš„æ¶æ„æ›´åˆ©äºæ–°åŠŸèƒ½å¼€å‘
2. **æ€§èƒ½ä¼˜åŒ–**: åˆ†ç¦»åæŸ¥è¯¢æ€§èƒ½æ›´å¥½

---

## ä¸ƒã€æ¨èä¿®å¤é¡ºåº

### ç«‹å³æ‰§è¡Œï¼ˆP0ï¼‰

1. âœ… ç§»é™¤ `Document.Content` å’Œ `Document.Version` å­—æ®µ
2. âœ… ä¿®å¤ `service/ai/context_service.go` çš„ä¸¤å¤„é”™è¯¯
3. âœ… ä¿®å¤ `service/project/version_service.go` çš„ä¸‰å¤„é”™è¯¯
4. âœ… ä¿®å¤ `service/project/document_service.go` çš„ä¸€å¤„é”™è¯¯

### è¿‘æœŸæ‰§è¡Œï¼ˆP1ï¼‰

5. æ›´æ–°æµ‹è¯•å·¥å…·ä»£ç ï¼ˆtestutil, fixturesï¼‰
6. æ·»åŠ /å®Œå–„ DocumentContentRepository
7. æ›´æ–°ç›¸å…³å•å…ƒæµ‹è¯•

### åç»­ä¼˜åŒ–ï¼ˆP2ï¼‰

8. æ•°æ®è¿ç§»è„šæœ¬ï¼ˆå¦‚æœç”Ÿäº§ç¯å¢ƒæœ‰æ•°æ®ï¼‰
9. APIæ–‡æ¡£æ›´æ–°
10. å‰ç«¯é€‚é…ï¼ˆå¦‚éœ€è¦ï¼‰

---

## å…«ã€æ•°æ®è¿ç§»å»ºè®®

å¦‚æœå·²æœ‰æ•°æ®åœ¨ `Document` è¡¨ä¸­å­˜å‚¨äº† `content` å’Œ `version`ï¼Œéœ€è¦æ‰§è¡Œæ•°æ®è¿ç§»ï¼š

```javascript
// MongoDB è¿ç§»è„šæœ¬
db.documents.find({ content: { $exists: true } }).forEach(doc => {
    // åˆ›å»ºæˆ–æ›´æ–° DocumentContent
    db.document_contents.updateOne(
        { document_id: doc._id },
        {
            $setOnInsert: {
                _id: new ObjectId(),
                document_id: doc._id,
                content: doc.content || "",
                version: doc.version || 1,
                content_type: "markdown",
                word_count: doc.word_count || 0,
                created_at: doc.created_at,
                updated_at: doc.updated_at
            }
        },
        { upsert: true }
    );
    
    // åˆ é™¤ Document ä¸­çš„å†—ä½™å­—æ®µ
    db.documents.updateOne(
        { _id: doc._id },
        { $unset: { content: "", version: "" } }
    );
});
```

---

## ä¹ã€æ€»ç»“

### æ ¹æœ¬åŸå› 

åœ¨ä¿®å¤ linter é”™è¯¯æ—¶ï¼Œä¸ºäº†å¿«é€Ÿè§£å†³ "undefined field" é”™è¯¯ï¼Œç›´æ¥åœ¨ `Document` æ¨¡å‹ä¸­æ·»åŠ äº† `Content` å’Œ `Version` å­—æ®µï¼Œ**æ²¡æœ‰å……åˆ†ç†è§£é¡¹ç›®çš„æ¶æ„è®¾è®¡æ„å›¾**ã€‚

### æ•™è®­

1. ğŸ¯ **ç†è§£æ¶æ„ä¼˜å…ˆ**: ä¿®å¤é”™è¯¯å‰åº”å…ˆç†è§£æ•´ä½“æ¶æ„è®¾è®¡
2. ğŸ¯ **è¿½æº¯è®¾è®¡æ–‡æ¡£**: åº”æŸ¥çœ‹ `DocumentContent` æ¨¡å‹çš„å­˜åœ¨ç›®çš„
3. ğŸ¯ **è´¨ç–‘å¿«é€Ÿä¿®å¤**: å¦‚æœä¿®å¤å¤ªç®€å•ï¼Œå¯èƒ½æ˜¯æ–¹å‘é”™äº†
4. ğŸ¯ **ä»£ç å®¡æŸ¥**: é‡å¤§æ¶æ„ä¿®æ”¹éœ€è¦å®¡æŸ¥

### æ­£ç¡®çš„ä¿®å¤æ€è·¯

å½“é‡åˆ° "undefined: doc.Content" é”™è¯¯æ—¶ï¼Œæ­£ç¡®çš„æ€è€ƒé¡ºåºåº”è¯¥æ˜¯ï¼š

1. â“ **ä¸ºä»€ä¹ˆè¿™ä¸ªå­—æ®µä¸å­˜åœ¨ï¼Ÿ** â†’ æŸ¥çœ‹ Document æ¨¡å‹å®šä¹‰
2. â“ **å†…å®¹åº”è¯¥åœ¨å“ªé‡Œï¼Ÿ** â†’ å‘ç° DocumentContent æ¨¡å‹
3. â“ **å¦‚ä½•æ­£ç¡®è·å–å†…å®¹ï¼Ÿ** â†’ æŸ¥è¯¢ DocumentContent è¡¨
4. âœ… **ä¿®å¤æœåŠ¡å±‚é€»è¾‘** â†’ æ·»åŠ  DocumentContent æŸ¥è¯¢

è€Œä¸æ˜¯ï¼š
1. âŒ ç¼ºå°‘å­—æ®µ â†’ ç›´æ¥æ·»åŠ å­—æ®µ â†’ ç¼–è¯‘é€šè¿‡ âœ…

---

## åã€ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. [ ] ç«‹å³ç§»é™¤ `Document.Content` å’Œ `Document.Version` å­—æ®µ
2. [ ] ä¿®å¤æ‰€æœ‰ Service å±‚çš„é”™è¯¯ä½¿ç”¨
3. [ ] æ›´æ–°æµ‹è¯•ä»£ç 
4. [ ] éªŒè¯æ‰€æœ‰æµ‹è¯•é€šè¿‡
5. [ ] æ›´æ–°ç›¸å…³æ–‡æ¡£

**æ‰§è¡Œäºº**: å¼€å‘å›¢é˜Ÿ  
**ä¼˜å…ˆçº§**: P0 (ç´§æ€¥)  
**é¢„è®¡å®Œæˆ**: ä»Šå¤©å†…

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-17  
**å®¡è®¡äºº**: AI æ¶æ„å®¡è®¡ç³»ç»Ÿ
