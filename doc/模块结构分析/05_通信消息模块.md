# 通信消息模块结构分析

## 模块概述

通信消息模块负责平台内的消息传递、通知和公告功能，包括私信对话、系统公告、站内通知等。

## 目录结构

```
通信消息模块/
├── api/v1/
│   ├── messaging/                # 消息API
│   │   ├── conversation_api.go  # 对话管理
│   │   ├── message_api.go       # 消息管理
│   │   └── announcement_api.go  # 公告管理
│   └── announcements/            # 公告API（公开路由）
├── service/messaging/           # 消息服务层
│   ├── conversation_service.go  # 对话服务
│   ├── message_service.go       # 消息服务
│   └── announcement_service.go  # 公告服务
├── repository/interfaces/messaging/ # 仓储接口
├── repository/mongodb/messaging/  # MongoDB仓储实现
├── models/messaging/            # 数据模型
│   ├── conversation.go          # 对话
│   ├── message.go               # 消息
│   └── announcement.go          # 公告
└── realtime/                    # 实时通信
    └── websocket.go             # WebSocket处理
```

## 核心组件

### 1. 对话管理 API (`api/v1/messaging/conversation_api.go`)

```go
type ConversationAPI struct {
    service messaging.ConversationService
}

// 主要接口：
- GetConversations(ctx)       // 获取对话列表
- GetConversation(ctx)         // 获取对话详情
- CreateConversation(ctx)      // 创建对话
- UpdateConversation(ctx)      // 更新对话
- DeleteConversation(ctx)      // 删除对话
- MarkAsRead(ctx)              // 标记为已读
- ArchiveConversation(ctx)     // 归档对话
```

### 2. 消息管理 API (`api/v1/messaging/message_api.go`)

```go
type MessageAPI struct {
    service messaging.MessageService
}

// 主要接口：
- SendMessage(ctx)            // 发送消息
- GetMessages(ctx)             // 获取消息列表
- GetMessage(ctx)              // 获取消息详情
- DeleteMessage(ctx)           // 删除消息
- RecallMessage(ctx)           // 撤回消息
- MarkAsRead(ctx)              // 标记为已读
- GetUnreadCount(ctx)          // 获取未读数
```

### 3. 公告管理 API (`api/v1/messaging/announcement_api.go`)

```go
type AnnouncementAPI struct {
    service messaging.AnnouncementService
}

// 主要接口：
- GetAnnouncements(ctx)       // 获取公告列表
- GetAnnouncement(ctx)         // 获取公告详情
- CreateAnnouncement(ctx)      // 创建公告（管理员）
- UpdateAnnouncement(ctx)      // 更新公告（管理员）
- DeleteAnnouncement(ctx)      // 删除公告（管理员）
- IncrementView(ctx)           // 增加浏览量
```

## 数据模型

### 1. 对话 (`models/messaging/conversation.go`)

```go
type Conversation struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    Type            ConversationType     `bson:"type" json:"type"`
    Participants    []Participant        `bson:"participants" json:"participants"`

    // 对话信息
    Title           string               `bson:"title" json:"title"`
    Avatar          string               `bson:"avatar" json:"avatar"`
    Description     string               `bson:"description,omitempty" json:"description,omitempty"`

    // 消息信息
    LastMessage     *MessageSummary      `bson:"last_message,omitempty" json:"lastMessage,omitempty"`
    UnreadCount     int                  `bson:"unread_count" json:"unreadCount"`
    TotalMessages   int64                `bson:"total_messages" json:"totalMessages"`

    // 状态信息
    Status          ConversationStatus   `bson:"status" json:"status"`
    IsArchived      bool                 `bson:"is_archived" json:"isArchived"`
    IsPinned        bool                 `bson:"is_pinned" json:"isPinned"`
    IsMuted         bool                 `bson:"is_muted" json:"isMuted"`

    // 设置
    Settings        ConversationSettings  `bson:"settings,omitempty" json:"settings,omitempty"`

    // 时间戳
    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`
    UpdatedAt       time.Time            `bson:"updated_at" json:"updatedAt"`
    LastMessageAt   *time.Time           `bson:"last_message_at,omitempty" json:"lastMessageAt,omitempty"`
}

type ConversationType string

const (
    ConversationTypePrivate    ConversationType = "private"    // 私聊
    ConversationTypeGroup      ConversationType = "group"      // 群聊
    ConversationTypeSystem     ConversationType = "system"     // 系统通知
)

type Participant struct {
    UserID          primitive.ObjectID   `bson:"user_id" json:"userId"`
    Nickname        string               `bson:"nickname,omitempty" json:"nickname,omitempty"`
    Role            ParticipantRole      `bson:"role" json:"role"`                  // owner/admin/member
    JoinedAt        time.Time            `bson:"joined_at" json:"joinedAt"`
    LastReadAt      *time.Time           `bson:"last_read_at,omitempty" json:"lastReadAt,omitempty"`
    IsMuted         bool                 `bson:"is_muted" json:"isMuted"`
}

type ParticipantRole string

const (
    RoleOwner    ParticipantRole = "owner"   // 群主
    RoleAdmin    ParticipantRole = "admin"   // 管理员
    RoleMember   ParticipantRole = "member"   // 普通成员
)

type ConversationStatus string

const (
    StatusActive   ConversationStatus = "active"   // 活跃
    StatusArchived ConversationStatus = "archived" // 已归档
    StatusDeleted  ConversationStatus = "deleted"  // 已删除
)

type ConversationSettings struct {
    AllowAddMember     bool                 `bson:"allow_add_member" json:"allowAddMember"`
    AllowRemoveMember  bool                 `bson:"allow_remove_member" json:"allowRemoveMember"`
    OnlyAdminSendMsg   bool                 `bson:"only_admin_send_msg" json:"onlyAdminSendMsg"`
}

type MessageSummary struct {
    ID              primitive.ObjectID   `bson:"id" json:"id"`
    Content         string               `bson:"content" json:"content"`
    SenderID        primitive.ObjectID   `bson:"sender_id" json:"senderId"`
    SenderNickname  string               `bson:"sender_nickname" json:"senderNickname"`
    MessageType    MessageType          `bson:"message_type" json:"messageType"`
    SentAt          time.Time            `bson:"sent_at" json:"sentAt"`
}
```

### 2. 消息 (`models/messaging/message.go`)

```go
type Message struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    ConversationID  primitive.ObjectID   `bson:"conversation_id" json:"conversationId"`
    SenderID        primitive.ObjectID   `bson:"sender_id" json:"senderId"`
    ReplyTo         *primitive.ObjectID  `bson:"reply_to,omitempty" json:"replyTo,omitempty"`

    // 消息内容
    Type            MessageType          `bson:"type" json:"type"`
    Content         string               `bson:"content" json:"content"`
    RichContent     string               `bson:"rich_content,omitempty" json:"richText,omitempty"`

    // 附件
    Attachments     []Attachment         `bson:"attachments,omitempty" json:"attachments,omitempty"`

    // 状态
    Status          MessageStatus        `bson:"status" json:"status"`
    IsRecalled      bool                 `bson:"is_recalled" json:"isRecalled"`

    // 读取状态
    ReadBy          []ReadReceipt        `bson:"read_by,omitempty" json:"readBy,omitempty"`

    // 时间戳
    SentAt          time.Time            `bson:"sent_at" json:"sentAt"`
    UpdatedAt       time.Time            `bson:"updated_at" json:"updatedAt"`
    RecalledAt      *time.Time           `bson:"recalled_at,omitempty" json:"recalledAt,omitempty"`
}

type MessageType string

const (
    MessageTypeText      MessageType = "text"       // 文本消息
    MessageTypeImage     MessageType = "image"      // 图片消息
    MessageTypeAudio     MessageType = "audio"      // 音频消息
    MessageTypeVideo     MessageType = "video"      // 视频消息
    MessageTypeFile      MessageType = "file"       // 文件消息
    MessageTypeSystem    MessageType = "system"     // 系统消息
    MessageTypeNotice    MessageType = "notice"     // 通知消息
)

type MessageStatus string

const (
    MessageStatusSending  MessageStatus = "sending"  // 发送中
    MessageStatusSent     MessageStatus = "sent"     // 已发送
    MessageStatusDelivered MessageStatus = "delivered" // 已送达
    MessageStatusRead     MessageStatus = "read"     // 已读
    MessageStatusRecalled MessageStatus = "recalled" // 已撤回
)

type Attachment struct {
    Type        string  `bson:"type" json:"type"`                // image/audio/video/file
    URL         string  `bson:"url" json:"url"`
    Name        string  `bson:"name" json:"name"`
    Size        int64   `bson:"size" json:"size"`
    Duration    int     `bson:"duration,omitempty" json:"duration,omitempty"` // 音视频时长
    Thumbnail   string  `bson:"thumbnail,omitempty" json:"thumbnail,omitempty"`
}

type ReadReceipt struct {
    UserID      primitive.ObjectID   `bson:"user_id" json:"userId"`
    ReadAt      time.Time            `bson:"read_at" json:"readAt"`
}
```

### 3. 公告 (`models/messaging/announcement.go`)

```go
type Announcement struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    Title           string               `bson:"title" json:"title" validate:"required,max=100"`
    Content         string               `bson:"content" json:"content" validate:"required,max=5000"`
    RichContent     string               `bson:"rich_content,omitempty" json:"richText,omitempty"`

    // 分类
    Category        AnnouncementCategory  `bson:"category" json:"category"`
    Priority        Priority             `bson:"priority" json:"priority"`

    // 显示设置
    IsPinned        bool                 `bson:"is_pinned" json:"isPinned"`
    ShowPopup       bool                 `bson:"show_popup" json:"showPopup"`
    TargetUsers     []primitive.ObjectID `bson:"target_users,omitempty" json:"targetUsers,omitempty"` // 指定用户

    // 状态
    Status          AnnouncementStatus   `bson:"status" json:"status"`

    // 统计
    ViewCount       int64                `bson:"view_count" json:"viewCount"`
    ClickCount      int64                `bson:"click_count" json:"clickCount"`

    // 时间设置
    PublishAt       *time.Time           `bson:"publish_at,omitempty" json:"publishAt,omitempty"`
    ExpireAt        *time.Time           `bson:"expire_at,omitempty" json:"expireAt,omitempty"`

    // 作者信息
    AuthorID        primitive.ObjectID   `bson:"author_id" json:"authorId"`
    AuthorName      string               `bson:"author_name" json:"authorName"`

    // 时间戳
    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`
    UpdatedAt       time.Time            `bson:"updated_at" json:"updatedAt"`
}

type AnnouncementCategory string

const (
    CategorySystem     AnnouncementCategory = "system"     // 系统公告
    CategoryActivity   AnnouncementCategory = "activity"   // 活动公告
    CategoryMaintenance AnnouncementCategory = "maintenance"// 维护公告
    CategoryFeature     AnnouncementCategory = "feature"    // 功能更新
    CategoryUrgent      AnnouncementCategory = "urgent"     // 紧急公告
)

type Priority string

const (
    PriorityLow      Priority = "low"      // 低优先级
    PriorityNormal   Priority = "normal"   // 普通优先级
    PriorityHigh     Priority = "high"     // 高优先级
    PriorityUrgent   Priority = "urgent"   // 紧急
)

type AnnouncementStatus string

const (
    AnnStatusDraft      AnnouncementStatus = "draft"      // 草稿
    AnnStatusScheduled  AnnouncementStatus = "scheduled"  // 定时发布
    AnnStatusPublished  AnnouncementStatus = "published"  // 已发布
    AnnStatusExpired    AnnouncementStatus = "expired"    // 已过期
    AnnStatusArchived   AnnouncementStatus = "archived"   // 已归档
)
```

## 核心功能

### 1. 实时消息

WebSocket 实时通信：
```go
type WebSocketHandler struct {
    hub      *MessageHub
    upgrader websocket.Upgrader
}

// WebSocket 消息类型
type WSMessage struct {
    Type    string      `json:"type"`    // message/typing/presence
    Data    interface{} `json:"data"`
    From    string      `json:"from"`    // 发送者ID
    To      string      `json:"to"`      // 接收者ID
}

// 消息类型
const (
    WSMessageType       = "message"    // 普通消息
    WSTypingIndicator  = "typing"     // 输入指示器
    WSPresence          = "presence"    // 在线状态
    WSReadReceipt       = "read"        // 已读回执
)
```

### 2. 消息推送

推送渠道：
- 站内通知
- 邮件推送
- 短信推送（重要消息）
- 移动端推送（APNs/FCM）

### 3. 消息已读回执

```go
type ReadReceipt struct {
    MessageID       primitive.ObjectID   `bson:"message_id" json:"messageId"`
    ReaderID        primitive.ObjectID   `bson:"reader_id" json:"readerId"`
    ReadAt          time.Time            `bson:"read_at" json:"readAt"`
    DeliveredAt     time.Time            `bson:"delivered_at" json:"deliveredAt"`
}
```

## 数据库集合

### conversations 集合
```javascript
{
  _id: ObjectId,
  type: String,              // private/group/system
  participants: [{
    user_id: ObjectId,
    nickname: String,
    role: String,             // owner/admin/member
    joined_at: ISODate,
    last_read_at: ISODate,
    is_muted: Boolean
  }],
  title: String,
  avatar: String,
  description: String,
  last_message: {
    id: ObjectId,
    content: String,
    sender_id: ObjectId,
    sender_nickname: String,
    message_type: String,
    sent_at: ISODate
  },
  unread_count: Number,
  total_messages: Number,
  status: String,           // active/archived/deleted
  is_archived: Boolean,
  is_pinned: Boolean,
  is_muted: Boolean,
  settings: {
    allow_add_member: Boolean,
    allow_remove_member: Boolean,
    only_admin_send_msg: Boolean
  },
  created_at: ISODate,
  updated_at: ISODate,
  last_message_at: ISODate
}
```

### messages 集合
```javascript
{
  _id: ObjectId,
  conversation_id: ObjectId,
  sender_id: ObjectId,
  reply_to: ObjectId,
  type: String,              // text/image/audio/video/file/system/notice
  content: String,
  rich_content: String,
  attachments: [{
    type: String,            // image/audio/video/file
    url: String,
    name: String,
    size: Number,
    duration: Number,
    thumbnail: String
  }],
  status: String,            // sending/sent/delivered/read/recalled
  is_recalled: Boolean,
  read_by: [{
    user_id: ObjectId,
    read_at: ISODate
  }],
  sent_at: ISODate,
  updated_at: ISODate,
  recalled_at: ISODate
}
```

### announcements 集合
```javascript
{
  _id: ObjectId,
  title: String,
  content: String,
  rich_content: String,
  category: String,          // system/activity/maintenance/feature/urgent
  priority: String,          // low/normal/high/urgent
  is_pinned: Boolean,
  show_popup: Boolean,
  target_users: [ObjectId],
  status: String,            // draft/scheduled/published/expired/archived
  view_count: Number,
  click_count: Number,
  publish_at: ISODate,
  expire_at: ISODate,
  author_id: ObjectId,
  author_name: String,
  created_at: ISODate,
  updated_at: ISODate
}
```

## API端点列表

### 对话相关
| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| GET | /api/v1/messaging/conversations | 获取对话列表 | 是 |
| GET | /api/v1/messaging/conversations/:id | 获取对话详情 | 是 |
| POST | /api/v1/messaging/conversations | 创建对话 | 是 |
| PUT | /api/v1/messaging/conversations/:id | 更新对话 | 是 |
| DELETE | /api/v1/messaging/conversations/:id | 删除对话 | 是 |
| PUT | /api/v1/messaging/conversations/:id/read | 标记为已读 | 是 |
| PUT | /api/v1/messaging/conversations/:id/archive | 归档对话 | 是 |

### 消息相关
| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| POST | /api/v1/messaging/messages | 发送消息 | 是 |
| GET | /api/v1/messaging/messages | 获取消息列表 | 是 |
| GET | /api/v1/messaging/messages/:id | 获取消息详情 | 是 |
| DELETE | /api/v1/messaging/messages/:id | 删除消息 | 是 |
| POST | /api/v1/messaging/messages/:id/recall | 撤回消息 | 是 |
| GET | /api/v1/messaging/unread-count | 获取未读数 | 是 |

### 公告相关
| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| GET | /api/v1/announcements/effective | 获取有效公告 | 否 |
| GET | /api/v1/announcements/:id | 获取公告详情 | 否 |
| POST | /api/v1/announcements/:id/view | 增加浏览量 | 否 |
| POST | /api/v1/admin/announcements | 创建公告 | 管理员 |
| GET | /api/v1/admin/announcements | 获取公告列表 | 管理员 |
| GET | /api/v1/admin/announcements/:id | 获取公告详情 | 管理员 |
| PUT | /api/v1/admin/announcements/:id | 更新公告 | 管理员 |
| DELETE | /api/v1/admin/announcements/:id | 删除公告 | 管理员 |
| PUT | /api/v1/admin/announcements/batch-status | 批量更新状态 | 管理员 |
| DELETE | /api/v1/admin/announcements/batch-delete | 批量删除 | 管理员 |

## 实时通信

### WebSocket 连接

```go
// WebSocket 端点
GET /ws/messages?token={jwt_token}

// 消息格式
{
  "type": "message",
  "data": {
    "id": "msg_id",
    "conversation_id": "conv_id",
    "content": "消息内容",
    "sender_id": "user_id",
    "sent_at": "2024-01-01T00:00:00Z"
  }
}

// 输入指示器
{
  "type": "typing",
  "data": {
    "conversation_id": "conv_id",
    "user_id": "user_id",
    "is_typing": true
  }
}

// 在线状态
{
  "type": "presence",
  "data": {
    "user_id": "user_id",
    "status": "online",    // online/offline/away/busy
    "last_seen": "2024-01-01T00:00:00Z"
  }
}
```

## 性能优化

1. **消息分页加载**
   - 每次加载20条消息
   - 滚动加载更多

2. **未读消息缓存**
   - Redis 缓存未读数
   - 实时更新

3. **WebSocket 连接管理**
   - 心跳检测
   - 自动重连
   - 连接池管理

## 安全考虑

1. **消息内容安全**
   - 敏感词过滤
   - 垃圾信息检测
   - 消息审核

2. **权限控制**
   - 对话访问权限
   - 消息发送权限
   - 管理员权限

3. **频率限制**
   - 消息发送频率限制
   - 防止消息轰炸
