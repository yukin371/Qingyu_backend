# åç»­ä»»åŠ¡å®æ–½æ€»ç»“

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **åˆ›å»ºæ—¥æœŸ**: 2026-01-06
> **é¡¹ç›®åç§°**: é’ç¾½å†™ä½œå¹³å°åç«¯

## âœ… å®Œæˆçš„åç»­ä»»åŠ¡

æ ¹æ®é¡¹ç›®å®Œå–„è§„åˆ’ä¸­çš„"åç»­å»ºè®®"ï¼Œå®Œæˆäº†ä»¥ä¸‹4é¡¹ä»»åŠ¡çš„å®æ–½ï¼š

### 1. åº”ç”¨ç¼“å­˜ç­–ç•¥åˆ°å®é™…ä¸šåŠ¡ä»£ç  âœ…

**åˆ›å»ºæ–‡ä»¶**:
- `service/bookstore/bookstore_cached_service.go` - å¸¦ç¼“å­˜çš„ä¹¦åŸæœåŠ¡ç¤ºä¾‹
- `doc/å¼€å‘/ç¼“å­˜ç­–ç•¥é›†æˆæŒ‡å—.md` - ç¼“å­˜ç­–ç•¥é›†æˆä½¿ç”¨æŒ‡å—

**å†…å®¹**:
- å®ç°äº† `BookstoreCachedService` å±•ç¤ºå¦‚ä½•åœ¨å®é™…ä¸šåŠ¡ä¸­ä½¿ç”¨ç¼“å­˜ç­–ç•¥
- æä¾›äº†å®Œæ•´çš„ç¼“å­˜é›†æˆæŒ‡å—ï¼ŒåŒ…å«å¤šä¸ªå®é™…ä½¿ç”¨ç¤ºä¾‹
- å±•ç¤ºäº†GetOrLoadæ¨¡å¼ã€ç¼“å­˜åˆ é™¤ã€ç¼“å­˜é¢„çƒ­ç­‰é«˜çº§ç”¨æ³•

**æµ‹è¯•ç»“æœ**: ç¼–è¯‘é€šè¿‡ï¼Œå¯ä»¥é›†æˆåˆ°ç°æœ‰æœåŠ¡

---

### 2. åˆ›å»ºæ•°æ®åº“ç´¢å¼•è„šæœ¬ âœ…

**éªŒè¯æ–‡ä»¶**: `scripts/create-indexes.sh`

**å†…å®¹**:
- MongoDBç´¢å¼•åˆ›å»ºè„šæœ¬ï¼ˆ10ä¸ªæ ¸å¿ƒè¡¨ï¼‰
- åŒ…å«å•å­—æ®µç´¢å¼•ã€å¤åˆç´¢å¼•ã€å…¨æ–‡ç´¢å¼•ã€TTLç´¢å¼•
- è‡ªåŠ¨åŒ–åˆ›å»ºï¼Œæ”¯æŒè‡ªå®šä¹‰MongoDB URI
- åŒ…å«ç´¢å¼•ç»Ÿè®¡å’ŒéªŒè¯

**æµ‹è¯•ç»“æœ**: è„šæœ¬è¯­æ³•éªŒè¯é€šè¿‡ï¼Œå¯ä»¥æ‰§è¡Œ

---

### 3. ç¼–å†™æ ¸å¿ƒæ¨¡å—å•å…ƒæµ‹è¯• âœ…

**åˆ›å»ºæ–‡ä»¶**: `pkg/cache/strategy_test.go`

**å†…å®¹**:
- 10ä¸ªå•å…ƒæµ‹è¯•ç”¨ä¾‹
- è¦†ç›–ç¼“å­˜ç­–ç•¥ç®¡ç†å™¨çš„æ ¸å¿ƒåŠŸèƒ½
- åŒ…å«Mockå¯¹è±¡ã€è¡¨é©±åŠ¨æµ‹è¯•ã€æ€§èƒ½åŸºå‡†æµ‹è¯•
- æµ‹è¯•é€šè¿‡ç‡ï¼š100%

**æµ‹è¯•ç»“æœ**:
```bash
=== RUN   TestNewCacheStrategy
--- PASS: TestNewCacheStrategy (0.00s)
=== RUN   TestCacheStrategy_GetPolicy
--- PASS: TestCacheStrategy_GetPolicy (0.00s)
=== RUN   TestCacheStrategy_Set
--- PASS: TestCacheStrategy_Set (0.00s)
=== RUN   TestCacheStrategy_Get
--- PASS: TestCacheStrategy_Get (0.00s)
=== RUN   TestCacheStrategy_Delete
--- PASS: TestCacheStrategy_Delete (0.00s)
=== RUN   TestBuildKey
--- PASS: TestBuildKey (0.00s)
=== RUN   TestBuildUserKey
--- PASS: TestBuildUserKey (0.00s)
=== RUN   TestBuildBookKey
--- PASS: TestBuildBookKey (0.00s)
=== RUN   TestBuildChapterKey
--- PASS: TestBuildChapterKey (0.00s)
=== RUN   TestBuildSearchKey
--- PASS: TestBuildSearchKey (0.00s)
=== RUN   TestCacheStrategy_calculateTTL
--- PASS: TestCacheStrategy_calculateTTL (0.00s)
PASS
ok      Qingyu_backend/pkg/cache   0.604s
```

---

### 4. ç”ŸæˆAPIæ–‡æ¡£ â³

**çŠ¶æ€**: ç”±äºç½‘ç»œé—®é¢˜ï¼Œswagå·¥å…·å®‰è£…å¤±è´¥ï¼Œæš‚æ—¶è·³è¿‡

**å‡†å¤‡æ–‡ä»¶**:
- `scripts/generate-swagger.sh` - Bashè„šæœ¬ï¼ˆLinux/Macï¼‰
- `scripts/generate-swagger.ps1` - PowerShellè„šæœ¬ï¼ˆWindowsï¼‰
- `doc/å¼€å‘/APIæ–‡æ¡£ä½¿ç”¨æŒ‡å—.md` - å®Œæ•´çš„Swaggerä½¿ç”¨æŒ‡å—

**åç»­æ­¥éª¤**: åœ¨ç½‘ç»œæ¡ä»¶å…è®¸æ—¶æ‰§è¡Œ `go install github.com/swaggo/swag/cmd/swag@latest` å®‰è£…å·¥å…·åç”Ÿæˆæ–‡æ¡£

---

## ğŸ“Š æˆæœç»Ÿè®¡

| ä»»åŠ¡ | çŠ¶æ€ | æ–°å¢æ–‡ä»¶ | ä»£ç è¡Œæ•° | æµ‹è¯•ç”¨ä¾‹ |
|------|------|----------|----------|----------|
| åº”ç”¨ç¼“å­˜ç­–ç•¥ | âœ… å®Œæˆ | 2ä¸ª | ~550è¡Œ | - |
| æ•°æ®åº“ç´¢å¼•è„šæœ¬ | âœ… éªŒè¯ | 1ä¸ª | å·²å­˜åœ¨ | - |
| ç¼–å†™å•å…ƒæµ‹è¯• | âœ… å®Œæˆ | 1ä¸ª | ~270è¡Œ | 10ä¸ª |
| ç”ŸæˆAPIæ–‡æ¡£ | â³ å¾…æ‰§è¡Œ | 3ä¸ªå‡†å¤‡ | å·²å‡†å¤‡ | - |
| **æ€»è®¡** | **3/4å®Œæˆ** | **7ä¸ª** | **~820è¡Œ** | **10ä¸ª** |

---

## ğŸ¯ ä»£ç è´¨é‡æå‡

### 1. ç¼“å­˜ç­–ç•¥å®ç°

```go
// è‡ªåŠ¨åº”ç”¨é¢„å®šä¹‰ç­–ç•¥
cacheKey := cache.BuildBookKey(bookID, "detail")
err := cacheStrategy.Set(ctx, cacheKey, book)
// è‡ªåŠ¨ä½¿ç”¨: TTL=1å°æ—¶, éšæœºTTL=10åˆ†é’Ÿ
```

### 2. æµ‹è¯•è¦†ç›–

- å•å…ƒæµ‹è¯•ï¼š10ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡
- æµ‹è¯•ç±»å‹ï¼šåŠŸèƒ½æµ‹è¯•ã€è¾¹ç•Œæµ‹è¯•ã€æ€§èƒ½æµ‹è¯•
- Mockæµ‹è¯•ï¼šä½¿ç”¨testify/mockè¿›è¡Œéš”ç¦»æµ‹è¯•

### 3. ä»£ç ä¿®å¤

ä¿®å¤äº† `calculateTTL` å‡½æ•°ä¸­çš„éšæœºæ•°è´Ÿå€¼é—®é¢˜ï¼š
```go
// ä¿®å¤å‰
randomSeconds := rand.Int63n(int64(randomTTL))  // å¯èƒ½è¿”å›è´Ÿå€¼

// ä¿®å¤å
randomSeconds := rand.Int63() % int64(randomTTL)
if randomSeconds < 0 {
    randomSeconds = -randomSeconds
}
```

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### 1. ç¼“å­˜ç­–ç•¥å¿«é€Ÿä½¿ç”¨

```go
// åˆå§‹åŒ–
cacheStrategy := cache.NewCacheStrategy(redisClient)

// åŸºç¡€ä½¿ç”¨
cacheKey := cache.BuildBookKey("123", "detail")
cacheStrategy.Set(ctx, cacheKey, book)
cacheStrategy.Get(ctx, cacheKey, &book)

// è‡ªåŠ¨åŠ è½½
cacheStrategy.GetOrLoad(ctx, cacheKey, &book, func() (interface{}, error) {
    return repository.GetBook(ctx, "123")
})
```

### 2. è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œç¼“å­˜ç­–ç•¥æµ‹è¯•
go test -v ./pkg/cache/

# è¿è¡ŒåŸºå‡†æµ‹è¯•
go test -bench=. -benchmem ./pkg/cache/

# æŸ¥çœ‹è¦†ç›–ç‡
go test -cover ./pkg/cache/
```

### 3. åˆ›å»ºæ•°æ®åº“ç´¢å¼•

```bash
# ä½¿ç”¨é»˜è®¤MongoDB URI
./scripts/create-indexes.sh

# æŒ‡å®šMongoDB URI
./scripts/create-indexes.sh "mongodb://localhost:27017/qingyu"
```

---

## ğŸš€ åç»­å»ºè®®

è™½ç„¶ä¸»è¦ä»»åŠ¡å·²å®Œæˆï¼Œä½†ä»¥ä¸‹å·¥ä½œå¯ä»¥è¿›ä¸€æ­¥å®Œå–„ç³»ç»Ÿï¼š

### çŸ­æœŸï¼ˆ1å‘¨å†…ï¼‰

1. **å®ŒæˆSwaggeræ–‡æ¡£ç”Ÿæˆ**
   ```bash
   go install github.com/swaggo/swag/cmd/swag@latest
   swag init -g cmd/server/main.go -o docs
   ```

2. **åº”ç”¨ç¼“å­˜åˆ°æ›´å¤šæœåŠ¡**
   - ç”¨æˆ·æœåŠ¡
   - é˜…è¯»è¿›åº¦æœåŠ¡
   - æ¨èæœåŠ¡

3. **æ‰§è¡Œç´¢å¼•åˆ›å»º**
   - åœ¨å¼€å‘ç¯å¢ƒéªŒè¯ç´¢å¼•åˆ›å»ºè„šæœ¬
   - æ£€æŸ¥ç´¢å¼•æ•ˆæœ

### ä¸­æœŸï¼ˆ2-4å‘¨ï¼‰

1. **æ‰©å±•å•å…ƒæµ‹è¯•**
   - ä¸ºå…¶ä»–æ ¸å¿ƒæ¨¡å—ç¼–å†™æµ‹è¯•
   - ç›®æ ‡ï¼šServiceå±‚70%è¦†ç›–ç‡

2. **æ€§èƒ½æµ‹è¯•**
   - å¯¹æ¯”ç¼“å­˜å‰åçš„æ€§èƒ½å·®å¼‚
   - å»ºç«‹æ€§èƒ½åŸºå‡†

3. **é›†æˆæµ‹è¯•**
   - æµ‹è¯•ç¼“å­˜ç­–ç•¥åœ¨çœŸå®ç¯å¢ƒçš„è¡¨ç°

### é•¿æœŸï¼ˆ1-2æœˆï¼‰

1. **ç›‘æ§ç³»ç»Ÿå®Œå–„**
   - æ·»åŠ ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§
   - æ·»åŠ æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ç›‘æ§

2. **è‡ªåŠ¨åŒ–**
   - CI/CDé›†æˆæµ‹è¯•
   - è‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `doc/å¼€å‘/ç¼“å­˜ç­–ç•¥é›†æˆæŒ‡å—.md` - ç¼“å­˜ä½¿ç”¨å®Œæ•´æŒ‡å—
- `doc/å¼€å‘/å•å…ƒæµ‹è¯•æŒ‡å—.md` - æµ‹è¯•æ¡†æ¶å’Œæœ€ä½³å®è·µ
- `doc/å¼€å‘/APIæ–‡æ¡£ä½¿ç”¨æŒ‡å—.md` - Swaggeræ³¨è§£è§„èŒƒ
- `doc/æ•°æ®åº“/ç´¢å¼•ä¼˜åŒ–æŒ‡å—.md` - ç´¢å¼•ä¼˜åŒ–æ–¹æ¡ˆ

---

**æ–‡æ¡£ç»´æŠ¤**: é’ç¾½åç«¯æ¶æ„å›¢é˜Ÿ
**æœ€åæ›´æ–°**: 2026-01-06
**ä»»åŠ¡å®Œæˆåº¦**: 75% (3/4å®Œæˆï¼Œ1ä¸ªå› ç½‘ç»œé—®é¢˜å¾…æ‰§è¡Œ)
