# 阅读器模块结构分析

## 模块概述

阅读器模块负责为读者提供完整的阅读体验，包括阅读进度管理、书架管理、笔记标注、阅读设置等功能。该模块与书店模块和写作模块紧密集成。

## 目录结构

```
阅读器模块/
├── api/v1/reader/                    # 阅读器API
│   ├── books_api.go                # 书架管理
│   ├── progress_api.go             # 阅读进度
│   ├── annotations_api.go          # 笔记标注
│   ├── settings_api.go             # 阅读设置
│   └── history_api.go              # 阅读历史
├── service/reader/                  # 阅读器服务层
│   ├── bookshelf_service.go        # 书架服务
│   ├── progress_service.go         # 进度服务
│   ├── annotation_service.go       # 标注服务
│   └── settings_service.go         # 设置服务
├── repository/interfaces/reader/    # 仓储接口
├── repository/mongodb/reader/       # MongoDB仓储实现
│   ├── bookshelf_repository_mongo.go
│   ├── progress_repository_mongo.go
│   └── annotation_repository_mongo.go
└── models/reader/                   # 数据模型
    ├── bookshelf.go                # 书架
    ├── progress.go                 # 阅读进度
    ├── annotation.go               # 标注
    ├── bookmark.go                 # 书签
    └── settings.go                 # 阅读设置
```

## 核心组件

### 1. 书架管理 API (`api/v1/reader/books_api.go`)

```go
type BooksAPI struct {
    service reader.BookshelfService
}

// 主要接口：
- GetBookshelf(ctx)             // 获取书架
- GetRecentReading(ctx)         // 获取最近阅读
- GetUnfinishedBooks(ctx)       // 获取未完结书籍
- GetFinishedBooks(ctx)         // 获取已完结书籍
- AddToBookshelf(ctx)           // 添加到书架
- RemoveFromBookshelf(ctx)      // 从书架移除
```

### 2. 阅读进度 API (`api/v1/reader/progress_api.go`)

```go
type ProgressAPI struct {
    service reader.ProgressService
}

// 主要接口：
- GetReadingProgress(ctx)       // 获取阅读进度
- SaveReadingProgress(ctx)      // 保存阅读进度
- UpdateReadingTime(ctx)        // 更新阅读时长
- GetRecentReading(ctx)         // 获取最近阅读记录
- GetReadingHistory(ctx)        // 获取阅读历史
- GetReadingStats(ctx)          // 获取阅读统计
- GetUnfinishedBooks(ctx)       // 获取未读完的书籍
- GetFinishedBooks(ctx)         // 获取已读完的书籍
```

### 3. 笔记标注 API (`api/v1/reader/annotations_api.go`)

```go
type AnnotationsAPI struct {
    service reader.AnnotationService
}

// 主要接口：
- CreateAnnotation(ctx)         // 创建标注
- UpdateAnnotation(ctx)         // 更新标注
- DeleteAnnotation(ctx)         // 删除标注
- BatchCreateAnnotations(ctx)   // 批量创建
- BatchUpdateAnnotations(ctx)   // 批量更新
- BatchDeleteAnnotations(ctx)   // 批量删除
- GetNotes(ctx)                 // 获取笔记
- GetBookmarks(ctx)             // 获取书签
- GetHighlights(ctx)            // 获取高亮
- GetAnnotationsByBook(ctx)     // 获取书籍标注
- GetAnnotationsByChapter(ctx)  // 获取章节标注
- GetRecentAnnotations(ctx)     // 获取最近标注
- SyncAnnotations(ctx)          // 同步标注
```

### 4. 阅读设置 API (`api/v1/reader/settings_api.go`)

```go
type SettingAPI struct {
    service reader.SettingService
}

// 主要接口：
- GetReadingSettings(ctx)      // 获取阅读设置
- SaveReadingSettings(ctx)     // 保存阅读设置
- UpdateReadingSettings(ctx)   // 更新阅读设置
```

## 数据模型

### 1. 书架条目 (`models/reader/bookshelf.go`)

```go
type BookshelfEntry struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    UserID          primitive.ObjectID   `bson:"user_id" json:"userId"`
    BookID          primitive.ObjectID   `bson:"book_id" json:"bookId"`
    ChapterID       *primitive.ObjectID  `bson:"chapter_id,omitempty" json:"chapterId,omitempty"`

    // 阅读状态
    ReadingStatus   ReadingStatus       `bson:"reading_status" json:"readingStatus"`
    Progress        float64              `bson:"progress" json:"progress"`           // 阅读进度 0-100
    LastChapter     int                  `bson:"last_chapter" json:"lastChapter"`
    LastPosition    int                  `bson:"last_position" json:"lastPosition"` // 字符位置

    // 个人标记
    IsFavorite      bool                 `bson:"is_favorite" json:"isFavorite"`
    Rating          int                  `bson:"rating" json:"rating"`             // 0-5星
    Tags            []string             `bson:"tags" json:"tags"`
    Notes           string               `bson:"notes" json:"notes"`

    // 统计信息
    TotalReadTime   int64                `bson:"total_read_time" json:"totalReadTime"` // 总阅读时长（秒）
    ReadCount       int                  `bson:"read_count" json:"readCount"`

    // 时间戳
    AddedAt         time.Time            `bson:"added_at" json:"addedAt"`
    LastReadAt      *time.Time           `bson:"last_read_at,omitempty" json:"lastReadAt,omitempty"`
    FinishedAt      *time.Time           `bson:"finished_at,omitempty" json:"finishedAt,omitempty"`
}

type ReadingStatus string

const (
    ReadingStatusNotStarted   ReadingStatus = "not_started"   // 未开始
    ReadingStatusReading      ReadingStatus = "reading"       // 阅读中
    ReadingStatusPaused       ReadingStatus = "paused"        // 暂停
    ReadingStatusCompleted    ReadingStatus = "completed"     // 已完成
    ReadingStatusAbandoned    ReadingStatus = "abandoned"     // 放弃
)
```

### 2. 阅读进度 (`models/reader/progress.go`)

```go
type ReadingProgress struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    UserID          primitive.ObjectID   `bson:"user_id" json:"userId"`
    BookID          primitive.ObjectID   `bson:"book_id" json:"bookId"`
    ChapterID       primitive.ObjectID   `bson:"chapter_id" json:"chapterId"`

    // 进度信息
    ChapterPosition  int                  `bson:"chapter_position" json:"chapterPosition"` // 章节内位置（字符）
    ChapterProgress float64              `bson:"chapter_progress" json:"chapterProgress"` // 章节进度 0-100
    BookProgress    float64              `bson:"book_progress" json:"bookProgress"`       // 全书进度 0-100

    // 阅读统计
    ReadTime        int64                `bson:"read_time" json:"readTime"`             // 本次阅读时长（秒）
    TotalReadTime   int64                `bson:"total_read_time" json:"totalReadTime"` // 累计阅读时长

    // 时间戳
    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`
    UpdatedAt       time.Time            `bson:"updated_at" json:"updatedAt"`
}

type ReadingHistory struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    UserID          primitive.ObjectID   `bson:"user_id" json:"userId"`
    BookID          primitive.ObjectID   `bson:"book_id" json:"bookId"`
    ChapterID       primitive.ObjectID   `bson:"chapter_id" json:"chapterId"`

    // 阅读会话
    SessionStart    time.Time            `bson:"session_start" json:"sessionStart"`
    SessionEnd      *time.Time           `bson:"session_end,omitempty" json:"sessionEnd,omitempty"`
    Duration        int64                `bson:"duration" json:"duration"`         // 阅读时长（秒）
    WordsRead       int64                `bson:"words_read" json:"wordsRead"`

    // 设备信息
    DeviceType      string               `bson:"device_type" json:"deviceType"`     // mobile/web/desktop
    DeviceID        string               `bson:"device_id" json:"deviceId"`

    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`
}
```

### 3. 标注 (`models/reader/annotation.go`)

```go
type Annotation struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    UserID          primitive.ObjectID   `bson:"user_id" json:"userId"`
    BookID          primitive.ObjectID   `bson:"book_id" json:"bookId"`
    ChapterID       primitive.ObjectID   `bson:"chapter_id" json:"chapterId"`

    // 标注内容
    Type            AnnotationType       `bson:"type" json:"type"`                   // highlight/note/bookmark
    Content         string               `bson:"content" json:"content"`             // 标注文本
    Note            string               `bson:"note" json:"note"`                   // 笔记内容
    Color           string               `bson:"color" json:"color"`                 // 高亮颜色

    // 位置信息
    StartPosition   int                  `bson:"start_position" json:"startPosition"`
    EndPosition     int                  `bson:"end_position" json:"endPosition"`
    StartOffset     int                  `bson:"start_offset" json:"startOffset"`   // 段落偏移
    EndOffset       int                  `bson:"end_offset" json:"endOffset"`
    ChapterNumber   int                  `bson:"chapter_number" json:"chapterNumber"`

    // 元数据
    Tags            []string             `bson:"tags" json:"tags"`
    IsPublic        bool                 `bson:"is_public" json:"isPublic"`
    IsShared        bool                 `bson:"is_shared" json:"isShared"`

    // 时间戳
    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`
    UpdatedAt       time.Time            `bson:"updated_at" json:"updatedAt"`
}

type AnnotationType string

const (
    AnnotationTypeHighlight  AnnotationType = "highlight"  // 高亮
    AnnotationTypeNote       AnnotationType = "note"       // 笔记
    AnnotationTypeBookmark   AnnotationType = "bookmark"   // 书签
)
```

### 4. 书签 (`models/reader/bookmark.go`)

```go
type Bookmark struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    UserID          primitive.ObjectID   `bson:"user_id" json:"userId"`
    BookID          primitive.ObjectID   `bson:"book_id" json:"bookId"`
    ChapterID       primitive.ObjectID   `bson:"chapter_id" json:"chapterId"`

    // 书签位置
    ChapterTitle     string               `bson:"chapter_title" json:"chapterTitle"`
    Position        int                  `bson:"position" json:"position"`           // 字符位置
    Progress        float64              `bson:"progress" json:"progress"`           // 阅读进度

    // 书签信息
    Title           string               `bson:"title" json:"title"`                 // 书签标题
    Note            string               `bson:"note" json:"note"`                   // 书签备注
    Color           string               `bson:"color" json:"color"`                 // 书签颜色

    CreatedAt       time.Time            `bson:"created_at" json:"createdAt"`
}
```

### 5. 阅读设置 (`models/reader/settings.go`)

```go
type ReaderSettings struct {
    ID              primitive.ObjectID   `bson:"_id,omitempty" json:"id"`
    UserID          primitive.ObjectID   `bson:"user_id" json:"userId"`

    // 显示设置
    FontSize        int                  `bson:"font_size" json:"fontSize"`           // 字号 12-32
    FontFamily      string               `bson:"font_family" json:"fontFamily"`       // 字体
    LineHeight      float64              `bson:"line_height" json:"lineHeight"`       // 行高 1.0-2.5
    ParagraphSpacing int                 `bson:"paragraph_spacing" json:"paragraphSpacing"` // 段间距

    // 主题设置
    Theme           ReaderTheme          `bson:"theme" json:"theme"`
    BackgroundColor string               `bson:"background_color" json:"backgroundColor"`
    TextColor       string               `bson:"text_color" json:"textColor"`

    // 阅读模式
    Mode            ReaderMode           `bson:"mode" json:"mode"`                   // day/night/eye-care
    AutoScroll      bool                 `bson:"auto_scroll" json:"autoScroll"`       // 自动滚动
    ScrollSpeed     int                  `bson:"scroll_speed" json:"scrollSpeed"`     // 滚动速度

    // 翻页设置
    FlipMode        FlipMode             `bson:"flip_mode" json:"flipMode"`           // 翻页模式
    TapToTurn       bool                 `bson:"tap_to_turn" json:"tapToTurn"`         // 点击翻页

    // 其他设置
    ShowComment     bool                 `bson:"show_comment" json:"showComment"`     // 显示评论
    ShowNavigation  bool                 `bson:"show_navigation" json:"showNavigation"` // 显示导航
    FullScreenMode  bool                 `bson:"full_screen_mode" json:"fullScreenMode"` // 全屏模式

    UpdatedAt       time.Time            `bson:"updated_at" json:"updatedAt"`
}

type ReaderTheme string

const (
    ThemeLight      ReaderTheme = "light"      // 日间模式
    ThemeDark       ReaderTheme = "dark"       // 夜间模式
    ThemeSepia      ReaderTheme = "sepia"      // 护眼模式
    ThemeCustom     ReaderTheme = "custom"     // 自定义
)

type ReaderMode string

const (
    ModeDay         ReaderMode = "day"         // 日间
    ModeNight       ReaderMode = "night"       // 夜间
    ModeEyeCare     ReaderMode = "eye_care"    // 护眼
)

type FlipMode string

const (
    FlipSimulation  FlipMode = "simulation"  // 仿真翻页
    FlipSlide       FlipMode = "slide"       // 滑动翻页
    FlipScroll      FlipMode = "scroll"      // 滚动翻页
    FlipNone        FlipMode = "none"        // 无动画
)
```

## 数据库集合

### bookshelf 集合
```javascript
{
  _id: ObjectId,
  user_id: ObjectId,
  book_id: ObjectId,
  chapter_id: ObjectId,
  reading_status: String,  // not_started/reading/paused/completed/abandoned
  progress: Number,        // 0-100
  last_chapter: Number,
  last_position: Number,
  is_favorite: Boolean,
  rating: Number,          // 0-5
  tags: [String],
  notes: String,
  total_read_time: Number,
  read_count: Number,
  added_at: ISODate,
  last_read_at: ISODate,
  finished_at: ISODate
}
```

### reading_progress 集合
```javascript
{
  _id: ObjectId,
  user_id: ObjectId,
  book_id: ObjectId,
  chapter_id: ObjectId,
  chapter_position: Number,
  chapter_progress: Number,
  book_progress: Number,
  read_time: Number,
  total_read_time: Number,
  created_at: ISODate,
  updated_at: ISODate
}
```

### reading_history 集合
```javascript
{
  _id: ObjectId,
  user_id: ObjectId,
  book_id: ObjectId,
  chapter_id: ObjectId,
  session_start: ISODate,
  session_end: ISODate,
  duration: Number,
  words_read: Number,
  device_type: String,
  device_id: String,
  created_at: ISODate
}
```

### annotations 集合
```javascript
{
  _id: ObjectId,
  user_id: ObjectId,
  book_id: ObjectId,
  chapter_id: ObjectId,
  type: String,           // highlight/note/bookmark
  content: String,
  note: String,
  color: String,
  start_position: Number,
  end_position: Number,
  start_offset: Number,
  end_offset: Number,
  chapter_number: Number,
  tags: [String],
  is_public: Boolean,
  is_shared: Boolean,
  created_at: ISODate,
  updated_at: ISODate
}
```

### reader_settings 集合
```javascript
{
  _id: ObjectId,
  user_id: ObjectId,
  font_size: Number,
  font_family: String,
  line_height: Number,
  paragraph_spacing: Number,
  theme: String,          // light/dark/sepia/custom
  background_color: String,
  text_color: String,
  mode: String,           // day/night/eye_care
  auto_scroll: Boolean,
  scroll_speed: Number,
  flip_mode: String,      // simulation/slide/scroll/none
  tap_to_turn: Boolean,
  show_comment: Boolean,
  show_navigation: Boolean,
  full_screen_mode: Boolean,
  updated_at: ISODate
}
```

## 核心功能

### 1. 书架管理

**功能描述**：
- 添加书籍到书架
- 移除书籍
- 书架分类（最近阅读、收藏、未读完、已读完）
- 书架排序和筛选

**主要API**：
```
GET  /api/v1/reader/books                    // 获取书架
GET  /api/v1/reader/books/recent            // 最近阅读
GET  /api/v1/reader/books/unfinished        // 未读完
GET  /api/v1/reader/books/finished          // 已读完
POST /api/v1/reader/books/:bookId           // 添加到书架
DELETE /api/v1/reader/books/:bookId         // 从书架移除
```

### 2. 阅读进度追踪

**功能描述**：
- 实时保存阅读位置
- 计算阅读进度
- 记录阅读时长
- 阅读历史记录

**进度计算逻辑**：
```go
// 章节进度 = (当前位置 / 章节总字数) * 100
chapterProgress := (position / chapter.WordCount) * 100

// 全书进度 = (已读章节数 / 总章节数) * 100
bookProgress := (readChapters / totalChapters) * 100
```

**主要API**：
```
GET  /api/v1/reader/progress/:bookId         // 获取阅读进度
POST /api/v1/reader/progress                  // 保存阅读进度
POST /api/v1/reader/progress/time            // 更新阅读时长
GET  /api/v1/reader/progress/recent           // 最近阅读
GET  /api/v1/reader/progress/history         // 阅读历史
GET  /api/v1/reader/progress/stats           // 阅读统计
```

### 3. 标注系统

**功能描述**：
- 高亮文本标记
- 添加笔记和批注
- 书签管理
- 标注分享

**标注类型**：
1. **高亮** - 标记重要文本
2. **笔记** - 添加个人想法
3. **书签** - 标记阅读位置

**主要API**：
```
POST   /api/v1/reader/annotations                   // 创建标注
PUT    /api/v1/reader/annotations/:id              // 更新标注
DELETE /api/v1/reader/annotations/:id              // 删除标注
POST   /api/v1/reader/annotations/batch           // 批量创建
GET    /api/v1/reader/annotations/notes           // 获取笔记
GET    /api/v1/reader/annotations/bookmarks       // 获取书签
GET    /api/v1/reader/annotations/highlights      // 获取高亮
GET    /api/v1/reader/annotations/book/:bookId    // 获取书籍标注
POST   /api/v1/reader/annotations/sync            // 同步标注
```

### 4. 阅读设置

**功能描述**：
- 字体大小和样式
- 行高和段间距
- 主题切换（日间/夜间/护眼）
- 翻页模式
- 自动滚动

**主要API**：
```
GET  /api/v1/reader/settings               // 获取阅读设置
POST /api/v1/reader/settings               // 保存阅读设置
PUT  /api/v1/reader/settings               // 更新阅读设置
```

## 阅读统计

### 个人阅读统计
```go
type ReadingStatistics struct {
    TotalBooks       int64     `json:"totalBooks"`        // 总阅读书籍数
    FinishedBooks    int64     `json:"finishedBooks"`     // 已读完书籍数
    ReadingBooks     int64     `json:"readingBooks"`      // 阅读中书籍数
    TotalReadTime    int64     `json:"totalReadTime"`     // 总阅读时长（小时）
    TotalWords       int64     `json:"totalWords"`        // 总阅读字数
    AverageDailyTime int64     `json:"averageDailyTime"`  // 日均阅读时长（分钟）
    ReadingStreak    int       `json:"readingStreak"`     // 连续阅读天数
    LastReadDate     time.Time `json:"lastReadDate"`      // 最后阅读日期
}
```

### 阅读习惯分析
- 最活跃阅读时段
- 偏好书籍类型
- 平均阅读速度
- 完读率统计

## API端点列表

| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| GET | /api/v1/reader/books | 获取书架 | 是 |
| GET | /api/v1/reader/books/recent | 最近阅读 | 是 |
| GET | /api/v1/reader/books/unfinished | 未读完 | 是 |
| GET | /api/v1/reader/books/finished | 已读完 | 是 |
| POST | /api/v1/reader/books/:bookId | 添加到书架 | 是 |
| DELETE | /api/v1/reader/books/:bookId | 从书架移除 | 是 |
| POST | /api/v1/reader/books/:bookId/like | 点赞书籍 | 是 |
| DELETE | /api/v1/reader/books/:bookId/like | 取消点赞 | 是 |
| GET | /api/v1/reader/progress/:bookId | 获取阅读进度 | 是 |
| POST | /api/v1/reader/progress | 保存阅读进度 | 是 |
| POST | /api/v1/reader/progress/time | 更新阅读时长 | 是 |
| GET | /api/v1/reader/progress/recent | 最近阅读记录 | 是 |
| GET | /api/v1/reader/progress/history | 阅读历史 | 是 |
| GET | /api/v1/reader/progress/stats | 阅读统计 | 是 |
| POST | /api/v1/reader/annotations | 创建标注 | 是 |
| PUT | /api/v1/reader/annotations/:id | 更新标注 | 是 |
| DELETE | /api/v1/reader/annotations/:id | 删除标注 | 是 |
| POST | /api/v1/reader/annotations/batch | 批量创建标注 | 是 |
| PUT | /api/v1/reader/annotations/batch | 批量更新标注 | 是 |
| DELETE | /api/v1/reader/annotations/batch | 批量删除标注 | 是 |
| GET | /api/v1/reader/annotations/notes | 获取笔记 | 是 |
| GET | /api/v1/reader/annotations/bookmarks | 获取书签 | 是 |
| GET | /api/v1/reader/annotations/highlights | 获取高亮 | 是 |
| GET | /api/v1/reader/annotations/book/:bookId | 获取书籍标注 | 是 |
| GET | /api/v1/reader/annotations/chapter/:chapterId | 获取章节标注 | 是 |
| GET | /api/v1/reader/annotations/recent | 最近标注 | 是 |
| GET | /api/v1/reader/annotations/public | 公开标注 | 是 |
| GET | /api/v1/reader/annotations/search | 搜索标注 | 是 |
| GET | /api/v1/reader/annotations/stats | 标注统计 | 是 |
| POST | /api/v1/reader/annotations/sync | 同步标注 | 是 |
| GET | /api/v1/reader/annotations/export | 导出标注 | 是 |
| GET | /api/v1/reader/annotations/bookmark/latest | 最新书签 | 是 |
| GET | /api/v1/reader/settings | 获取阅读设置 | 是 |
| POST | /api/v1/reader/settings | 保存阅读设置 | 是 |
| PUT | /api/v1/reader/settings | 更新阅读设置 | 是 |
| POST | /api/v1/reader/reading-history | 记录阅读 | 是 |
| GET | /api/v1/reader/reading-history | 获取阅读历史 | 是 |
| GET | /api/v1/reader/reading-history/stats | 阅读统计 | 是 |
| DELETE | /api/v1/reader/reading-history/:id | 删除阅读历史 | 是 |
| DELETE | /api/v1/reader/reading-history | 清除阅读历史 | 是 |

## 依赖关系

### 依赖的模块
- **认证模块** - 用户身份验证
- **书店模块** - 获取书籍和章节信息
- **写作模块** - 获取未发布内容（如果作者本人）

### 被依赖的模块
- **社交模块** - 分享阅读记录和标注
- **推荐模块** - 基于阅读历史推荐内容

## 性能优化

1. **进度同步优化**
   - 防抖处理，避免频繁保存
   - 批量更新进度

2. **标注查询优化**
   - 按章节索引标注
   - 标注分页加载

3. **缓存策略**
   - Redis 缓存阅读进度
   - 本地存储阅读设置

## 扩展点

1. **朗读功能**
   - TTS文本转语音
   - 听书进度同步

2. **社交阅读**
   - 阅读排行
   - 阅读时长挑战
   - 阅读成就系统

3. **智能推荐**
   - 基于阅读历史推荐书籍
   - 基于标注内容推荐相似段落

4. **跨设备同步**
   - 阅读进度云端同步
   - 标注和设置同步
