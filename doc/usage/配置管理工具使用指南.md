# 配置管理工具使用指南

## 📋 概述

配置管理工具是一个简单易用的Web界面工具，允许系统管理员通过前端界面实时管理系统配置，无需手动编辑YAML文件或重启服务。

### 核心特性

- 🎨 **友好界面**：通过Web界面管理配置，无需SSH登录服务器
- 🔄 **实时生效**：配置更新后自动重新加载，部分配置即时生效
- 🔒 **安全保护**：敏感信息脱敏显示，管理员权限控制
- 📦 **自动备份**：每次更新前自动备份，支持一键恢复
- ✅ **配置验证**：更新前验证配置格式，防止错误配置
- 🔍 **分组管理**：配置按功能分组，便于查找和管理

---

## 🚀 快速开始

### 1. 获取管理员Token

首先需要以管理员身份登录获取Token：

```bash
# 管理员登录
curl -X POST http://localhost:8080/api/v1/login \
  -H 'Content-Type: application/json' \
  -d '{
    "username": "admin",
    "password": "your_password"
  }'

# 响应
{
  "code": 200,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user_id": "admin_user_id"
  }
}
```

保存返回的 `token`，后续所有请求都需要使用。

### 2. 查看当前配置

```bash
curl -X GET http://localhost:8080/api/v1/admin/config \
  -H 'Authorization: Bearer <your_token>'
```

### 3. 更新配置

```bash
curl -X PUT http://localhost:8080/api/v1/admin/config \
  -H 'Authorization: Bearer <your_token>' \
  -H 'Content-Type: application/json' \
  -d '{
    "key": "server.port",
    "value": "9090"
  }'
```

---

## 💻 功能详解

### 配置分组

配置按照功能模块分为以下几组：

#### 1. 服务器配置 (server)

| 配置项 | 说明 | 默认值 | 示例 |
|-------|------|--------|------|
| `server.port` | 服务器端口 | 8080 | 8080, 9090 |
| `server.mode` | 运行模式 | debug | debug, release |

**何时修改**：
- 端口冲突时修改 `server.port`
- 生产环境切换到 `release` 模式

#### 2. 数据库配置 (database)

| 配置项 | 说明 | 默认值 | 示例 |
|-------|------|--------|------|
| `database.uri` | MongoDB连接URI | mongodb://localhost:27017 | mongodb://user:pass@host:port |
| `database.name` | 数据库名称 | Qingyu_backend | Qingyu_backend, qingyu_prod |
| `database.max_pool_size` | 最大连接池大小 | 100 | 50, 100, 200 |

**何时修改**：
- 切换数据库服务器时修改 `database.uri`
- 生产环境使用独立数据库名
- 性能调优时调整连接池大小

#### 3. JWT配置 (jwt)

| 配置项 | 说明 | 默认值 | 示例 |
|-------|------|--------|------|
| `jwt.secret` | JWT密钥 | qingyu_secret_key | 强密码字符串 |
| `jwt.expiration_hours` | Token过期时间 | 24 | 1, 24, 168 |

**何时修改**：
- 生产环境必须修改为强密钥
- 根据安全需求调整过期时间

#### 4. Redis配置 (redis)

| 配置项 | 说明 | 默认值 | 示例 |
|-------|------|--------|------|
| `redis.host` | Redis主机地址 | localhost | localhost, redis.example.com |
| `redis.port` | Redis端口 | 6379 | 6379, 6380 |
| `redis.password` | Redis密码 | 空 | 密码字符串 |
| `redis.db` | 数据库编号 | 0 | 0, 1, 2 |

**何时修改**：
- 切换Redis服务器
- 生产环境设置密码
- 不同环境使用不同DB

#### 5. AI服务配置 (ai)

| 配置项 | 说明 | 默认值 | 示例 |
|-------|------|--------|------|
| `ai.api_key` | AI API密钥 | - | AIzaSy... |
| `ai.base_url` | API基础URL | - | https://api.openai.com/v1 |
| `ai.max_tokens` | 最大Token数 | 2000 | 1000, 2000, 4000 |

**何时修改**：
- 切换AI服务提供商
- 调整Token限制

---

## 🔧 常见操作场景

### 场景1: 修改服务器端口

**需求**：将服务器端口从8080改为9090

**步骤**：

1. 获取当前配置确认端口
```bash
curl -X GET http://localhost:8080/api/v1/admin/config/server.port \
  -H 'Authorization: Bearer <token>'
```

2. 更新端口配置
```bash
curl -X PUT http://localhost:8080/api/v1/admin/config \
  -H 'Authorization: Bearer <token>' \
  -H 'Content-Type: application/json' \
  -d '{
    "key": "server.port",
    "value": "9090"
  }'
```

3. 重启服务生效
```bash
# 注意：端口修改需要重启服务
./scripts/deployment/restart.sh
```

### 场景2: 切换到生产环境

**需求**：将开发配置切换到生产配置

**步骤**：

使用批量更新API一次性修改多个配置：

```bash
curl -X PUT http://localhost:8080/api/v1/admin/config/batch \
  -H 'Authorization: Bearer <token>' \
  -H 'Content-Type: application/json' \
  -d '{
    "updates": [
      {
        "key": "server.mode",
        "value": "release"
      },
      {
        "key": "jwt.secret",
        "value": "super-secure-production-secret-key-123456"
      },
      {
        "key": "database.name",
        "value": "qingyu_production"
      },
      {
        "key": "jwt.expiration_hours",
        "value": 1
      }
    ]
  }'
```

### 场景3: 配置错误恢复

**问题**：不小心修改了配置导致服务异常

**解决方案**：

1. 恢复最近的备份
```bash
curl -X POST http://localhost:8080/api/v1/admin/config/restore \
  -H 'Authorization: Bearer <token>'
```

2. 验证配置是否正常
```bash
curl -X GET http://localhost:8080/api/v1/admin/config \
  -H 'Authorization: Bearer <token>'
```

### 场景4: 增加数据库连接池

**需求**：系统负载增加，需要调整数据库连接池大小

**步骤**：

```bash
curl -X PUT http://localhost:8080/api/v1/admin/config \
  -H 'Authorization: Bearer <token>' \
  -H 'Content-Type: application/json' \
  -d '{
    "key": "database.max_pool_size",
    "value": 200
  }'
```

**生效时间**：立即生效（下次数据库连接时使用新配置）

### 场景5: 更换AI服务提供商

**需求**：从Gemini切换到OpenAI

**步骤**：

```bash
curl -X PUT http://localhost:8080/api/v1/admin/config/batch \
  -H 'Authorization: Bearer <token>' \
  -H 'Content-Type: application/json' \
  -d '{
    "updates": [
      {
        "key": "ai.api_key",
        "value": "sk-xxxxxxxxxxxxxxxxxxxxx"
      },
      {
        "key": "ai.base_url",
        "value": "https://api.openai.com/v1"
      },
      {
        "key": "ai.max_tokens",
        "value": 4000
      }
    ]
  }'
```

---

## ⚠️ 注意事项

### 需要重启服务的配置

以下配置修改后需要重启服务才能生效：

- ✅ `server.port` - 服务器端口
- ✅ `server.mode` - 运行模式
- ✅ `database.uri` - 数据库连接

### 立即生效的配置

以下配置修改后立即生效，无需重启：

- ✅ `jwt.expiration_hours` - Token过期时间（影响新生成的Token）
- ✅ `ai.max_tokens` - AI Token限制
- ✅ `database.max_pool_size` - 连接池大小（新连接使用新值）

### 敏感信息保护

系统会自动脱敏以下敏感信息：

- 🔒 `jwt.secret` - JWT密钥
- 🔒 `database.uri` - 数据库连接字符串（包含密码）
- 🔒 `redis.password` - Redis密码
- 🔒 `ai.api_key` - AI API密钥

**显示格式**：`qing****_key`（仅显示首尾4个字符）

### 备份策略

- 📦 每次更新配置前自动创建备份文件
- 📦 备份文件命名：`config.yaml.backup`
- 📦 位于配置文件同目录下
- 📦 建议定期手动备份到安全位置

---

## 🛡️ 安全建议

### 1. 权限管理

- ✅ 只授予可信任的管理员访问权限
- ✅ 定期轮换管理员密码
- ✅ 使用强密码策略

### 2. 敏感信息

- ✅ 生产环境JWT密钥至少32位
- ✅ 数据库密码使用强密码
- ✅ API密钥定期轮换

### 3. 操作记录

建议在重要配置修改前：

1. 记录修改原因
2. 通知相关人员
3. 准备回滚方案

### 4. 测试流程

生产环境配置修改前：

1. 在测试环境先验证
2. 准备回滚方案
3. 选择低峰期操作
4. 监控服务运行状态

---

## 🐛 故障排查

### 问题1: 更新配置后服务无响应

**可能原因**：
- 配置格式错误
- 数据库连接失败
- Redis连接失败

**解决方案**：
```bash
# 1. 查看服务日志
tail -f logs/server.log

# 2. 恢复配置备份
curl -X POST http://localhost:8080/api/v1/admin/config/restore \
  -H 'Authorization: Bearer <token>'

# 3. 重启服务
./scripts/deployment/restart.sh
```

### 问题2: 无法访问配置管理界面

**可能原因**：
- Token过期
- 权限不足
- 服务未启动

**解决方案**：
```bash
# 1. 重新登录获取Token
curl -X POST http://localhost:8080/api/v1/login \
  -H 'Content-Type: application/json' \
  -d '{"username":"admin","password":"your_password"}'

# 2. 确认角色权限
curl -X GET http://localhost:8080/api/v1/users/profile \
  -H 'Authorization: Bearer <token>'
# 确认role字段为"admin"

# 3. 检查服务状态
systemctl status qingyu-backend
```

### 问题3: 配置更新失败

**可能原因**：
- 配置值类型错误
- 配置项不存在
- 配置项不可编辑

**解决方案**：
```bash
# 1. 查看具体错误信息
# 响应会包含详细错误说明

# 2. 验证配置格式
curl -X POST http://localhost:8080/api/v1/admin/config/validate \
  -H 'Authorization: Bearer <token>' \
  -H 'Content-Type: application/json' \
  -d '{"yaml_content":"your yaml content"}'

# 3. 确认配置项信息
curl -X GET http://localhost:8080/api/v1/admin/config/<key> \
  -H 'Authorization: Bearer <token>'
```

---

## 📞 技术支持

### 获取帮助

1. **文档**：查看 `/doc/api/admin/配置管理API文档.md`
2. **日志**：查看 `/logs/server.log` 获取详细错误信息
3. **测试**：使用Postman或cURL测试API接口

### 反馈问题

如果遇到问题，请提供：

- 操作步骤
- 错误信息
- 配置文件内容（敏感信息脱敏）
- 服务器日志

---

## 🎓 最佳实践

### 1. 配置管理流程

```
[计划] → [测试] → [备份] → [执行] → [验证] → [监控]
```

### 2. 环境隔离

- 开发环境：`config.yaml`
- 测试环境：`config.test.yaml`
- 生产环境：`config.prod.yaml`

### 3. 变更管理

建议建立配置变更流程：

1. 提交变更申请
2. 技术评审
3. 测试环境验证
4. 生产环境执行
5. 变更记录归档

### 4. 定期检查

建议每月检查：

- JWT密钥是否需要轮换
- 连接池大小是否合适
- Token过期时间是否合理
- API密钥是否有效

---

**维护者**：青羽后端团队  
**最后更新**：2025-10-25  
**版本**：v1.0

