# æ¨èç³»ç»Ÿä½¿ç”¨æŒ‡å—

> **é€‚ç”¨ç‰ˆæœ¬**: v1.0.0  
> **æ›´æ–°æ—¶é—´**: 2025-10-10  
> **ç›®æ ‡è¯»è€…**: å‰ç«¯å¼€å‘ã€äº§å“ç»ç†ã€æµ‹è¯•å·¥ç¨‹å¸ˆ

---

## ğŸ“š ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
3. [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
4. [ä½¿ç”¨åœºæ™¯](#ä½¿ç”¨åœºæ™¯)
5. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
6. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
7. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)

---

## ç³»ç»Ÿæ¦‚è¿°

### åŠŸèƒ½ç®€ä»‹

é’ç¾½æ¨èç³»ç»Ÿæ˜¯åŸºäºç”¨æˆ·è¡Œä¸ºå’Œç‰©å“ç‰¹å¾çš„æ™ºèƒ½æ¨èå¼•æ“ï¼Œä¸ºç”¨æˆ·æä¾›ä¸ªæ€§åŒ–çš„ä¹¦ç±æ¨èæœåŠ¡ã€‚

### æ ¸å¿ƒç‰¹æ€§

âœ… **ä¸ªæ€§åŒ–æ¨è**: åŸºäºç”¨æˆ·ç”»åƒçš„å†…å®¹æ¨è  
âœ… **ç›¸ä¼¼ç‰©å“**: åŸºäºååŒè¿‡æ»¤çš„ç›¸ä¼¼æ¨è  
âœ… **è¡Œä¸ºé‡‡é›†**: å®æ—¶è®°å½•ç”¨æˆ·è¡Œä¸ºï¼ŒåŠ¨æ€æ›´æ–°ç”»åƒ  
âœ… **å†·å¯åŠ¨**: æ–°ç”¨æˆ·çƒ­é—¨ä¹¦ç±æ¨è  
âœ… **é«˜æ€§èƒ½**: Redisç¼“å­˜ + MongoDBå­˜å‚¨  
âœ… **æ˜“é›†æˆ**: RESTful APIï¼Œå“åº”æ—¶é—´ < 200ms

### æ¨èç®—æ³•

| ç®—æ³•ç±»å‹ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|---------|------|---------|
| åŸºäºç”¨æˆ·ç”»åƒ | æ ‡ç­¾/ä½œè€…/åˆ†ç±»åå¥½åŒ¹é… | å·²æœ‰ç”¨æˆ·è¡Œä¸ºæ•°æ® |
| ååŒè¿‡æ»¤ | ç‰©å“ç›¸ä¼¼åº¦è®¡ç®— | ä¹¦ç±è¯¦æƒ…é¡µ"ç›¸ä¼¼æ¨è" |
| çƒ­é—¨æ¨è | æŒ‰é˜…è¯»é‡/æ”¶è—é‡æ’åº | æ–°ç”¨æˆ·å†·å¯åŠ¨ |

---

## å¿«é€Ÿå¼€å§‹

### å‰ç½®æ¡ä»¶

- ç”¨æˆ·å·²ç™»å½•ï¼ˆè·å– JWT Tokenï¼‰
- åç«¯æœåŠ¡å·²å¯åŠ¨ï¼ˆé»˜è®¤ç«¯å£: 8080ï¼‰
- Redis å’Œ MongoDB å·²é…ç½®

### 5åˆ†é’Ÿä¸Šæ‰‹

#### 1. å‰ç«¯é›†æˆï¼ˆJavaScriptï¼‰

```javascript
// 1. è·å–ä¸ªæ€§åŒ–æ¨èï¼ˆé¦–é¡µæ¨èï¼‰
async function loadRecommendations() {
  const response = await fetch('/api/v1/recommendation/personalized?limit=10', {
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('token')}`
    }
  });
  
  const result = await response.json();
  
  if (result.code === 200) {
    const bookIds = result.data.recommendations;
    // æ‰¹é‡è·å–ä¹¦ç±è¯¦æƒ…
    displayBooks(bookIds);
  }
}

// 2. ä¹¦ç±è¯¦æƒ…é¡µï¼šè·å–ç›¸ä¼¼ä¹¦ç±
async function loadSimilarBooks(bookId) {
  const response = await fetch(`/api/v1/recommendation/similar?itemId=${bookId}&limit=6`);
  const result = await response.json();
  
  if (result.code === 200) {
    displaySimilarBooks(result.data.similar_items);
  }
}

// 3. è®°å½•ç”¨æˆ·è¡Œä¸º
async function trackBehavior(itemId, behaviorType, value) {
  await fetch('/api/v1/recommendation/behavior', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('token')}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      itemId,
      behaviorType,
      value
    })
  });
}

// ä½¿ç”¨ç¤ºä¾‹ï¼šç”¨æˆ·ç‚¹å‡»ä¹¦ç±
function onBookClick(bookId) {
  trackBehavior(bookId, 'click', 1.0);
}

// ä½¿ç”¨ç¤ºä¾‹ï¼šç”¨æˆ·é˜…è¯»ç« èŠ‚
function onChapterRead(bookId, chapterId, duration) {
  trackBehavior(bookId, 'read', duration);
}
```

#### 2. React é›†æˆ

```jsx
import { useEffect, useState } from 'react';
import { getPersonalizedRecommendations, recordBehavior } from './api/recommendation';

function RecommendationSection() {
  const [books, setBooks] = useState([]);
  
  useEffect(() => {
    loadRecommendations();
  }, []);
  
  async function loadRecommendations() {
    const result = await getPersonalizedRecommendations(10);
    if (result.code === 200) {
      // æ‰¹é‡è·å–ä¹¦ç±è¯¦æƒ…
      const bookDetails = await fetchBookDetails(result.data.recommendations);
      setBooks(bookDetails);
    }
  }
  
  function handleBookClick(bookId) {
    recordBehavior(bookId, 'click', 1.0);
    // è·³è½¬åˆ°ä¹¦ç±è¯¦æƒ…é¡µ
    window.location.href = `/book/${bookId}`;
  }
  
  return (
    <div className="recommendation-section">
      <h2>ä¸ºä½ æ¨è</h2>
      <div className="book-grid">
        {books.map(book => (
          <BookCard 
            key={book.id} 
            book={book} 
            onClick={() => handleBookClick(book.id)} 
          />
        ))}
      </div>
    </div>
  );
}
```

#### 3. Vue é›†æˆ

```vue
<template>
  <div class="recommendation-section">
    <h2>ä¸ºä½ æ¨è</h2>
    <div class="book-grid">
      <book-card 
        v-for="book in books" 
        :key="book.id" 
        :book="book"
        @click="handleBookClick(book.id)"
      />
    </div>
  </div>
</template>

<script>
import { getPersonalizedRecommendations, recordBehavior } from '@/api/recommendation';

export default {
  data() {
    return {
      books: []
    };
  },
  
  mounted() {
    this.loadRecommendations();
  },
  
  methods: {
    async loadRecommendations() {
      const result = await getPersonalizedRecommendations(10);
      if (result.code === 200) {
        const bookDetails = await this.fetchBookDetails(result.data.recommendations);
        this.books = bookDetails;
      }
    },
    
    handleBookClick(bookId) {
      recordBehavior(bookId, 'click', 1.0);
      this.$router.push(`/book/${bookId}`);
    }
  }
};
</script>
```

---

## æ ¸å¿ƒåŠŸèƒ½

### 1. ä¸ªæ€§åŒ–æ¨è

**åŠŸèƒ½è¯´æ˜**: æ ¹æ®ç”¨æˆ·å†å²è¡Œä¸ºå’Œåå¥½ï¼Œæ¨èå¯èƒ½æ„Ÿå…´è¶£çš„ä¹¦ç±ã€‚

**API**: `GET /api/v1/recommendation/personalized?limit=10`

**ä½¿ç”¨åœºæ™¯**:
- é¦–é¡µæ¨èæ¨¡å—
- "çŒœä½ å–œæ¬¢"æ¨¡å—
- ç©ºé—²çŠ¶æ€æ¨è

**ä»£ç ç¤ºä¾‹**:

```javascript
// 1. åŸºç¡€ç”¨æ³•
const result = await getPersonalizedRecommendations(10);

// 2. å¸¦é”™è¯¯å¤„ç†
async function loadPersonalizedBooks() {
  try {
    const result = await getPersonalizedRecommendations(10);
    
    if (result.code === 200) {
      const bookIds = result.data.recommendations;
      
      // æ£€æŸ¥æ¨èæ¥æº
      if (result.data.source === 'hot_books') {
        console.log('æ–°ç”¨æˆ·ï¼Œè¿”å›çƒ­é—¨ä¹¦ç±');
      } else {
        console.log('åŸºäºç”¨æˆ·ç”»åƒæ¨è');
      }
      
      // åŠ è½½ä¹¦ç±è¯¦æƒ…
      displayBooks(bookIds);
    } else {
      console.error('æ¨èå¤±è´¥:', result.message);
    }
  } catch (error) {
    console.error('ç½‘ç»œé”™è¯¯:', error);
  }
}

// 3. åˆ†é¡µåŠ è½½ï¼ˆç€‘å¸ƒæµï¼‰
let offset = 0;
async function loadMoreRecommendations() {
  const result = await getPersonalizedRecommendations(20);
  // è¿½åŠ åˆ°ç°æœ‰åˆ—è¡¨
  appendBooks(result.data.recommendations);
}
```

**æœ€ä½³å®è·µ**:

1. **ç¼“å­˜ç»“æœ**: å‰ç«¯ç¼“å­˜æ¨èç»“æœ5åˆ†é’Ÿï¼Œå‡å°‘è¯·æ±‚
2. **æ‡’åŠ è½½**: ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨ï¼ŒæŒ‰éœ€åŠ è½½ä¹¦ç±è¯¦æƒ…
3. **åŸ‹ç‚¹ä¸ŠæŠ¥**: è®°å½•æ¨èä½æ›å…‰å’Œç‚¹å‡»ï¼Œç”¨äºç®—æ³•ä¼˜åŒ–

```javascript
// æ›å…‰åŸ‹ç‚¹
function trackRecommendationImpression(bookIds) {
  // ä¸ŠæŠ¥æ¨èä½æ›å…‰
  analytics.track('recommendation_impression', {
    book_ids: bookIds,
    position: 'homepage',
    timestamp: Date.now()
  });
}

// ç‚¹å‡»åŸ‹ç‚¹
function onRecommendationClick(bookId, position) {
  // è®°å½•è¡Œä¸ºï¼ˆç”¨äºæ¨èç³»ç»Ÿï¼‰
  recordBehavior(bookId, 'click', 1.0);
  
  // ä¸ŠæŠ¥ç‚¹å‡»äº‹ä»¶ï¼ˆç”¨äºæ•°æ®åˆ†æï¼‰
  analytics.track('recommendation_click', {
    book_id: bookId,
    position: position,
    timestamp: Date.now()
  });
}
```

---

### 2. ç›¸ä¼¼ç‰©å“æ¨è

**åŠŸèƒ½è¯´æ˜**: æ¨èä¸æŒ‡å®šä¹¦ç±ç›¸ä¼¼çš„å…¶ä»–ä¹¦ç±ï¼ˆå…¬å¼€æ¥å£ï¼Œæ— éœ€ç™»å½•ï¼‰ã€‚

**API**: `GET /api/v1/recommendation/similar?itemId={bookId}&limit=6`

**ä½¿ç”¨åœºæ™¯**:
- ä¹¦ç±è¯¦æƒ…é¡µ"ç›¸ä¼¼æ¨è"æ¨¡å—
- "çœ‹è¿‡è¿™æœ¬ä¹¦çš„äººè¿˜çœ‹äº†"
- ä¹¦ç±åˆ—è¡¨é¡µç›¸å…³æ¨è

**ä»£ç ç¤ºä¾‹**:

```javascript
// 1. ä¹¦ç±è¯¦æƒ…é¡µ
async function loadBookDetail(bookId) {
  // åŠ è½½ä¹¦ç±è¯¦æƒ…
  const bookDetail = await fetchBookDetail(bookId);
  displayBookDetail(bookDetail);
  
  // åŠ è½½ç›¸ä¼¼ä¹¦ç±
  const result = await getSimilarItems(bookId, 6);
  if (result.code === 200) {
    displaySimilarBooks(result.data.similar_items);
  }
}

// 2. åˆ—è¡¨é¡µç›¸å…³æ¨è
function BookListItem({ book }) {
  const [similarBooks, setSimilarBooks] = useState([]);
  
  async function loadSimilar() {
    const result = await getSimilarItems(book.id, 3);
    if (result.code === 200) {
      setSimilarBooks(result.data.similar_items);
    }
  }
  
  return (
    <div className="book-item">
      <BookCover book={book} />
      <button onClick={loadSimilar}>æŸ¥çœ‹ç›¸ä¼¼</button>
      {similarBooks.length > 0 && (
        <div className="similar-books">
          {similarBooks.map(id => <MiniBookCard key={id} bookId={id} />)}
        </div>
      )}
    </div>
  );
}
```

**æœ€ä½³å®è·µ**:

1. **å»¶è¿ŸåŠ è½½**: ç›¸ä¼¼æ¨èåœ¨ç”¨æˆ·æ»šåŠ¨åˆ°å¯¹åº”åŒºåŸŸæ—¶å†åŠ è½½
2. **ç¼“å­˜ç­–ç•¥**: ç›¸ä¼¼æ¨èç¼“å­˜24å°æ—¶ï¼Œå‡å°‘æœåŠ¡å™¨å‹åŠ›
3. **é™çº§æ–¹æ¡ˆ**: å¦‚æœç›¸ä¼¼æ¨èå¤±è´¥ï¼Œå±•ç¤ºåŒåˆ†ç±»çƒ­é—¨ä¹¦ç±

```javascript
async function loadSimilarBooksWithFallback(bookId) {
  try {
    const result = await getSimilarItems(bookId, 6);
    
    if (result.code === 200 && result.data.similar_items.length > 0) {
      return result.data.similar_items;
    } else {
      // é™çº§ï¼šè¿”å›åŒåˆ†ç±»çƒ­é—¨ä¹¦ç±
      const book = await fetchBookDetail(bookId);
      return await getHotBooksByCategory(book.category, 6);
    }
  } catch (error) {
    console.error('åŠ è½½ç›¸ä¼¼ä¹¦ç±å¤±è´¥:', error);
    return [];
  }
}
```

---

### 3. ç”¨æˆ·è¡Œä¸ºè®°å½•

**åŠŸèƒ½è¯´æ˜**: è®°å½•ç”¨æˆ·çš„æµè§ˆã€ç‚¹å‡»ã€æ”¶è—ã€é˜…è¯»ç­‰è¡Œä¸ºï¼Œç”¨äºæ›´æ–°ç”¨æˆ·ç”»åƒã€‚

**API**: `POST /api/v1/recommendation/behavior`

**è¡Œä¸ºç±»å‹**:

| ç±»å‹ | è§¦å‘æ—¶æœº | value | metadata |
|------|---------|-------|----------|
| view | è¿›å…¥ä¹¦ç±è¯¦æƒ…é¡µ | åœç•™æ—¶é•¿ï¼ˆç§’ï¼‰ | - |
| click | ç‚¹å‡»ä¹¦ç±å¡ç‰‡ | 1.0 | `{position: 'homepage'}` |
| collect | æ”¶è—ä¹¦ç± | 1.0 | - |
| read | é˜…è¯»ç« èŠ‚ | é˜…è¯»æ—¶é•¿ï¼ˆç§’ï¼‰ | `{chapterId, progress}` |
| finish | è¯»å®Œç« èŠ‚ | 1.0 | `{chapterId}` |
| like | ç‚¹èµè¯„è®º | 1.0 | `{commentId}` |
| share | åˆ†äº«ä¹¦ç± | 1.0 | `{platform: 'wechat'}` |

**ä»£ç ç¤ºä¾‹**:

```javascript
// 1. ç‚¹å‡»è¡Œä¸ºï¼ˆä¹¦ç±å¡ç‰‡ï¼‰
function BookCard({ book, position }) {
  async function handleClick() {
    // è®°å½•ç‚¹å‡»è¡Œä¸º
    await recordBehavior(book.id, 'click', 1.0, {
      position: position // 'homepage', 'recommendation', 'search'
    });
    
    // è·³è½¬åˆ°è¯¦æƒ…é¡µ
    window.location.href = `/book/${book.id}`;
  }
  
  return <div onClick={handleClick}>...</div>;
}

// 2. æµè§ˆè¡Œä¸ºï¼ˆè¯¦æƒ…é¡µåœç•™æ—¶é•¿ï¼‰
function BookDetailPage({ bookId }) {
  useEffect(() => {
    const startTime = Date.now();
    
    return () => {
      const duration = (Date.now() - startTime) / 1000;
      if (duration > 5) { // åœç•™è¶…è¿‡5ç§’æ‰è®°å½•
        recordBehavior(bookId, 'view', duration);
      }
    };
  }, [bookId]);
  
  return <div>...</div>;
}

// 3. é˜…è¯»è¡Œä¸ºï¼ˆç« èŠ‚é˜…è¯»ï¼‰
function ReaderPage({ bookId, chapterId }) {
  const startTime = useRef(Date.now());
  const [progress, setProgress] = useState(0);
  
  // å®šæœŸä¿å­˜é˜…è¯»è¿›åº¦
  useEffect(() => {
    const timer = setInterval(() => {
      const duration = (Date.now() - startTime.current) / 1000;
      
      // æ¯30ç§’è®°å½•ä¸€æ¬¡
      if (duration >= 30) {
        recordBehavior(bookId, 'read', duration, {
          chapterId,
          progress: progress / 100
        });
        
        startTime.current = Date.now();
      }
    }, 30000);
    
    return () => clearInterval(timer);
  }, [bookId, chapterId, progress]);
  
  // è¯»å®Œç« èŠ‚
  function handleChapterFinish() {
    recordBehavior(bookId, 'finish', 1.0, {
      chapterId
    });
  }
  
  return <div>...</div>;
}

// 4. æ”¶è—è¡Œä¸º
async function handleCollect(bookId) {
  // è°ƒç”¨æ”¶è—API
  await collectBook(bookId);
  
  // è®°å½•æ”¶è—è¡Œä¸º
  await recordBehavior(bookId, 'collect', 1.0);
  
  showToast('æ”¶è—æˆåŠŸ');
}

// 5. åˆ†äº«è¡Œä¸º
async function handleShare(bookId, platform) {
  // è°ƒç”¨åˆ†äº«API
  await shareBook(bookId, platform);
  
  // è®°å½•åˆ†äº«è¡Œä¸º
  await recordBehavior(bookId, 'share', 1.0, {
    platform: platform // 'wechat', 'qq', 'weibo'
  });
}
```

**æœ€ä½³å®è·µ**:

1. **æ‰¹é‡ä¸ŠæŠ¥**: æœ¬åœ°ç¼“å­˜è¡Œä¸ºæ•°æ®ï¼Œæ¯åˆ†é’Ÿæ‰¹é‡ä¸ŠæŠ¥ä¸€æ¬¡
2. **å¼‚æ­¥å¤„ç†**: è¡Œä¸ºè®°å½•ä¸é˜»å¡ä¸»æµç¨‹ï¼Œå¤±è´¥é™é»˜å¤„ç†
3. **æ•°æ®æ¸…æ´—**: è¿‡æ»¤æ— æ•ˆè¡Œä¸ºï¼ˆå¦‚åœç•™æ—¶é—´<3ç§’ï¼‰

```javascript
// æ‰¹é‡ä¸ŠæŠ¥ç®¡ç†å™¨
class BehaviorReporter {
  constructor() {
    this.queue = [];
    this.timer = null;
    this.startReporting();
  }
  
  // æ·»åŠ è¡Œä¸ºåˆ°é˜Ÿåˆ—
  add(itemId, behaviorType, value, metadata) {
    this.queue.push({
      itemId,
      behaviorType,
      value,
      metadata,
      timestamp: Date.now()
    });
    
    // é˜Ÿåˆ—è¶…è¿‡10æ¡ï¼Œç«‹å³ä¸ŠæŠ¥
    if (this.queue.length >= 10) {
      this.flush();
    }
  }
  
  // å®šæœŸä¸ŠæŠ¥ï¼ˆæ¯åˆ†é’Ÿï¼‰
  startReporting() {
    this.timer = setInterval(() => {
      this.flush();
    }, 60000);
  }
  
  // æ‰¹é‡ä¸ŠæŠ¥
  async flush() {
    if (this.queue.length === 0) return;
    
    const behaviors = [...this.queue];
    this.queue = [];
    
    try {
      // æ‰¹é‡ä¸ŠæŠ¥ï¼ˆéœ€è¦åç«¯æ”¯æŒï¼‰
      await fetch('/api/v1/recommendation/behavior/batch', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ behaviors })
      });
    } catch (error) {
      console.error('è¡Œä¸ºä¸ŠæŠ¥å¤±è´¥:', error);
      // å¤±è´¥çš„è¡Œä¸ºé‡æ–°åŠ å…¥é˜Ÿåˆ—
      this.queue.unshift(...behaviors);
    }
  }
  
  // é¡µé¢å…³é—­æ—¶ä¸ŠæŠ¥
  destroy() {
    clearInterval(this.timer);
    this.flush();
  }
}

// å…¨å±€å•ä¾‹
const behaviorReporter = new BehaviorReporter();

// é¡µé¢å¸è½½æ—¶ä¸ŠæŠ¥
window.addEventListener('beforeunload', () => {
  behaviorReporter.destroy();
});

// ç®€åŒ–çš„API
function trackBehavior(itemId, behaviorType, value, metadata) {
  behaviorReporter.add(itemId, behaviorType, value, metadata);
}
```

---

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: é¦–é¡µæ¨èæ¨¡å—

**éœ€æ±‚**: é¦–é¡µå±•ç¤º10æœ¬ä¸ªæ€§åŒ–æ¨èä¹¦ç±

```javascript
// 1. åŠ è½½æ¨è
async function loadHomepageRecommendations() {
  const result = await getPersonalizedRecommendations(10);
  
  if (result.code === 200) {
    const bookIds = result.data.recommendations;
    const books = await fetchBookDetails(bookIds);
    
    // æ›å…‰åŸ‹ç‚¹
    trackRecommendationImpression(bookIds);
    
    // æ¸²æŸ“
    renderRecommendationSection(books);
  }
}

// 2. ç‚¹å‡»äº‹ä»¶
function onBookClick(bookId, index) {
  // è®°å½•ç‚¹å‡»è¡Œä¸º
  recordBehavior(bookId, 'click', 1.0);
  
  // ç‚¹å‡»åŸ‹ç‚¹
  analytics.track('recommendation_click', {
    book_id: bookId,
    position: 'homepage',
    index: index
  });
  
  // è·³è½¬
  window.location.href = `/book/${bookId}`;
}
```

### åœºæ™¯2: ä¹¦ç±è¯¦æƒ…é¡µç›¸ä¼¼æ¨è

**éœ€æ±‚**: è¯¦æƒ…é¡µåº•éƒ¨å±•ç¤º6æœ¬ç›¸ä¼¼ä¹¦ç±

```javascript
async function loadBookDetailPage(bookId) {
  // åŠ è½½ä¹¦ç±è¯¦æƒ…
  const book = await fetchBookDetail(bookId);
  renderBookDetail(book);
  
  // è®°å½•æµè§ˆè¡Œä¸º
  trackViewBehavior(bookId);
  
  // åŠ è½½ç›¸ä¼¼ä¹¦ç±
  const result = await getSimilarItems(bookId, 6);
  if (result.code === 200) {
    const similarBooks = await fetchBookDetails(result.data.similar_items);
    renderSimilarSection(similarBooks);
  }
}

// æµè§ˆæ—¶é•¿è®°å½•
function trackViewBehavior(bookId) {
  const startTime = Date.now();
  
  window.addEventListener('beforeunload', () => {
    const duration = (Date.now() - startTime) / 1000;
    if (duration > 5) {
      recordBehavior(bookId, 'view', duration);
    }
  });
}
```

### åœºæ™¯3: é˜…è¯»é¡µè¡Œä¸ºè¿½è¸ª

**éœ€æ±‚**: è¿½è¸ªç”¨æˆ·é˜…è¯»æ—¶é•¿å’Œé˜…è¯»è¿›åº¦

```javascript
class ReaderTracker {
  constructor(bookId, chapterId) {
    this.bookId = bookId;
    this.chapterId = chapterId;
    this.startTime = Date.now();
    this.lastReportTime = Date.now();
    this.startReporting();
  }
  
  // æ¯30ç§’ä¸ŠæŠ¥ä¸€æ¬¡
  startReporting() {
    this.timer = setInterval(() => {
      const duration = (Date.now() - this.lastReportTime) / 1000;
      
      recordBehavior(this.bookId, 'read', duration, {
        chapterId: this.chapterId,
        progress: this.getProgress()
      });
      
      this.lastReportTime = Date.now();
    }, 30000);
  }
  
  // è·å–é˜…è¯»è¿›åº¦
  getProgress() {
    const scrollTop = window.scrollY;
    const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
    return scrollTop / scrollHeight;
  }
  
  // è¯»å®Œç« èŠ‚
  finishChapter() {
    clearInterval(this.timer);
    
    const duration = (Date.now() - this.lastReportTime) / 1000;
    recordBehavior(this.bookId, 'read', duration, {
      chapterId: this.chapterId,
      progress: 1.0
    });
    
    recordBehavior(this.bookId, 'finish', 1.0, {
      chapterId: this.chapterId
    });
  }
  
  // æ¸…ç†
  destroy() {
    clearInterval(this.timer);
    
    const duration = (Date.now() - this.lastReportTime) / 1000;
    if (duration > 5) {
      recordBehavior(this.bookId, 'read', duration, {
        chapterId: this.chapterId,
        progress: this.getProgress()
      });
    }
  }
}

// ä½¿ç”¨
const tracker = new ReaderTracker(bookId, chapterId);

// è¯»å®Œç« èŠ‚
function onNextChapter() {
  tracker.finishChapter();
  // åŠ è½½ä¸‹ä¸€ç« 
}

// é¡µé¢å…³é—­
window.addEventListener('beforeunload', () => {
  tracker.destroy();
});
```

---

## æœ€ä½³å®è·µ

### 1. æ€§èƒ½ä¼˜åŒ–

**å‰ç«¯ç¼“å­˜**:

```javascript
// æœ¬åœ°ç¼“å­˜æ¨èç»“æœ
const CACHE_KEY = 'qingyu_recommendations';
const CACHE_DURATION = 5 * 60 * 1000; // 5åˆ†é’Ÿ

async function getCachedRecommendations() {
  const cached = localStorage.getItem(CACHE_KEY);
  
  if (cached) {
    const { data, timestamp } = JSON.parse(cached);
    
    if (Date.now() - timestamp < CACHE_DURATION) {
      return data;
    }
  }
  
  // ç¼“å­˜å¤±æ•ˆï¼Œé‡æ–°è¯·æ±‚
  const result = await getPersonalizedRecommendations(10);
  
  if (result.code === 200) {
    localStorage.setItem(CACHE_KEY, JSON.stringify({
      data: result.data.recommendations,
      timestamp: Date.now()
    }));
    
    return result.data.recommendations;
  }
}
```

**æ‡’åŠ è½½**:

```javascript
// ä½¿ç”¨Intersection Observerå»¶è¿ŸåŠ è½½
function RecommendationSection() {
  const ref = useRef(null);
  const [books, setBooks] = useState([]);
  
  useEffect(() => {
    const observer = new IntersectionObserver((entries) => {
      if (entries[0].isIntersecting) {
        loadRecommendations();
        observer.disconnect();
      }
    });
    
    observer.observe(ref.current);
    
    return () => observer.disconnect();
  }, []);
  
  async function loadRecommendations() {
    const result = await getPersonalizedRecommendations(10);
    if (result.code === 200) {
      const bookDetails = await fetchBookDetails(result.data.recommendations);
      setBooks(bookDetails);
    }
  }
  
  return <div ref={ref}>...</div>;
}
```

### 2. é”™è¯¯å¤„ç†

```javascript
async function safeGetRecommendations(limit = 10, retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      const result = await getPersonalizedRecommendations(limit);
      
      if (result.code === 200) {
        return result.data.recommendations;
      } else {
        console.warn(`æ¨èå¤±è´¥: ${result.message}`);
      }
    } catch (error) {
      console.error(`è¯·æ±‚å¤±è´¥ (${i + 1}/${retries}):`, error);
      
      if (i === retries - 1) {
        // æœ€åä¸€æ¬¡å¤±è´¥ï¼Œè¿”å›é»˜è®¤æ¨è
        return getDefaultRecommendations();
      }
      
      // æŒ‡æ•°é€€é¿
      await delay(Math.pow(2, i) * 1000);
    }
  }
}

// é»˜è®¤æ¨èï¼ˆçƒ­é—¨ä¹¦ç±ï¼‰
function getDefaultRecommendations() {
  return fetchHotBooks(10);
}
```

### 3. ç”¨æˆ·ä½“éªŒ

**éª¨æ¶å±**:

```jsx
function RecommendationSection() {
  const [loading, setLoading] = useState(true);
  const [books, setBooks] = useState([]);
  
  useEffect(() => {
    loadRecommendations();
  }, []);
  
  async function loadRecommendations() {
    setLoading(true);
    const result = await getPersonalizedRecommendations(10);
    if (result.code === 200) {
      const bookDetails = await fetchBookDetails(result.data.recommendations);
      setBooks(bookDetails);
    }
    setLoading(false);
  }
  
  if (loading) {
    return <SkeletonBookGrid count={10} />;
  }
  
  return <BookGrid books={books} />;
}
```

**åˆ·æ–°æ¨è**:

```jsx
function RecommendationSection() {
  const [books, setBooks] = useState([]);
  const [refreshing, setRefreshing] = useState(false);
  
  async function handleRefresh() {
    setRefreshing(true);
    
    // æ¸…é™¤ç¼“å­˜
    clearRecommendationCache();
    
    // é‡æ–°åŠ è½½
    const result = await getPersonalizedRecommendations(10);
    if (result.code === 200) {
      const bookDetails = await fetchBookDetails(result.data.recommendations);
      setBooks(bookDetails);
    }
    
    setRefreshing(false);
  }
  
  return (
    <div>
      <div className="section-header">
        <h2>ä¸ºä½ æ¨è</h2>
        <button onClick={handleRefresh} disabled={refreshing}>
          {refreshing ? 'åˆ·æ–°ä¸­...' : 'æ¢ä¸€æ‰¹'}
        </button>
      </div>
      <BookGrid books={books} />
    </div>
  );
}
```

---

## å¸¸è§é—®é¢˜

### Q1: æ–°ç”¨æˆ·æ²¡æœ‰æ¨èæ€ä¹ˆåŠï¼Ÿ

**A**: ç³»ç»Ÿä¼šè‡ªåŠ¨è¿”å›çƒ­é—¨ä¹¦ç±ä½œä¸ºå†·å¯åŠ¨ç­–ç•¥ã€‚

```javascript
const result = await getPersonalizedRecommendations(10);

if (result.data.source === 'hot_books') {
  // æ–°ç”¨æˆ·ï¼Œå±•ç¤º"çƒ­é—¨æ¨è"æ ‡é¢˜
  showHotBooksTitle();
} else {
  // è€ç”¨æˆ·ï¼Œå±•ç¤º"ä¸ºä½ æ¨è"æ ‡é¢˜
  showPersonalizedTitle();
}
```

### Q2: æ¨èç»“æœå¤šä¹…æ›´æ–°ä¸€æ¬¡ï¼Ÿ

**A**: 
- åç«¯ç¼“å­˜ï¼š1å°æ—¶
- ç”¨æˆ·äº§ç”Ÿæ–°è¡Œä¸ºåï¼Œç¼“å­˜ç«‹å³å¤±æ•ˆ
- å‰ç«¯å»ºè®®5åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡

### Q3: å¦‚ä½•æé«˜æ¨èå‡†ç¡®ç‡ï¼Ÿ

**A**: 
1. å°½å¯èƒ½è®°å½•ç”¨æˆ·è¡Œä¸ºï¼ˆview, click, readç­‰ï¼‰
2. ä¼ é€’è¯¦ç»†çš„metadataï¼ˆå¦‚é˜…è¯»è¿›åº¦ã€åœç•™æ—¶é•¿ï¼‰
3. ç”¨æˆ·ç‚¹å‡»æ¨èååŠæ—¶ä¸ŠæŠ¥ç‚¹å‡»äº‹ä»¶

### Q4: ç›¸ä¼¼æ¨èä¸ºä»€ä¹ˆæœ‰æ—¶è¿”å›ç©ºï¼Ÿ

**A**: 
- æ–°ä¹¦ç±ç‰¹å¾æœªè®¡ç®—å®Œæˆ
- ä¹¦ç±ç‰¹å¾ä¸è¶³ï¼ˆæ ‡ç­¾ã€ä½œè€…ã€åˆ†ç±»ç¼ºå¤±ï¼‰
- å»ºè®®é™çº§åˆ°åŒåˆ†ç±»çƒ­é—¨ä¹¦ç±

```javascript
const result = await getSimilarItems(bookId, 6);

if (!result.data.similar_items || result.data.similar_items.length === 0) {
  // é™çº§ï¼šåŒåˆ†ç±»çƒ­é—¨ä¹¦ç±
  const book = await fetchBookDetail(bookId);
  const hotBooks = await getHotBooksByCategory(book.category, 6);
  displaySimilarBooks(hotBooks);
}
```

### Q5: è¡Œä¸ºä¸ŠæŠ¥å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A**: 
- è¡Œä¸ºè®°å½•å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
- å»ºè®®å®ç°æœ¬åœ°ç¼“å­˜ + é‡è¯•æœºåˆ¶
- å¤±è´¥çš„è¡Œä¸ºå¯ä»¥æš‚å­˜ï¼Œä¸‹æ¬¡å†ä¸ŠæŠ¥

---

## æ€§èƒ½ä¼˜åŒ–

### æŒ‡æ ‡ç›‘æ§

```javascript
// åŸ‹ç‚¹ï¼šæ¨èè¯·æ±‚è€—æ—¶
function trackRecommendationPerformance() {
  const startTime = performance.now();
  
  const result = await getPersonalizedRecommendations(10);
  
  const duration = performance.now() - startTime;
  
  analytics.track('recommendation_performance', {
    duration: duration,
    success: result.code === 200,
    timestamp: Date.now()
  });
}
```

### é¢„åŠ è½½

```javascript
// é¦–é¡µåŠ è½½æ—¶é¢„åŠ è½½æ¨è
window.addEventListener('DOMContentLoaded', () => {
  // é¢„åŠ è½½æ¨èï¼ˆä¸é˜»å¡æ¸²æŸ“ï¼‰
  prefetchRecommendations();
});

async function prefetchRecommendations() {
  const result = await getPersonalizedRecommendations(20);
  // ç¼“å­˜åˆ°localStorage
  cacheRecommendations(result.data.recommendations);
}
```

### CDNåŠ é€Ÿ

- ä¹¦ç±å°é¢å›¾ä½¿ç”¨CDN
- æ¨èAPIè€ƒè™‘ä½¿ç”¨CDNè¾¹ç¼˜èŠ‚ç‚¹
- é™æ€èµ„æºï¼ˆJS/CSSï¼‰ä½¿ç”¨CDN

---

## æŠ€æœ¯æ”¯æŒ

**é—®é¢˜åé¦ˆ**: issues@qingyu.com  
**æ–‡æ¡£åé¦ˆ**: docs@qingyu.com  
**æŠ€æœ¯äº¤æµ**: tech-community@qingyu.com

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2025-10-10  
**ç»´æŠ¤å›¢é˜Ÿ**: é’ç¾½æ¨èç³»ç»Ÿå›¢é˜Ÿ


