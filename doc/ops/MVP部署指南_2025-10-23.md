# MVP内测环境部署指南

**版本**: v1.0-MVP  
**日期**: 2025-10-23  
**目标**: 部署MVP版本到内测环境

---

## 📋 部署前准备

### 环境要求

**服务器配置**:
- CPU: 2核+
- 内存: 4GB+
- 磁盘: 20GB+
- 操作系统: Linux/Windows/macOS

**软件依赖**:
- Docker: 20.10+
- docker-compose: 1.29+
- Go: 1.21+ (开发环境)

### 准备检查清单

运行部署检查脚本：
```bash
bash scripts/deployment_check.sh
```

**检查结果应为**:
- ✅ 21/21项检查通过
- ⚠️ 0个警告
- ❌ 0个失败

---

## 🚀 快速部署（推荐）

### 方式一：一键部署脚本

```bash
# 1. 克隆代码（如果尚未克隆）
git clone <repository-url>
cd Qingyu_backend

# 2. 切换到最新MVP分支
git checkout mvp-release

# 3. 运行一键部署脚本
bash scripts/quick_deploy_mvp.sh
```

脚本会自动完成：
- 构建Docker镜像
- 启动服务容器
- 初始化数据库
- 创建测试账号
- 健康检查

### 方式二：手动部署

#### Step 1: 构建Docker镜像

```bash
docker build -t qingyu-backend:mvp -f docker/Dockerfile.prod .
```

#### Step 2: 启动服务

```bash
# 启动所有服务（MongoDB + Redis + Backend）
docker-compose -f docker/docker-compose.prod.yml up -d

# 查看服务状态
docker-compose -f docker/docker-compose.prod.yml ps
```

**预期输出**:
```
Name                  State   Ports
qingyu-backend        Up      0.0.0.0:8080->8080/tcp
qingyu-mongodb        Up      0.0.0.0:27017->27017/tcp
qingyu-redis          Up      0.0.0.0:6379->6379/tcp
```

#### Step 3: 数据库初始化

```bash
# 运行数据库迁移
docker exec -it qingyu-backend go run cmd/migrate/main.go

# 创建测试数据（可选）
docker exec -it qingyu-backend go run migration/seeds/main.go
```

#### Step 4: 健康检查

```bash
# 检查API健康状态
curl http://localhost:8080/health

# 预期响应
{
  "status": "healthy",
  "timestamp": "2025-10-23T10:00:00Z",
  "services": {
    "mongodb": "connected",
    "redis": "connected"
  }
}
```

---

## 🧪 部署验证

### 1. 服务可用性验证

```bash
# 检查服务是否运行
curl -i http://localhost:8080/health

# 检查API响应
curl http://localhost:8080/api/v1/system/version
```

### 2. MVP新功能验证

#### 密码强度验证

```bash
# 测试注册（弱密码应被拒绝）
curl -X POST http://localhost:8080/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "test_user",
    "email": "test@example.com",
    "password": "123456"
  }'

# 预期：400 Bad Request，密码不符合要求

# 测试注册（强密码应成功）
curl -X POST http://localhost:8080/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "test_user",
    "email": "test@example.com",
    "password": "Test123456"
  }'

# 预期：201 Created
```

#### 多端登录限制验证

```bash
# 脚本：模拟6次登录
for i in {1..6}; do
  echo "登录尝试 $i"
  curl -X POST http://localhost:8080/api/v1/auth/login \
    -H "Content-Type: application/json" \
    -d '{
      "username": "test_user",
      "password": "Test123456"
    }'
  echo ""
done

# 预期：前5次成功，第6次失败（设备数量限制）
```

#### 自动保存功能验证

```bash
# 1. 登录获取Token
TOKEN=$(curl -s -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "test_user", "password": "Test123456"}' \
  | jq -r '.data.token')

# 2. 创建项目
PROJECT_ID=$(curl -s -X POST http://localhost:8080/api/v1/projects \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "测试项目", "description": "自动保存测试"}' \
  | jq -r '.data.id')

# 3. 创建文档
DOCUMENT_ID=$(curl -s -X POST http://localhost:8080/api/v1/projects/$PROJECT_ID/documents \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"title": "测试章节", "content": "初始内容"}' \
  | jq -r '.data.id')

# 4. 等待35秒（确保触发自动保存）
sleep 35

# 5. 查询版本历史
curl -s http://localhost:8080/api/v1/documents/$DOCUMENT_ID/versions \
  -H "Authorization: Bearer $TOKEN"

# 预期：版本列表中应包含"自动保存"版本
```

### 3. 核心流程完整验证

参考 `scripts/mvp_smoke_test.sh` 脚本，验证完整用户流程：
```bash
bash scripts/mvp_smoke_test.sh
```

---

## 📊 监控与日志

### 查看日志

```bash
# 查看后端服务日志
docker logs -f qingyu-backend

# 查看MongoDB日志
docker logs -f qingyu-mongodb

# 查看Redis日志
docker logs -f qingyu-redis

# 查看最近100行日志
docker logs --tail 100 qingyu-backend
```

### 日志级别

**生产环境配置** (`config/config.docker.yaml`):
```yaml
log:
  level: info  # debug/info/warn/error
  format: json
  output: stdout
```

### 关键日志标识

- `[AutoSave]` - 自动保存相关
- `[Session]` - 会话管理相关
- `[Auth]` - 认证授权相关
- `[ERROR]` - 错误日志
- `[WARN]` - 警告日志

---

## 🔧 常见问题处理

### 问题1: 服务启动失败

**症状**: `docker-compose up` 失败

**排查**:
```bash
# 查看详细错误
docker-compose -f docker/docker-compose.prod.yml logs

# 检查端口占用
netstat -an | grep 8080

# 检查Docker磁盘空间
docker system df
```

**解决**:
```bash
# 清理旧容器
docker-compose -f docker/docker-compose.prod.yml down

# 重新启动
docker-compose -f docker/docker-compose.prod.yml up -d
```

### 问题2: MongoDB连接失败

**症状**: 日志中显示 "connect to mongodb failed"

**排查**:
```bash
# 检查MongoDB是否运行
docker ps | grep mongodb

# 检查MongoDB日志
docker logs qingyu-mongodb

# 测试连接
docker exec -it qingyu-mongodb mongosh --eval "db.runCommand({ ping: 1 })"
```

**解决**:
```bash
# 重启MongoDB
docker restart qingyu-mongodb

# 重新初始化数据库
docker exec -it qingyu-backend go run cmd/migrate/main.go
```

### 问题3: Redis连接失败

**症状**: 会话功能异常

**排查**:
```bash
# 检查Redis是否运行
docker ps | grep redis

# 测试Redis连接
docker exec -it qingyu-redis redis-cli ping
```

**解决**:
```bash
# 重启Redis
docker restart qingyu-redis
```

### 问题4: 自动保存未触发

**症状**: 30秒后未创建版本

**排查**:
```bash
# 检查后端日志
docker logs qingyu-backend | grep AutoSave

# 检查版本服务日志
docker logs qingyu-backend | grep Version
```

**解决**:
```bash
# 重启后端服务
docker restart qingyu-backend

# 手动触发保存
# 通过API调用 PUT /api/v1/documents/{id}
```

---

## 🔄 更新与回滚

### 更新部署

```bash
# 1. 拉取最新代码
git pull origin mvp-release

# 2. 重新构建镜像
docker build -t qingyu-backend:mvp-new -f docker/Dockerfile.prod .

# 3. 停止旧服务
docker-compose -f docker/docker-compose.prod.yml down

# 4. 更新镜像标签并启动
docker tag qingyu-backend:mvp-new qingyu-backend:mvp
docker-compose -f docker/docker-compose.prod.yml up -d

# 5. 验证
curl http://localhost:8080/health
```

### 回滚部署

```bash
# 1. 停止当前服务
docker-compose -f docker/docker-compose.prod.yml down

# 2. 使用旧镜像
docker tag qingyu-backend:mvp-old qingyu-backend:mvp

# 3. 启动服务
docker-compose -f docker/docker-compose.prod.yml up -d

# 4. 验证
curl http://localhost:8080/health
```

---

## 📱 内测账号准备

### 创建测试账号

```bash
# 使用种子数据脚本创建
docker exec -it qingyu-backend go run migration/seeds/create_test_users.go
```

**内测账号列表**:
| 用户名 | 邮箱 | 密码 | 角色 |
|--------|------|------|------|
| test001 | test001@qingyu.com | Test@123456 | 普通用户 |
| test002 | test002@qingyu.com | Test@123456 | 普通用户 |
| test003 | test003@qingyu.com | Test@123456 | VIP用户 |
| test004 | test004@qingyu.com | Test@123456 | VIP用户 |
| test005 | test005@qingyu.com | Test@123456 | 作者 |
| admin001 | admin@qingyu.com | Admin@123456 | 管理员 |

---

## 🎯 内测准备清单

### 部署前

- [ ] 代码已合并到mvp-release分支
- [ ] 所有编译检查通过
- [ ] 部署准备检查通过（21/21）
- [ ] 配置文件已更新（生产环境）

### 部署中

- [ ] Docker镜像构建成功
- [ ] 服务启动成功
- [ ] 数据库初始化完成
- [ ] 健康检查通过

### 部署后

- [ ] API可访问性验证
- [ ] MVP新功能验证（密码/多端登录/自动保存）
- [ ] 核心流程冒烟测试通过
- [ ] 内测账号创建完成
- [ ] 监控日志正常

### 文档准备

- [ ] 内测指南发送给测试用户
- [ ] 问题反馈渠道已建立
- [ ] 已知限制说明文档

---

## 📞 支持与反馈

**技术支持**: tech-support@qingyu.com  
**Bug反馈**: https://github.com/qingyu/issues  
**紧急联系**: 技术负责人

---

**部署成功标准**:
1. ✅ 所有服务健康检查通过
2. ✅ MVP核心功能可用
3. ✅ 无严重错误日志
4. ✅ 内测账号可登录
5. ✅ 监控日志正常运行

**下一步**: 启动内测，收集用户反馈 🚀

