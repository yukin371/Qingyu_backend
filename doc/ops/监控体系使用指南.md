# 青羽写作后端 - 监控体系使用指南

**文档版本**: v1.0  
**最后更新**: 2025-10-27  
**适用版本**: Backend v1.0+

---

## 📋 目录

1. [监控体系概览](#监控体系概览)
2. [快速开始](#快速开始)
3. [Prometheus使用](#prometheus使用)
4. [Grafana使用](#grafana使用)
5. [告警配置](#告警配置)
6. [指标说明](#指标说明)
7. [故障排查](#故障排查)
8. [最佳实践](#最佳实践)

---

## 监控体系概览

### 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     监控体系架构                              │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────┐      ┌──────────────┐                     │
│  │   Backend    │─────►│  Prometheus  │────────┐            │
│  │  /metrics    │      │  (指标收集)   │        │            │
│  └──────────────┘      └──────────────┘        │            │
│         │                                       │            │
│         │                                       ▼            │
│         │              ┌──────────────┐   ┌───────────┐     │
│         │              │   Grafana    │◄──│  Alert   │     │
│         └─────────────►│  (可视化)     │   │ Manager  │     │
│                        └──────────────┘   └───────────┘     │
│                                                               │
│  核心组件：                                                   │
│  • Prometheus: 时序数据库，指标收集                           │
│  • Grafana: 数据可视化，Dashboard展示                        │
│  • Alertmanager: 告警管理，通知分发                          │
│  • Node Exporter: 系统指标收集                               │
└─────────────────────────────────────────────────────────────┘
```

### 核心指标分类

| 分类 | 指标类型 | 说明 |
|------|---------|------|
| **HTTP指标** | Counter, Histogram | 请求数、响应时间、状态码 |
| **服务指标** | Counter, Gauge | 调用次数、健康状态、运行时间 |
| **业务指标** | Counter, Gauge | AI配额、用户活跃度、书籍查看 |
| **资源指标** | Gauge | CPU、内存、磁盘、网络 |
| **数据库指标** | Histogram, Counter | 查询时间、连接数、错误率 |
| **Redis指标** | Counter, Histogram | 命中率、连接数、响应时间 |

---

## 快速开始

### 1. 启动监控服务

```bash
# 进入docker目录
cd docker

# 启动监控栈（Prometheus + Grafana + Alertmanager）
docker-compose -f docker-compose.monitor.yml up -d

# 查看服务状态
docker-compose -f docker-compose.monitor.yml ps

# 查看日志
docker-compose -f docker-compose.monitor.yml logs -f prometheus
```

### 2. 访问监控面板

| 服务 | URL | 默认账号 | 默认密码 |
|------|-----|---------|---------|
| **Grafana** | http://localhost:3000 | admin | admin123 |
| **Prometheus** | http://localhost:9090 | - | - |
| **Alertmanager** | http://localhost:9093 | - | - |

### 3. 验证指标收集

```bash
# 访问应用metrics端点
curl http://localhost:8080/metrics

# 检查Prometheus是否抓取成功
# 打开 http://localhost:9090/targets
# 查看 qingyu_backend target状态应该为 UP
```

---

## Prometheus使用

### 访问Prometheus UI

打开浏览器访问：`http://localhost:9090`

### 常用查询示例

#### 1. HTTP指标查询

```promql
# 每秒请求数（QPS）
rate(http_requests_total[5m])

# 按路径分组的QPS
sum(rate(http_requests_total[5m])) by (path)

# P95响应时间
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

# 错误率
rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m])

# 活跃请求数
http_active_requests
```

#### 2. AI业务指标查询

```promql
# AI配额使用率
(ai_quota_usage / ai_quota_total) * 100

# AI请求成功率
rate(ai_requests_total{status="success"}[5m]) / rate(ai_requests_total[5m])

# AI Token消耗速率
rate(ai_tokens_consumed_total[5m])

# 按模型分组的请求数
sum(rate(ai_requests_total[5m])) by (model)
```

#### 3. 资源指标查询

```promql
# CPU使用率
100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

# 内存使用率
(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100

# 磁盘使用率
(node_filesystem_size_bytes - node_filesystem_avail_bytes) / node_filesystem_size_bytes * 100
```

#### 4. 数据库指标查询

```promql
# 数据库连接数
db_connections_active + db_connections_idle

# 查询响应时间P95
histogram_quantile(0.95, rate(db_query_duration_seconds_bucket[5m]))

# 数据库错误率
rate(db_errors_total[5m])
```

### 配置文件说明

**文件位置**: `docker/prometheus/prometheus.yml`

```yaml
global:
  scrape_interval: 15s      # 全局抓取间隔
  evaluation_interval: 15s   # 评估告警规则间隔

scrape_configs:
  - job_name: 'qingyu_backend'
    static_configs:
      - targets: ['host.docker.internal:8080']
    metrics_path: '/metrics'
    scrape_interval: 10s    # 应用指标抓取间隔
```

---

## Grafana使用

### 首次登录

1. 访问 http://localhost:3000
2. 使用默认账号登录: `admin` / `admin123`
3. 修改默认密码（建议）

### 预置Dashboard

#### 1. Qingyu系统概览

**路径**: Dashboards → Qingyu系统概览

**包含面板**:
- 请求速率(QPS)
- 响应时间分位数(P50/P95/P99)
- 活跃请求数
- 成功率/错误率
- AI配额剩余量

#### 2. 创建自定义Dashboard

**步骤**:
1. 点击左侧菜单 → Dashboard → New Dashboard
2. 添加Panel
3. 选择Prometheus数据源
4. 输入PromQL查询
5. 配置图表类型和样式
6. 保存Dashboard

**示例配置**:

```json
{
  "title": "API性能监控",
  "panels": [
    {
      "title": "请求速率",
      "targets": [
        {
          "expr": "rate(http_requests_total[5m])"
        }
      ],
      "type": "graph"
    }
  ]
}
```

### 常用面板配置

#### 时序图（Time Series）

适合显示趋势数据：响应时间、请求数、CPU使用率

```promql
# 查询
rate(http_requests_total[5m])

# Legend格式
{{method}} {{path}} - {{status}}
```

#### 仪表盘（Gauge）

适合显示百分比数据：成功率、内存使用率

```promql
# 查询
rate(http_requests_total{status=~"2.."}[5m]) / rate(http_requests_total[5m]) * 100

# 阈值配置
- Green: 0-90
- Yellow: 90-95
- Red: 95-100
```

#### 数值卡片（Stat）

适合显示单一指标：当前QPS、活跃用户数

```promql
# 查询
sum(rate(http_requests_total[1m]))

# 显示配置
- Calc: Last (lastNotNull)
- Unit: ops (operations per second)
```

### 告警通知配置

**配置路径**: Alerting → Notification channels

**支持的通知方式**:
- Webhook
- Email
- Slack
- DingTalk
- WeChat

---

## 告警配置

### 告警规则

**文件位置**: `docker/prometheus/alerts.yml`

### 预置告警规则

#### 1. 服务可用性

```yaml
- alert: ServiceDown
  expr: up{job="qingyu_backend"} == 0
  for: 1m
  labels:
    severity: critical
  annotations:
    summary: "服务宕机"
    description: "服务已宕机超过1分钟"
```

#### 2. 高错误率

```yaml
- alert: HighErrorRate
  expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
  for: 5m
  labels:
    severity: warning
  annotations:
    summary: "高错误率"
    description: "5xx错误率超过5%"
```

#### 3. 响应时间过长

```yaml
- alert: HighResponseTime
  expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
  for: 5m
  labels:
    severity: warning
  annotations:
    summary: "响应时间过长"
    description: "P95响应时间超过1秒"
```

#### 4. AI配额告警

```yaml
- alert: AIQuotaLow
  expr: ai_quota_remaining / ai_quota_total < 0.1
  for: 5m
  labels:
    severity: warning
  annotations:
    summary: "AI配额不足"
    description: "配额剩余低于10%"
```

### Alertmanager配置

**文件位置**: `docker/alertmanager/alertmanager.yml`

#### 告警分级

| 级别 | 描述 | 响应时间 | 通知频率 |
|------|------|---------|---------|
| **critical** | 严重告警 | 立即 | 4小时 |
| **warning** | 警告告警 | 30秒内 | 12小时 |
| **info** | 信息告警 | 5分钟内 | 24小时 |

#### Webhook接收器配置

```yaml
receivers:
  - name: 'webhook'
    webhook_configs:
      - url: 'http://qingyu_backend:8080/api/v1/webhook/alert'
        send_resolved: true
```

---

## 指标说明

### HTTP指标

| 指标名称 | 类型 | 说明 | Labels |
|---------|------|------|--------|
| `http_requests_total` | Counter | HTTP请求总数 | method, path, status |
| `http_request_duration_seconds` | Histogram | 请求响应时间 | method, path |
| `http_request_size_bytes` | Histogram | 请求大小 | method, path |
| `http_response_size_bytes` | Histogram | 响应大小 | method, path |
| `http_active_requests` | Gauge | 活跃请求数 | - |

### AI业务指标

| 指标名称 | 类型 | 说明 | Labels |
|---------|------|------|--------|
| `ai_quota_total` | Gauge | AI配额总量 | user_id, quota_type |
| `ai_quota_usage` | Gauge | AI配额使用量 | user_id, quota_type |
| `ai_quota_remaining` | Gauge | AI配额剩余量 | user_id, quota_type |
| `ai_requests_total` | Counter | AI请求总数 | service, model, status |
| `ai_request_duration_seconds` | Histogram | AI请求响应时间 | service, model |
| `ai_tokens_consumed_total` | Counter | Token消耗总数 | user_id, model |

### 服务指标

| 指标名称 | 类型 | 说明 | Labels |
|---------|------|------|--------|
| `service_health_status` | Gauge | 服务健康状态 | service, version |
| `service_uptime_seconds` | Gauge | 服务运行时间 | service |
| `service_call_total` | Counter | 服务调用总数 | service, method, status |
| `service_call_duration_seconds` | Histogram | 服务调用响应时间 | service, method |
| `service_errors_total` | Counter | 服务错误总数 | service, error_type |

### 数据库指标

| 指标名称 | 类型 | 说明 | Labels |
|---------|------|------|--------|
| `db_connections_active` | Gauge | 活跃连接数 | - |
| `db_connections_idle` | Gauge | 空闲连接数 | - |
| `db_query_duration_seconds` | Histogram | 查询响应时间 | operation, collection |
| `db_query_total` | Counter | 查询总数 | operation, collection, status |
| `db_errors_total` | Counter | 数据库错误总数 | operation, error_type |

### Redis指标

| 指标名称 | 类型 | 说明 | Labels |
|---------|------|------|--------|
| `redis_hits_total` | Counter | 缓存命中总数 | - |
| `redis_misses_total` | Counter | 缓存未命中总数 | - |
| `redis_connections` | Gauge | Redis连接数 | - |
| `redis_command_duration_seconds` | Histogram | 命令响应时间 | command |

---

## 故障排查

### 常见问题

#### 1. Prometheus无法抓取应用指标

**症状**:
- Targets页面显示 `DOWN`
- 错误信息：`context deadline exceeded`

**解决方案**:
```bash
# 检查应用是否启动
curl http://localhost:8080/metrics

# 检查网络连接
docker exec qingyu_prometheus ping host.docker.internal

# 检查配置文件
docker exec qingyu_prometheus cat /etc/prometheus/prometheus.yml
```

#### 2. Grafana无法连接Prometheus

**症状**:
- Dashboard显示 `No data`
- 数据源测试失败

**解决方案**:
```bash
# 检查Prometheus服务
docker logs qingyu_prometheus

# 检查数据源配置
# Grafana → Configuration → Data Sources → Prometheus
# URL应该是: http://prometheus:9090
```

#### 3. 告警未触发

**症状**:
- 指标超过阈值但没有收到告警

**解决方案**:
```bash
# 检查告警规则是否加载
curl http://localhost:9090/api/v1/rules

# 检查Alertmanager
docker logs qingyu_alertmanager

# 验证告警规则语法
promtool check rules docker/prometheus/alerts.yml
```

---

## 最佳实践

### 1. 指标设计原则

✅ **DO**:
- 使用有意义的指标名称
- 限制label的基数（避免用户ID等高基数label）
- 使用适当的指标类型（Counter vs Gauge vs Histogram）
- 为指标添加help文档

❌ **DON'T**:
- 不要在label中使用动态值（如时间戳）
- 不要创建过多的指标（会影响性能）
- 不要在指标名称中包含label信息

### 2. Dashboard设计原则

- **遵循RED原则**（Request rate, Error rate, Duration）
- **分层展示**：从系统概览到具体服务
- **合理使用变量**：支持动态切换时间范围、服务等
- **添加说明文档**：每个面板添加描述信息

### 3. 告警设置原则

- **避免告警疲劳**：只设置重要告警
- **合理设置阈值**：基于历史数据分析
- **告警分级**：critical/warning/info
- **添加上下文**：告警描述中包含足够的信息

### 4. 性能优化

- **优化查询**：使用rate()而不是irate()做趋势分析
- **控制抓取频率**：根据实际需求设置scrape_interval
- **使用recording rules**：预计算复杂查询
- **定期清理数据**：设置retention period

### 5. 数据保留策略

```yaml
# prometheus.yml
storage:
  tsdb:
    retention.time: 30d     # 保留30天数据
    retention.size: 10GB    # 或限制总大小
```

---

## 附录

### A. 常用PromQL函数

| 函数 | 说明 | 示例 |
|------|------|------|
| `rate()` | 计算速率 | `rate(http_requests_total[5m])` |
| `irate()` | 瞬时速率 | `irate(http_requests_total[1m])` |
| `sum()` | 求和 | `sum(http_requests_total)` |
| `avg()` | 平均值 | `avg(http_request_duration_seconds)` |
| `histogram_quantile()` | 分位数 | `histogram_quantile(0.95, ...)` |
| `increase()` | 增量 | `increase(http_requests_total[1h])` |

### B. 快速命令参考

```bash
# 启动监控栈
docker-compose -f docker-compose.monitor.yml up -d

# 停止监控栈
docker-compose -f docker-compose.monitor.yml down

# 重启Prometheus（重新加载配置）
docker-compose -f docker-compose.monitor.yml restart prometheus

# 查看日志
docker-compose -f docker-compose.monitor.yml logs -f

# 导出Grafana Dashboard
curl -u admin:admin123 http://localhost:3000/api/dashboards/uid/qingyu_overview > dashboard.json

# 导入Grafana Dashboard
curl -u admin:admin123 -H "Content-Type: application/json" -d @dashboard.json http://localhost:3000/api/dashboards/db
```

### C. 相关链接

- [Prometheus官方文档](https://prometheus.io/docs/)
- [Grafana官方文档](https://grafana.com/docs/)
- [PromQL教程](https://prometheus.io/docs/prometheus/latest/querying/basics/)
- [Alertmanager配置](https://prometheus.io/docs/alerting/latest/configuration/)

---

**文档维护**: 青羽后端团队  
**技术支持**: 如有问题请提Issue或联系运维团队

