# é’ç¾½å†™ä½œåç«¯ - ç›‘æ§ä½“ç³»ä½¿ç”¨æŒ‡å—

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-10-27  
**é€‚ç”¨ç‰ˆæœ¬**: Backend v1.0+

---

## ğŸ“‹ ç›®å½•

1. [ç›‘æ§ä½“ç³»æ¦‚è§ˆ](#ç›‘æ§ä½“ç³»æ¦‚è§ˆ)
2. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
3. [Prometheusä½¿ç”¨](#prometheusä½¿ç”¨)
4. [Grafanaä½¿ç”¨](#grafanaä½¿ç”¨)
5. [å‘Šè­¦é…ç½®](#å‘Šè­¦é…ç½®)
6. [æŒ‡æ ‡è¯´æ˜](#æŒ‡æ ‡è¯´æ˜)
7. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
8. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ç›‘æ§ä½“ç³»æ¦‚è§ˆ

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç›‘æ§ä½“ç³»æ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚   Backend    â”‚â”€â”€â”€â”€â”€â–ºâ”‚  Prometheus  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  /metrics    â”‚      â”‚  (æŒ‡æ ‡æ”¶é›†)   â”‚        â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚            â”‚
â”‚         â”‚                                       â”‚            â”‚
â”‚         â”‚                                       â–¼            â”‚
â”‚         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚         â”‚              â”‚   Grafana    â”‚â—„â”€â”€â”‚  Alert   â”‚     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  (å¯è§†åŒ–)     â”‚   â”‚ Manager  â”‚     â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                               â”‚
â”‚  æ ¸å¿ƒç»„ä»¶ï¼š                                                   â”‚
â”‚  â€¢ Prometheus: æ—¶åºæ•°æ®åº“ï¼ŒæŒ‡æ ‡æ”¶é›†                           â”‚
â”‚  â€¢ Grafana: æ•°æ®å¯è§†åŒ–ï¼ŒDashboardå±•ç¤º                        â”‚
â”‚  â€¢ Alertmanager: å‘Šè­¦ç®¡ç†ï¼Œé€šçŸ¥åˆ†å‘                          â”‚
â”‚  â€¢ Node Exporter: ç³»ç»ŸæŒ‡æ ‡æ”¶é›†                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæŒ‡æ ‡åˆ†ç±»

| åˆ†ç±» | æŒ‡æ ‡ç±»å‹ | è¯´æ˜ |
|------|---------|------|
| **HTTPæŒ‡æ ‡** | Counter, Histogram | è¯·æ±‚æ•°ã€å“åº”æ—¶é—´ã€çŠ¶æ€ç  |
| **æœåŠ¡æŒ‡æ ‡** | Counter, Gauge | è°ƒç”¨æ¬¡æ•°ã€å¥åº·çŠ¶æ€ã€è¿è¡Œæ—¶é—´ |
| **ä¸šåŠ¡æŒ‡æ ‡** | Counter, Gauge | AIé…é¢ã€ç”¨æˆ·æ´»è·ƒåº¦ã€ä¹¦ç±æŸ¥çœ‹ |
| **èµ„æºæŒ‡æ ‡** | Gauge | CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ |
| **æ•°æ®åº“æŒ‡æ ‡** | Histogram, Counter | æŸ¥è¯¢æ—¶é—´ã€è¿æ¥æ•°ã€é”™è¯¯ç‡ |
| **RedisæŒ‡æ ‡** | Counter, Histogram | å‘½ä¸­ç‡ã€è¿æ¥æ•°ã€å“åº”æ—¶é—´ |

---

## å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨ç›‘æ§æœåŠ¡

```bash
# è¿›å…¥dockerç›®å½•
cd docker

# å¯åŠ¨ç›‘æ§æ ˆï¼ˆPrometheus + Grafana + Alertmanagerï¼‰
docker-compose -f docker-compose.monitor.yml up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.monitor.yml ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.monitor.yml logs -f prometheus
```

### 2. è®¿é—®ç›‘æ§é¢æ¿

| æœåŠ¡ | URL | é»˜è®¤è´¦å· | é»˜è®¤å¯†ç  |
|------|-----|---------|---------|
| **Grafana** | http://localhost:3000 | admin | admin123 |
| **Prometheus** | http://localhost:9090 | - | - |
| **Alertmanager** | http://localhost:9093 | - | - |

### 3. éªŒè¯æŒ‡æ ‡æ”¶é›†

```bash
# è®¿é—®åº”ç”¨metricsç«¯ç‚¹
curl http://localhost:8080/metrics

# æ£€æŸ¥Prometheusæ˜¯å¦æŠ“å–æˆåŠŸ
# æ‰“å¼€ http://localhost:9090/targets
# æŸ¥çœ‹ qingyu_backend targetçŠ¶æ€åº”è¯¥ä¸º UP
```

---

## Prometheusä½¿ç”¨

### è®¿é—®Prometheus UI

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:9090`

### å¸¸ç”¨æŸ¥è¯¢ç¤ºä¾‹

#### 1. HTTPæŒ‡æ ‡æŸ¥è¯¢

```promql
# æ¯ç§’è¯·æ±‚æ•°ï¼ˆQPSï¼‰
rate(http_requests_total[5m])

# æŒ‰è·¯å¾„åˆ†ç»„çš„QPS
sum(rate(http_requests_total[5m])) by (path)

# P95å“åº”æ—¶é—´
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

# é”™è¯¯ç‡
rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m])

# æ´»è·ƒè¯·æ±‚æ•°
http_active_requests
```

#### 2. AIä¸šåŠ¡æŒ‡æ ‡æŸ¥è¯¢

```promql
# AIé…é¢ä½¿ç”¨ç‡
(ai_quota_usage / ai_quota_total) * 100

# AIè¯·æ±‚æˆåŠŸç‡
rate(ai_requests_total{status="success"}[5m]) / rate(ai_requests_total[5m])

# AI Tokenæ¶ˆè€—é€Ÿç‡
rate(ai_tokens_consumed_total[5m])

# æŒ‰æ¨¡å‹åˆ†ç»„çš„è¯·æ±‚æ•°
sum(rate(ai_requests_total[5m])) by (model)
```

#### 3. èµ„æºæŒ‡æ ‡æŸ¥è¯¢

```promql
# CPUä½¿ç”¨ç‡
100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

# å†…å­˜ä½¿ç”¨ç‡
(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100

# ç£ç›˜ä½¿ç”¨ç‡
(node_filesystem_size_bytes - node_filesystem_avail_bytes) / node_filesystem_size_bytes * 100
```

#### 4. æ•°æ®åº“æŒ‡æ ‡æŸ¥è¯¢

```promql
# æ•°æ®åº“è¿æ¥æ•°
db_connections_active + db_connections_idle

# æŸ¥è¯¢å“åº”æ—¶é—´P95
histogram_quantile(0.95, rate(db_query_duration_seconds_bucket[5m]))

# æ•°æ®åº“é”™è¯¯ç‡
rate(db_errors_total[5m])
```

### é…ç½®æ–‡ä»¶è¯´æ˜

**æ–‡ä»¶ä½ç½®**: `docker/prometheus/prometheus.yml`

```yaml
global:
  scrape_interval: 15s      # å…¨å±€æŠ“å–é—´éš”
  evaluation_interval: 15s   # è¯„ä¼°å‘Šè­¦è§„åˆ™é—´éš”

scrape_configs:
  - job_name: 'qingyu_backend'
    static_configs:
      - targets: ['host.docker.internal:8080']
    metrics_path: '/metrics'
    scrape_interval: 10s    # åº”ç”¨æŒ‡æ ‡æŠ“å–é—´éš”
```

---

## Grafanaä½¿ç”¨

### é¦–æ¬¡ç™»å½•

1. è®¿é—® http://localhost:3000
2. ä½¿ç”¨é»˜è®¤è´¦å·ç™»å½•: `admin` / `admin123`
3. ä¿®æ”¹é»˜è®¤å¯†ç ï¼ˆå»ºè®®ï¼‰

### é¢„ç½®Dashboard

#### 1. Qingyuç³»ç»Ÿæ¦‚è§ˆ

**è·¯å¾„**: Dashboards â†’ Qingyuç³»ç»Ÿæ¦‚è§ˆ

**åŒ…å«é¢æ¿**:
- è¯·æ±‚é€Ÿç‡(QPS)
- å“åº”æ—¶é—´åˆ†ä½æ•°(P50/P95/P99)
- æ´»è·ƒè¯·æ±‚æ•°
- æˆåŠŸç‡/é”™è¯¯ç‡
- AIé…é¢å‰©ä½™é‡

#### 2. åˆ›å»ºè‡ªå®šä¹‰Dashboard

**æ­¥éª¤**:
1. ç‚¹å‡»å·¦ä¾§èœå• â†’ Dashboard â†’ New Dashboard
2. æ·»åŠ Panel
3. é€‰æ‹©Prometheusæ•°æ®æº
4. è¾“å…¥PromQLæŸ¥è¯¢
5. é…ç½®å›¾è¡¨ç±»å‹å’Œæ ·å¼
6. ä¿å­˜Dashboard

**ç¤ºä¾‹é…ç½®**:

```json
{
  "title": "APIæ€§èƒ½ç›‘æ§",
  "panels": [
    {
      "title": "è¯·æ±‚é€Ÿç‡",
      "targets": [
        {
          "expr": "rate(http_requests_total[5m])"
        }
      ],
      "type": "graph"
    }
  ]
}
```

### å¸¸ç”¨é¢æ¿é…ç½®

#### æ—¶åºå›¾ï¼ˆTime Seriesï¼‰

é€‚åˆæ˜¾ç¤ºè¶‹åŠ¿æ•°æ®ï¼šå“åº”æ—¶é—´ã€è¯·æ±‚æ•°ã€CPUä½¿ç”¨ç‡

```promql
# æŸ¥è¯¢
rate(http_requests_total[5m])

# Legendæ ¼å¼
{{method}} {{path}} - {{status}}
```

#### ä»ªè¡¨ç›˜ï¼ˆGaugeï¼‰

é€‚åˆæ˜¾ç¤ºç™¾åˆ†æ¯”æ•°æ®ï¼šæˆåŠŸç‡ã€å†…å­˜ä½¿ç”¨ç‡

```promql
# æŸ¥è¯¢
rate(http_requests_total{status=~"2.."}[5m]) / rate(http_requests_total[5m]) * 100

# é˜ˆå€¼é…ç½®
- Green: 0-90
- Yellow: 90-95
- Red: 95-100
```

#### æ•°å€¼å¡ç‰‡ï¼ˆStatï¼‰

é€‚åˆæ˜¾ç¤ºå•ä¸€æŒ‡æ ‡ï¼šå½“å‰QPSã€æ´»è·ƒç”¨æˆ·æ•°

```promql
# æŸ¥è¯¢
sum(rate(http_requests_total[1m]))

# æ˜¾ç¤ºé…ç½®
- Calc: Last (lastNotNull)
- Unit: ops (operations per second)
```

### å‘Šè­¦é€šçŸ¥é…ç½®

**é…ç½®è·¯å¾„**: Alerting â†’ Notification channels

**æ”¯æŒçš„é€šçŸ¥æ–¹å¼**:
- Webhook
- Email
- Slack
- DingTalk
- WeChat

---

## å‘Šè­¦é…ç½®

### å‘Šè­¦è§„åˆ™

**æ–‡ä»¶ä½ç½®**: `docker/prometheus/alerts.yml`

### é¢„ç½®å‘Šè­¦è§„åˆ™

#### 1. æœåŠ¡å¯ç”¨æ€§

```yaml
- alert: ServiceDown
  expr: up{job="qingyu_backend"} == 0
  for: 1m
  labels:
    severity: critical
  annotations:
    summary: "æœåŠ¡å®•æœº"
    description: "æœåŠ¡å·²å®•æœºè¶…è¿‡1åˆ†é’Ÿ"
```

#### 2. é«˜é”™è¯¯ç‡

```yaml
- alert: HighErrorRate
  expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
  for: 5m
  labels:
    severity: warning
  annotations:
    summary: "é«˜é”™è¯¯ç‡"
    description: "5xxé”™è¯¯ç‡è¶…è¿‡5%"
```

#### 3. å“åº”æ—¶é—´è¿‡é•¿

```yaml
- alert: HighResponseTime
  expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
  for: 5m
  labels:
    severity: warning
  annotations:
    summary: "å“åº”æ—¶é—´è¿‡é•¿"
    description: "P95å“åº”æ—¶é—´è¶…è¿‡1ç§’"
```

#### 4. AIé…é¢å‘Šè­¦

```yaml
- alert: AIQuotaLow
  expr: ai_quota_remaining / ai_quota_total < 0.1
  for: 5m
  labels:
    severity: warning
  annotations:
    summary: "AIé…é¢ä¸è¶³"
    description: "é…é¢å‰©ä½™ä½äº10%"
```

### Alertmanageré…ç½®

**æ–‡ä»¶ä½ç½®**: `docker/alertmanager/alertmanager.yml`

#### å‘Šè­¦åˆ†çº§

| çº§åˆ« | æè¿° | å“åº”æ—¶é—´ | é€šçŸ¥é¢‘ç‡ |
|------|------|---------|---------|
| **critical** | ä¸¥é‡å‘Šè­¦ | ç«‹å³ | 4å°æ—¶ |
| **warning** | è­¦å‘Šå‘Šè­¦ | 30ç§’å†… | 12å°æ—¶ |
| **info** | ä¿¡æ¯å‘Šè­¦ | 5åˆ†é’Ÿå†… | 24å°æ—¶ |

#### Webhookæ¥æ”¶å™¨é…ç½®

```yaml
receivers:
  - name: 'webhook'
    webhook_configs:
      - url: 'http://qingyu_backend:8080/api/v1/webhook/alert'
        send_resolved: true
```

---

## æŒ‡æ ‡è¯´æ˜

### HTTPæŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | è¯´æ˜ | Labels |
|---------|------|------|--------|
| `http_requests_total` | Counter | HTTPè¯·æ±‚æ€»æ•° | method, path, status |
| `http_request_duration_seconds` | Histogram | è¯·æ±‚å“åº”æ—¶é—´ | method, path |
| `http_request_size_bytes` | Histogram | è¯·æ±‚å¤§å° | method, path |
| `http_response_size_bytes` | Histogram | å“åº”å¤§å° | method, path |
| `http_active_requests` | Gauge | æ´»è·ƒè¯·æ±‚æ•° | - |

### AIä¸šåŠ¡æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | è¯´æ˜ | Labels |
|---------|------|------|--------|
| `ai_quota_total` | Gauge | AIé…é¢æ€»é‡ | user_id, quota_type |
| `ai_quota_usage` | Gauge | AIé…é¢ä½¿ç”¨é‡ | user_id, quota_type |
| `ai_quota_remaining` | Gauge | AIé…é¢å‰©ä½™é‡ | user_id, quota_type |
| `ai_requests_total` | Counter | AIè¯·æ±‚æ€»æ•° | service, model, status |
| `ai_request_duration_seconds` | Histogram | AIè¯·æ±‚å“åº”æ—¶é—´ | service, model |
| `ai_tokens_consumed_total` | Counter | Tokenæ¶ˆè€—æ€»æ•° | user_id, model |

### æœåŠ¡æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | è¯´æ˜ | Labels |
|---------|------|------|--------|
| `service_health_status` | Gauge | æœåŠ¡å¥åº·çŠ¶æ€ | service, version |
| `service_uptime_seconds` | Gauge | æœåŠ¡è¿è¡Œæ—¶é—´ | service |
| `service_call_total` | Counter | æœåŠ¡è°ƒç”¨æ€»æ•° | service, method, status |
| `service_call_duration_seconds` | Histogram | æœåŠ¡è°ƒç”¨å“åº”æ—¶é—´ | service, method |
| `service_errors_total` | Counter | æœåŠ¡é”™è¯¯æ€»æ•° | service, error_type |

### æ•°æ®åº“æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | è¯´æ˜ | Labels |
|---------|------|------|--------|
| `db_connections_active` | Gauge | æ´»è·ƒè¿æ¥æ•° | - |
| `db_connections_idle` | Gauge | ç©ºé—²è¿æ¥æ•° | - |
| `db_query_duration_seconds` | Histogram | æŸ¥è¯¢å“åº”æ—¶é—´ | operation, collection |
| `db_query_total` | Counter | æŸ¥è¯¢æ€»æ•° | operation, collection, status |
| `db_errors_total` | Counter | æ•°æ®åº“é”™è¯¯æ€»æ•° | operation, error_type |

### RedisæŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | è¯´æ˜ | Labels |
|---------|------|------|--------|
| `redis_hits_total` | Counter | ç¼“å­˜å‘½ä¸­æ€»æ•° | - |
| `redis_misses_total` | Counter | ç¼“å­˜æœªå‘½ä¸­æ€»æ•° | - |
| `redis_connections` | Gauge | Redisè¿æ¥æ•° | - |
| `redis_command_duration_seconds` | Histogram | å‘½ä»¤å“åº”æ—¶é—´ | command |

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. Prometheusæ— æ³•æŠ“å–åº”ç”¨æŒ‡æ ‡

**ç—‡çŠ¶**:
- Targetsé¡µé¢æ˜¾ç¤º `DOWN`
- é”™è¯¯ä¿¡æ¯ï¼š`context deadline exceeded`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥åº”ç”¨æ˜¯å¦å¯åŠ¨
curl http://localhost:8080/metrics

# æ£€æŸ¥ç½‘ç»œè¿æ¥
docker exec qingyu_prometheus ping host.docker.internal

# æ£€æŸ¥é…ç½®æ–‡ä»¶
docker exec qingyu_prometheus cat /etc/prometheus/prometheus.yml
```

#### 2. Grafanaæ— æ³•è¿æ¥Prometheus

**ç—‡çŠ¶**:
- Dashboardæ˜¾ç¤º `No data`
- æ•°æ®æºæµ‹è¯•å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥PrometheusæœåŠ¡
docker logs qingyu_prometheus

# æ£€æŸ¥æ•°æ®æºé…ç½®
# Grafana â†’ Configuration â†’ Data Sources â†’ Prometheus
# URLåº”è¯¥æ˜¯: http://prometheus:9090
```

#### 3. å‘Šè­¦æœªè§¦å‘

**ç—‡çŠ¶**:
- æŒ‡æ ‡è¶…è¿‡é˜ˆå€¼ä½†æ²¡æœ‰æ”¶åˆ°å‘Šè­¦

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥å‘Šè­¦è§„åˆ™æ˜¯å¦åŠ è½½
curl http://localhost:9090/api/v1/rules

# æ£€æŸ¥Alertmanager
docker logs qingyu_alertmanager

# éªŒè¯å‘Šè­¦è§„åˆ™è¯­æ³•
promtool check rules docker/prometheus/alerts.yml
```

---

## æœ€ä½³å®è·µ

### 1. æŒ‡æ ‡è®¾è®¡åŸåˆ™

âœ… **DO**:
- ä½¿ç”¨æœ‰æ„ä¹‰çš„æŒ‡æ ‡åç§°
- é™åˆ¶labelçš„åŸºæ•°ï¼ˆé¿å…ç”¨æˆ·IDç­‰é«˜åŸºæ•°labelï¼‰
- ä½¿ç”¨é€‚å½“çš„æŒ‡æ ‡ç±»å‹ï¼ˆCounter vs Gauge vs Histogramï¼‰
- ä¸ºæŒ‡æ ‡æ·»åŠ helpæ–‡æ¡£

âŒ **DON'T**:
- ä¸è¦åœ¨labelä¸­ä½¿ç”¨åŠ¨æ€å€¼ï¼ˆå¦‚æ—¶é—´æˆ³ï¼‰
- ä¸è¦åˆ›å»ºè¿‡å¤šçš„æŒ‡æ ‡ï¼ˆä¼šå½±å“æ€§èƒ½ï¼‰
- ä¸è¦åœ¨æŒ‡æ ‡åç§°ä¸­åŒ…å«labelä¿¡æ¯

### 2. Dashboardè®¾è®¡åŸåˆ™

- **éµå¾ªREDåŸåˆ™**ï¼ˆRequest rate, Error rate, Durationï¼‰
- **åˆ†å±‚å±•ç¤º**ï¼šä»ç³»ç»Ÿæ¦‚è§ˆåˆ°å…·ä½“æœåŠ¡
- **åˆç†ä½¿ç”¨å˜é‡**ï¼šæ”¯æŒåŠ¨æ€åˆ‡æ¢æ—¶é—´èŒƒå›´ã€æœåŠ¡ç­‰
- **æ·»åŠ è¯´æ˜æ–‡æ¡£**ï¼šæ¯ä¸ªé¢æ¿æ·»åŠ æè¿°ä¿¡æ¯

### 3. å‘Šè­¦è®¾ç½®åŸåˆ™

- **é¿å…å‘Šè­¦ç–²åŠ³**ï¼šåªè®¾ç½®é‡è¦å‘Šè­¦
- **åˆç†è®¾ç½®é˜ˆå€¼**ï¼šåŸºäºå†å²æ•°æ®åˆ†æ
- **å‘Šè­¦åˆ†çº§**ï¼šcritical/warning/info
- **æ·»åŠ ä¸Šä¸‹æ–‡**ï¼šå‘Šè­¦æè¿°ä¸­åŒ…å«è¶³å¤Ÿçš„ä¿¡æ¯

### 4. æ€§èƒ½ä¼˜åŒ–

- **ä¼˜åŒ–æŸ¥è¯¢**ï¼šä½¿ç”¨rate()è€Œä¸æ˜¯irate()åšè¶‹åŠ¿åˆ†æ
- **æ§åˆ¶æŠ“å–é¢‘ç‡**ï¼šæ ¹æ®å®é™…éœ€æ±‚è®¾ç½®scrape_interval
- **ä½¿ç”¨recording rules**ï¼šé¢„è®¡ç®—å¤æ‚æŸ¥è¯¢
- **å®šæœŸæ¸…ç†æ•°æ®**ï¼šè®¾ç½®retention period

### 5. æ•°æ®ä¿ç•™ç­–ç•¥

```yaml
# prometheus.yml
storage:
  tsdb:
    retention.time: 30d     # ä¿ç•™30å¤©æ•°æ®
    retention.size: 10GB    # æˆ–é™åˆ¶æ€»å¤§å°
```

---

## é™„å½•

### A. å¸¸ç”¨PromQLå‡½æ•°

| å‡½æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `rate()` | è®¡ç®—é€Ÿç‡ | `rate(http_requests_total[5m])` |
| `irate()` | ç¬æ—¶é€Ÿç‡ | `irate(http_requests_total[1m])` |
| `sum()` | æ±‚å’Œ | `sum(http_requests_total)` |
| `avg()` | å¹³å‡å€¼ | `avg(http_request_duration_seconds)` |
| `histogram_quantile()` | åˆ†ä½æ•° | `histogram_quantile(0.95, ...)` |
| `increase()` | å¢é‡ | `increase(http_requests_total[1h])` |

### B. å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# å¯åŠ¨ç›‘æ§æ ˆ
docker-compose -f docker-compose.monitor.yml up -d

# åœæ­¢ç›‘æ§æ ˆ
docker-compose -f docker-compose.monitor.yml down

# é‡å¯Prometheusï¼ˆé‡æ–°åŠ è½½é…ç½®ï¼‰
docker-compose -f docker-compose.monitor.yml restart prometheus

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.monitor.yml logs -f

# å¯¼å‡ºGrafana Dashboard
curl -u admin:admin123 http://localhost:3000/api/dashboards/uid/qingyu_overview > dashboard.json

# å¯¼å…¥Grafana Dashboard
curl -u admin:admin123 -H "Content-Type: application/json" -d @dashboard.json http://localhost:3000/api/dashboards/db
```

### C. ç›¸å…³é“¾æ¥

- [Prometheuså®˜æ–¹æ–‡æ¡£](https://prometheus.io/docs/)
- [Grafanaå®˜æ–¹æ–‡æ¡£](https://grafana.com/docs/)
- [PromQLæ•™ç¨‹](https://prometheus.io/docs/prometheus/latest/querying/basics/)
- [Alertmanageré…ç½®](https://prometheus.io/docs/alerting/latest/configuration/)

---

**æ–‡æ¡£ç»´æŠ¤**: é’ç¾½åç«¯å›¢é˜Ÿ  
**æŠ€æœ¯æ”¯æŒ**: å¦‚æœ‰é—®é¢˜è¯·æIssueæˆ–è”ç³»è¿ç»´å›¢é˜Ÿ

