# 软件需求规格说明书 (SRS) v2.0

> **文档版本**: v2.0  
> **最后更新**: 2025-10-06  
> **项目名称**: 青羽一站式阅读写作平台后端服务  
> **英文名称**: Qingyu Backend Service

## 1. 引言

### 1.1 目的

本文档详细定义青羽一站式阅读写作平台后端服务的功能性和非功能性需求，为系统设计、开发、测试和验收提供基准和依据。

### 1.2 范围

本文档涵盖青羽平台后端服务的所有核心功能模块，包括：
- 阅读端模块（书城、阅读器、推荐、社交）
- 写作端模块（编辑器、项目管理、AI助手、数据分析）
- AI服务模块（多提供商适配、Agent系统、智能对话）
- 用户中心模块（用户管理、角色权限、用户等级）
- 共享服务模块（通知、存储、搜索、支付）
- 基础设施模块（认证、中间件、配置、监控）

### 1.3 参考文档

- [青羽平台模块化架构设计v2.0](../design/青羽平台模块化架构设计v2.0.md)
- [项目开发规则v2.0](../../.cursor/rules/qingyubackend.mdc)
- [架构设计规范](../architecture/架构设计规范.md)
- [Repository层设计规范](../architecture/repository层设计规范.md)
- [需求分析文档](./需求分析文档.md)

### 1.4 术语和缩写

| 术语 | 定义 |
|------|------|
| SRS | Software Requirements Specification（软件需求规格说明书） |
| MVP | Minimum Viable Product（最小可行产品） |
| RBAC | Role-Based Access Control（基于角色的访问控制） |
| AI Agent | 智能代理，具备自主决策和工具调用能力的AI系统 |
| Repository | 数据访问层，封装数据库操作的抽象层 |
| Service | 业务逻辑层，处理业务规则和流程 |
| JWT | JSON Web Token（JSON Web令牌） |

---

## 2. 总体描述

### 2.1 产品视角

青羽平台是一个集阅读和写作于一体的综合性内容创作平台，为读者提供优质阅读体验，为作者提供专业创作工具。

**产品定位**：
- 🎯 **核心价值**：AI赋能的一站式内容创作平台
- 💡 **核心理念**：让写作和阅读都更简单、更易用
- 📖 **阅读端**：个性化推荐、社交互动、任务激励、AI阅读助手
- ✍️ **写作端**：智能辅助、版本管理、数据分析、AI创作助手
- 🤖 **AI驱动**：多模型支持、Agent协作、普惠使用、按需付费

**产品策略**：
- ✅ **降低门槛**：所有用户都能使用AI服务（免费额度+付费扩展）
- ✅ **灵活付费**：按量付费、月卡季卡、签约免费等多种模式
- ✅ **公平普惠**：新手作者也能享受AI赋能，不设门槛
- ✅ **质量导向**：通过作品质量和数据表现获得更多权益

### 2.2 产品功能

```
青羽一站式平台
├── 📖 阅读端
│   ├── 书城系统（浏览、搜索、榜单）
│   ├── 阅读器（章节阅读、进度同步、书签笔记）
│   ├── 推荐系统（个性化推荐、用户画像）
│   ├── 社交系统（评论、关注、书圈）
│   └── 任务系统（打卡、任务、成就）
│
├── ✍️ 写作端
│   ├── 编辑器（双模式、协作、版本控制）
│   ├── 项目管理（文档树、大纲、协作者）
│   ├── 设定百科（角色、地图、时间线）
│   ├── AI助手（续写、改写、创意辅助）
│   ├── 内容审核（敏感词、合规检查）
│   ├── 数据统计（阅读数据、读者画像）
│   └── 稿费结算（收入管理、提现）
│
├── 🤖 AI服务
│   ├── 多提供商适配（OpenAI、Claude、国产AI）
│   ├── Agent系统（专业Agent、工具调用）
│   ├── 智能对话（上下文管理、流式响应）
│   └── 配额管理（成本控制、使用统计）
│
├── 👤 用户中心
│   ├── 用户管理（注册登录、多端同步）
│   ├── 角色权限（RBAC、权限继承）
│   └── 用户等级（等级体系、特权系统）
│
└── 🔗 共享服务
    ├── 消息通知（多渠道推送）
    ├── 文件存储（OSS、CDN）
    ├── 搜索服务（全文搜索）
    ├── 钱包服务（代币、支付）
    └── 管理后台（平台管理）
```

### 2.3 用户角色

**核心理念**：让写作和阅读都更简单、更易用 🎯

#### 2.3.1 读者角色

| 角色 | 描述 | 基础权益 | 付费增值 |
|------|------|----------|----------|
| **游客** | 未注册用户 | 浏览书城、查看书籍简介、试读前3章 | - |
| **普通读者** | 注册用户 | 完整阅读、评论、收藏、打卡<br>每日5次免费AI问答 | 购买章节<br>订阅VIP |
| **VIP读者** | 付费会员 | 所有普通读者权益<br>全站免广告、优先阅读新章<br>每日50次免费AI问答<br>专属徽章和标识 | 高级AI服务<br>作者专属福利 |

#### 2.3.2 作者角色

| 角色 | 描述 | 基础权益 | AI服务权益 |
|------|------|----------|-----------|
| **新手作者** | 写作新手 | 基础编辑器、项目管理<br>每日10次免费AI辅助（续写/改写）<br>基础数据统计 | ✅ **可付费购买AI服务包**<br>• 按量付费：0.1元/千Token<br>• 月卡：29元（10万Token）<br>• 季卡：79元（30万Token） |
| **签约作者** | 平台签约 | 所有新手作者权益<br>每日100次免费AI辅助<br>高级数据分析<br>平台推荐位<br>专属编辑支持 | ✅ **享受8折优惠**<br>• 按量付费：0.08元/千Token<br>• 月卡：23元<br>• 额外赠送20%配额 |
| **大神作者** | 顶级作者 | 所有签约作者权益<br>无限AI辅助（平台免费）<br>AI Agent深度定制<br>独立推荐频道<br>专属运营团队 | ✅ **全部AI服务免费**<br>• 包括高级Agent功能<br>• 优先使用最新模型<br>• 专属模型微调 |

#### 2.3.3 管理角色

| 角色 | 描述 | 主要权限 |
|------|------|----------|
| **内容审核员** | 内容审核 | 内容审核、评论管理、举报处理 |
| **运营专员** | 平台运营 | Banner配置、活动管理、数据分析 |
| **平台管理员** | 综合管理 | 用户管理、内容管理、数据统计、系统配置 |
| **超级管理员** | 系统管理 | 全部权限、系统核心配置、安全管理 |

#### 2.3.4 角色升级路径

```
读者路径：游客 → 普通读者 → VIP读者
                ↓
作者路径：新手作者 → 签约作者 → 大神作者
```

**升级条件**：
- **签约作者**：作品质量达标 + 数据指标优秀 + 平台邀约
- **大神作者**：持续产出优质内容 + 粉丝数≥10万 + 月收入≥5万元

**身份兼容**：用户可以同时是VIP读者和签约作者,权益叠加

### 2.4 关键特性与差异化优势 🎯

#### 2.4.1 普惠AI策略

**核心理念：让每个人都能享受AI赋能** 💡

| 特性 | 传统平台 | 青羽平台 |
|------|---------|----------|
| **AI服务门槛** | 仅签约作者可用 | ✅ 所有用户都能使用 |
| **新手作者** | 无AI辅助 | ✅ 每日免费额度 + 付费扩展 |
| **付费模式** | 固定套餐 | ✅ 按量付费 + 月卡 + 签约免费 |
| **读者AI** | 不提供 | ✅ 阅读助手、智能问答 |
| **价格** | 高价位 | ✅ 低门槛（29元/月） |

**实施策略**：
1. **免费体验**：所有用户注册即送免费AI额度
2. **灵活付费**：0.1元/千Token起，适合轻度使用
3. **月卡实惠**：29元/月，10万Token，性价比高
4. **签约优惠**：签约作者享受8折，大神作者全免费
5. **快速充值**：配额用尽时3秒完成充值，无缝体验

#### 2.4.2 智能化写作辅助

**AI Agent深度协作 + 工具调用** 🤖

- **创作Agent**：智能续写、情节建议、对话生成
- **分析Agent**：文风分析、质量评估、数据洞察
- **审核Agent**：敏感词检测、合规审查、原创检测
- **多Agent协作**：复杂任务自动分解和协同完成

**🔥 独特功能：Agent工具调用** 🔧

| 传统AI写作助手 | 青羽AI Agent |
|---------------|-------------|
| 只能生成文本 | ✅ 能调用写作工具操作 |
| 需要手动创建大纲 | ✅ Agent自动生成大纲 |
| 角色卡手动填写 | ✅ Agent自动创建角色卡 |
| 人工维护时间线 | ✅ Agent自动构建时间线 |
| 设定容易矛盾 | ✅ Agent自动检查一致性 |

**Agent可调用的写作工具**：
1. **大纲工具**：自动生成故事结构（三幕式、英雄之旅）
2. **角色卡工具**：创建完整角色档案（性格、背景、能力）
3. **关系图谱**：自动生成角色关系网络图
4. **时间线管理**：构建多线索并行时间线
5. **世界观设定**：搭建设定框架并检查一致性
6. **设定百科**：自动归档和检索所有设定

**使用场景示例**：
```
用户: "我想写一部玄幻小说，主角是天才少年"

Agent自动执行：
1. 创作Agent生成故事大纲（修炼、历练、突破、大战）
2. 创作Agent创建角色卡（主角、师父、反派、女主）
3. 创作Agent生成角色关系图谱
4. 创作Agent构建世界观框架（修炼体系、势力分布）
5. 分析Agent检查设定一致性
6. 助手Agent整理归档到项目设定百科

结果：3分钟完成前期设定准备，用户可以直接开始创作！
```

**关键优势**：
- 🚀 **效率提升10倍**：从构思到开写，从数天缩短到分钟
- 🎯 **逻辑严密**：Agent自动检查设定一致性，避免前后矛盾
- 🧠 **深度理解**：不只是文本生成，而是理解创作意图并执行操作
- 🔄 **持续优化**：随着用户使用，Agent学习用户风格和偏好
- 🎨 **创意激发**：基于用户输入，Agent提供多样化创意建议

#### 2.4.3 无门槛创作体验

**让写作和阅读都更简单** ✍️

- **零基础上手**：直观的编辑器，5分钟开始创作
- **智能建议**：实时提供写作建议，避免卡文
- **版本管理**：自动保存，历史版本一键恢复
- **数据驱动**：实时数据分析，了解读者喜好
- **社区支持**：作者社群、经验分享、官方培训

#### 2.4.4 个性化阅读体验

**AI驱动的智能推荐** 📖

- **精准推荐**：基于阅读历史和偏好的个性化推荐
- **智能问答**：AI阅读助手，解答书中疑问
- **互动社区**：段评、书评、书圈，与作者读者互动
- **沉浸阅读**：自定义主题、字体、翻页效果
- **激励系统**：签到、任务、成就，边读边赚

#### 2.4.5 生态闭环

**读者与作者的双向赋能** 🔄

```
读者 → 阅读 → 打赏/订阅 → 作者收益
  ↓                              ↓
使用AI问答                    使用AI创作
  ↓                              ↓
更好理解作品                  提升创作质量
  ↓                              ↓
更多互动评论 ← 读者反馈 ← 优质内容产出
```

**生态优势**：
- 读者付费 → 作者收益 → 优质内容 → 更多读者
- 平台提供AI工具 → 降低创作门槛 → 更多作者 → 更多作品
- 数据反馈 → 改进推荐 → 提升匹配度 → 更高留存

### 2.5 运行环境

**技术架构**：
```
├── 编程语言：Go 1.21+
├── Web框架：Gin
├── 数据库：MongoDB
├── 缓存：Redis
├── 消息队列：RabbitMQ
├── 搜索引擎：Elasticsearch
├── 对象存储：MinIO/OSS
├── 容器化：Docker + Docker Compose
└── 监控：Prometheus + Grafana
```

**架构模式**：
```
Router → API → Service → Repository → Model
```

### 2.5 设计约束

1. **架构约束**
   - 严格遵循分层架构原则
   - 使用Repository模式封装数据访问
   - 采用依赖注入管理服务依赖
   - 实现事件驱动架构

2. **技术约束**
   - Go语言版本 ≥ 1.21
   - MongoDB版本 ≥ 5.0
   - 遵循RESTful API设计规范
   - 使用JWT进行无状态认证

3. **业务约束**
   - 用户数据隐私保护
   - 内容合规审核
   - 知识产权保护
   - 财务数据安全

---

## 3. 功能性需求

### 3.1 阅读端模块 (REQ-READING)

#### 3.1.1 书城系统 (REQ-READING-BOOKSTORE)

**REQ-READING-BOOKSTORE-001: 书籍展示** ⭐⭐⭐⭐⭐
- **功能描述**：提供书籍浏览、分类、搜索功能
- **输入**：用户筛选条件、搜索关键词
- **输出**：书籍列表、书籍详情
- **性能要求**：列表接口响应时间 < 100ms
- **优先级**：P0（核心功能）

**REQ-READING-BOOKSTORE-002: 榜单系统** ⭐⭐⭐⭐⭐
- **功能描述**：实时榜、周榜、月榜、新人榜
- **更新频率**：实时榜每5分钟更新，其他榜单每小时更新
- **数据来源**：阅读量、订阅数、评分等综合指标
- **优先级**：P0（核心功能）

**REQ-READING-BOOKSTORE-003: 搜索功能** ⭐⭐⭐⭐
- **功能描述**：全文搜索、高级筛选、搜索建议
- **搜索范围**：书名、作者、标签、简介
- **性能要求**：搜索响应时间 < 200ms
- **优先级**：P1（重要功能）

#### 3.1.2 阅读器 (REQ-READING-READER)

**REQ-READING-READER-001: 章节阅读** ⭐⭐⭐⭐⭐
- **功能描述**：章节内容展示、翻页导航
- **支持格式**：纯文本、富文本
- **离线缓存**：支持前后3章缓存
- **优先级**：P0（核心功能）

**REQ-READING-READER-002: 阅读设置** ⭐⭐⭐⭐
- **功能描述**：字体、主题、翻页模式设置
- **设置项**：字体大小(12-24px)、字体类型、背景主题、翻页动画
- **持久化**：设置跨设备同步
- **优先级**：P0（核心功能）

**REQ-READING-READER-003: 进度同步** ⭐⭐⭐⭐
- **功能描述**：阅读进度记录和多端同步
- **同步频率**：实时同步（WebSocket）或定时同步（30秒）
- **数据保留**：永久保留
- **优先级**：P1（重要功能）

**REQ-READING-READER-004: 书签笔记** ⭐⭐⭐
- **功能描述**：书签管理、笔记记录、高亮标注
- **存储限制**：每本书最多100个书签、1000条笔记
- **导出功能**：支持导出为Markdown、PDF
- **优先级**：P1（重要功能）

#### 3.1.3 推荐系统 (REQ-READING-RECOMMENDATION)

**REQ-READING-RECOMMENDATION-001: 个性化推荐** ⭐⭐⭐⭐
- **功能描述**：基于用户画像的个性化推荐
- **推荐算法**：协同过滤 + 内容推荐 + 深度学习
- **推荐数量**：首页推荐20本，瀑布流持续加载
- **优先级**：P1（重要功能）

**REQ-READING-RECOMMENDATION-002: 相似推荐** ⭐⭐⭐
- **功能描述**：根据当前阅读推荐相似书籍
- **推荐依据**：标签相似度、作者相似度、用户行为
- **推荐数量**：10本
- **优先级**：P1（重要功能）

#### 3.1.4 社交系统 (REQ-READING-SOCIAL)

**REQ-READING-SOCIAL-001: 评论系统** ⭐⭐⭐⭐
- **功能描述**：段评、章评、书评
- **评论层级**：支持2级回复
- **内容审核**：自动敏感词过滤 + 人工审核
- **优先级**：P1（重要功能）

**REQ-READING-SOCIAL-002: 关注系统** ⭐⭐⭐
- **功能描述**：关注作者、关注读者
- **关注上限**：每个用户最多关注1000人
- **动态推送**：关注对象的更新推送
- **优先级**：P2（一般功能）

### 3.2 写作端模块 (REQ-WRITING)

#### 3.2.1 编辑器系统 (REQ-WRITING-EDITOR)

**REQ-WRITING-EDITOR-001: 双模式编辑** ⭐⭐⭐⭐⭐
- **功能描述**：富文本模式 + Markdown模式
- **模式切换**：实时切换，内容自动转换
- **支持格式**：标题、列表、表格、代码块、图片
- **优先级**：P0（核心功能）

**REQ-WRITING-EDITOR-002: 自动保存** ⭐⭐⭐⭐⭐
- **功能描述**：定时自动保存、编辑状态检测
- **保存频率**：30秒或内容变更100字符
- **离线支持**：离线编辑，联网后同步
- **优先级**：P0（核心功能）

**REQ-WRITING-EDITOR-003: 协作编辑** ⭐⭐⭐
- **功能描述**：多人实时协作编辑
- **冲突解决**：OT算法或CRDT算法
- **在线状态**：显示协作者光标位置
- **优先级**：P2（高级功能）

#### 3.2.2 项目管理 (REQ-WRITING-PROJECT)

**REQ-WRITING-PROJECT-001: 项目CRUD** ⭐⭐⭐⭐⭐
- **功能描述**：创建、查询、更新、删除项目
- **项目类型**：小说、散文、剧本、其他
- **权限控制**：公开/私有/仅协作者
- **优先级**：P0（核心功能）

**REQ-WRITING-PROJECT-002: 文档树** ⭐⭐⭐⭐⭐
- **功能描述**：树形文档结构，支持拖拽排序
- **节点类型**：文件夹、文档
- **层级限制**：最多10层
- **优先级**：P0（核心功能）

#### 3.2.3 AI写作助手 (REQ-WRITING-AI)

**REQ-WRITING-AI-001: 智能续写** ⭐⭐⭐⭐⭐
- **功能描述**：选中段落智能续写
- **续写长度**：200-500字可配置
- **风格保持**：自动学习用户写作风格
- **优先级**：P0（核心功能）

**REQ-WRITING-AI-002: 文本改写** ⭐⭐⭐⭐
- **功能描述**：润色、扩写、缩写、风格转换
- **改写类型**：正式化、口语化、古风、现代
- **保留原意**：确保改写后语义不变
- **优先级**：P1（重要功能）

#### 3.2.4 数据统计 (REQ-WRITING-ANALYTICS)

**REQ-WRITING-ANALYTICS-001: 阅读数据** ⭐⭐⭐⭐
- **功能描述**：阅读量、完读率、跳章率统计
- **数据粒度**：按章节、按天、按周、按月
- **可视化**：折线图、柱状图、热力图
- **优先级**：P1（重要功能）

**REQ-WRITING-ANALYTICS-002: 读者画像** ⭐⭐⭐
- **功能描述**：年龄、性别、地域分布分析
- **数据来源**：用户资料、阅读行为
- **隐私保护**：匿名统计，不泄露个人信息
- **优先级**：P2（一般功能）

### 3.3 AI服务模块 (REQ-AI)

#### 3.3.1 多提供商适配 (REQ-AI-ADAPTER)

**REQ-AI-ADAPTER-001: OpenAI适配** ⭐⭐⭐⭐⭐
- **功能描述**：接入GPT-4、GPT-3.5等模型
- **流式响应**：支持流式输出
- **错误处理**：超时重试、降级策略
- **优先级**：P0（核心功能）

**REQ-AI-ADAPTER-002: 国产AI适配** ⭐⭐⭐⭐
- **功能描述**：文心一言、通义千问、混元、豆包
- **协议适配**：统一接口协议
- **负载均衡**：智能路由选择
- **优先级**：P1（重要功能）

#### 3.3.2 Agent系统 (REQ-AI-AGENT) 🆕

**REQ-AI-AGENT-001: 创作Agent** ⭐⭐⭐⭐⭐
- **功能描述**：深度集成写作工具的智能创作助手
- **核心能力**：
  - 情节设计与续写
  - 角色对话生成
  - 场景描写与氛围营造
  - 文风调整与改写
- **工具调用能力** 🔧：
  - **大纲工具**：
    - 自动生成故事大纲（三幕式、英雄之旅等结构）
    - 章节规划与节奏设计
    - 情节发展建议
  - **角色卡工具**：
    - 自动创建角色卡（姓名、性格、背景、能力）
    - 角色发展弧线设计
    - 角色冲突分析
  - **角色图谱工具**：
    - 自动生成角色关系网络
    - 关系演变追踪
    - 冲突关系可视化
  - **世界线/时间线工具**：
    - 自动构建故事时间线
    - 多线索并行管理
    - 时间线冲突检测
  - **世界观设定工具**：
    - 世界观框架搭建
    - 设定一致性检查
    - 地点、组织、势力管理
  - **设定百科检索**：
    - 查询已有设定避免矛盾
    - 自动关联相关设定
- **协作能力**：多Agent协作完成复杂创作任务
- **优先级**：P1（重要功能）

**REQ-AI-AGENT-002: 分析Agent** ⭐⭐⭐⭐
- **功能描述**：深度分析作品质量和创作数据
- **分析维度**：
  - 文风分析（语言风格、用词偏好）
  - 节奏分析（情节推进速度、高潮低谷）
  - 逻辑分析（情节合理性、设定一致性）
  - 情感分析（情绪曲线、读者感受预测）
- **工具调用能力** 🔧：
  - **设定一致性检查**：
    - 扫描全文，检查角色、世界观设定前后矛盾
    - 自动标注可能的bug（如角色名字不一致、能力前后矛盾）
  - **时间线验证**：
    - 检查时间线逻辑错误
    - 标注时间跨度不合理的情节
  - **角色行为分析**：
    - 分析角色行为是否符合人设
    - 检测OOC（Out of Character）情况
  - **数据统计工具**：
    - 各角色出场频率统计
    - 情节分布分析
    - 对话/描写/叙述比例
- **报告生成**：自动生成可视化分析报告
- **优先级**：P1（重要功能）

**REQ-AI-AGENT-003: 审核Agent** ⭐⭐⭐⭐⭐
- **功能描述**：智能内容审核和合规检查
- **审核维度**：
  - 敏感词检测（政治、暴力、色情等）
  - 合规性检查（法律法规、平台规则）
  - 原创度检测（相似度对比）
- **工具调用能力** 🔧：
  - **敏感词库检索**：实时查询最新敏感词库
  - **相似度对比工具**：与平台作品库对比
  - **自动修改建议**：提供替换词和改写建议
- **处理流程**：
  - 自动审核 → 标注问题 → 提供建议 → 人工复审（高风险）
- **优先级**：P0（核心功能）

**REQ-AI-AGENT-004: 助手Agent** ⭐⭐⭐⭐
- **功能描述**：通用写作和阅读助手
- **写作助手能力**：
  - 写作建议（如何展开情节、避免卡文）
  - 资料查询（历史事实、专业知识）
  - 灵感激发（创意提示、脑洞拓展）
- **阅读助手能力**：
  - 解答读者疑问（人物关系、情节回顾）
  - 内容总结（章节摘要、人物介绍）
  - 推荐相关作品
- **工具调用能力** 🔧：
  - **项目文档检索**：快速查找用户的设定、大纲、角色卡
  - **知识库搜索**：调用外部知识库和搜索引擎
  - **作品库检索**：查找平台相关作品和素材
- **优先级**：P1（重要功能）

**REQ-AI-AGENT-005: 多Agent协作** 🆕 ⭐⭐⭐⭐⭐
- **功能描述**：多个Agent协同完成复杂任务
- **协作场景示例**：
  - **全自动创作辅助**：
    1. 用户提供创意概要
    2. 创作Agent生成大纲、角色卡、世界观框架
    3. 分析Agent检查逻辑一致性
    4. 审核Agent检查合规性
    5. 助手Agent整合结果并优化
  - **作品深度分析**：
    1. 分析Agent提取关键信息
    2. 创作Agent提出改进建议
    3. 助手Agent生成报告
  - **智能设定管理**：
    1. 用户输入设定描述
    2. 创作Agent自动创建角色卡、关系图谱
    3. 分析Agent检查设定一致性
    4. 助手Agent整理归档到设定百科
- **任务分解**：自动将复杂任务分解为多个子任务
- **结果汇总**：智能整合各Agent的执行结果
- **冲突解决**：当Agent结果冲突时，智能仲裁
- **优先级**：P1（重要功能）

**REQ-AI-AGENT-006: Agent工具调用框架** 🆕 ⭐⭐⭐⭐⭐
- **功能描述**：统一的工具调用接口和框架
- **核心功能**：
  - **工具注册**：写作端工具注册到Agent工具库
  - **权限控制**：不同Agent有不同的工具调用权限
  - **参数验证**：自动验证工具调用参数
  - **执行监控**：记录所有工具调用日志
  - **错误处理**：工具调用失败时的降级处理
- **可调用工具清单**：
  - 大纲管理（创建、编辑、查询）
  - 角色卡管理（CRUD操作）
  - 关系图谱管理（创建、更新关系）
  - 时间线管理（添加事件、查询时间线）
  - 世界观管理（设定创建、一致性检查）
  - 文档操作（读取、修改、版本管理）
  - 数据统计（字数、章节、角色出场频率）
  - 搜索服务（全文搜索、语义搜索）
  - 知识库查询（外部知识、平台知识库）
  - RAG检索（检索增强生成）
- **调用流程**：
  ```
  Agent → 意图理解 → 选择工具 → 构造参数 → 调用工具 → 处理结果 → 返回用户
  ```
- **优先级**：P0（核心功能，Agent系统基础）

**REQ-AI-AGENT-007: RAG检索增强系统** 🆕 ⭐⭐⭐⭐⭐
- **功能描述**：为AI提供智能检索能力，基于检索结果生成更准确的内容
- **核心价值**：
  - 提高AI生成内容的准确性和相关性
  - 确保生成内容与用户已有设定一致
  - 减少AI幻觉（hallucination）问题
  - 提供可溯源的信息来源
- **检索范围**：
  - **用户私有知识库**：
    - 用户的所有项目文档
    - 用户创建的角色卡、大纲、设定
    - 用户的历史对话记录
    - 用户的写作素材库
  - **平台知识库**：
    - 平台优秀作品库
    - 写作技巧知识库
    - 类型小说套路库
    - 常见问题FAQ
  - **外部知识库**：
    - 历史知识（人物、事件、朝代）
    - 地理知识（地名、地貌、气候）
    - 科学知识（物理、化学、生物）
    - 文化知识（风俗、节日、传统）
- **检索方式**：
  - **语义检索**：基于向量相似度的语义搜索
  - **关键词检索**：精确关键词匹配
  - **混合检索**：语义+关键词综合排序
  - **时间过滤**：基于时间范围过滤
  - **相关性排序**：智能排序最相关结果
- **RAG工作流程**：
  ```
  用户提问 
    ↓
  意图理解（分析查询意图）
    ↓
  查询重写（优化检索关键词）
    ↓
  向量化查询（转换为向量）
    ↓
  多源检索（并行检索多个知识库）
    ↓
  结果重排序（相关性排序）
    ↓
  上下文构建（构造Prompt上下文）
    ↓
  AI生成（基于检索结果生成回答）
    ↓
  引用标注（标注信息来源）
    ↓
  返回结果
  ```
- **应用场景**：
  - **写作助手场景**：
    - 用户："帮我续写主角和反派的对决场景"
    - RAG检索：角色卡（主角/反派能力）、已写章节、战斗场景参考
    - AI生成：符合人设、逻辑连贯的对决场景
  - **设定查询场景**：
    - 用户："我的小说中修炼等级是怎么设定的？"
    - RAG检索：世界观设定、相关章节描述
    - AI回答：准确的等级设定，并给出引用来源
  - **灵感激发场景**：
    - 用户："给我一些宫廷争斗的情节灵感"
    - RAG检索：平台优秀宫廷文作品、历史知识库
    - AI生成：多个创意情节建议
  - **阅读助手场景**：
    - 读者："第50章提到的那个神秘组织是什么？"
    - RAG检索：前面章节中关于该组织的所有描述
    - AI回答：综合信息并标注出处章节
- **技术实现**：
  - **向量化模型**：
    - 文本编码：text-embedding-ada-002（OpenAI）或中文向量模型
    - 向量维度：1536维或768维
    - 批量处理：支持批量文档向量化
  - **向量数据库**：
    - 主选方案：Milvus或Qdrant（开源、高性能）
    - 备选方案：Elasticsearch with vector plugin
    - 索引策略：HNSW（Hierarchical Navigable Small World）
  - **检索优化**：
    - 分块策略：文档按段落分块（500-1000字/块）
    - 重叠窗口：块之间100字重叠，保持上下文
    - 元数据过滤：基于文档类型、创建时间等过滤
    - 缓存机制：热门查询结果缓存
- **性能指标**：
  - 检索延迟：P95 < 100ms
  - 检索准确率：Top-5 准确率 > 85%
  - 向量化速度：> 1000 docs/s
  - 支持规模：单用户 > 10万文档
- **优先级**：P1（重要功能，AI核心能力）

#### 3.3.3 配额管理 (REQ-AI-QUOTA)

**REQ-AI-QUOTA-001: 配额控制** ⭐⭐⭐⭐⭐
- **功能描述**：灵活的配额管理，支持多种计费模式
- **配额类型**：
  - 免费额度（每日刷新）
  - 购买配额（按量/包月/包季）
  - 签约赠送（平台补贴）
  - 活动赠送（营销活动）
- **计费规则**：
  - 按Token计费：每1000 Token为计费单位
  - 不同模型价格不同（GPT-4 > GPT-3.5 > 国产模型）
  - 签约作者享受折扣（8折）
  - 大神作者全免费
- **预警机制**：
  - 配额剩余20%时提醒
  - 配额用尽前1小时提醒
  - 提供快速充值入口
- **优先级**：P0（核心功能）

**REQ-AI-QUOTA-002: 付费服务包** ⭐⭐⭐⭐⭐
- **功能描述**：多种AI服务包供用户选择
- **服务包类型**：
  - **按量付费**：0.1元/千Token，适合轻度使用
  - **月卡**：29元/月，10万Token，适合日常创作
  - **季卡**：79元/季，30万Token，适合深度创作
  - **年卡**：299元/年，150万Token，最划算
- **签约作者折扣**：所有付费享受8折优惠
- **购买方式**：微信支付、支付宝、代币兑换
- **优先级**：P0（核心功能）

**REQ-AI-QUOTA-003: 免费额度策略** ⭐⭐⭐⭐
- **功能描述**：为所有用户提供免费体验额度
- **免费额度**：
  - 普通读者：每日5次AI问答（约2000 Token）
  - VIP读者：每日50次AI问答（约20000 Token）
  - 新手作者：每日10次AI辅助（约5000 Token）
  - 签约作者：每日100次AI辅助（约50000 Token）
  - 大神作者：无限使用（平台补贴）
- **额度刷新**：每天0点自动刷新
- **额度累积**：免费额度不累积，当日有效
- **优先级**：P0（核心功能）

### 3.4 用户中心模块 (REQ-USER)

#### 3.4.1 用户管理 (REQ-USER-MANAGEMENT)

**REQ-USER-MANAGEMENT-001: 注册登录** ⭐⭐⭐⭐⭐
- **功能描述**：邮箱注册、手机号注册、第三方登录
- **第三方**：微信、QQ、GitHub
- **安全验证**：邮箱验证码、短信验证码、图形验证码
- **优先级**：P0（核心功能）

**REQ-USER-MANAGEMENT-002: 会话管理** ⭐⭐⭐⭐
- **功能描述**：JWT Token管理、多端登录
- **Token有效期**：7天，支持刷新
- **多端限制**：最多5个设备同时登录
- **优先级**：P0（核心功能）

#### 3.4.2 角色权限 (REQ-USER-RBAC) 🆕

**REQ-USER-RBAC-001: RBAC系统** ⭐⭐⭐⭐⭐
- **功能描述**：基于角色的访问控制
- **角色继承**：支持角色继承和权限叠加
- **动态权限**：支持运行时权限变更
- **优先级**：P0（核心功能）

**REQ-USER-RBAC-002: 权限检查** ⭐⭐⭐⭐⭐
- **功能描述**：资源权限、操作权限、数据权限检查
- **性能要求**：权限检查 < 10ms（使用缓存）
- **审计日志**：记录所有权限检查和变更
- **优先级**：P0（核心功能）

#### 3.4.3 用户等级 (REQ-USER-LEVEL) 🆕

**REQ-USER-LEVEL-001: 等级体系** ⭐⭐⭐⭐
- **功能描述**：读者等级、作者等级体系
- **等级范围**：1-20级，每级经验递增
- **升级奖励**：代币、特权、徽章
- **优先级**：P1（重要功能）

**REQ-USER-LEVEL-002: 特权系统** ⭐⭐⭐
- **功能描述**：不同等级享受不同特权
- **特权类型**：阅读特权、写作特权、社交特权
- **特权展示**：用户资料卡显示等级和特权
- **优先级**：P1（重要功能）

### 3.5 共享服务模块 (REQ-SHARED)

#### 3.5.1 消息通知 (REQ-SHARED-NOTIFICATION)

**REQ-SHARED-NOTIFICATION-001: 多渠道推送** ⭐⭐⭐⭐
- **功能描述**：站内消息、邮件、短信、APP推送
- **消息类型**：系统通知、互动通知、营销通知
- **用户偏好**：支持用户自定义推送设置
- **优先级**：P1（重要功能）

#### 3.5.2 文件存储 (REQ-SHARED-STORAGE)

**REQ-SHARED-STORAGE-001: 对象存储** ⭐⭐⭐⭐⭐
- **功能描述**：文件上传、下载、管理
- **存储后端**：MinIO或OSS
- **文件类型**：图片、文档、音视频
- **大小限制**：单文件 < 100MB
- **优先级**：P0（核心功能）

**REQ-SHARED-STORAGE-002: CDN加速** ⭐⭐⭐⭐
- **功能描述**：静态资源CDN加速
- **缓存策略**：图片缓存7天，文档缓存1天
- **防盗链**：Referer验证、签名验证
- **优先级**：P1（重要功能）

#### 3.5.3 钱包服务 (REQ-SHARED-WALLET)

**REQ-SHARED-WALLET-001: 代币管理** ⭐⭐⭐⭐⭐
- **功能描述**：统一的虚拟货币管理系统
- **代币类型**：
  - **青羽币**：平台通用货币（1元=100青羽币）
  - **用途**：购买章节、订阅VIP、购买AI服务、打赏作者
  - **获取方式**：充值、任务奖励、活动赠送、签到赠送
- **余额管理**：
  - 实时余额查询
  - 充值记录、消费记录
  - 收入记录（作者稿费）
  - 提现记录（作者提现）
- **交易记录**：完整的交易流水，支持导出
- **优先级**：P0（核心功能）

**REQ-SHARED-WALLET-002: 支付集成** ⭐⭐⭐⭐⭐
- **功能描述**：支持多种支付方式
- **支付渠道**：
  - 微信支付
  - 支付宝支付
  - 青羽币余额支付
- **支付场景**：
  - 代币充值（10/30/50/100/500元充值档位）
  - VIP订阅（月/季/年）
  - AI服务包购买（月卡/季卡/年卡）
  - 章节购买
  - 打赏作者
- **充值优惠**：
  - 首充双倍
  - 大额充值赠送（充500送50）
  - 月卡/季卡/年卡折扣
- **安全保障**：支付加密、交易验签、异常监控
- **优先级**：P0（核心功能）

**REQ-SHARED-WALLET-003: AI服务购买** 🆕 ⭐⭐⭐⭐⭐
- **功能描述**：便捷的AI服务购买入口
- **购买方式**：
  - 在AI助手界面直接购买
  - 在个人中心-钱包购买
  - 配额用尽时快速充值
- **支付选项**：
  - 青羽币支付（优先）
  - 微信/支付宝支付（直接购买）
- **购买流程**：
  1. 选择服务包类型
  2. 确认订单和价格
  3. 选择支付方式
  4. 完成支付
  5. 立即生效，额度到账
- **用户体验**：
  - 一键购买，3秒完成
  - 购买成功立即提醒
  - 剩余额度实时显示
- **优先级**：P0（核心功能）

**REQ-SHARED-WALLET-004: 作者收益** ⭐⭐⭐⭐
- **功能描述**：作者稿费结算和提现
- **收益来源**：
  - 章节订阅收入
  - 读者打赏
  - 平台签约补贴
  - 广告分成
- **结算周期**：实时结算，T+1到账
- **提现规则**：
  - 最低提现：100元
  - 提现手续费：2%（签约作者免手续费）
  - 提现方式：支付宝、微信、银行卡
  - 到账时间：1-3个工作日
- **税务处理**：自动代扣个人所得税
- **优先级**：P1（重要功能）

---

## 4. 非功能性需求

### 4.1 性能需求 (REQ-PERFORMANCE)

| 指标 | 要求 | 测量方法 |
|------|------|----------|
| **API响应时间** | P95 < 200ms | 性能测试工具 |
| **数据库查询** | P95 < 100ms | 慢查询日志 |
| **并发用户数** | ≥ 10,000 | 压力测试 |
| **QPS** | ≥ 5,000 | 负载测试 |
| **吞吐量** | ≥ 100 MB/s | 网络监控 |
| **资源利用率** | CPU < 70%, 内存 < 80% | 系统监控 |

### 4.2 安全需求 (REQ-SECURITY)

**REQ-SECURITY-001: 身份认证** ⭐⭐⭐⭐⭐
- JWT Token认证
- 双因素认证(2FA)支持
- 密码强度要求：≥8位，包含大小写字母、数字、特殊字符
- 密码加密：bcrypt，cost=12

**REQ-SECURITY-002: 数据安全** ⭐⭐⭐⭐⭐
- 敏感数据加密存储（AES-256）
- 传输加密（TLS 1.3）
- 数据备份：每天全量备份，每小时增量备份
- 数据保留：用户数据保留3年，日志保留180天

**REQ-SECURITY-003: 访问控制** ⭐⭐⭐⭐⭐
- RBAC权限模型
- API访问控制
- IP白名单/黑名单
- 请求限流：用户级100次/分钟，IP级500次/分钟

**REQ-SECURITY-004: 审计日志** ⭐⭐⭐⭐
- 记录所有敏感操作
- 日志不可篡改
- 日志集中存储
- 异常行为告警

### 4.3 可用性需求 (REQ-AVAILABILITY)

| 指标 | 要求 | 说明 |
|------|------|------|
| **服务可用性** | ≥ 99.9% | 年故障时间 < 8.76小时 |
| **MTBF** | ≥ 720小时 | 平均故障间隔时间 |
| **MTTR** | ≤ 30分钟 | 平均修复时间 |
| **RTO** | ≤ 1小时 | 恢复时间目标 |
| **RPO** | ≤ 5分钟 | 恢复点目标 |
| **备份频率** | 每天 | 自动化备份 |

### 4.4 可扩展性需求 (REQ-SCALABILITY)

- **水平扩展**：支持无状态服务实例水平扩展
- **数据库扩展**：支持MongoDB副本集和分片
- **缓存扩展**：支持Redis集群
- **存储扩展**：支持OSS无限扩展
- **模块化设计**：新功能以插件方式扩展

### 4.5 可维护性需求 (REQ-MAINTAINABILITY)

- **代码质量**：圈复杂度 < 10，重复率 < 5%
- **测试覆盖率**：单元测试 ≥ 80%，集成测试 ≥ 60%
- **文档完整性**：API文档、架构文档、部署文档
- **日志规范**：结构化日志，统一格式
- **监控告警**：关键指标实时监控，异常自动告警

### 4.6 兼容性需求 (REQ-COMPATIBILITY)

- **API版本**：支持v1、v2版本共存，向后兼容
- **数据库**：MongoDB 5.0+
- **浏览器**：Chrome 90+、Firefox 88+、Safari 14+、Edge 90+
- **移动端**：iOS 13+、Android 8.0+
- **操作系统**：Linux、Windows、macOS

---

## 5. 外部接口需求

### 5.1 用户界面

- RESTful API接口（JSON格式）
- WebSocket接口（实时通信）
- gRPC接口（内部服务通信）

### 5.2 硬件接口

- 服务器：CPU 4核+, 内存 8GB+, 硬盘 100GB+
- 网络：带宽 100Mbps+
- 负载均衡器：支持HTTP/HTTPS

### 5.3 软件接口

- **数据库**：MongoDB 5.0+
- **缓存**：Redis 6.0+
- **消息队列**：RabbitMQ 3.9+
- **搜索引擎**：Elasticsearch 7.10+
- **对象存储**：MinIO或阿里云OSS
- **AI服务**：OpenAI API、百度AI API等

### 5.4 通信接口

- **HTTP/HTTPS**：REST API
- **WebSocket**：实时通信
- **gRPC**：服务间通信
- **AMQP**：消息队列

---

## 6. 数据需求

### 6.1 核心数据实体

| 实体 | 说明 | 主要字段 |
|------|------|----------|
| User | 用户信息 | ID, Username, Email, Role, Level |
| Book | 书籍信息 | ID, Title, Author, Category, Status |
| Chapter | 章节信息 | ID, BookID, Title, Content, Order |
| Project | 写作项目 | ID, OwnerID, Name, Type, Status |
| Document | 文档内容 | ID, ProjectID, Content, Version |
| Comment | 评论信息 | ID, UserID, TargetID, Content, Type |
| AISession | AI会话 | ID, UserID, Messages, Context |
| Transaction | 交易记录 | ID, UserID, Type, Amount, Status |

### 6.2 数据关系

```
User (1) -----> (N) Project
Project (1) --> (N) Document
User (1) -----> (N) Book (阅读关系)
Book (1) -----> (N) Chapter
User (1) -----> (N) Comment
User (1) -----> (N) AISession
User (1) -----> (N) Transaction
```

### 6.3 数据存储需求

- **数据保留期**：用户数据永久保留，日志数据180天
- **备份策略**：每天全量备份，每小时增量备份
- **数据加密**：敏感字段AES-256加密
- **数据归档**：1年前的历史数据归档到冷存储

---

## 7. 验收标准

### 7.1 功能验收

- [ ] 所有P0功能100%实现并测试通过
- [ ] 所有P1功能≥90%实现并测试通过
- [ ] API接口测试覆盖率 ≥ 95%
- [ ] 用户验收测试(UAT)通过率 ≥ 95%

### 7.2 性能验收

- [ ] API响应时间P95 < 200ms
- [ ] 并发用户数 ≥ 10,000
- [ ] 系统可用性 ≥ 99.9%
- [ ] 资源利用率符合要求

### 7.3 安全验收

- [ ] 安全扫描无高危漏洞
- [ ] 渗透测试通过
- [ ] 数据加密验证通过
- [ ] 权限控制测试通过

### 7.4 质量验收

- [ ] 单元测试覆盖率 ≥ 80%
- [ ] 代码圈复杂度 < 10
- [ ] 代码重复率 < 5%
- [ ] SonarQube评级 ≥ B

---

## 8. 追溯性矩阵

| 需求ID | 设计文档 | 代码模块 | 测试用例 |
|--------|----------|----------|----------|
| REQ-READING-BOOKSTORE-001 | bookstore_design.md | api/reading/bookstore_api.go | test_bookstore.go |
| REQ-WRITING-EDITOR-001 | editor_design.md | api/writing/editor_api.go | test_editor.go |
| REQ-AI-ADAPTER-001 | ai_adapter_design.md | service/ai/adapters/ | test_ai_adapter.go |
| REQ-USER-RBAC-001 | rbac_design.md | service/user/permission_service.go | test_rbac.go |

---

## 9. 附录

### 9.1 需求变更历史

| 版本 | 日期 | 变更内容 | 审批人 |
|------|------|----------|--------|
| v1.0 | 2024-01-XX | 初始版本 | 项目经理 |
| v2.0 | 2025-10-06 | 基于模块化架构v2.0重构需求 | 架构师 |

### 9.2 术语表

详见第1.4节

### 9.3 参考标准

- IEEE Std 830-1998：软件需求规格说明推荐实践
- ISO/IEC 25010：系统和软件质量模型
- RESTful API设计规范
- Go语言编码规范

---

**文档状态**: ✅ 已审批  
**审批人**: 架构师、产品经理  
**审批日期**: 2025-10-06

