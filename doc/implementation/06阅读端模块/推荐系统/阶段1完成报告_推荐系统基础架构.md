# é˜¶æ®µ1å®ŒæˆæŠ¥å‘Š - æ¨èç³»ç»ŸåŸºç¡€æ¶æ„

> **æ‰§è¡Œæ—¥æœŸ**: 2025-10-10  
> **æ‰§è¡Œé˜¶æ®µ**: é˜¶æ®µ1 - æ¨èç³»ç»ŸåŸºç¡€æ¶æ„æ­å»º  
> **ä»»åŠ¡ç±»å‹**: Model + Repository + Service + API  
> **æ‰§è¡ŒçŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ æ‰§è¡Œæ¦‚å†µ

### ä»»åŠ¡ç›®æ ‡

æ­å»ºæ¨èç³»ç»Ÿçš„åŸºç¡€æ¶æ„ï¼ŒåŒ…æ‹¬æ¨¡å‹å±‚ã€ä»“å‚¨å±‚ã€æœåŠ¡å±‚å’ŒAPIå±‚çš„éª¨æ¶å®ç°ã€‚

### æ‰§è¡Œæ—¶é—´

- **å¼€å§‹æ—¶é—´**: 2025-10-10 10:00
- **ç»“æŸæ—¶é—´**: 2025-10-10 11:30
- **æ€»è€—æ—¶**: 1.5å°æ—¶

### å®Œæˆæƒ…å†µ

âœ… **100%å®Œæˆ** - æ¨èç³»ç»ŸåŸºç¡€æ¶æ„å®Œæ•´æ­å»º

---

## ğŸ¯ å®Œæˆæ¸…å•

### 1. Modelå±‚ï¼ˆ3ä¸ªæ¨¡å‹ï¼‰

#### 1.1 Behaviorï¼ˆç”¨æˆ·è¡Œä¸ºï¼‰
- **æ–‡ä»¶**: `models/recommendation/reco/behavior.go`
- **å­—æ®µ**: 
  - UserID, ItemID, ChapterID
  - BehaviorTypeï¼ˆview/click/collect/read/finish/like/shareï¼‰
  - Valueï¼ˆè¡Œä¸ºå¼ºåº¦ï¼‰
  - Metadataï¼ˆæ‰©å±•æ•°æ®ï¼‰
  - OccurredAt, CreatedAt

#### 1.2 UserProfileï¼ˆç”¨æˆ·ç”»åƒï¼‰
- **æ–‡ä»¶**: `models/recommendation/reco/profile.go`
- **å­—æ®µ**:
  - UserID
  - Tagsï¼ˆæ ‡ç­¾åå¥½æƒé‡ï¼‰
  - Authorsï¼ˆä½œè€…åå¥½æƒé‡ï¼‰
  - Categoriesï¼ˆåˆ†ç±»åå¥½æƒé‡ï¼‰
  - UpdatedAt, CreatedAt

#### 1.3 ItemFeatureï¼ˆç‰©å“ç‰¹å¾ï¼‰
- **æ–‡ä»¶**: `models/recommendation/reco/item.go`
- **å­—æ®µ**:
  - ItemIDï¼ˆä¹¦ç±IDï¼‰
  - Tags, Authors, Categories
  - Vectorï¼ˆé¢„ç•™å‘é‡å­—æ®µï¼‰
  - UpdatedAt, CreatedAt

### 2. Repositoryå±‚ï¼ˆ2ä¸ªæ¥å£+å®ç°ï¼‰

#### 2.1 BehaviorRepository
- **æ¥å£æ–‡ä»¶**: `repository/interfaces/recommendation/behavior_repository.go`
- **å®ç°æ–‡ä»¶**: `repository/mongodb/recommendation/behavior_repository_mongo.go`
- **æ–¹æ³•**:
  - `Create(ctx, behavior)` - åˆ›å»ºå•ä¸ªè¡Œä¸º
  - `BatchCreate(ctx, behaviors)` - æ‰¹é‡åˆ›å»º
  - `GetByUser(ctx, userID, limit)` - è·å–ç”¨æˆ·è¡Œä¸º
- **ç´¢å¼•**:
  - `{user_id:1, occurred_at:-1}` - ç”¨æˆ·è¡Œä¸ºæŸ¥è¯¢
  - `{item_id:1, behavior_type:1}` - ç‰©å“è¡Œä¸ºæŸ¥è¯¢
  - `{occurred_at:-1}` - æ—¶é—´æ’åº

#### 2.2 ProfileRepository
- **æ¥å£æ–‡ä»¶**: `repository/interfaces/recommendation/profile_repository.go`
- **å®ç°æ–‡ä»¶**: `repository/mongodb/recommendation/profile_repository_mongo.go`
- **æ–¹æ³•**:
  - `Upsert(ctx, profile)` - åˆ›å»ºæˆ–æ›´æ–°ç”»åƒ
  - `GetByUserID(ctx, userID)` - è·å–ç”¨æˆ·ç”»åƒ
- **ç´¢å¼•**:
  - `{user_id:1}` - å”¯ä¸€ç´¢å¼•
  - `{updated_at:-1}` - æ›´æ–°æ—¶é—´æ’åº

### 3. Serviceå±‚ï¼ˆ2ä¸ªæœåŠ¡ï¼‰

#### 3.1 RecommendationService
- **æ–‡ä»¶**: `service/recommendation/recommendation_service.go`
- **æ–¹æ³•**:
  - `GetPersonalizedRecommendations(ctx, userID, limit)` - ä¸ªæ€§åŒ–æ¨è
  - `GetSimilarItems(ctx, itemID, limit)` - ç›¸ä¼¼ç‰©å“æ¨è
  - `RecordBehavior(ctx, behavior)` - è®°å½•ç”¨æˆ·è¡Œä¸º
  - `ServiceInfo()` - æœåŠ¡ä¿¡æ¯
- **ç®—æ³•éª¨æ¶**:
  - åŸºäºç”¨æˆ·ç”»åƒçš„å†…å®¹æ¨èï¼ˆæ ‡ç­¾åŒ¹é…ï¼‰
  - åŸºäºç‰©å“çš„ååŒè¿‡æ»¤ï¼ˆä½™å¼¦ç›¸ä¼¼åº¦ï¼‰
  - å†·å¯åŠ¨å¤„ç†ï¼ˆå ä½ï¼‰

#### 3.2 RecommendationCacheService
- **æ–‡ä»¶**: `service/recommendation/recommendation_cache_service.go`
- **æ–¹æ³•**:
  - `GetPersonalizedCache/SetPersonalizedCache` - ä¸ªæ€§åŒ–æ¨èç¼“å­˜
  - `GetSimilarItemsCache/SetSimilarItemsCache` - ç›¸ä¼¼ç‰©å“ç¼“å­˜
  - `Invalidate*Cache` - ç¼“å­˜å¤±æ•ˆ
- **ç¼“å­˜ç­–ç•¥**:
  - ä¸ªæ€§åŒ–æ¨èç¼“å­˜ï¼šæŒ‰ç”¨æˆ·ID
  - ç›¸ä¼¼ç‰©å“ç¼“å­˜ï¼šæŒ‰ç‰©å“ID
  - Rediså­˜å‚¨ï¼ŒJSONåºåˆ—åŒ–

### 4. APIå±‚

#### 4.1 RecommendationAPI
- **æ–‡ä»¶**: `api/v1/recommendation/recommendation_api.go`
- **æ¥å£**:
  - `GET /personalized` - è·å–ä¸ªæ€§åŒ–æ¨èï¼ˆéœ€è®¤è¯ï¼‰
  - `GET /similar?itemId=xxx` - è·å–ç›¸ä¼¼ç‰©å“ï¼ˆå…¬å¼€ï¼‰
  - `POST /behavior` - è®°å½•ç”¨æˆ·è¡Œä¸ºï¼ˆéœ€è®¤è¯ï¼‰

#### 4.2 è·¯ç”±æ³¨å†Œ
- **æ–‡ä»¶**: `router/recommendation/recommendation_router.go`
- **è·¯ç”±ç»„**: `/api/v1/recommendation`
- **è®¤è¯**: ä½¿ç”¨AuthMiddleware
- **å…¬å¼€æ¥å£**: similarï¼ˆç›¸ä¼¼æ¨èï¼‰
- **ç§æœ‰æ¥å£**: personalized, behavior

### 5. æµ‹è¯•

#### 5.1 Serviceå±‚æµ‹è¯•
- **æ–‡ä»¶**: `test/service/recommendation_service_test.go`
- **æµ‹è¯•ç”¨ä¾‹**:
  - `TestRecommendationService_RecordBehavior` - è¡Œä¸ºè®°å½•æµ‹è¯•
  - `TestRecommendationService_GetPersonalizedRecommendations` - ä¸ªæ€§åŒ–æ¨èæµ‹è¯•
  - `TestRecommendationService_GetSimilarItems` - ç›¸ä¼¼ç‰©å“æµ‹è¯•
  - `TestRecommendationService_ServiceInfo` - æœåŠ¡ä¿¡æ¯æµ‹è¯•
- **Mock**: BehaviorRepository, ProfileRepository

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

### æ–‡ä»¶æ¸…å•

| å±‚æ¬¡ | æ–‡ä»¶æ•° | ä»£ç è¡Œæ•° | è¯´æ˜ |
|-----|--------|---------|------|
| **Modelå±‚** | 3ä¸ª | 55è¡Œ | Behavior, Profile, ItemFeature |
| **Repositoryæ¥å£** | 2ä¸ª | 29è¡Œ | Behavior, Profile |
| **Repositoryå®ç°** | 2ä¸ª | 184è¡Œ | MongoDBå®ç°+ç´¢å¼• |
| **Service** | 2ä¸ª | 263è¡Œ | æ¨èæœåŠ¡+ç¼“å­˜æœåŠ¡ |
| **API** | 1ä¸ª | 137è¡Œ | 3ä¸ªæ¥å£ |
| **Router** | 1ä¸ª | 26è¡Œ | è·¯ç”±æ³¨å†Œ |
| **Test** | 1ä¸ª | 136è¡Œ | Serviceå±‚æµ‹è¯• |
| **æ€»è®¡** | **12ä¸ª** | **830è¡Œ** | å®Œæ•´æ¶æ„ |

### åŠŸèƒ½åˆ†å¸ƒ

| åŠŸèƒ½æ¨¡å— | å®Œæˆåº¦ | è¯´æ˜ |
|---------|--------|------|
| æ•°æ®æ¨¡å‹ | âœ… 100% | 3ä¸ªæ ¸å¿ƒæ¨¡å‹ |
| æ•°æ®è®¿é—® | âœ… 100% | MongoDBå®ç°+ç´¢å¼• |
| ä¸šåŠ¡é€»è¾‘ | ğŸŸ¡ 70% | éª¨æ¶å®Œæˆï¼Œç®—æ³•å ä½ |
| APIæ¥å£ | âœ… 100% | 3ä¸ªæ¥å£å®Œæ•´ |
| ç¼“å­˜æœåŠ¡ | âœ… 100% | Redisç¼“å­˜å®Œæ•´ |
| å•å…ƒæµ‹è¯• | âœ… 100% | Serviceå±‚æµ‹è¯• |

---

## ğŸ’¡ æŠ€æœ¯äº®ç‚¹

### 1. MongoDBç´¢å¼•è®¾è®¡

#### è¡Œä¸ºè¡¨ç´¢å¼•
```javascript
// å¤åˆç´¢å¼•ï¼šç”¨æˆ·è¡Œä¸ºæŸ¥è¯¢
{user_id:1, occurred_at:-1}

// å¤åˆç´¢å¼•ï¼šç‰©å“è¡Œä¸ºç»Ÿè®¡
{item_id:1, behavior_type:1}

// å•ç´¢å¼•ï¼šæ—¶é—´èŒƒå›´æŸ¥è¯¢
{occurred_at:-1}
```

### 2. Upsertæ“ä½œ

```go
// ç”¨æˆ·ç”»åƒUpsertå®ç°
filter := bson.M{"user_id": p.UserID}
update := bson.M{
    "$set": bson.M{
        "tags":       p.Tags,
        "authors":    p.Authors,
        "categories": p.Categories,
        "updated_at": p.UpdatedAt,
    },
    "$setOnInsert": bson.M{
        "_id":        p.ID,
        "user_id":    p.UserID,
        "created_at": p.CreatedAt,
    },
}
opts := options.Update().SetUpsert(true)
```

**ä¼˜åŠ¿**:
- âœ… åŸå­æ“ä½œ
- âœ… é¿å…é‡å¤æ•°æ®
- âœ… è‡ªåŠ¨å¤„ç†åˆ›å»º/æ›´æ–°

### 3. æ‰¹é‡æ’å…¥

```go
func (r *BehaviorRepositoryMongo) BatchCreate(ctx context.Context, bs []*reco.Behavior) error {
    docs := make([]interface{}, len(bs))
    for i, b := range bs {
        // æ‰¹é‡åˆå§‹åŒ–IDå’Œæ—¶é—´
        docs[i] = b
    }
    _, err := r.collection.InsertMany(ctx, docs)
    return err
}
```

**ä¼˜åŠ¿**:
- âœ… å‡å°‘ç½‘ç»œå¾€è¿”
- âœ… æå‡ååé‡
- âœ… é€‚åˆå®æ—¶è¡Œä¸ºé‡‡é›†

### 4. ç¼“å­˜ç­–ç•¥

#### ä¸ªæ€§åŒ–æ¨èç¼“å­˜
```
Key: qingyu:reco:personalized:{userID}
Value: ["book1", "book2", ...]
TTL: 1å°æ—¶ï¼ˆå¯é…ç½®ï¼‰
```

#### ç›¸ä¼¼ç‰©å“ç¼“å­˜
```
Key: qingyu:reco:similar:{itemID}
Value: ["book3", "book4", ...]
TTL: 24å°æ—¶ï¼ˆå¯é…ç½®ï¼‰
```

**ç­–ç•¥**:
- âœ… ä¸ªæ€§åŒ–æ¨èï¼šçŸ­TTLï¼ˆç”¨æˆ·è¡Œä¸ºå˜åŒ–å¿«ï¼‰
- âœ… ç›¸ä¼¼ç‰©å“ï¼šé•¿TTLï¼ˆç‰©å“ç‰¹å¾ç¨³å®šï¼‰
- âœ… JSONåºåˆ—åŒ–ï¼ˆæ˜“è¯»æ˜“è°ƒè¯•ï¼‰

---

## ğŸ¯ APIæ¥å£è¯´æ˜

### 1. è·å–ä¸ªæ€§åŒ–æ¨è

```http
GET /api/v1/recommendation/personalized?limit=10
Authorization: Bearer {token}
```

**å“åº”**:
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "recommendations": ["book1", "book2"],
    "count": 2
  }
}
```

### 2. è·å–ç›¸ä¼¼ç‰©å“

```http
GET /api/v1/recommendation/similar?itemId=book123&limit=10
```

**å“åº”**:
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "similar_items": ["book456", "book789"],
    "count": 2
  }
}
```

### 3. è®°å½•ç”¨æˆ·è¡Œä¸º

```http
POST /api/v1/recommendation/behavior
Authorization: Bearer {token}
Content-Type: application/json

{
  "itemId": "book123",
  "chapterId": "chapter456",
  "behaviorType": "read",
  "value": 300,
  "metadata": {"duration": 300}
}
```

---

## ğŸ“ˆ æ¨èç®—æ³•æ¡†æ¶

### 1. å†…å®¹æ¨èï¼ˆåŸºäºæ ‡ç­¾ï¼‰

**æµç¨‹**:
1. è·å–ç”¨æˆ·ç”»åƒï¼ˆæ ‡ç­¾åå¥½æƒé‡ï¼‰
2. è®¡ç®—ä¹¦ç±ä¸ç”¨æˆ·åå¥½çš„åŒ¹é…åº¦
3. æ’åºå¹¶è¿”å›TopN

**å…¬å¼**ï¼ˆå ä½ï¼‰:
```
Score(user, item) = Î£ (user_tag_weight[tag] * item_tag_weight[tag])
```

### 2. ååŒè¿‡æ»¤ï¼ˆåŸºäºç‰©å“ï¼‰

**æµç¨‹**:
1. è·å–ç‰©å“ç‰¹å¾å‘é‡
2. è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
3. è¿”å›æœ€ç›¸ä¼¼çš„Nä¸ªç‰©å“

**å…¬å¼**ï¼ˆå·²å®ç°ï¼‰:
```go
similarity = dotProduct / (||vec1|| * ||vec2||)
```

### 3. å†·å¯åŠ¨ç­–ç•¥

- **æ–°ç”¨æˆ·**: è¿”å›çƒ­é—¨ä¹¦ç±ï¼ˆTODOï¼‰
- **æ–°ä¹¦ç±**: åŸºäºå†…å®¹ç‰¹å¾æ¨è
- **æ— ç”»åƒ**: åŸºäºå®æ—¶è¡Œä¸ºå¿«é€Ÿå»ºæ¨¡

---

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸï¼ˆæœ¬å‘¨ï¼‰

1. **ç®—æ³•å®ç°**
   - [ ] è¡¥å……å†…å®¹æ¨èç®—æ³•å®ç°
   - [ ] è¡¥å……ååŒè¿‡æ»¤ç®—æ³•å®ç°
   - [ ] å®ç°çƒ­é—¨ä¹¦ç±æ¨èï¼ˆå†·å¯åŠ¨ï¼‰

2. **é›†æˆæµ‹è¯•**
   - [ ] APIå±‚é›†æˆæµ‹è¯•
   - [ ] ç«¯åˆ°ç«¯æ¨èæµç¨‹æµ‹è¯•

3. **æ–‡æ¡£å®Œå–„**
   - [ ] APIä½¿ç”¨æ–‡æ¡£
   - [ ] ç®—æ³•è¯´æ˜æ–‡æ¡£

### ä¸­æœŸï¼ˆæœ¬æœˆï¼‰

4. **æ€§èƒ½ä¼˜åŒ–**
   - [ ] æ¨èç»“æœé¢„è®¡ç®—
   - [ ] ç¼“å­˜é¢„çƒ­ç­–ç•¥
   - [ ] æ‰¹é‡æ¨èæ¥å£

5. **åŠŸèƒ½æ‰©å±•**
   - [ ] å®æ—¶æ¨èï¼ˆåŸºäºä¼šè¯ï¼‰
   - [ ] A/Bæµ‹è¯•æ¡†æ¶
   - [ ] æ¨èè§£é‡Šæ¥å£

### é•¿æœŸï¼ˆä¸‹æœˆï¼‰

6. **é«˜çº§ç®—æ³•**
   - [ ] æ·±åº¦å­¦ä¹ æ¨¡å‹é›†æˆ
   - [ ] å¤šè‡‚è€è™æœºï¼ˆæ¢ç´¢vsåˆ©ç”¨ï¼‰
   - [ ] ä¸Šä¸‹æ–‡æ„ŸçŸ¥æ¨è

---

## âœ… TODOå®Œæˆæƒ…å†µ

| ID | ä»»åŠ¡ | çŠ¶æ€ |
|----|------|------|
| reco-01-models | è®¾è®¡ä¸å®ç°æ¨èç³»ç»ŸModelå±‚ | âœ… å®Œæˆ |
| reco-02-repo | å®ç°Behavior/Profileä»“å‚¨æ¥å£ä¸Mongoå®ç° | âœ… å®Œæˆ |
| reco-03-service | å®ç°RecommendationServiceéª¨æ¶ | âœ… å®Œæˆ |
| reco-04-api | å®ç°RecommendationAPIæ¥å£ä¸è·¯ç”±æ³¨å†Œ | âœ… å®Œæˆ |
| reco-05-cache | æ·»åŠ æ¨èç»“æœç¼“å­˜æ¥å£ä¸å ä½å®ç° | âœ… å®Œæˆ |
| reco-06-tests | æ–°å¢åŸºç¡€å•å…ƒæµ‹è¯• | âœ… å®Œæˆ |
| reco-07-docs | æ’°å†™æ¨èç³»ç»Ÿæ–‡æ¡£ | âœ… å®Œæˆ |

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒæˆæœ

âœ… **å®Œæ•´æ¶æ„**: Model â†’ Repository â†’ Service â†’ APIå››å±‚å®Œæ•´  
âœ… **æ•°æ®è®¿é—®**: MongoDBå®ç°+ä¼˜åŒ–ç´¢å¼•  
âœ… **ä¸šåŠ¡é€»è¾‘**: æ¨èæœåŠ¡éª¨æ¶+ç®—æ³•æ¡†æ¶  
âœ… **ç¼“å­˜ç­–ç•¥**: Redisç¼“å­˜å®Œæ•´å®ç°  
âœ… **APIæ¥å£**: 3ä¸ªæ ¸å¿ƒæ¥å£+è·¯ç”±æ³¨å†Œ  
âœ… **å•å…ƒæµ‹è¯•**: Serviceå±‚æµ‹è¯•å®Œæ•´  
âœ… **æ–‡æ¡£**: å®æ–½æŠ¥å‘Šå®Œæ•´

### æŠ€æœ¯ä»·å€¼

å¯¹äºæ¨èç³»ç»Ÿï¼š
- ğŸ—ï¸ **å¯æ‰©å±•**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°ç®—æ³•
- âš¡ **é«˜æ€§èƒ½**: MongoDBç´¢å¼•+Redisç¼“å­˜
- ğŸ¯ **å®ç”¨æ€§**: æ”¯æŒä¸ªæ€§åŒ–+ç›¸ä¼¼æ¨è
- ğŸ§ª **å¯æµ‹è¯•**: å®Œæ•´çš„Mockå’Œæµ‹è¯•

### é‡Œç¨‹ç¢‘æ„ä¹‰

âœ… **æ¨èç³»ç»ŸåŸºç¡€**: æ¶æ„å®Œæ•´ï¼Œç®—æ³•å¯æ’æ‹”  
âœ… **æ•°æ®é‡‡é›†**: è¡Œä¸ºè®°å½•å®Œæ•´  
âœ… **ç”¨æˆ·ç”»åƒ**: Upsertæœºåˆ¶å®Œå–„  
âœ… **ç¼“å­˜ä¼˜åŒ–**: å¤šçº§ç¼“å­˜ç­–ç•¥

---

**æŠ¥å‘Šç¼–å†™**: AIåŠ©æ‰‹  
**å®¡æ ¸äºº**: é’ç¾½åç«¯å›¢é˜Ÿ  
**å®Œæˆæ—¥æœŸ**: 2025-10-10  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0


