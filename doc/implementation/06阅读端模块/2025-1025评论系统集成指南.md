# 评论系统集成指南

**版本**: v1.0  
**日期**: 2025-10-25  
**状态**: 待集成

---

## ✅ 已完成的工作

评论系统的核心代码已经实现完成：

1. ✅ **数据模型**: `models/reader/comment.go`
2. ✅ **Repository接口**: `repository/interfaces/reading/comment_repository.go`
3. ✅ **Repository实现**: `repository/mongodb/reading/comment_repository_mongo.go`
4. ✅ **Service接口**: `service/interfaces/comment_service.go`
5. ✅ **Service实现**: `service/reading/comment_service.go`
6. ✅ **API实现**: `api/v1/reader/comment_api.go`
7. ✅ **路由配置**: `router/reader/reader_router.go`（已修改）

---

## 🔧 待完成的集成工作

### 步骤1：注册CommentService到服务容器

**文件**: `service/container/service_container.go`

#### 1.1 添加commentService字段

在ServiceContainer结构体中添加：

```go
// ServiceContainer 服务容器
type ServiceContainer struct {
    // ... 现有字段 ...
    
    // 业务服务
    userService      userInterface.UserService
    aiService        *aiService.Service
    bookstoreService bookstoreService.BookstoreService
    readerService    *readingService.ReaderService
    commentService   *readingService.CommentService  // 新增
    
    // ... 其他字段 ...
}
```

#### 1.2 添加注册方法

在文件末尾添加以下方法：

```go
// RegisterCommentService 注册评论服务
func (c *ServiceContainer) RegisterCommentService(commentService *readingService.CommentService) {
    c.mu.Lock()
    defer c.mu.Unlock()
    c.commentService = commentService
    c.services["CommentService"] = commentService
}

// GetCommentService 获取评论服务
func (c *ServiceContainer) GetCommentService() (*readingService.CommentService, error) {
    if c.commentService == nil {
        return nil, fmt.Errorf("CommentService未初始化")
    }
    return c.commentService, nil
}
```

#### 1.3 在Initialize方法中创建并注册CommentService

找到Initialize方法中创建readerService的部分，在其后添加：

```go
// 创建CommentService
commentRepo := c.repositoryFactory.GetCommentRepository()
sensitiveWordRepo := c.repositoryFactory.GetSensitiveWordRepository()

commentSvc := readingService.NewCommentService(
    commentRepo,
    sensitiveWordRepo,
    c.eventBus,
)
c.RegisterCommentService(commentSvc)
```

**注意**: 需要确保RepositoryFactory已经实现了GetCommentRepository和GetSensitiveWordRepository方法。

---

### 步骤2：更新RepositoryFactory

**文件**: `repository/interfaces/repository_factory.go`

#### 2.1 添加接口方法

```go
type RepositoryFactory interface {
    // ... 现有方法 ...
    
    // 阅读相关Repository
    GetCommentRepository() reading.CommentRepository
    
    // ... 其他方法 ...
}
```

**文件**: `repository/mongodb/repository_factory.go`

#### 2.2 添加实现方法

```go
// GetCommentRepository 获取评论Repository
func (f *MongoRepositoryFactory) GetCommentRepository() readingRepo.CommentRepository {
    if f.commentRepo == nil {
        f.commentRepo = readingMongo.NewMongoCommentRepository(f.db)
    }
    return f.commentRepo
}
```

#### 2.3 在结构体中添加字段

```go
type MongoRepositoryFactory struct {
    db *mongo.Database
    
    // ... 现有字段 ...
    commentRepo readingRepo.CommentRepository
    // ... 其他字段 ...
}
```

---

### 步骤3：更新路由入口

**文件**: `router/enter.go`

#### 3.1 获取CommentService并传递给InitReaderRouter

找到注册阅读器路由的部分：

```go
// ============ 注册阅读器路由 ============
readerSvc, err := serviceContainer.GetReaderService()
if err != nil {
    logger.Warn("获取阅读器服务失败", zap.Error(err))
    logger.Info("阅读器路由未注册")
} else {
    // 获取评论服务（如果可用）
    commentSvc, commentErr := serviceContainer.GetCommentService()
    if commentErr != nil {
        logger.Warn("评论服务未配置", zap.Error(commentErr))
        commentSvc = nil
    }
    
    readerRouter.InitReaderRouter(v1, readerSvc, commentSvc)

    logger.Info("✓ 阅读器路由已注册到: /api/v1/reader/")
    logger.Info("  - /api/v1/reader/books/* (书架管理)")
    logger.Info("  - /api/v1/reader/chapters/* (章节内容)")
    logger.Info("  - /api/v1/reader/progress/* (阅读进度)")
    logger.Info("  - /api/v1/reader/annotations/* (标注管理)")
    logger.Info("  - /api/v1/reader/settings/* (阅读设置)")
    if commentSvc != nil {
        logger.Info("  - /api/v1/reader/comments/* (评论系统)")
    }
}
```

---

### 步骤4：验证评论系统

#### 4.1 编译检查

```bash
go build ./...
```

如果有编译错误，根据错误信息修复。

#### 4.2 启动服务器

```bash
go run cmd/server/main.go
```

检查日志中是否有：
- ✓ CommentService已注册
- ✓ 评论路由已注册到: /api/v1/reader/comments/

#### 4.3 测试评论API

使用Postman或curl测试：

**1. 发表评论**

```bash
curl -X POST http://localhost:8080/api/v1/reader/comments \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "book_id": "BOOK_ID",
    "content": "这是一条测试评论，内容至少需要10个字。",
    "rating": 5
  }'
```

**2. 获取评论列表**

```bash
curl http://localhost:8080/api/v1/reader/comments?bookId=BOOK_ID&page=1&size=20
```

---

## 📋 集成检查清单

- [ ] ServiceContainer添加commentService字段
- [ ] 实现RegisterCommentService和GetCommentService方法
- [ ] 在Initialize方法中创建并注册CommentService
- [ ] RepositoryFactory添加GetCommentRepository方法
- [ ] MongoRepositoryFactory实现GetCommentRepository
- [ ] 更新router/enter.go以传递commentService
- [ ] 编译通过（go build）
- [ ] 服务启动成功
- [ ] 日志显示评论服务和路由已注册
- [ ] API测试通过（发表评论、获取列表）

---

## 🧪 测试建议

### 单元测试

创建 `test/service/comment_service_test.go`:

```go
package service_test

import (
    "context"
    "testing"
    
    "Qingyu_backend/models/reader"
    "Qingyu_backend/service/reading"
    // Mock repositories...
)

func TestCommentService_PublishComment(t *testing.T) {
    // TODO: 实现测试
}

func TestCommentService_ReplyComment(t *testing.T) {
    // TODO: 实现测试
}

// ... 更多测试用例
```

### 集成测试

修复 `test/integration/scenario_interaction_test.go` 中的测试4、5：

```go
t.Run("4.评论_发表书籍评论", func(t *testing.T) {
    // 移除 t.Skip()
    // 实现完整的测试逻辑
})

t.Run("5.评论_获取书籍评论列表", func(t *testing.T) {
    // 移除 t.Skip()
    // 实现完整的测试逻辑
})
```

---

## 🔍 常见问题

### Q1: 编译时找不到CommentRepository

**A**: 确保已经在RepositoryFactory接口中添加了GetCommentRepository方法，并在MongoRepositoryFactory中实现。

### Q2: 服务启动时评论路由未注册

**A**: 检查：
1. CommentService是否成功创建和注册
2. router/enter.go是否正确获取并传递commentService
3. router/reader/reader_router.go中的条件判断是否正确

### Q3: 评论审核总是返回rejected

**A**: 检查sensitiveWordRepo是否正确初始化。如果sensitiveWordRepo为nil，应该默认通过审核。

---

## 📝 下一步计划

完成评论系统集成后：

1. **实现点赞系统**（阶段2）
   - 创建Like模型
   - 实现LikeRepository和LikeService
   - 集成Redis缓存
   - 与CommentService集成

2. **实现收藏系统**（阶段3）
   - 独立的收藏功能
   - 收藏夹管理
   - 分享功能

3. **实现阅读历史系统**（阶段4）
   - 独立的历史记录
   - 阅读统计
   - 自动清理

4. **集成测试与优化**（阶段5）
   - 运行所有集成测试
   - 性能优化
   - 编写实施文档

---

**集成指南编写时间**: 2025-10-25  
**预计集成时间**: 1-2小时  
**下次更新**: 完成集成后

