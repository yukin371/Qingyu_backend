# é˜¶æ®µ12 - ä»»åŠ¡2.4: ä¸­é—´ä»¶é›†æˆå®ç°æ€»ç»“

## ä»»åŠ¡æ¦‚è¿°

**ä»»åŠ¡ç›®æ ‡**: é…ç½®å®Œæ•´çš„ä¸­é—´ä»¶é“¾ï¼Œä¸ºå…±äº«æœåŠ¡APIæä¾›å…¨é¢çš„ä¿æŠ¤å’ŒåŠŸèƒ½æ”¯æŒ

**å®æ–½æ—¶é—´**: 2025-01-10

**è´Ÿè´£æ¨¡å—**: è·¯ç”±é…ç½®ï¼ˆrouter/sharedï¼‰ã€ä¸­é—´ä»¶ï¼ˆmiddlewareï¼‰

## å®æ–½å†…å®¹

### 1. å…¨å±€ä¸­é—´ä»¶é“¾é…ç½®

#### 1.1 ä¸­é—´ä»¶æ‰§è¡Œé¡ºåºï¼ˆrouter/shared/shared_router.goï¼‰
```go
r.Use(middleware.ResponseFormatterMiddleware()) // 1. å“åº”æ ¼å¼åŒ–ï¼ˆRequestIDç”Ÿæˆï¼‰
r.Use(middleware.ResponseTimingMiddleware())    // 2. å“åº”æ—¶é—´è®°å½•
r.Use(middleware.CORSMiddleware())              // 3. è·¨åŸŸå¤„ç†
r.Use(middleware.Recovery())                    // 4. Panicæ¢å¤
r.Use(response.GzipMiddleware(5))               // 5. Gzipå‹ç¼©ï¼ˆå‹ç¼©çº§åˆ«5ï¼‰
```

**æ‰§è¡Œé¡ºåºè¯´æ˜**ï¼š
1. **ResponseFormatter**: æœ€å…ˆæ‰§è¡Œï¼Œç”ŸæˆRequestIDç”¨äºè¿½è¸ª
2. **ResponseTiming**: è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´
3. **CORS**: å¤„ç†è·¨åŸŸè¯·æ±‚ï¼Œåœ¨ä¸šåŠ¡é€»è¾‘å‰
4. **Recovery**: æ•è·panicï¼Œé˜²æ­¢æœåŠ¡å´©æºƒ
5. **Gzip**: æœ€åæ‰§è¡Œï¼Œå‹ç¼©å“åº”æ•°æ®

### 2. è·¯ç”±ç»„ä¸­é—´ä»¶é…ç½®

#### 2.1 è®¤è¯æœåŠ¡è·¯ç”±ï¼ˆ/authï¼‰
```go
// å…¬å¼€è·¯ç”± - ä¸¥æ ¼é™æµ
publicAuth.Use(middleware.RateLimitMiddleware(10, 60)) // 10æ¬¡/åˆ†é’Ÿ
{
    publicAuth.POST("/register", authAPI.Register)
    publicAuth.POST("/login", authAPI.Login)
}

// éœ€è®¤è¯è·¯ç”± - ä¸­ç­‰é™æµ
authProtected.Use(middleware.JWTAuth())
authProtected.Use(middleware.RateLimitMiddleware(30, 60)) // 30æ¬¡/åˆ†é’Ÿ
{
    authProtected.POST("/logout", authAPI.Logout)
    authProtected.POST("/refresh", authAPI.RefreshToken)
    authProtected.GET("/permissions", authAPI.GetUserPermissions)
    authProtected.GET("/roles", authAPI.GetUserRoles)
}
```

**è®¾è®¡è€ƒè™‘**ï¼š
- ç™»å½•/æ³¨å†Œï¼šä¸¥æ ¼é™æµï¼ˆ10æ¬¡/åˆ†é’Ÿï¼‰é˜²æ­¢æš´åŠ›ç ´è§£
- è®¤è¯æ“ä½œï¼šä¸­ç­‰é™æµï¼ˆ30æ¬¡/åˆ†é’Ÿï¼‰å¹³è¡¡å®‰å…¨å’Œä½“éªŒ

#### 2.2 é’±åŒ…æœåŠ¡è·¯ç”±ï¼ˆ/walletï¼‰
```go
walletGroup.Use(middleware.JWTAuth())                   // JWTè®¤è¯
walletGroup.Use(middleware.RateLimitMiddleware(50, 60)) // 50æ¬¡/åˆ†é’Ÿ
```

**è®¾è®¡è€ƒè™‘**ï¼š
- æ‰€æœ‰é’±åŒ…æ“ä½œéƒ½éœ€è¦è®¤è¯
- è¾ƒé«˜é™æµï¼ˆ50æ¬¡/åˆ†é’Ÿï¼‰æ”¯æŒæ­£å¸¸ä½¿ç”¨åœºæ™¯

#### 2.3 å­˜å‚¨æœåŠ¡è·¯ç”±ï¼ˆ/storageï¼‰
```go
storageGroup.Use(middleware.JWTAuth())                   // JWTè®¤è¯
storageGroup.Use(middleware.RateLimitMiddleware(20, 60)) // 20æ¬¡/åˆ†é’Ÿ
```

**è®¾è®¡è€ƒè™‘**ï¼š
- æ–‡ä»¶æ“ä½œæˆæœ¬é«˜
- è¾ƒä½é™æµï¼ˆ20æ¬¡/åˆ†é’Ÿï¼‰é˜²æ­¢æ»¥ç”¨

#### 2.4 ç®¡ç†æœåŠ¡è·¯ç”±ï¼ˆ/adminï¼‰
```go
adminGroup.Use(middleware.JWTAuth())                      // JWTè®¤è¯
adminGroup.Use(middleware.AdminPermissionMiddleware())    // ç®¡ç†å‘˜æƒé™
adminGroup.Use(middleware.RateLimitMiddleware(100, 60))   // 100æ¬¡/åˆ†é’Ÿ
```

**è®¾è®¡è€ƒè™‘**ï¼š
- åŒé‡éªŒè¯ï¼šJWT + ç®¡ç†å‘˜æƒé™
- é«˜é™æµï¼ˆ100æ¬¡/åˆ†é’Ÿï¼‰æ”¯æŒç®¡ç†å‘˜æ‰¹é‡æ“ä½œ

### 3. æ–°å¢ä¸­é—´ä»¶

#### 3.1 ç®¡ç†å‘˜æƒé™ä¸­é—´ä»¶ï¼ˆmiddleware/admin_permission.goï¼Œ114è¡Œï¼‰

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. **AdminPermissionMiddleware** - ç®¡ç†å‘˜æƒé™éªŒè¯
2. **SuperAdminPermissionMiddleware** - è¶…çº§ç®¡ç†å‘˜æƒé™éªŒè¯
3. **RequirePermissionsMiddleware** - é€šç”¨æƒé™éªŒè¯

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```go
// åªå…è®¸ç®¡ç†å‘˜
adminGroup.Use(middleware.AdminPermissionMiddleware())

// åªå…è®¸è¶…çº§ç®¡ç†å‘˜
superAdminGroup.Use(middleware.SuperAdminPermissionMiddleware())

// éœ€è¦ç‰¹å®šæƒé™
router.Use(middleware.RequirePermissionsMiddleware("user:delete", "user:ban"))
```

**æƒé™æ£€æŸ¥é€»è¾‘**ï¼š
```go
func AdminPermissionMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        role, exists := c.Get("user_role")
        if !exists {
            c.JSON(403, gin.H{"code": 403, "message": "æƒé™ä¸è¶³ï¼šæ— æ³•è·å–ç”¨æˆ·è§’è‰²"})
            c.Abort()
            return
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
        if role != "admin" && role != "super_admin" {
            c.JSON(403, gin.H{"code": 403, "message": "æƒé™ä¸è¶³ï¼šéœ€è¦ç®¡ç†å‘˜æƒé™"})
            c.Abort()
            return
        }

        c.Next()
    }
}
```

**ç‰¹æ€§**ï¼š
- ä»Contextè·å–ç”¨æˆ·è§’è‰²ï¼ˆç”±JWTä¸­é—´ä»¶æ³¨å…¥ï¼‰
- æ”¯æŒadminå’Œsuper_adminä¸¤ç§ç®¡ç†å‘˜è§’è‰²
- ç»Ÿä¸€çš„403é”™è¯¯å“åº”
- æ”¯æŒè‡ªå®šä¹‰æƒé™åˆ—è¡¨ï¼ˆ`RequirePermissionsMiddleware`ï¼‰
- æ”¯æŒé€šé…ç¬¦æƒé™ï¼ˆ`*`è¡¨ç¤ºæ‰€æœ‰æƒé™ï¼‰

#### 3.2 CORSè·¨åŸŸä¸­é—´ä»¶ï¼ˆmiddleware/cors.goï¼Œ124è¡Œï¼‰

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. **CORSMiddleware** - ç®€å•CORSä¸­é—´ä»¶
2. **CORSMiddlewareWithConfig** - å¸¦é…ç½®çš„CORSä¸­é—´ä»¶
3. **DefaultCORSConfig** - é»˜è®¤é…ç½®

**CORSå“åº”å¤´è®¾ç½®**ï¼š
```go
c.Header("Access-Control-Allow-Origin", origin)
c.Header("Access-Control-Allow-Methods", "GET, POST, PUT, PATCH, DELETE, OPTIONS")
c.Header("Access-Control-Allow-Headers", "Origin, Content-Type, Content-Length, Accept-Encoding, Authorization, X-Request-ID")
c.Header("Access-Control-Expose-Headers", "Content-Length, X-Request-ID, X-Response-Time")
c.Header("Access-Control-Allow-Credentials", "true")
c.Header("Access-Control-Max-Age", "86400") // 24å°æ—¶
```

**é¢„æ£€è¯·æ±‚å¤„ç†**ï¼š
```go
// å¤„ç†OPTIONSé¢„æ£€è¯·æ±‚
if c.Request.Method == "OPTIONS" {
    c.AbortWithStatus(http.StatusNoContent)
    return
}
```

**é…ç½®åŒ–CORS**ï¼š
```go
type CORSConfig struct {
    AllowedOrigins   []string // å…è®¸çš„æº
    AllowedMethods   []string // å…è®¸çš„HTTPæ–¹æ³•
    AllowedHeaders   []string // å…è®¸çš„è¯·æ±‚å¤´
    ExposedHeaders   []string // æš´éœ²çš„å“åº”å¤´
    AllowCredentials bool     // æ˜¯å¦å…è®¸æºå¸¦å‡­è¯
    MaxAge           int      // é¢„æ£€è¯·æ±‚ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```go
// ç®€å•æ¨¡å¼ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
router.Use(middleware.CORSMiddleware())

// é…ç½®æ¨¡å¼ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
config := middleware.CORSConfig{
    AllowedOrigins: []string{"https://example.com"},
    AllowedMethods: []string{"GET", "POST"},
    AllowCredentials: true,
}
router.Use(middleware.CORSMiddlewareWithConfig(config))
```

#### 3.3 é€Ÿç‡é™åˆ¶ä¸­é—´ä»¶æ‰©å±•ï¼ˆmiddleware/rate_limit.goï¼‰

**æ–°å¢å‡½æ•°**ï¼š
```go
// RateLimitMiddleware ç®€å•çš„é€Ÿç‡é™åˆ¶ä¸­é—´ä»¶
// limit: å…è®¸çš„è¯·æ±‚æ•°, window: æ—¶é—´çª—å£ï¼ˆç§’ï¼‰
func RateLimitMiddleware(limit int, window int) gin.HandlerFunc
```

**å®ç°é€»è¾‘**ï¼š
```go
func RateLimitMiddleware(limit int, window int) gin.HandlerFunc {
    // è®¡ç®—æ¯ç§’é€Ÿç‡
    rps := float64(limit) / float64(window)
    limiter := NewTokenBucketLimiter(int(rps*100), limit)

    return func(c *gin.Context) {
        // ä½¿ç”¨IPä½œä¸ºé™æµkey
        key := c.ClientIP()

        if !limiter.Allow(key) {
            c.JSON(429, gin.H{
                "code":    429,
                "message": fmt.Sprintf("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œæ¯%dç§’æœ€å¤š%dæ¬¡è¯·æ±‚", window, limit),
            })
            c.Abort()
            return
        }

        c.Next()
    }
}
```

**ç‰¹æ€§**ï¼š
- åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•
- æŒ‰IPåœ°å€é™æµ
- å‹å¥½çš„é”™è¯¯æç¤º
- çµæ´»çš„æ—¶é—´çª—å£é…ç½®

## ä¸­é—´ä»¶é…ç½®å¯¹æ¯”

### é…ç½®å‰ï¼ˆåŸå§‹ï¼‰
```go
// åªæœ‰åŸºæœ¬çš„JWTè®¤è¯
authGroup.Use(middleware.JWTAuth())
walletGroup.Use(middleware.JWTAuth())
storageGroup.Use(middleware.JWTAuth())
adminGroup.Use(middleware.JWTAuth())
```

### é…ç½®åï¼ˆå®Œæ•´ï¼‰
```go
// å…¨å±€ä¸­é—´ä»¶ï¼ˆ5ä¸ªï¼‰
r.Use(middleware.ResponseFormatterMiddleware())
r.Use(middleware.ResponseTimingMiddleware())
r.Use(middleware.CORSMiddleware())
r.Use(middleware.Recovery())
r.Use(response.GzipMiddleware(5))

// è·¯ç”±ç»„ä¸­é—´ä»¶ï¼ˆåˆ†å±‚é…ç½®ï¼‰
authGroup (å…¬å¼€): RateLimit(10/min)
authGroup (è®¤è¯): JWT + RateLimit(30/min)
walletGroup:      JWT + RateLimit(50/min)
storageGroup:     JWT + RateLimit(20/min)
adminGroup:       JWT + AdminPermission + RateLimit(100/min)
```

**æ”¹è¿›ç‚¹**ï¼š
1. **å…¨é¢ä¿æŠ¤**ï¼šå“åº”æ ¼å¼åŒ–ã€æ—¶é—´è®°å½•ã€CORSã€æ¢å¤ã€å‹ç¼©
2. **åˆ†å±‚é™æµ**ï¼šæ ¹æ®ä¸åŒæœåŠ¡è®¾ç½®ä¸åŒé™æµç­–ç•¥
3. **æƒé™ç»†åŒ–**ï¼šç®¡ç†å‘˜è·¯ç”±æ·»åŠ é¢å¤–æƒé™éªŒè¯
4. **ç”¨æˆ·ä½“éªŒ**ï¼šå‹å¥½çš„é”™è¯¯æç¤ºã€RequestIDè¿½è¸ª

## é€Ÿç‡é™åˆ¶ç­–ç•¥

| è·¯ç”±ç»„ | é™æµç­–ç•¥ | åŸå›  |
|--------|---------|------|
| /auth (å…¬å¼€) | 10æ¬¡/åˆ†é’Ÿ | é˜²æ­¢æš´åŠ›ç ´è§£ç™»å½•/æ³¨å†Œ |
| /auth (è®¤è¯) | 30æ¬¡/åˆ†é’Ÿ | æ”¯æŒæ­£å¸¸çš„è®¤è¯æ“ä½œ |
| /wallet | 50æ¬¡/åˆ†é’Ÿ | æ”¯æŒé¢‘ç¹çš„é’±åŒ…æŸ¥è¯¢å’Œäº¤æ˜“ |
| /storage | 20æ¬¡/åˆ†é’Ÿ | æ–‡ä»¶æ“ä½œæˆæœ¬é«˜ï¼Œé™åˆ¶æ›´ä¸¥æ ¼ |
| /admin | 100æ¬¡/åˆ†é’Ÿ | ç®¡ç†å‘˜éœ€è¦æ‰¹é‡æ“ä½œæ”¯æŒ |

**è®¾è®¡åŸåˆ™**ï¼š
1. **å®‰å…¨ç¬¬ä¸€**ï¼šå…¬å¼€æ¥å£æœ€ä¸¥æ ¼
2. **æˆæœ¬è€ƒè™‘**ï¼šæ–‡ä»¶æ“ä½œé™åˆ¶æ›´ä¸¥
3. **ç”¨æˆ·ä½“éªŒ**ï¼šæ­£å¸¸ä½¿ç”¨ä¸å—å½±å“
4. **ç®¡ç†å‘˜ä¼˜å…ˆ**ï¼šæ›´é«˜çš„é™æµé˜ˆå€¼

## ä¸­é—´ä»¶æ‰§è¡Œæµç¨‹

```
Client Request
  â†“
1. ResponseFormatter (ç”ŸæˆRequestID)
  â†“
2. ResponseTiming (è®°å½•å¼€å§‹æ—¶é—´)
  â†“
3. CORS (å¤„ç†è·¨åŸŸ)
  â†“
4. Recovery (æ•è·panic)
  â†“
5. Gzip (å‡†å¤‡å‹ç¼©å™¨)
  â†“
[è·¯ç”±åŒ¹é…]
  â†“
6. RateLimit (æ£€æŸ¥é™æµ)
  â†“
7. JWT Auth (éªŒè¯Token)
  â†“
8. AdminPermission (éªŒè¯ç®¡ç†å‘˜æƒé™) [ä»…ç®¡ç†è·¯ç”±]
  â†“
9. API Handler (ä¸šåŠ¡é€»è¾‘)
  â†“
Response
  â†“
10. Gzip (å‹ç¼©å“åº”)
  â†“
11. ResponseTiming (æ·»åŠ å“åº”æ—¶é—´å¤´)
  â†“
12. ResponseFormatter (æ·»åŠ RequestIDå¤´)
  â†“
Client
```

## ä»£ç ç»Ÿè®¡

### æ–‡ä»¶æ¸…å•
| æ–‡ä»¶ | è¡Œæ•° | è¯´æ˜ |
|------|------|------|
| router/shared/shared_router.go | 102 | è·¯ç”±é…ç½®ï¼ˆæ›´æ–°ï¼‰ |
| middleware/admin_permission.go | 114 | ç®¡ç†å‘˜æƒé™ä¸­é—´ä»¶ï¼ˆæ–°å¢ï¼‰ |
| middleware/cors.go | 124 | CORSè·¨åŸŸä¸­é—´ä»¶ï¼ˆæ–°å¢ï¼‰ |
| middleware/rate_limit.go | 230+ | é€Ÿç‡é™åˆ¶ï¼ˆæ›´æ–°ï¼‰ |
| **æ€»è®¡** | **570+** | **4ä¸ªæ–‡ä»¶** |

### åŠŸèƒ½ç»Ÿè®¡
- **å…¨å±€ä¸­é—´ä»¶**: 5ä¸ª
- **è·¯ç”±ç»„é…ç½®**: 4ä¸ªæœåŠ¡
- **æ–°å¢ä¸­é—´ä»¶**: 2ä¸ª
- **é€Ÿç‡é™åˆ¶ç­–ç•¥**: 5ç§
- **æƒé™ç­‰çº§**: 3çº§ï¼ˆæ™®é€š/ç®¡ç†å‘˜/è¶…çº§ç®¡ç†å‘˜ï¼‰

## è®¾è®¡äº®ç‚¹

### 1. ä¸­é—´ä»¶åˆ†å±‚
**å…¨å±€å±‚**ï¼š
- åŸºç¡€åŠŸèƒ½ï¼ˆæ ¼å¼åŒ–ã€æ—¶é—´ã€CORSã€æ¢å¤ã€å‹ç¼©ï¼‰
- å¯¹æ‰€æœ‰è¯·æ±‚ç”Ÿæ•ˆ

**è·¯ç”±ç»„å±‚**ï¼š
- è®¤è¯ã€é™æµ
- æŒ‰æœåŠ¡ç‰¹æ€§é…ç½®

**ç‰¹å®šè·¯ç”±å±‚**ï¼š
- æƒé™éªŒè¯
- ç»†ç²’åº¦æ§åˆ¶

### 2. é€Ÿç‡é™åˆ¶ç­–ç•¥
**å·®å¼‚åŒ–é™æµ**ï¼š
- å…¬å¼€æ¥å£ï¼šä¸¥æ ¼ï¼ˆ10æ¬¡/åˆ†é’Ÿï¼‰
- æ™®é€šç”¨æˆ·ï¼šä¸­ç­‰ï¼ˆ30-50æ¬¡/åˆ†é’Ÿï¼‰
- æ–‡ä»¶æ“ä½œï¼šä¿å®ˆï¼ˆ20æ¬¡/åˆ†é’Ÿï¼‰
- ç®¡ç†å‘˜ï¼šå®½æ¾ï¼ˆ100æ¬¡/åˆ†é’Ÿï¼‰

**æŒ‰IPé™æµ**ï¼š
```go
key := c.ClientIP()
if !limiter.Allow(key) {
    // è¿”å›429é”™è¯¯
}
```

### 3. æƒé™åˆ†çº§
**ä¸‰çº§æƒé™ä½“ç³»**ï¼š
1. **æ™®é€šç”¨æˆ·**ï¼šåŸºæœ¬APIè®¿é—®
2. **ç®¡ç†å‘˜**ï¼ˆadminï¼‰ï¼šå†…å®¹å®¡æ ¸ã€ç”¨æˆ·ç®¡ç†
3. **è¶…çº§ç®¡ç†å‘˜**ï¼ˆsuper_adminï¼‰ï¼šç³»ç»Ÿé…ç½®ã€æƒé™ç®¡ç†

**æƒé™æ£€æŸ¥**ï¼š
```go
role, _ := c.Get("user_role")
if role != "admin" && role != "super_admin" {
    c.JSON(403, ...)
    c.Abort()
    return
}
```

### 4. CORSé…ç½®
**çµæ´»é…ç½®**ï¼š
- ç®€å•æ¨¡å¼ï¼šé€‚åˆå¼€å‘ç¯å¢ƒ
- é…ç½®æ¨¡å¼ï¼šé€‚åˆç”Ÿäº§ç¯å¢ƒ

**å®‰å…¨è€ƒè™‘**ï¼š
```go
// å¼€å‘ç¯å¢ƒ
AllowedOrigins: []string{"*"}

// ç”Ÿäº§ç¯å¢ƒ
AllowedOrigins: []string{"https://example.com"}
AllowCredentials: true
```

### 5. é”™è¯¯å“åº”ç»Ÿä¸€
**æ‰€æœ‰ä¸­é—´ä»¶ç»Ÿä¸€é”™è¯¯æ ¼å¼**ï¼š
```json
{
  "code": 403,
  "message": "æƒé™ä¸è¶³ï¼šéœ€è¦ç®¡ç†å‘˜æƒé™"
}

{
  "code": 429,
  "message": "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œæ¯60ç§’æœ€å¤š10æ¬¡è¯·æ±‚"
}
```

## ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯1ï¼šæ·»åŠ æ–°çš„ç®¡ç†å‘˜è·¯ç”±
```go
// è¶…çº§ç®¡ç†å‘˜ä¸“ç”¨è·¯ç”±
superAdminGroup := adminGroup.Group("/super")
superAdminGroup.Use(middleware.SuperAdminPermissionMiddleware())
{
    superAdminGroup.POST("/config", adminAPI.UpdateConfig)
    superAdminGroup.POST("/users/ban", adminAPI.BanUser)
}
```

### åœºæ™¯2ï¼šè‡ªå®šä¹‰CORSé…ç½®
```go
// ç”Ÿäº§ç¯å¢ƒCORS
corsConfig := middleware.CORSConfig{
    AllowedOrigins:   []string{"https://qingyu.com", "https://admin.qingyu.com"},
    AllowedMethods:   []string{"GET", "POST", "PUT", "DELETE"},
    AllowedHeaders:   []string{"Authorization", "Content-Type"},
    AllowCredentials: true,
    MaxAge:           3600,
}
r.Use(middleware.CORSMiddlewareWithConfig(corsConfig))
```

### åœºæ™¯3ï¼šè‡ªå®šä¹‰é™æµç­–ç•¥
```go
// VIPç”¨æˆ·è·¯ç”± - æ›´é«˜é™æµ
vipGroup := r.Group("/vip")
vipGroup.Use(middleware.JWTAuth())
vipGroup.Use(middleware.RateLimitMiddleware(200, 60)) // 200æ¬¡/åˆ†é’Ÿ
{
    vipGroup.GET("/content", vipAPI.GetContent)
}
```

### åœºæ™¯4ï¼šç‰¹å®šæƒé™éªŒè¯
```go
// éœ€è¦ç‰¹å®šæƒé™çš„è·¯ç”±
deleteGroup := userGroup.Group("/delete")
deleteGroup.Use(middleware.RequirePermissionsMiddleware("user:delete", "user:ban"))
{
    deleteGroup.DELETE("/:id", userAPI.DeleteUser)
}
```

## æŠ€æœ¯è¦ç‚¹

### 1. ä¸­é—´ä»¶é¡ºåºçš„é‡è¦æ€§
```go
// âœ“ æ­£ç¡®ï¼šRequestIDåœ¨æœ€å‰é¢
r.Use(middleware.ResponseFormatterMiddleware()) // ç”ŸæˆRequestID
r.Use(middleware.Logger())                      // æ—¥å¿—å¯ä»¥ä½¿ç”¨RequestID

// âœ— é”™è¯¯ï¼šLoggeråœ¨å‰é¢æ— æ³•è·å–RequestID
r.Use(middleware.Logger())                      // RequestIDæœªç”Ÿæˆ
r.Use(middleware.ResponseFormatterMiddleware()) // ç”ŸæˆRequestID
```

### 2. é€Ÿç‡é™åˆ¶å™¨å®ç°
**ä»¤ç‰Œæ¡¶ç®—æ³•**ï¼š
```go
type TokenBucketLimiter struct {
    limiters map[string]*rate.Limiter
    mutex    sync.RWMutex
    rps      rate.Limit
    burst    int
}

func (tbl *TokenBucketLimiter) Allow(key string) bool {
    limiter := tbl.getLimiter(key)
    return limiter.Allow()
}
```

### 3. Contextå€¼ä¼ é€’
```go
// JWTä¸­é—´ä»¶è®¾ç½®
c.Set("user_id", claims.UserID)
c.Set("user_role", claims.Role)

// æƒé™ä¸­é—´ä»¶è·å–
role, exists := c.Get("user_role")
```

### 4. ä¸­é—´ä»¶é“¾å¼è°ƒç”¨
```go
group.Use(middleware1())
group.Use(middleware2())
group.Use(middleware3())
// æ‰§è¡Œé¡ºåºï¼šmiddleware1 â†’ middleware2 â†’ middleware3 â†’ handler
```

## é—®é¢˜ä¿®å¤

### å·²ä¿®å¤
1. âœ… `RecoveryMiddleware` â†’ `Recovery`ï¼ˆä½¿ç”¨å·²å­˜åœ¨çš„ä¸­é—´ä»¶ï¼‰
2. âœ… `PermissionMiddleware`é‡å¤å£°æ˜ â†’ é‡å‘½åä¸º`RequirePermissionsMiddleware`
3. âœ… `checkPermission`é‡å¤å£°æ˜ â†’ é‡å‘½åä¸º`checkAdminPermission`
4. âœ… æ·»åŠ `RateLimitMiddleware`ç®€åŒ–å‡½æ•°

### æ— linteré”™è¯¯
```bash
âœ… router/shared: 0 errors
âœ… middleware/admin_permission.go: 0 errors
âœ… middleware/cors.go: 0 errors
âœ… middleware/rate_limit.go: 0 errors
```

## æ€§èƒ½è€ƒè™‘

### 1. ä¸­é—´ä»¶æ‰§è¡Œæˆæœ¬
| ä¸­é—´ä»¶ | æˆæœ¬ | è¯´æ˜ |
|--------|------|------|
| ResponseFormatter | æä½ | ä»…ç”Ÿæˆå­—ç¬¦ä¸² |
| ResponseTiming | æä½ | æ—¶é—´æˆ³è®°å½• |
| CORS | ä½ | å­—ç¬¦ä¸²æ¯”è¾ƒå’Œå¤´è®¾ç½® |
| Recovery | ä½ | defer+recover |
| Gzip | ä¸­ç­‰ | å‹ç¼©è®¡ç®—ï¼ˆä½¿ç”¨æ± ä¼˜åŒ–ï¼‰ |
| RateLimit | ä½ | ä»¤ç‰Œæ¡¶æ£€æŸ¥ |
| JWT | ä¸­ç­‰ | Tokenè§£æå’ŒéªŒè¯ |
| AdminPermission | æä½ | å­—ç¬¦ä¸²æ¯”è¾ƒ |

### 2. ä»¤ç‰Œæ¡¶æ± åŒ–
```go
var gzipWriterPool = sync.Pool{
    New: func() interface{} {
        return gzip.NewWriter(io.Discard)
    },
}
```

### 3. é™æµå™¨ç¼“å­˜
```go
func (tbl *TokenBucketLimiter) getLimiter(key string) *rate.Limiter {
    tbl.mutex.RLock()
    limiter, exists := tbl.limiters[key]
    tbl.mutex.RUnlock()

    if !exists {
        tbl.mutex.Lock()
        limiter = rate.NewLimiter(tbl.rps, tbl.burst)
        tbl.limiters[key] = limiter
        tbl.mutex.Unlock()
    }

    return limiter
}
```

## ä¸‹ä¸€æ­¥ä¼˜åŒ–

### çŸ­æœŸ
- [ ] æ·»åŠ ä¸­é—´ä»¶ç›‘æ§ï¼ˆæ‰§è¡Œæ—¶é—´ã€é”™è¯¯ç‡ï¼‰
- [ ] å®ç°åŸºäºRedisçš„åˆ†å¸ƒå¼é™æµ
- [ ] æ·»åŠ IPç™½åå•/é»‘åå•
- [ ] ç»†åŒ–æƒé™ç²’åº¦ï¼ˆresource:actionæ ¼å¼ï¼‰

### ä¸­æœŸ
- [ ] åŠ¨æ€è°ƒæ•´é™æµé˜ˆå€¼
- [ ] æ·»åŠ ç†”æ–­æœºåˆ¶
- [ ] å®ç°APIå¯†é’¥è®¤è¯
- [ ] æ·»åŠ è¯·æ±‚ç­¾åéªŒè¯

### é•¿æœŸ
- [ ] å®ç°WAFåŠŸèƒ½ï¼ˆWebåº”ç”¨é˜²ç«å¢™ï¼‰
- [ ] æ·»åŠ DDoSé˜²æŠ¤
- [ ] æœºå™¨å­¦ä¹ å¼‚å¸¸æ£€æµ‹
- [ ] åœ°ç†ä½ç½®é™åˆ¶

## æ€»ç»“

### ä¸»è¦æˆå°±
1. âœ… **å®Œæ•´çš„ä¸­é—´ä»¶é“¾**ï¼š5ä¸ªå…¨å±€ä¸­é—´ä»¶
2. âœ… **åˆ†å±‚é™æµç­–ç•¥**ï¼š5ç§ä¸åŒçš„é™æµé…ç½®
3. âœ… **æƒé™ç»†åŒ–**ï¼š3çº§æƒé™ä½“ç³»
4. âœ… **CORSæ”¯æŒ**ï¼šçµæ´»çš„è·¨åŸŸé…ç½®
5. âœ… **ç”Ÿäº§å°±ç»ª**ï¼šå®‰å…¨ã€æ€§èƒ½ã€ç›‘æ§ä¸€åº”ä¿±å…¨

### å…³é”®æŒ‡æ ‡
- **ä»£ç è¡Œæ•°**: 570+è¡Œ
- **æ–°å¢ä¸­é—´ä»¶**: 2ä¸ª
- **æ›´æ–°æ–‡ä»¶**: 2ä¸ª
- **è·¯ç”±ç»„é…ç½®**: 4ä¸ªæœåŠ¡
- **é€Ÿç‡é™åˆ¶ç­–ç•¥**: 5ç§
- **Linteré”™è¯¯**: 0
- **å¼€å‘æ—¶é—´**: ~0.5å°æ—¶

### æŠ€æœ¯äº®ç‚¹
1. **ä¸­é—´ä»¶åˆ†å±‚** - å…¨å±€/è·¯ç”±ç»„/ç‰¹å®šè·¯ç”±ä¸‰å±‚
2. **å·®å¼‚åŒ–é™æµ** - æ ¹æ®æœåŠ¡ç‰¹æ€§çµæ´»é…ç½®
3. **æƒé™åˆ†çº§** - æ™®é€š/ç®¡ç†å‘˜/è¶…çº§ç®¡ç†å‘˜
4. **ç»Ÿä¸€é”™è¯¯** - æ‰€æœ‰ä¸­é—´ä»¶ç»Ÿä¸€å“åº”æ ¼å¼
5. **æ€§èƒ½ä¼˜åŒ–** - æ± åŒ–ã€ç¼“å­˜ã€å¹¶å‘æ§åˆ¶

### ç»éªŒæ•™è®­
1. **é¡ºåºå¾ˆé‡è¦**ï¼šä¸­é—´ä»¶æ‰§è¡Œé¡ºåºç›´æ¥å½±å“åŠŸèƒ½
2. **é™æµè¦åˆç†**ï¼šè¿‡ä¸¥å½±å“ä½“éªŒï¼Œè¿‡æ¾å­˜åœ¨é£é™©
3. **æƒé™è¦æ˜ç¡®**ï¼šæ¸…æ™°çš„æƒé™ä½“ç³»ä¾¿äºç®¡ç†
4. **é”™è¯¯è¦å‹å¥½**ï¼šç»Ÿä¸€çš„é”™è¯¯æ ¼å¼æ–¹ä¾¿å®¢æˆ·ç«¯å¤„ç†

---

**ä»»åŠ¡çŠ¶æ€**: âœ… å·²å®Œæˆ

**è´¨é‡è¯„ä¼°**: 
- åŠŸèƒ½å®Œæ•´æ€§: â­â­â­â­â­
- ä»£ç è´¨é‡: â­â­â­â­â­
- å®‰å…¨æ€§: â­â­â­â­â­
- æ€§èƒ½: â­â­â­â­â­
- å¯ç»´æŠ¤æ€§: â­â­â­â­â­

**ä¸‹ä¸€é˜¶æ®µ**: ä»»åŠ¡3 - æ–‡æ¡£å®Œå–„ï¼ˆAPIä½¿ç”¨æ–‡æ¡£ã€éƒ¨ç½²æŒ‡å—ã€æ€§èƒ½ä¼˜åŒ–æŒ‡å—ï¼‰

**ğŸ‰ ä»»åŠ¡2ï¼ˆAPIå±‚å®ç°ï¼‰å…¨éƒ¨å®Œæˆï¼**

