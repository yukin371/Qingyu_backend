# Stats æœåŠ¡æ¶æ„é‡æ„æŠ¥å‘Š

**æ—¥æœŸ**ï¼š2025-10-27  
**ä½œè€…**ï¼šé’ç¾½åç«¯å›¢é˜Ÿ  
**ç‰ˆæœ¬**ï¼šv1.0  

---

## ğŸ“‹ é‡æ„èƒŒæ™¯

### é—®é¢˜å‘ç°

ç”¨æˆ·å‘ç°ä»¥ä¸‹æ¶æ„ä¸ä¸€è‡´é—®é¢˜ï¼š

1. **Repository å±‚**ï¼š`repository/interfaces/stats` ç‹¬ç«‹å­˜åœ¨
2. **Service å±‚**ï¼š
   - `service/shared/stats/stats_service.go` - å¹³å°çº§ç»Ÿè®¡
   - `service/stats/stats_service.go` - é˜…è¯»/ä¹¦åº—ç»Ÿè®¡

**å…³é”®ç–‘é—®**ï¼š
> "repositoryä¸­sharedå’Œstatsæ˜¯åˆ†ç¦»çš„ï¼Œè€Œserviceå±‚ä¸­å´åœ¨ä¸€èµ·ï¼Œè¿™æ ·è®¾è®¡æ˜¯å¦èƒ½ä¿è¯é¡¹ç›®æ¸…æ™°ï¼Ÿ"

---

## ğŸ” é—®é¢˜åˆ†æ

### ç°çŠ¶è°ƒæŸ¥

æ£€æŸ¥ä¸¤ä¸ªstatsæœåŠ¡çš„å†…å®¹åå‘ç°ï¼š

#### 1. `service/stats/stats_service.go` (æ—§è·¯å¾„)
**èŒè´£**ï¼šé˜…è¯»/ä¹¦åº—é¢†åŸŸçš„ç»Ÿè®¡
- `CalculateBookStats` - è®¡ç®—ä½œå“ç»Ÿè®¡
- `CalculateChapterStats` - è®¡ç®—ç« èŠ‚ç»Ÿè®¡
- `GenerateHeatmap` - ç”Ÿæˆé˜…è¯»çƒ­åŠ›å›¾
- `GetRevenueBreakdown` - è·å–æ”¶ç›Šç»†åˆ†
- `RecordReaderBehavior` - è®°å½•è¯»è€…è¡Œä¸º
- `CalculateRetention` - è®¡ç®—ç•™å­˜ç‡

**é¢†åŸŸå½’å±**ï¼š`Reading/Bookstore`

#### 2. `service/shared/stats/stats_service.go` (ç°è·¯å¾„)
**èŒè´£**ï¼šå¹³å°çº§èšåˆç»Ÿè®¡
- `GetUserStats` - ç”¨æˆ·ç»Ÿè®¡ï¼ˆè·¨åŸŸèšåˆï¼‰
- `GetPlatformUserStats` - å¹³å°ç”¨æˆ·ç»Ÿè®¡
- `GetContentStats` - å†…å®¹ç»Ÿè®¡ï¼ˆè·¨åŸŸï¼‰
- `GetPlatformContentStats` - å¹³å°å†…å®¹ç»Ÿè®¡
- `GetUserActivityStats` - ç”¨æˆ·æ´»è·ƒåº¦ç»Ÿè®¡
- `GetRevenueStats` - æ”¶ç›Šç»Ÿè®¡

**é¢†åŸŸå½’å±**ï¼š`Platform/Shared`

### é—®é¢˜è¯†åˆ«

ä¸¤ä¸ªæœåŠ¡**ä¸å†—ä½™**ï¼Œä½†å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **å‘½åæ··æ·†**ï¼šä¸¤ä¸ªéƒ½å« `StatsService`ï¼ŒèŒè´£ä¸æ˜ç¡®
2. **è·¯å¾„ä¸ç¬¦åˆDDD**ï¼š`service/stats/` åº”è¯¥æŒ‰ä¸šåŠ¡é¢†åŸŸç»„ç»‡
3. **ç¼ºä¹æ¸…æ™°çš„è¾¹ç•Œ**ï¼šä¸æ˜“çœ‹å‡ºå“ªä¸ªæ˜¯å¹³å°çº§ã€å“ªä¸ªæ˜¯é¢†åŸŸçº§

---

## âœ… é‡æ„æ–¹æ¡ˆ

### æ ¸å¿ƒåŸåˆ™

æŒ‰ç…§ **DDD é¢†åŸŸé©±åŠ¨è®¾è®¡** åŸåˆ™ï¼Œå°†ç»Ÿè®¡æœåŠ¡æŒ‰ä¸šåŠ¡é¢†åŸŸåˆ†ç¦»ï¼š

```
Platform Stats (shared)  -> å¹³å°çº§èšåˆç»Ÿè®¡
   â†‘
   â””â”€â”€ èšåˆ Reading Statsã€User Statsã€Writing Stats...

Reading Stats (reading)  -> é˜…è¯»/ä¹¦åº—ç»Ÿè®¡
User Stats (user)        -> ç”¨æˆ·é¢†åŸŸç»Ÿè®¡ (TODO: Phase3)
Writing Stats (writing)  -> å†™ä½œé¢†åŸŸç»Ÿè®¡ (TODO: Phase3)
```

### é‡æ„æ“ä½œ

#### 1. é‡å‘½åå¹³å°ç»Ÿè®¡æœåŠ¡

**æ–‡ä»¶**ï¼š`service/shared/stats/stats_service.go`

**å˜æ›´**ï¼š
- `StatsService` â†’ `PlatformStatsService`
- `StatsServiceImpl` â†’ `PlatformStatsServiceImpl`
- `NewStatsService()` â†’ `NewPlatformStatsService()`

**æ–°å¢æ³¨é‡Š**ï¼š
```go
// PlatformStatsService å¹³å°ç»Ÿè®¡æœåŠ¡æ¥å£
// èŒè´£ï¼šè·¨ä¸šåŠ¡åŸŸçš„èšåˆç»Ÿè®¡ã€å¹³å°çº§æ•°æ®åˆ†æ
// é¢†åŸŸï¼šPlatform/Shared
```

#### 2. ç§»åŠ¨é˜…è¯»ç»Ÿè®¡æœåŠ¡

**å˜æ›´**ï¼š
- ç§»åŠ¨ï¼š`service/stats/` â†’ `service/reading/stats/`
- é‡å‘½åï¼š`StatsService` â†’ `ReadingStatsService`
- é‡å‘½åï¼š`StatsServiceImpl` â†’ `ReadingStatsServiceImpl`

**æ–°å¢æ³¨é‡Š**ï¼š
```go
// ReadingStatsService é˜…è¯»/ä¹¦åº—ç»Ÿè®¡æœåŠ¡æ¥å£
// èŒè´£ï¼šä½œå“ã€ç« èŠ‚çš„é˜…è¯»æ•°æ®ç»Ÿè®¡å’Œåˆ†æ
// é¢†åŸŸï¼šReading/Bookstore
```

#### 3. æ›´æ–°APIå±‚å¼•ç”¨

**å¹³å°ç»Ÿè®¡API**ï¼š`api/v1/shared/stats_api.go`
```go
// ä½¿ç”¨ PlatformStatsService
statsService stats.PlatformStatsService
```

**é˜…è¯»ç»Ÿè®¡API**ï¼š`api/v1/writer/stats_api.go`
```go
// ä½¿ç”¨ ReadingStatsService
import readingStats "Qingyu_backend/service/reading/stats"
statsService *readingStats.ReadingStatsService
```

**è·¯ç”±å±‚**ï¼š`router/writer/stats.go`
```go
import readingStats "Qingyu_backend/service/reading/stats"
func InitStatsRouter(r *gin.RouterGroup, service *readingStats.ReadingStatsService)
```

---

## ğŸ“Š é‡æ„å‰åå¯¹æ¯”

### æ¶æ„å¯¹æ¯”è¡¨

| å¯¹æ¯”é¡¹ | é‡æ„å‰ | é‡æ„å |
|--------|--------|--------|
| **å¹³å°ç»Ÿè®¡** | `service/shared/stats/StatsService` | `service/shared/stats/PlatformStatsService` |
| **é˜…è¯»ç»Ÿè®¡** | `service/stats/StatsService` | `service/reading/stats/ReadingStatsService` |
| **é¢†åŸŸå½’å±** | ä¸æ˜ç¡® | æ¸…æ™°ï¼ˆPlatform vs Readingï¼‰ |
| **å‘½åå†²çª** | ä¸¤ä¸ªéƒ½å«StatsService | åç§°åŒºåˆ†æ˜ç¡® |
| **DDDç¬¦åˆåº¦** | âŒ | âœ… |

### ç›®å½•ç»“æ„å¯¹æ¯”

#### é‡æ„å‰
```
service/
  â”œâ”€â”€ shared/
  â”‚   â””â”€â”€ stats/
  â”‚       â””â”€â”€ stats_service.go          (å¹³å°ç»Ÿè®¡)
  â””â”€â”€ stats/
      â””â”€â”€ stats_service.go              (é˜…è¯»ç»Ÿè®¡)
```

#### é‡æ„å
```
service/
  â”œâ”€â”€ shared/
  â”‚   â””â”€â”€ stats/
  â”‚       â””â”€â”€ stats_service.go          (PlatformStatsService)
  â””â”€â”€ reading/
      â””â”€â”€ stats/
          â””â”€â”€ reading_stats_service.go  (ReadingStatsService)
```

---

## ğŸ¯ è®¾è®¡åŸåˆ™éªŒè¯

### âœ… ç¬¦åˆæ¶æ„è§„èŒƒ

| åŸåˆ™ | éªŒè¯ç»“æœ |
|------|---------|
| **DDDé¢†åŸŸåˆ†ç¦»** | âœ… æŒ‰Readingã€Platformé¢†åŸŸæ¸…æ™°åˆ†ç¦» |
| **å•ä¸€èŒè´£** | âœ… Platformèšåˆç»Ÿè®¡ vs Readingé¢†åŸŸç»Ÿè®¡ |
| **å‘½åä¸€è‡´æ€§** | âœ… æœåŠ¡åç§°ä¸èŒè´£åŒ¹é… |
| **å¯æ‰©å±•æ€§** | âœ… ä¾¿äºåç»­æ·»åŠ UserStatsã€WritingStats |

### æœªæ¥æ‰©å±•

Phase 3 å¯ç»§ç»­æ·»åŠ ï¼š

```
service/
  â”œâ”€â”€ shared/stats/              (å¹³å°çº§èšåˆ)
  â”œâ”€â”€ reading/stats/             (é˜…è¯»ç»Ÿè®¡) âœ…
  â”œâ”€â”€ user/stats/                (ç”¨æˆ·ç»Ÿè®¡) TODO
  â”œâ”€â”€ writing/stats/             (å†™ä½œç»Ÿè®¡) TODO
  â””â”€â”€ ai/stats/                  (AIä½¿ç”¨ç»Ÿè®¡) TODO
```

---

## ğŸ“ å½±å“èŒƒå›´

### ä»£ç å˜æ›´

| æ–‡ä»¶ç±»å‹ | å˜æ›´æ•°é‡ | å˜æ›´è¯´æ˜ |
|---------|---------|---------|
| Serviceå±‚ | 2ä¸ªæ–‡ä»¶ | é‡å‘½å+ç§»åŠ¨ |
| APIå±‚ | 2ä¸ªæ–‡ä»¶ | æ›´æ–°å¼•ç”¨ |
| Routerå±‚ | 1ä¸ªæ–‡ä»¶ | æ›´æ–°å¼•ç”¨ |
| æ€»è®¡ | 5ä¸ªæ–‡ä»¶ | æ— ç ´åæ€§å˜æ›´ï¼ˆæ¥å£ä¿æŒå…¼å®¹ï¼‰ |

### æµ‹è¯•éªŒè¯

- âœ… Lintæ£€æŸ¥é€šè¿‡
- âœ… æ— ç¼–è¯‘é”™è¯¯
- âš ï¸ å•å…ƒæµ‹è¯•éœ€è¦æ›´æ–°å¼•ç”¨ï¼ˆå¦‚æœ‰ï¼‰

---

## ğŸ”„ å‡çº§æŒ‡å¯¼

### å¯¹äºæ–°ä»£ç 

ç›´æ¥ä½¿ç”¨æ–°çš„åŒ…è·¯å¾„ï¼š

```go
// å¹³å°çº§ç»Ÿè®¡
import platformStats "Qingyu_backend/service/shared/stats"
statsService := platformStats.NewPlatformStatsService()

// é˜…è¯»ç»Ÿè®¡
import readingStats "Qingyu_backend/service/reading/stats"
statsService := readingStats.NewReadingStatsService(...)
```

### å¯¹äºç°æœ‰ä»£ç 

æ›´æ–°å¯¼å…¥è·¯å¾„ï¼š

```go
// æ—§
import statsService "Qingyu_backend/service/stats"

// æ–°
import readingStats "Qingyu_backend/service/reading/stats"
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [x] æœåŠ¡é‡å‘½åå®Œæˆ
- [x] ç›®å½•ç»“æ„ç¬¦åˆDDD
- [x] APIå±‚å¼•ç”¨æ›´æ–°
- [x] Routerå±‚å¼•ç”¨æ›´æ–°
- [x] Lintæ£€æŸ¥é€šè¿‡
- [x] æ— ç¼–è¯‘é”™è¯¯

### æ–‡æ¡£éªŒæ”¶

- [x] é‡æ„æŠ¥å‘Šå®Œæˆ
- [x] ä»£ç æ³¨é‡Šæ›´æ–°
- [ ] æ¶æ„æ–‡æ¡£æ›´æ–°ï¼ˆå¾…æ›´æ–°æ€»ä½“æ¶æ„å›¾ï¼‰

---

## ğŸ“Œ æ€»ç»“

### é‡æ„æˆæœ

1. **è§£å†³äº†æ¶æ„ä¸ä¸€è‡´é—®é¢˜**ï¼šServiceå±‚ä¸Repositoryå±‚ç°åœ¨éƒ½æŒ‰é¢†åŸŸåˆ†ç¦»
2. **æé«˜äº†ä»£ç å¯è¯»æ€§**ï¼šæœåŠ¡å‘½åæ¸…æ™°è¡¨è¾¾èŒè´£
3. **ç¬¦åˆDDDåŸåˆ™**ï¼šæŒ‰ä¸šåŠ¡é¢†åŸŸç»„ç»‡ä»£ç 
4. **ä¾¿äºæœªæ¥æ‰©å±•**ï¼šå¯ä»¥ç»§ç»­æ·»åŠ å…¶ä»–é¢†åŸŸçš„StatsæœåŠ¡

### å…³é”®æ”¹è¿›

| æ”¹è¿›ç‚¹ | è¯´æ˜ |
|--------|------|
| **æ¸…æ™°åº¦** | PlatformStatsService vs ReadingStatsService |
| **ä¸€è‡´æ€§** | æ‰€æœ‰é¢†åŸŸéƒ½æŒ‰ `service/{domain}/stats/` ç»„ç»‡ |
| **å¯ç»´æŠ¤æ€§** | èŒè´£è¾¹ç•Œæ¸…æ™°ï¼Œä¾¿äºå®šä½å’Œä¿®æ”¹ |
| **å¯æ‰©å±•æ€§** | ä¸ºPhase3æ–°å¢é¢†åŸŸç»Ÿè®¡æä¾›æ¨¡æ¿ |

---

**æœ€åæ›´æ–°**ï¼š2025-10-27  
**çŠ¶æ€**ï¼šâœ… é‡æ„å®Œæˆ  
**ä¸‹ä¸€æ­¥**ï¼šæ›´æ–°æ¶æ„æ–‡æ¡£ä¸­çš„Serviceå±‚ç»„ç»‡å›¾

