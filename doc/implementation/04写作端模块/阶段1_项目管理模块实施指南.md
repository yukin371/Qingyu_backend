# 阶段1：项目管理模块实施指南

> **实施周期**: 5天（2025.10.17 - 2025.10.21）  
> **负责人**: 开发团队  
> **状态**: ⏸️ 待开始

## 实施概览

本阶段实施写作端的项目管理和文档管理核心功能，包括项目CRUD、文档树管理、权限控制等。

### 目标成果

- ✅ 完整的项目管理功能
- ✅ 文档树形结构管理
- ✅ 权限控制体系
- ✅ 6个核心API接口
- ✅ 单元测试覆盖率≥90%

---

## 任务1.1：Project模型与Repository（Day 1，8小时）

### 📋 任务清单

#### 1.1.1 创建Project模型

**文件**: `models/document/project.go`

**实施步骤**:

1. 创建目录结构
```bash
mkdir -p models/document
```

2. 创建Project模型文件
```go
// models/document/project.go
package document

import "time"

// Project 项目模型
type Project struct {
    ID          string         `bson:"_id,omitempty" json:"id"`
    AuthorID    string         `bson:"author_id" json:"authorId" validate:"required"`
    Title       string         `bson:"title" json:"title" validate:"required,min=1,max=100"`
    Summary     string         `bson:"summary,omitempty" json:"summary,omitempty"`
    CoverURL    string         `bson:"cover_url,omitempty" json:"coverUrl,omitempty"`
    Status      ProjectStatus  `bson:"status" json:"status"`
    Category    string         `bson:"category,omitempty" json:"category,omitempty"`
    Tags        []string       `bson:"tags,omitempty" json:"tags,omitempty"`
    Visibility  Visibility     `bson:"visibility" json:"visibility"`
    
    // 统计信息
    Statistics  ProjectStats   `bson:"statistics" json:"statistics"`
    
    // 设置信息
    Settings    ProjectSettings `bson:"settings" json:"settings"`
    
    // 协作信息
    Collaborators []Collaborator `bson:"collaborators,omitempty" json:"collaborators,omitempty"`
    
    // 时间戳
    CreatedAt   time.Time      `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time      `bson:"updated_at" json:"updatedAt"`
    PublishedAt *time.Time     `bson:"published_at,omitempty" json:"publishedAt,omitempty"`
    DeletedAt   *time.Time     `bson:"deleted_at,omitempty" json:"deletedAt,omitempty"`
}

// ProjectStatus 项目状态
type ProjectStatus string

const (
    StatusDraft       ProjectStatus = "draft"
    StatusSerializing ProjectStatus = "serializing"
    StatusCompleted   ProjectStatus = "completed"
    StatusSuspended   ProjectStatus = "suspended"
    StatusArchived    ProjectStatus = "archived"
)

// Visibility 可见性
type Visibility string

const (
    VisibilityPrivate Visibility = "private"
    VisibilityPublic  Visibility = "public"
)

// ProjectStats 项目统计
type ProjectStats struct {
    TotalWords    int       `bson:"total_words" json:"totalWords"`
    ChapterCount  int       `bson:"chapter_count" json:"chapterCount"`
    DocumentCount int       `bson:"document_count" json:"documentCount"`
    LastUpdateAt  time.Time `bson:"last_update_at" json:"lastUpdateAt"`
}

// ProjectSettings 项目设置
type ProjectSettings struct {
    AutoBackup     bool `bson:"auto_backup" json:"autoBackup"`
    BackupInterval int  `bson:"backup_interval" json:"backupInterval"`
    WordCountGoal  int  `bson:"word_count_goal,omitempty" json:"wordCountGoal,omitempty"`
}

// Collaborator 协作者
type Collaborator struct {
    UserID     string           `bson:"user_id" json:"userId"`
    Role       CollaboratorRole `bson:"role" json:"role"`
    InvitedAt  time.Time        `bson:"invited_at" json:"invitedAt"`
    AcceptedAt *time.Time       `bson:"accepted_at,omitempty" json:"acceptedAt,omitempty"`
}

// CollaboratorRole 协作者角色
type CollaboratorRole string

const (
    RoleOwner  CollaboratorRole = "owner"
    RoleEditor CollaboratorRole = "editor"
    RoleViewer CollaboratorRole = "viewer"
)

// 业务方法
func (p *Project) IsOwner(userID string) bool {
    return p.AuthorID == userID
}

func (p *Project) CanEdit(userID string) bool {
    if p.IsOwner(userID) {
        return true
    }
    
    for _, collab := range p.Collaborators {
        if collab.UserID == userID && collab.Role == RoleEditor && collab.AcceptedAt != nil {
            return true
        }
    }
    
    return false
}

func (p *Project) CanView(userID string) bool {
    if p.CanEdit(userID) {
        return true
    }
    
    for _, collab := range p.Collaborators {
        if collab.UserID == userID && collab.AcceptedAt != nil {
            return true
        }
    }
    
    return p.Visibility == VisibilityPublic
}

func (p *Project) UpdateStatistics(stats ProjectStats) {
    p.Statistics = stats
    p.UpdatedAt = time.Now()
}
```

**验证**:
- [ ] 模型文件编译通过
- [ ] 所有常量定义正确
- [ ] 业务方法逻辑正确

#### 1.1.2 创建ProjectRepository接口

**文件**: `repository/interfaces/writing/project_repository.go`

**实施步骤**:

1. 创建接口目录
```bash
mkdir -p repository/interfaces/writing
```

2. 创建接口定义（参考设计文档第3.2.1节）

**验证**:
- [ ] 接口定义完整
- [ ] 方法签名符合规范
- [ ] 包含所有必要方法

#### 1.1.3 实现MongoProjectRepository

**文件**: `repository/mongodb/writing/project_repository_mongo.go`

**实施步骤**:

1. 创建MongoDB实现目录
```bash
mkdir -p repository/mongodb/writing
```

2. 实现所有接口方法（参考设计文档第3.2.2节）

**关键实现**:
- Create: 初始化默认值、生成ID
- GetByID: 排除已删除项目
- Update: 自动更新updated_at
- SoftDelete: 软删除而非物理删除
- 索引创建: author_id, status, created_at

**验证**:
- [ ] 所有接口方法实现
- [ ] 错误处理完整
- [ ] 索引创建正确

#### 1.1.4 更新Repository工厂

**文件**: `repository/mongodb/factory.go`

**修改内容**:
```go
func (f *MongoRepositoryFactory) CreateProjectRepository() writing.ProjectRepository {
    return writing.NewMongoProjectRepository(f.db)
}
```

**验证**:
- [ ] 工厂方法添加成功
- [ ] 接口导入正确

---

### 🧪 测试1.1：ProjectRepository测试（2小时）

**文件**: `test/repository/project_repository_test.go`

**测试用例**:

```go
package repository

import (
    "context"
    "testing"
    "time"
    
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/require"
    
    "qingyu_backend/models/document"
    "qingyu_backend/repository/mongodb"
    "qingyu_backend/test/testutil"
)

func TestProjectRepository_Create(t *testing.T) {
    // 1. 初始化测试环境
    factory := testutil.SetupTestDB(t)
    defer testutil.TeardownTestDB(t, factory)
    
    repo := factory.CreateProjectRepository()
    ctx := context.Background()
    
    // 2. 测试正常创建
    t.Run("正常创建项目", func(t *testing.T) {
        project := &document.Project{
            AuthorID: "user123",
            Title:    "测试项目",
            Summary:  "这是一个测试项目",
        }
        
        err := repo.Create(ctx, project)
        require.NoError(t, err)
        assert.NotEmpty(t, project.ID)
        assert.Equal(t, document.StatusDraft, project.Status)
        assert.Equal(t, document.VisibilityPrivate, project.Visibility)
    })
    
    // 3. 测试统计初始化
    t.Run("统计信息初始化", func(t *testing.T) {
        project := &document.Project{
            AuthorID: "user123",
            Title:    "测试项目2",
        }
        
        err := repo.Create(ctx, project)
        require.NoError(t, err)
        assert.Equal(t, 0, project.Statistics.TotalWords)
        assert.Equal(t, 0, project.Statistics.ChapterCount)
    })
}

func TestProjectRepository_GetByID(t *testing.T) {
    factory := testutil.SetupTestDB(t)
    defer testutil.TeardownTestDB(t, factory)
    
    repo := factory.CreateProjectRepository()
    ctx := context.Background()
    
    // 1. 创建测试数据
    project := &document.Project{
        AuthorID: "user123",
        Title:    "测试项目",
    }
    err := repo.Create(ctx, project)
    require.NoError(t, err)
    
    // 2. 测试查询存在的项目
    t.Run("查询存在的项目", func(t *testing.T) {
        found, err := repo.GetByID(ctx, project.ID)
        require.NoError(t, err)
        assert.NotNil(t, found)
        assert.Equal(t, project.Title, found.Title)
    })
    
    // 3. 测试查询不存在的项目
    t.Run("查询不存在的项目", func(t *testing.T) {
        found, err := repo.GetByID(ctx, "nonexistent")
        assert.NoError(t, err)
        assert.Nil(t, found)
    })
    
    // 4. 测试软删除后查询
    t.Run("软删除后不可查询", func(t *testing.T) {
        err := repo.SoftDelete(ctx, project.ID)
        require.NoError(t, err)
        
        found, err := repo.GetByID(ctx, project.ID)
        assert.NoError(t, err)
        assert.Nil(t, found)
    })
}

func TestProjectRepository_Update(t *testing.T) {
    factory := testutil.SetupTestDB(t)
    defer testutil.TeardownTestDB(t, factory)
    
    repo := factory.CreateProjectRepository()
    ctx := context.Background()
    
    // 创建测试数据
    project := &document.Project{
        AuthorID: "user123",
        Title:    "原标题",
    }
    err := repo.Create(ctx, project)
    require.NoError(t, err)
    
    // 测试更新
    t.Run("更新项目信息", func(t *testing.T) {
        updates := map[string]interface{}{
            "title":   "新标题",
            "summary": "新简介",
        }
        
        err := repo.Update(ctx, project.ID, updates)
        require.NoError(t, err)
        
        // 验证更新
        updated, err := repo.GetByID(ctx, project.ID)
        require.NoError(t, err)
        assert.Equal(t, "新标题", updated.Title)
        assert.Equal(t, "新简介", updated.Summary)
    })
}

func TestProjectRepository_GetByAuthorID(t *testing.T) {
    factory := testutil.SetupTestDB(t)
    defer testutil.TeardownTestDB(t, factory)
    
    repo := factory.CreateProjectRepository()
    ctx := context.Background()
    
    authorID := "user123"
    
    // 创建多个项目
    for i := 0; i < 3; i++ {
        project := &document.Project{
            AuthorID: authorID,
            Title:    fmt.Sprintf("项目%d", i+1),
        }
        err := repo.Create(ctx, project)
        require.NoError(t, err)
    }
    
    // 查询作者的所有项目
    t.Run("查询作者的所有项目", func(t *testing.T) {
        projects, err := repo.GetByAuthorID(ctx, authorID)
        require.NoError(t, err)
        assert.Equal(t, 3, len(projects))
    })
}
```

**测试覆盖**:
- [x] Create方法测试
- [x] GetByID方法测试
- [x] Update方法测试
- [x] GetByAuthorID方法测试
- [ ] SoftDelete方法测试
- [ ] UpdateStatistics方法测试
- [ ] AddCollaborator方法测试

**运行测试**:
```bash
go test ./test/repository/project_repository_test.go -v
```

**验收标准**:
- [ ] 所有测试用例通过
- [ ] 测试覆盖率≥90%
- [ ] 无数据泄漏

---

## 任务1.2：ProjectService业务逻辑（Day 2，8小时）

### 📋 任务清单

#### 1.2.1 创建Service接口

**文件**: `service/interfaces/project_service.go`

**实施步骤**:

1. 创建接口目录
```bash
mkdir -p service/interfaces
```

2. 定义Service接口（可选，Go中可直接实现）

#### 1.2.2 实现ProjectService

**文件**: `service/project/project_service.go`

**实施步骤**:

1. 创建service目录
```bash
mkdir -p service/project
```

2. 实现ProjectService（参考设计文档第3.3节）

**关键方法**:
- CreateProject: 创建项目，发布事件
- GetProject: 获取项目，权限检查
- ListMyProjects: 分页查询，过滤条件
- UpdateProject: 更新项目，权限验证
- DeleteProject: 软删除，级联处理
- UpdateProjectStatistics: 统计更新

**验证**:
- [ ] 所有方法实现完整
- [ ] 权限检查正确
- [ ] 事件发布正常
- [ ] 错误处理完善

#### 1.2.3 创建Request/Response模型

**文件**: `service/project/project_dto.go`

**实施步骤**:

```go
package project

import "time"

// CreateProjectRequest 创建项目请求
type CreateProjectRequest struct {
    Title    string   `json:"title" validate:"required,min=1,max=100"`
    Summary  string   `json:"summary,omitempty"`
    CoverURL string   `json:"coverUrl,omitempty"`
    Category string   `json:"category,omitempty"`
    Tags     []string `json:"tags,omitempty"`
}

// CreateProjectResponse 创建项目响应
type CreateProjectResponse struct {
    ProjectID string    `json:"projectId"`
    Title     string    `json:"title"`
    Status    string    `json:"status"`
    CreatedAt time.Time `json:"createdAt"`
}

// UpdateProjectRequest 更新项目请求
type UpdateProjectRequest struct {
    Title    string   `json:"title,omitempty"`
    Summary  string   `json:"summary,omitempty"`
    CoverURL string   `json:"coverUrl,omitempty"`
    Category string   `json:"category,omitempty"`
    Tags     []string `json:"tags,omitempty"`
    Status   string   `json:"status,omitempty"`
}

// ListProjectsRequest 项目列表请求
type ListProjectsRequest struct {
    Page     int    `json:"page"`
    PageSize int    `json:"pageSize"`
    Status   string `json:"status,omitempty"`
    Category string `json:"category,omitempty"`
}

// ListProjectsResponse 项目列表响应
type ListProjectsResponse struct {
    Projects []*document.Project `json:"projects"`
    Total    int64               `json:"total"`
    Page     int                 `json:"page"`
    PageSize int                 `json:"pageSize"`
}
```

**验证**:
- [ ] DTO定义完整
- [ ] 验证标签正确

#### 1.2.4 注册Service到容器

**文件**: `service/container/service_container.go`

**修改内容**:
```go
// 初始化ProjectService
projectRepo := repositoryFactory.CreateProjectRepository()
documentRepo := repositoryFactory.CreateDocumentRepository()
eventBus := base.NewSimpleEventBus()

projectService := project.NewProjectService(projectRepo, documentRepo, eventBus)
container.RegisterService("ProjectService", projectService)
```

**验证**:
- [ ] Service注册成功
- [ ] 依赖注入正确

---

### 🧪 测试1.2：ProjectService测试（2小时）

**文件**: `test/service/project_service_test.go`

**测试用例**:

```go
package service

import (
    "context"
    "testing"
    
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"
    "github.com/stretchr/testify/require"
    
    "qingyu_backend/models/document"
    "qingyu_backend/service/project"
    "qingyu_backend/test/mocks"
)

func TestProjectService_CreateProject(t *testing.T) {
    // 1. 创建Mock Repository
    mockProjectRepo := new(mocks.MockProjectRepository)
    mockDocumentRepo := new(mocks.MockDocumentRepository)
    mockEventBus := new(mocks.MockEventBus)
    
    // 2. 创建Service
    service := project.NewProjectService(mockProjectRepo, mockDocumentRepo, mockEventBus)
    
    ctx := context.WithValue(context.Background(), "userID", "user123")
    
    // 3. 设置Mock期望
    mockProjectRepo.On("Create", mock.Anything, mock.AnythingOfType("*document.Project")).Return(nil)
    mockEventBus.On("PublishAsync", mock.Anything, mock.Anything).Return()
    
    // 4. 执行测试
    t.Run("正常创建项目", func(t *testing.T) {
        req := &project.CreateProjectRequest{
            Title:    "测试项目",
            Summary:  "测试简介",
            Category: "玄幻",
            Tags:     []string{"热血"},
        }
        
        resp, err := service.CreateProject(ctx, req)
        
        require.NoError(t, err)
        assert.NotNil(t, resp)
        assert.Equal(t, "测试项目", resp.Title)
        assert.Equal(t, "draft", resp.Status)
    })
    
    // 5. 测试参数验证
    t.Run("标题为空应该失败", func(t *testing.T) {
        req := &project.CreateProjectRequest{
            Title: "",
        }
        
        resp, err := service.CreateProject(ctx, req)
        
        assert.Error(t, err)
        assert.Nil(t, resp)
    })
    
    // 6. 验证Mock调用
    mockProjectRepo.AssertExpectations(t)
    mockEventBus.AssertExpectations(t)
}

func TestProjectService_GetProject(t *testing.T) {
    mockProjectRepo := new(mocks.MockProjectRepository)
    mockDocumentRepo := new(mocks.MockDocumentRepository)
    mockEventBus := new(mocks.MockEventBus)
    
    service := project.NewProjectService(mockProjectRepo, mockDocumentRepo, mockEventBus)
    
    ctx := context.WithValue(context.Background(), "userID", "user123")
    
    // 测试获取项目
    t.Run("获取存在的项目", func(t *testing.T) {
        testProject := &document.Project{
            ID:       "project123",
            AuthorID: "user123",
            Title:    "测试项目",
            Visibility: document.VisibilityPrivate,
        }
        
        mockProjectRepo.On("GetByID", mock.Anything, "project123").Return(testProject, nil)
        
        result, err := service.GetProject(ctx, "project123")
        
        require.NoError(t, err)
        assert.Equal(t, "测试项目", result.Title)
    })
    
    // 测试权限检查
    t.Run("无权限访问私密项目", func(t *testing.T) {
        testProject := &document.Project{
            ID:       "project123",
            AuthorID: "other_user",
            Title:    "他人项目",
            Visibility: document.VisibilityPrivate,
        }
        
        mockProjectRepo.On("GetByID", mock.Anything, "project123").Return(testProject, nil)
        
        result, err := service.GetProject(ctx, "project123")
        
        assert.Error(t, err)
        assert.Nil(t, result)
    })
}
```

**验收标准**:
- [ ] 所有业务逻辑测试通过
- [ ] 权限验证测试通过
- [ ] Mock使用正确
- [ ] 测试覆盖率≥85%

---

## 任务1.3：Document模型与Repository（Day 3，8小时）

### 📋 任务清单

#### 1.3.1 创建Document模型

**文件**: `models/document/document.go`

**实施步骤**: 参考设计文档第3.1节

**验证**:
- [ ] 模型定义完整
- [ ] 树形结构字段正确
- [ ] 业务方法实现

#### 1.3.2 创建DocumentRepository接口

**文件**: `repository/interfaces/writing/document_repository.go`

**实施步骤**: 参考设计文档第3.2.1节

**关键方法**:
- 基础CRUD
- 树形结构查询（GetChildren, GetDocumentTree）
- 排序操作（UpdateOrder, ReorderSiblings）
- 移动操作（Move, UpdateParent）
- 批量操作（BatchDelete, GetDescendants）

**验证**:
- [ ] 接口定义完整
- [ ] 树形操作方法齐全

#### 1.3.3 实现MongoDocumentRepository

**文件**: `repository/mongodb/writing/document_repository_mongo.go`

**实施步骤**: 参考设计文档第3.2.2节

**关键实现**:
- GetDocumentTree: 按level和order排序
- GetMaxOrder: 查询同级最大order
- Move: 更新parent_id和order
- SoftDeleteWithChildren: 递归软删除
- GetDescendants: 递归查询子孙节点

**验证**:
- [ ] 树形操作正确
- [ ] 递归逻辑无误
- [ ] 索引创建完整

---

### 🧪 测试1.3：DocumentRepository测试（2小时）

**文件**: `test/repository/document_repository_test.go`

**测试重点**:
- 文档树创建和查询
- 文档移动操作
- 排序更新
- 批量删除
- 递归查询

**验收标准**:
- [ ] 树形操作测试通过
- [ ] 测试覆盖率≥90%

---

## 任务1.4：DocumentService业务逻辑（Day 4，8小时）

### 📋 任务清单

#### 1.4.1 实现DocumentService

**文件**: `service/document/document_service.go`

**实施步骤**: 参考设计文档第3.3节

**关键方法**:
- CreateDocument: 验证层级、父文档
- GetDocumentTree: 构建树形结构
- MoveDocument: 检查循环、更新层级
- ReorderDocuments: 批量更新顺序
- DeleteDocument: 级联软删除

**验证**:
- [ ] 层级限制正确（最多3层）
- [ ] 循环检测有效
- [ ] 权限验证完整

---

### 🧪 测试1.4：DocumentService测试（2小时）

**文件**: `test/service/document_service_test.go`

**测试重点**:
- 文档创建层级验证
- 文档移动循环检测
- 树形结构构建
- 权限验证

**验收标准**:
- [ ] 业务逻辑测试通过
- [ ] 测试覆盖率≥85%

---

## 任务1.5：项目管理API（Day 5，8小时）

### 📋 任务清单

#### 1.5.1 实现ProjectApi

**文件**: `api/v1/writer/project_api.go`

**实施步骤**: 参考设计文档第3.4节

**API方法**:
- CreateProject: POST /api/v1/projects
- GetProject: GET /api/v1/projects/:id
- ListProjects: GET /api/v1/projects
- UpdateProject: PUT /api/v1/projects/:id
- DeleteProject: DELETE /api/v1/projects/:id

**验证**:
- [ ] 参数绑定正确
- [ ] 响应格式统一
- [ ] 错误处理完善

#### 1.5.2 实现DocumentApi

**文件**: `api/v1/writer/document_api.go`

**API方法**:
- CreateDocument: POST /api/v1/projects/:projectId/documents
- GetDocumentTree: GET /api/v1/projects/:projectId/documents/tree
- MoveDocument: POST /api/v1/projects/:projectId/documents/:id/move
- ReorderDocuments: POST /api/v1/projects/:projectId/documents/reorder
- DeleteDocument: DELETE /api/v1/projects/:projectId/documents/:id

**验证**:
- [ ] 路由参数正确
- [ ] 请求验证完整

#### 1.5.3 配置路由

**文件**: `router/writer/project.go`, `router/writer/document.go`

**实施步骤**:

```go
// router/writer/project.go
func InitProjectRouter(r *gin.RouterGroup, projectApi *writer.ProjectApi) {
    projectGroup := r.Group("/projects")
    projectGroup.Use(middleware.JWTAuth())
    {
        projectGroup.POST("", projectApi.CreateProject)
        projectGroup.GET("", projectApi.ListProjects)
        projectGroup.GET("/:id", projectApi.GetProject)
        projectGroup.PUT("/:id", projectApi.UpdateProject)
        projectGroup.DELETE("/:id", projectApi.DeleteProject)
    }
}
```

**验证**:
- [ ] 路由注册成功
- [ ] 中间件配置正确

#### 1.5.4 更新主路由

**文件**: `router/enter.go`

**修改内容**:
```go
// 写作端路由
writerGroup := v1.Group("/writer")
writerGroup.Use(middleware.JWTAuth())
{
    writer.InitProjectRouter(writerGroup, projectApi)
    writer.InitDocumentRouter(writerGroup, documentApi)
}
```

---

### 🧪 测试1.5：API集成测试（2小时）

**文件**: `test/api/project_api_test.go`, `test/api/document_api_test.go`

**测试步骤**:

```go
package api

import (
    "bytes"
    "encoding/json"
    "net/http"
    "net/http/httptest"
    "testing"
    
    "github.com/gin-gonic/gin"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/require"
    
    "qingyu_backend/test/testutil"
)

func TestProjectAPI_Create(t *testing.T) {
    // 1. 初始化测试环境
    router, container := testutil.SetupTestRouter(t)
    defer testutil.TeardownTest(t, container)
    
    // 2. 准备测试数据
    reqBody := map[string]interface{}{
        "title":    "测试项目",
        "summary":  "测试简介",
        "category": "玄幻",
    }
    
    bodyBytes, _ := json.Marshal(reqBody)
    
    // 3. 发送请求
    req := httptest.NewRequest("POST", "/api/v1/projects", bytes.NewBuffer(bodyBytes))
    req.Header.Set("Content-Type", "application/json")
    req.Header.Set("Authorization", "Bearer "+testutil.GetTestToken())
    
    w := httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    // 4. 验证响应
    assert.Equal(t, http.StatusCreated, w.Code)
    
    var resp map[string]interface{}
    err := json.Unmarshal(w.Body.Bytes(), &resp)
    require.NoError(t, err)
    
    assert.Equal(t, float64(201), resp["code"])
    assert.Equal(t, "创建成功", resp["message"])
    
    data := resp["data"].(map[string]interface{})
    assert.NotEmpty(t, data["projectId"])
    assert.Equal(t, "测试项目", data["title"])
}
```

**Postman测试集**: `test/postman/写作端-项目管理.postman_collection.json`

**验收标准**:
- [ ] 所有API测试通过
- [ ] Postman测试集完整
- [ ] 响应格式正确
- [ ] 错误处理验证

---

## 阶段1完成验证

### ✅ 功能验证清单

#### 基础功能
- [ ] 创建项目成功
- [ ] 查询项目详情成功
- [ ] 更新项目信息成功
- [ ] 删除项目成功（软删除）
- [ ] 项目列表分页查询成功

#### 文档管理
- [ ] 创建文档节点成功
- [ ] 查询文档树成功
- [ ] 移动文档成功
- [ ] 重新排序成功
- [ ] 删除文档成功（级联删除）

#### 权限控制
- [ ] 只能查看自己的项目
- [ ] 只能编辑自己的项目
- [ ] 只能删除自己的项目
- [ ] 协作者权限正常

#### 数据一致性
- [ ] 统计数据准确
- [ ] 树形结构正确
- [ ] 软删除数据不可见
- [ ] 事件发布成功

### 📊 质量指标

- [ ] 单元测试覆盖率 ≥ 90%
- [ ] Service测试覆盖率 ≥ 85%
- [ ] API测试全部通过
- [ ] 无Linter错误
- [ ] 代码审查通过

### 📝 交付文档

- [ ] 更新实施进度文档
- [ ] 编写API使用文档
- [ ] 记录已知问题
- [ ] 更新数据库索引文档

---

## 常见问题和解决方案

### Q1: 软删除后关联数据如何处理？

**A**: 使用级联软删除，但保留数据关联：
- 项目软删除时，关联文档也软删除
- 查询时始终过滤deleted_at不为空的数据
- 提供恢复功能（后期）

### Q2: 文档树深度如何限制？

**A**: 在CreateDocument时检查：
```go
if req.ParentID != "" {
    parent, _ := s.documentRepo.GetByID(ctx, req.ParentID)
    if !parent.CanHaveChildren() {
        return nil, errors.NewBusinessError("该文档不能添加子文档（最多3层）")
    }
}
```

### Q3: 并发更新如何处理？

**A**: 使用乐观锁：
- 添加version字段
- 更新时检查version
- version不匹配返回冲突错误

---

## 下一步计划

完成阶段1后，进入**阶段2：文档编辑器**开发，包括：
- DocumentContent模型和Repository
- 编辑器Service（自动保存、版本控制）
- 编辑API
- 前端编辑器集成

---

**文档版本**: v1.0  
**创建日期**: 2025-10-16  
**最后更新**: 2025-10-16  
**状态**: ⏸️ 待开始

