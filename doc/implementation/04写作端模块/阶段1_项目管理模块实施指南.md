# é˜¶æ®µ1ï¼šé¡¹ç›®ç®¡ç†æ¨¡å—å®æ–½æŒ‡å—

> **å®æ–½å‘¨æœŸ**: 5å¤©ï¼ˆ2025.10.17 - 2025.10.21ï¼‰  
> **è´Ÿè´£äºº**: å¼€å‘å›¢é˜Ÿ  
> **çŠ¶æ€**: â¸ï¸ å¾…å¼€å§‹

## å®æ–½æ¦‚è§ˆ

æœ¬é˜¶æ®µå®æ–½å†™ä½œç«¯çš„é¡¹ç›®ç®¡ç†å’Œæ–‡æ¡£ç®¡ç†æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬é¡¹ç›®CRUDã€æ–‡æ¡£æ ‘ç®¡ç†ã€æƒé™æ§åˆ¶ç­‰ã€‚

### ç›®æ ‡æˆæœ

- âœ… å®Œæ•´çš„é¡¹ç›®ç®¡ç†åŠŸèƒ½
- âœ… æ–‡æ¡£æ ‘å½¢ç»“æ„ç®¡ç†
- âœ… æƒé™æ§åˆ¶ä½“ç³»
- âœ… 6ä¸ªæ ¸å¿ƒAPIæ¥å£
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–ç‡â‰¥90%

---

## ä»»åŠ¡1.1ï¼šProjectæ¨¡å‹ä¸Repositoryï¼ˆDay 1ï¼Œ8å°æ—¶ï¼‰

### ğŸ“‹ ä»»åŠ¡æ¸…å•

#### 1.1.1 åˆ›å»ºProjectæ¨¡å‹

**æ–‡ä»¶**: `models/document/project.go`

**å®æ–½æ­¥éª¤**:

1. åˆ›å»ºç›®å½•ç»“æ„
```bash
mkdir -p models/document
```

2. åˆ›å»ºProjectæ¨¡å‹æ–‡ä»¶
```go
// models/document/project.go
package document

import "time"

// Project é¡¹ç›®æ¨¡å‹
type Project struct {
    ID          string         `bson:"_id,omitempty" json:"id"`
    AuthorID    string         `bson:"author_id" json:"authorId" validate:"required"`
    Title       string         `bson:"title" json:"title" validate:"required,min=1,max=100"`
    Summary     string         `bson:"summary,omitempty" json:"summary,omitempty"`
    CoverURL    string         `bson:"cover_url,omitempty" json:"coverUrl,omitempty"`
    Status      ProjectStatus  `bson:"status" json:"status"`
    Category    string         `bson:"category,omitempty" json:"category,omitempty"`
    Tags        []string       `bson:"tags,omitempty" json:"tags,omitempty"`
    Visibility  Visibility     `bson:"visibility" json:"visibility"`
    
    // ç»Ÿè®¡ä¿¡æ¯
    Statistics  ProjectStats   `bson:"statistics" json:"statistics"`
    
    // è®¾ç½®ä¿¡æ¯
    Settings    ProjectSettings `bson:"settings" json:"settings"`
    
    // åä½œä¿¡æ¯
    Collaborators []Collaborator `bson:"collaborators,omitempty" json:"collaborators,omitempty"`
    
    // æ—¶é—´æˆ³
    CreatedAt   time.Time      `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time      `bson:"updated_at" json:"updatedAt"`
    PublishedAt *time.Time     `bson:"published_at,omitempty" json:"publishedAt,omitempty"`
    DeletedAt   *time.Time     `bson:"deleted_at,omitempty" json:"deletedAt,omitempty"`
}

// ProjectStatus é¡¹ç›®çŠ¶æ€
type ProjectStatus string

const (
    StatusDraft       ProjectStatus = "draft"
    StatusSerializing ProjectStatus = "serializing"
    StatusCompleted   ProjectStatus = "completed"
    StatusSuspended   ProjectStatus = "suspended"
    StatusArchived    ProjectStatus = "archived"
)

// Visibility å¯è§æ€§
type Visibility string

const (
    VisibilityPrivate Visibility = "private"
    VisibilityPublic  Visibility = "public"
)

// ProjectStats é¡¹ç›®ç»Ÿè®¡
type ProjectStats struct {
    TotalWords    int       `bson:"total_words" json:"totalWords"`
    ChapterCount  int       `bson:"chapter_count" json:"chapterCount"`
    DocumentCount int       `bson:"document_count" json:"documentCount"`
    LastUpdateAt  time.Time `bson:"last_update_at" json:"lastUpdateAt"`
}

// ProjectSettings é¡¹ç›®è®¾ç½®
type ProjectSettings struct {
    AutoBackup     bool `bson:"auto_backup" json:"autoBackup"`
    BackupInterval int  `bson:"backup_interval" json:"backupInterval"`
    WordCountGoal  int  `bson:"word_count_goal,omitempty" json:"wordCountGoal,omitempty"`
}

// Collaborator åä½œè€…
type Collaborator struct {
    UserID     string           `bson:"user_id" json:"userId"`
    Role       CollaboratorRole `bson:"role" json:"role"`
    InvitedAt  time.Time        `bson:"invited_at" json:"invitedAt"`
    AcceptedAt *time.Time       `bson:"accepted_at,omitempty" json:"acceptedAt,omitempty"`
}

// CollaboratorRole åä½œè€…è§’è‰²
type CollaboratorRole string

const (
    RoleOwner  CollaboratorRole = "owner"
    RoleEditor CollaboratorRole = "editor"
    RoleViewer CollaboratorRole = "viewer"
)

// ä¸šåŠ¡æ–¹æ³•
func (p *Project) IsOwner(userID string) bool {
    return p.AuthorID == userID
}

func (p *Project) CanEdit(userID string) bool {
    if p.IsOwner(userID) {
        return true
    }
    
    for _, collab := range p.Collaborators {
        if collab.UserID == userID && collab.Role == RoleEditor && collab.AcceptedAt != nil {
            return true
        }
    }
    
    return false
}

func (p *Project) CanView(userID string) bool {
    if p.CanEdit(userID) {
        return true
    }
    
    for _, collab := range p.Collaborators {
        if collab.UserID == userID && collab.AcceptedAt != nil {
            return true
        }
    }
    
    return p.Visibility == VisibilityPublic
}

func (p *Project) UpdateStatistics(stats ProjectStats) {
    p.Statistics = stats
    p.UpdatedAt = time.Now()
}
```

**éªŒè¯**:
- [ ] æ¨¡å‹æ–‡ä»¶ç¼–è¯‘é€šè¿‡
- [ ] æ‰€æœ‰å¸¸é‡å®šä¹‰æ­£ç¡®
- [ ] ä¸šåŠ¡æ–¹æ³•é€»è¾‘æ­£ç¡®

#### 1.1.2 åˆ›å»ºProjectRepositoryæ¥å£

**æ–‡ä»¶**: `repository/interfaces/writing/project_repository.go`

**å®æ–½æ­¥éª¤**:

1. åˆ›å»ºæ¥å£ç›®å½•
```bash
mkdir -p repository/interfaces/writing
```

2. åˆ›å»ºæ¥å£å®šä¹‰ï¼ˆå‚è€ƒè®¾è®¡æ–‡æ¡£ç¬¬3.2.1èŠ‚ï¼‰

**éªŒè¯**:
- [ ] æ¥å£å®šä¹‰å®Œæ•´
- [ ] æ–¹æ³•ç­¾åç¬¦åˆè§„èŒƒ
- [ ] åŒ…å«æ‰€æœ‰å¿…è¦æ–¹æ³•

#### 1.1.3 å®ç°MongoProjectRepository

**æ–‡ä»¶**: `repository/mongodb/writing/project_repository_mongo.go`

**å®æ–½æ­¥éª¤**:

1. åˆ›å»ºMongoDBå®ç°ç›®å½•
```bash
mkdir -p repository/mongodb/writing
```

2. å®ç°æ‰€æœ‰æ¥å£æ–¹æ³•ï¼ˆå‚è€ƒè®¾è®¡æ–‡æ¡£ç¬¬3.2.2èŠ‚ï¼‰

**å…³é”®å®ç°**:
- Create: åˆå§‹åŒ–é»˜è®¤å€¼ã€ç”ŸæˆID
- GetByID: æ’é™¤å·²åˆ é™¤é¡¹ç›®
- Update: è‡ªåŠ¨æ›´æ–°updated_at
- SoftDelete: è½¯åˆ é™¤è€Œéç‰©ç†åˆ é™¤
- ç´¢å¼•åˆ›å»º: author_id, status, created_at

**éªŒè¯**:
- [ ] æ‰€æœ‰æ¥å£æ–¹æ³•å®ç°
- [ ] é”™è¯¯å¤„ç†å®Œæ•´
- [ ] ç´¢å¼•åˆ›å»ºæ­£ç¡®

#### 1.1.4 æ›´æ–°Repositoryå·¥å‚

**æ–‡ä»¶**: `repository/mongodb/factory.go`

**ä¿®æ”¹å†…å®¹**:
```go
func (f *MongoRepositoryFactory) CreateProjectRepository() writing.ProjectRepository {
    return writing.NewMongoProjectRepository(f.db)
}
```

**éªŒè¯**:
- [ ] å·¥å‚æ–¹æ³•æ·»åŠ æˆåŠŸ
- [ ] æ¥å£å¯¼å…¥æ­£ç¡®

---

### ğŸ§ª æµ‹è¯•1.1ï¼šProjectRepositoryæµ‹è¯•ï¼ˆ2å°æ—¶ï¼‰

**æ–‡ä»¶**: `test/repository/project_repository_test.go`

**æµ‹è¯•ç”¨ä¾‹**:

```go
package repository

import (
    "context"
    "testing"
    "time"
    
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/require"
    
    "qingyu_backend/models/document"
    "qingyu_backend/repository/mongodb"
    "qingyu_backend/test/testutil"
)

func TestProjectRepository_Create(t *testing.T) {
    // 1. åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
    factory := testutil.SetupTestDB(t)
    defer testutil.TeardownTestDB(t, factory)
    
    repo := factory.CreateProjectRepository()
    ctx := context.Background()
    
    // 2. æµ‹è¯•æ­£å¸¸åˆ›å»º
    t.Run("æ­£å¸¸åˆ›å»ºé¡¹ç›®", func(t *testing.T) {
        project := &document.Project{
            AuthorID: "user123",
            Title:    "æµ‹è¯•é¡¹ç›®",
            Summary:  "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é¡¹ç›®",
        }
        
        err := repo.Create(ctx, project)
        require.NoError(t, err)
        assert.NotEmpty(t, project.ID)
        assert.Equal(t, document.StatusDraft, project.Status)
        assert.Equal(t, document.VisibilityPrivate, project.Visibility)
    })
    
    // 3. æµ‹è¯•ç»Ÿè®¡åˆå§‹åŒ–
    t.Run("ç»Ÿè®¡ä¿¡æ¯åˆå§‹åŒ–", func(t *testing.T) {
        project := &document.Project{
            AuthorID: "user123",
            Title:    "æµ‹è¯•é¡¹ç›®2",
        }
        
        err := repo.Create(ctx, project)
        require.NoError(t, err)
        assert.Equal(t, 0, project.Statistics.TotalWords)
        assert.Equal(t, 0, project.Statistics.ChapterCount)
    })
}

func TestProjectRepository_GetByID(t *testing.T) {
    factory := testutil.SetupTestDB(t)
    defer testutil.TeardownTestDB(t, factory)
    
    repo := factory.CreateProjectRepository()
    ctx := context.Background()
    
    // 1. åˆ›å»ºæµ‹è¯•æ•°æ®
    project := &document.Project{
        AuthorID: "user123",
        Title:    "æµ‹è¯•é¡¹ç›®",
    }
    err := repo.Create(ctx, project)
    require.NoError(t, err)
    
    // 2. æµ‹è¯•æŸ¥è¯¢å­˜åœ¨çš„é¡¹ç›®
    t.Run("æŸ¥è¯¢å­˜åœ¨çš„é¡¹ç›®", func(t *testing.T) {
        found, err := repo.GetByID(ctx, project.ID)
        require.NoError(t, err)
        assert.NotNil(t, found)
        assert.Equal(t, project.Title, found.Title)
    })
    
    // 3. æµ‹è¯•æŸ¥è¯¢ä¸å­˜åœ¨çš„é¡¹ç›®
    t.Run("æŸ¥è¯¢ä¸å­˜åœ¨çš„é¡¹ç›®", func(t *testing.T) {
        found, err := repo.GetByID(ctx, "nonexistent")
        assert.NoError(t, err)
        assert.Nil(t, found)
    })
    
    // 4. æµ‹è¯•è½¯åˆ é™¤åæŸ¥è¯¢
    t.Run("è½¯åˆ é™¤åä¸å¯æŸ¥è¯¢", func(t *testing.T) {
        err := repo.SoftDelete(ctx, project.ID)
        require.NoError(t, err)
        
        found, err := repo.GetByID(ctx, project.ID)
        assert.NoError(t, err)
        assert.Nil(t, found)
    })
}

func TestProjectRepository_Update(t *testing.T) {
    factory := testutil.SetupTestDB(t)
    defer testutil.TeardownTestDB(t, factory)
    
    repo := factory.CreateProjectRepository()
    ctx := context.Background()
    
    // åˆ›å»ºæµ‹è¯•æ•°æ®
    project := &document.Project{
        AuthorID: "user123",
        Title:    "åŸæ ‡é¢˜",
    }
    err := repo.Create(ctx, project)
    require.NoError(t, err)
    
    // æµ‹è¯•æ›´æ–°
    t.Run("æ›´æ–°é¡¹ç›®ä¿¡æ¯", func(t *testing.T) {
        updates := map[string]interface{}{
            "title":   "æ–°æ ‡é¢˜",
            "summary": "æ–°ç®€ä»‹",
        }
        
        err := repo.Update(ctx, project.ID, updates)
        require.NoError(t, err)
        
        // éªŒè¯æ›´æ–°
        updated, err := repo.GetByID(ctx, project.ID)
        require.NoError(t, err)
        assert.Equal(t, "æ–°æ ‡é¢˜", updated.Title)
        assert.Equal(t, "æ–°ç®€ä»‹", updated.Summary)
    })
}

func TestProjectRepository_GetByAuthorID(t *testing.T) {
    factory := testutil.SetupTestDB(t)
    defer testutil.TeardownTestDB(t, factory)
    
    repo := factory.CreateProjectRepository()
    ctx := context.Background()
    
    authorID := "user123"
    
    // åˆ›å»ºå¤šä¸ªé¡¹ç›®
    for i := 0; i < 3; i++ {
        project := &document.Project{
            AuthorID: authorID,
            Title:    fmt.Sprintf("é¡¹ç›®%d", i+1),
        }
        err := repo.Create(ctx, project)
        require.NoError(t, err)
    }
    
    // æŸ¥è¯¢ä½œè€…çš„æ‰€æœ‰é¡¹ç›®
    t.Run("æŸ¥è¯¢ä½œè€…çš„æ‰€æœ‰é¡¹ç›®", func(t *testing.T) {
        projects, err := repo.GetByAuthorID(ctx, authorID)
        require.NoError(t, err)
        assert.Equal(t, 3, len(projects))
    })
}
```

**æµ‹è¯•è¦†ç›–**:
- [x] Createæ–¹æ³•æµ‹è¯•
- [x] GetByIDæ–¹æ³•æµ‹è¯•
- [x] Updateæ–¹æ³•æµ‹è¯•
- [x] GetByAuthorIDæ–¹æ³•æµ‹è¯•
- [ ] SoftDeleteæ–¹æ³•æµ‹è¯•
- [ ] UpdateStatisticsæ–¹æ³•æµ‹è¯•
- [ ] AddCollaboratoræ–¹æ³•æµ‹è¯•

**è¿è¡Œæµ‹è¯•**:
```bash
go test ./test/repository/project_repository_test.go -v
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡
- [ ] æµ‹è¯•è¦†ç›–ç‡â‰¥90%
- [ ] æ— æ•°æ®æ³„æ¼

---

## ä»»åŠ¡1.2ï¼šProjectServiceä¸šåŠ¡é€»è¾‘ï¼ˆDay 2ï¼Œ8å°æ—¶ï¼‰

### ğŸ“‹ ä»»åŠ¡æ¸…å•

#### 1.2.1 åˆ›å»ºServiceæ¥å£

**æ–‡ä»¶**: `service/interfaces/project_service.go`

**å®æ–½æ­¥éª¤**:

1. åˆ›å»ºæ¥å£ç›®å½•
```bash
mkdir -p service/interfaces
```

2. å®šä¹‰Serviceæ¥å£ï¼ˆå¯é€‰ï¼ŒGoä¸­å¯ç›´æ¥å®ç°ï¼‰

#### 1.2.2 å®ç°ProjectService

**æ–‡ä»¶**: `service/project/project_service.go`

**å®æ–½æ­¥éª¤**:

1. åˆ›å»ºserviceç›®å½•
```bash
mkdir -p service/project
```

2. å®ç°ProjectServiceï¼ˆå‚è€ƒè®¾è®¡æ–‡æ¡£ç¬¬3.3èŠ‚ï¼‰

**å…³é”®æ–¹æ³•**:
- CreateProject: åˆ›å»ºé¡¹ç›®ï¼Œå‘å¸ƒäº‹ä»¶
- GetProject: è·å–é¡¹ç›®ï¼Œæƒé™æ£€æŸ¥
- ListMyProjects: åˆ†é¡µæŸ¥è¯¢ï¼Œè¿‡æ»¤æ¡ä»¶
- UpdateProject: æ›´æ–°é¡¹ç›®ï¼Œæƒé™éªŒè¯
- DeleteProject: è½¯åˆ é™¤ï¼Œçº§è”å¤„ç†
- UpdateProjectStatistics: ç»Ÿè®¡æ›´æ–°

**éªŒè¯**:
- [ ] æ‰€æœ‰æ–¹æ³•å®ç°å®Œæ•´
- [ ] æƒé™æ£€æŸ¥æ­£ç¡®
- [ ] äº‹ä»¶å‘å¸ƒæ­£å¸¸
- [ ] é”™è¯¯å¤„ç†å®Œå–„

#### 1.2.3 åˆ›å»ºRequest/Responseæ¨¡å‹

**æ–‡ä»¶**: `service/project/project_dto.go`

**å®æ–½æ­¥éª¤**:

```go
package project

import "time"

// CreateProjectRequest åˆ›å»ºé¡¹ç›®è¯·æ±‚
type CreateProjectRequest struct {
    Title    string   `json:"title" validate:"required,min=1,max=100"`
    Summary  string   `json:"summary,omitempty"`
    CoverURL string   `json:"coverUrl,omitempty"`
    Category string   `json:"category,omitempty"`
    Tags     []string `json:"tags,omitempty"`
}

// CreateProjectResponse åˆ›å»ºé¡¹ç›®å“åº”
type CreateProjectResponse struct {
    ProjectID string    `json:"projectId"`
    Title     string    `json:"title"`
    Status    string    `json:"status"`
    CreatedAt time.Time `json:"createdAt"`
}

// UpdateProjectRequest æ›´æ–°é¡¹ç›®è¯·æ±‚
type UpdateProjectRequest struct {
    Title    string   `json:"title,omitempty"`
    Summary  string   `json:"summary,omitempty"`
    CoverURL string   `json:"coverUrl,omitempty"`
    Category string   `json:"category,omitempty"`
    Tags     []string `json:"tags,omitempty"`
    Status   string   `json:"status,omitempty"`
}

// ListProjectsRequest é¡¹ç›®åˆ—è¡¨è¯·æ±‚
type ListProjectsRequest struct {
    Page     int    `json:"page"`
    PageSize int    `json:"pageSize"`
    Status   string `json:"status,omitempty"`
    Category string `json:"category,omitempty"`
}

// ListProjectsResponse é¡¹ç›®åˆ—è¡¨å“åº”
type ListProjectsResponse struct {
    Projects []*document.Project `json:"projects"`
    Total    int64               `json:"total"`
    Page     int                 `json:"page"`
    PageSize int                 `json:"pageSize"`
}
```

**éªŒè¯**:
- [ ] DTOå®šä¹‰å®Œæ•´
- [ ] éªŒè¯æ ‡ç­¾æ­£ç¡®

#### 1.2.4 æ³¨å†ŒServiceåˆ°å®¹å™¨

**æ–‡ä»¶**: `service/container/service_container.go`

**ä¿®æ”¹å†…å®¹**:
```go
// åˆå§‹åŒ–ProjectService
projectRepo := repositoryFactory.CreateProjectRepository()
documentRepo := repositoryFactory.CreateDocumentRepository()
eventBus := base.NewSimpleEventBus()

projectService := project.NewProjectService(projectRepo, documentRepo, eventBus)
container.RegisterService("ProjectService", projectService)
```

**éªŒè¯**:
- [ ] Serviceæ³¨å†ŒæˆåŠŸ
- [ ] ä¾èµ–æ³¨å…¥æ­£ç¡®

---

### ğŸ§ª æµ‹è¯•1.2ï¼šProjectServiceæµ‹è¯•ï¼ˆ2å°æ—¶ï¼‰

**æ–‡ä»¶**: `test/service/project_service_test.go`

**æµ‹è¯•ç”¨ä¾‹**:

```go
package service

import (
    "context"
    "testing"
    
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"
    "github.com/stretchr/testify/require"
    
    "qingyu_backend/models/document"
    "qingyu_backend/service/project"
    "qingyu_backend/test/mocks"
)

func TestProjectService_CreateProject(t *testing.T) {
    // 1. åˆ›å»ºMock Repository
    mockProjectRepo := new(mocks.MockProjectRepository)
    mockDocumentRepo := new(mocks.MockDocumentRepository)
    mockEventBus := new(mocks.MockEventBus)
    
    // 2. åˆ›å»ºService
    service := project.NewProjectService(mockProjectRepo, mockDocumentRepo, mockEventBus)
    
    ctx := context.WithValue(context.Background(), "userID", "user123")
    
    // 3. è®¾ç½®MockæœŸæœ›
    mockProjectRepo.On("Create", mock.Anything, mock.AnythingOfType("*document.Project")).Return(nil)
    mockEventBus.On("PublishAsync", mock.Anything, mock.Anything).Return()
    
    // 4. æ‰§è¡Œæµ‹è¯•
    t.Run("æ­£å¸¸åˆ›å»ºé¡¹ç›®", func(t *testing.T) {
        req := &project.CreateProjectRequest{
            Title:    "æµ‹è¯•é¡¹ç›®",
            Summary:  "æµ‹è¯•ç®€ä»‹",
            Category: "ç„å¹»",
            Tags:     []string{"çƒ­è¡€"},
        }
        
        resp, err := service.CreateProject(ctx, req)
        
        require.NoError(t, err)
        assert.NotNil(t, resp)
        assert.Equal(t, "æµ‹è¯•é¡¹ç›®", resp.Title)
        assert.Equal(t, "draft", resp.Status)
    })
    
    // 5. æµ‹è¯•å‚æ•°éªŒè¯
    t.Run("æ ‡é¢˜ä¸ºç©ºåº”è¯¥å¤±è´¥", func(t *testing.T) {
        req := &project.CreateProjectRequest{
            Title: "",
        }
        
        resp, err := service.CreateProject(ctx, req)
        
        assert.Error(t, err)
        assert.Nil(t, resp)
    })
    
    // 6. éªŒè¯Mockè°ƒç”¨
    mockProjectRepo.AssertExpectations(t)
    mockEventBus.AssertExpectations(t)
}

func TestProjectService_GetProject(t *testing.T) {
    mockProjectRepo := new(mocks.MockProjectRepository)
    mockDocumentRepo := new(mocks.MockDocumentRepository)
    mockEventBus := new(mocks.MockEventBus)
    
    service := project.NewProjectService(mockProjectRepo, mockDocumentRepo, mockEventBus)
    
    ctx := context.WithValue(context.Background(), "userID", "user123")
    
    // æµ‹è¯•è·å–é¡¹ç›®
    t.Run("è·å–å­˜åœ¨çš„é¡¹ç›®", func(t *testing.T) {
        testProject := &document.Project{
            ID:       "project123",
            AuthorID: "user123",
            Title:    "æµ‹è¯•é¡¹ç›®",
            Visibility: document.VisibilityPrivate,
        }
        
        mockProjectRepo.On("GetByID", mock.Anything, "project123").Return(testProject, nil)
        
        result, err := service.GetProject(ctx, "project123")
        
        require.NoError(t, err)
        assert.Equal(t, "æµ‹è¯•é¡¹ç›®", result.Title)
    })
    
    // æµ‹è¯•æƒé™æ£€æŸ¥
    t.Run("æ— æƒé™è®¿é—®ç§å¯†é¡¹ç›®", func(t *testing.T) {
        testProject := &document.Project{
            ID:       "project123",
            AuthorID: "other_user",
            Title:    "ä»–äººé¡¹ç›®",
            Visibility: document.VisibilityPrivate,
        }
        
        mockProjectRepo.On("GetByID", mock.Anything, "project123").Return(testProject, nil)
        
        result, err := service.GetProject(ctx, "project123")
        
        assert.Error(t, err)
        assert.Nil(t, result)
    })
}
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ‰€æœ‰ä¸šåŠ¡é€»è¾‘æµ‹è¯•é€šè¿‡
- [ ] æƒé™éªŒè¯æµ‹è¯•é€šè¿‡
- [ ] Mockä½¿ç”¨æ­£ç¡®
- [ ] æµ‹è¯•è¦†ç›–ç‡â‰¥85%

---

## ä»»åŠ¡1.3ï¼šDocumentæ¨¡å‹ä¸Repositoryï¼ˆDay 3ï¼Œ8å°æ—¶ï¼‰

### ğŸ“‹ ä»»åŠ¡æ¸…å•

#### 1.3.1 åˆ›å»ºDocumentæ¨¡å‹

**æ–‡ä»¶**: `models/document/document.go`

**å®æ–½æ­¥éª¤**: å‚è€ƒè®¾è®¡æ–‡æ¡£ç¬¬3.1èŠ‚

**éªŒè¯**:
- [ ] æ¨¡å‹å®šä¹‰å®Œæ•´
- [ ] æ ‘å½¢ç»“æ„å­—æ®µæ­£ç¡®
- [ ] ä¸šåŠ¡æ–¹æ³•å®ç°

#### 1.3.2 åˆ›å»ºDocumentRepositoryæ¥å£

**æ–‡ä»¶**: `repository/interfaces/writing/document_repository.go`

**å®æ–½æ­¥éª¤**: å‚è€ƒè®¾è®¡æ–‡æ¡£ç¬¬3.2.1èŠ‚

**å…³é”®æ–¹æ³•**:
- åŸºç¡€CRUD
- æ ‘å½¢ç»“æ„æŸ¥è¯¢ï¼ˆGetChildren, GetDocumentTreeï¼‰
- æ’åºæ“ä½œï¼ˆUpdateOrder, ReorderSiblingsï¼‰
- ç§»åŠ¨æ“ä½œï¼ˆMove, UpdateParentï¼‰
- æ‰¹é‡æ“ä½œï¼ˆBatchDelete, GetDescendantsï¼‰

**éªŒè¯**:
- [ ] æ¥å£å®šä¹‰å®Œæ•´
- [ ] æ ‘å½¢æ“ä½œæ–¹æ³•é½å…¨

#### 1.3.3 å®ç°MongoDocumentRepository

**æ–‡ä»¶**: `repository/mongodb/writing/document_repository_mongo.go`

**å®æ–½æ­¥éª¤**: å‚è€ƒè®¾è®¡æ–‡æ¡£ç¬¬3.2.2èŠ‚

**å…³é”®å®ç°**:
- GetDocumentTree: æŒ‰levelå’Œorderæ’åº
- GetMaxOrder: æŸ¥è¯¢åŒçº§æœ€å¤§order
- Move: æ›´æ–°parent_idå’Œorder
- SoftDeleteWithChildren: é€’å½’è½¯åˆ é™¤
- GetDescendants: é€’å½’æŸ¥è¯¢å­å­™èŠ‚ç‚¹

**éªŒè¯**:
- [ ] æ ‘å½¢æ“ä½œæ­£ç¡®
- [ ] é€’å½’é€»è¾‘æ— è¯¯
- [ ] ç´¢å¼•åˆ›å»ºå®Œæ•´

---

### ğŸ§ª æµ‹è¯•1.3ï¼šDocumentRepositoryæµ‹è¯•ï¼ˆ2å°æ—¶ï¼‰

**æ–‡ä»¶**: `test/repository/document_repository_test.go`

**æµ‹è¯•é‡ç‚¹**:
- æ–‡æ¡£æ ‘åˆ›å»ºå’ŒæŸ¥è¯¢
- æ–‡æ¡£ç§»åŠ¨æ“ä½œ
- æ’åºæ›´æ–°
- æ‰¹é‡åˆ é™¤
- é€’å½’æŸ¥è¯¢

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ ‘å½¢æ“ä½œæµ‹è¯•é€šè¿‡
- [ ] æµ‹è¯•è¦†ç›–ç‡â‰¥90%

---

## ä»»åŠ¡1.4ï¼šDocumentServiceä¸šåŠ¡é€»è¾‘ï¼ˆDay 4ï¼Œ8å°æ—¶ï¼‰

### ğŸ“‹ ä»»åŠ¡æ¸…å•

#### 1.4.1 å®ç°DocumentService

**æ–‡ä»¶**: `service/document/document_service.go`

**å®æ–½æ­¥éª¤**: å‚è€ƒè®¾è®¡æ–‡æ¡£ç¬¬3.3èŠ‚

**å…³é”®æ–¹æ³•**:
- CreateDocument: éªŒè¯å±‚çº§ã€çˆ¶æ–‡æ¡£
- GetDocumentTree: æ„å»ºæ ‘å½¢ç»“æ„
- MoveDocument: æ£€æŸ¥å¾ªç¯ã€æ›´æ–°å±‚çº§
- ReorderDocuments: æ‰¹é‡æ›´æ–°é¡ºåº
- DeleteDocument: çº§è”è½¯åˆ é™¤

**éªŒè¯**:
- [ ] å±‚çº§é™åˆ¶æ­£ç¡®ï¼ˆæœ€å¤š3å±‚ï¼‰
- [ ] å¾ªç¯æ£€æµ‹æœ‰æ•ˆ
- [ ] æƒé™éªŒè¯å®Œæ•´

---

### ğŸ§ª æµ‹è¯•1.4ï¼šDocumentServiceæµ‹è¯•ï¼ˆ2å°æ—¶ï¼‰

**æ–‡ä»¶**: `test/service/document_service_test.go`

**æµ‹è¯•é‡ç‚¹**:
- æ–‡æ¡£åˆ›å»ºå±‚çº§éªŒè¯
- æ–‡æ¡£ç§»åŠ¨å¾ªç¯æ£€æµ‹
- æ ‘å½¢ç»“æ„æ„å»º
- æƒé™éªŒè¯

**éªŒæ”¶æ ‡å‡†**:
- [ ] ä¸šåŠ¡é€»è¾‘æµ‹è¯•é€šè¿‡
- [ ] æµ‹è¯•è¦†ç›–ç‡â‰¥85%

---

## ä»»åŠ¡1.5ï¼šé¡¹ç›®ç®¡ç†APIï¼ˆDay 5ï¼Œ8å°æ—¶ï¼‰

### ğŸ“‹ ä»»åŠ¡æ¸…å•

#### 1.5.1 å®ç°ProjectApi

**æ–‡ä»¶**: `api/v1/writer/project_api.go`

**å®æ–½æ­¥éª¤**: å‚è€ƒè®¾è®¡æ–‡æ¡£ç¬¬3.4èŠ‚

**APIæ–¹æ³•**:
- CreateProject: POST /api/v1/projects
- GetProject: GET /api/v1/projects/:id
- ListProjects: GET /api/v1/projects
- UpdateProject: PUT /api/v1/projects/:id
- DeleteProject: DELETE /api/v1/projects/:id

**éªŒè¯**:
- [ ] å‚æ•°ç»‘å®šæ­£ç¡®
- [ ] å“åº”æ ¼å¼ç»Ÿä¸€
- [ ] é”™è¯¯å¤„ç†å®Œå–„

#### 1.5.2 å®ç°DocumentApi

**æ–‡ä»¶**: `api/v1/writer/document_api.go`

**APIæ–¹æ³•**:
- CreateDocument: POST /api/v1/projects/:projectId/documents
- GetDocumentTree: GET /api/v1/projects/:projectId/documents/tree
- MoveDocument: POST /api/v1/projects/:projectId/documents/:id/move
- ReorderDocuments: POST /api/v1/projects/:projectId/documents/reorder
- DeleteDocument: DELETE /api/v1/projects/:projectId/documents/:id

**éªŒè¯**:
- [ ] è·¯ç”±å‚æ•°æ­£ç¡®
- [ ] è¯·æ±‚éªŒè¯å®Œæ•´

#### 1.5.3 é…ç½®è·¯ç”±

**æ–‡ä»¶**: `router/writer/project.go`, `router/writer/document.go`

**å®æ–½æ­¥éª¤**:

```go
// router/writer/project.go
func InitProjectRouter(r *gin.RouterGroup, projectApi *writer.ProjectApi) {
    projectGroup := r.Group("/projects")
    projectGroup.Use(middleware.JWTAuth())
    {
        projectGroup.POST("", projectApi.CreateProject)
        projectGroup.GET("", projectApi.ListProjects)
        projectGroup.GET("/:id", projectApi.GetProject)
        projectGroup.PUT("/:id", projectApi.UpdateProject)
        projectGroup.DELETE("/:id", projectApi.DeleteProject)
    }
}
```

**éªŒè¯**:
- [ ] è·¯ç”±æ³¨å†ŒæˆåŠŸ
- [ ] ä¸­é—´ä»¶é…ç½®æ­£ç¡®

#### 1.5.4 æ›´æ–°ä¸»è·¯ç”±

**æ–‡ä»¶**: `router/enter.go`

**ä¿®æ”¹å†…å®¹**:
```go
// å†™ä½œç«¯è·¯ç”±
writerGroup := v1.Group("/writer")
writerGroup.Use(middleware.JWTAuth())
{
    writer.InitProjectRouter(writerGroup, projectApi)
    writer.InitDocumentRouter(writerGroup, documentApi)
}
```

---

### ğŸ§ª æµ‹è¯•1.5ï¼šAPIé›†æˆæµ‹è¯•ï¼ˆ2å°æ—¶ï¼‰

**æ–‡ä»¶**: `test/api/project_api_test.go`, `test/api/document_api_test.go`

**æµ‹è¯•æ­¥éª¤**:

```go
package api

import (
    "bytes"
    "encoding/json"
    "net/http"
    "net/http/httptest"
    "testing"
    
    "github.com/gin-gonic/gin"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/require"
    
    "qingyu_backend/test/testutil"
)

func TestProjectAPI_Create(t *testing.T) {
    // 1. åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
    router, container := testutil.SetupTestRouter(t)
    defer testutil.TeardownTest(t, container)
    
    // 2. å‡†å¤‡æµ‹è¯•æ•°æ®
    reqBody := map[string]interface{}{
        "title":    "æµ‹è¯•é¡¹ç›®",
        "summary":  "æµ‹è¯•ç®€ä»‹",
        "category": "ç„å¹»",
    }
    
    bodyBytes, _ := json.Marshal(reqBody)
    
    // 3. å‘é€è¯·æ±‚
    req := httptest.NewRequest("POST", "/api/v1/projects", bytes.NewBuffer(bodyBytes))
    req.Header.Set("Content-Type", "application/json")
    req.Header.Set("Authorization", "Bearer "+testutil.GetTestToken())
    
    w := httptest.NewRecorder()
    router.ServeHTTP(w, req)
    
    // 4. éªŒè¯å“åº”
    assert.Equal(t, http.StatusCreated, w.Code)
    
    var resp map[string]interface{}
    err := json.Unmarshal(w.Body.Bytes(), &resp)
    require.NoError(t, err)
    
    assert.Equal(t, float64(201), resp["code"])
    assert.Equal(t, "åˆ›å»ºæˆåŠŸ", resp["message"])
    
    data := resp["data"].(map[string]interface{})
    assert.NotEmpty(t, data["projectId"])
    assert.Equal(t, "æµ‹è¯•é¡¹ç›®", data["title"])
}
```

**Postmanæµ‹è¯•é›†**: `test/postman/å†™ä½œç«¯-é¡¹ç›®ç®¡ç†.postman_collection.json`

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ‰€æœ‰APIæµ‹è¯•é€šè¿‡
- [ ] Postmanæµ‹è¯•é›†å®Œæ•´
- [ ] å“åº”æ ¼å¼æ­£ç¡®
- [ ] é”™è¯¯å¤„ç†éªŒè¯

---

## é˜¶æ®µ1å®ŒæˆéªŒè¯

### âœ… åŠŸèƒ½éªŒè¯æ¸…å•

#### åŸºç¡€åŠŸèƒ½
- [ ] åˆ›å»ºé¡¹ç›®æˆåŠŸ
- [ ] æŸ¥è¯¢é¡¹ç›®è¯¦æƒ…æˆåŠŸ
- [ ] æ›´æ–°é¡¹ç›®ä¿¡æ¯æˆåŠŸ
- [ ] åˆ é™¤é¡¹ç›®æˆåŠŸï¼ˆè½¯åˆ é™¤ï¼‰
- [ ] é¡¹ç›®åˆ—è¡¨åˆ†é¡µæŸ¥è¯¢æˆåŠŸ

#### æ–‡æ¡£ç®¡ç†
- [ ] åˆ›å»ºæ–‡æ¡£èŠ‚ç‚¹æˆåŠŸ
- [ ] æŸ¥è¯¢æ–‡æ¡£æ ‘æˆåŠŸ
- [ ] ç§»åŠ¨æ–‡æ¡£æˆåŠŸ
- [ ] é‡æ–°æ’åºæˆåŠŸ
- [ ] åˆ é™¤æ–‡æ¡£æˆåŠŸï¼ˆçº§è”åˆ é™¤ï¼‰

#### æƒé™æ§åˆ¶
- [ ] åªèƒ½æŸ¥çœ‹è‡ªå·±çš„é¡¹ç›®
- [ ] åªèƒ½ç¼–è¾‘è‡ªå·±çš„é¡¹ç›®
- [ ] åªèƒ½åˆ é™¤è‡ªå·±çš„é¡¹ç›®
- [ ] åä½œè€…æƒé™æ­£å¸¸

#### æ•°æ®ä¸€è‡´æ€§
- [ ] ç»Ÿè®¡æ•°æ®å‡†ç¡®
- [ ] æ ‘å½¢ç»“æ„æ­£ç¡®
- [ ] è½¯åˆ é™¤æ•°æ®ä¸å¯è§
- [ ] äº‹ä»¶å‘å¸ƒæˆåŠŸ

### ğŸ“Š è´¨é‡æŒ‡æ ‡

- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 90%
- [ ] Serviceæµ‹è¯•è¦†ç›–ç‡ â‰¥ 85%
- [ ] APIæµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] æ— Linteré”™è¯¯
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡

### ğŸ“ äº¤ä»˜æ–‡æ¡£

- [ ] æ›´æ–°å®æ–½è¿›åº¦æ–‡æ¡£
- [ ] ç¼–å†™APIä½¿ç”¨æ–‡æ¡£
- [ ] è®°å½•å·²çŸ¥é—®é¢˜
- [ ] æ›´æ–°æ•°æ®åº“ç´¢å¼•æ–‡æ¡£

---

## å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### Q1: è½¯åˆ é™¤åå…³è”æ•°æ®å¦‚ä½•å¤„ç†ï¼Ÿ

**A**: ä½¿ç”¨çº§è”è½¯åˆ é™¤ï¼Œä½†ä¿ç•™æ•°æ®å…³è”ï¼š
- é¡¹ç›®è½¯åˆ é™¤æ—¶ï¼Œå…³è”æ–‡æ¡£ä¹Ÿè½¯åˆ é™¤
- æŸ¥è¯¢æ—¶å§‹ç»ˆè¿‡æ»¤deleted_atä¸ä¸ºç©ºçš„æ•°æ®
- æä¾›æ¢å¤åŠŸèƒ½ï¼ˆåæœŸï¼‰

### Q2: æ–‡æ¡£æ ‘æ·±åº¦å¦‚ä½•é™åˆ¶ï¼Ÿ

**A**: åœ¨CreateDocumentæ—¶æ£€æŸ¥ï¼š
```go
if req.ParentID != "" {
    parent, _ := s.documentRepo.GetByID(ctx, req.ParentID)
    if !parent.CanHaveChildren() {
        return nil, errors.NewBusinessError("è¯¥æ–‡æ¡£ä¸èƒ½æ·»åŠ å­æ–‡æ¡£ï¼ˆæœ€å¤š3å±‚ï¼‰")
    }
}
```

### Q3: å¹¶å‘æ›´æ–°å¦‚ä½•å¤„ç†ï¼Ÿ

**A**: ä½¿ç”¨ä¹è§‚é”ï¼š
- æ·»åŠ versionå­—æ®µ
- æ›´æ–°æ—¶æ£€æŸ¥version
- versionä¸åŒ¹é…è¿”å›å†²çªé”™è¯¯

---

## ä¸‹ä¸€æ­¥è®¡åˆ’

å®Œæˆé˜¶æ®µ1åï¼Œè¿›å…¥**é˜¶æ®µ2ï¼šæ–‡æ¡£ç¼–è¾‘å™¨**å¼€å‘ï¼ŒåŒ…æ‹¬ï¼š
- DocumentContentæ¨¡å‹å’ŒRepository
- ç¼–è¾‘å™¨Serviceï¼ˆè‡ªåŠ¨ä¿å­˜ã€ç‰ˆæœ¬æ§åˆ¶ï¼‰
- ç¼–è¾‘API
- å‰ç«¯ç¼–è¾‘å™¨é›†æˆ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-16  
**æœ€åæ›´æ–°**: 2025-10-16  
**çŠ¶æ€**: â¸ï¸ å¾…å¼€å§‹

