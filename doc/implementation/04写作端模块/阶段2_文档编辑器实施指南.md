# 阶段2：文档编辑器实施指南

> **实施周期**: 5天（2025.10.22 - 2025.10.26）  
> **前置依赖**: 阶段1完成  
> **状态**: ⏸️ 待开始

## 实施概览

本阶段实施文档编辑功能，包括内容编辑、自动保存、版本控制等核心功能。

### 目标成果

- ✅ 文档内容存储（支持大文件）
- ✅ Markdown和富文本双模式编辑
- ✅ 自动保存机制
- ✅ 完整的版本控制系统
- ✅ 6个编辑相关API
- ✅ 前端编辑器组件集成

---

## 任务2.1：文档内容存储设计（Day 1，8小时）

### 📋 任务清单

#### 2.1.1 创建DocumentContent模型

**文件**: `models/document/document_content.go`

**实施步骤**:

```go
// models/document/document_content.go
package document

import "time"

// DocumentContent 文档内容
type DocumentContent struct {
    ID           string    `bson:"_id,omitempty" json:"id"`
    DocumentID   string    `bson:"document_id" json:"documentId" validate:"required"`
    Content      string    `bson:"content" json:"content"`
    ContentType  string    `bson:"content_type" json:"contentType"` // markdown | richtext
    WordCount    int       `bson:"word_count" json:"wordCount"`
    CharCount    int       `bson:"char_count" json:"charCount"`
    GridFSID     string    `bson:"gridfs_id,omitempty" json:"gridfsId,omitempty"`
    Version      int       `bson:"version" json:"version"`
    LastSavedAt  time.Time `bson:"last_saved_at" json:"lastSavedAt"`
    LastEditedBy string    `bson:"last_edited_by" json:"lastEditedBy"`
    UpdatedAt    time.Time `bson:"updated_at" json:"updatedAt"`
    CreatedAt    time.Time `bson:"created_at" json:"createdAt"`
}

// IsLargeDocument 判断是否为大文档（>1MB）
func (d *DocumentContent) IsLargeDocument() bool {
    return len(d.Content) > 1024*1024
}

// GetDisplayWordCount 获取显示用的字数
func (d *DocumentContent) GetDisplayWordCount() int {
    if d.WordCount > 0 {
        return d.WordCount
    }
    return len([]rune(d.Content))
}
```

**验证**:
- [ ] 模型定义完整
- [ ] 业务方法正确

#### 2.1.2 创建Version模型

**文件**: `models/document/version.go`

**实施步骤**:

```go
// models/document/version.go
package document

import (
    "fmt"
    "time"
)

// Version 文档版本
type Version struct {
    ID          string    `bson:"_id,omitempty" json:"id"`
    DocumentID  string    `bson:"document_id" json:"documentId" validate:"required"`
    VersionNum  int       `bson:"version_num" json:"versionNum"`
    Content     string    `bson:"content" json:"content"`
    GridFSID    string    `bson:"gridfs_id,omitempty" json:"gridfsId,omitempty"`
    ContentType string    `bson:"content_type" json:"contentType"`
    WordCount   int       `bson:"word_count" json:"wordCount"`
    Comment     string    `bson:"comment,omitempty" json:"comment,omitempty"`
    CreatedBy   string    `bson:"created_by" json:"createdBy"`
    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`
    IsAutoSave  bool      `bson:"is_auto_save" json:"isAutoSave"`
}

// GetVersionLabel 获取版本标签
func (v *Version) GetVersionLabel() string {
    if v.IsAutoSave {
        return fmt.Sprintf("v%d (自动保存)", v.VersionNum)
    }
    return fmt.Sprintf("v%d", v.VersionNum)
}
```

**验证**:
- [ ] 版本模型定义正确
- [ ] 自动保存标记完整

#### 2.1.3 创建DocumentContentRepository接口

**文件**: `repository/interfaces/document/document_content_repository.go`

**关键方法**:
- Create/GetByDocumentID/Update/Delete
- SaveContent/GetContent
- SaveToGridFS/LoadFromGridFS/DeleteFromGridFS
- UpdateWordCount
- Health

**验证**:
- [ ] 接口定义完整
- [ ] GridFS操作方法齐全

#### 2.1.4 创建VersionRepository接口

**文件**: `repository/interfaces/document/version_repository.go`

**关键方法**:
- Create/GetByID/GetByDocumentID/Delete
- GetByVersionNum
- DeleteOldVersions/GetVersionCount

**验证**:
- [ ] 版本操作方法完整

#### 2.1.5 实现MongoDB Repository

**文件**: 
- `repository/mongodb/document/document_content_repository_mongo.go`
- `repository/mongodb/document/version_repository_mongo.go`

**关键实现**:
1. DocumentContent Repository:
   - 自动判断是否使用GridFS（>1MB）
   - GridFS文件上传和下载
   - 字数统计更新

2. Version Repository:
   - 版本号自动递增
   - 版本清理（保留30天）
   - GridFS版本内容存储

**验证**:
- [ ] GridFS操作正确
- [ ] 版本管理逻辑完整

---

### 🧪 测试2.1：Repository测试（2小时）

**文件**: 
- `test/repository/document_content_repository_test.go`
- `test/repository/version_repository_test.go`

**测试重点**:
- 小文件和大文件存储
- GridFS上传下载
- 版本创建和查询
- 版本清理

**验收标准**:
- [ ] 所有测试通过
- [ ] 覆盖率≥90%
- [ ] GridFS操作正常

---

## 任务2.2：文档编辑API实现（Day 2，8小时）

### 📋 任务清单

#### 2.2.1 实现DocumentContentService

**文件**: `service/document/document_content_service.go`

**关键方法**:

```go
// SaveContent 保存文档内容
func (s *DocumentContentService) SaveContent(ctx context.Context, req *SaveContentRequest) (*SaveContentResponse, error) {
    // 1. 验证文档权限
    // 2. 获取当前内容
    // 3. 检查并发冲突（乐观锁）
    // 4. 计算字数
    // 5. 判断是否使用GridFS
    // 6. 保存或更新内容
    // 7. 创建版本（非自动保存才创建）
    // 8. 更新文档统计
    // 9. 发布事件
    // 10. 返回响应
}

// GetContent 获取文档内容
func (s *DocumentContentService) GetContent(ctx context.Context, documentID string) (*DocumentContent, error)

// AutoSave 自动保存
func (s *DocumentContentService) AutoSave(ctx context.Context, req *AutoSaveRequest) error
```

**验证**:
- [ ] 并发冲突检测正确
- [ ] GridFS切换正常
- [ ] 字数统计准确

#### 2.2.2 实现VersionService

**文件**: `service/document/version_service.go`

**关键方法**:

```go
// ListVersions 获取版本历史
func (s *VersionService) ListVersions(ctx context.Context, documentID string, limit int) ([]*Version, error)

// GetVersion 获取指定版本
func (s *VersionService) GetVersion(ctx context.Context, documentID string, versionNum int) (*Version, error)

// CompareVersions 对比两个版本
func (s *VersionService) CompareVersions(ctx context.Context, documentID string, version1, version2 int) (*VersionCompareResponse, error)

// RestoreVersion 恢复到指定版本
func (s *VersionService) RestoreVersion(ctx context.Context, documentID string, versionNum int) error

// CleanOldVersions 清理旧版本
func (s *VersionService) CleanOldVersions(ctx context.Context, documentID string, keepDays int) error
```

**验证**:
- [ ] 版本查询正确
- [ ] 版本恢复功能正常
- [ ] 版本清理逻辑正确

#### 2.2.3 创建DTO模型

**文件**: `service/document/document_content_dto.go`

```go
// SaveContentRequest 保存内容请求
type SaveContentRequest struct {
    DocumentID  string `json:"documentId" validate:"required"`
    Content     string `json:"content"`
    ContentType string `json:"contentType" validate:"required,oneof=markdown richtext"`
    Version     int    `json:"version"`
    Comment     string `json:"comment,omitempty"`
    IsAutoSave  bool   `json:"isAutoSave"`
}

// SaveContentResponse 保存内容响应
type SaveContentResponse struct {
    DocumentID string    `json:"documentId"`
    Version    int       `json:"version"`
    WordCount  int       `json:"wordCount"`
    SavedAt    time.Time `json:"savedAt"`
}

// AutoSaveRequest 自动保存请求
type AutoSaveRequest struct {
    DocumentID  string `json:"documentId"`
    Content     string `json:"content"`
    ContentType string `json:"contentType"`
    Version     int    `json:"version"`
}

// VersionCompareResponse 版本对比响应
type VersionCompareResponse struct {
    Version1      *Version `json:"version1"`
    Version2      *Version `json:"version2"`
    WordCountDiff int      `json:"wordCountDiff"`
}
```

**验证**:
- [ ] DTO定义完整
- [ ] 验证规则正确

---

### 🧪 测试2.2：Service测试（2小时）

**文件**: 
- `test/service/document_content_service_test.go`
- `test/service/version_service_test.go`

**测试重点**:
- 保存内容（小文件和大文件）
- 自动保存
- 并发冲突检测
- 版本创建和恢复
- 版本对比

**验收标准**:
- [ ] 业务逻辑测试通过
- [ ] 覆盖率≥85%
- [ ] Mock使用正确

---

## 任务2.3：Markdown编辑器集成（Day 3，8小时）

### 📋 任务清单

#### 2.3.1 实现DocumentContentApi

**文件**: `api/v1/writer/document_content_api.go`

**API方法**:

```go
// GetContent 获取文档内容
func (api *DocumentContentApi) GetContent(c *gin.Context)

// SaveContent 保存文档内容
func (api *DocumentContentApi) SaveContent(c *gin.Context)

// AutoSave 自动保存
func (api *DocumentContentApi) AutoSave(c *gin.Context)

// GetVersions 获取版本历史
func (api *DocumentContentApi) GetVersions(c *gin.Context)

// GetVersion 获取指定版本
func (api *DocumentContentApi) GetVersion(c *gin.Context)

// RestoreVersion 恢复版本
func (api *DocumentContentApi) RestoreVersion(c *gin.Context)
```

**实施要点**:
- 参数验证完整
- 错误处理统一
- 响应格式规范

**验证**:
- [ ] API实现完整
- [ ] 参数验证正确

#### 2.3.2 配置路由

**文件**: `router/writer/document_content.go`

```go
func InitDocumentContentRouter(r *gin.RouterGroup, contentApi *writer.DocumentContentApi) {
    docGroup := r.Group("/documents")
    docGroup.Use(middleware.JWTAuth())
    {
        // 内容管理
        docGroup.GET("/:id/content", contentApi.GetContent)
        docGroup.PUT("/:id/content", contentApi.SaveContent)
        docGroup.POST("/:id/autosave", contentApi.AutoSave)
        
        // 版本管理
        docGroup.GET("/:id/versions", contentApi.GetVersions)
        docGroup.GET("/:id/versions/:version", contentApi.GetVersion)
        docGroup.POST("/:id/restore/:version", contentApi.RestoreVersion)
    }
}
```

**验证**:
- [ ] 路由配置正确
- [ ] 中间件应用正常

#### 2.3.3 编写API文档

**文件**: `doc/api/document/文档编辑API.md`

**内容包括**:
- 接口列表
- 请求参数
- 响应格式
- 错误码说明
- 示例代码

**验证**:
- [ ] API文档完整
- [ ] 示例代码正确

---

### 🧪 测试2.3：API测试（2小时）

**文件**: `test/api/document_content_api_test.go`

**测试用例**:
- 获取内容测试
- 保存内容测试（小文件和大文件）
- 自动保存测试
- 版本历史测试
- 版本恢复测试
- 并发保存测试

**Postman测试集**: `test/postman/写作端-文档编辑.postman_collection.json`

**验收标准**:
- [ ] 所有API测试通过
- [ ] Postman测试集完整
- [ ] 并发测试通过

---

## 任务2.4：富文本编辑器集成（Day 4，8小时）

### 📋 任务清单

#### 2.4.1 格式转换工具

**文件**: `pkg/converter/markdown_converter.go`

**实施步骤**:

```go
package converter

// MarkdownToHTML Markdown转HTML
func MarkdownToHTML(markdown string) (string, error) {
    // 使用marked库或goldmark
}

// HTMLToMarkdown HTML转Markdown
func HTMLToMarkdown(html string) (string, error) {
    // 使用turndown或类似库
}

// ValidateMarkdown 验证Markdown格式
func ValidateMarkdown(markdown string) error
```

**验证**:
- [ ] 转换功能正常
- [ ] 格式保留完整

#### 2.4.2 前端编辑器组件（参考）

**Markdown编辑器**:
```vue
<template>
  <div class="editor-container">
    <v-md-editor
      v-model="content"
      height="600px"
      @save="handleSave"
      @change="handleChange"
    />
    
    <div class="editor-status">
      <span>字数: {{ wordCount }}</span>
      <span>{{ saveStatus }}</span>
    </div>
  </div>
</template>

<script>
export default {
  data() {
    return {
      content: '',
      wordCount: 0,
      saveStatus: '已保存',
      autoSaveTimer: null,
      version: 0
    }
  },
  
  mounted() {
    this.loadContent()
    this.startAutoSave()
  },
  
  methods: {
    async loadContent() {
      const res = await this.$api.getDocumentContent(this.documentId)
      this.content = res.data.content
      this.version = res.data.version
      this.wordCount = res.data.wordCount
    },
    
    async handleSave() {
      try {
        const res = await this.$api.saveDocumentContent(this.documentId, {
          content: this.content,
          contentType: 'markdown',
          version: this.version
        })
        this.version = res.data.version
        this.saveStatus = '已保存'
        this.$message.success('保存成功')
      } catch (error) {
        this.$message.error('保存失败')
      }
    },
    
    handleChange() {
      this.saveStatus = '未保存'
      this.wordCount = this.content.length
    },
    
    startAutoSave() {
      this.autoSaveTimer = setInterval(() => {
        if (this.saveStatus === '未保存') {
          this.autoSave()
        }
      }, 30000) // 30秒自动保存
    },
    
    async autoSave() {
      try {
        await this.$api.autoSaveDocumentContent(this.documentId, {
          content: this.content,
          contentType: 'markdown',
          version: this.version
        })
        this.saveStatus = '自动保存于 ' + new Date().toLocaleTimeString()
      } catch (error) {
        console.error('自动保存失败', error)
      }
    }
  },
  
  beforeUnmount() {
    if (this.autoSaveTimer) {
      clearInterval(this.autoSaveTimer)
    }
  }
}
</script>
```

**验证**:
- [ ] 前端组件参考文档完整

---

### 🧪 测试2.4：功能测试（2小时）

**测试内容**:
- 格式转换测试
- 字数统计测试
- 大文件处理测试

**验收标准**:
- [ ] 转换功能正常
- [ ] 统计准确

---

## 任务2.5：版本控制界面（Day 5，8小时）

### 📋 任务清单

#### 2.5.1 版本历史组件（参考）

**文件**: 前端组件参考

```vue
<template>
  <div class="version-history">
    <el-timeline>
      <el-timeline-item
        v-for="version in versions"
        :key="version.id"
        :timestamp="formatTime(version.createdAt)"
      >
        <div class="version-item">
          <div class="version-info">
            <span class="version-num">v{{ version.versionNum }}</span>
            <span class="version-comment">{{ version.comment }}</span>
            <span class="word-count">{{ version.wordCount }}字</span>
          </div>
          <div class="version-actions">
            <el-button size="small" @click="previewVersion(version)">
              预览
            </el-button>
            <el-button size="small" @click="compareVersion(version)">
              对比
            </el-button>
            <el-button size="small" type="primary" @click="restoreVersion(version)">
              恢复
            </el-button>
          </div>
        </div>
      </el-timeline-item>
    </el-timeline>
  </div>
</template>
```

#### 2.5.2 Diff对比功能

**工具库**: diff-match-patch

**实施要点**:
- 逐行对比
- 差异高亮
- 统计信息（增删字数）

**验证**:
- [ ] 对比功能正常
- [ ] 高亮显示正确

#### 2.5.3 完整功能测试

**测试场景**:
1. 创建文档并编辑
2. 多次保存生成版本
3. 查看版本历史
4. 对比不同版本
5. 恢复到历史版本
6. 自动保存功能
7. 大文档处理

**验证**:
- [ ] 所有功能正常
- [ ] 性能符合要求

---

## 阶段2完成验证

### ✅ 功能验证清单

#### 编辑功能
- [ ] Markdown编辑器正常
- [ ] 富文本编辑器正常
- [ ] 格式转换功能正常
- [ ] 字数统计准确

#### 保存功能
- [ ] 手动保存成功
- [ ] 自动保存正常（30秒）
- [ ] 大文件GridFS保存成功
- [ ] 并发冲突检测有效

#### 版本控制
- [ ] 版本自动创建
- [ ] 版本历史查询正常
- [ ] 版本对比功能正常
- [ ] 版本恢复功能正常
- [ ] 版本清理功能正常

#### 性能指标
- [ ] 文档加载 <500ms
- [ ] 自动保存 <200ms
- [ ] 版本查询 <300ms
- [ ] 版本对比 <1s

### 📊 质量指标

- [ ] 单元测试覆盖率 ≥ 90%
- [ ] Service测试覆盖率 ≥ 85%
- [ ] API测试全部通过
- [ ] 性能测试达标
- [ ] 代码审查通过

### 📝 交付文档

- [ ] 更新实施进度
- [ ] 编写API使用文档
- [ ] 前端集成文档
- [ ] 性能测试报告

---

## 常见问题和解决方案

### Q1: 大文档保存缓慢如何优化？

**A**: 
1. 使用GridFS分块存储
2. 压缩内容后存储
3. 异步处理大文件
4. 前端分块上传

### Q2: 自动保存失败如何处理？

**A**:
1. 前端LocalStorage缓存
2. 保存失败重试3次
3. 明确提示保存状态
4. 提供手动保存按钮

### Q3: 版本过多如何管理？

**A**:
1. 定期清理30天前版本
2. 重要版本打标签保留
3. 合并连续小改动
4. 限制版本总数（100个）

---

## 下一步计划

完成阶段2后，进入**阶段3：设定百科系统**开发，包括：
- 角色卡管理
- 世界观设定
- 设定模板库
- 关系图谱

---

**文档版本**: v1.0  
**创建日期**: 2025-10-16  
**最后更新**: 2025-10-16  
**状态**: ⏸️ 待开始  
**前置依赖**: 阶段1完成

