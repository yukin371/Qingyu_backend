# 阶段3：设定百科系统实施指南

> **实施周期**: 3周（2025.10.29 - 2025.11.16）  
> **前置依赖**: 阶段1、阶段2完成  
> **状态**: ⏸️ 待开始

## 实施概览

本阶段实施设定百科系统，包括角色卡管理、世界观设定、设定模板库等功能。

### 目标成果

- ✅ 角色卡完整管理系统
- ✅ 角色关系图谱可视化
- ✅ 世界观设定管理（11种类型）
- ✅ 设定模板库（10+内置模板）
- ✅ 设定关联和引用功能

---

## 任务3.1：角色卡管理（Week 1，5天）

### Day 1: Character模型与Repository

#### 📋 任务清单

**文件**: `models/document/character.go`

```go
type Character struct {
    ID          string    `bson:"_id,omitempty" json:"id"`
    ProjectID   string    `bson:"project_id" json:"projectId"`
    Name        string    `bson:"name" json:"name"`
    Alias       []string  `bson:"alias,omitempty" json:"alias,omitempty"`
    Summary     string    `bson:"summary,omitempty" json:"summary,omitempty"`
    Traits      []string  `bson:"traits,omitempty" json:"traits,omitempty"`
    Background  string    `bson:"background,omitempty" json:"background,omitempty"`
    AvatarURL   string    `bson:"avatar_url,omitempty" json:"avatarUrl,omitempty"`
    CreatedBy   string    `bson:"created_by" json:"createdBy"`
    CreatedAt   time.Time `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time `bson:"updated_at" json:"updatedAt"`
    DeletedAt   *time.Time `bson:"deleted_at,omitempty" json:"deletedAt,omitempty"`
}
```

**Repository接口**: `repository/interfaces/document/character_repository.go`

**MongoDB实现**: `repository/mongodb/document/character_repository_mongo.go`

**测试**: `test/repository/character_repository_test.go`

---

### Day 2: Relationship模型与Repository

#### 📋 任务清单

**文件**: `models/document/relationship.go`

```go
type Relationship struct {
    ID              string           `bson:"_id,omitempty" json:"id"`
    ProjectID       string           `bson:"project_id" json:"projectId"`
    FromCharacterID string           `bson:"from_character_id" json:"fromCharacterId"`
    ToCharacterID   string           `bson:"to_character_id" json:"toCharacterId"`
    Type            RelationshipType `bson:"type" json:"type"`
    Description     string           `bson:"description,omitempty" json:"description,omitempty"`
    Strength        int              `bson:"strength" json:"strength"` // 1-10
    CreatedBy       string           `bson:"created_by" json:"createdBy"`
    CreatedAt       time.Time        `bson:"created_at" json:"createdAt"`
    UpdatedAt       time.Time        `bson:"updated_at" json:"updatedAt"`
}

type RelationshipType string

const (
    RelationshipFamily    RelationshipType = "family"
    RelationshipFriend    RelationshipType = "friend"
    RelationshipLove      RelationshipType = "love"
    RelationshipEnemy     RelationshipType = "enemy"
    RelationshipMentor    RelationshipType = "mentor"
    RelationshipColleague RelationshipType = "colleague"
    RelationshipRival     RelationshipType = "rival"
)
```

**Repository接口**: `repository/interfaces/document/relationship_repository.go`

**MongoDB实现**: `repository/mongodb/document/relationship_repository_mongo.go`

**测试**: `test/repository/relationship_repository_test.go`

---

### Day 3: CharacterService与GraphService

#### 📋 任务清单

**CharacterService**: `service/character/character_service.go`

**关键方法**:
- CreateCharacter
- GetCharacterByID
- ListCharacters
- UpdateCharacter
- DeleteCharacter
- SearchCharacters

**GraphService**: `service/character/graph_service.go`

**关键方法**:
- GenerateGraph: 生成关系图数据
- GetCharacterNetwork: 获取角色关系网络

**测试**: `test/service/character_service_test.go`

---

### Day 4: 角色管理API

#### 📋 任务清单

**文件**: `api/v1/writer/character_api.go`

**API列表**:
- POST /api/v1/projects/{projectId}/characters
- GET /api/v1/projects/{projectId}/characters
- GET /api/v1/projects/{projectId}/characters/{id}
- PUT /api/v1/projects/{projectId}/characters/{id}
- DELETE /api/v1/projects/{projectId}/characters/{id}
- POST /api/v1/projects/{projectId}/relationships
- GET /api/v1/projects/{projectId}/relationships
- GET /api/v1/projects/{projectId}/graph

**路由**: `router/writer/character.go`

**测试**: `test/api/character_api_test.go`

---

### Day 5: 前端集成与测试

#### 📋 任务清单

**前端组件参考**:
- CharacterList.vue: 角色列表
- CharacterForm.vue: 角色编辑表单
- RelationshipGraph.vue: 关系图谱（使用D3.js或ECharts）

**完整测试**:
- 角色CRUD测试
- 关系管理测试
- 关系图生成测试
- 性能测试

---

## 任务3.2：世界观设定（Week 2，5天）

### Day 1: WorldSetting模型与Repository

#### 📋 任务清单

**文件**: `models/document/world_setting.go`

```go
type WorldSetting struct {
    ID          string       `bson:"_id,omitempty" json:"id"`
    ProjectID   string       `bson:"project_id" json:"projectId"`
    Type        SettingType  `bson:"type" json:"type"`
    Category    string       `bson:"category,omitempty" json:"category,omitempty"`
    Name        string       `bson:"name" json:"name"`
    Summary     string       `bson:"summary,omitempty" json:"summary,omitempty"`
    Content     string       `bson:"content" json:"content"`
    Properties  map[string]interface{} `bson:"properties,omitempty" json:"properties,omitempty"`
    RelatedSettings []string `bson:"related_settings,omitempty" json:"relatedSettings,omitempty"`
    Tags        []string     `bson:"tags,omitempty" json:"tags,omitempty"`
    Notes       string       `bson:"notes,omitempty" json:"notes,omitempty"`
    ReferenceCount int       `bson:"reference_count" json:"referenceCount"`
    Images      []string     `bson:"images,omitempty" json:"images,omitempty"`
    CreatedBy   string       `bson:"created_by" json:"createdBy"`
    CreatedAt   time.Time    `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time    `bson:"updated_at" json:"updatedAt"`
    DeletedAt   *time.Time   `bson:"deleted_at,omitempty" json:"deletedAt,omitempty"`
}

type SettingType string

const (
    TypeCultivation   SettingType = "cultivation"   // 修炼体系
    TypeFaction       SettingType = "faction"       // 势力组织
    TypeGeography     SettingType = "geography"     // 地理设定
    TypeItem          SettingType = "item"          // 物品设定
    TypeSkill         SettingType = "skill"         // 技能设定
    TypeRace          SettingType = "race"          // 种族设定
    TypeHistory       SettingType = "history"       // 历史事件
    TypeCulture       SettingType = "culture"       // 文化设定
    TypeMagic         SettingType = "magic"         // 魔法体系
    TypeTechnology    SettingType = "technology"    // 科技体系
    TypeOther         SettingType = "other"         // 其他
)
```

**Repository接口**: `repository/interfaces/document/world_setting_repository.go`

**MongoDB实现**: `repository/mongodb/document/world_setting_repository_mongo.go`

**测试**: `test/repository/world_setting_repository_test.go`

---

### Day 2-3: 特定类型属性结构

#### 📋 任务清单

**文件**: `models/document/setting_properties.go`

```go
// CultivationProperties 修炼体系属性
type CultivationProperties struct {
    Levels      []CultivationLevel `json:"levels"`
    Method      string            `json:"method"`
    Energy      string            `json:"energy"`
    Description string            `json:"description"`
}

type CultivationLevel struct {
    Name        string `json:"name"`
    Order       int    `json:"order"`
    Description string `json:"description"`
}

// FactionProperties 势力组织属性
type FactionProperties struct {
    LeaderName   string   `json:"leaderName"`
    MemberCount  int      `json:"memberCount"`
    Territory    string   `json:"territory"`
    Strength     string   `json:"strength"`
    Affiliation  string   `json:"affiliation"`
    Allies       []string `json:"allies"`
    Enemies      []string `json:"enemies"`
}

// GeographyProperties 地理设定属性
type GeographyProperties struct {
    LocationType string  `json:"locationType"`
    Climate      string  `json:"climate"`
    Area         float64 `json:"area"`
    Population   int     `json:"population"`
    Coordinates  string  `json:"coordinates"`
}

// ItemProperties 物品设定属性
type ItemProperties struct {
    ItemType    string `json:"itemType"`
    Rarity      string `json:"rarity"`
    Effect      string `json:"effect"`
    Origin      string `json:"origin"`
    Material    string `json:"material"`
}

// ... 其他类型属性
```

**验证**:
- [ ] 所有类型属性定义完整
- [ ] 属性验证规则正确

---

### Day 4: WorldSettingService

#### 📋 任务清单

**文件**: `service/worldsetting/world_setting_service.go`

**关键方法**:
- CreateSetting
- GetSettingsByType
- GetSettingsByCategory
- SearchSettings
- UpdateSetting
- DeleteSetting
- AddRelatedSetting
- RemoveRelatedSetting

**测试**: `test/service/world_setting_service_test.go`

---

### Day 5: 世界观设定API

#### 📋 任务清单

**文件**: `api/v1/writer/world_setting_api.go`

**API列表**:
- POST /api/v1/projects/{projectId}/settings
- GET /api/v1/projects/{projectId}/settings?type=cultivation
- GET /api/v1/projects/{projectId}/settings/search?keyword=境界
- GET /api/v1/projects/{projectId}/settings/{id}
- PUT /api/v1/projects/{projectId}/settings/{id}
- DELETE /api/v1/projects/{projectId}/settings/{id}

**路由**: `router/writer/world_setting.go`

**测试**: `test/api/world_setting_api_test.go`

---

## 任务3.3：设定模板库（Week 3，5天）

### Day 1-2: 内置模板设计

#### 📋 任务清单

**文件**: `models/document/setting_template.go`

```go
type SettingTemplate struct {
    ID          string                 `bson:"_id,omitempty" json:"id"`
    Name        string                 `bson:"name" json:"name"`
    Type        SettingType            `bson:"type" json:"type"`
    Category    string                 `bson:"category,omitempty" json:"category,omitempty"`
    Description string                 `bson:"description,omitempty" json:"description,omitempty"`
    Fields      []TemplateField        `bson:"fields" json:"fields"`
    DefaultData map[string]interface{} `bson:"default_data,omitempty" json:"defaultData,omitempty"`
    IsBuiltIn   bool                   `bson:"is_built_in" json:"isBuiltIn"`
    CreatedBy   string                 `bson:"created_by,omitempty" json:"createdBy,omitempty"`
    CreatedAt   time.Time              `bson:"created_at" json:"createdAt"`
    UpdatedAt   time.Time              `bson:"updated_at" json:"updatedAt"`
}

type TemplateField struct {
    Name        string      `json:"name"`
    Label       string      `json:"label"`
    Type        string      `json:"type"` // text, textarea, number, select, etc.
    Required    bool        `json:"required"`
    Placeholder string      `json:"placeholder,omitempty"`
    Options     []string    `json:"options,omitempty"`
    DefaultValue interface{} `json:"defaultValue,omitempty"`
}
```

**内置模板列表**:
1. 玄幻修真境界体系模板
2. 现代都市势力模板
3. 奇幻种族设定模板
4. 科幻科技体系模板
5. 武侠功法设定模板
6. 历史朝代背景模板
7. 游戏装备系统模板
8. 魔法体系模板
9. 异能设定模板
10. 世界观背景模板

**验证**:
- [ ] 10个内置模板创建完成
- [ ] 模板字段设计合理

---

### Day 3: 模板Service

#### 📋 任务清单

**文件**: `service/template/template_service.go`

**关键方法**:
- ListTemplates
- GetTemplate
- CreateTemplateFromSetting
- ApplyTemplate
- UpdateTemplate
- DeleteTemplate

**测试**: `test/service/template_service_test.go`

---

### Day 4: 模板API

#### 📋 任务清单

**文件**: `api/v1/writer/template_api.go`

**API列表**:
- GET /api/v1/templates?type=cultivation
- GET /api/v1/templates/{id}
- POST /api/v1/templates (创建自定义模板)
- POST /api/v1/templates/{id}/apply (应用模板)

**路由**: `router/writer/template.go`

**测试**: `test/api/template_api_test.go`

---

### Day 5: 完整测试与优化

#### 📋 任务清单

**完整功能测试**:
- 角色卡CRUD完整流程
- 关系图谱生成和显示
- 世界观设定管理
- 设定关联功能
- 模板应用功能
- 设定搜索功能

**性能优化**:
- 关系图谱查询优化
- 设定搜索索引优化
- 模板加载优化

**文档完善**:
- 更新实施进度
- 编写使用文档
- 记录已知问题

---

## 阶段3完成验证

### ✅ 功能验证清单

#### 角色管理
- [ ] 角色CRUD功能正常
- [ ] 角色搜索功能正常
- [ ] 角色关系创建成功
- [ ] 关系图谱生成正确
- [ ] 关系强度显示正常

#### 世界观设定
- [ ] 11种设定类型支持
- [ ] 设定分类管理正常
- [ ] 结构化属性保存正确
- [ ] 设定关联功能正常
- [ ] 设定搜索功能有效

#### 模板系统
- [ ] 10个内置模板可用
- [ ] 自定义模板创建成功
- [ ] 模板应用功能正常
- [ ] 模板导入导出正常

#### 引用功能
- [ ] 设定引用计数准确
- [ ] 关联设定查询正常
- [ ] 引用关系管理正确

### 📊 质量指标

- [ ] 单元测试覆盖率 ≥ 90%
- [ ] Service测试覆盖率 ≥ 85%
- [ ] API测试全部通过
- [ ] 性能测试达标
- [ ] 用户体验良好

### 📝 交付文档

- [ ] 角色管理使用文档
- [ ] 世界观设定使用文档
- [ ] 模板使用指南
- [ ] API文档完整
- [ ] 实施总结报告

---

## 常见问题和解决方案

### Q1: 关系图谱性能问题？

**A**:
1. 限制单次查询节点数（最多100个）
2. 使用分页加载
3. 前端虚拟渲染
4. Redis缓存图谱数据

### Q2: 设定类型扩展如何处理？

**A**:
1. Properties字段使用map[string]interface{}
2. 新类型只需添加常量定义
3. 属性结构可动态解析
4. 保持向后兼容

### Q3: 模板如何适配不同类型？

**A**:
1. 模板与设定类型绑定
2. 字段配置灵活可扩展
3. 支持自定义字段
4. 提供默认值机制

---

## 写作端模块完成标准

### 核心功能完成度

| 功能模块 | 完成标准 |
|---------|---------|
| 项目管理 | ✅ CRUD、权限、统计 |
| 文档管理 | ✅ 树形结构、移动、排序 |
| 文档编辑 | ✅ 双模式、自动保存、版本控制 |
| 角色管理 | ✅ CRUD、关系图谱 |
| 世界观设定 | ✅ 11种类型、关联、搜索 |
| 模板系统 | ✅ 10+模板、应用、导出 |

### MVP交付标准

- [ ] 可以创建和管理项目
- [ ] 可以编辑文档（Markdown）
- [ ] 自动保存功能稳定
- [ ] 版本控制功能正常
- [ ] 可以管理角色和关系
- [ ] 可以创建世界观设定
- [ ] 基础模板可用

---

**文档版本**: v1.0  
**创建日期**: 2025-10-16  
**最后更新**: 2025-10-16  
**状态**: ⏸️ 待开始  
**前置依赖**: 阶段1、阶段2完成

