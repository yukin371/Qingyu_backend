# 写作端模块实施文档

## 文档概述

本文档跟踪和记录青羽平台写作端模块的完整实施过程，包括项目管理、文档编辑、设定百科、版本控制等功能。

## 项目背景

### 目标
构建功能完善的写作创作平台，为作者提供项目管理、文档编辑、设定管理、AI辅助等全方位创作支持。

### 实施范围

| 功能模块 | 状态 | 说明 |
|---------|------|------|
| 项目管理 | ⏸️ 待开始 | 项目CRUD、权限管理 |
| 文档树管理 | ⏸️ 待开始 | 树形结构、拖拽排序 |
| 文档编辑 | ⏸️ 待开始 | Markdown/富文本、自动保存 |
| 版本控制 | ⏸️ 待开始 | 版本历史、对比、回滚 |
| 设定百科 | ⏸️ 待开始 | 角色卡、世界观、关系图谱 |

---

## 实施阶段

### 阶段1：项目管理模块（预计5天，2025.10.10-10.14）

**整体进度**: 0% (0/5任务)  
**计划开始**: 2025年10月10日  
**计划完成**: 2025年10月14日

#### 任务1.1：Project模型与Repository（1天）
- [ ] Project模型设计
  - [ ] 基础字段（ID、标题、描述、封面）
  - [ ] 作者字段（author_id）
  - [ ] 状态字段（草稿、连载、完结）
  - [ ] 统计字段（总字数、章节数）
  - [ ] 设置字段（可见性、分类、标签）
- [ ] ProjectRepository接口
  - [ ] Create（创建项目）
  - [ ] GetByID（查询项目）
  - [ ] GetByAuthorID（作者的项目列表）
  - [ ] Update（更新项目）
  - [ ] Delete（删除项目）
  - [ ] UpdateStatistics（更新统计）
- [ ] MongoDB实现
  - [ ] 实现所有接口
  - [ ] 索引创建（author_id, status）
  - [ ] 单元测试

**预期交付物**:
- ✅ Project模型
- ✅ ProjectRepository实现
- ✅ 单元测试覆盖率≥90%

**预计工作量**: 8小时

#### 任务1.2：ProjectService业务逻辑（1天）
- [ ] Service接口设计
  - [ ] CreateProject（创建项目）
  - [ ] GetProject（获取项目详情）
  - [ ] ListMyProjects（我的项目列表）
  - [ ] UpdateProject（更新项目）
  - [ ] DeleteProject（删除项目）
  - [ ] UpdateProjectStatistics（更新统计）
- [ ] 业务逻辑实现
  - [ ] 权限检查（只能管理自己的项目）
  - [ ] 参数验证
  - [ ] 级联删除（删除项目时删除文档）
  - [ ] 统计信息同步
- [ ] 单元测试
  - [ ] 正常流程测试
  - [ ] 权限测试
  - [ ] 异常测试

**预期交付物**:
- ✅ ProjectService实现
- ✅ 业务逻辑测试
- ✅ 测试覆盖率≥85%

**预计工作量**: 8小时

#### 任务1.3：文档树结构设计（1天）
- [ ] Document模型设计
  - [ ] 基础字段（ID、标题、内容）
  - [ ] 树形结构（parent_id、order、level）
  - [ ] 项目关联（project_id）
  - [ ] 类型字段（卷、章、节）
  - [ ] 统计字段（字数、创建时间）
- [ ] 树形操作方法
  - [ ] GetChildren（获取子节点）
  - [ ] GetAncestors（获取祖先节点）
  - [ ] GetSiblings（获取兄弟节点）
  - [ ] Move（移动节点）
  - [ ] UpdateOrder（更新顺序）
- [ ] Repository实现
  - [ ] 树形查询优化
  - [ ] 批量操作支持

**预期交付物**:
- ✅ Document模型
- ✅ 树形操作方法
- ✅ Repository实现

**预计工作量**: 8小时

#### 任务1.4：文档管理Service（1天）
- [ ] DocumentService接口
  - [ ] CreateDocument（创建文档）
  - [ ] GetDocument（获取文档）
  - [ ] ListDocuments（文档列表）
  - [ ] UpdateDocument（更新文档）
  - [ ] DeleteDocument（删除文档）
  - [ ] MoveDocument（移动文档）
  - [ ] ReorderDocuments（重新排序）
- [ ] 业务逻辑
  - [ ] 权限检查
  - [ ] 层级限制（最多3层）
  - [ ] 顺序管理
  - [ ] 级联删除
  - [ ] 字数统计与同步
- [ ] 单元测试

**预期交付物**:
- ✅ DocumentService实现
- ✅ 树形操作测试
- ✅ 权限测试

**预计工作量**: 8小时

#### 任务1.5：项目管理API与前端（1天）
- [ ] 后端API
  - [ ] POST /api/projects（创建项目）
  - [ ] GET /api/projects/:id（项目详情）
  - [ ] GET /api/projects（项目列表）
  - [ ] PUT /api/projects/:id（更新项目）
  - [ ] DELETE /api/projects/:id（删除项目）
  - [ ] GET /api/projects/:id/documents（文档树）
- [ ] 前端页面
  - [ ] 项目列表页
  - [ ] 项目创建/编辑表单
  - [ ] 文档树组件（el-tree）
  - [ ] 拖拽排序功能

**预期交付物**:
- ✅ 6个项目管理API
- ✅ 前端项目管理界面
- ✅ 文档树组件

**预计工作量**: 8小时

**里程碑**: 项目管理模块完成（2025.10.14）

---

### 阶段2：文档编辑器（预计5天，2025.10.15-10.19）

**整体进度**: 0% (0/5任务)

#### 任务2.1：文档内容存储设计（1天）
- [ ] 内容存储方案
  - [ ] MongoDB存储（适合<16MB文档）
  - [ ] GridFS存储（大文档）
  - [ ] 分块存储策略
- [ ] 版本控制设计
  - [ ] Version模型
  - [ ] 版本号生成
  - [ ] 版本内容存储
  - [ ] 版本关联
- [ ] 自动保存机制
  - [ ] 前端定时保存（30秒）
  - [ ] 后端保存API
  - [ ] 冲突检测
  - [ ] 保存状态反馈

**预期交付物**:
- ✅ 内容存储方案
- ✅ Version模型
- ✅ 自动保存设计

**预计工作量**: 8小时

#### 任务2.2：文档编辑API实现（1天）
- [ ] 编辑相关API
  - [ ] GET /api/documents/:id/content（获取内容）
  - [ ] PUT /api/documents/:id/content（保存内容）
  - [ ] POST /api/documents/:id/autosave（自动保存）
  - [ ] GET /api/documents/:id/versions（版本历史）
  - [ ] GET /api/documents/:id/versions/:version（获取版本）
  - [ ] POST /api/documents/:id/restore（恢复版本）
- [ ] 业务逻辑
  - [ ] 并发编辑检测
  - [ ] 字数统计
  - [ ] 版本创建策略
  - [ ] 版本清理（保留30天）

**预期交付物**:
- ✅ 6个编辑相关API
- ✅ 版本控制实现
- ✅ 并发处理

**预计工作量**: 8小时

#### 任务2.3：Markdown编辑器集成（1天）
- [ ] v-md-editor集成
  - [ ] 编辑器配置
  - [ ] 工具栏自定义
  - [ ] 快捷键配置
  - [ ] 实时预览
- [ ] 编辑器功能
  - [ ] 语法高亮
  - [ ] 代码块支持
  - [ ] 表格编辑
  - [ ] 图片上传
  - [ ] 链接插入
- [ ] 自动保存集成
  - [ ] 定时器实现
  - [ ] 保存状态显示
  - [ ] 错误处理

**预期交付物**:
- ✅ Markdown编辑器
- ✅ 自动保存功能
- ✅ 编辑器组件

**预计工作量**: 8小时

#### 任务2.4：富文本编辑器集成（1天）
- [ ] Quill编辑器集成
  - [ ] 编辑器初始化
  - [ ] 工具栏配置
  - [ ] 格式化选项
- [ ] 富文本功能
  - [ ] 字体样式
  - [ ] 段落格式
  - [ ] 列表与引用
  - [ ] 图片与视频
- [ ] Markdown转换
  - [ ] Markdown→富文本
  - [ ] 富文本→Markdown
  - [ ] 双模式切换

**预期交付物**:
- ✅ 富文本编辑器
- ✅ 格式转换功能
- ✅ 双模式支持

**预计工作量**: 8小时

#### 任务2.5：版本控制界面（1天）
- [ ] 版本历史组件
  - [ ] 版本列表
  - [ ] 版本对比（diff）
  - [ ] 版本预览
  - [ ] 版本恢复
- [ ] Diff显示
  - [ ] 文本差异高亮
  - [ ] 逐行对比
  - [ ] 统计信息
- [ ] 操作功能
  - [ ] 一键回滚
  - [ ] 版本导出
  - [ ] 版本标签

**预期交付物**:
- ✅ 版本历史界面
- ✅ Diff对比功能
- ✅ 版本管理功能

**预计工作量**: 8小时

**里程碑**: 文档编辑器完成（2025.10.19）

---

### 阶段3：设定百科系统（预计3周，2025.11.02-11.22）

**整体进度**: 0% (0/3任务)

#### 任务3.1：角色卡管理（1周）
- [ ] CharacterCard模型
  - [ ] 基础信息（姓名、性别、年龄）
  - [ ] 外貌特征
  - [ ] 性格特点
  - [ ] 背景故事
  - [ ] 能力设定
  - [ ] 关系网络
  - [ ] 自定义字段
- [ ] Repository与Service
  - [ ] CRUD操作
  - [ ] 关联到项目
  - [ ] 角色搜索
  - [ ] 批量导入导出
- [ ] 前端界面
  - [ ] 角色卡列表
  - [ ] 角色卡编辑表单
  - [ ] 自定义字段管理
  - [ ] 角色卡模板

**预期交付物**:
- ✅ 角色卡管理功能
- ✅ 完整的前后端实现
- ✅ 角色卡模板库

**预计工作量**: 40小时

#### 任务3.2：世界观设定（1周）
- [ ] WorldSetting模型
  - [ ] 设定分类（修炼体系、势力、地理等）
  - [ ] 设定内容（富文本）
  - [ ] 设定关联
  - [ ] 设定标签
- [ ] 设定管理功能
  - [ ] 设定CRUD
  - [ ] 设定分类管理
  - [ ] 设定关联引用
  - [ ] 设定搜索
- [ ] 前端界面
  - [ ] 设定树形结构
  - [ ] 设定编辑器
  - [ ] 设定引用系统

**预期交付物**:
- ✅ 世界观设定功能
- ✅ 设定分类系统
- ✅ 设定引用功能

**预计工作量**: 40小时

#### 任务3.3：设定模板库（1周）
- [ ] 模板系统设计
  - [ ] Template模型
  - [ ] 内置模板
  - [ ] 用户自定义模板
  - [ ] 模板分类
- [ ] 模板功能
  - [ ] 模板创建
  - [ ] 模板应用
  - [ ] 模板分享
  - [ ] 模板导入导出
- [ ] 前端界面
  - [ ] 模板库页面
  - [ ] 模板预览
  - [ ] 模板选择器

**预期交付物**:
- ✅ 设定模板系统
- ✅ 10+内置模板
- ✅ 模板管理界面

**预计工作量**: 40小时

**里程碑**: 设定百科系统完成（2025.11.22）

---

## 总体进度概览

| 阶段 | 周数 | 任务数 | 完成 | 进度 | 预计完成日期 |
|------|------|--------|------|------|-------------|
| 阶段1：项目管理 | 1周 | 5 | 0 | 0% | 2025.10.14 |
| 阶段2：文档编辑器 | 1周 | 5 | 0 | 0% | 2025.10.19 |
| 阶段3：设定百科 | 3周 | 3 | 0 | 0% | 2025.11.22 |
| **总计** | **5周** | **13** | **0** | **0%** | **2025.11.22** |

**总预计工作量**: 200小时

---

## 技术栈

### 后端技术
- **Go**: 1.21+
- **Gin**: Web框架
- **MongoDB**: 数据存储
- **GridFS**: 大文件存储
- **Redis**: 缓存

### 前端技术
- **Vue 3**: 前端框架
- **Element Plus**: UI组件
- **v-md-editor**: Markdown编辑器
- **Quill**: 富文本编辑器
- **diff-match-patch**: 文本对比

---

## 项目结构

### 后端结构
```
Qingyu_backend/
├── models/
│   ├── writer/
│   │   ├── project.go           # 项目模型
│   │   ├── document.go          # 文档模型
│   │   ├── version.go           # 版本模型
│   │   ├── character_card.go    # 角色卡模型
│   │   └── world_setting.go     # 世界观模型
├── repository/
│   ├── interfaces/
│   │   ├── project_repository.go
│   │   └── document_repository.go
│   └── mongodb/
│       ├── project_repository.go
│       └── document_repository.go
├── service/
│   ├── writer/
│   │   ├── project_service.go   # 项目服务
│   │   ├── document_service.go  # 文档服务
│   │   ├── version_service.go   # 版本服务
│   │   └── setting_service.go   # 设定服务
├── api/v1/
│   └── writer/
│       ├── project_api.go       # 项目API
│       ├── document_api.go      # 文档API
│       └── setting_api.go       # 设定API
```

### 前端结构
```
Qingyu/
├── src/
│   ├── views/
│   │   └── writer/
│   │       ├── ProjectList.vue  # 项目列表
│   │       ├── Editor.vue       # 编辑器
│   │       ├── Characters.vue   # 角色卡管理
│   │       └── Settings.vue     # 世界观设定
│   ├── components/
│   │   └── writer/
│   │       ├── DocumentTree.vue # 文档树
│   │       ├── MdEditor.vue     # Markdown编辑器
│   │       ├── RichEditor.vue   # 富文本编辑器
│   │       └── VersionHistory.vue # 版本历史
│   └── stores/
│       └── writer.js            # 写作端状态
```

---

## 质量标准

### 代码质量
- [ ] 单元测试覆盖率≥80%
- [ ] Service层测试≥85%
- [ ] Repository层测试≥90%
- [ ] 0 Linter错误

### 功能标准
- [ ] 自动保存稳定性100%
- [ ] 版本控制准确性100%
- [ ] 文档树操作无BUG
- [ ] 编辑器响应流畅

### 性能标准
- [ ] 文档加载：<500ms
- [ ] 自动保存：<200ms
- [ ] 文档树加载：<300ms
- [ ] 版本对比：<1s

---

## 风险与应对

### 风险1：大文档性能问题
**风险描述**: 单个文档过大（>1MB）导致加载缓慢

**应对措施**:
- 实施文档分块加载
- 使用GridFS存储大文档
- 前端虚拟滚动
- 提供分章节编辑模式

### 风险2：并发编辑冲突
**风险描述**: 多设备同时编辑导致内容冲突

**应对措施**:
- 实施乐观锁机制
- 版本号检查
- 冲突提示与合并
- 最后写入时间戳

### 风险3：自动保存失败
**风险描述**: 网络问题导致自动保存失败，内容丢失

**应对措施**:
- 前端本地缓存（LocalStorage）
- 保存失败重试机制
- 保存状态明确提示
- 离线编辑支持

---

## 里程碑检查点

| 里程碑 | 日期 | 检查内容 | 状态 |
|--------|------|----------|------|
| **项目管理完成** | 2025.10.14 | 项目CRUD、文档树功能 | ⏸️ 待开始 |
| **文档编辑器完成** | 2025.10.19 | 双编辑器、自动保存、版本控制 | ⏸️ 待开始 |
| **设定百科完成** | 2025.11.22 | 角色卡、世界观、模板系统 | ⏸️ 待开始 |
| **写作端MVP完成** | 2025.10.23 | 核心功能可用，可开始创作 | ⏸️ 待开始 |

---

## 相关文档

### 📚 设计文档
- [编辑器系统设计](../../design/writing/编辑器系统设计.md)
- [项目管理系统设计](../../design/writing/项目管理系统设计.md)
- [文档管理系统设计](../../design/writing/文档管理系统设计.md)
- [世界观设定管理设计](../../design/writing/世界观设定管理设计.md)
- [角色卡关系图设计](../../design/writing/角色卡_关系图设计.md)
- [写作端模块设计总览](../../design/writing/README_写作端模块设计文档.md)

### 📋 实施指南（NEW）
- [**实施总览与开发指南**](./实施总览_开发指南.md) ⭐ 必读
- [阶段1：项目管理模块实施指南](./阶段1_项目管理模块实施指南.md)
- [阶段2：文档编辑器实施指南](./阶段2_文档编辑器实施指南.md)
- [阶段3：设定百科系统实施指南](./阶段3_设定百科系统实施指南.md)

### 🔗 相关实施文档
- [整体实施规划](../青羽平台整体实施规划.md)
- [用户管理实施](../03用户管理模块/)

---

## 更新日志

### 2025-10-11
- 📄 创建写作端模块实施文档
- 📋 规划3个阶段、13个任务
- 📅 制定详细时间表（2025.10.10-11.22）

---

**文档版本**: v1.0  
**创建日期**: 2025年10月11日  
**最后更新**: 2025年10月11日  
**项目状态**: ⏸️ 待开始  
**预计开始**: 2025年10月10日  
**预计完成**: 2025年11月22日

