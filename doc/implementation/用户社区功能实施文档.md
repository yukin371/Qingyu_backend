# 用户社区功能实施文档

**版本**：v1.0  
**创建时间**：2025-10-26  
**最后更新**：2025-10-26

---

## 文档概述

本文档记录青羽平台用户社区功能的后端实施过程，包括已完成的工作、待完成的任务、遇到的问题及解决方案。

---

## 1. 项目背景

### 1.1 需求来源

为了完善青羽平台的用户体验，需要实现以下功能：
- 用户主页（作者主页、读者主页）
- 评论系统扩展（评论线程、热门评论）
- 用户作品展示

### 1.2 技术栈

- **语言**：Go 1.21+
- **框架**：Gin
- **数据库**：MongoDB
- **架构**：五层架构（Router → API → Service → Repository → Model）

---

## 2. 已完成工作

### 2.1 API层实现

#### 2.1.1 用户API（user_api.go）

**文件路径**：`api/v1/user/user_api.go`

**新增接口**：

1. **GetUserProfile** - 获取用户公开信息
```go
// 路由：GET /api/v1/users/:userId/profile
func (api *UserAPI) GetUserProfile(c *gin.Context) {
    userID := c.Param("userId")
    // ... 实现逻辑
}
```

**功能**：
- ✅ 路径参数验证
- ✅ 调用 UserService 获取用户信息
- ✅ 过滤敏感信息（只返回公开字段）
- ✅ 统一错误处理

2. **GetUserBooks** - 获取用户作品列表
```go
// 路由：GET /api/v1/users/:userId/books
func (api *UserAPI) GetUserBooks(c *gin.Context) {
    userID := c.Param("userId")
    page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
    size, _ := strconv.Atoi(c.DefaultQuery("size", "20"))
    // ... 实现逻辑
}
```

**功能**：
- ✅ 路径参数和查询参数验证
- ✅ 分页支持
- ✅ 临时返回模拟数据（待BookService实现）
- ⏳ TODO：集成 BookService

**Linter修复**：
- ✅ 修复了 `status` 变量未使用的警告
- 使用 `_ = c.Query("status")` 标记为预留参数

---

#### 2.1.2 评论API（comment_api.go）

**文件路径**：`api/v1/reader/comment_api.go`

**新增接口**：

1. **GetCommentThread** - 获取评论完整线程
```go
// 路由：GET /api/v1/reader/comments/:id/thread
func (api *CommentAPI) GetCommentThread(c *gin.Context) {
    commentID := c.Param("id")
    // 临时实现：返回评论详情
    comment, err := api.commentService.GetCommentDetail(...)
    // ... 实现逻辑
}
```

**状态**：
- ✅ API接口已定义
- ✅ Swagger文档注释已添加
- ⏳ 临时实现：返回评论详情
- ⏳ TODO：实现完整的树状结构查询

2. **GetTopComments** - 获取热门评论
```go
// 路由：GET /api/v1/reader/comments/top
func (api *CommentAPI) GetTopComments(c *gin.Context) {
    bookID := c.Query("book_id")
    limit, _ := strconv.Atoi(c.DefaultQuery("limit", "10"))
    // 临时实现：返回按热度排序的评论列表
    comments, total, err := api.commentService.GetCommentList(...)
    // ... 实现逻辑
}
```

**状态**：
- ✅ API接口已定义
- ✅ 限制最大返回数量（50条）
- ⏳ 临时实现：使用 GetCommentList 的 "hot" 排序
- ⏳ TODO：实现专门的热门评论算法

3. **GetCommentReplies** - 获取评论回复列表
```go
// 路由：GET /api/v1/reader/comments/:id/replies
func (api *CommentAPI) GetCommentReplies(c *gin.Context) {
    commentID := c.Param("id")
    page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
    size, _ := strconv.Atoi(c.DefaultQuery("size", "20"))
    // 临时实现：返回空列表
    shared.Success(c, http.StatusOK, "获取成功", gin.H{...})
}
```

**状态**：
- ✅ API接口已定义
- ✅ 分页参数处理
- ⏳ 临时实现：返回空列表（前端可正常渲染）
- ⏳ TODO：实现真实的回复查询逻辑

**Linter修复**：
- ✅ 修复了调用不存在方法的错误
- ✅ 添加了TODO注释说明需要在Service层实现
- ✅ 提供了临时实现确保API可用

---

### 2.2 DTO层实现

**文件路径**：`api/v1/user/user_dto.go`

**新增结构体**：

```go
// PublicUserProfileResponse 用户公开信息响应
type PublicUserProfileResponse struct {
    UserID    string    `json:"user_id"`
    Username  string    `json:"username"`
    Avatar    string    `json:"avatar,omitempty"`
    Nickname  string    `json:"nickname,omitempty"`
    Bio       string    `json:"bio,omitempty"`
    Role      string    `json:"role"`
    CreatedAt time.Time `json:"created_at"`
}

// UserBooksResponse 用户作品列表响应
type UserBooksResponse struct {
    Books []map[string]interface{} `json:"books"`
    Total int                      `json:"total"`
    Page  int                      `json:"page"`
    Size  int                      `json:"size"`
}
```

**设计原则**：
- 公开信息不包含敏感字段（email、phone等）
- 使用 `omitempty` 标签处理可选字段
- 分页响应包含完整的分页信息

---

### 2.3 Swagger文档

**已完成**：
- ✅ 所有新增接口都添加了Swagger注释
- ✅ 包含完整的参数说明
- ✅ 包含响应示例

**示例**：
```go
// GetUserProfile 获取用户公开信息（用于用户主页）
//
//  @Summary        获取用户公开信息
//  @Description    获取指定用户的公开信息，用于展示用户主页
//  @Tags           用户
//  @Accept         json
//  @Produce        json
//  @Param          userId  path        string  true    "用户ID"
//  @Success        200     {object}    shared.APIResponse{data=PublicUserProfileResponse}
//  @Failure        404     {object}    shared.ErrorResponse
//  @Failure        500     {object}    shared.ErrorResponse
//  @Router         /api/v1/users/{userId}/profile [get]
```

---

## 3. 待完成任务

### 3.1 Service层实现（高优先级）

#### 3.1.1 CommentService 扩展

**需要实现的方法**：

1. **GetCommentThread** - 获取评论线程
```go
func (s *CommentService) GetCommentThread(ctx context.Context, commentID string) (*CommentThread, error) {
    // 1. 获取主评论
    // 2. 递归查询所有子评论
    // 3. 构建树状结构
    // 4. 返回完整的线程
}
```

**技术方案**：
- 使用递归查询或CTE（Common Table Expression）
- 考虑限制最大深度（如3层）
- 添加缓存优化热门评论线程

2. **GetTopComments** - 获取热门评论
```go
func (s *CommentService) GetTopComments(ctx context.Context, bookID string, limit int) ([]*Comment, error) {
    // 1. 计算评论热度分数
    // 2. 按分数排序
    // 3. 返回top N评论
}
```

**热度计算公式**：
```
score = like_count * 2 + reply_count * 1 - time_decay
```

3. **GetCommentReplies** - 获取评论回复
```go
func (s *CommentService) GetCommentReplies(ctx context.Context, commentID string, page, size int) ([]*Comment, int64, error) {
    // 1. 查询直接回复（parent_id = commentID）
    // 2. 分页处理
    // 3. 返回结果和总数
}
```

**实施步骤**：
1. 在 `service/reading/comment_service.go` 中添加方法
2. 调用 Repository 层查询数据
3. 添加单元测试
4. 更新 API 层调用

**预计工时**：4-6小时

---

#### 3.1.2 BookService 扩展

**需要实现的方法**：

```go
func (s *BookService) GetBooksByAuthor(ctx context.Context, userID string, page, size int, status string) ([]*Book, int64, error) {
    // 1. 查询用户的书籍列表
    // 2. 筛选已发布的作品
    // 3. 分页返回
}
```

**实施步骤**：
1. 确认 BookService 是否存在
2. 添加方法实现
3. 在 UserAPI 中集成调用
4. 添加测试

**预计工时**：2-3小时

---

### 3.2 Repository层扩展（中优先级）

如果 CommentRepository 不支持所需的查询，需要添加：

```go
// 查询评论的所有子评论（递归）
func (r *CommentRepository) GetCommentChildren(ctx context.Context, parentID string) ([]*Comment, error)

// 查询热门评论
func (r *CommentRepository) GetTopComments(ctx context.Context, bookID string, limit int) ([]*Comment, error)

// 查询直接回复
func (r *CommentRepository) GetDirectReplies(ctx context.Context, parentID string, page, size int) ([]*Comment, int64, error)
```

**预计工时**：2-3小时

---

### 3.3 性能优化（中优先级）

#### 3.3.1 缓存策略

**Redis缓存方案**：

1. **用户公开信息缓存**
```go
key: "user:profile:{userId}"
ttl: 1小时
```

2. **热门评论缓存**
```go
key: "comments:top:{bookId}"
ttl: 5分钟
```

3. **评论线程缓存**
```go
key: "comment:thread:{commentId}"
ttl: 10分钟
```

**实施步骤**：
1. 集成 Redis 客户端
2. 在 Service 层添加缓存逻辑
3. 实现缓存失效策略
4. 监控缓存命中率

**预计工时**：3-4小时

---

#### 3.3.2 查询优化

**数据库索引**：
- `comments` 表：
  - `book_id + created_at`（查询书籍评论）
  - `parent_id + created_at`（查询回复）
  - `like_count + created_at`（热门评论）

**预计工时**：1小时

---

### 3.4 路由注册（高优先级）

**需要在路由文件中注册新接口**：

```go
// router/user_routes.go
func RegisterUserRoutes(router *gin.RouterGroup, userAPI *v1.UserAPI) {
    users := router.Group("/users")
    {
        // 公开接口（无需认证）
        users.GET("/:userId/profile", userAPI.GetUserProfile)
        users.GET("/:userId/books", userAPI.GetUserBooks)
    }
}

// router/reader_routes.go
func RegisterReaderRoutes(router *gin.RouterGroup, commentAPI *v1.CommentAPI) {
    comments := router.Group("/reader/comments")
    {
        // 公开接口
        comments.GET("/:id/thread", commentAPI.GetCommentThread)
        comments.GET("/top", commentAPI.GetTopComments)
        comments.GET("/:id/replies", commentAPI.GetCommentReplies)
    }
}
```

**实施步骤**：
1. 找到路由注册文件
2. 添加新路由
3. 测试路由是否生效

**预计工时**：0.5小时

---

## 4. 遇到的问题及解决方案

### 4.1 Linter错误

**问题1**：`status` 变量声明但未使用

**原因**：在 `GetUserBooks` 中声明了 status 参数，但临时实现中未使用。

**解决方案**：
```go
_ = c.Query("status") // 标记为预留参数
```

**问题2**：调用不存在的Service方法

**原因**：API层调用了尚未在 CommentService 中实现的方法：
- `GetCommentThread`
- `GetTopComments`
- `GetCommentReplies`

**解决方案**：
1. 添加TODO注释说明需要实现
2. 提供临时实现：
   - `GetCommentThread`：返回评论详情
   - `GetTopComments`：使用现有的 GetCommentList
   - `GetCommentReplies`：返回空列表
3. 确保API可用，不阻塞前端开发

---

### 4.2 数据结构设计

**问题**：用户作品列表的返回结构不统一

**解决方案**：
- 定义 `UserBooksResponse` DTO
- 使用 `[]map[string]interface{}` 作为临时方案
- 待 BookService 实现后，改用具体的 Book 结构体

---

### 4.3 性能考虑

**问题**：评论线程的递归查询可能导致性能问题

**解决方案**：
1. 限制最大递归深度（3层）
2. 使用缓存优化热门评论
3. 考虑使用MongoDB的聚合查询优化
4. 前端使用分页加载减轻服务器压力

---

## 5. 测试方案

### 5.1 单元测试

**测试文件**：`api/v1/user/user_api_test.go`

```go
func TestGetUserProfile(t *testing.T) {
    // 测试正常用户
    // 测试不存在的用户
    // 测试参数验证
}

func TestGetUserBooks(t *testing.T) {
    // 测试分页功能
    // 测试状态筛选
    // 测试空结果
}
```

**测试文件**：`api/v1/reader/comment_api_test.go`

```go
func TestGetCommentThread(t *testing.T) {
    // 测试获取评论线程
    // 测试不存在的评论
}

func TestGetTopComments(t *testing.T) {
    // 测试热门评论
    // 测试limit参数
}

func TestGetCommentReplies(t *testing.T) {
    // 测试回复列表
    // 测试分页
}
```

---

### 5.2 集成测试

**测试场景**：
1. 用户主页访问流程
2. 评论线程的完整查询
3. 热门评论的排序逻辑

**工具**：
- Postman Collection
- 自动化测试脚本

---

### 5.3 API测试示例

```bash
# 测试获取用户公开信息
curl -X GET "http://localhost:8080/api/v1/users/user123/profile"

# 测试获取用户作品列表
curl -X GET "http://localhost:8080/api/v1/users/user123/books?page=1&size=20"

# 测试获取评论线程
curl -X GET "http://localhost:8080/api/v1/reader/comments/comment123/thread"

# 测试获取热门评论
curl -X GET "http://localhost:8080/api/v1/reader/comments/top?book_id=book123&limit=10"

# 测试获取评论回复
curl -X GET "http://localhost:8080/api/v1/reader/comments/comment123/replies?page=1&size=20"
```

---

## 6. 部署清单

### 6.1 代码变更

- [x] `api/v1/user/user_api.go` - 新增2个接口
- [x] `api/v1/user/user_dto.go` - 新增2个DTO
- [x] `api/v1/reader/comment_api.go` - 新增3个接口
- [ ] `service/reading/comment_service.go` - 待添加3个方法
- [ ] `service/bookstore/book_service.go` - 待添加1个方法
- [ ] `router/user_routes.go` - 待注册路由
- [ ] `router/reader_routes.go` - 待注册路由

### 6.2 数据库变更

- [ ] 添加评论表索引（如需要）
- [ ] 验证数据完整性

### 6.3 配置变更

- [ ] Redis配置（如添加缓存）
- [ ] 更新Swagger文档

---

## 7. 时间估算

| 任务 | 预计工时 | 优先级 |
|------|----------|--------|
| CommentService 扩展 | 4-6小时 | 高 |
| BookService 扩展 | 2-3小时 | 高 |
| 路由注册 | 0.5小时 | 高 |
| Repository 扩展 | 2-3小时 | 中 |
| 缓存实现 | 3-4小时 | 中 |
| 单元测试 | 3-4小时 | 中 |
| 集成测试 | 2-3小时 | 低 |
| **总计** | **17-26.5小时** | - |

---

## 8. 风险评估

### 8.1 技术风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 递归查询性能问题 | 高 | 中 | 限制深度、添加缓存 |
| 缓存失效策略复杂 | 中 | 中 | 使用简单的TTL策略 |
| MongoDB聚合查询复杂 | 中 | 低 | 使用应用层递归查询 |

### 8.2 进度风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| Service层实现延迟 | 中 | 低 | 已提供临时实现，不阻塞前端 |
| 测试覆盖不足 | 低 | 中 | 优先完成核心功能测试 |

---

## 9. 下一步行动计划

### 9.1 短期计划（1周内）

1. **第1天**：实现 CommentService 的3个方法
2. **第2天**：实现 BookService 的 GetBooksByAuthor 方法
3. **第3天**：注册路由并进行API测试
4. **第4-5天**：添加单元测试和集成测试
5. **第6-7天**：性能测试和优化

### 9.2 中期计划（1月内）

1. 实现缓存优化
2. 添加监控和日志
3. 完善文档
4. 收集用户反馈并迭代

---

## 10. 附录

### 10.1 相关文档

- [API设计文档](./用户社区功能API设计文档.md)
- [架构设计规范](../architecture/架构设计规范.md)
- [数据库设计文档](../database/数据库设计.md)

### 10.2 参考资料

- [Gin框架文档](https://gin-gonic.com/docs/)
- [MongoDB Go Driver](https://www.mongodb.com/docs/drivers/go/current/)
- [Swagger注释规范](https://github.com/swaggo/swag)

---

**文档维护者**：青羽后端开发团队  
**最后更新时间**：2025-10-26  
**文档状态**：持续更新中

