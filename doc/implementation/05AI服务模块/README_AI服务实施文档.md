# AI服务模块实施文档

## 文档概述

本文档跟踪和记录青羽平台AI服务模块的完整实施过程，包括AI服务架构、智能续写、AI聊天、RAG检索、Agent工具调用等功能。

## 项目背景

### 目标
构建强大的AI服务体系，为写作端提供智能续写、改写、聊天等AI辅助功能，并实现RAG检索增强和Agent工具调用，打造平台核心竞争力。

### 实施范围

| 功能模块 | 优先级 | 状态 | 说明 |
|---------|-------|------|------|
| AI服务架构 | P0 | ✅ 已完成 | 统一接口、适配器模式、配额管理 |
| 智能续写 | P0 | ✅ 已完成 | 基于上文的内容续写 |
| 内容改写 | P0 | ✅ 已完成 | 扩写、缩写、润色 |
| AI聊天助手 | P0 | ✅ 已完成 | 对话管理、上下文维护 |
| RAG检索增强 | P1 | ⏸️ 待开始 | 私有知识库、语义检索 |
| Agent工具调用 | P1 | ⏸️ 待开始 | Function Calling、自动生成 |

---

## 实施阶段

### 阶段1：AI服务架构（预计3天，2025.10.24-10.26）✅

**整体进度**: 100% (3/3任务)  
**实际开始**: 2025年10月22日  
**实际完成**: 2025年10月22日  
**优先级**: P0  
**状态**: ✅ 已完成

#### 任务1.1：AI服务抽象层（1天）✅
- [x] AIService接口设计
  - [x] GenerateText（文本生成）
  - [x] StreamGenerateText（流式生成）
  - [x] GenerateEmbedding（向量化）
  - [x] ChatCompletion（对话补全）
  - [x] FunctionCall（函数调用）
- [x] 统一请求/响应格式
  - [x] AIRequest结构
  - [x] AIResponse结构
  - [x] StreamResponse结构
  - [x] 错误响应格式
- [x] 流式响应支持
  - [x] SSE（Server-Sent Events）
  - [x] 分块传输
  - [x] 错误处理
- [x] 配置管理
  - [x] AI提供商配置
  - [x] 模型参数配置
  - [x] 超时配置

**实际交付物**:
- ✅ AIService接口定义
- ✅ 统一数据结构
- ✅ 流式响应框架

**实际工作量**: 已完成（使用现有实现）

#### 任务1.2：OpenAI适配器（1天）✅
- [x] OpenAI客户端集成
  - [ ] 官方SDK集成
  - [ ] API Key配置
  - [ ] 模型选择（GPT-4/GPT-3.5）
- [ ] Chat Completion实现
  - [ ] 消息格式转换
  - [ ] 流式响应处理
  - [ ] Token计数
- [ ] Embedding实现
  - [ ] text-embedding-ada-002
  - [ ] 批量向量化
- [ ] 错误处理
  - [ ] 限流处理
  - [ ] 重试机制
  - [ ] 错误码映射

**预期交付物**:
- ✅ OpenAI适配器实现
- ✅ 流式响应功能
- ✅ 错误处理完善

**预计工作量**: 8小时

#### 任务1.3：配额管理系统（1天）
- [ ] UserQuota模型
  - [ ] 用户ID
  - [ ] 配额类型（日配额、月配额）
  - [ ] 已用配额
  - [ ] 总配额
  - [ ] 重置时间
- [ ] QuotaService实现
  - [ ] CheckQuota（配额检查）
  - [ ] ConsumeQuota（配额扣减）
  - [ ] RestoreQuota（配额恢复）
  - [ ] GetQuotaInfo（配额查询）
- [ ] 配额策略
  - [ ] 普通读者：5次/日
  - [ ] VIP读者：50次/日
  - [ ] 新手作者：10次/日
  - [ ] 签约作者：100次/日
  - [ ] 大神作者：无限
- [ ] 配额中间件
  - [ ] 请求前检查
  - [ ] 请求后扣减
  - [ ] 超额拦截

**预期交付物**:
- ✅ 配额管理系统
- ✅ 配额中间件
- ✅ 配额API

**预计工作量**: 8小时

**里程碑**: AI服务架构完成（2025.10.26）

---

### 阶段2：AI写作功能（预计4天，2025.10.27-10.30）

**整体进度**: 0% (0/4任务)  
**优先级**: P0

#### 任务2.1：智能续写（1天）
- [ ] 续写API设计
  - [ ] POST /api/ai/continue
  - [ ] 请求参数（文档ID、上下文长度）
  - [ ] 流式响应
- [ ] Prompt工程
  - [ ] 上下文提取（最近1000字）
  - [ ] Prompt模板设计
  - [ ] 风格保持策略
- [ ] 续写逻辑
  - [ ] 上下文构建
  - [ ] AI调用
  - [ ] 流式返回
  - [ ] Token计数与扣费
- [ ] 前端集成
  - [ ] 续写按钮
  - [ ] 流式显示
  - [ ] 结果插入
  - [ ] Loading状态

**预期交付物**:
- ✅ 智能续写API
- ✅ Prompt优化
- ✅ 前端续写功能

**预计工作量**: 8小时

#### 任务2.2：内容改写（1天）
- [ ] 改写API设计
  - [ ] POST /api/ai/rewrite
  - [ ] 改写模式（扩写、缩写、润色）
  - [ ] 支持选中文本改写
- [ ] 改写Prompt
  - [ ] 扩写Prompt（增加细节）
  - [ ] 缩写Prompt（保留核心）
  - [ ] 润色Prompt（优化表达）
- [ ] 改写逻辑
  - [ ] 原文内容提取
  - [ ] 模式选择
  - [ ] AI调用
  - [ ] 结果返回
- [ ] 前端集成
  - [ ] 选中文本菜单
  - [ ] 改写模式选择
  - [ ] 结果对比显示
  - [ ] 一键替换

**预期交付物**:
- ✅ 内容改写API
- ✅ 3种改写模式
- ✅ 前端改写功能

**预计工作量**: 8小时

#### 任务2.3：语法检查（0.5天）
- [ ] 语法检查API
  - [ ] POST /api/ai/check
  - [ ] 错误识别
  - [ ] 修改建议
- [ ] 检查逻辑
  - [ ] Prompt设计
  - [ ] 错误定位
  - [ ] 建议生成
- [ ] 前端集成
  - [ ] 错误高亮
  - [ ] 悬浮提示
  - [ ] 一键修正

**预期交付物**:
- ✅ 语法检查API
- ✅ 错误识别功能
- ✅ 前端检查界面

**预计工作量**: 4小时

#### 任务2.4：AI聊天助手（1.5天）
- [ ] 对话管理
  - [ ] Conversation模型
  - [ ] Message模型
  - [ ] 会话CRUD
- [ ] 聊天API
  - [ ] POST /api/ai/chat（发送消息）
  - [ ] GET /api/ai/conversations（会话列表）
  - [ ] DELETE /api/ai/conversations/:id（删除会话）
- [ ] 上下文管理
  - [ ] 消息历史维护
  - [ ] 上下文窗口限制
  - [ ] 上下文压缩
- [ ] 前端聊天界面
  - [ ] 聊天面板
  - [ ] 消息列表
  - [ ] 输入框
  - [ ] 流式显示
  - [ ] Markdown渲染

**预期交付物**:
- ✅ AI聊天助手完整功能
- ✅ 对话管理系统
- ✅ 聊天界面

**预计工作量**: 12小时

**里程碑**: AI写作功能完成（2025.10.30）

---

### 阶段3：RAG检索增强系统（预计3周，2025.11.23-12.13）

**整体进度**: 0% (0/3任务)  
**优先级**: P1

#### 任务3.1：向量数据库集成（1周）
- [ ] Milvus部署
  - [ ] Docker部署Milvus
  - [ ] 配置优化
  - [ ] 健康检查
- [ ] Go客户端集成
  - [ ] milvus-sdk-go集成
  - [ ] 连接池配置
  - [ ] 错误处理
- [ ] Collection设计
  - [ ] user_knowledge Collection
  - [ ] 字段设计（ID、向量、元数据）
  - [ ] 索引类型（HNSW）
- [ ] 基础操作
  - [ ] Insert（插入向量）
  - [ ] Search（向量检索）
  - [ ] Delete（删除向量）
  - [ ] Query（条件查询）

**预期交付物**:
- ✅ Milvus集成完成
- ✅ Collection创建
- ✅ 基础CRUD操作

**预计工作量**: 40小时

#### 任务3.2：内容索引（1周）
- [ ] Embedding Service
  - [ ] 调用OpenAI Embedding API
  - [ ] 批量向量化
  - [ ] 向量缓存
- [ ] 索引策略
  - [ ] 文档内容索引
  - [ ] 角色卡索引
  - [ ] 世界观设定索引
  - [ ] 增量索引更新
- [ ] 索引任务队列
  - [ ] 异步索引任务
  - [ ] 任务调度
  - [ ] 失败重试
- [ ] 索引管理
  - [ ] 索引状态跟踪
  - [ ] 索引更新触发
  - [ ] 索引清理

**预期交付物**:
- ✅ 内容索引系统
- ✅ 私有知识库
- ✅ 索引任务队列

**预计工作量**: 40小时

#### 任务3.3：语义检索与生成（1周）
- [ ] 检索API
  - [ ] POST /api/ai/search（语义检索）
  - [ ] 查询向量化
  - [ ] 相似度检索
  - [ ] 结果重排序
- [ ] 混合检索
  - [ ] 向量检索
  - [ ] 关键词检索
  - [ ] 结果融合
- [ ] RAG生成流程
  - [ ] 检索相关文档
  - [ ] 构建增强Prompt
  - [ ] LLM生成
  - [ ] 引用标注
- [ ] 前端检索界面
  - [ ] 检索输入框
  - [ ] 结果列表
  - [ ] 引用跳转
  - [ ] 相关度显示

**预期交付物**:
- ✅ 语义检索API
- ✅ RAG生成功能
- ✅ 检索界面

**预计工作量**: 40小时

**里程碑**: RAG检索增强完成（2025.12.13）

---

### 阶段4：AI Agent工具调用（预计3周，2025.12.14-01.03）

**整体进度**: 0% (0/3任务)  
**优先级**: P1

#### 任务4.1：Function Calling框架（1周）
- [ ] Tool接口定义
  - [ ] Tool结构（名称、描述、参数）
  - [ ] Execute方法
  - [ ] ValidateParams方法
- [ ] 工具注册机制
  - [ ] ToolRegistry
  - [ ] RegisterTool方法
  - [ ] GetTool方法
- [ ] Function Calling适配
  - [ ] OpenAI Function Calling
  - [ ] 工具描述转换
  - [ ] 参数提取
- [ ] 工具执行引擎
  - [ ] 工具调用解析
  - [ ] 参数验证
  - [ ] 工具执行
  - [ ] 结果返回

**预期交付物**:
- ✅ Tool接口与注册
- ✅ Function Calling适配
- ✅ 工具执行引擎

**预计工作量**: 40小时

#### 任务4.2：Agent工具开发（1周）
- [ ] 大纲生成工具
  - [ ] GenerateOutlineTool
  - [ ] 三幕式结构
  - [ ] 英雄之旅结构
  - [ ] 自动保存到项目
- [ ] 角色卡创建工具
  - [ ] CreateCharacterTool
  - [ ] 自动填充属性
  - [ ] 保存到设定百科
- [ ] 关系图谱生成工具
  - [ ] GenerateRelationshipTool
  - [ ] 关系提取
  - [ ] 图谱数据生成
- [ ] 设定生成工具
  - [ ] GenerateSettingTool
  - [ ] 世界观生成
  - [ ] 修炼体系生成

**预期交付物**:
- ✅ 4个Agent工具
- ✅ 工具完整实现
- ✅ 工具测试

**预计工作量**: 40小时

#### 任务4.3：前端Agent集成（1周）
- [ ] Agent对话界面增强
  - [ ] 工具调用可视化
  - [ ] 工具执行进度
  - [ ] 工具结果预览
- [ ] 结果确认与编辑
  - [ ] 大纲预览与编辑
  - [ ] 角色卡预览与编辑
  - [ ] 一键保存到项目
- [ ] 工具调用历史
  - [ ] 调用记录
  - [ ] 结果查看
  - [ ] 重新生成

**预期交付物**:
- ✅ Agent界面完善
- ✅ 工具结果管理
- ✅ 完整用户体验

**预计工作量**: 40小时

**里程碑**: AI Agent系统完成（2025.01.03）

---

## 总体进度概览

| 阶段 | 周数 | 任务数 | 完成 | 进度 | 预计完成日期 |
|------|------|--------|------|------|-------------|
| 阶段1：AI服务架构 | 0.6周 | 3 | 0 | 0% | 2025.10.26 |
| 阶段2：AI写作功能 | 0.8周 | 4 | 0 | 0% | 2025.10.30 |
| 阶段3：RAG检索增强 | 3周 | 3 | 0 | 0% | 2025.12.13 |
| 阶段4：Agent工具调用 | 3周 | 3 | 0 | 0% | 2025.01.03 |
| **总计** | **7.4周** | **13** | **0** | **0%** | **2025.01.03** |

**总预计工作量**: 296小时

---

## 技术栈

### AI技术
- **OpenAI**: GPT-4、GPT-3.5-turbo
- **Anthropic Claude**: 备用模型
- **Embedding**: text-embedding-ada-002
- **Milvus**: 向量数据库

### 后端技术
- **Go**: 1.21+
- **Gin**: Web框架
- **MongoDB**: 数据存储
- **Redis**: 配额管理、缓存
- **RabbitMQ**: 索引任务队列（可选）

### 前端技术
- **Vue 3**: 前端框架
- **SSE**: 流式响应
- **Markdown-it**: Markdown渲染

---

## 项目结构

### 后端结构
```
Qingyu_backend/
├── models/
│   └── ai/
│       ├── conversation.go      # 对话模型
│       ├── message.go           # 消息模型
│       ├── user_quota.go        # 配额模型
│       └── tool_call.go         # 工具调用记录
├── service/
│   └── ai/
│       ├── ai_service.go        # AI服务接口
│       ├── openai_adapter.go    # OpenAI适配器
│       ├── quota_service.go     # 配额管理
│       ├── conversation_service.go # 对话管理
│       ├── embedding_service.go # 向量化服务
│       ├── rag_service.go       # RAG服务
│       └── agent_service.go     # Agent服务
├── pkg/
│   ├── ai/
│   │   ├── client.go            # AI客户端
│   │   ├── stream.go            # 流式响应
│   │   └── prompt.go            # Prompt模板
│   ├── vector/
│   │   ├── milvus.go            # Milvus客户端
│   │   └── search.go            # 向量检索
│   └── agent/
│       ├── tool.go              # 工具接口
│       ├── registry.go          # 工具注册
│       └── executor.go          # 工具执行
├── api/v1/
│   └── ai/
│       ├── continue_api.go      # 续写API
│       ├── rewrite_api.go       # 改写API
│       ├── chat_api.go          # 聊天API
│       ├── rag_api.go           # RAG API
│       └── agent_api.go         # Agent API
└── tools/
    ├── outline_tool.go          # 大纲生成工具
    ├── character_tool.go        # 角色卡工具
    ├── relationship_tool.go     # 关系图谱工具
    └── setting_tool.go          # 设定生成工具
```

### 前端结构
```
Qingyu/
├── src/
│   ├── views/
│   │   └── ai/
│   │       ├── Chat.vue         # AI聊天界面
│   │       └── Agent.vue        # Agent界面
│   ├── components/
│   │   └── ai/
│   │       ├── MessageList.vue  # 消息列表
│   │       ├── InputBox.vue     # 输入框
│   │       ├── StreamText.vue   # 流式文本显示
│   │       └── ToolResult.vue   # 工具结果显示
│   └── stores/
│       └── ai.js                # AI状态管理
```

---

## 质量标准

### 功能标准
- [ ] 续写内容与上文风格一致
- [ ] 流式响应流畅无卡顿
- [ ] RAG检索准确率>85%
- [ ] Agent工具调用成功率>95%

### 性能标准
- [ ] AI首字响应：<500ms
- [ ] 流式生成速度：>10字/秒
- [ ] 向量检索：P95<100ms
- [ ] 工具执行：<3秒

### 成本标准
- [ ] 续写成本：<0.01元/次
- [ ] 对话成本：<0.005元/轮
- [ ] 日均AI成本：<50元

---

## 风险与应对

### 风险1：AI成本过高
**风险描述**: 免费额度或普惠策略导致AI成本失控

**应对措施**:
- 严格配额管理
- 优先使用GPT-3.5
- 实施Prompt缓存
- 监控每日成本，及时预警

### 风险2：API限流
**风险描述**: OpenAI API限流导致服务不可用

**应对措施**:
- 实施请求队列
- 多账号轮询
- 集成备用AI提供商（Claude）
- 降级策略（关闭AI功能）

### 风险3：向量检索性能
**风险描述**: 用户增长后，向量检索延迟上升

**应对措施**:
- 用户数据隔离（分Collection）
- HNSW索引优化
- 检索结果缓存
- Milvus集群部署

### 风险4：RAG准确性
**风险描述**: RAG检索不准，生成内容与设定矛盾

**应对措施**:
- 优化Embedding模型
- 改进检索算法
- 结果重排序
- 人工标注训练数据

---

## 成本估算

### OpenAI API成本（月）

| 场景 | 模型 | 单价 | 月调用量 | 月成本 |
|------|------|------|---------|--------|
| 续写 | GPT-3.5 | $0.002/1K tokens | 100K次×500 tokens | $100 |
| 改写 | GPT-3.5 | $0.002/1K tokens | 50K次×300 tokens | $30 |
| 聊天 | GPT-3.5 | $0.002/1K tokens | 200K轮×200 tokens | $80 |
| Embedding | ada-002 | $0.0001/1K tokens | 1M次×500 tokens | $50 |
| **合计** | - | - | - | **$260 (≈¥1,900)** |

### Milvus成本（月）
- 云服务器（8核16G）：¥500
- 存储（100GB SSD）：¥100
- **合计**: ¥600

**总计**: 约¥2,500/月

---

## 里程碑检查点

| 里程碑 | 日期 | 检查内容 | 状态 |
|--------|------|----------|------|
| **AI服务架构完成** | 2025.10.26 | 接口定义、适配器、配额管理 | ⏸️ 待开始 |
| **AI写作功能完成** | 2025.10.30 | 续写、改写、聊天功能 | ⏸️ 待开始 |
| **MVP AI功能上线** | 2025.11.01 | 核心AI功能可用 | ⏸️ 待开始 |
| **RAG系统完成** | 2025.12.13 | 向量库、索引、检索 | ⏸️ 待开始 |
| **Agent系统完成** | 2025.01.03 | 工具调用、自动生成 | ⏸️ 待开始 |

---

## 相关文档

### 设计文档
- [AI服务架构设计](../../design/ai/01.AI服务架构设计.md)
- [AI功能总体设计](../../design/ai/02.AI功能总体设计.md)
- [AI智能辅助系统](../../design/writer/AI智能辅助系统.md)

### 实施文档
- [整体实施规划](../青羽平台整体实施规划.md)
- [写作端实施](../04写作端模块/)

---

## 更新日志

### 2025-10-11
- 📄 创建AI服务模块实施文档
- 📋 规划4个阶段、13个任务
- 📅 制定详细时间表（2025.10.24-2026.01.03）
- 💰 成本估算与控制策略

---

**文档版本**: v1.0  
**创建日期**: 2025年10月11日  
**最后更新**: 2025年10月11日  
**项目状态**: ⏸️ 待开始  
**预计开始**: 2025年10月24日  
**预计完成**: 2025年1月3日

