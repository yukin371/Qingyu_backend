# ä¹¦åŸç³»ç»Ÿä½¿ç”¨æŒ‡å—

> **é¢å‘å¯¹è±¡**: å‰ç«¯å¼€å‘è€…ã€æµ‹è¯•äººå‘˜ã€äº§å“ç»ç†  
> **éš¾åº¦çº§åˆ«**: â­â­  
> **é¢„è®¡é˜…è¯»æ—¶é—´**: 20åˆ†é’Ÿ

## ğŸ“‹ ç›®å½•

1. [å¿«é€Ÿå¼€å§‹](#1-å¿«é€Ÿå¼€å§‹)
2. [æ ¸å¿ƒåŠŸèƒ½ä½¿ç”¨](#2-æ ¸å¿ƒåŠŸèƒ½ä½¿ç”¨)
3. [é«˜çº§åŠŸèƒ½](#3-é«˜çº§åŠŸèƒ½)
4. [æœ€ä½³å®è·µ](#4-æœ€ä½³å®è·µ)
5. [å¸¸è§é—®é¢˜](#5-å¸¸è§é—®é¢˜)
6. [æ•…éšœæ’æŸ¥](#6-æ•…éšœæ’æŸ¥)

## 1. å¿«é€Ÿå¼€å§‹

### 1.1 ç¯å¢ƒå‡†å¤‡

**åç«¯ç¯å¢ƒ**:
- Go 1.21+
- MongoDB 5.0+
- Redis 6.0+

**å‰ç«¯ç¯å¢ƒ**:
- ä»»ä½•æ”¯æŒHTTPè¯·æ±‚çš„ç¯å¢ƒ
- å»ºè®®ä½¿ç”¨axiosæˆ–fetch

### 1.2 ç¬¬ä¸€ä¸ªè¯·æ±‚

æœ€ç®€å•çš„è¯·æ±‚ - è·å–é¦–é¡µæ•°æ®ï¼š

```javascript
// ä½¿ç”¨fetch
fetch('http://api.example.com/api/v1/bookstore/homepage')
  .then(response => response.json())
  .then(data => {
    console.log('é¦–é¡µæ•°æ®:', data);
  })
  .catch(error => {
    console.error('è¯·æ±‚å¤±è´¥:', error);
  });
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "banners": [...],
    "recommendedBooks": [...],
    "featuredBooks": [...],
    "categories": [...]
  }
}
```

### 1.3 åŸºç¡€é…ç½®

```javascript
// æ¨èçš„APIå®¢æˆ·ç«¯é…ç½®
const bookstoreClient = {
  baseURL: 'http://api.example.com/api/v1/bookstore',
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json'
  }
};

// ä½¿ç”¨axiosçš„ç¤ºä¾‹
import axios from 'axios';

const api = axios.create(bookstoreClient);

// æ·»åŠ è¯·æ±‚æ‹¦æˆªå™¨
api.interceptors.request.use(config => {
  // æ·»åŠ tokenï¼ˆå¦‚æœæœ‰ï¼‰
  const token = localStorage.getItem('token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// æ·»åŠ å“åº”æ‹¦æˆªå™¨
api.interceptors.response.use(
  response => response.data,
  error => {
    console.error('APIé”™è¯¯:', error);
    return Promise.reject(error);
  }
);
```

## 2. æ ¸å¿ƒåŠŸèƒ½ä½¿ç”¨

### 2.1 é¦–é¡µå±•ç¤º

#### åœºæ™¯ï¼šå±•ç¤ºä¹¦åŸé¦–é¡µ

```javascript
class BookstoreHomepage {
  constructor() {
    this.api = api;
  }
  
  // åŠ è½½é¦–é¡µæ•°æ®
  async loadHomepage() {
    try {
      const data = await this.api.get('/homepage');
      
      // æ¸²æŸ“Banner
      this.renderBanners(data.banners);
      
      // æ¸²æŸ“æ¨èä¹¦ç±
      this.renderBooks('recommended', data.recommendedBooks);
      
      // æ¸²æŸ“ç²¾é€‰ä¹¦ç±
      this.renderBooks('featured', data.featuredBooks);
      
      // æ¸²æŸ“åˆ†ç±»
      this.renderCategories(data.categories);
      
      // æ˜¾ç¤ºç»Ÿè®¡
      this.showStats(data.stats);
      
    } catch (error) {
      this.showError('åŠ è½½é¦–é¡µå¤±è´¥');
    }
  }
  
  // æ¸²æŸ“Banner
  renderBanners(banners) {
    const container = document.getElementById('banner-carousel');
    container.innerHTML = banners.map(banner => `
      <div class="banner-item" onclick="handleBannerClick('${banner.id}', '${banner.targetType}', '${banner.target}')">
        <img src="${banner.image}" alt="${banner.title}">
        <div class="banner-title">${banner.title}</div>
        <div class="banner-desc">${banner.description}</div>
      </div>
    `).join('');
  }
  
  // æ¸²æŸ“ä¹¦ç±åˆ—è¡¨
  renderBooks(section, books) {
    const container = document.getElementById(`${section}-books`);
    container.innerHTML = books.map(book => `
      <div class="book-card" onclick="viewBook('${book.id}')">
        <img class="book-cover" src="${book.cover}" alt="${book.title}">
        <h3 class="book-title">${book.title}</h3>
        <p class="book-author">${book.author}</p>
        <div class="book-stats">
          <span class="rating">â­ ${book.rating}</span>
          <span class="views">ğŸ‘ï¸ ${formatNumber(book.viewCount)}</span>
        </div>
      </div>
    `).join('');
  }
}

// ä½¿ç”¨
const homepage = new BookstoreHomepage();
homepage.loadHomepage();
```

### 2.2 ä¹¦ç±è¯¦æƒ…

#### åœºæ™¯ï¼šæŸ¥çœ‹ä¹¦ç±è¯¦æƒ…

```javascript
class BookDetail {
  constructor(bookId) {
    this.bookId = bookId;
    this.api = api;
  }
  
  // åŠ è½½ä¹¦ç±è¯¦æƒ…
  async loadBookDetail() {
    try {
      const book = await this.api.get(`/books/${this.bookId}`);
      
      // æ¸²æŸ“ä¹¦ç±ä¿¡æ¯
      this.renderBookInfo(book);
      
      // è®°å½•æµè§ˆ
      this.recordView();
      
      // åŠ è½½æ¨èä¹¦ç±
      this.loadRecommendations();
      
    } catch (error) {
      if (error.response && error.response.status === 404) {
        this.showError('ä¹¦ç±ä¸å­˜åœ¨');
      } else {
        this.showError('åŠ è½½å¤±è´¥');
      }
    }
  }
  
  // æ¸²æŸ“ä¹¦ç±ä¿¡æ¯
  renderBookInfo(book) {
    document.getElementById('book-detail').innerHTML = `
      <div class="book-detail-container">
        <div class="book-cover-section">
          <img src="${book.cover}" alt="${book.title}">
          <div class="book-actions">
            <button onclick="startReading('${book.id}')">å¼€å§‹é˜…è¯»</button>
            <button onclick="addToShelf('${book.id}')">åŠ å…¥ä¹¦æ¶</button>
          </div>
        </div>
        
        <div class="book-info-section">
          <h1>${book.title}</h1>
          <p class="author">ä½œè€…ï¼š${book.author}</p>
          
          <div class="book-meta">
            <span class="rating">â­ ${book.rating} (${book.ratingCount}äººè¯„åˆ†)</span>
            <span class="views">ğŸ‘ï¸ ${formatNumber(book.viewCount)} é˜…è¯»</span>
            <span class="likes">ğŸ‘ ${formatNumber(book.likeCount)} ç‚¹èµ</span>
          </div>
          
          <div class="book-tags">
            ${book.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
          </div>
          
          <div class="book-stats">
            <span>${formatNumber(book.wordCount)} å­—</span>
            <span>${book.chapterCount} ç« èŠ‚</span>
            <span>${book.status === 'published' ? 'è¿è½½ä¸­' : 'è‰ç¨¿'}</span>
          </div>
          
          <div class="book-intro">
            <h3>ä½œå“ç®€ä»‹</h3>
            <p>${book.introduction}</p>
          </div>
        </div>
      </div>
    `;
  }
  
  // è®°å½•æµè§ˆ
  async recordView() {
    try {
      await this.api.post(`/books/${this.bookId}/view`);
    } catch (error) {
      // æµè§ˆè®°å½•å¤±è´¥ä¸å½±å“ç”¨æˆ·ä½“éªŒ
      console.error('è®°å½•æµè§ˆå¤±è´¥:', error);
    }
  }
  
  // åŠ è½½æ¨èä¹¦ç±
  async loadRecommendations() {
    try {
      const { books } = await this.api.get('/books/recommended', {
        params: { limit: 6 }
      });
      this.renderRecommendations(books);
    } catch (error) {
      console.error('åŠ è½½æ¨èå¤±è´¥:', error);
    }
  }
}

// ä½¿ç”¨
const bookDetail = new BookDetail('65f1234567890abcdef12346');
bookDetail.loadBookDetail();
```

### 2.3 ä¹¦ç±æœç´¢

#### åœºæ™¯ï¼šæœç´¢ä¹¦ç±

```javascript
class BookSearch {
  constructor() {
    this.api = api;
    this.currentPage = 1;
    this.pageSize = 20;
  }
  
  // æœç´¢ä¹¦ç±
  async search(keyword, filters = {}) {
    try {
      const params = {
        keyword: keyword,
        page: this.currentPage,
        size: this.pageSize,
        ...filters
      };
      
      const result = await this.api.post('/books/search', params);
      
      this.renderResults(result);
      this.renderPagination(result.total, result.page, result.size);
      
    } catch (error) {
      this.showError('æœç´¢å¤±è´¥');
    }
  }
  
  // é«˜çº§æœç´¢
  async advancedSearch(filters) {
    const {
      keyword,
      categoryIds,
      author,
      tags,
      minRating,
      sortBy,
      sortOrder
    } = filters;
    
    try {
      const result = await this.api.post('/books/search', {
        keyword,
        categoryIds,
        author,
        tags,
        minRating,
        sortBy: sortBy || 'viewCount',
        sortOrder: sortOrder || 'desc',
        page: this.currentPage,
        size: this.pageSize
      });
      
      this.renderResults(result);
      
    } catch (error) {
      this.showError('æœç´¢å¤±è´¥');
    }
  }
  
  // æ¸²æŸ“æœç´¢ç»“æœ
  renderResults(result) {
    const container = document.getElementById('search-results');
    
    if (result.books.length === 0) {
      container.innerHTML = '<div class="no-results">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ä¹¦ç±</div>';
      return;
    }
    
    container.innerHTML = `
      <div class="search-summary">
        æ‰¾åˆ° ${result.total} æœ¬ç›¸å…³ä¹¦ç±
      </div>
      <div class="book-list">
        ${result.books.map(book => this.renderBookItem(book)).join('')}
      </div>
    `;
  }
  
  // æ¸²æŸ“å•ä¸ªä¹¦ç±é¡¹
  renderBookItem(book) {
    return `
      <div class="book-item" onclick="viewBook('${book.id}')">
        <img class="book-cover" src="${book.cover}" alt="${book.title}">
        <div class="book-info">
          <h3>${book.title}</h3>
          <p class="author">${book.author}</p>
          <p class="intro">${book.introduction.substring(0, 100)}...</p>
          <div class="book-meta">
            <span class="rating">â­ ${book.rating}</span>
            <span class="views">ğŸ‘ï¸ ${formatNumber(book.viewCount)}</span>
            <span class="chapters">${book.chapterCount}ç« </span>
          </div>
        </div>
      </div>
    `;
  }
}

// ä½¿ç”¨
const search = new BookSearch();

// ç®€å•æœç´¢
search.search('ä¿®çœŸ');

// é«˜çº§æœç´¢
search.advancedSearch({
  keyword: 'ä¿®çœŸ',
  categoryIds: ['65f1234567890abcdef12347'],
  minRating: 4.0,
  sortBy: 'rating',
  sortOrder: 'desc'
});
```

### 2.4 åˆ†ç±»æµè§ˆ

#### åœºæ™¯ï¼šæŒ‰åˆ†ç±»æµè§ˆä¹¦ç±

```javascript
class CategoryBrowser {
  constructor() {
    this.api = api;
  }
  
  // åŠ è½½åˆ†ç±»æ ‘
  async loadCategoryTree() {
    try {
      const { tree } = await this.api.get('/categories/tree');
      this.renderCategoryTree(tree);
    } catch (error) {
      this.showError('åŠ è½½åˆ†ç±»å¤±è´¥');
    }
  }
  
  // æ¸²æŸ“åˆ†ç±»æ ‘
  renderCategoryTree(tree) {
    const container = document.getElementById('category-tree');
    container.innerHTML = this.buildCategoryHTML(tree);
  }
  
  // æ„å»ºåˆ†ç±»HTML
  buildCategoryHTML(categories, level = 0) {
    return categories.map(category => `
      <div class="category-item level-${level}">
        <div class="category-header" onclick="toggleCategory('${category.id}')">
          <span class="category-name">${category.name}</span>
          <span class="book-count">${category.bookCount}æœ¬</span>
          ${category.children.length > 0 ? '<span class="toggle-icon">â–¼</span>' : ''}
        </div>
        ${category.children.length > 0 ? `
          <div class="category-children" id="children-${category.id}">
            ${this.buildCategoryHTML(category.children, level + 1)}
          </div>
        ` : ''}
      </div>
    `).join('');
  }
  
  // åŠ è½½åˆ†ç±»ä¸‹çš„ä¹¦ç±
  async loadCategoryBooks(categoryId, page = 1, size = 20) {
    try {
      const result = await this.api.get(`/categories/${categoryId}/books`, {
        params: { page, size }
      });
      
      this.renderCategoryBooks(result);
      
    } catch (error) {
      this.showError('åŠ è½½ä¹¦ç±å¤±è´¥');
    }
  }
  
  // æ¸²æŸ“åˆ†ç±»ä¹¦ç±
  renderCategoryBooks(result) {
    const container = document.getElementById('category-books');
    
    container.innerHTML = `
      <div class="category-info">
        <h2>${result.category.name}</h2>
        <p>å…± ${result.total} æœ¬ä¹¦ç±</p>
      </div>
      <div class="book-grid">
        ${result.books.map(book => this.renderBookCard(book)).join('')}
      </div>
      <div class="pagination">
        ${this.renderPagination(result.total, result.page, result.size)}
      </div>
    `;
  }
}

// ä½¿ç”¨
const browser = new CategoryBrowser();
browser.loadCategoryTree();
browser.loadCategoryBooks('65f1234567890abcdef12347');
```

## 3. é«˜çº§åŠŸèƒ½

### 3.1 å®æ—¶æ›´æ–°

ä½¿ç”¨WebSocketæˆ–è½®è¯¢å®ç°å®æ—¶æ›´æ–°ï¼š

```javascript
class RealtimeBookstore {
  constructor() {
    this.api = api;
    this.updateInterval = 30000; // 30ç§’æ›´æ–°ä¸€æ¬¡
  }
  
  // å¯åŠ¨å®æ—¶æ›´æ–°
  startRealtimeUpdates() {
    // ç«‹å³æ›´æ–°ä¸€æ¬¡
    this.updateHotBooks();
    
    // å®šæ—¶æ›´æ–°
    this.intervalId = setInterval(() => {
      this.updateHotBooks();
    }, this.updateInterval);
  }
  
  // åœæ­¢å®æ—¶æ›´æ–°
  stopRealtimeUpdates() {
    if (this.intervalId) {
      clearInterval(this.intervalId);
    }
  }
  
  // æ›´æ–°çƒ­é—¨ä¹¦ç±
  async updateHotBooks() {
    try {
      const { books } = await this.api.get('/books/hot', {
        params: { limit: 10 }
      });
      
      this.updateHotBooksList(books);
      
    } catch (error) {
      console.error('æ›´æ–°çƒ­é—¨ä¹¦ç±å¤±è´¥:', error);
    }
  }
  
  // æ›´æ–°çƒ­é—¨ä¹¦ç±åˆ—è¡¨
  updateHotBooksList(books) {
    const container = document.getElementById('hot-books');
    
    // ä½¿ç”¨æ·¡å…¥æ·¡å‡ºåŠ¨ç”»
    container.style.opacity = '0';
    
    setTimeout(() => {
      container.innerHTML = books.map((book, index) => `
        <div class="hot-book-item" data-rank="${index + 1}">
          <span class="rank">${index + 1}</span>
          <img src="${book.cover}" alt="${book.title}">
          <div class="book-info">
            <h4>${book.title}</h4>
            <p>${book.author}</p>
          </div>
          <div class="hot-indicator">ğŸ”¥ ${formatNumber(book.viewCount)}</div>
        </div>
      `).join('');
      
      container.style.opacity = '1';
    }, 300);
  }
}

// ä½¿ç”¨
const realtime = new RealtimeBookstore();
realtime.startRealtimeUpdates();

// é¡µé¢å¸è½½æ—¶åœæ­¢
window.addEventListener('beforeunload', () => {
  realtime.stopRealtimeUpdates();
});
```

### 3.2 ç¼“å­˜ç­–ç•¥

å‰ç«¯ç¼“å­˜ç­–ç•¥ç¤ºä¾‹ï¼š

```javascript
class BookstoreCache {
  constructor() {
    this.cache = new Map();
    this.ttl = 5 * 60 * 1000; // 5åˆ†é’ŸTTL
  }
  
  // è·å–ç¼“å­˜
  get(key) {
    const item = this.cache.get(key);
    
    if (!item) {
      return null;
    }
    
    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    if (Date.now() > item.expiry) {
      this.cache.delete(key);
      return null;
    }
    
    return item.data;
  }
  
  // è®¾ç½®ç¼“å­˜
  set(key, data, ttl = this.ttl) {
    this.cache.set(key, {
      data: data,
      expiry: Date.now() + ttl
    });
  }
  
  // æ¸…é™¤ç¼“å­˜
  clear() {
    this.cache.clear();
  }
}

// å¸¦ç¼“å­˜çš„APIå®¢æˆ·ç«¯
class CachedBookstoreAPI {
  constructor() {
    this.api = api;
    this.cache = new BookstoreCache();
  }
  
  // è·å–é¦–é¡µï¼ˆå¸¦ç¼“å­˜ï¼‰
  async getHomepage() {
    const cacheKey = 'homepage';
    const cached = this.cache.get(cacheKey);
    
    if (cached) {
      return cached;
    }
    
    const data = await this.api.get('/homepage');
    this.cache.set(cacheKey, data);
    
    return data;
  }
  
  // è·å–ä¹¦ç±è¯¦æƒ…ï¼ˆå¸¦ç¼“å­˜ï¼‰
  async getBook(bookId) {
    const cacheKey = `book:${bookId}`;
    const cached = this.cache.get(cacheKey);
    
    if (cached) {
      return cached;
    }
    
    const data = await this.api.get(`/books/${bookId}`);
    this.cache.set(cacheKey, data, 10 * 60 * 1000); // ä¹¦ç±è¯¦æƒ…ç¼“å­˜10åˆ†é’Ÿ
    
    return data;
  }
}
```

### 3.3 æ€§èƒ½ä¼˜åŒ–

å›¾ç‰‡æ‡’åŠ è½½å’Œåˆ—è¡¨è™šæ‹ŸåŒ–ï¼š

```javascript
class OptimizedBookList {
  constructor() {
    this.observer = null;
    this.initLazyLoad();
  }
  
  // åˆå§‹åŒ–å›¾ç‰‡æ‡’åŠ è½½
  initLazyLoad() {
    this.observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          img.src = img.dataset.src;
          img.classList.add('loaded');
          this.observer.unobserve(img);
        }
      });
    }, {
      rootMargin: '50px'
    });
  }
  
  // æ¸²æŸ“ä¹¦ç±åˆ—è¡¨ï¼ˆä½¿ç”¨æ‡’åŠ è½½ï¼‰
  renderBooks(books) {
    const html = books.map(book => `
      <div class="book-card">
        <img 
          class="book-cover lazy" 
          data-src="${book.cover}" 
          alt="${book.title}"
          src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 280'%3E%3Crect fill='%23ddd' width='200' height='280'/%3E%3C/svg%3E"
        >
        <h3>${book.title}</h3>
        <p>${book.author}</p>
      </div>
    `).join('');
    
    document.getElementById('book-list').innerHTML = html;
    
    // è§‚å¯Ÿæ‰€æœ‰æ‡’åŠ è½½å›¾ç‰‡
    document.querySelectorAll('.lazy').forEach(img => {
      this.observer.observe(img);
    });
  }
  
  // è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¤§åˆ—è¡¨ä¼˜åŒ–ï¼‰
  virtualScroll(books, itemHeight = 200) {
    const container = document.getElementById('book-list');
    const viewport = document.getElementById('viewport');
    
    let scrollTop = 0;
    let startIndex = 0;
    let endIndex = 0;
    
    const visibleCount = Math.ceil(viewport.clientHeight / itemHeight);
    const bufferCount = 5;
    
    function render() {
      startIndex = Math.max(0, Math.floor(scrollTop / itemHeight) - bufferCount);
      endIndex = Math.min(books.length, startIndex + visibleCount + bufferCount * 2);
      
      const visibleBooks = books.slice(startIndex, endIndex);
      const offsetY = startIndex * itemHeight;
      
      container.style.transform = `translateY(${offsetY}px)`;
      container.innerHTML = visibleBooks.map((book, index) => 
        this.renderBookItem(book, startIndex + index)
      ).join('');
    }
    
    viewport.addEventListener('scroll', () => {
      scrollTop = viewport.scrollTop;
      requestAnimationFrame(render);
    });
    
    render();
  }
}
```

## 4. æœ€ä½³å®è·µ

### 4.1 é”™è¯¯å¤„ç†

```javascript
class ErrorHandler {
  // ç»Ÿä¸€é”™è¯¯å¤„ç†
  static handle(error, context) {
    // è®°å½•é”™è¯¯
    console.error(`[${context}] é”™è¯¯:`, error);
    
    // æ ¹æ®é”™è¯¯ç±»å‹å¤„ç†
    if (error.response) {
      // HTTPé”™è¯¯
      switch (error.response.status) {
        case 400:
          this.showMessage('è¯·æ±‚å‚æ•°é”™è¯¯', 'warning');
          break;
        case 401:
          this.showMessage('è¯·å…ˆç™»å½•', 'warning');
          this.redirectToLogin();
          break;
        case 404:
          this.showMessage('èµ„æºä¸å­˜åœ¨', 'error');
          break;
        case 500:
          this.showMessage('æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
          break;
        default:
          this.showMessage('è¯·æ±‚å¤±è´¥', 'error');
      }
    } else if (error.request) {
      // ç½‘ç»œé”™è¯¯
      this.showMessage('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
    } else {
      // å…¶ä»–é”™è¯¯
      this.showMessage('æ“ä½œå¤±è´¥', 'error');
    }
  }
  
  // æ˜¾ç¤ºæ¶ˆæ¯
  static showMessage(message, type) {
    // å®ç°æ¶ˆæ¯æç¤ºUI
    console.log(`[${type}] ${message}`);
  }
  
  // é‡å®šå‘åˆ°ç™»å½•é¡µ
  static redirectToLogin() {
    window.location.href = '/login';
  }
}

// ä½¿ç”¨
try {
  const data = await api.get('/books/123');
} catch (error) {
  ErrorHandler.handle(error, 'getBookDetail');
}
```

### 4.2 æ•°æ®æ ¼å¼åŒ–

```javascript
class DataFormatter {
  // æ ¼å¼åŒ–æ•°å­—
  static formatNumber(num) {
    if (num >= 100000000) {
      return (num / 100000000).toFixed(1) + 'äº¿';
    } else if (num >= 10000) {
      return (num / 10000).toFixed(1) + 'ä¸‡';
    }
    return num.toString();
  }
  
  // æ ¼å¼åŒ–æ—¶é—´
  static formatTime(date) {
    const now = new Date();
    const target = new Date(date);
    const diff = now - target;
    
    const minute = 60 * 1000;
    const hour = 60 * minute;
    const day = 24 * hour;
    
    if (diff < minute) {
      return 'åˆšåˆš';
    } else if (diff < hour) {
      return Math.floor(diff / minute) + 'åˆ†é’Ÿå‰';
    } else if (diff < day) {
      return Math.floor(diff / hour) + 'å°æ—¶å‰';
    } else if (diff < 7 * day) {
      return Math.floor(diff / day) + 'å¤©å‰';
    } else {
      return target.toLocaleDateString();
    }
  }
  
  // æˆªæ–­æ–‡æœ¬
  static truncateText(text, maxLength) {
    if (text.length <= maxLength) {
      return text;
    }
    return text.substring(0, maxLength) + '...';
  }
}
```

### 4.3 çŠ¶æ€ç®¡ç†

```javascript
// ä½¿ç”¨ç®€å•çš„çŠ¶æ€ç®¡ç†
class BookstoreStore {
  constructor() {
    this.state = {
      books: [],
      categories: [],
      currentBook: null,
      loading: false,
      error: null
    };
    
    this.listeners = [];
  }
  
  // è®¢é˜…çŠ¶æ€å˜åŒ–
  subscribe(listener) {
    this.listeners.push(listener);
    return () => {
      this.listeners = this.listeners.filter(l => l !== listener);
    };
  }
  
  // æ›´æ–°çŠ¶æ€
  setState(updates) {
    this.state = { ...this.state, ...updates };
    this.notify();
  }
  
  // é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨
  notify() {
    this.listeners.forEach(listener => listener(this.state));
  }
  
  // è·å–çŠ¶æ€
  getState() {
    return this.state;
  }
}

// ä½¿ç”¨
const store = new BookstoreStore();

// è®¢é˜…çŠ¶æ€å˜åŒ–
const unsubscribe = store.subscribe((state) => {
  console.log('çŠ¶æ€æ›´æ–°:', state);
  // æ›´æ–°UI
});

// æ›´æ–°çŠ¶æ€
store.setState({ loading: true });
store.setState({ books: [...], loading: false });
```

## 5. å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•å¤„ç†å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Ÿ

```javascript
function handleImageError(img) {
  img.onerror = function() {
    this.src = '/default-book-cover.png'; // ä½¿ç”¨é»˜è®¤å›¾ç‰‡
    this.onerror = null; // é˜²æ­¢æ— é™å¾ªç¯
  };
}

// åœ¨æ¸²æŸ“æ—¶ä½¿ç”¨
<img src="${book.cover}" onerror="handleImageError(this)" alt="${book.title}">
```

### Q2: å¦‚ä½•å®ç°æ— é™æ»šåŠ¨åŠ è½½ï¼Ÿ

```javascript
class InfiniteScroll {
  constructor(loadMoreFn) {
    this.loadMoreFn = loadMoreFn;
    this.loading = false;
    this.hasMore = true;
    
    this.init();
  }
  
  init() {
    window.addEventListener('scroll', () => {
      if (this.shouldLoadMore()) {
        this.loadMore();
      }
    });
  }
  
  shouldLoadMore() {
    if (this.loading || !this.hasMore) {
      return false;
    }
    
    const scrollTop = window.scrollY;
    const windowHeight = window.innerHeight;
    const documentHeight = document.documentElement.scrollHeight;
    
    return scrollTop + windowHeight >= documentHeight - 200;
  }
  
  async loadMore() {
    this.loading = true;
    
    try {
      const hasMore = await this.loadMoreFn();
      this.hasMore = hasMore;
    } catch (error) {
      console.error('åŠ è½½å¤±è´¥:', error);
    } finally {
      this.loading = false;
    }
  }
}

// ä½¿ç”¨
let currentPage = 1;
const infiniteScroll = new InfiniteScroll(async () => {
  const result = await api.get('/books', {
    params: { page: currentPage++, size: 20 }
  });
  
  appendBooks(result.books);
  return result.books.length > 0;
});
```

### Q3: å¦‚ä½•å®ç°æœç´¢é˜²æŠ–ï¼Ÿ

```javascript
function debounce(fn, delay = 300) {
  let timer = null;
  
  return function(...args) {
    if (timer) {
      clearTimeout(timer);
    }
    
    timer = setTimeout(() => {
      fn.apply(this, args);
    }, delay);
  };
}

// ä½¿ç”¨
const searchInput = document.getElementById('search-input');
const debouncedSearch = debounce((keyword) => {
  search.search(keyword);
}, 300);

searchInput.addEventListener('input', (e) => {
  debouncedSearch(e.target.value);
});
```

## 6. æ•…éšœæ’æŸ¥

### 6.1 å¸¸è§é”™è¯¯

**é”™è¯¯1: è·¨åŸŸé—®é¢˜**

```
Access to XMLHttpRequest at 'http://api.example.com' 
from origin 'http://localhost:3000' has been blocked by CORS policy
```

**è§£å†³æ–¹æ¡ˆ**:
1. åç«¯é…ç½®CORS
2. ä½¿ç”¨ä»£ç†æœåŠ¡å™¨
3. å¼€å‘ç¯å¢ƒé…ç½®ä»£ç†

```javascript
// vue.config.js (Vueé¡¹ç›®)
module.exports = {
  devServer: {
    proxy: {
      '/api': {
        target: 'http://api.example.com',
        changeOrigin: true
      }
    }
  }
}
```

**é”™è¯¯2: è¯·æ±‚è¶…æ—¶**

```javascript
// è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
const api = axios.create({
  baseURL: 'http://api.example.com',
  timeout: 10000 // 10ç§’è¶…æ—¶
});

// å¤„ç†è¶…æ—¶é”™è¯¯
api.interceptors.response.use(
  response => response,
  error => {
    if (error.code === 'ECONNABORTED') {
      ErrorHandler.handle(new Error('è¯·æ±‚è¶…æ—¶'), 'timeout');
    }
    return Promise.reject(error);
  }
);
```

### 6.2 è°ƒè¯•æŠ€å·§

```javascript
// å¯ç”¨è°ƒè¯•æ¨¡å¼
class Debug {
  static enabled = process.env.NODE_ENV === 'development';
  
  static log(...args) {
    if (this.enabled) {
      console.log('[DEBUG]', ...args);
    }
  }
  
  static logRequest(config) {
    this.log('Request:', {
      url: config.url,
      method: config.method,
      params: config.params,
      data: config.data
    });
  }
  
  static logResponse(response) {
    this.log('Response:', {
      status: response.status,
      data: response.data
    });
  }
}

// ä½¿ç”¨
api.interceptors.request.use(config => {
  Debug.logRequest(config);
  return config;
});

api.interceptors.response.use(response => {
  Debug.logResponse(response);
  return response;
});
```

---

**æ–‡æ¡£ç»´æŠ¤**: é’ç¾½åç«¯å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025-10-08  
**æŠ€æœ¯æ”¯æŒ**: support@qingyu.com

