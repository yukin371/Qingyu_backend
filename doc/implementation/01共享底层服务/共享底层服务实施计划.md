# 共享底层服务实施计划

## 📋 总体目标

根据 [共享底层服务设计文档](../design/shared/README_共享底层服务设计文档.md)，实施以下6个核心服务模块：

1. **auth** - 账号与权限模块
2. **wallet** - 钱包系统模块
3. **recommendation** - 推荐服务模块
4. **messaging** - 消息队列模块
5. **storage** - 文件存储模块
6. **admin** - 管理后台模块

---

## 🎯 实施进度总览

### 完成情况：17% (2/12阶段) ✅

| 阶段 | 模块 | 状态 | 完成度 | 预计工作量 | 实际工作量 |
|------|------|------|--------|-----------|-----------|
| **阶段1** | 目录结构创建 | ✅ 已完成 | 100% | 0.5h | 0.5h |
| **阶段2** | Auth模块-基础 | ✅ 已完成 | 100% | 8h | 8h |
| **阶段3** | Auth模块-进阶 | ⏸️ 待开始 | 0% | 6h | - |
| **阶段4** | Wallet模块 | ⏸️ 待开始 | 0% | 10h | - |
| **阶段5** | Recommendation模块 | ⏸️ 待开始 | 0% | 8h | - |
| **阶段6** | Messaging模块 | ⏸️ 待开始 | 0% | 6h | - |
| **阶段7** | Storage模块 | ⏸️ 待开始 | 0% | 6h | - |
| **阶段8** | Admin模块 | ⏸️ 待开始 | 0% | 8h | - |
| **阶段9** | 服务集成 | ⏸️ 待开始 | 0% | 4h | - |
| **阶段10** | API层实现 | ⏸️ 待开始 | 0% | 6h | - |
| **阶段11** | 测试编写 | ⏸️ 待开始 | 0% | 8h | - |
| **阶段12** | 文档完善 | ⏸️ 待开始 | 0% | 2h | - |

**总预计工作量**: 72.5小时  
**总实际工作量**: 8.5小时

---

## 📊 当前状态分析

### ✅ 已有基础

1. **用户服务部分实现**
   - 位置：`service/user/user_service.go`
   - 已实现：CRUD、注册、登录（基础版）
   - 缺失：JWT生成、角色权限、会话管理

2. **用户模型**
   - 位置：`models/users/user.go`
   - 已有：User结构、密码加密验证

3. **用户Repository**
   - 位置：`repository/mongodb/user/`
   - 已实现：基础数据访问

### ❌ 缺失模块

1. **Auth模块** - 需要完整实现
   - JWT Token生成与验证
   - 角色权限系统（RBAC）
   - 会话管理（Redis）
   - 权限中间件

2. **Wallet模块** - 完全缺失
   - 钱包数据模型
   - 交易系统
   - 支付集成
   - 提现功能

3. **Recommendation模块** - 完全缺失
   - 推荐算法
   - 用户行为收集
   - 推荐结果缓存

4. **Messaging模块** - 完全缺失
   - Redis Streams集成
   - 消息发布订阅
   - 异步任务处理

5. **Storage模块** - 完全缺失
   - 文件上传下载
   - 存储策略
   - 权限控制

6. **Admin模块** - 完全缺失
   - 内容审核
   - 用户管理
   - 操作日志

---

## 🚀 详细实施计划

### 阶段1：目录结构创建（0.5小时）

#### 目标
创建符合模块化单体架构的目录结构

#### 任务清单
- [x] 创建 `service/shared/` 目录
- [x] 创建子模块目录结构
- [x] 创建对应的 `models/shared/` 目录
- [x] 创建对应的 `repository/interfaces/shared/` 目录
- [x] 创建对应的 `repository/mongodb/shared/` 目录
- [x] 创建所有服务模块的 `interfaces.go` 文件
- [x] 创建所有核心模型文件
- [x] 创建 Repository 接口文件

#### 目录结构
```
service/shared/
├── auth/
│   ├── auth_service.go          # 认证服务实现
│   ├── jwt_service.go           # JWT服务
│   ├── role_service.go          # 角色服务
│   ├── permission_service.go    # 权限服务
│   ├── session_service.go       # 会话服务
│   └── interfaces.go            # 对外接口
│
├── wallet/
│   ├── wallet_service.go        # 钱包服务
│   ├── transaction_service.go   # 交易服务
│   ├── payment_service.go       # 支付服务
│   ├── withdraw_service.go      # 提现服务
│   └── interfaces.go
│
├── recommendation/
│   ├── recommendation_service.go
│   ├── algorithm_service.go     # 推荐算法
│   ├── behavior_service.go      # 行为收集
│   └── interfaces.go
│
├── messaging/
│   ├── messaging_service.go
│   ├── redis_stream.go          # Redis Streams实现
│   ├── publisher.go             # 发布者
│   ├── subscriber.go            # 订阅者
│   └── interfaces.go
│
├── storage/
│   ├── storage_service.go
│   ├── local_storage.go         # 本地存储
│   ├── cloud_storage.go         # 云存储（预留）
│   └── interfaces.go
│
└── admin/
    ├── admin_service.go
    ├── audit_service.go         # 审核服务
    ├── log_service.go           # 日志服务
    └── interfaces.go

models/shared/
├── auth/
│   ├── role.go
│   ├── permission.go
│   └── session.go
│
├── wallet/
│   ├── wallet.go
│   ├── transaction.go
│   └── withdraw_request.go
│
├── recommendation/
│   ├── recommendation.go
│   └── user_behavior.go
│
├── messaging/
│   └── message.go
│
├── storage/
│   └── file.go
│
└── admin/
    └── admin_log.go

repository/interfaces/shared/
├── auth_repository.go
├── wallet_repository.go
├── recommendation_repository.go
├── messaging_repository.go
├── storage_repository.go
└── admin_repository.go

repository/mongodb/shared/
├── auth_repository.go
├── wallet_repository.go
├── recommendation_repository.go
├── messaging_repository.go
├── storage_repository.go
└── admin_repository.go
```

---

### 阶段2：Auth模块 - 基础功能（8小时）

#### 优先级：🔴 高

#### 2.1 JWT服务实现（2小时）

**任务清单**
- [x] 创建JWT配置结构
- [x] 实现Token生成（GenerateToken）
- [x] 实现Token验证（ValidateToken）
- [x] 实现Token刷新（RefreshToken）
- [x] 实现Token黑名单（Redis）
- [x] 编写单元测试（7个测试用例，全部通过）

**文件清单**
- `service/shared/auth/jwt_service.go`
- `models/shared/auth/token.go`

**代码示例**
```go
// service/shared/auth/jwt_service.go
package auth

import (
    "context"
    "time"
    "github.com/golang-jwt/jwt/v5"
)

type JWTService interface {
    GenerateToken(ctx context.Context, userID string, roles []string) (string, error)
    ValidateToken(ctx context.Context, token string) (*TokenClaims, error)
    RefreshToken(ctx context.Context, token string) (string, error)
    RevokeToken(ctx context.Context, token string) error
    IsTokenRevoked(ctx context.Context, token string) (bool, error)
}

type JWTServiceImpl struct {
    secretKey     string
    issuer        string
    expiration    time.Duration
    redisClient   *redis.Client
}

// TODO: 实现接口方法
```

#### 2.2 角色模型与Repository（2小时）

**任务清单**
- [ ] 创建Role模型
- [ ] 创建Permission模型
- [ ] 创建RoleRepository接口
- [ ] 实现MongoDB Repository

**文件清单**
- `models/shared/auth/role.go`
- `models/shared/auth/permission.go`
- `repository/interfaces/shared/auth_repository.go`
- `repository/mongodb/shared/auth_repository.go`

#### 2.3 角色服务实现（2小时）

**任务清单**
- [ ] 实现CreateRole
- [ ] 实现UpdateRole
- [ ] 实现DeleteRole
- [ ] 实现AssignPermissions
- [ ] 实现RemovePermissions

**文件清单**
- `service/shared/auth/role_service.go`

#### 2.4 权限服务实现（2小时）

**任务清单**
- [ ] 实现CheckPermission（权限检查）
- [ ] 实现GetUserPermissions（获取用户权限）
- [ ] 实现HasRole（角色检查）
- [ ] 实现权限缓存（Redis）

**文件清单**
- `service/shared/auth/permission_service.go`

---

### 阶段3：Auth模块 - 进阶功能（6小时）

#### 优先级：🔴 高

#### 3.1 会话管理（2小时）

**任务清单**
- [ ] 创建Session模型
- [ ] 实现会话创建（Redis）
- [ ] 实现会话验证
- [ ] 实现会话销毁
- [ ] 实现会话续期

**文件清单**
- `models/shared/auth/session.go`
- `service/shared/auth/session_service.go`

#### 3.2 Auth Service集成（2小时）

**任务清单**
- [ ] 整合JWT、Role、Permission、Session服务
- [ ] 实现统一的Auth接口
- [ ] 完善用户注册流程（集成角色分配）
- [ ] 完善用户登录流程（生成真实JWT）

**文件清单**
- `service/shared/auth/auth_service.go`
- `service/shared/auth/interfaces.go`

#### 3.3 中间件实现（2小时）

**任务清单**
- [ ] 完善JWT中间件（`middleware/jwt.go`）
- [ ] 完善权限中间件（`middleware/permission.go`）
- [ ] 集成Auth服务到中间件

**文件清单**
- `middleware/jwt.go`
- `middleware/permission.go`

---

### 阶段4：Wallet模块（10小时）

#### 优先级：🔴 高

#### 4.1 钱包模型与Repository（2小时）

**任务清单**
- [ ] 创建Wallet模型
- [ ] 创建Transaction模型
- [ ] 创建WithdrawRequest模型
- [ ] 创建WalletRepository接口
- [ ] 实现MongoDB Repository

**文件清单**
- `models/shared/wallet/wallet.go`
- `models/shared/wallet/transaction.go`
- `models/shared/wallet/withdraw_request.go`
- `repository/interfaces/shared/wallet_repository.go`
- `repository/mongodb/shared/wallet_repository.go`

#### 4.2 钱包基础服务（3小时）

**任务清单**
- [ ] 实现CreateWallet
- [ ] 实现GetBalance
- [ ] 实现GetWallet
- [ ] 实现钱包冻结/解冻

**文件清单**
- `service/shared/wallet/wallet_service.go`

#### 4.3 交易服务（3小时）

**任务清单**
- [ ] 实现Recharge（充值）
- [ ] 实现Consume（消费）
- [ ] 实现Transfer（转账）
- [ ] 实现交易记录查询
- [ ] 实现事务保证（ACID）

**文件清单**
- `service/shared/wallet/transaction_service.go`

#### 4.4 支付与提现（2小时）

**任务清单**
- [ ] 实现支付接口（预留）
- [ ] 实现提现申请
- [ ] 实现提现审核
- [ ] 实现提现处理

**文件清单**
- `service/shared/wallet/payment_service.go`
- `service/shared/wallet/withdraw_service.go`

---

### 阶段5：Recommendation模块（8小时）

#### 优先级：🟡 中

#### 5.1 模型与Repository（2小时）

**任务清单**
- [ ] 创建RecommendedItem模型
- [ ] 创建UserBehavior模型
- [ ] 创建Repository接口
- [ ] 实现MongoDB Repository

#### 5.2 用户行为收集（2小时）

**任务清单**
- [ ] 实现RecordBehavior（浏览、点击、收藏等）
- [ ] 实现行为数据存储
- [ ] 实现行为数据统计

**文件清单**
- `service/shared/recommendation/behavior_service.go`

#### 5.3 推荐算法（简单版）（3小时）

**任务清单**
- [ ] 实现热度推荐算法
- [ ] 实现标签匹配推荐
- [ ] 实现协同过滤（简单版）
- [ ] 实现推荐结果缓存（Redis）

**文件清单**
- `service/shared/recommendation/algorithm_service.go`

#### 5.4 推荐服务集成（1小时）

**任务清单**
- [ ] 实现GetPersonalizedRecommendations
- [ ] 实现GetSimilarItems
- [ ] 实现GetHotItems

**文件清单**
- `service/shared/recommendation/recommendation_service.go`
- `service/shared/recommendation/interfaces.go`

---

### 阶段6：Messaging模块（6小时）

#### 优先级：🟡 中

#### 6.1 Redis Streams集成（2小时）

**任务清单**
- [ ] 实现Redis Streams连接
- [ ] 实现Stream创建
- [ ] 实现Consumer Group管理

**文件清单**
- `service/shared/messaging/redis_stream.go`

#### 6.2 消息发布订阅（2小时）

**任务清单**
- [ ] 实现Publisher
- [ ] 实现Subscriber
- [ ] 实现消息序列化/反序列化

**文件清单**
- `service/shared/messaging/publisher.go`
- `service/shared/messaging/subscriber.go`

#### 6.3 消息服务封装（2小时）

**任务清单**
- [ ] 实现Publish方法
- [ ] 实现Subscribe方法
- [ ] 实现PublishDelayed方法
- [ ] 实现常见Topic定义

**文件清单**
- `service/shared/messaging/messaging_service.go`
- `service/shared/messaging/topics.go`
- `service/shared/messaging/interfaces.go`

---

### 阶段7：Storage模块（6小时）

#### 优先级：🟡 中

#### 7.1 模型与Repository（1小时）

**任务清单**
- [ ] 创建File模型
- [ ] 创建FileRepository接口
- [ ] 实现MongoDB Repository（存储元数据）

**文件清单**
- `models/shared/storage/file.go`
- `repository/interfaces/shared/storage_repository.go`
- `repository/mongodb/shared/storage_repository.go`

#### 7.2 本地存储实现（2小时）

**任务清单**
- [ ] 实现文件上传（本地文件系统）
- [ ] 实现文件下载
- [ ] 实现文件删除
- [ ] 实现文件信息获取

**文件清单**
- `service/shared/storage/local_storage.go`

#### 7.3 存储服务封装（2小时）

**任务清单**
- [ ] 实现Upload接口
- [ ] 实现Download接口
- [ ] 实现Delete接口
- [ ] 实现GetFileInfo接口
- [ ] 实现访问权限控制

**文件清单**
- `service/shared/storage/storage_service.go`
- `service/shared/storage/interfaces.go`

#### 7.4 云存储预留（1小时）

**任务清单**
- [ ] 定义云存储接口
- [ ] 创建OSS适配器框架（预留实现）

**文件清单**
- `service/shared/storage/cloud_storage.go`

---

### 阶段8：Admin模块（8小时）

#### 优先级：🟢 低

#### 8.1 模型与Repository（2小时）

**任务清单**
- [ ] 创建AdminLog模型
- [ ] 创建AuditRecord模型
- [ ] 创建Repository接口
- [ ] 实现MongoDB Repository

**文件清单**
- `models/shared/admin/admin_log.go`
- `models/shared/admin/audit_record.go`
- `repository/interfaces/shared/admin_repository.go`
- `repository/mongodb/shared/admin_repository.go`

#### 8.2 审核服务（2小时）

**任务清单**
- [ ] 实现ReviewContent（内容审核）
- [ ] 实现ApproveContent（批准）
- [ ] 实现RejectContent（驳回）
- [ ] 实现GetPendingReviews（待审核列表）

**文件清单**
- `service/shared/admin/audit_service.go`

#### 8.3 用户管理服务（2小时）

**任务清单**
- [ ] 实现ManageUser（用户管理）
- [ ] 实现BanUser（封禁用户）
- [ ] 实现UnbanUser（解封用户）
- [ ] 实现GetUserStatistics（用户统计）

#### 8.4 日志服务（2小时）

**任务清单**
- [ ] 实现LogOperation（操作日志）
- [ ] 实现GetOperationLogs（日志查询）
- [ ] 实现日志导出

**文件清单**
- `service/shared/admin/log_service.go`
- `service/shared/admin/admin_service.go`
- `service/shared/admin/interfaces.go`

---

### 阶段9：服务集成（4小时）

#### 优先级：🔴 高

#### 9.1 服务容器扩展（2小时）

**任务清单**
- [ ] 扩展ServiceContainer，注册所有共享服务
- [ ] 实现依赖注入
- [ ] 实现服务生命周期管理

**文件清单**
- `service/container/service_container.go`

#### 9.2 服务初始化（2小时）

**任务清单**
- [ ] 在`main.go`中初始化所有共享服务
- [ ] 实现健康检查端点
- [ ] 实现服务启动顺序管理

**文件清单**
- `main.go`
- `core/init_shared_services.go`（新建）

---

### 阶段10：API层实现（6小时）

#### 优先级：🔴 高

#### 10.1 Auth API（2小时）

**任务清单**
- [ ] 实现登录API（集成JWT）
- [ ] 实现注册API（集成角色分配）
- [ ] 实现登出API（Token黑名单）
- [ ] 实现Token刷新API
- [ ] 实现角色管理API

**文件清单**
- `api/v1/shared/auth_api.go`

#### 10.2 Wallet API（2小时）

**任务清单**
- [ ] 实现充值API
- [ ] 实现余额查询API
- [ ] 实现交易记录API
- [ ] 实现提现申请API

**文件清单**
- `api/v1/shared/wallet_api.go`

#### 10.3 其他API（2小时）

**任务清单**
- [ ] 实现推荐API
- [ ] 实现文件上传API
- [ ] 实现管理后台API

**文件清单**
- `api/v1/shared/recommendation_api.go`
- `api/v1/shared/storage_api.go`
- `api/v1/shared/admin_api.go`

#### 10.4 路由配置

**任务清单**
- [ ] 创建共享服务路由
- [ ] 配置权限中间件
- [ ] 集成到主路由

**文件清单**
- `router/shared/shared_router.go`

---

### 阶段11：测试编写（8小时）

#### 优先级：🟡 中

#### 11.1 单元测试（4小时）

**任务清单**
- [ ] Auth模块测试
- [ ] Wallet模块测试
- [ ] Recommendation模块测试
- [ ] Messaging模块测试
- [ ] Storage模块测试

**文件清单**
- `service/shared/auth/*_test.go`
- `service/shared/wallet/*_test.go`
- 等等

#### 11.2 集成测试（4小时）

**任务清单**
- [ ] 用户注册登录流程测试
- [ ] 钱包充值消费流程测试
- [ ] 推荐系统集成测试
- [ ] 文件上传下载测试

**文件清单**
- `test/integration/shared_services_test.go`

---

### 阶段12：文档完善（2小时）

#### 优先级：🟢 低

**任务清单**
- [ ] 编写API使用文档
- [ ] 编写服务调用示例
- [ ] 更新README
- [ ] 编写部署指南

**文件清单**
- `doc/usage/共享服务使用指南.md`
- `doc/api/shared/`（各API文档）

---

## 📅 时间表

### Week 1 (09.30 - 10.06)
- [x] 阶段1：目录结构创建（2025-09-30完成）
- [ ] 阶段2：Auth模块基础功能
- [ ] 阶段3：Auth模块进阶功能

### Week 2 (10.08 - 10.14)
- [ ] 阶段4：Wallet模块
- [ ] 阶段5：Recommendation模块（开始）

### Week 3 (10.15 - 10.21)
- [ ] 阶段5：Recommendation模块（完成）
- [ ] 阶段6：Messaging模块
- [ ] 阶段7：Storage模块

### Week 4 (10.22 - 10.28)
- [ ] 阶段8：Admin模块
- [ ] 阶段9：服务集成
- [ ] 阶段10：API层实现

### Week 5 (10.29 - 11.04)
- [ ] 阶段11：测试编写
- [ ] 阶段12：文档完善
- [ ] 最终验收

---

## 🔗 依赖关系

### 模块依赖图

```
┌─────────────┐
│   Messaging │ (基础设施)
└──────┬──────┘
       │
┌──────▼──────┐     ┌────────────┐
│    Auth     │◄────┤   Storage  │
└──────┬──────┘     └────────────┘
       │
       ├──────────────────┐
       │                  │
┌──────▼──────┐     ┌─────▼─────────┐
│   Wallet    │     │ Recommendation│
└─────────────┘     └───────────────┘
       │                  │
       └──────────┬───────┘
                  │
           ┌──────▼──────┐
           │    Admin    │
           └─────────────┘
```

### 实施顺序说明

1. **优先级1（基础设施）**: Auth、Messaging
2. **优先级2（核心业务）**: Wallet、Storage
3. **优先级3（增值服务）**: Recommendation、Admin

---

## ✅ 验收标准

### 功能完整性
- [ ] 所有接口按照设计文档实现
- [ ] 所有模块通过单元测试
- [ ] 集成测试覆盖主要流程

### 代码质量
- [ ] 遵循项目开发规则
- [ ] 代码注释完整
- [ ] 错误处理规范
- [ ] 日志记录完整

### 性能要求
- [ ] API响应时间 < 200ms (P95)
- [ ] 支持并发用户数 > 1000
- [ ] 数据库查询优化（索引完整）

### 文档完整性
- [ ] API文档完整
- [ ] 使用指南完整
- [ ] 测试文档完整
- [ ] 部署文档完整

---

## 🚨 风险与应对

### 风险1：JWT实现复杂度
**风险描述**: JWT生成、验证、刷新机制较复杂  
**应对措施**: 
- 使用成熟的JWT库（`golang-jwt/jwt`）
- 参考业界最佳实践
- 编写详细测试用例

### 风险2：钱包事务一致性
**风险描述**: 钱包充值、消费需要保证ACID  
**应对措施**:
- 使用MongoDB事务
- 实现乐观锁机制
- 详细的事务测试

### 风险3：推荐算法效果
**风险描述**: 简单推荐算法可能效果不佳  
**应对措施**:
- 先实现简单算法（热度、标签）
- 收集数据后逐步优化
- 预留算法升级接口

### 风险4：Redis Streams学习曲线
**风险描述**: 团队可能不熟悉Redis Streams  
**应对措施**:
- 提前学习和实验
- 参考官方文档和示例
- 可降级到Go Channel（开发环境）

---

## 📊 进度跟踪

### 每日更新

#### 2025-09-30（Day 0）
- ✅ 创建实施计划文档
- ✅ 完成阶段1：目录结构创建（0.5h）
  - 创建所有服务层目录（auth, wallet, recommendation, messaging, storage, admin）
  - 创建所有模型层目录
  - 创建所有Repository层目录
  - 创建所有服务接口文件（6个）
  - 创建所有核心模型文件（6个模块）
  - 创建Repository接口文件
- ✅ 完成阶段2.1：JWT服务实现（2h）
  - 创建JWT配置结构（`config/jwt.go`）
  - 实现完整的JWT服务（`service/shared/auth/jwt_service.go`，~310行）
  - 功能：Token生成、验证、刷新、吊销、黑名单
  - 编写单元测试（`jwt_service_test.go`，~250行，7个测试用例）
  - 测试结果：✅ 全部通过
- 🔄 下一步：阶段2.2 角色模型与Repository实现
- ✅ 完成阶段2.2-2.4：角色权限系统（6h）
  - 创建AuthRepository实现（`repository/mongodb/shared/auth_repository.go`，~290行）
  - 实现RoleService（`service/shared/auth/role_service.go`，~180行）
  - 实现PermissionService（`service/shared/auth/permission_service.go`，~130行）
  - 实现AuthService集成服务（`service/shared/auth/auth_service.go`，~240行）
  - 编写完整测试（~500行，23个测试用例）
  - 测试结果：✅ 全部通过（23/23）
- 🔄 下一步：阶段3 Auth模块会话管理与中间件

#### 待更新...

---

## 🔗 相关文档

### 设计文档
- [共享底层服务设计文档](../design/shared/README_共享底层服务设计文档.md)
- [账号权限系统设计](../design/shared/账号权限系统设计.md)
- [钱包系统设计](../design/shared/钱包系统设计.md)
- [推荐服务设计](../design/shared/推荐服务设计.md)
- [消息队列设计](../design/shared/消息队列设计.md)

### 架构文档
- [项目开发规则](../architecture/项目开发规则.md)
- [架构设计规范](../architecture/架构设计规范.md)
- [Repository层设计规范](../architecture/repository层设计规范.md)

### 实施文档
- [实施文档目录](./README.md)
- [测试框架实施进度](./测试框架实施进度.md)

---

## 💡 协作指南

### 如何认领任务
1. 在对应阶段的任务清单中选择未完成的任务
2. 更新任务状态为 `🟡 进行中`
3. 完成后更新为 `✅ 已完成`

### 如何提交代码
```bash
# 1. 创建功能分支
git checkout -b feature/shared-auth-module

# 2. 完成代码开发和测试
go test ./service/shared/auth/...

# 3. 提交代码
git add .
git commit -m "feat(shared): 实现Auth模块JWT服务"

# 4. 推送并创建PR
git push origin feature/shared-auth-module
```

### Commit消息规范
```
feat(shared): 实现钱包充值功能
fix(shared): 修复JWT Token刷新逻辑
test(shared): 添加推荐服务单元测试
docs(shared): 更新共享服务API文档
```

---

*让我们一起构建高质量的共享服务！* 🚀
