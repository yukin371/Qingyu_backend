# 青羽平台架构重构执行计划

> **创建日期**: 2025-10-22  
> **计划周期**: 4周  
> **执行状态**: 待开始  
> **相关文档**: [架构审查报告](./架构审查报告_2025-10-22.md)

---

## 📋 执行概览

### 重构目标

1. **提升模块清晰度**: 从60%提升到95%
2. **统一命名规范**: 消除所有命名不一致
3. **清理代码结构**: 删除所有空目录和孤立文件
4. **优化开发体验**: 降低新人上手难度50%

### 重构原则

✅ **安全第一**: 每个阶段完成后充分测试  
✅ **渐进式**: 分4个Phase逐步实施  
✅ **可回滚**: 保留Git历史，出问题可快速回滚  
✅ **文档同步**: 代码重构同步更新所有文档  

---

## 🗓️ 时间表

| Phase | 内容 | 工期 | 开始日期 | 结束日期 | 状态 |
|-------|------|------|----------|----------|------|
| Phase 1 | 紧急修复 | 1-2天 | TBD | TBD | ⏸️ 待开始 |
| Phase 2 | 命名统一 | 3-5天 | TBD | TBD | ⏸️ 待开始 |
| Phase 3 | 模块重组 | 1-2周 | TBD | TBD | ⏸️ 待开始 |
| Phase 4 | 优化完善 | 持续 | TBD | TBD | ⏸️ 待开始 |

---

## 📦 Phase 1: 紧急修复（1-2天）

### 目标
清理所有空目录和孤立文件，提升项目结构清晰度

### 任务列表

#### Task 1.1: 删除空目录 ⭐⭐⭐

**清单**:
```bash
# Service层空目录
service/social/
service/task/

# Model层空目录  
models/reading/recommendation/
models/reading/social/
models/reading/task/
models/writer/

# Router层空目录
router/reading/
```

**执行步骤**:
```bash
# 1. 确认目录确实为空
ls -la service/social/
ls -la service/task/
ls -la models/reading/recommendation/
ls -la models/reading/social/
ls -la models/reading/task/
ls -la models/writer/
ls -la router/reading/

# 2. 删除空目录
rm -rf service/social/
rm -rf service/task/
rm -rf models/reading/recommendation/
rm -rf models/reading/social/
rm -rf models/reading/task/
rm -rf models/writer/
rm -rf router/reading/

# 3. 提交Git
git add -A
git commit -m "refactor: 清理空目录，提升项目结构清晰度"
```

**验证**:
- [ ] 所有空目录已删除
- [ ] 项目编译通过
- [ ] 单元测试通过

**风险**: 无  
**预计耗时**: 0.5小时

---

#### Task 1.2: 移动Quota Repository ⭐⭐⭐

**当前问题**:
```
repository/mongodb/
├── quota_repository.go  ❌ 孤立在顶层

repository/interfaces/
└── QuotaRepo_interface.go  ❌ 孤立在顶层
```

**目标结构**:
```
repository/mongodb/ai/
└── quota_repository_mongo.go  ✅

repository/interfaces/ai/
└── QuotaRepository_interface.go  ✅
```

**执行步骤**:
```bash
# 1. 创建AI子目录
mkdir -p repository/mongodb/ai/
mkdir -p repository/interfaces/ai/

# 2. 移动文件
git mv repository/mongodb/quota_repository.go \
        repository/mongodb/ai/quota_repository_mongo.go
        
git mv repository/interfaces/QuotaRepo_interface.go \
        repository/interfaces/ai/QuotaRepository_interface.go

# 3. 更新package声明
# 编辑 repository/mongodb/ai/quota_repository_mongo.go
# 将 package mongodb 改为 package ai

# 编辑 repository/interfaces/ai/QuotaRepository_interface.go  
# 将 package interfaces 改为 package ai

# 4. 更新所有import路径
# 查找并替换以下import:
#   旧: "Qingyu_backend/repository/interfaces"
#   新: "Qingyu_backend/repository/interfaces/ai"

# 受影响的文件:
# - service/ai/quota_service.go
# - repository/mongodb/factory.go

# 5. 更新Factory方法
# 编辑 repository/mongodb/factory.go
# CreateQuotaRepository() 方法改为返回 ai.QuotaRepository

# 6. 提交Git
git add -A
git commit -m "refactor(repository): 将Quota Repository移入ai子目录"
```

**需要修改的文件**:
1. `repository/mongodb/ai/quota_repository_mongo.go` - 包名
2. `repository/interfaces/ai/QuotaRepository_interface.go` - 包名
3. `service/ai/quota_service.go` - import路径
4. `repository/mongodb/factory.go` - import和返回类型

**验证**:
- [ ] 文件已移动到正确位置
- [ ] 包名已更新
- [ ] 所有import路径已更新
- [ ] 编译通过
- [ ] QuotaService测试通过

**风险**: 低  
**预计耗时**: 1小时

---

### Phase 1 检查点

**完成标准**:
- [ ] 所有空目录已删除
- [ ] 孤立文件已移动到合适位置
- [ ] 项目编译通过 (`go build`)
- [ ] 所有单元测试通过 (`go test ./...`)
- [ ] 代码已提交到Git

**输出成果**:
- ✅ 更清晰的项目结构
- ✅ 0个空目录
- ✅ 0个顶层孤立文件

---

## 📦 Phase 2: 命名统一（3-5天）

### 目标
统一各层级的模块命名，消除Reading/Reader、Writing/Writer等不一致

### 任务列表

#### Task 2.1: Reader/Reading统一 ⭐⭐⭐⭐⭐

**当前状态**:
| 层级 | 目录名 | 包名 |
|------|--------|------|
| API | `api/v1/reader/` | `reader` |
| Service | `service/reading/` ❌ | `reading` |
| Repository | `repository/mongodb/reading/` ❌ | `reading` |
| Repository接口 | `repository/interfaces/reading/` ❌ | `reading` |
| Model | `models/reading/` ❌ | - |
| Router | `router/reader/` | - |

**目标**: 全部统一为 `reader`

**执行步骤**:

```bash
# 1. 重命名Service目录
git mv service/reading/ service/reader/

# 2. 重命名Repository MongoDB目录
git mv repository/mongodb/reading/ repository/mongodb/reader/

# 3. 重命名Repository接口目录
git mv repository/interfaces/reading/ repository/interfaces/reader/

# 4. 重命名Model目录
git mv models/reading/ models/reader/

# 5. 更新所有文件的package声明
# Service层文件 (service/reader/*.go)
find service/reader/ -name "*.go" -exec sed -i 's/package reading/package reader/g' {} \;

# Repository MongoDB文件
find repository/mongodb/reader/ -name "*.go" -exec sed -i 's/package reading/package reader/g' {} \;

# Repository接口文件
find repository/interfaces/reader/ -name "*.go" -exec sed -i 's/package reading/package reader/g' {} \;

# 6. 更新所有import路径
# 需要在整个项目中查找替换:
#   旧: "Qingyu_backend/service/reading"
#   新: "Qingyu_backend/service/reader"
#
#   旧: "Qingyu_backend/repository/mongodb/reading"
#   新: "Qingyu_backend/repository/mongodb/reader"
#
#   旧: "Qingyu_backend/repository/interfaces/reading"
#   新: "Qingyu_backend/repository/interfaces/reader"
#
#   旧: "Qingyu_backend/models/reading"
#   新: "Qingyu_backend/models/reader"

# 7. 更新Factory
# 编辑 repository/mongodb/factory.go
# 所有 CreateXXXRepository() 方法的返回类型从 reading.XXX 改为 reader.XXX

# 8. 提交Git
git add -A
git commit -m "refactor: 统一Reader模块命名（reading→reader）"
```

**受影响的文件（预估）**:
- Service: ~10个文件
- Repository: ~10个文件
- API: ~7个文件
- Router: ~3个文件
- Model: ~8个文件
- Factory: 1个文件
- **总计**: ~40个文件

**验证**:
- [ ] 所有目录已重命名
- [ ] 所有package声明已更新
- [ ] 所有import路径已更新
- [ ] Factory方法返回类型已更新
- [ ] 编译通过
- [ ] Reader相关测试通过
- [ ] API测试通过

**风险**: 中（影响范围大）  
**预计耗时**: 2-3小时

---

#### Task 2.2: Writer/Writing/Document统一 ⭐⭐⭐⭐⭐

**当前状态（混乱）**:
| 层级 | 目录名 | 说明 |
|------|--------|------|
| API | `api/v1/writer/` ✅ | 统一入口 |
| Service | `service/audit/` ❌ | 分散 |
| Service | `service/document/` ❌ | 分散 |
| Service | `service/project/` ❌ | 分散 |
| Service | `service/stats/` ❌ | 分散 |
| Repository | `repository/mongodb/writing/` ⚠️ | 叫writing |
| Repository接口 | `repository/interfaces/writing/` ⚠️ | 叫writing |
| Model | `models/document/` ⚠️ | 未统一 |
| Router | `router/writer/` ✅ | 部分文件 |
| Router | `router/project/` ❌ | 分散 |

**目标**: 全部统一为 `writer`

**执行步骤**:

```bash
# === 第一步: 创建统一的Writer Service ===

# 1. 创建writer service目录
mkdir -p service/writer/

# 2. 移动所有相关service文件
git mv service/audit/*.go service/writer/
git mv service/document/*.go service/writer/
git mv service/project/*.go service/writer/
git mv service/stats/*.go service/writer/

# 3. 更新package声明
find service/writer/ -name "*.go" -exec sed -i 's/package audit/package writer/g' {} \;
find service/writer/ -name "*.go" -exec sed -i 's/package document/package writer/g' {} \;
find service/writer/ -name "*.go" -exec sed -i 's/package project/package writer/g' {} \;
find service/writer/ -name "*.go" -exec sed -i 's/package stats/package writer/g' {} \;

# 4. 删除旧的service目录
rmdir service/audit/
rmdir service/document/
rmdir service/project/
rmdir service/stats/

# === 第二步: 重命名Repository ===

# 5. 重命名Repository MongoDB目录
git mv repository/mongodb/writing/ repository/mongodb/writer/

# 6. 重命名Repository接口目录
git mv repository/interfaces/writing/ repository/interfaces/writer/

# 7. 更新package声明
find repository/mongodb/writer/ -name "*.go" -exec sed -i 's/package writing/package writer/g' {} \;
find repository/interfaces/writer/ -name "*.go" -exec sed -i 's/package writing/package writer/g' {} \;

# === 第三步: 统一Router ===

# 8. 移动project router文件
git mv router/project/*.go router/writer/

# 9. 删除旧的router目录
rmdir router/project/

# === 第四步: 更新所有import路径 ===

# 需要全局查找替换:
#   service相关:
#     旧: "Qingyu_backend/service/audit"
#     新: "Qingyu_backend/service/writer"
#     
#     旧: "Qingyu_backend/service/document"
#     新: "Qingyu_backend/service/writer"
#
#     旧: "Qingyu_backend/service/project"
#     新: "Qingyu_backend/service/writer"
#
#     旧: "Qingyu_backend/service/stats"
#     新: "Qingyu_backend/service/writer"
#
#   repository相关:
#     旧: "Qingyu_backend/repository/mongodb/writing"
#     新: "Qingyu_backend/repository/mongodb/writer"
#
#     旧: "Qingyu_backend/repository/interfaces/writing"
#     新: "Qingyu_backend/repository/interfaces/writer"

# === 第五步: 更新Factory和Router ===

# 10. 更新Factory
# 编辑 repository/mongodb/factory.go
# CreateProjectRepository() 等方法的返回类型

# 11. 更新Router enter.go
# 编辑 router/enter.go
# 更新writer router的初始化代码

# 12. 提交Git
git add -A
git commit -m "refactor: 统一Writer模块（整合audit/document/project/stats）"
```

**受影响的文件（预估）**:
- Service: ~20个文件
- Repository: ~10个文件
- API: ~7个文件
- Router: ~5个文件
- Model: 不变（保持document）
- Factory: 1个文件
- **总计**: ~50个文件

**验证**:
- [ ] Service文件已整合到writer目录
- [ ] 所有目录已重命名
- [ ] 所有package声明已更新
- [ ] 所有import路径已更新
- [ ] Factory方法已更新
- [ ] Router已整合
- [ ] 编译通过
- [ ] Writer相关测试通过

**风险**: 高（影响范围很大）  
**预计耗时**: 4-6小时

---

#### Task 2.3: Users/User统一 ⭐⭐

**当前状态**:
| 层级 | 目录名 |
|------|--------|
| Model | `models/users/` ❌ |
| Service | `service/user/` ✅ |
| Repository | `repository/.../user/` ✅ |
| Router | `router/users/` ❌ |

**目标**: 全部统一为 `user`

**执行步骤**:
```bash
# 1. 重命名Models目录
git mv models/users/ models/user/

# 2. 重命名Router目录
git mv router/users/ router/user/

# 3. 更新import路径
# 查找替换:
#   旧: "Qingyu_backend/models/users"
#   新: "Qingyu_backend/models/user"

# 4. 提交Git
git add -A
git commit -m "refactor: 统一User模块命名（users→user）"
```

**受影响的文件（预估）**:
- Model: ~3个文件
- Router: ~1个文件
- 其他引用: ~5个文件
- **总计**: ~10个文件

**验证**:
- [ ] 目录已重命名
- [ ] import路径已更新
- [ ] 编译通过
- [ ] 用户相关测试通过

**风险**: 低  
**预计耗时**: 0.5小时

---

#### Task 2.4: 简化Recommendation路径 ⭐⭐

**当前状态**:
```
models/recommendation/
└── reco/              ❌ 多余一层
    ├── behavior.go
    ├── item.go
    └── profile.go
```

**目标**:
```
models/recommendation/
├── behavior.go
├── item.go
└── profile.go
```

**执行步骤**:
```bash
# 1. 移动文件
git mv models/recommendation/reco/*.go models/recommendation/

# 2. 删除空目录
rmdir models/recommendation/reco/

# 3. 更新package声明（如果需要）
# 从 package reco 改为 package recommendation

# 4. 更新import路径
# 查找替换:
#   旧: "Qingyu_backend/models/recommendation/reco"
#   新: "Qingyu_backend/models/recommendation"

# 5. 提交Git
git add -A
git commit -m "refactor: 简化Recommendation模型路径"
```

**受影响的文件（预估）**:
- Model: ~3个文件
- Service: ~2个文件
- Repository: ~4个文件
- **总计**: ~10个文件

**验证**:
- [ ] 文件已移动
- [ ] package声明已更新
- [ ] import路径已更新
- [ ] 编译通过
- [ ] Recommendation测试通过

**风险**: 低  
**预计耗时**: 0.5小时

---

### Phase 2 检查点

**完成标准**:
- [ ] Reader/Reading已统一为reader
- [ ] Writer相关已全部统一
- [ ] Users/User已统一为user
- [ ] Recommendation路径已简化
- [ ] 所有import路径已更新
- [ ] 项目编译通过
- [ ] 所有单元测试通过
- [ ] 代码已提交到Git

**输出成果**:
- ✅ 100%命名一致性
- ✅ 更清晰的模块结构
- ✅ 更易理解的代码组织

---

## 📦 Phase 3: 模块重组（1-2周）

### 目标
合并重复模块，完善缺失功能

### 任务列表

#### Task 3.1: 合并System到Shared ⭐⭐⭐⭐

**当前问题**:
- `api/v1/system/` 与 `api/v1/shared/auth_api.go` 功能重叠
- 用户管理API分散在两处

**执行步骤**:
```bash
# 1. 创建统一的UserAPI
# 新建 api/v1/shared/user_api.go
# 整合 system/sys_user.go 的功能

# 2. 迁移DTO
mkdir -p service/user/dto/
git mv api/v1/system/user_dto.go service/user/dto/

# 3. 更新AuthAPI引用
# 编辑 api/v1/shared/auth_api.go
# 添加用户管理相关方法

# 4. 删除system目录
rm -rf api/v1/system/

# 5. 更新Router
# 编辑 router/shared/shared_router.go
# 添加用户管理路由

# 6. 删除users router（已合并）
rm -rf router/user/

# 7. 更新router/enter.go
# 移除system router初始化

# 8. 提交Git
git add -A
git commit -m "refactor: 合并System到Shared，统一用户管理API"
```

**需要新建的文件**:
- `api/v1/shared/user_api.go` - 整合的用户API

**需要修改的文件**:
- `api/v1/shared/auth_api.go` - 添加用户管理方法
- `router/shared/shared_router.go` - 添加用户路由
- `router/enter.go` - 更新路由注册
- `service/user/dto/*.go` - DTO移动

**验证**:
- [ ] UserAPI已整合到Shared
- [ ] DTO已移动到Service层
- [ ] 路由已更新
- [ ] 编译通过
- [ ] API测试通过
- [ ] 用户管理功能正常

**风险**: 中  
**预计耗时**: 2-3小时

---

#### Task 3.2: 实现Audit Repository ⭐⭐⭐

**当前状态**:
- ✅ 接口已定义：`repository/interfaces/audit/`
- ❌ MongoDB实现缺失

**目标**: 实现完整的Audit Repository

**执行步骤**:
```bash
# 1. 创建目录
mkdir -p repository/mongodb/audit/

# 2. 实现三个Repository
# 新建文件:
# - audit_record_repository_mongo.go
# - sensitive_word_repository_mongo.go
# - violation_record_repository_mongo.go

# 3. 更新Factory
# 编辑 repository/mongodb/factory.go
# 添加:
#   CreateAuditRecordRepository()
#   CreateSensitiveWordRepository()
#   CreateViolationRecordRepository()

# 4. 更新接口工厂
# 编辑 repository/interfaces/repository_factory.go
# 添加对应的接口方法

# 5. 编写单元测试
# 在 test/repository/ 下添加测试文件

# 6. 提交Git
git add -A
git commit -m "feat(repository): 实现Audit Repository MongoDB实现"
```

**需要新建的文件**:
- `repository/mongodb/audit/audit_record_repository_mongo.go`
- `repository/mongodb/audit/sensitive_word_repository_mongo.go`
- `repository/mongodb/audit/violation_record_repository_mongo.go`
- `test/repository/audit_repository_test.go`

**需要修改的文件**:
- `repository/mongodb/factory.go`
- `repository/interfaces/repository_factory.go`

**验证**:
- [ ] 三个Repository已实现
- [ ] Factory方法已添加
- [ ] 单元测试通过
- [ ] AuditService可以正常使用Repository

**风险**: 低（新增功能）  
**预计耗时**: 3-4小时

---

#### Task 3.3: 填充Writer Models ⭐⭐

**当前状态**:
- `models/writer/` 目录为空
- 写作端模型分散在`models/document/`

**目标**: 整理Writer模型结构

**执行步骤**:
```bash
# 方案A: 将document内容移入writer
git mv models/document/ models/writer/document/

# 方案B: 在writer下创建新的聚合模型
mkdir -p models/writer/
# 创建 writer_project.go, writer_document.go 等

# 推荐方案A（保持现有结构）

# 提交Git
git add -A
git commit -m "refactor: 整理Writer模型结构"
```

**验证**:
- [ ] 模型结构清晰
- [ ] import路径已更新
- [ ] 编译通过

**风险**: 低  
**预计耗时**: 1小时

---

### Phase 3 检查点

**完成标准**:
- [ ] System已合并到Shared
- [ ] Audit Repository已实现
- [ ] Writer Models已整理
- [ ] 所有功能正常工作
- [ ] 测试覆盖率 > 80%
- [ ] 代码已提交到Git

**输出成果**:
- ✅ 更合理的模块划分
- ✅ 完整的Repository实现
- ✅ 清晰的Writer模块结构

---

## 📦 Phase 4: 优化完善（持续）

### 目标
持续优化，提升代码质量和可维护性

### 任务列表

#### Task 4.1: DTO统一管理 ⭐⭐⭐

**目标**: 将所有DTO统一放在Service层

**当前问题**:
- DTO散落在API层和Service层
- 命名不统一

**执行步骤**:
1. 在每个service下创建`dto/`子目录
2. 将API层的DTO迁移到Service层
3. 统一DTO命名规范：`XXXRequest`, `XXXResponse`, `XXXDTO`
4. 更新import路径

**预计耗时**: 2-3天

---

#### Task 4.2: 文档更新 ⭐⭐⭐⭐

**需要更新的文档**:
- [ ] 所有API文档（doc/api/）
- [ ] Swagger注释
- [ ] README文件
- [ ] 架构设计文档
- [ ] 开发规则文档

**预计耗时**: 2-3天

---

#### Task 4.3: 测试补充 ⭐⭐⭐⭐

**目标**: 测试覆盖率达到80%以上

**任务**:
- [ ] 为所有新增Service补充单元测试
- [ ] 添加集成测试
- [ ] 添加API测试
- [ ] 性能测试

**预计耗时**: 持续

---

## ✅ 总体验收标准

### 代码质量

- [ ] 编译无警告
- [ ] 所有单元测试通过
- [ ] 测试覆盖率 > 80%
- [ ] Linter检查通过

### 架构质量

- [ ] 模块边界清晰
- [ ] 命名100%一致
- [ ] 无空目录
- [ ] 无孤立文件
- [ ] 层级对应完整

### 文档质量

- [ ] 所有API文档已更新
- [ ] Swagger文档完整
- [ ] README准确
- [ ] 架构文档同步

### 团队反馈

- [ ] Code Review通过
- [ ] 团队培训完成
- [ ] 新人上手指南更新

---

## 📊 进度追踪

### 更新日志

| 日期 | Phase | 任务 | 状态 | 备注 |
|------|-------|------|------|------|
| - | - | - | - | - |

### 风险日志

| 日期 | 风险 | 影响 | 缓解措施 | 状态 |
|------|------|------|----------|------|
| - | - | - | - | - |

---

## 📚 参考资料

- [架构审查报告](./架构审查报告_2025-10-22.md)
- [青羽平台模块化架构设计 v2.2](../design/青羽平台模块化架构设计v2.2.md)
- [项目开发规则 v2.0](../../.cursor/rules/qingyubackend.mdc)
- [Git工作流规范](../ops/Git工作流规范.md)

---

**计划制定人**: AI架构师  
**审核人**: 待定  
**执行团队**: 待定  
**最后更新**: 2025-10-22

