# 🔧 紧急修复任务清单

> **目标**: 让项目可以正常启动（预计3.5小时）

---

## ✅ 任务清单

### 🔴 任务1: Bookstore服务接口 (30分钟)

**文件**: `service/bookstore/bookstore_service.go`

```go
// 添加缺失方法
func (s *BookstoreServiceImpl) GetFreeBooks(ctx context.Context, page, pageSize int) ([]*bookstore.Book, error) {
    offset := (page - 1) * pageSize
    return s.bookRepo.GetFreeBooks(ctx, pageSize, offset)
}
```

**文件**: `service/bookstore/book_detail_service.go`

```go
// 添加缺失方法
func (s *BookDetailServiceImpl) DecrementCommentCount(ctx context.Context, bookID primitive.ObjectID) error {
    return s.bookDetailRepo.UpdateCommentCount(ctx, bookID, -1)
}
```

**文件**: `service/bookstore/cached_bookstore_service.go`

```go
// 添加缺失方法
func (c *CachedBookstoreService) GetFreeBooks(ctx context.Context, page, pageSize int) ([]*bookstore.Book, error) {
    cacheKey := fmt.Sprintf("books:free:%d:%d", page, pageSize)
    
    var books []*bookstore.Book
    if err := c.cache.Get(ctx, cacheKey, &books); err == nil {
        return books, nil
    }
    
    books, err := c.service.GetFreeBooks(ctx, page, pageSize)
    if err != nil {
        return nil, err
    }
    
    _ = c.cache.Set(ctx, cacheKey, books, 5*time.Minute)
    return books, nil
}
```

---

### 🔴 任务2: Repository接口 (45分钟)

**文件**: `repository/interfaces/bookstore/BookStoreRepository_interface.go`

```go
type BookRepository interface {
    // ... 现有方法 ...
    
    // 添加统计方法
    GetStats(ctx context.Context) (*bookstore.BookStats, error)
    IncrementViewCount(ctx context.Context, bookID primitive.ObjectID) error
}
```

**文件**: `repository/interfaces/bookstore/BookDetailRepository_interface.go`

```go
// 修改方法签名
// 从：BatchUpdateCategories(ctx, bookIDs, categoryID, categoryName) error
// 改为：
BatchUpdateCategories(ctx context.Context, bookIDs []primitive.ObjectID, categoryIDs []string) error
```

**文件**: `repository/mongodb/bookstore/book_repository.go`

```go
// 实现新方法
func (r *BookRepositoryImpl) GetStats(ctx context.Context) (*bookstore.BookStats, error) {
    stats := &bookstore.BookStats{}
    
    // 统计总书籍数
    total, err := r.collection.CountDocuments(ctx, bson.M{})
    if err != nil {
        return nil, err
    }
    stats.TotalBooks = total
    
    // 统计已发布书籍数
    published, err := r.collection.CountDocuments(ctx, bson.M{"status": "published"})
    if err != nil {
        return nil, err
    }
    stats.PublishedBooks = published
    
    // 统计免费书籍数
    free, err := r.collection.CountDocuments(ctx, bson.M{"is_free": true})
    if err != nil {
        return nil, err
    }
    stats.FreeBooks = free
    
    return stats, nil
}

func (r *BookRepositoryImpl) IncrementViewCount(ctx context.Context, bookID primitive.ObjectID) error {
    filter := bson.M{"_id": bookID}
    update := bson.M{
        "$inc": bson.M{"view_count": 1},
        "$set": bson.M{"updated_at": time.Now()},
    }
    
    _, err := r.collection.UpdateOne(ctx, filter, update)
    return err
}
```

**文件**: `repository/mongodb/bookstore/book_detail_repository.go`

```go
// 修改方法实现
func (r *BookDetailRepositoryImpl) BatchUpdateCategories(ctx context.Context, bookIDs []primitive.ObjectID, categoryIDs []string) error {
    filter := bson.M{"_id": bson.M{"$in": bookIDs}}
    update := bson.M{
        "$set": bson.M{
            "category_ids": categoryIDs,
            "updated_at":   time.Now(),
        },
    }
    
    _, err := r.collection.UpdateMany(ctx, filter, update)
    return err
}
```

**文件**: `service/bookstore/book_detail_service.go`

```go
// 修改调用处（约591行）
// 从：
err = s.bookDetailRepo.BatchUpdateCategories(ctx, bookIDs, categoryID, categoryName)

// 改为：
err = s.bookDetailRepo.BatchUpdateCategories(ctx, bookIDs, categoryIDs)
```

---

### 🔴 任务3: 统一搜索方法 (30分钟)

**文件**: `service/bookstore/bookstore_service.go`

```go
// 修改实现（约175行）
func (s *BookstoreServiceImpl) SearchBooks(ctx context.Context, keyword string, page, pageSize int) ([]*bookstore.Book, int64, error) {
    offset := (page - 1) * pageSize
    
    // 调用Repository的Search方法
    books, err := s.bookRepo.Search(ctx, keyword, pageSize, offset)
    if err != nil {
        return nil, 0, err
    }
    
    // 计算总数
    filter := &bookstore.BookFilter{
        Keyword: keyword,
        Status:  bookstore.BookStatusPublished, // 只搜索已发布的书籍
    }
    total, err := s.bookRepo.CountByFilter(ctx, filter)
    if err != nil {
        return books, 0, err
    }
    
    return books, total, nil
}

// 修改实现（约181行）
func (s *BookstoreServiceImpl) SearchBooksWithFilter(ctx context.Context, filter *bookstore.BookFilter) ([]*bookstore.Book, int64, error) {
    books, err := s.bookRepo.SearchWithFilter(ctx, filter)
    if err != nil {
        return nil, 0, err
    }
    
    total, err := s.bookRepo.CountByFilter(ctx, filter)
    if err != nil {
        return books, 0, err
    }
    
    return books, total, nil
}

// 修改GetHomepageData方法（约195行）
// 从：
stats, err := s.bookRepo.GetStats(...)

// 改为：
stats, err := s.bookRepo.GetStats(ctx)

// 修改RecordBookView方法（约225行）
// 从：
err := s.bookRepo.IncrementViewCount(...)

// 改为：
err := s.bookRepo.IncrementViewCount(ctx, objectID)
```

**文件**: `service/bookstore/cached_bookstore_service.go`

```go
// 修改SearchBooks方法（约286行）
func (c *CachedBookstoreService) SearchBooks(ctx context.Context, keyword string, page, pageSize int) ([]*bookstore.Book, int64, error) {
    cacheKey := fmt.Sprintf("search:%s:%d:%d", keyword, page, pageSize)
    
    // 尝试从缓存获取
    type CachedResult struct {
        Books []*bookstore.Book
        Total int64
    }
    var cached CachedResult
    if err := c.cache.Get(ctx, cacheKey, &cached); err == nil {
        return cached.Books, cached.Total, nil
    }
    
    // 从服务获取
    books, total, err := c.service.SearchBooks(ctx, keyword, page, pageSize)
    if err != nil {
        return nil, 0, err
    }
    
    // 写入缓存
    _ = c.cache.Set(ctx, cacheKey, CachedResult{Books: books, Total: total}, 5*time.Minute)
    return books, total, nil
}
```

---

### 🔴 任务4: AI模块错误类型 (30分钟)

**新建文件**: `pkg/errors/adapter_errors.go`

```go
package errors

import "fmt"

// AdapterErrorType 适配器错误类型
type AdapterErrorType string

const (
    AdapterErrorInit        AdapterErrorType = "INIT_ERROR"
    AdapterErrorConfig      AdapterErrorType = "CONFIG_ERROR"
    AdapterErrorValidation  AdapterErrorType = "VALIDATION_ERROR"
    AdapterErrorNotFound    AdapterErrorType = "NOT_FOUND"
    AdapterErrorUnavailable AdapterErrorType = "UNAVAILABLE"
    AdapterErrorInternal    AdapterErrorType = "INTERNAL_ERROR"
)

// AdapterError 适配器错误
type AdapterError struct {
    Type      AdapterErrorType
    Message   string
    AdapterID string
    Provider  string
    Cause     error
}

func (e *AdapterError) Error() string {
    if e.Cause != nil {
        return fmt.Sprintf("[Adapter:%s/%s] %s: %s (cause: %v)",
            e.Provider, e.AdapterID, e.Type, e.Message, e.Cause)
    }
    return fmt.Sprintf("[Adapter:%s/%s] %s: %s",
        e.Provider, e.AdapterID, e.Type, e.Message)
}

// NewAdapterError 创建适配器错误
func NewAdapterError(adapterID, provider string, errorType AdapterErrorType, message string, cause error) *AdapterError {
    return &AdapterError{
        Type:      errorType,
        Message:   message,
        AdapterID: adapterID,
        Provider:  provider,
        Cause:     cause,
    }
}
```

**文件**: `service/ai/adapter_manager_new.go`

替换所有错误创建（约137, 143, 154, 160, 170, 225, 233, 280行）：

```go
// 查找所有：
errors.AdapterFactory

// 替换为（根据上下文调整参数）：
errors.NewAdapterError(adapterID, provider, errors.AdapterErrorValidation, message, cause)

// 查找：
base.NewServiceError(base.ErrorTypeValidation, ...)
// 替换为：
errors.NewServiceError("ai-service", errors.ServiceErrorValidation, message, "", cause)

// 查找：
base.NewServiceError(base.ErrorTypeNotFound, ...)
// 替换为：
errors.NewServiceError("ai-service", errors.ServiceErrorNotFound, message, "", cause)
```

具体替换示例：
```go
// 第137行
return errors.NewAdapterError("", provider, errors.AdapterErrorConfig, "provider not found", nil)

// 第143行
return errors.NewAdapterError(adapterID, "", errors.AdapterErrorConfig, "invalid adapter ID", nil)

// 第154行
return errors.NewAdapterError(adapterID, provider, errors.AdapterErrorConfig, "adapter config not found", nil)

// 第160行
return errors.NewAdapterError(adapterID, provider, errors.AdapterErrorInit, "failed to create adapter", err)

// 第170行
return errors.NewAdapterError(adapterID, provider, errors.AdapterErrorInit, "adapter already exists", nil)

// 第225行
return errors.NewServiceError("ai-service", errors.ServiceErrorValidation, "model ID cannot be empty", "", nil)

// 第233行
return errors.NewServiceError("ai-service", errors.ServiceErrorNotFound, "adapter not found", "", nil)
```

---

### 🔴 任务5: 中间件工厂 (10分钟)

**文件**: `middleware/cors.go`

```go
// 在文件末尾添加工厂函数
func CreateCORSMiddleware(config map[string]interface{}) (gin.HandlerFunc, error) {
    // 可以从 config 中读取 CORS 配置
    // 暂时使用默认配置
    return CORSMiddleware(), nil
}
```

---

## ✅ 验证步骤

### 1. 编译验证
```bash
cd d:\Github\青羽\Qingyu_backend
go build ./...
```

### 2. 运行测试
```bash
# Bookstore模块
go test ./service/bookstore/... -v

# AI模块
go test ./service/ai/... -v

# 中间件
go test ./middleware/... -v
```

### 3. 启动服务
```bash
go run main.go
```

期望输出：
```
[GIN-debug] Listening and serving HTTP on :8080
```

### 4. 健康检查
```bash
curl http://localhost:8080/health
```

期望响应：
```json
{
  "status": "ok",
  "timestamp": "2025-01-05T..."
}
```

---

## 📝 提交建议

建议分5次提交，每个任务一次：

```bash
# 提交1
git add service/bookstore/
git commit -m "fix(bookstore): 添加缺失的服务方法 GetFreeBooks 和 DecrementCommentCount"

# 提交2
git add repository/
git commit -m "fix(repository): 添加 GetStats 和 IncrementViewCount 方法，修正 BatchUpdateCategories 签名"

# 提交3
git add service/bookstore/
git commit -m "fix(bookstore): 统一 SearchBooks 方法签名和返回值"

# 提交4
git add pkg/errors/ service/ai/
git commit -m "fix(ai): 修复错误类型定义和使用"

# 提交5
git add middleware/
git commit -m "fix(middleware): 添加 CreateCORSMiddleware 工厂函数"
```

---

## 🎯 完成标准

- ✅ `go build ./...` 成功，无编译错误
- ✅ `go run main.go` 成功启动
- ✅ `/health` 端点返回正常
- ✅ 所有现有测试通过

---

**预计总耗时**: 2小时25分钟（修复） + 1小时（验证） = **3.5小时**

**文档创建时间**: 2025-10-05  
**最后更新**: 2025-10-05

