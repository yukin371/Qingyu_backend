# æç½®ä»»åŠ¡æ¸…å•

> è®°å½•å¼€å‘è¿‡ç¨‹ä¸­æš‚æ—¶æç½®çš„ä»»åŠ¡å’Œå¾…å¤„ç†é—®é¢˜
> 
> **åˆ›å»ºæ—¶é—´**: 2025-09-30  
> **æœ€åæ›´æ–°**: 2025-09-30

---

## ğŸ“Œ ä»»åŠ¡æ¦‚è§ˆ

| ID | ä»»åŠ¡åç§° | ä¼˜å…ˆçº§ | å¤æ‚åº¦ | é¢„è®¡å·¥ä½œé‡ | æç½®åŸå›  | çŠ¶æ€ |
|----|---------|--------|--------|-----------|---------|------|
| DEV-001 | BookstoreæœåŠ¡ç¼–è¯‘é”™è¯¯ä¿®å¤ | ğŸŸ¡ ä¸­ | ğŸ”´ é«˜ | 4-6h | æ¶‰åŠæ¥å£é‡æ„ | â¸ï¸ æç½® |
| DEV-002 | *(å¾…æ·»åŠ )* | - | - | - | - | - |

---

## ğŸ”´ DEV-001: BookstoreæœåŠ¡ç¼–è¯‘é”™è¯¯ä¿®å¤

### åŸºæœ¬ä¿¡æ¯

- **åˆ›å»ºæ—¥æœŸ**: 2025-09-30
- **æç½®æ—¥æœŸ**: 2025-09-30
- **è´Ÿè´£äºº**: å¾…åˆ†é…
- **ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­ç­‰
- **å¤æ‚åº¦**: ğŸ”´ é«˜
- **é¢„è®¡å·¥ä½œé‡**: 4-6å°æ—¶
- **æç½®åŸå› **: æ¶‰åŠRepositoryæ¥å£é‡æ„ï¼Œä¸å½±å“æµ‹è¯•æ¡†æ¶å»ºè®¾ä¸»çº¿

### é—®é¢˜æè¿°

Bookstoreæ¨¡å—åœ¨ç¼–è¯‘æ—¶å‡ºç°å¤šä¸ªæ¥å£ä¸åŒ¹é…å’Œæ–¹æ³•ç¼ºå¤±é”™è¯¯ï¼Œéœ€è¦ç³»ç»Ÿæ€§ä¿®å¤ã€‚

### å½±å“èŒƒå›´

```
service/bookstore/
â”œâ”€â”€ book_detail_service.go       âŒ 2ä¸ªç¼–è¯‘é”™è¯¯
â”œâ”€â”€ bookstore_service.go         âŒ 5ä¸ªç¼–è¯‘é”™è¯¯
â””â”€â”€ cached_bookstore_service.go  âŒ 2ä¸ªç¼–è¯‘é”™è¯¯
```

### è¯¦ç»†é”™è¯¯åˆ—è¡¨

#### 1. BookDetailService æ¥å£ä¸åŒ¹é…

**æ–‡ä»¶**: `service/bookstore/book_detail_service.go:96`

**é”™è¯¯ä¿¡æ¯**:
```
cannot use &BookDetailServiceImpl{â€¦} as BookDetailService value in return statement: 
*BookDetailServiceImpl does not implement BookDetailService (missing method DecrementCommentCount)
```

**é—®é¢˜åˆ†æ**:
- æ¥å£å®šä¹‰äº† `DecrementCommentCount()` æ–¹æ³•
- å®ç°ç±» `BookDetailServiceImpl` æœªå®ç°è¯¥æ–¹æ³•

**è§£å†³æ–¹æ¡ˆ**:
```go
// Option 1: æ·»åŠ ç¼ºå¤±æ–¹æ³•
func (s *BookDetailServiceImpl) DecrementCommentCount(ctx context.Context, bookID primitive.ObjectID) error {
    return s.bookDetailRepo.DecrementCommentCount(ctx, bookID)
}

// Option 2: å¦‚æœä¸éœ€è¦è¯¥åŠŸèƒ½ï¼Œä»æ¥å£ä¸­ç§»é™¤
// ä¿®æ”¹ interfaces/bookstore_service.go
type BookDetailService interface {
    // ... other methods ...
    // DecrementCommentCount(ctx context.Context, bookID primitive.ObjectID) error  // æ³¨é‡Šæˆ–åˆ é™¤
}
```

**å·¥ä½œé‡**: 0.5å°æ—¶

---

#### 2. BatchUpdateCategories å‚æ•°ä¸åŒ¹é…

**æ–‡ä»¶**: `service/bookstore/book_detail_service.go:591`

**é”™è¯¯ä¿¡æ¯**:
```
not enough arguments in call to s.bookDetailRepo.BatchUpdateCategories
have (context.Context, []primitive.ObjectID, []string)
want (context.Context, []primitive.ObjectID, primitive.ObjectID, string)
```

**é—®é¢˜åˆ†æ**:
- è°ƒç”¨æ–¹ä¼ å…¥: `(ctx, bookIDs, categories)`
- æ¥å£æœŸæœ›: `(ctx, bookIDs, categoryID, categoryName)`

**è§£å†³æ–¹æ¡ˆ**:
```go
// æ£€æŸ¥å®é™…ä¸šåŠ¡éœ€æ±‚ï¼Œç¡®å®šæ­£ç¡®çš„å‚æ•°
// Option 1: ä¿®æ”¹è°ƒç”¨ä»£ç 
for i, bookID := range bookIDs {
    err := s.bookDetailRepo.UpdateCategory(ctx, bookID, categories[i])
    if err != nil {
        return err
    }
}

// Option 2: ä¿®æ”¹æ¥å£å®šä¹‰ä»¥æ”¯æŒæ‰¹é‡å­—ç¬¦ä¸²
// repository/interfaces/bookstore/book_detail_repository.go
BatchUpdateCategories(ctx context.Context, bookIDs []primitive.ObjectID, categories []string) error
```

**å·¥ä½œé‡**: 1å°æ—¶ï¼ˆéœ€è¦ç¡®è®¤ä¸šåŠ¡é€»è¾‘ï¼‰

---

#### 3. BookstoreService æ¥å£ä¸åŒ¹é… - GetFreeBooks

**æ–‡ä»¶**: `service/bookstore/bookstore_service.go:75`

**é”™è¯¯ä¿¡æ¯**:
```
cannot use &BookstoreServiceImpl{â€¦} as BookstoreService value in return statement: 
*BookstoreServiceImpl does not implement BookstoreService (missing method GetFreeBooks)
```

**é—®é¢˜åˆ†æ**:
- æ¥å£å®šä¹‰äº† `GetFreeBooks()` æ–¹æ³•
- å®ç°ç±»æœªæä¾›è¯¥æ–¹æ³•

**è§£å†³æ–¹æ¡ˆ**:
```go
// æ·»åŠ å…è´¹ä¹¦ç±æŸ¥è¯¢æ–¹æ³•
func (s *BookstoreServiceImpl) GetFreeBooks(ctx context.Context, page, pageSize int) ([]*models.Book, int64, error) {
    filter := &models.BookFilter{
        PriceMax: 0, // ä»·æ ¼ä¸º0çš„ä¹¦ç±
        Status:   "published",
    }
    
    return s.bookRepo.FindByFilter(ctx, filter, page, pageSize)
}
```

**å·¥ä½œé‡**: 0.5å°æ—¶

---

#### 4. BookStatus ç±»å‹è½¬æ¢é”™è¯¯

**æ–‡ä»¶**: `service/bookstore/bookstore_service.go:175`

**é”™è¯¯ä¿¡æ¯**:
```
cannot use &status (value of type *string) as *BookStatus value in assignment
```

**é—®é¢˜åˆ†æ**:
- `status` å˜é‡ç±»å‹ä¸º `*string`
- ç›®æ ‡ç±»å‹ä¸º `*BookStatus` (è‡ªå®šä¹‰ç±»å‹)

**è§£å†³æ–¹æ¡ˆ**:
```go
// ç¡®è®¤ BookStatus çš„å®šä¹‰
// models/reading/bookstore/book.go
type BookStatus string

const (
    BookStatusDraft     BookStatus = "draft"
    BookStatusPublished BookStatus = "published"
    BookStatusArchived  BookStatus = "archived"
)

// ä¿®å¤ä»£ç 
var statusValue string = "published"
bookStatus := BookStatus(statusValue)  // ç±»å‹è½¬æ¢
filter.Status = &bookStatus
```

**å·¥ä½œé‡**: 0.5å°æ—¶

---

#### 5. Search æ–¹æ³•å‚æ•°ä¸åŒ¹é…

**æ–‡ä»¶**: `service/bookstore/bookstore_service.go:181`

**é”™è¯¯ä¿¡æ¯**:
```
not enough arguments in call to s.bookRepo.Search
have (context.Context, string, *BookFilter)
want (context.Context, string, int, int)
```

**é—®é¢˜åˆ†æ**:
- å½“å‰è°ƒç”¨: `Search(ctx, keyword, filter)`
- æ¥å£è¦æ±‚: `Search(ctx, keyword, page, pageSize)`

**è§£å†³æ–¹æ¡ˆ**:
```go
// Option 1: æ·»åŠ åˆ†é¡µå‚æ•°
results, total, err := s.bookRepo.Search(ctx, keyword, filter.Page, filter.PageSize)

// Option 2: ä¿®æ”¹æ¥å£ä»¥æ”¯æŒFilter
// repository/interfaces/bookstore/book_repository.go
Search(ctx context.Context, keyword string, filter *BookFilter) ([]*Book, int64, error)
```

**å·¥ä½œé‡**: 0.5å°æ—¶

---

#### 6. GetStats æ–¹æ³•ä¸å­˜åœ¨

**æ–‡ä»¶**: `service/bookstore/bookstore_service.go:195`

**é”™è¯¯ä¿¡æ¯**:
```
s.bookRepo.GetStats undefined (type BookRepository has no field or method GetStats)
```

**è§£å†³æ–¹æ¡ˆ**:
```go
// åœ¨ repository/interfaces/bookstore/book_repository.go ä¸­æ·»åŠ 
type BookRepository interface {
    // ... existing methods ...
    GetStats(ctx context.Context) (*BookStats, error)
}

// åœ¨ repository/mongodb/bookstore/book_repository.go ä¸­å®ç°
func (r *BookRepositoryImpl) GetStats(ctx context.Context) (*models.BookStats, error) {
    // å®ç°ç»Ÿè®¡é€»è¾‘
    pipeline := []bson.M{
        {"$group": bson.M{
            "_id": nil,
            "total": bson.M{"$sum": 1},
            "published": bson.M{"$sum": bson.M{
                "$cond": []interface{}{
                    bson.M{"$eq": []interface{}{"$status", "published"}},
                    1, 0,
                },
            }},
        }},
    }
    
    // ... æ‰§è¡ŒèšåˆæŸ¥è¯¢
}
```

**å·¥ä½œé‡**: 1å°æ—¶

---

#### 7. IncrementViewCount æ–¹æ³•ä¸å­˜åœ¨

**æ–‡ä»¶**: `service/bookstore/bookstore_service.go:225`

**é”™è¯¯ä¿¡æ¯**:
```
s.bookRepo.IncrementViewCount undefined
```

**è§£å†³æ–¹æ¡ˆ**:
```go
// åœ¨ BookRepository æ¥å£ä¸­æ·»åŠ 
IncrementViewCount(ctx context.Context, bookID primitive.ObjectID) error

// å®ç°
func (r *BookRepositoryImpl) IncrementViewCount(ctx context.Context, bookID primitive.ObjectID) error {
    filter := bson.M{"_id": bookID}
    update := bson.M{"$inc": bson.M{"view_count": 1}}
    
    _, err := r.collection.UpdateOne(ctx, filter, update)
    return err
}
```

**å·¥ä½œé‡**: 0.5å°æ—¶

---

#### 8. CachedBookstoreService æ¥å£ä¸åŒ¹é…

**æ–‡ä»¶**: `service/bookstore/cached_bookstore_service.go:18`

**é”™è¯¯ä¿¡æ¯**:
```
cannot use &CachedBookstoreService{â€¦} as BookstoreService value (missing method GetFreeBooks)
```

**é—®é¢˜åˆ†æ**:
- ä¸é”™è¯¯3ç›¸åŒï¼Œç¼“å­˜å±‚ä¹Ÿéœ€è¦å®ç°è¯¥æ–¹æ³•

**è§£å†³æ–¹æ¡ˆ**:
```go
func (c *CachedBookstoreService) GetFreeBooks(ctx context.Context, page, pageSize int) ([]*models.Book, int64, error) {
    // å…ˆæŸ¥ç¼“å­˜
    cacheKey := fmt.Sprintf("free_books:%d:%d", page, pageSize)
    
    if cached, found := c.cache.Get(cacheKey); found {
        return cached.([]*models.Book), 0, nil
    }
    
    // è°ƒç”¨åº•å±‚æœåŠ¡
    books, total, err := c.service.GetFreeBooks(ctx, page, pageSize)
    if err != nil {
        return nil, 0, err
    }
    
    // è®¾ç½®ç¼“å­˜
    c.cache.Set(cacheKey, books, 5*time.Minute)
    
    return books, total, nil
}
```

**å·¥ä½œé‡**: 0.5å°æ—¶

---

#### 9. SearchBooks è¿”å›å€¼ä¸åŒ¹é…

**æ–‡ä»¶**: `service/bookstore/cached_bookstore_service.go:286`

**é”™è¯¯ä¿¡æ¯**:
```
too many return values
have ([]*Book, int64, error)
want ([]*Book, error)
```

**é—®é¢˜åˆ†æ**:
- åº•å±‚æœåŠ¡è¿”å› 3 ä¸ªå€¼ï¼š`(books, total, error)`
- æ¥å£åªæœŸæœ› 2 ä¸ªå€¼ï¼š`(books, error)`

**è§£å†³æ–¹æ¡ˆ**:
```go
// Option 1: ä¿®æ”¹æ¥å£å®šä¹‰ï¼Œè¿”å›æ€»æ•°
// interfaces/bookstore_service.go
SearchBooks(ctx context.Context, keyword string, filter *BookFilter) ([]*Book, int64, error)

// Option 2: è°ƒæ•´ä»£ç ï¼Œä¸¢å¼ƒæ€»æ•°
books, _, err := c.service.SearchBooks(ctx, keyword, filter)
if err != nil {
    return nil, err
}
return books, nil
```

**å·¥ä½œé‡**: 0.5å°æ—¶

---

### ä¿®å¤è®¡åˆ’

#### é˜¶æ®µ1ï¼šæ¥å£ä¸€è‡´æ€§ä¿®å¤ï¼ˆ2å°æ—¶ï¼‰

- [ ] **ä»»åŠ¡1.1**: ç»Ÿä¸€ `BookDetailService` æ¥å£å®šä¹‰
  - æ£€æŸ¥æ¥å£æ–‡ä»¶å’Œå®ç°æ–‡ä»¶
  - è¡¥å……ç¼ºå¤±çš„ `DecrementCommentCount` æ–¹æ³•
  
- [ ] **ä»»åŠ¡1.2**: ç»Ÿä¸€ `BookstoreService` æ¥å£å®šä¹‰
  - å®ç° `GetFreeBooks` æ–¹æ³•
  - ç¡®è®¤ `SearchBooks` è¿”å›å€¼è§„èŒƒ

- [ ] **ä»»åŠ¡1.3**: ç»Ÿä¸€ `BookRepository` æ¥å£å®šä¹‰
  - æ·»åŠ  `GetStats` æ–¹æ³•
  - æ·»åŠ  `IncrementViewCount` æ–¹æ³•

#### é˜¶æ®µ2ï¼šå®ç°ç¼ºå¤±æ–¹æ³•ï¼ˆ2å°æ—¶ï¼‰

- [ ] **ä»»åŠ¡2.1**: Repositoryå±‚å®ç°
  - [ ] `BookRepository.GetStats()`
  - [ ] `BookRepository.IncrementViewCount()`
  - [ ] ä¿®æ­£ `BatchUpdateCategories` å‚æ•°

- [ ] **ä»»åŠ¡2.2**: Serviceå±‚å®ç°
  - [ ] `BookDetailServiceImpl.DecrementCommentCount()`
  - [ ] `BookstoreServiceImpl.GetFreeBooks()`
  - [ ] `CachedBookstoreService.GetFreeBooks()`

#### é˜¶æ®µ3ï¼šå‚æ•°å’Œç±»å‹ä¿®å¤ï¼ˆ1-2å°æ—¶ï¼‰

- [ ] **ä»»åŠ¡3.1**: ä¿®å¤ç±»å‹è½¬æ¢
  - [ ] `BookStatus` ç±»å‹è½¬æ¢ (é”™è¯¯4)
  
- [ ] **ä»»åŠ¡3.2**: ä¿®å¤æ–¹æ³•è°ƒç”¨
  - [ ] `BatchUpdateCategories` è°ƒç”¨ä¿®å¤ (é”™è¯¯2)
  - [ ] `Search` æ–¹æ³•å‚æ•°ä¿®å¤ (é”™è¯¯5)
  - [ ] `SearchBooks` è¿”å›å€¼ä¿®å¤ (é”™è¯¯9)

#### é˜¶æ®µ4ï¼šæµ‹è¯•éªŒè¯ï¼ˆ1å°æ—¶ï¼‰

- [ ] **ä»»åŠ¡4.1**: ç¼–è¯‘éªŒè¯
  ```bash
  go build ./service/bookstore/...
  ```

- [ ] **ä»»åŠ¡4.2**: å•å…ƒæµ‹è¯•
  ```bash
  go test ./service/bookstore/... -v
  ```

- [ ] **ä»»åŠ¡4.3**: é›†æˆæµ‹è¯•
  ```bash
  go test ./test/integration/bookstore_integration_test.go -v
  ```

---

### ä¾èµ–å…³ç³»å›¾

```
repository/interfaces/bookstore/
â”œâ”€â”€ book_repository.go
â”‚   â”œâ”€â”€ GetStats()              [éœ€è¦æ·»åŠ ]
â”‚   â”œâ”€â”€ IncrementViewCount()    [éœ€è¦æ·»åŠ ]
â”‚   â””â”€â”€ Search()                [éœ€è¦ä¿®æ”¹ç­¾å]
â”‚
â””â”€â”€ book_detail_repository.go
    â””â”€â”€ BatchUpdateCategories()  [éœ€è¦ä¿®æ”¹ç­¾å]

        â†“ ä¾èµ–

repository/mongodb/bookstore/
â”œâ”€â”€ book_repository.go          [éœ€è¦å®ç°ä¸Šè¿°æ¥å£]
â””â”€â”€ book_detail_repository.go   [éœ€è¦å®ç°ä¸Šè¿°æ¥å£]

        â†“ ä¾èµ–

service/bookstore/
â”œâ”€â”€ bookstore_service.go
â”‚   â”œâ”€â”€ GetFreeBooks()          [éœ€è¦å®ç°]
â”‚   â””â”€â”€ SearchBooks()           [éœ€è¦ä¿®æ­£è¿”å›å€¼]
â”‚
â”œâ”€â”€ book_detail_service.go
â”‚   â””â”€â”€ DecrementCommentCount() [éœ€è¦å®ç°]
â”‚
â””â”€â”€ cached_bookstore_service.go
    â””â”€â”€ GetFreeBooks()          [éœ€è¦å®ç°]
```

---

### é£é™©è¯„ä¼°

| é£é™©é¡¹ | çº§åˆ« | å½±å“ | åº”å¯¹æªæ–½ |
|-------|------|------|---------|
| æ¥å£å˜æ›´å½±å“ç°æœ‰åŠŸèƒ½ | ğŸŸ¡ ä¸­ | å¯èƒ½ç ´åç°æœ‰API | ä¿®æ”¹å‰æ£€æŸ¥è°ƒç”¨æ–¹ï¼Œæä¾›å‘åå…¼å®¹ |
| æµ‹è¯•æ•°æ®ä¸è¶³ | ğŸŸ¢ ä½ | æµ‹è¯•è¦†ç›–ä¸å…¨ | è¡¥å……æµ‹è¯•ç”¨ä¾‹ |
| Repositoryå®ç°å¤æ‚ | ğŸŸ¡ ä¸­ | å¼€å‘æ—¶é—´å»¶é•¿ | å…ˆå®ç°ç®€å•ç‰ˆæœ¬ |
| ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ | ğŸŸ¡ ä¸­ | æ•°æ®ä¸ä¸€è‡´ | æ˜ç¡®ç¼“å­˜å¤±æ•ˆç­–ç•¥ |

---

### éªŒæ”¶æ ‡å‡†

- [x] **ç¼–è¯‘é€šè¿‡**: `go build ./service/bookstore/...` æ— é”™è¯¯
- [ ] **æµ‹è¯•é€šè¿‡**: æ‰€æœ‰å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•é€šè¿‡
- [ ] **æ¥å£ä¸€è‡´**: æ‰€æœ‰Serviceå®ç°ç±»å®Œæ•´å®ç°æ¥å£
- [ ] **æ–‡æ¡£æ›´æ–°**: æ›´æ–°ç›¸å…³æ¥å£æ–‡æ¡£
- [ ] **ä»£ç å®¡æŸ¥**: é€šè¿‡å›¢é˜Ÿä»£ç å®¡æŸ¥

---

### ç›¸å…³èµ„æº

- **æ¥å£å®šä¹‰**: `repository/interfaces/bookstore/`
- **Serviceå®ç°**: `service/bookstore/`
- **æµ‹è¯•æ–‡ä»¶**: `test/service/bookstore/`
- **è®¾è®¡æ–‡æ¡£**: [ä¹¦åŸç³»ç»Ÿæµ‹è¯•è®¾è®¡](../design/testing/ä¹¦åŸç³»ç»Ÿæµ‹è¯•è®¾è®¡.md)

---

### æ›´æ–°æ—¥å¿—

**2025-09-30**
- åˆ›å»ºä»»åŠ¡ï¼Œè®°å½•9ä¸ªç¼–è¯‘é”™è¯¯
- åˆ¶å®š4é˜¶æ®µä¿®å¤è®¡åˆ’
- é¢„è®¡æ€»å·¥ä½œé‡ï¼š4-6å°æ—¶

---

## ğŸ“ æ·»åŠ æ–°ä»»åŠ¡æ¨¡æ¿

```markdown
## ğŸ”´ DEV-XXX: ä»»åŠ¡æ ‡é¢˜

### åŸºæœ¬ä¿¡æ¯
- **åˆ›å»ºæ—¥æœŸ**: YYYY-MM-DD
- **æç½®æ—¥æœŸ**: YYYY-MM-DD
- **è´Ÿè´£äºº**: å¾…åˆ†é…
- **ä¼˜å…ˆçº§**: ğŸ”´é«˜ / ğŸŸ¡ä¸­ / ğŸŸ¢ä½
- **å¤æ‚åº¦**: ğŸ”´é«˜ / ğŸŸ¡ä¸­ / ğŸŸ¢ä½
- **é¢„è®¡å·¥ä½œé‡**: Xå°æ—¶
- **æç½®åŸå› **: åŸå› è¯´æ˜

### é—®é¢˜æè¿°
è¯¦ç»†æè¿°é—®é¢˜...

### è§£å†³æ–¹æ¡ˆ
æå‡ºçš„è§£å†³æ–¹æ¡ˆ...

### ä¿®å¤è®¡åˆ’
- [ ] ä»»åŠ¡1
- [ ] ä»»åŠ¡2

### éªŒæ”¶æ ‡å‡†
- [ ] æ ‡å‡†1
- [ ] æ ‡å‡†2
```

---

*æœ¬æ–‡æ¡£æŒç»­æ›´æ–°ä¸­... ğŸ“Œ*
