# 搁置任务清单

> 记录开发过程中暂时搁置的任务和待处理问题
> 
> **创建时间**: 2025-09-30  
> **最后更新**: 2025-09-30

---

## 📌 任务概览

| ID | 任务名称 | 优先级 | 复杂度 | 预计工作量 | 搁置原因 | 状态 |
|----|---------|--------|--------|-----------|---------|------|
| DEV-001 | Bookstore服务编译错误修复 | 🟡 中 | 🔴 高 | 4-6h | 涉及接口重构 | ⏸️ 搁置 |
| DEV-002 | *(待添加)* | - | - | - | - | - |

---

## 🔴 DEV-001: Bookstore服务编译错误修复

### 基本信息

- **创建日期**: 2025-09-30
- **搁置日期**: 2025-09-30
- **负责人**: 待分配
- **优先级**: 🟡 中等
- **复杂度**: 🔴 高
- **预计工作量**: 4-6小时
- **搁置原因**: 涉及Repository接口重构，不影响测试框架建设主线

### 问题描述

Bookstore模块在编译时出现多个接口不匹配和方法缺失错误，需要系统性修复。

### 影响范围

```
service/bookstore/
├── book_detail_service.go       ❌ 2个编译错误
├── bookstore_service.go         ❌ 5个编译错误
└── cached_bookstore_service.go  ❌ 2个编译错误
```

### 详细错误列表

#### 1. BookDetailService 接口不匹配

**文件**: `service/bookstore/book_detail_service.go:96`

**错误信息**:
```
cannot use &BookDetailServiceImpl{…} as BookDetailService value in return statement: 
*BookDetailServiceImpl does not implement BookDetailService (missing method DecrementCommentCount)
```

**问题分析**:
- 接口定义了 `DecrementCommentCount()` 方法
- 实现类 `BookDetailServiceImpl` 未实现该方法

**解决方案**:
```go
// Option 1: 添加缺失方法
func (s *BookDetailServiceImpl) DecrementCommentCount(ctx context.Context, bookID primitive.ObjectID) error {
    return s.bookDetailRepo.DecrementCommentCount(ctx, bookID)
}

// Option 2: 如果不需要该功能，从接口中移除
// 修改 interfaces/bookstore_service.go
type BookDetailService interface {
    // ... other methods ...
    // DecrementCommentCount(ctx context.Context, bookID primitive.ObjectID) error  // 注释或删除
}
```

**工作量**: 0.5小时

---

#### 2. BatchUpdateCategories 参数不匹配

**文件**: `service/bookstore/book_detail_service.go:591`

**错误信息**:
```
not enough arguments in call to s.bookDetailRepo.BatchUpdateCategories
have (context.Context, []primitive.ObjectID, []string)
want (context.Context, []primitive.ObjectID, primitive.ObjectID, string)
```

**问题分析**:
- 调用方传入: `(ctx, bookIDs, categories)`
- 接口期望: `(ctx, bookIDs, categoryID, categoryName)`

**解决方案**:
```go
// 检查实际业务需求，确定正确的参数
// Option 1: 修改调用代码
for i, bookID := range bookIDs {
    err := s.bookDetailRepo.UpdateCategory(ctx, bookID, categories[i])
    if err != nil {
        return err
    }
}

// Option 2: 修改接口定义以支持批量字符串
// repository/interfaces/bookstore/book_detail_repository.go
BatchUpdateCategories(ctx context.Context, bookIDs []primitive.ObjectID, categories []string) error
```

**工作量**: 1小时（需要确认业务逻辑）

---

#### 3. BookstoreService 接口不匹配 - GetFreeBooks

**文件**: `service/bookstore/bookstore_service.go:75`

**错误信息**:
```
cannot use &BookstoreServiceImpl{…} as BookstoreService value in return statement: 
*BookstoreServiceImpl does not implement BookstoreService (missing method GetFreeBooks)
```

**问题分析**:
- 接口定义了 `GetFreeBooks()` 方法
- 实现类未提供该方法

**解决方案**:
```go
// 添加免费书籍查询方法
func (s *BookstoreServiceImpl) GetFreeBooks(ctx context.Context, page, pageSize int) ([]*models.Book, int64, error) {
    filter := &models.BookFilter{
        PriceMax: 0, // 价格为0的书籍
        Status:   "published",
    }
    
    return s.bookRepo.FindByFilter(ctx, filter, page, pageSize)
}
```

**工作量**: 0.5小时

---

#### 4. BookStatus 类型转换错误

**文件**: `service/bookstore/bookstore_service.go:175`

**错误信息**:
```
cannot use &status (value of type *string) as *BookStatus value in assignment
```

**问题分析**:
- `status` 变量类型为 `*string`
- 目标类型为 `*BookStatus` (自定义类型)

**解决方案**:
```go
// 确认 BookStatus 的定义
// models/reading/bookstore/book.go
type BookStatus string

const (
    BookStatusDraft     BookStatus = "draft"
    BookStatusPublished BookStatus = "published"
    BookStatusArchived  BookStatus = "archived"
)

// 修复代码
var statusValue string = "published"
bookStatus := BookStatus(statusValue)  // 类型转换
filter.Status = &bookStatus
```

**工作量**: 0.5小时

---

#### 5. Search 方法参数不匹配

**文件**: `service/bookstore/bookstore_service.go:181`

**错误信息**:
```
not enough arguments in call to s.bookRepo.Search
have (context.Context, string, *BookFilter)
want (context.Context, string, int, int)
```

**问题分析**:
- 当前调用: `Search(ctx, keyword, filter)`
- 接口要求: `Search(ctx, keyword, page, pageSize)`

**解决方案**:
```go
// Option 1: 添加分页参数
results, total, err := s.bookRepo.Search(ctx, keyword, filter.Page, filter.PageSize)

// Option 2: 修改接口以支持Filter
// repository/interfaces/bookstore/book_repository.go
Search(ctx context.Context, keyword string, filter *BookFilter) ([]*Book, int64, error)
```

**工作量**: 0.5小时

---

#### 6. GetStats 方法不存在

**文件**: `service/bookstore/bookstore_service.go:195`

**错误信息**:
```
s.bookRepo.GetStats undefined (type BookRepository has no field or method GetStats)
```

**解决方案**:
```go
// 在 repository/interfaces/bookstore/book_repository.go 中添加
type BookRepository interface {
    // ... existing methods ...
    GetStats(ctx context.Context) (*BookStats, error)
}

// 在 repository/mongodb/bookstore/book_repository.go 中实现
func (r *BookRepositoryImpl) GetStats(ctx context.Context) (*models.BookStats, error) {
    // 实现统计逻辑
    pipeline := []bson.M{
        {"$group": bson.M{
            "_id": nil,
            "total": bson.M{"$sum": 1},
            "published": bson.M{"$sum": bson.M{
                "$cond": []interface{}{
                    bson.M{"$eq": []interface{}{"$status", "published"}},
                    1, 0,
                },
            }},
        }},
    }
    
    // ... 执行聚合查询
}
```

**工作量**: 1小时

---

#### 7. IncrementViewCount 方法不存在

**文件**: `service/bookstore/bookstore_service.go:225`

**错误信息**:
```
s.bookRepo.IncrementViewCount undefined
```

**解决方案**:
```go
// 在 BookRepository 接口中添加
IncrementViewCount(ctx context.Context, bookID primitive.ObjectID) error

// 实现
func (r *BookRepositoryImpl) IncrementViewCount(ctx context.Context, bookID primitive.ObjectID) error {
    filter := bson.M{"_id": bookID}
    update := bson.M{"$inc": bson.M{"view_count": 1}}
    
    _, err := r.collection.UpdateOne(ctx, filter, update)
    return err
}
```

**工作量**: 0.5小时

---

#### 8. CachedBookstoreService 接口不匹配

**文件**: `service/bookstore/cached_bookstore_service.go:18`

**错误信息**:
```
cannot use &CachedBookstoreService{…} as BookstoreService value (missing method GetFreeBooks)
```

**问题分析**:
- 与错误3相同，缓存层也需要实现该方法

**解决方案**:
```go
func (c *CachedBookstoreService) GetFreeBooks(ctx context.Context, page, pageSize int) ([]*models.Book, int64, error) {
    // 先查缓存
    cacheKey := fmt.Sprintf("free_books:%d:%d", page, pageSize)
    
    if cached, found := c.cache.Get(cacheKey); found {
        return cached.([]*models.Book), 0, nil
    }
    
    // 调用底层服务
    books, total, err := c.service.GetFreeBooks(ctx, page, pageSize)
    if err != nil {
        return nil, 0, err
    }
    
    // 设置缓存
    c.cache.Set(cacheKey, books, 5*time.Minute)
    
    return books, total, nil
}
```

**工作量**: 0.5小时

---

#### 9. SearchBooks 返回值不匹配

**文件**: `service/bookstore/cached_bookstore_service.go:286`

**错误信息**:
```
too many return values
have ([]*Book, int64, error)
want ([]*Book, error)
```

**问题分析**:
- 底层服务返回 3 个值：`(books, total, error)`
- 接口只期望 2 个值：`(books, error)`

**解决方案**:
```go
// Option 1: 修改接口定义，返回总数
// interfaces/bookstore_service.go
SearchBooks(ctx context.Context, keyword string, filter *BookFilter) ([]*Book, int64, error)

// Option 2: 调整代码，丢弃总数
books, _, err := c.service.SearchBooks(ctx, keyword, filter)
if err != nil {
    return nil, err
}
return books, nil
```

**工作量**: 0.5小时

---

### 修复计划

#### 阶段1：接口一致性修复（2小时）

- [ ] **任务1.1**: 统一 `BookDetailService` 接口定义
  - 检查接口文件和实现文件
  - 补充缺失的 `DecrementCommentCount` 方法
  
- [ ] **任务1.2**: 统一 `BookstoreService` 接口定义
  - 实现 `GetFreeBooks` 方法
  - 确认 `SearchBooks` 返回值规范

- [ ] **任务1.3**: 统一 `BookRepository` 接口定义
  - 添加 `GetStats` 方法
  - 添加 `IncrementViewCount` 方法

#### 阶段2：实现缺失方法（2小时）

- [ ] **任务2.1**: Repository层实现
  - [ ] `BookRepository.GetStats()`
  - [ ] `BookRepository.IncrementViewCount()`
  - [ ] 修正 `BatchUpdateCategories` 参数

- [ ] **任务2.2**: Service层实现
  - [ ] `BookDetailServiceImpl.DecrementCommentCount()`
  - [ ] `BookstoreServiceImpl.GetFreeBooks()`
  - [ ] `CachedBookstoreService.GetFreeBooks()`

#### 阶段3：参数和类型修复（1-2小时）

- [ ] **任务3.1**: 修复类型转换
  - [ ] `BookStatus` 类型转换 (错误4)
  
- [ ] **任务3.2**: 修复方法调用
  - [ ] `BatchUpdateCategories` 调用修复 (错误2)
  - [ ] `Search` 方法参数修复 (错误5)
  - [ ] `SearchBooks` 返回值修复 (错误9)

#### 阶段4：测试验证（1小时）

- [ ] **任务4.1**: 编译验证
  ```bash
  go build ./service/bookstore/...
  ```

- [ ] **任务4.2**: 单元测试
  ```bash
  go test ./service/bookstore/... -v
  ```

- [ ] **任务4.3**: 集成测试
  ```bash
  go test ./test/integration/bookstore_integration_test.go -v
  ```

---

### 依赖关系图

```
repository/interfaces/bookstore/
├── book_repository.go
│   ├── GetStats()              [需要添加]
│   ├── IncrementViewCount()    [需要添加]
│   └── Search()                [需要修改签名]
│
└── book_detail_repository.go
    └── BatchUpdateCategories()  [需要修改签名]

        ↓ 依赖

repository/mongodb/bookstore/
├── book_repository.go          [需要实现上述接口]
└── book_detail_repository.go   [需要实现上述接口]

        ↓ 依赖

service/bookstore/
├── bookstore_service.go
│   ├── GetFreeBooks()          [需要实现]
│   └── SearchBooks()           [需要修正返回值]
│
├── book_detail_service.go
│   └── DecrementCommentCount() [需要实现]
│
└── cached_bookstore_service.go
    └── GetFreeBooks()          [需要实现]
```

---

### 风险评估

| 风险项 | 级别 | 影响 | 应对措施 |
|-------|------|------|---------|
| 接口变更影响现有功能 | 🟡 中 | 可能破坏现有API | 修改前检查调用方，提供向后兼容 |
| 测试数据不足 | 🟢 低 | 测试覆盖不全 | 补充测试用例 |
| Repository实现复杂 | 🟡 中 | 开发时间延长 | 先实现简单版本 |
| 缓存一致性问题 | 🟡 中 | 数据不一致 | 明确缓存失效策略 |

---

### 验收标准

- [x] **编译通过**: `go build ./service/bookstore/...` 无错误
- [ ] **测试通过**: 所有单元测试和集成测试通过
- [ ] **接口一致**: 所有Service实现类完整实现接口
- [ ] **文档更新**: 更新相关接口文档
- [ ] **代码审查**: 通过团队代码审查

---

### 相关资源

- **接口定义**: `repository/interfaces/bookstore/`
- **Service实现**: `service/bookstore/`
- **测试文件**: `test/service/bookstore/`
- **设计文档**: [书城系统测试设计](../design/testing/书城系统测试设计.md)

---

### 更新日志

**2025-09-30**
- 创建任务，记录9个编译错误
- 制定4阶段修复计划
- 预计总工作量：4-6小时

---

## 📝 添加新任务模板

```markdown
## 🔴 DEV-XXX: 任务标题

### 基本信息
- **创建日期**: YYYY-MM-DD
- **搁置日期**: YYYY-MM-DD
- **负责人**: 待分配
- **优先级**: 🔴高 / 🟡中 / 🟢低
- **复杂度**: 🔴高 / 🟡中 / 🟢低
- **预计工作量**: X小时
- **搁置原因**: 原因说明

### 问题描述
详细描述问题...

### 解决方案
提出的解决方案...

### 修复计划
- [ ] 任务1
- [ ] 任务2

### 验收标准
- [ ] 标准1
- [ ] 标准2
```

---

*本文档持续更新中... 📌*
