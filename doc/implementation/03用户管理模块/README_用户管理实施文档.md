# 用户管理模块实施文档

## 文档概述

本文档跟踪和记录青羽平台用户管理模块的完整实施过程，包括用户认证、权限管理、个人资料管理等功能。

## 项目背景

### 目标
实现完整的用户管理系统，包括注册、登录、权限控制、角色管理等核心功能，为平台提供用户体系支持。

### 实施范围

| 功能 | 状态 | 说明 |
|------|------|------|
| 用户注册登录 | ⏸️ 待开始 | 邮箱注册、密码登录、第三方登录 |
| JWT认证 | ⏸️ 待开始 | Token生成、验证、刷新 |
| 权限管理 | ⏸️ 待开始 | RBAC权限模型、角色管理 |
| 个人资料 | ⏸️ 待开始 | 资料查看、编辑、头像上传 |
| 文件上传 | ⏸️ 待开始 | MinIO集成、图片处理 |

---

## 实施阶段

### 阶段1：用户Model与Repository（预计2天，2025.09.26-09.27）

**整体进度**: 0% (0/4任务)  
**计划开始**: 2025年9月26日  
**计划完成**: 2025年9月27日

#### 任务1.1：User模型定义（0.5天）
- [ ] 模型结构设计
  - [ ] 基础字段（ID、用户名、邮箱、密码）
  - [ ] 角色字段（Reader、Writer、Admin）
  - [ ] 状态字段（激活、禁用）
  - [ ] 时间戳字段
- [ ] 验证规则
  - [ ] 邮箱格式验证
  - [ ] 密码强度验证
  - [ ] 用户名唯一性
- [ ] 辅助方法
  - [ ] BeforeCreate钩子
  - [ ] 密码哈希方法
  - [ ] 密码验证方法

**预期交付物**:
- ✅ User模型定义
- ✅ 验证规则完整
- ✅ 单元测试

**预计工作量**: 4小时

#### 任务1.2：UserRepository接口定义（0.5天）
- [ ] 接口设计
  - [ ] Create（创建用户）
  - [ ] GetByID（根据ID查询）
  - [ ] GetByEmail（根据邮箱查询）
  - [ ] GetByUsername（根据用户名查询）
  - [ ] Update（更新用户信息）
  - [ ] Delete（删除用户）
  - [ ] List（用户列表）
  - [ ] UpdatePassword（更新密码）
  - [ ] UpdateRole（更新角色）

**预期交付物**:
- ✅ Repository接口定义
- ✅ 接口文档
- ✅ 错误类型定义

**预计工作量**: 4小时

#### 任务1.3：MongoDB实现（0.5天）
- [ ] Repository实现
  - [ ] 实现所有接口方法
  - [ ] 错误处理
  - [ ] 查询优化
- [ ] 索引创建
  - [ ] 邮箱唯一索引
  - [ ] 用户名唯一索引
  - [ ] 角色索引
- [ ] 事务支持
  - [ ] 用户创建事务
  - [ ] 批量操作事务

**预期交付物**:
- ✅ MongoDB实现代码
- ✅ 索引脚本
- ✅ 性能测试

**预计工作量**: 4小时

#### 任务1.4：Repository单元测试（0.5天）
- [ ] 测试用例编写
  - [ ] CRUD操作测试
  - [ ] 唯一性约束测试
  - [ ] 并发安全测试
  - [ ] 边界条件测试
- [ ] Mock数据准备
  - [ ] 测试用户数据
  - [ ] 边界数据
- [ ] 测试覆盖率
  - [ ] 目标：≥90%

**预期交付物**:
- ✅ 完整单元测试
- ✅ 测试覆盖率报告
- ✅ 测试文档

**预计工作量**: 4小时

**里程碑**: Model与Repository完成（2025.09.27）

---

### 阶段2：UserService业务逻辑（预计2天，2025.09.28-09.29）

**整体进度**: 0% (0/4任务)

#### 任务2.1：UserService接口设计（0.5天）
- [ ] 服务接口定义
  - [ ] Register（用户注册）
  - [ ] Login（用户登录）
  - [ ] GetProfile（获取个人资料）
  - [ ] UpdateProfile（更新个人资料）
  - [ ] ChangePassword（修改密码）
  - [ ] ResetPassword（重置密码）
  - [ ] UploadAvatar（上传头像）
- [ ] DTO设计
  - [ ] RegisterRequest
  - [ ] LoginRequest
  - [ ] UpdateProfileRequest
  - [ ] UserResponse

**预期交付物**:
- ✅ Service接口定义
- ✅ DTO结构体
- ✅ 接口文档

**预计工作量**: 4小时

#### 任务2.2：认证逻辑实现（0.5天）
- [ ] 注册逻辑
  - [ ] 邮箱验证
  - [ ] 密码强度检查
  - [ ] 密码哈希（bcrypt）
  - [ ] 默认角色分配
- [ ] 登录逻辑
  - [ ] 用户验证
  - [ ] 密码验证
  - [ ] 登录失败次数限制
  - [ ] 最后登录时间更新
- [ ] Token生成
  - [ ] Access Token生成
  - [ ] Refresh Token生成
  - [ ] Token存储（Redis）

**预期交付物**:
- ✅ 注册功能实现
- ✅ 登录功能实现
- ✅ Token管理

**预计工作量**: 4小时

#### 任务2.3：个人资料管理（0.5天）
- [ ] 资料查询
  - [ ] 获取个人资料
  - [ ] 敏感信息过滤
- [ ] 资料更新
  - [ ] 昵称修改
  - [ ] 个人简介
  - [ ] 联系方式
  - [ ] 并发更新处理
- [ ] 密码管理
  - [ ] 修改密码（需旧密码验证）
  - [ ] 重置密码（邮箱验证）
  - [ ] 密码历史检查

**预期交付物**:
- ✅ 资料管理功能
- ✅ 密码管理功能
- ✅ 业务逻辑测试

**预计工作量**: 4小时

#### 任务2.4：Service单元测试（0.5天）
- [ ] 测试用例
  - [ ] 注册流程测试
  - [ ] 登录流程测试
  - [ ] 资料更新测试
  - [ ] 密码管理测试
  - [ ] 异常场景测试
- [ ] Mock Repository
  - [ ] 使用testify/mock
  - [ ] 设置期望行为
- [ ] 测试覆盖率
  - [ ] 目标：≥85%

**预期交付物**:
- ✅ 完整单元测试
- ✅ 测试覆盖率≥85%
- ✅ 测试文档

**预计工作量**: 4小时

**里程碑**: UserService完成（2025.09.29）

---

### 阶段3：JWT认证系统（预计2天，2025.09.30-10.01）

**整体进度**: 0% (0/4任务)

#### 任务3.1：JWT工具实现（0.5天）
- [ ] Token生成
  - [ ] GenerateAccessToken
  - [ ] GenerateRefreshToken
  - [ ] Claims结构设计
- [ ] Token验证
  - [ ] ValidateToken
  - [ ] ParseToken
  - [ ] 过期检查
- [ ] Token刷新
  - [ ] RefreshAccessToken
  - [ ] Refresh Token轮换
- [ ] Token管理
  - [ ] Token存储（Redis）
  - [ ] Token撤销（黑名单）
  - [ ] Token清理

**预期交付物**:
- ✅ JWT工具包
- ✅ Token管理功能
- ✅ 单元测试

**预计工作量**: 4小时

#### 任务3.2：认证中间件完善（0.5天）
- [ ] JWT中间件
  - [ ] Token提取
  - [ ] Token验证
  - [ ] 用户信息注入上下文
  - [ ] 过期处理
- [ ] 权限中间件
  - [ ] 角色检查
  - [ ] 权限检查
  - [ ] 资源所有权检查
- [ ] 可选认证
  - [ ] 支持匿名访问
  - [ ] 已登录用户优先

**预期交付物**:
- ✅ 完善的认证中间件
- ✅ 权限中间件
- ✅ 中间件测试

**预计工作量**: 4小时

#### 任务3.3：角色权限系统（0.5天）
- [ ] 角色定义
  - [ ] Reader（普通读者）
  - [ ] Writer（作者）
  - [ ] VIPReader（VIP读者）
  - [ ] Admin（管理员）
- [ ] 权限定义
  - [ ] 资源权限
  - [ ] 操作权限
  - [ ] 权限继承
- [ ] 权限检查
  - [ ] CheckPermission方法
  - [ ] 权限验证中间件
  - [ ] 动态权限加载

**预期交付物**:
- ✅ RBAC系统实现
- ✅ 权限检查功能
- ✅ 权限测试

**预计工作量**: 4小时

#### 任务3.4：认证流程测试（0.5天）
- [ ] 集成测试
  - [ ] 完整认证流程测试
  - [ ] Token刷新流程测试
  - [ ] 权限验证测试
- [ ] 安全测试
  - [ ] Token篡改测试
  - [ ] 过期Token测试
  - [ ] 权限越权测试
- [ ] 性能测试
  - [ ] Token验证性能
  - [ ] 并发认证测试

**预期交付物**:
- ✅ 集成测试用例
- ✅ 安全测试报告
- ✅ 性能测试报告

**预计工作量**: 4小时

**里程碑**: JWT认证系统完成（2025.10.01）

---

### 阶段4：文件存储服务（预计1天，2025.10.02）

**整体进度**: 0% (0/2任务)

#### 任务4.1：MinIO集成（0.5天）
- [ ] MinIO配置
  - [ ] 连接配置
  - [ ] Bucket创建
  - [ ] 访问策略设置
- [ ] 文件上传
  - [ ] UploadFile接口
  - [ ] 文件类型验证
  - [ ] 文件大小限制
  - [ ] 文件名生成（UUID）
- [ ] 文件下载
  - [ ] DownloadFile接口
  - [ ] 预签名URL生成
  - [ ] 临时访问链接
- [ ] 文件管理
  - [ ] 文件列表
  - [ ] 文件删除
  - [ ] 文件信息查询

**预期交付物**:
- ✅ MinIO集成完成
- ✅ 文件操作API
- ✅ 单元测试

**预计工作量**: 4小时

#### 任务4.2：图片处理（0.5天）
- [ ] 头像上传
  - [ ] 图片格式验证
  - [ ] 图片大小限制（5MB）
  - [ ] 图片裁剪
  - [ ] 缩略图生成
- [ ] 图片优化
  - [ ] 格式转换（WebP）
  - [ ] 质量压缩
  - [ ] 尺寸调整
- [ ] CDN集成（可选）
  - [ ] CDN URL生成
  - [ ] 缓存策略

**预期交付物**:
- ✅ 图片处理功能
- ✅ 头像上传API
- ✅ 测试用例

**预计工作量**: 4小时

**里程碑**: 文件存储服务完成（2025.10.02）

---

### 阶段5：API层与前端集成（预计3天，2025.10.03-10.05）

**整体进度**: 0% (0/3任务)

#### 任务5.1：用户API实现（1天）
- [ ] 认证API
  - [ ] POST /api/auth/register（注册）
  - [ ] POST /api/auth/login（登录）
  - [ ] POST /api/auth/logout（登出）
  - [ ] POST /api/auth/refresh（刷新Token）
  - [ ] POST /api/auth/forgot-password（忘记密码）
- [ ] 用户API
  - [ ] GET /api/users/profile（获取个人资料）
  - [ ] PUT /api/users/profile（更新个人资料）
  - [ ] PUT /api/users/password（修改密码）
  - [ ] POST /api/users/avatar（上传头像）
- [ ] 参数验证
  - [ ] 请求体验证
  - [ ] 参数格式检查
  - [ ] 业务规则验证

**预期交付物**:
- ✅ 9个用户相关API
- ✅ 完整的参数验证
- ✅ API文档（Swagger）

**预计工作量**: 8小时

#### 任务5.2：前端用户模块（2天）
- [ ] 登录注册页面
  - [ ] 登录表单组件
  - [ ] 注册表单组件
  - [ ] 表单验证
  - [ ] 错误提示
- [ ] 个人中心页面
  - [ ] 资料展示
  - [ ] 资料编辑表单
  - [ ] 头像上传组件
  - [ ] 密码修改表单
- [ ] 状态管理
  - [ ] Auth Store（Pinia）
  - [ ] 用户信息存储
  - [ ] Token管理
  - [ ] 登录状态持久化
- [ ] 路由守卫
  - [ ] 认证守卫
  - [ ] 角色守卫
  - [ ] 重定向处理

**预期交付物**:
- ✅ 完整的前端用户模块
- ✅ 登录注册功能
- ✅ 个人中心功能
- ✅ 状态管理

**预计工作量**: 16小时

**里程碑**: API层与前端集成完成（2025.10.05）

---

## 总体进度概览

| 阶段 | 任务数 | 完成 | 进度 | 预计完成日期 |
|------|--------|------|------|-------------|
| 阶段1：Model & Repository | 4 | 0 | 0% | 2025.09.27 |
| 阶段2：Service业务逻辑 | 4 | 0 | 0% | 2025.09.29 |
| 阶段3：JWT认证系统 | 4 | 0 | 0% | 2025.10.01 |
| 阶段4：文件存储服务 | 2 | 0 | 0% | 2025.10.02 |
| 阶段5：API层与前端 | 2 | 0 | 0% | 2025.10.05 |
| **总计** | **16** | **0** | **0%** | **2025.10.05** |

**总预计工作量**: 80小时（10个工作日）

---

## 技术栈

### 后端技术
- **Go**: 1.21+
- **Gin**: Web框架
- **MongoDB**: 用户数据存储
- **Redis**: Token存储、会话管理
- **JWT**: 身份认证
- **bcrypt**: 密码加密
- **MinIO**: 文件存储

### 前端技术
- **Vue 3**: 前端框架
- **Pinia**: 状态管理
- **Vue Router**: 路由管理
- **Element Plus**: UI组件
- **Axios**: HTTP客户端

---

## 项目结构

### 后端结构
```
Qingyu_backend/
├── models/
│   └── users/
│       ├── user.go              # User模型
│       └── user_test.go         # 模型测试
├── repository/
│   ├── interfaces/
│   │   └── user_repository.go  # Repository接口
│   └── mongodb/
│       ├── user_repository.go  # MongoDB实现
│       └── user_repository_test.go
├── service/
│   ├── interfaces/
│   │   └── user_service.go     # Service接口
│   └── user/
│       ├── user_service.go     # Service实现
│       ├── user_service_test.go
│       └── dto.go              # DTO定义
├── api/v1/
│   └── users/
│       ├── auth_api.go         # 认证API
│       ├── user_api.go         # 用户API
│       └── validator.go        # 参数验证
├── middleware/
│   ├── auth_middleware.go      # 认证中间件
│   └── permission.go           # 权限中间件
├── pkg/
│   ├── jwt/
│   │   ├── jwt.go              # JWT工具
│   │   └── jwt_test.go
│   └── upload/
│       ├── minio.go            # MinIO工具
│       └── image.go            # 图片处理
└── router/
    └── users/
        └── user_router.go      # 用户路由
```

### 前端结构
```
Qingyu/
├── src/
│   ├── api/
│   │   ├── auth.js             # 认证API
│   │   └── user.js             # 用户API
│   ├── stores/
│   │   └── auth.js             # 认证状态
│   ├── views/
│   │   ├── auth/
│   │   │   ├── Login.vue       # 登录页
│   │   │   └── Register.vue    # 注册页
│   │   └── user/
│   │       └── Profile.vue     # 个人中心
│   ├── components/
│   │   └── user/
│   │       ├── AvatarUpload.vue # 头像上传
│   │       └── PasswordForm.vue # 密码表单
│   └── router/
│       ├── guards.js           # 路由守卫
│       └── index.js            # 路由配置
```

---

## 质量标准

### 代码质量
- [ ] 单元测试覆盖率≥85%
- [ ] Repository层测试≥90%
- [ ] Service层测试≥85%
- [ ] API层测试≥70%
- [ ] 0 Linter错误

### 安全标准
- [ ] 密码bcrypt加密（cost=12）
- [ ] JWT Token安全配置
- [ ] 敏感数据脱敏
- [ ] SQL注入防护
- [ ] XSS防护

### 性能标准
- [ ] 注册接口：<500ms
- [ ] 登录接口：<300ms
- [ ] Token验证：<10ms
- [ ] 文件上传：>1MB/s

---

## 风险与应对

### 风险1：密码安全性
**风险描述**: 密码存储不当可能导致用户数据泄露

**应对措施**:
- 使用bcrypt加密（cost=12）
- 密码强度验证
- 密码历史检查
- 定期安全审计

### 风险2：Token管理
**风险描述**: Token泄露或被盗用

**应对措施**:
- Access Token短期有效（2小时）
- Refresh Token长期有效（7天）
- Token黑名单机制
- 异常登录检测

### 风险3：文件上传安全
**风险描述**: 恶意文件上传、文件过大

**应对措施**:
- 文件类型白名单
- 文件大小限制
- 文件内容检测
- 病毒扫描（可选）

---

## 里程碑检查点

| 里程碑 | 日期 | 检查内容 | 状态 |
|--------|------|----------|------|
| **Model & Repository完成** | 2025.09.27 | 模型定义、Repository实现、单元测试 | ⏸️ 待开始 |
| **Service业务逻辑完成** | 2025.09.29 | 注册登录、资料管理、单元测试 | ⏸️ 待开始 |
| **JWT认证系统完成** | 2025.10.01 | Token管理、权限系统、集成测试 | ⏸️ 待开始 |
| **文件存储服务完成** | 2025.10.02 | MinIO集成、图片处理 | ⏸️ 待开始 |
| **用户系统完成** | 2025.10.09 | API完成、前端集成、功能测试通过 | ⏸️ 待开始 |

---

## 测试计划

### 单元测试
- [ ] User模型测试
- [ ] UserRepository测试
- [ ] UserService测试
- [ ] JWT工具测试
- [ ] 中间件测试

### 集成测试
- [ ] 注册→登录流程测试
- [ ] Token刷新流程测试
- [ ] 资料更新流程测试
- [ ] 文件上传流程测试

### 安全测试
- [ ] 密码安全测试
- [ ] Token安全测试
- [ ] 权限越权测试
- [ ] 文件上传安全测试

### 性能测试
- [ ] 登录接口性能测试
- [ ] Token验证性能测试
- [ ] 并发注册测试
- [ ] 文件上传性能测试

---

## 相关文档

### 设计文档
- [用户管理系统设计](../../design/platform/用户管理系统设计.md)
- [JWT身份认证设计](../../design/core/JWT身份认证设计.md)
- [账号权限系统设计](../../design/shared/账号权限系统设计.md)

### API文档
- [用户API接口文档](../../api/system/)

### 实施文档
- [整体实施规划](../青羽平台整体实施规划.md)
- [基础设施实施](../02基础设施/)

---

## 更新日志

### 2025-10-11
- 📄 创建用户管理模块实施文档
- 📋 规划5个阶段、16个任务
- 📅 制定详细时间表（2025.09.26-10.09）

---

**文档版本**: v1.0  
**创建日期**: 2025年10月11日  
**最后更新**: 2025年10月11日  
**项目状态**: ⏸️ 待开始  
**预计开始**: 2025年9月26日  
**预计完成**: 2025年10月9日

