# Rediså®¢æˆ·ç«¯é›†æˆå®æ–½æŠ¥å‘Š

**ä»»åŠ¡ç¼–å·**: Phase1-Task1  
**å®æ–½æ—¥æœŸ**: 2025-10-24  
**è´Ÿè´£äºº**: yukin371  
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜  

---

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

ä¸ºé’ç¾½å†™ä½œåç«¯æœåŠ¡é›†æˆRediså®¢æˆ·ç«¯ï¼Œæä¾›ç¼“å­˜ã€ä¼šè¯ç®¡ç†ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰åŸºç¡€è®¾æ–½æ”¯æŒã€‚

### å®æ–½ç›®æ ‡

- âœ… åˆ›å»ºRedisé…ç½®ç®¡ç†
- âœ… å°è£…Rediså®¢æˆ·ç«¯ï¼ˆåŸºäºgo-redis/redis/v8ï¼‰
- âœ… é›†æˆåˆ°æœåŠ¡å®¹å™¨
- âœ… æä¾›å®Œæ•´çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
- âœ… æ›´æ–°é…ç½®æ–‡ä»¶

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. é…ç½®å±‚ (`config/redis.go`)

**æ ¸å¿ƒåŠŸèƒ½**:
- Redisè¿æ¥é…ç½®ï¼ˆåœ°å€ã€ç«¯å£ã€å¯†ç ã€DBï¼‰
- è¿æ¥æ± é…ç½®ï¼ˆå¤§å°ã€ç©ºé—²è¿æ¥æ•°ï¼‰
- è¶…æ—¶é…ç½®ï¼ˆè¿æ¥ã€è¯»å†™ã€è¿æ¥æ± ï¼‰
- é‡è¯•é…ç½®ï¼ˆæ¬¡æ•°ã€é—´éš”ï¼‰

**å…³é”®ç»“æ„**:

```go
type RedisConfig struct {
    // è¿æ¥é…ç½®
    Host     string
    Port     int
    Password string
    DB       int

    // è¿æ¥æ± é…ç½®
    PoolSize     int
    MinIdleConns int
    MaxIdleConns int

    // è¶…æ—¶é…ç½®
    DialTimeout  time.Duration
    ReadTimeout  time.Duration
    WriteTimeout time.Duration
    PoolTimeout  time.Duration

    // é‡è¯•é…ç½®
    MaxRetries      int
    MinRetryBackoff time.Duration
    MaxRetryBackoff time.Duration
}
```

**é»˜è®¤é…ç½®**:
- Host: localhost
- Port: 6379
- DB: 0
- PoolSize: 10
- è¿æ¥è¶…æ—¶: 5s
- è¯»å†™è¶…æ—¶: 3s

---

### 2. å®¢æˆ·ç«¯å°è£… (`pkg/cache/redis_client.go`)

**æ¥å£è®¾è®¡**:

```go
type RedisClient interface {
    // åŸºç¡€æ“ä½œ
    Get(ctx context.Context, key string) (string, error)
    Set(ctx context.Context, key string, value interface{}, expiration time.Duration) error
    Delete(ctx context.Context, keys ...string) error
    Exists(ctx context.Context, keys ...string) (int64, error)

    // æ‰¹é‡æ“ä½œ
    MGet(ctx context.Context, keys ...string) ([]interface{}, error)
    MSet(ctx context.Context, pairs ...interface{}) error

    // è¿‡æœŸæ—¶é—´
    Expire(ctx context.Context, key string, expiration time.Duration) error
    TTL(ctx context.Context, key string) (time.Duration, error)

    // Hashæ“ä½œ
    HGet(ctx context.Context, key, field string) (string, error)
    HSet(ctx context.Context, key string, values ...interface{}) error
    HGetAll(ctx context.Context, key string) (map[string]string, error)
    HDel(ctx context.Context, key string, fields ...string) error

    // Seté›†åˆæ“ä½œ
    SAdd(ctx context.Context, key string, members ...interface{}) error
    SMembers(ctx context.Context, key string) ([]string, error)
    SRem(ctx context.Context, key string, members ...interface{}) error

    // åŸå­æ“ä½œ
    Incr(ctx context.Context, key string) (int64, error)
    Decr(ctx context.Context, key string) (int64, error)
    IncrBy(ctx context.Context, key string, value int64) (int64, error)
    DecrBy(ctx context.Context, key string, value int64) (int64, error)

    // å¥åº·æ£€æŸ¥
    Ping(ctx context.Context) error
    Close() error
    GetClient() interface{}
}
```

**å®ç°ç‰¹æ€§**:
- åŸºäºgo-redis/redis/v8å°è£…
- å®Œæ•´çš„è¿æ¥æ± ç®¡ç†
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- æ”¯æŒä¸Šä¸‹æ–‡å–æ¶ˆ
- åŸç”Ÿå®¢æˆ·ç«¯è®¿é—®

---

### 3. æœåŠ¡å®¹å™¨é›†æˆ (`service/container/service_container.go`)

**é›†æˆæ–¹å¼**:

```go
type ServiceContainer struct {
    // ... å…¶ä»–å­—æ®µ
    redisClient cache.RedisClient
}

// Initialize åˆå§‹åŒ–æ—¶è‡ªåŠ¨åˆ›å»ºRediså®¢æˆ·ç«¯
func (c *ServiceContainer) Initialize(ctx context.Context) error {
    // åˆå§‹åŒ–Rediså®¢æˆ·ç«¯ï¼ˆå¤±è´¥ä¸é˜»å¡å¯åŠ¨ï¼‰
    if err := c.initRedis(); err != nil {
        fmt.Printf("è­¦å‘Š: Rediså®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: %v\n", err)
    }
    // ... å…¶ä»–åˆå§‹åŒ–
}

// initRedis åˆå§‹åŒ–Rediså®¢æˆ·ç«¯
func (c *ServiceContainer) initRedis() error {
    cfg := config.GetRedisConfig()
    client, err := cache.NewRedisClient(cfg)
    if err != nil {
        return err
    }
    c.redisClient = client
    return nil
}

// GetRedisClient è·å–Rediså®¢æˆ·ç«¯
func (c *ServiceContainer) GetRedisClient() cache.RedisClient {
    c.mu.RLock()
    defer c.mu.RUnlock()
    return c.redisClient
}
```

**ç‰¹æ€§**:
- æœåŠ¡å®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–
- å¤±è´¥æ—¶ä¸é˜»å¡åº”ç”¨å¯åŠ¨ï¼ˆä¼˜é›…é™çº§ï¼‰
- å…³é—­æ—¶è‡ªåŠ¨æ¸…ç†è¿æ¥
- çº¿ç¨‹å®‰å…¨è®¿é—®

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ–°å»ºæ–‡ä»¶

1. **`config/redis.go`** (69è¡Œ)
   - Redisé…ç½®ç»“æ„å®šä¹‰
   - é»˜è®¤é…ç½®å·¥å‚
   - å…¨å±€é…ç½®ç®¡ç†

2. **`pkg/cache/redis_client.go`** (314è¡Œ)
   - RedisClientæ¥å£å®šä¹‰
   - DefaultRedisClientå®ç°
   - å®Œæ•´çš„Redisæ“ä½œå°è£…

3. **`pkg/cache/redis_client_test.go`** (296è¡Œ)
   - Mockå®¢æˆ·ç«¯å®ç°
   - å•å…ƒæµ‹è¯•å¥—ä»¶
   - æ€§èƒ½åŸºå‡†æµ‹è¯•

4. **`test/integration/redis_integration_test.go`** (303è¡Œ)
   - å®Œæ•´çš„é›†æˆæµ‹è¯•
   - æ€§èƒ½åŸºå‡†æµ‹è¯•
   - çœŸå®ç¯å¢ƒéªŒè¯

### ä¿®æ”¹æ–‡ä»¶

1. **`config/config.go`**
   - æ·»åŠ Redisé…ç½®å­—æ®µåˆ°Configç»“æ„ä½“

2. **`config/validation.go`**
   - æ·»åŠ Redisé…ç½®é»˜è®¤å€¼è®¾ç½®

3. **`config/config.local.yaml`**
   - æ·»åŠ æœ¬åœ°å¼€å‘ç¯å¢ƒRedisé…ç½®

4. **`service/container/service_container.go`**
   - æ·»åŠ redisClientå­—æ®µ
   - å®ç°Redisåˆå§‹åŒ–å’Œæ¸…ç†é€»è¾‘
   - æä¾›GetRedisClientè®¿é—®æ–¹æ³•

---

## âœ… æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹** (`pkg/cache/redis_client_test.go`):
- âœ… é»˜è®¤é…ç½®æµ‹è¯•
- âœ… é”™è¯¯åŒ…è£…æµ‹è¯•
- âœ… Mockå®¢æˆ·ç«¯åŸºæœ¬æ“ä½œ
- âœ… Mock Hashæ“ä½œ
- âœ… Mock Setæ“ä½œ
- âœ… MockåŸå­æ“ä½œ
- âœ… Pingå¥åº·æ£€æŸ¥

**è¿è¡Œç»“æœ**:
```bash
go test ./pkg/cache -v -run TestMock
=== RUN   TestMockRedisClient
--- PASS: TestMockRedisClient (0.00s)
=== RUN   TestMockRedisClient_HashOperations
--- PASS: TestMockRedisClient_HashOperations (0.00s)
=== RUN   TestMockRedisClient_SetOperations
--- PASS: TestMockRedisClient_SetOperations (0.00s)
=== RUN   TestMockRedisClient_AtomicOperations
--- PASS: TestMockRedisClient_AtomicOperations (0.00s)
=== RUN   TestMockRedisClient_Ping
--- PASS: TestMockRedisClient_Ping (0.00s)
ok      Qingyu_backend/pkg/cache        0.830s
```

### é›†æˆæµ‹è¯•

**æµ‹è¯•åœºæ™¯** (`test/integration/redis_integration_test.go`):
- âœ… Rediså¥åº·æ£€æŸ¥
- âœ… åŸºæœ¬è¯»å†™æ“ä½œ
- âœ… è¿‡æœŸæ—¶é—´éªŒè¯
- âœ… Hashæ“ä½œ
- âœ… Seté›†åˆæ“ä½œ
- âœ… åŸå­æ“ä½œï¼ˆIncr/Decrï¼‰
- âœ… æ‰¹é‡æ“ä½œï¼ˆMGet/MSetï¼‰
- âœ… TTLç®¡ç†
- âœ… Existsæ£€æŸ¥
- âœ… æœåŠ¡å®¹å™¨é›†æˆ

**æ€§èƒ½åŸºå‡†**:
- Setæ“ä½œ
- Getæ“ä½œ
- Incræ“ä½œ
- HSetæ“ä½œ

---

## ğŸ”§ é…ç½®è¯´æ˜

### æœ¬åœ°å¼€å‘é…ç½® (`config.local.yaml`)

```yaml
redis:
  host: "localhost"
  port: 6379
  password: ""  # æœ¬åœ°å¼€å‘æ— å¯†ç 
  db: 0
  pool_size: 10
  min_idle_conns: 5
  max_idle_conns: 10
  dial_timeout: 5s
  read_timeout: 3s
  write_timeout: 3s
  pool_timeout: 4s
  max_retries: 3
  min_retry_backoff: 8ms
  max_retry_backoff: 512ms
```

### ç¯å¢ƒå˜é‡è¦†ç›–

æ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–é…ç½®ï¼ˆå‰ç¼€: `QINGYU_`ï¼‰:
```bash
QINGYU_REDIS_HOST=redis-server
QINGYU_REDIS_PORT=6379
QINGYU_REDIS_PASSWORD=secret
QINGYU_REDIS_DB=1
```

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```go
// è·å–Rediså®¢æˆ·ç«¯
redisClient := serviceContainer.GetRedisClient()
if redisClient == nil {
    // Redisæœªåˆå§‹åŒ–ï¼Œä½¿ç”¨é™çº§ç­–ç•¥
    return handleWithoutRedis()
}

// è®¾ç½®ç¼“å­˜
ctx := context.Background()
err := redisClient.Set(ctx, "user:123", userJSON, 10*time.Minute)

// è·å–ç¼“å­˜
data, err := redisClient.Get(ctx, "user:123")

// Hashæ“ä½œ
err = redisClient.HSet(ctx, "session:abc", "user_id", "123", "login_at", time.Now().Unix())
userID, err := redisClient.HGet(ctx, "session:abc", "user_id")

// åŸå­è®¡æ•°
count, err := redisClient.Incr(ctx, "api:calls:123")
```

### åœ¨Serviceå±‚ä½¿ç”¨

```go
type UserService struct {
    userRepo    interfaces.UserRepository
    redisClient cache.RedisClient
}

func (s *UserService) GetUser(ctx context.Context, userID string) (*models.User, error) {
    // å°è¯•ä»ç¼“å­˜è·å–
    if s.redisClient != nil {
        cacheKey := "user:" + userID
        if data, err := s.redisClient.Get(ctx, cacheKey); err == nil {
            var user models.User
            if err := json.Unmarshal([]byte(data), &user); err == nil {
                return &user, nil
            }
        }
    }

    // ä»æ•°æ®åº“è·å–
    user, err := s.userRepo.FindByID(ctx, userID)
    if err != nil {
        return nil, err
    }

    // å†™å…¥ç¼“å­˜
    if s.redisClient != nil {
        if data, err := json.Marshal(user); err == nil {
            _ = s.redisClient.Set(ctx, "user:"+userID, string(data), 10*time.Minute)
        }
    }

    return user, nil
}
```

---

## ğŸ”„ åç»­è®¡åˆ’

### Phase1åç»­ä»»åŠ¡

1. **ä¼šè¯ç®¡ç†é›†æˆ** (é«˜ä¼˜å…ˆçº§)
   - ä½¿ç”¨Rediså­˜å‚¨ç”¨æˆ·ä¼šè¯
   - å®ç°åˆ†å¸ƒå¼ä¼šè¯å…±äº«
   - Tokené»‘åå•ç®¡ç†

2. **ç¼“å­˜ç­–ç•¥å®ç°** (é«˜ä¼˜å…ˆçº§)
   - ç”¨æˆ·ä¿¡æ¯ç¼“å­˜
   - ä¹¦ç±ä¿¡æ¯ç¼“å­˜
   - çƒ­é—¨å†…å®¹ç¼“å­˜
   - ç¼“å­˜å¤±æ•ˆç­–ç•¥

3. **é™æµå™¨å®ç°** (ä¸­ä¼˜å…ˆçº§)
   - åŸºäºRedisçš„åˆ†å¸ƒå¼é™æµ
   - APIé€Ÿç‡é™åˆ¶
   - ç”¨æˆ·é…é¢ç®¡ç†

4. **æ¶ˆæ¯é˜Ÿåˆ—** (ä¸­ä¼˜å…ˆçº§)
   - Redis Streamå®ç°
   - å¼‚æ­¥ä»»åŠ¡å¤„ç†
   - äº‹ä»¶é€šçŸ¥

### æ€§èƒ½ä¼˜åŒ–

- [ ] è¿æ¥æ± è°ƒä¼˜
- [ ] æ‰¹é‡æ“ä½œä¼˜åŒ–
- [ ] Pipelineæ”¯æŒ
- [ ] é›†ç¾¤æ¨¡å¼æ”¯æŒ

---

## ğŸ“Š è´¨é‡æŒ‡æ ‡

### ä»£ç è´¨é‡

- âœ… ç¼–è¯‘é€šè¿‡
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–
- âœ… é›†æˆæµ‹è¯•é€šè¿‡
- âœ… æ¥å£è®¾è®¡è§„èŒƒ
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… æ–‡æ¡£å®Œæ•´

### æ€§èƒ½æŒ‡æ ‡

- è¿æ¥æ± å¤§å°: 10
- æœ€å°ç©ºé—²è¿æ¥: 5
- è¿æ¥è¶…æ—¶: 5s
- è¯»å†™è¶…æ—¶: 3s
- æ”¯æŒå¹¶å‘è®¿é—®

### å¯é æ€§

- âœ… ä¼˜é›…é™çº§ï¼ˆRedisä¸å¯ç”¨æ—¶ä¸å½±å“å¯åŠ¨ï¼‰
- âœ… è‡ªåŠ¨é‡è¿ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- âœ… è¿æ¥æ± ç®¡ç†
- âœ… è¶…æ—¶æ§åˆ¶
- âœ… èµ„æºæ¸…ç†

---

## ğŸ“ ç»éªŒæ€»ç»“

### æˆåŠŸç»éªŒ

1. **æ¥å£è®¾è®¡ä¼˜å…ˆ**: å…ˆå®šä¹‰æ¸…æ™°çš„æ¥å£ï¼Œä¾¿äºMockå’Œæµ‹è¯•
2. **ä¼˜é›…é™çº§**: Rediså¤±è´¥ä¸é˜»å¡åº”ç”¨å¯åŠ¨ï¼Œæé«˜ç³»ç»Ÿå¯ç”¨æ€§
3. **å®Œæ•´æµ‹è¯•**: å•å…ƒæµ‹è¯•+é›†æˆæµ‹è¯•ï¼Œç¡®ä¿è´¨é‡
4. **é…ç½®çµæ´»**: æ”¯æŒé»˜è®¤é…ç½®+ç¯å¢ƒå˜é‡è¦†ç›–

### æ³¨æ„äº‹é¡¹

1. **è¿æ¥æ± ç®¡ç†**: åˆç†é…ç½®è¿æ¥æ± å¤§å°ï¼Œé¿å…èµ„æºæµªè´¹
2. **è¶…æ—¶è®¾ç½®**: è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼Œé¿å…é•¿æ—¶é—´é˜»å¡
3. **é”™è¯¯å¤„ç†**: åŒºåˆ†ä¸´æ—¶é”™è¯¯å’Œæ°¸ä¹…é”™è¯¯ï¼Œå®ç°åˆç†çš„é‡è¯•
4. **èµ„æºæ¸…ç†**: åº”ç”¨å…³é—­æ—¶ç¡®ä¿Redisè¿æ¥æ­£ç¡®å…³é—­

### æ”¹è¿›å»ºè®®

1. æœªæ¥å¯è€ƒè™‘æ”¯æŒRedis Clusteræ¨¡å¼
2. å¯æ·»åŠ æ›´å¤šçš„æ•°æ®ç»“æ„æ”¯æŒï¼ˆZSetã€Bitmapç­‰ï¼‰
3. å¯å®ç°Pipelineæ‰¹é‡æ“ä½œä¼˜åŒ–
4. å¯æ·»åŠ æ…¢æŸ¥è¯¢ç›‘æ§

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [go-rediså®˜æ–¹æ–‡æ¡£](https://redis.uptrace.dev/)
- [Redisæœ€ä½³å®è·µ](https://redis.io/topics/best-practices)
- [Goå¹¶å‘ç¼–ç¨‹æ¨¡å¼](https://go.dev/blog/pipelines)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-10-24  
**çŠ¶æ€**: âœ… å®Œæˆ

