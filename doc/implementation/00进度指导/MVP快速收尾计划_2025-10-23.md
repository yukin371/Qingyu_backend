# MVP快速收尾计划

**制定时间**: 2025-10-23  
**目标**: 2-3天内完成MVP，进入内测  
**策略**: 聚焦关键阻塞项，暂缓非必需功能

---

## 🎯 MVP最小可发布标准

### 核心原则

**MVP = Minimum Viable Product（最小可行产品）**
- ✅ 核心功能可用（创作、阅读、AI辅助）
- ✅ 安全性保障（认证、权限、内容审核）
- ✅ 数据安全（防丢失、版本控制基础）
- ❌ 不追求完美（高级功能可延后）

---

## 📊 当前状态快速评估

### 功能完成度分析

| 模块 | 核心功能 | MVP必需 | 当前状态 | 行动 |
|------|---------|---------|---------|------|
| **用户管理** | 登录注册 | ✅ 必需 | ✅ 已实现 | 无需改动 |
| | RBAC权限 | ✅ 必需 | ✅ 已实现 | 无需改动 |
| | 会话管理 | ✅ 必需 | 🔴 Bug阻塞 | **必须修复** |
| | 多端登录 | ⚠️ 建议 | ❌ 未实现 | **快速实现** |
| | 密码强度 | ⚠️ 建议 | ❌ 未实现 | **快速实现** |
| **写作核心** | 项目管理 | ✅ 必需 | ✅ 已实现 | 无需改动 |
| | 章节编辑 | ✅ 必需 | ✅ 已实现 | 无需改动 |
| | 自动保存 | ✅ 必需 | ❌ 未实现 | **必须实现** |
| | 版本控制 | ⚠️ 建议 | 🟡 基础有 | 验证即可 |
| **AI服务** | AI续写 | ✅ 必需 | ✅ 已实现 | 无需改动 |
| | 配额扣减 | ✅ 必需 | ✅ 已实现 | 无需改动 |
| | 内容审核 | ✅ 必需 | ✅ 已实现 | 无需改动 |
| **阅读端** | 书籍展示 | ✅ 必需 | ✅ 已实现 | 无需改动 |
| | 章节阅读 | ✅ 必需 | ✅ 已实现 | 无需改动 |

**评估结论**:
- ✅ 核心功能：90%完成
- 🔴 **阻塞项：4个** (会话Bug、自动保存、多端登录、密码强度)
- ⏸️ 可延后：20个TDD功能

---

## 🚀 快速收尾计划 (2-3天)

### Day 1: 修复关键Bug（必须完成）

**上午 (4小时)**:

**任务1: 修复SessionService Bug** ⚠️ P0
```bash
文件: service/shared/auth/session_service.go
问题: fmt.Sscanf解析错误
耗时: 1小时
```

**修复方案** (已在Bug报告中提供):
```go
// 位置: session_service.go:68
// 替换 fmt.Sscanf 为 strings.Split

parts := strings.Split(value, "|")
if len(parts) != 3 {
    return nil, fmt.Errorf("会话数据格式无效")
}

userID := parts[0]
createdAt, err := strconv.ParseInt(parts[1], 10, 64)
if err != nil {
    return nil, fmt.Errorf("解析创建时间失败: %w", err)
}
expiresAt, err := strconv.ParseInt(parts[2], 10, 64)
if err != nil {
    return nil, fmt.Errorf("解析过期时间失败: %w", err)
}

// 新增导入
import (
    "strings"
    "strconv"
)
```

**验证**:
```bash
# 运行会话测试
go test ./test/service/shared/auth/ -run TestSessionService -v
```

**预期**: 11个会话测试从Skip→Pass，auth覆盖率 48.5% → 75%

---

**任务2: 快速冒烟测试** ⚠️ P0
```bash
耗时: 2小时
```

**测试清单**:
- [ ] 用户注册登录流程
- [ ] 创建项目和章节
- [ ] AI续写功能
- [ ] 配额扣减
- [ ] 书籍浏览
- [ ] 章节阅读

**验证方式**: 手动测试 + Postman

---

**下午 (4小时)**:

**任务3: 实现自动保存功能** ⚠️ P0
```bash
文件: service/project/autosave_service.go (新建)
耗时: 3小时
```

**最小实现** (定时保存即可):
```go
package project

import (
    "context"
    "time"
)

type AutoSaveService struct {
    versionService VersionService
    interval       time.Duration
    stopChan       map[string]chan struct{}
}

func NewAutoSaveService(versionService VersionService) *AutoSaveService {
    return &AutoSaveService{
        versionService: versionService,
        interval:       30 * time.Second,
        stopChan:       make(map[string]chan struct{}),
    }
}

// StartAutoSave 启动自动保存
func (s *AutoSaveService) StartAutoSave(docID string) {
    if _, exists := s.stopChan[docID]; exists {
        return // 已启动
    }

    stopChan := make(chan struct{})
    s.stopChan[docID] = stopChan

    go func() {
        ticker := time.NewTicker(s.interval)
        defer ticker.Stop()

        for {
            select {
            case <-ticker.C:
                // 执行保存
                _ = s.versionService.CreateAutoSaveRevision(context.Background(), docID)
            case <-stopChan:
                return
            }
        }
    }()
}

// StopAutoSave 停止自动保存
func (s *AutoSaveService) StopAutoSave(docID string) {
    if stopChan, exists := s.stopChan[docID]; exists {
        close(stopChan)
        delete(s.stopChan, docID)
    }
}
```

**VersionService增加方法**:
```go
// CreateAutoSaveRevision 创建自动保存版本
func (s *VersionService) CreateAutoSaveRevision(ctx context.Context, docID string) error {
    // 简化版：只创建版本，不做复杂逻辑
    return s.BumpVersionAndCreateRevision(
        getProjectID(docID), 
        docID, 
        "system", 
        "自动保存",
    )
}
```

**集成到API**:
```go
// 在文档打开时启动自动保存
func (api *DocumentAPI) OpenDocument(c *gin.Context) {
    // ... 现有逻辑
    
    // 启动自动保存
    autoSaveService.StartAutoSave(docID)
}

// 在文档关闭时停止自动保存
func (api *DocumentAPI) CloseDocument(c *gin.Context) {
    // ... 现有逻辑
    
    // 停止自动保存
    autoSaveService.StopAutoSave(docID)
}
```

**验证**: 打开文档30秒后检查版本列表

---

**任务4: 基础测试验证** ⚠️ P0
```bash
耗时: 1小时
```

**测试自动保存**:
```go
// 简单验证测试
func TestAutoSave_BasicFlow(t *testing.T) {
    service := NewAutoSaveService(mockVersionService)
    
    service.StartAutoSave("doc123")
    time.Sleep(31 * time.Second)
    service.StopAutoSave("doc123")
    
    // 验证CreateAutoSaveRevision被调用
    mockVersionService.AssertCalled(t, "CreateAutoSaveRevision", mock.Anything, "doc123")
}
```

---

### Day 2: 安全增强（快速实现）

**上午 (4小时)**:

**任务5: 多端登录限制** ⚠️ P1
```bash
文件: service/shared/auth/session_manager.go (增强)
耗时: 2小时
```

**简化实现** (只限制数量，不做踢出):
```go
// CheckDeviceLimit 检查设备数量限制
func (s *SessionManager) CheckDeviceLimit(userID string) error {
    sessions, err := s.sessionRepo.GetUserSessions(userID)
    if err != nil {
        return err
    }

    if len(sessions) >= 5 {
        return errors.New("最多允许5台设备登录，请退出其他设备")
    }

    return nil
}

// 在Login时调用
func (s *AuthService) Login(username, password string) (*TokenPair, error) {
    // ... 现有验证逻辑
    
    // 检查设备限制
    if err := s.sessionManager.CheckDeviceLimit(user.ID); err != nil {
        return nil, err
    }
    
    // ... 创建Token和会话
}
```

**验证**: 登录6次，第6次应被拒绝

---

**任务6: 密码强度验证** ⚠️ P1
```bash
文件: service/shared/auth/password_validator.go (新建)
耗时: 1.5小时
```

**简化实现** (基础规则):
```go
package auth

import (
    "errors"
    "regexp"
)

type PasswordValidator struct{}

func NewPasswordValidator() *PasswordValidator {
    return &PasswordValidator{}
}

// ValidatePassword 验证密码强度
func (v *PasswordValidator) ValidatePassword(password string) error {
    if len(password) < 8 {
        return errors.New("密码长度至少8位")
    }

    if len(password) > 32 {
        return errors.New("密码长度不能超过32位")
    }

    // 至少包含一个数字
    hasNumber := regexp.MustCompile(`[0-9]`).MatchString(password)
    if !hasNumber {
        return errors.New("密码必须包含至少一个数字")
    }

    // 至少包含一个字母
    hasLetter := regexp.MustCompile(`[a-zA-Z]`).MatchString(password)
    if !hasLetter {
        return errors.New("密码必须包含至少一个字母")
    }

    return nil
}

// 在Register时调用
func (s *AuthService) Register(req *RegisterRequest) (*User, error) {
    // 验证密码强度
    if err := s.passwordValidator.ValidatePassword(req.Password); err != nil {
        return nil, err
    }
    
    // ... 现有注册逻辑
}
```

**验证**: 注册时测试各种密码

---

**任务7: 更新API文档** 📝
```bash
耗时: 0.5小时
```

更新以下文档:
- `doc/api/frontend/认证API参考.md` (密码强度要求)
- `doc/api/frontend/写作系统API参考.md` (自动保存说明)

---

**下午 (4小时)**:

**任务8: 完整端到端测试** ⚠️ P0
```bash
耗时: 3小时
```

**测试场景**:

**场景1: 新用户完整流程**
1. 注册（强密码）
2. 登录
3. 创建项目
4. 创建章节
5. 编辑内容（等待自动保存）
6. AI续写
7. 查看版本历史
8. 退出登录

**场景2: AI写作流程**
1. 登录
2. 打开章节
3. AI续写（检查配额扣减）
4. 流式响应接收
5. 内容审核（敏感词）
6. 保存

**场景3: 阅读流程**
1. 浏览书城
2. 查看书籍详情
3. 阅读章节
4. 更新阅读进度
5. 查看推荐

**记录Bug**: 发现的问题记录到 `doc/implementation/测试/MVP测试Bug清单.md`

---

**任务9: 性能快速验证** ⚠️ P1
```bash
耗时: 1小时
```

**性能指标验证**:
- [ ] AI续写响应时间 < 5秒
- [ ] 页面加载时间 < 2秒
- [ ] 配额扣减操作 < 100ms
- [ ] 内容审核速度 < 3秒/万字

**工具**: Postman性能测试 + 日志分析

---

### Day 3: 文档与部署

**上午 (4小时)**:

**任务10: 修复发现的Bug** 🐛
```bash
耗时: 2小时
```

根据Day 2测试发现的问题快速修复

---

**任务11: 生成MVP完成报告** 📊
```bash
耗时: 1.5小时
```

创建 `doc/implementation/00进度指导/MVP完成报告_2025-10-23.md`:
- MVP功能清单（已实现/未实现）
- 测试覆盖率总结
- 已知问题清单
- 后续改进建议

---

**任务12: 更新部署文档** 📝
```bash
耗时: 0.5小时
```

更新 `doc/ops/部署指南.md`:
- 环境要求
- 部署步骤
- 配置说明
- 常见问题

---

**下午 (4小时)**:

**任务13: 内测环境部署** 🚀
```bash
耗时: 2小时
```

**部署步骤**:
```bash
# 1. 构建Docker镜像
docker build -t qingyu-backend:mvp .

# 2. 启动服务
docker-compose -f docker/docker-compose.prod.yml up -d

# 3. 数据库初始化
go run cmd/migrate/main.go

# 4. 创建测试账号
go run cmd/seed/main.go --env=test

# 5. 健康检查
curl http://localhost:8080/health
```

---

**任务14: 内测账号准备** 👥
```bash
耗时: 0.5小时
```

创建10个内测账号:
```bash
test001@qingyu.com / Test@123
test002@qingyu.com / Test@123
...
test010@qingyu.com / Test@123
```

配置不同角色:
- 5个普通用户
- 3个VIP用户
- 2个管理员

---

**任务15: 内测指南编写** 📖
```bash
耗时: 1小时
```

创建 `doc/usage/内测指南_v1.0.md`:
- 内测目标
- 测试重点
- 问题反馈方式
- 已知限制

---

**任务16: 启动内测** 🎯
```bash
耗时: 0.5小时
```

- [ ] 发送内测邀请邮件
- [ ] 创建问题反馈表单
- [ ] 建立内测沟通群
- [ ] 开始监控服务状态

---

## 📋 MVP功能范围确认

### 确认包含 ✅

**用户管理**:
- ✅ 用户注册登录
- ✅ 会话管理（Bug已修复）
- ✅ RBAC权限系统
- ✅ 多端登录限制（快速实现）
- ✅ 密码强度验证（快速实现）

**写作核心**:
- ✅ 项目创建与管理
- ✅ 文档树与章节编辑
- ✅ 自动保存（快速实现）
- ✅ 版本控制基础（现有代码）
- ✅ AI续写
- ✅ 配额管理与扣减

**AI服务**:
- ✅ OpenAI/国产AI适配
- ✅ 错误重试机制
- ✅ 内容审核（敏感词）

**阅读端**:
- ✅ 书城首页
- ✅ 书籍展示
- ✅ 章节阅读
- ✅ 推荐系统

**共享服务**:
- ✅ 文件存储
- ✅ 消息通知

---

### 确认延后 ⏸️

**高级功能** (Phase 2):
- ⏸️ 配额预警机制
- ⏸️ 上下文窗口优化
- ⏸️ 流式响应增强
- ⏸️ 协作编辑
- ⏸️ 版本Diff
- ⏸️ 登录失败锁定

**增强功能** (Phase 3+):
- ⏸️ 社区互动（评论、打赏）
- ⏸️ 高级AI功能（大纲生成、角色设计）
- ⏸️ 数据分析
- ⏸️ 性能优化（增量存储、缓存优化）

---

## ✅ 验收标准

### 功能验收

- [x] **核心流程畅通**: 注册→登录→创作→AI→阅读 完整流程无阻塞
- [ ] **关键Bug修复**: SessionService Bug已修复
- [ ] **安全保障**: 密码强度验证、多端登录限制生效
- [ ] **数据安全**: 自动保存功能正常工作
- [ ] **内容安全**: 敏感词检测正常工作

### 测试验收

- [ ] **冒烟测试**: 所有核心功能手动测试通过
- [ ] **关键路径**: 3大场景端到端测试通过
- [ ] **性能基准**: 关键操作响应时间符合预期

### 文档验收

- [ ] **API文档**: 更新完整，包含新增功能
- [ ] **部署文档**: 完整可执行
- [ ] **内测指南**: 清晰明了
- [ ] **完成报告**: 总结详尽

### 部署验收

- [ ] **环境稳定**: 服务正常运行24小时无崩溃
- [ ] **健康检查**: 所有健康检查接口正常
- [ ] **日志监控**: 日志正常输出，无ERROR级别
- [ ] **数据备份**: 数据库备份策略已配置

---

## 🎯 成功标准

**MVP发布标准**:
1. ✅ 4个阻塞项全部解决
2. ✅ 核心功能100%可用
3. ✅ 关键Bug全部修复
4. ✅ 安全性基本保障
5. ✅ 内测环境稳定运行

**不强求**:
- ❌ 测试覆盖率达标（可在Phase 2补充）
- ❌ 性能极致优化（可在Phase 2优化）
- ❌ 所有TDD功能实现（可在Phase 2实现）

---

## 📊 时间估算

| 任务 | Day 1 | Day 2 | Day 3 | 总计 |
|------|-------|-------|-------|------|
| **修复Bug** | 1h | 2h | 0h | 3h |
| **功能开发** | 3h | 3.5h | 0h | 6.5h |
| **测试验证** | 3h | 4h | 0h | 7h |
| **文档编写** | 1h | 0.5h | 2h | 3.5h |
| **部署准备** | 0h | 0h | 4h | 4h |
| **总计** | 8h | 10h | 6h | **24h (3天)** |

**缓冲**: +1天应对突发问题

**实际预计**: 3-4天完成MVP

---

## 🚨 风险应对

| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|---------|
| **自动保存实现复杂** | 中 | 高 | 采用最简实现（仅定时保存） |
| **测试发现严重Bug** | 中 | 高 | 快速修复，必要时降级功能 |
| **部署环境问题** | 低 | 中 | 提前准备Docker环境 |
| **时间延期** | 中 | 中 | 已预留1天缓冲 |

---

## 📝 文件清单

### 需要修改的文件

**Service层**:
1. `service/shared/auth/session_service.go` (Bug修复)
2. `service/project/autosave_service.go` (新建)
3. `service/shared/auth/session_manager.go` (多端登录)
4. `service/shared/auth/password_validator.go` (新建)

**API层**:
1. `api/v1/document/document_api.go` (集成自动保存)
2. `api/v1/system/auth_api.go` (集成密码验证)

**配置**:
1. `docker/docker-compose.prod.yml` (部署配置)

### 需要创建的文档

1. `doc/implementation/测试/MVP测试Bug清单.md`
2. `doc/implementation/00进度指导/MVP完成报告_2025-10-23.md`
3. `doc/usage/内测指南_v1.0.md`

---

## 🎉 预期成果

**3天后**:
- ✅ MVP功能完整可用
- ✅ 4个关键阻塞项已解决
- ✅ 内测环境已部署
- ✅ 10个测试账号已准备
- ✅ 内测指南已发布
- ✅ 进入内测阶段

**质量指标**:
- 核心功能可用率: 100%
- 已知严重Bug: 0个
- 服务稳定性: ≥99%
- 用户可用性: 良好

**后续计划**:
- 内测期: 1-2周
- 收集反馈并快速迭代
- 启动Phase 2开发

---

**计划执行**: 2025-10-23 → 2025-10-26  
**预计发布**: 2025-10-26 进入内测  
**责任人**: 技术负责人 + 项目经理

---

**立即开始执行！** 🚀

