# é˜¶æ®µ 2.1 è¿›åº¦æŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-28  
**çŠ¶æ€**: ğŸš§ è¿›è¡Œä¸­  
**å®Œæˆåº¦**: 70%

---

## âœ… å·²å®Œæˆä»»åŠ¡

### 1. EmbeddingManager æ¨¡å‹ç®¡ç†å™¨ âœ…

**æ–‡ä»¶**: `python_ai_service/src/rag/embedding_manager.py` (~290è¡Œ)

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… ç»Ÿä¸€çš„å‘é‡åŒ–æ¥å£
- âœ… æ”¯æŒå¤šç§æ¨¡å‹ç±»å‹ï¼ˆlocalã€openaiã€customï¼‰
- âœ… æ‡’åŠ è½½æœºåˆ¶
- âœ… å¼‚æ­¥å¤„ç†ï¼ˆexecutoråŒ…è£…åŒæ­¥æ¨¡å‹ï¼‰
- âœ… å¥åº·æ£€æŸ¥
- âœ… å…¨å±€å•ä¾‹æ¨¡å¼

**å…³é”®ç‰¹æ€§**:
- æ¨¡å‹ç±»å‹æšä¸¾ï¼ˆModelType Enumï¼‰
- è‡ªåŠ¨è·¯ç”±åˆ°ä¸åŒå®ç°
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—
- æ”¯æŒæ‰¹é‡å’Œå•æ–‡æœ¬å‘é‡åŒ–

---

### 2. OpenAI Embedding é›†æˆ âœ…

**æ–‡ä»¶**: `python_ai_service/src/rag/openai_embedding.py` (~250è¡Œ)

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… AsyncOpenAI å®¢æˆ·ç«¯
- âœ… text-embedding-3ç³»åˆ—æ”¯æŒ
- âœ… è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼ˆtenacityï¼‰
- âœ… é€Ÿç‡é™åˆ¶å¤„ç†
- âœ… æ‰¹é‡å¤„ç†ä¼˜åŒ–
- âœ… Tokenè®¡æ•°å’Œæ—¥å¿—

**æŠ€æœ¯äº®ç‚¹**:
- ä½¿ç”¨`@retry`è£…é¥°å™¨å¤„ç†RateLimitError
- æŒ‡æ•°é€€é¿ç­–ç•¥ï¼ˆ2-10ç§’ï¼‰
- è‡ªåŠ¨åˆ†æ‰¹ï¼ˆé»˜è®¤100æ¡/æ‰¹ï¼‰
- å®Œæ•´çš„å¼‚æ­¥æ”¯æŒ

**æ”¯æŒçš„æ¨¡å‹**:
- `text-embedding-3-small` (1536ç»´)
- `text-embedding-3-large` (3072ç»´)
- `text-embedding-ada-002` (1536ç»´)

---

### 3. TextSplitter æ–‡æœ¬åˆ†å—å™¨ âœ…

**æ–‡ä»¶**: `python_ai_service/src/rag/text_splitter.py` (~330è¡Œ)

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… `RecursiveCharacterTextSplitter` - é€’å½’åˆ†å—
- âœ… ä¸­æ–‡åˆ†éš”ç¬¦ä¼˜åŒ–
- âœ… æ™ºèƒ½é‡å ç­–ç•¥
- âœ… å…ƒæ•°æ®ä¿ç•™
- âœ… `TextChunk` æ•°æ®ç»“æ„
- âœ… æ–‡æ¡£çº§åˆ†å‰²

**åˆ†éš”ç¬¦ä¼˜å…ˆçº§**ï¼ˆä¸­æ–‡ä¼˜åŒ–ï¼‰:
1. `\n\n` - æ®µè½
2. `\n` - æ¢è¡Œ
3. `ã€‚ï¼ï¼Ÿï¼›` - ä¸­æ–‡æ ‡ç‚¹
4. `.!?;` - è‹±æ–‡æ ‡ç‚¹
5. `,ï¼Œ` - é€—å·
6. ` ` - ç©ºæ ¼
7. `""` - å­—ç¬¦çº§åˆ«

**å…³é”®ç‰¹æ€§**:
- é€’å½’åˆ†å‰²ç®—æ³•
- ä¿æŒchunk_sizeå’Œchunk_overlap
- `create_chunks()`è¿”å›ç»“æ„åŒ–å¯¹è±¡
- `split_documents()`æ‰¹é‡å¤„ç†å¹¶ä¿ç•™å…ƒæ•°æ®

---

### 4. EmbeddingCache ç¼“å­˜æœºåˆ¶ âœ…

**æ–‡ä»¶**: `python_ai_service/src/rag/embedding_cache.py` (~320è¡Œ)

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… LRUå†…å­˜ç¼“å­˜ï¼ˆOrderedDictå®ç°ï¼‰
- âœ… Redisç¼“å­˜å±‚ï¼ˆå¯é€‰ï¼‰
- âœ… SHA256å“ˆå¸ŒKeyç”Ÿæˆ
- âœ… æ‰¹é‡æ“ä½œæ”¯æŒ
- âœ… ç»Ÿè®¡ä¿¡æ¯ï¼ˆå‘½ä¸­ç‡ã€å®¹é‡ï¼‰
- âœ… å…¨å±€å•ä¾‹æ¨¡å¼

**ç¼“å­˜ç­–ç•¥**:
1. æŸ¥è¯¢ï¼šLRU â†’ Redis â†’ æ¨¡å‹
2. å†™å…¥ï¼šåŒæ—¶å†™LRUå’ŒRedis
3. æ·˜æ±°ï¼šLRUè‡ªåŠ¨æ·˜æ±°æœ€ä¹…æœªä½¿ç”¨

**æ€§èƒ½æŒ‡æ ‡**:
- LRUå®¹é‡ï¼š1000æ¡ï¼ˆå¯é…ç½®ï¼‰
- Redis TTLï¼š7å¤©ï¼ˆå¯é…ç½®ï¼‰
- é¢„æœŸå‘½ä¸­ç‡ï¼š>80%ï¼ˆé‡å¤æŸ¥è¯¢åœºæ™¯ï¼‰

---

### 5. é…ç½®ç®¡ç†æ›´æ–° âœ…

**æ–‡ä»¶**: `python_ai_service/src/core/config.py`

**æ–°å¢é…ç½®é¡¹**:
```python
# Embedding
embedding_provider: str = "local"  # æ¨¡å‹æä¾›å•†
embedding_cache_enabled: bool = True  # ç¼“å­˜å¼€å…³
embedding_cache_ttl: int = 604800  # 7å¤©

# OpenAI Embedding
openai_embedding_model: str = "text-embedding-3-small"
openai_embedding_batch_size: int = 100
openai_embedding_max_retries: int = 3

# Text Splitter
text_chunk_size: int = 500
text_chunk_overlap: int = 50
text_splitter_type: str = "recursive"
```

---

## â³ å¾…å®Œæˆä»»åŠ¡

### 6. æ›´æ–° MilvusClient â³

**æ–‡ä»¶**: `python_ai_service/src/rag/milvus_client.py`

**å¾…æ·»åŠ åŠŸèƒ½**:
- [ ] æ·»åŠ `chunk_id`å’Œ`document_id`å­—æ®µåˆ°Schema
- [ ] `insert_document()` - æ–‡æ¡£çº§æ’å…¥ï¼ˆè‡ªåŠ¨åˆ†å—ï¼‰
- [ ] `get_document_chunks()` - æŸ¥è¯¢æ–‡æ¡£çš„æ‰€æœ‰chunk
- [ ] `delete_document()` - åˆ é™¤æ–‡æ¡£çš„æ‰€æœ‰chunk

**é¢„è®¡æ—¶é—´**: 20åˆ†é’Ÿ

---

### 7. æ€§èƒ½ä¼˜åŒ– â³

**ä¼˜åŒ–é¡¹**:
- [ ] é›†æˆç¼“å­˜åˆ°EmbeddingManager
- [ ] åŠ¨æ€batch sizeï¼ˆæ ¹æ®æ–‡æœ¬é•¿åº¦ï¼‰
- [ ] è¿›åº¦å›è°ƒï¼ˆå¤§æ‰¹é‡å¤„ç†ï¼‰
- [ ] å†…å­˜ç®¡ç†ä¼˜åŒ–

**é¢„è®¡æ—¶é—´**: 15åˆ†é’Ÿ

---

### 8. æµ‹è¯•ç”¨ä¾‹ â³

**æµ‹è¯•æ–‡ä»¶**:
- [ ] `tests/test_embedding_manager.py` - æ¨¡å‹ç®¡ç†å™¨æµ‹è¯•
- [ ] `tests/test_text_splitter.py` - åˆ†å—å™¨æµ‹è¯•
- [ ] `tests/test_embedding_cache.py` - ç¼“å­˜æµ‹è¯•
- [ ] `tests/test_performance.py` - æ€§èƒ½æµ‹è¯•

**æµ‹è¯•åœºæ™¯**:
- æ¨¡å‹åˆ‡æ¢ï¼ˆlocalâ†”openaiï¼‰
- ä¸­æ–‡æ–‡æœ¬åˆ†å—
- ç¼“å­˜å‘½ä¸­ç‡
- 100æ¡æ–‡æœ¬æ‰¹é‡å‘é‡åŒ–æ€§èƒ½

**é¢„è®¡æ—¶é—´**: 30åˆ†é’Ÿ

---

### 9. ä¸­æ–‡å®æ–½æŠ¥å‘Š â³

**æ–‡ä»¶**: `doc/implementation/00è¿›åº¦æŒ‡å¯¼/é˜¶æ®µ2.1_å‘é‡åŒ–å¼•æ“å®Œå–„_å®æ–½æŠ¥å‘Š.md`

**æ–‡æ¡£ç»“æ„**:
- å®æ–½æ¦‚è§ˆ
- å„æ¨¡å—è¯¦ç»†è¯´æ˜
- ä½¿ç”¨æŒ‡å—å’Œç¤ºä¾‹
- æ€§èƒ½æµ‹è¯•ç»“æœ
- æ•…éšœæ’æŸ¥

**é¢„è®¡æ—¶é—´**: 25åˆ†é’Ÿ

---

## ğŸ“Š æ•´ä½“è¿›åº¦

| ä»»åŠ¡ | çŠ¶æ€ | å®Œæˆåº¦ | ä»£ç é‡ |
|------|------|--------|--------|
| EmbeddingManager | âœ… å®Œæˆ | 100% | ~290è¡Œ |
| OpenAI Embedding | âœ… å®Œæˆ | 100% | ~250è¡Œ |
| TextSplitter | âœ… å®Œæˆ | 100% | ~330è¡Œ |
| EmbeddingCache | âœ… å®Œæˆ | 100% | ~320è¡Œ |
| é…ç½®æ›´æ–° | âœ… å®Œæˆ | 100% | ~20è¡Œ |
| MilvusClientæ›´æ–° | â³ å¾…å®Œæˆ | 0% | ~100è¡Œé¢„è®¡ |
| æ€§èƒ½ä¼˜åŒ– | â³ å¾…å®Œæˆ | 0% | ~50è¡Œé¢„è®¡ |
| æµ‹è¯•ç”¨ä¾‹ | â³ å¾…å®Œæˆ | 0% | ~200è¡Œé¢„è®¡ |
| ä¸­æ–‡æ–‡æ¡£ | â³ å¾…å®Œæˆ | 0% | ~500è¡Œé¢„è®¡ |

**æ€»è®¡**: 70%å®Œæˆ

**å·²å®Œæˆä»£ç **: ~1210è¡Œ  
**å¾…å®Œæˆä»£ç **: ~850è¡Œé¢„è®¡  
**æ€»ä»£ç é‡**: ~2060è¡Œé¢„è®¡

---

## ğŸ¯ æ ¸å¿ƒæˆæœ

### æŠ€æœ¯äº®ç‚¹

1. **ç»Ÿä¸€çš„å‘é‡åŒ–æ¥å£**
   - å±è”½åº•å±‚å·®å¼‚
   - æ”¯æŒå¤šæ¨¡å‹åˆ‡æ¢
   - å¼‚æ­¥å‹å¥½

2. **æ™ºèƒ½æ–‡æœ¬åˆ†å—**
   - ä¸­æ–‡ä¼˜åŒ–
   - é€’å½’ç®—æ³•
   - å…ƒæ•°æ®ä¿ç•™

3. **å¤šçº§ç¼“å­˜**
   - LRU + Redis
   - è‡ªåŠ¨æ·˜æ±°
   - ç»Ÿè®¡ç›‘æ§

4. **OpenAIé›†æˆ**
   - è‡ªåŠ¨é‡è¯•
   - é€Ÿç‡é™åˆ¶
   - æ‰¹é‡ä¼˜åŒ–

###è´¨é‡æŒ‡æ ‡

- âœ… **ä»£ç è´¨é‡**: å®Œæ•´çš„ç±»å‹æ³¨è§£ã€é”™è¯¯å¤„ç†ã€æ—¥å¿—è®°å½•
- âœ… **æ¶æ„è®¾è®¡**: æ¨¡å—åŒ–ã€å¯æ‰©å±•ã€æ¥å£æ¸…æ™°
- âœ… **é…ç½®ç®¡ç†**: çµæ´»çš„é…ç½®é¡¹ï¼Œæ”¯æŒå¤šç¯å¢ƒ
- â³ **æµ‹è¯•è¦†ç›–**: å¾…å®Œæˆ

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œï¼ˆå‰©ä½™1å°æ—¶ï¼‰

**é€‰é¡¹Aï¼šå®Œæˆæ‰€æœ‰å‰©ä½™ä»»åŠ¡**ï¼ˆæ¨èï¼‰
1. æ›´æ–°MilvusClientï¼ˆ20åˆ†é’Ÿï¼‰
2. æ€§èƒ½ä¼˜åŒ–ï¼ˆ15åˆ†é’Ÿï¼‰
3. ç¼–å†™æµ‹è¯•ï¼ˆ30åˆ†é’Ÿï¼‰
4. ç¼–å†™æ–‡æ¡£ï¼ˆ25åˆ†é’Ÿï¼‰

**é€‰é¡¹Bï¼šæ ¸å¿ƒåŠŸèƒ½ä¼˜å…ˆ**
1. æ›´æ–°MilvusClientï¼ˆå¿…é¡»ï¼‰
2. ç®€å•æµ‹è¯•éªŒè¯ï¼ˆå¿…é¡»ï¼‰
3. åŸºç¡€æ–‡æ¡£ï¼ˆå¿…é¡»ï¼‰
4. æ€§èƒ½ä¼˜åŒ–å»¶å

### åç»­è§„åˆ’

**é˜¶æ®µ 2.2ï¼šç»“æ„åŒ–RAGå®ç°**ï¼ˆWeek 3ï¼‰
- RAGPipelineç±»
- Rerankeré›†æˆ
- æ··åˆæ£€ç´¢
- ä¸Šä¸‹æ–‡ç»„è£…
- å¼•ç”¨æ ‡æ³¨

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### 1. ä½¿ç”¨EmbeddingManager

```python
from src.rag.embedding_manager import EmbeddingManager

# åˆå§‹åŒ–ï¼ˆlocalæ¨¡å‹ï¼‰
manager = EmbeddingManager(model_type="local")

# å‘é‡åŒ–
texts = ["è¿™æ˜¯ç¬¬ä¸€æ®µæ–‡æœ¬", "è¿™æ˜¯ç¬¬äºŒæ®µæ–‡æœ¬"]
embeddings = await manager.embed_texts(texts)

# æŸ¥è¯¢
query_embedding = await manager.embed_query("æœç´¢æŸ¥è¯¢")
```

### 2. ä½¿ç”¨TextSplitter

```python
from src.rag.text_splitter import RecursiveCharacterTextSplitter

# åˆå§‹åŒ–
splitter = RecursiveCharacterTextSplitter(
    chunk_size=500,
    chunk_overlap=50
)

# åˆ†å—
long_text = "è¿™æ˜¯ä¸€æ®µå¾ˆé•¿çš„æ–‡æœ¬..."
chunks = splitter.split_text(long_text)

# å¸¦å…ƒæ•°æ®
chunk_objects = splitter.create_chunks(
    long_text,
    metadata={"source": "novel", "chapter": 1}
)
```

### 3. ä½¿ç”¨ç¼“å­˜

```python
from src.rag.embedding_cache import EmbeddingCache

# åˆå§‹åŒ–
cache = EmbeddingCache(lru_size=1000)

# æŸ¥è¯¢ç¼“å­˜
embedding = await cache.get("æ–‡æœ¬", "bge-large-zh")

# è®¾ç½®ç¼“å­˜
await cache.set("æ–‡æœ¬", "bge-large-zh", embedding, ttl=7*24*3600)

# ç»Ÿè®¡
stats = cache.get_stats()
print(f"å‘½ä¸­ç‡: {stats['lru']['hit_rate_percent']}%")
```

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ–°å»ºæ–‡ä»¶ï¼ˆ4ä¸ªï¼‰
1. `python_ai_service/src/rag/embedding_manager.py` - æ¨¡å‹ç®¡ç†å™¨
2. `python_ai_service/src/rag/openai_embedding.py` - OpenAIé›†æˆ
3. `python_ai_service/src/rag/text_splitter.py` - æ–‡æœ¬åˆ†å—å™¨
4. `python_ai_service/src/rag/embedding_cache.py` - ç¼“å­˜ç®¡ç†

### æ›´æ–°æ–‡ä»¶ï¼ˆ1ä¸ªï¼‰
5. `python_ai_service/src/core/config.py` - é…ç½®æ›´æ–°

### å¾…åˆ›å»ºæ–‡ä»¶ï¼ˆ5ä¸ªï¼‰
6. `tests/test_embedding_manager.py` - ç®¡ç†å™¨æµ‹è¯•
7. `tests/test_text_splitter.py` - åˆ†å—å™¨æµ‹è¯•
8. `tests/test_embedding_cache.py` - ç¼“å­˜æµ‹è¯•
9. `tests/test_performance.py` - æ€§èƒ½æµ‹è¯•
10. `doc/implementation/00è¿›åº¦æŒ‡å¯¼/é˜¶æ®µ2.1_å‘é‡åŒ–å¼•æ“å®Œå–„_å®æ–½æŠ¥å‘Š.md` - å®æ–½æŠ¥å‘Š

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### ä¾èµ–é¡¹

éœ€è¦å®‰è£…ä»¥ä¸‹PythonåŒ…ï¼š
```bash
pip install openai tenacity
```

æˆ–ä½¿ç”¨Poetryï¼š
```bash
poetry add openai tenacity
```

### ç¯å¢ƒå˜é‡

éœ€è¦é…ç½®ï¼ˆ.envæ–‡ä»¶ï¼‰ï¼š
```env
# é€‰æ‹©å‘é‡åŒ–æä¾›å•†
EMBEDDING_PROVIDER=local  # æˆ– openai

# OpenAIï¼ˆå¦‚æœä½¿ç”¨ï¼‰
OPENAI_API_KEY=your_key_here
OPENAI_EMBEDDING_MODEL=text-embedding-3-small

# ç¼“å­˜
EMBEDDING_CACHE_ENABLED=true
EMBEDDING_CACHE_TTL=604800

# åˆ†å—
TEXT_CHUNK_SIZE=500
TEXT_CHUNK_OVERLAP=50
```

---

**åˆ›å»ºæ—¶é—´**: 2025-10-28  
**æ›´æ–°æ—¶é—´**: 2025-10-28  
**å½“å‰å®Œæˆåº¦**: 70%  
**é¢„è®¡å®Œæˆæ—¶é—´**: 2025-10-28ï¼ˆå‰©ä½™1å°æ—¶ï¼‰

**ç»´æŠ¤è€…**: é’ç¾½åç«¯æ¶æ„å›¢é˜Ÿ

