# Phase 3 下一步实施计划

**日期**: 2025-10-29  
**当前进度**: 5/8任务完成（62.5%）  
**状态**: 规划中 📋

---

## 当前成果总结

### ✅ 已完成（5/8）

1. **Gemini API配置** ✅
   - Gemini 2.0 Flash集成
   - LLM工厂类
   - 4/4测试通过

2. **BaseAgent框架升级** ✅
   - PipelineStateV2设计
   - BaseAgentV2简化基类
   - 反思循环状态管理

3. **MCP工具框架** ✅
   - 标准化工具接口
   - LangChain适配器
   - 工具注册机制
   - 8/8测试通过

4. **增强审核Agent** ✅
   - DiagnosticReport结构化诊断
   - 深度根因分析
   - 具体修正指令
   - 3/3测试通过

5. **元调度器** ✅
   - 智能Agent定位
   - 修正策略选择
   - Prompt工程
   - 迭代控制
   - 6/6测试通过

**核心成就**: 反思循环的核心组件全部完成！

---

## 剩余任务分析

### 🔴 任务6: 专业Agent（v2版本）

**优先级**: 高  
**预估时间**: 6-8小时  
**复杂度**: 高

#### 需要实现的Agent
1. **OutlineAgent** - 大纲生成Agent
   - 功能：生成故事大纲结构
   - 输入：用户需求、工作区上下文
   - 输出：结构化大纲（章节、节点）
   - 难度：中高

2. **CharacterAgent** - 角色设计Agent
   - 功能：创建和完善角色
   - 输入：大纲、用户需求
   - 输出：角色卡（性格、背景、关系）
   - 难度：中高

3. **PlotAgent** - 情节安排Agent
   - 功能：设计情节和时间线
   - 输入：大纲、角色
   - 输出：情节事件、时间线
   - 难度：高

#### 实施策略
- **分步实现**：先OutlineAgent → CharacterAgent → PlotAgent
- **简化版本**：先实现核心功能，高级功能后续迭代
- **测试驱动**：每个Agent都编写完整测试
- **文档完善**：详细的使用文档和示例

#### 技术挑战
- ❓ 如何与Go API集成（获取项目数据）
- ❓ 如何与RAG Pipeline集成（检索知识）
- ❓ Prompt工程（需要精心设计）
- ❓ 输出结构化（JSON Schema定义）

#### 依赖关系
- 依赖：WorkspaceContextTool（已完成）
- 依赖：BaseAgentV2（已完成）
- 依赖：LLM Factory（已完成）
- 需要：Go API Client（未完成，可以Mock）
- 需要：RAG Pipeline（未完成，可以Mock）

---

### 🟡 任务7: LangGraph工作流

**优先级**: 中高  
**预估时间**: 4-6小时  
**复杂度**: 中

#### 核心功能
1. **反思循环路由** - 核心！
   - ReviewAgent → MetaScheduler → SpecializedAgent
   - 循环直到通过或达到最大迭代次数

2. **动态Agent路由**
   - 根据执行计划动态选择下一个Agent
   - 支持条件分支和并行执行

3. **错误处理和恢复**
   - Agent执行失败的处理
   - 状态回滚和重试机制
   - 错误日志和监控

#### 实施策略
- **优先反思循环**：这是最核心的功能
- **使用StateGraph**：LangGraph的状态图
- **条件路由**：使用add_conditional_edges
- **完整测试**：端到端工作流测试

#### 技术要点
```python
from langgraph.graph import StateGraph, END

# 创建工作流
workflow = StateGraph(PipelineStateV2)

# 添加节点
workflow.add_node("planner", planner_node)
workflow.add_node("outline", outline_node)
workflow.add_node("character", character_node)
workflow.add_node("plot", plot_node)
workflow.add_node("review", review_node)
workflow.add_node("meta_scheduler", meta_scheduler_node)

# 反思循环路由
def review_router(state):
    if state["review_passed"]:
        return END
    elif state["current_step"] == "human_review":
        return "human_review"
    else:
        return "meta_scheduler"

workflow.add_conditional_edges(
    "review",
    review_router,
    {
        END: END,
        "human_review": "human_review",
        "meta_scheduler": "meta_scheduler"
    }
)

# 元调度路由
def meta_scheduler_router(state):
    return state["current_step"]  # 动态路由

workflow.add_conditional_edges(
    "meta_scheduler",
    meta_scheduler_router,
    {
        "outline": "outline",
        "character": "character",
        "plot": "plot",
    }
)
```

---

### 🟢 任务8: 集成测试和优化

**优先级**: 低（但重要）  
**预估时间**: 6-8小时  
**复杂度**: 中

#### 测试维度
1. **端到端测试**
   - 完整的创作流程测试
   - 反思循环测试
   - 错误场景测试

2. **性能测试**
   - LLM调用次数优化
   - 响应时间测试
   - 并发测试

3. **集成测试**
   - Go API集成测试
   - RAG Pipeline集成测试
   - 数据库集成测试

4. **文档完善**
   - API文档
   - 使用指南
   - 架构文档
   - 部署文档

---

## 推荐实施顺序

### 方案A：完整实现（推荐）

**目标**: 构建完整的可用系统

```
第1天（明天）:
├── 上午: 实现OutlineAgent
│   ├── Agent核心逻辑
│   ├── Prompt工程
│   └── 单元测试
│
└── 下午: 实现CharacterAgent
    ├── Agent核心逻辑
    ├── Prompt工程
    └── 单元测试

第2天:
├── 上午: 实现PlotAgent
│   ├── Agent核心逻辑
│   ├── Prompt工程
│   └── 单元测试
│
└── 下午: LangGraph工作流（第一部分）
    ├── 基础工作流结构
    └── Agent节点集成

第3天:
├── 上午: LangGraph工作流（第二部分）
│   ├── 反思循环路由
│   ├── 动态Agent路由
│   └── 错误处理
│
└── 下午: 集成测试
    ├── 端到端测试
    └── 性能测试

第4天:
└── 文档和优化
    ├── 完善文档
    ├── 代码优化
    └── 部署准备
```

**优势**: 
- ✅ 系统完整可用
- ✅ 所有组件都经过测试
- ✅ 可以立即演示

**挑战**:
- ⚠️ 时间较长（4天）
- ⚠️ 需要持续投入

---

### 方案B：MVP快速实现（灵活）

**目标**: 快速构建最小可用原型

```
阶段1（3-4小时）: 简化的OutlineAgent
├── 核心功能实现
├── 简单Prompt
└── 基础测试

阶段2（3-4小时）: 反思循环工作流
├── Review → MetaScheduler → Outline循环
├── 基础路由
└── 集成测试

阶段3（2-3小时）: 演示和验证
├── 端到端测试
├── 问题修复
└── 文档编写
```

**优势**:
- ✅ 快速看到效果
- ✅ 尽早发现问题
- ✅ 可以根据反馈调整

**挑战**:
- ⚠️ 功能不完整
- ⚠️ 需要后续补充

---

### 方案C：并行开发（高效）

**目标**: 最大化开发效率

```
Track 1: 专业Agent开发
├── Day 1: OutlineAgent
├── Day 2: CharacterAgent  
└── Day 3: PlotAgent

Track 2: 工作流开发（可并行）
├── Day 1-2: LangGraph基础结构
└── Day 3: 反思循环和路由

Track 3: 测试和文档（持续）
└── 每天: 单元测试 + 文档
```

**优势**:
- ✅ 开发效率最高
- ✅ 可以同时推进多个任务
- ✅ 灵活调整优先级

**挑战**:
- ⚠️ 需要多人协作
- ⚠️ 集成复杂度高

---

## 推荐方案

### 🎯 建议采用：**方案B（MVP快速实现）+ 方案A（逐步完善）**

**理由**:
1. **快速验证**：先实现最小可用系统，验证架构设计
2. **降低风险**：尽早发现架构和集成问题
3. **灵活调整**：根据实际情况调整后续计划
4. **持续交付**：每个阶段都有可演示的成果

### 具体实施计划

#### 阶段1：MVP（明天，3-4小时）

**目标**: 实现最小的反思循环

```
1. 简化的OutlineAgent (2小时)
   - 核心生成逻辑
   - 基础Prompt
   - Mock的RAG和API
   - 基本测试

2. 反思循环集成 (1-2小时)
   - LangGraph工作流骨架
   - Outline → Review → MetaScheduler → Outline
   - 端到端测试
```

**交付物**:
- ✅ 可运行的反思循环Demo
- ✅ 基础测试通过
- ✅ 演示文档

#### 阶段2：完善Agent（1-2天）

```
1. 完善OutlineAgent
   - 改进Prompt
   - 增加RAG集成
   - 完整测试

2. 实现CharacterAgent
   - 完整功能
   - Prompt工程
   - 测试覆盖

3. 实现PlotAgent
   - 完整功能
   - Prompt工程
   - 测试覆盖
```

#### 阶段3：工作流和优化（1天）

```
1. 完善LangGraph工作流
   - 动态路由
   - 错误处理
   - 性能优化

2. 集成测试
   - 端到端场景
   - 性能测试
   - 压力测试

3. 文档和部署
   - API文档
   - 使用指南
   - 部署文档
```

---

## 技术准备

### 需要准备的Mock/Stub

由于Go API和RAG Pipeline尚未完全集成，需要准备Mock：

#### 1. Mock Go API Client

```python
# src/infrastructure/go_api/mock_client.py

class MockGoAPIClient:
    """Mock Go API客户端（用于开发测试）"""
    
    async def get_project(self, project_id: str):
        return {
            "id": project_id,
            "title": "测试项目",
            "outline": {...},
            "characters": [...]
        }
    
    async def get_outline(self, project_id: str):
        return {"nodes": [...]}
    
    async def get_characters(self, project_id: str):
        return [{"name": "主角", "traits": [...]}]
```

#### 2. Mock RAG Pipeline

```python
# src/rag/mock_pipeline.py

class MockRAGPipeline:
    """Mock RAG Pipeline（用于开发测试）"""
    
    async def retrieve(self, query: str, top_k: int = 5):
        return [
            {"content": "相关知识1", "score": 0.9},
            {"content": "相关知识2", "score": 0.8},
        ]
```

### Prompt模板准备

需要为每个Agent准备高质量的Prompt模板：

#### OutlineAgent Prompt模板

```python
OUTLINE_SYSTEM_PROMPT = """
你是一个专业的故事大纲设计师，擅长构建完整、有吸引力的故事结构。

你的任务：
1. 分析用户需求和创作意图
2. 设计合理的故事结构（章节、节点）
3. 确保情节连贯、冲突充足
4. 考虑角色发展和主题表达

输出格式（JSON）：
{
  "title": "故事标题",
  "chapters": [
    {
      "chapter_id": 1,
      "title": "章节标题",
      "summary": "章节概要",
      "key_events": ["事件1", "事件2"],
      "characters_involved": ["角色1", "角色2"]
    }
  ]
}
"""
```

---

## 风险和应对

### 风险1：Go API集成困难

**风险等级**: 中  
**影响**: 无法获取项目数据

**应对**:
- 使用Mock先完成开发
- 定义清晰的接口契约
- 预留集成时间
- 准备降级方案（本地文件）

### 风险2：Prompt效果不佳

**风险等级**: 高  
**影响**: 生成质量差

**应对**:
- 准备多个Prompt版本
- A/B测试不同Prompt
- 引入Few-shot示例
- 迭代优化Prompt

### 风险3：性能问题

**风险等级**: 中  
**影响**: 响应时间长

**应对**:
- 并行化Agent执行
- 缓存LLM结果
- 优化Prompt长度
- 引入流式输出

### 风险4：测试覆盖不足

**风险等级**: 中  
**影响**: 隐藏Bug

**应对**:
- 测试驱动开发
- 每个Agent完整测试
- 端到端场景测试
- 集成测试

---

## 成功标准

### MVP阶段
- ✅ 反思循环可运行
- ✅ OutlineAgent能生成基本大纲
- ✅ Review → MetaScheduler → Outline循环正常
- ✅ 基础测试通过

### 完整实现阶段
- ✅ 3个专业Agent全部实现
- ✅ LangGraph工作流完整
- ✅ 端到端测试通过
- ✅ 性能达标（<30s完成一次循环）
- ✅ 文档完善

---

## 下一步行动

### 立即行动（如果继续）

1. **创建OutlineAgent框架** (30分钟)
   ```
   - src/agents/specialized/outline_agent.py
   - src/agents/specialized/__init__.py
   - tests/test_outline_agent.py
   ```

2. **实现基础功能** (1-2小时)
   - Prompt设计
   - 核心生成逻辑
   - 输出格式化

3. **编写测试** (30分钟)
   - 单元测试
   - 集成测试

### 或者明天开始

- 休息调整
- 明天精力充沛地开始MVP阶段

---

## 总结

### 当前位置
```
=====================================> 62.5%
[████████████████████▓▓▓▓▓▓▓▓▓▓▓▓▓]
已完成: 5/8任务
剩余: 3/8任务
核心: 反思循环✅
```

### 下一里程碑
- **MVP**: 1个Agent + 反思循环
- **Beta**: 3个Agent + 完整工作流
- **Release**: 测试 + 文档 + 优化

### 预期时间
- **MVP**: 3-4小时
- **Beta**: 2-3天
- **Release**: 3-4天

---

**规划时间**: 2025-10-29  
**规划人**: Qingyu AI Team  
**状态**: 等待开始 ⏳







