# Phase 3: AI能力提升

**阶段状态**: ⏳ 待开始  
**预计开始**: 2025-11-30  
**预计完成**: 2025-12-28 (4周)  
**本阶段目标**: 实现差异化AI功能，构建技术壁垒

---

## 📊 完成情况总览

- **整体进度**: 0%
- **核心任务**: 0/10

---

## 🎯 阶段目标

### 核心目标
1. RAG检索增强系统
2. AI Agent工具调用框架
3. 设定百科系统
4. 智能大纲生成

### 预期成果
- 完整的RAG检索系统
- Agent自动化工具调用
- 设定百科管理
- AI辅助创作大幅提升

---

## 📋 任务清单

### 3.1 RAG检索增强系统 ⏳

**优先级**: P0  
**工期**: 1.5周

**Week 1: 向量数据库集成**
- [ ] Milvus集成
  - [ ] Milvus服务部署
  - [ ] Go客户端集成
  - [ ] Collection设计
  - [ ] 基础CRUD操作

- [ ] 或Qdrant集成（备选）
  - [ ] Qdrant部署
  - [ ] 客户端集成

**Week 2: 内容索引与检索**
- [ ] 私有知识库索引
  - [ ] Embedding API调用
  - [ ] 文档向量化
  - [ ] 增量索引更新

- [ ] 语义检索
  - [ ] 相似度检索
  - [ ] 混合检索（向量+关键词）
  - [ ] 结果重排序（Rerank）

**Week 3: RAG生成流程**
- [ ] 检索增强生成
  - [ ] 上下文组装
  - [ ] Prompt优化
  - [ ] 引用标注

---

### 3.2 AI Agent工具调用框架 ⏳

**优先级**: P0  
**工期**: 1.5周

**Week 1: Function Calling框架**
- [ ] Tool接口定义
- [ ] 工具注册机制
- [ ] Function Calling适配
- [ ] 工具执行引擎

**Week 2: Agent工具开发**
- [ ] 大纲生成工具
- [ ] 角色卡创建工具
- [ ] 关系图谱生成工具
- [ ] 设定生成工具

**Week 3: 前端集成**
- [ ] Agent界面
- [ ] 工具调用可视化
- [ ] 生成结果预览

---

## 📋 v2.0 升级：从流水线到协作生态

**参考文档**: 
- `doc/design/ai/phase3/05.A2A创作流水线Agent设计_v2.0_智能协作生态.md`
- `doc/design/ai/phase3/A2A流水线v2.0改进总结.md`

### 3.4 反思与自我修正循环 ⏳

**优先级**: P0  
**工期**: 4周  
**理论基础**: Reflexion, Self-Refine

**Week 1-2: 增强审核Agent**
- [ ] 设计结构化诊断报告 Schema
  - [ ] 问题根因分析格式
  - [ ] 修正指令格式
  - [ ] 受影响实体追踪
- [ ] 增强审核 Agent Prompt（生成 JSON 诊断报告）
- [ ] 实现诊断报告解析和验证
- [ ] 单元测试（模拟各种问题场景）

**Week 3-4: 元调度器 (Meta-Scheduler)**
- [ ] 实现 `meta_scheduler_node`
- [ ] 诊断报告分析逻辑
  - [ ] 智能定位问题 Agent
  - [ ] 受影响分析
- [ ] 修正 Prompt 生成
  - [ ] 增强版 Prompt（包含诊断结果）
  - [ ] 上下文注入
- [ ] 修正策略选择
  - [ ] 增量修复 (incremental_fix)
  - [ ] 全量重新生成 (regenerate)
  - [ ] 决策逻辑
- [ ] 迭代次数控制和降级
- [ ] 集成测试

**预期效果**:
- ✅ 迭代次数减少 40%
- ✅ 一次通过率提升 60%
- ✅ 修正精准度提升

---

### 3.5 工作区上下文感知工具 ⏳

**优先级**: P0  
**工期**: 3周  
**灵感来源**: Cursor AI

**Week 1: WorkspaceContextTool 实现**
- [ ] 实现工作区上下文工具
- [ ] 支持任务类型识别
  - [ ] `continue_writing` - 续写任务
  - [ ] `create_chapter` - 新建章节
  - [ ] `review_content` - 审核任务
- [ ] 结构化上下文构建
  - [ ] 前序内容提取
  - [ ] 相关角色卡加载
  - [ ] 大纲节点获取
  - [ ] 时间线事件关联
- [ ] 单元测试

**Week 2: 结构化 RAG 增强**
- [ ] 向量化时注入元数据
  - [ ] 扩展 VectorDocument 模型
  - [ ] 元数据字段设计（doc_type, character_id, traits等）
- [ ] 实现混合检索
  - [ ] 结构化过滤 + 向量相似度
  - [ ] MilvusClient 查询增强
- [ ] 更新 Milvus Collection Schema
- [ ] 性能测试

**Week 3: 集成与优化**
- [ ] Agent 集成工作区上下文工具
  - [ ] outline_agent_v2 集成
  - [ ] character_agent_v2 集成
  - [ ] plot_agent_v2 集成
- [ ] Prompt 增强（利用结构化上下文）
- [ ] 缓存策略优化
- [ ] 端到端测试

**预期效果**:
- ✅ 上下文理解力提升 40%+
- ✅ Token 消耗减少 30%
- ✅ 生成质量提升

---

### 3.6 规划 Agent (Planner Agent) ⏳

**优先级**: P1  
**工期**: 4周  
**灵感来源**: AutoGPT, Plan-and-Solve

**Week 1-2: 规划 Agent 实现**
- [ ] 实现 `planner_agent_node`
- [ ] 需求分析逻辑
  - [ ] 需求类型识别（新建/扩展/修改）
  - [ ] 复杂度评估
  - [ ] 所需能力分析
- [ ] 执行计划生成
  - [ ] Agent 序列生成
  - [ ] 工具配置
  - [ ] 依赖关系分析
  - [ ] Token 估算
- [ ] Prompt 工程
- [ ] 单元测试

**Week 3: 动态路由器**
- [ ] 实现动态路由器（根据执行计划）
- [ ] 更新 `PipelineStateV2` Schema
- [ ] 更新 workflow v2.0
  - [ ] 规划 Agent 入口
  - [ ] 动态路由逻辑
- [ ] 集成测试

**Week 4: 扩展与优化**
- [ ] 新增 WorldviewAgent（可选）
- [ ] 计划调整逻辑
  - [ ] 运行时计划修正
  - [ ] 错误恢复
- [ ] Token 估算准确性优化
- [ ] 端到端测试
- [ ] 文档完善

**预期效果**:
- ✅ 执行流程灵活性提升 10x
- ✅ 可扩展性大幅提升
- ✅ 新 Agent 开发效率提升 200%

---

### 3.7 知识图谱集成（长期演进）⏳

**优先级**: P2  
**工期**: 8周  
**实施阶段**: Phase 4 (6个月后)

**Week 1-2: 图数据库集成**
- [ ] Neo4j 部署配置
- [ ] Go Neo4j 客户端集成
- [ ] 基础 CRUD 操作
- [ ] 连接池管理

**Week 3-4: 知识图谱构建**
- [ ] 实体抽取
  - [ ] Character 节点
  - [ ] Location 节点
  - [ ] Event 节点
  - [ ] Item 节点
- [ ] 关系抽取
  - [ ] knows, friend_of, enemy_of
  - [ ] visited, owns
  - [ ] participated_in
- [ ] 图谱构建 Pipeline
- [ ] 事件驱动更新

**Week 5-6: 混合查询引擎**
- [ ] 图查询实现（Cypher）
- [ ] 向量查询实现
- [ ] 结果融合算法
- [ ] KnowledgeGraphTool 封装

**Week 7-8: 集成与优化**
- [ ] Agent 集成 KG Tool
- [ ] 查询性能优化
- [ ] 索引优化
- [ ] 测试覆盖

**预期效果**:
- ✅ 复杂关系查询能力
- ✅ 推理能力提升
- ✅ 精准度 + 召回率双提升

---

### 3.3 设定百科系统 ⏳

**优先级**: P1  
**工期**: 1周

**角色卡管理**
- [ ] CharacterCard模型
- [ ] 角色卡CRUD
- [ ] 自定义属性字段
- [ ] 关联到项目

**世界观设定**
- [ ] WorldSetting模型
- [ ] 设定分类管理
- [ ] 设定关联引用

**设定模板库**
- [ ] 内置设定模板
- [ ] 用户自定义模板
- [ ] 模板导入导出

---

## 📊 质量标准

| 指标 | 目标值 |
|------|--------|
| RAG检索准确率 | ≥85% |
| Agent工具成功率 | ≥90% |
| 大纲生成质量 | 用户满意度≥80% |

---

**详细任务将在Phase2完成后补充**

---

**文档最后更新**: 2025-10-24

