# SessionService Bugè¯Šæ–­æŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-29  
**è¯Šæ–­äºº**: AI Assistant  
**æ–‡ä»¶**: `service/shared/auth/session_service.go`  
**ä»£ç è¡Œæ•°**: 374è¡Œ

---

## ä¸€ã€Bugæ¸…å•

### ğŸ”´ Bug #1: ç¼ºå°‘å®šæ—¶æ¸…ç†æœºåˆ¶

**ä¸¥é‡ç¨‹åº¦**: é«˜  
**å½±å“**: è¿‡æœŸSessionæœªåŠæ—¶æ¸…ç†ï¼Œå¯èƒ½å¯¼è‡´Rediså†…å­˜æµªè´¹

**é—®é¢˜æè¿°**:
- ä»£ç ä¾èµ–Redisçš„è‡ªåŠ¨è¿‡æœŸæœºåˆ¶ï¼ˆTTLï¼‰
- ä½†ç”¨æˆ·ä¼šè¯åˆ—è¡¨ï¼ˆ`user_sessions:{userID}`ï¼‰çš„TTLæ¯”å•ä¸ªSessioné•¿24å°æ—¶ï¼ˆç¬¬361è¡Œï¼‰
- å¦‚æœç”¨æˆ·é•¿æœŸä¸ç™»å½•ï¼Œä¼šè¯åˆ—è¡¨å¯èƒ½åŒ…å«å¤§é‡è¿‡æœŸSession ID

**å½“å‰ä»£ç **:
```go
// ç¬¬361è¡Œ
return s.cacheClient.Set(ctx, userSessionsKey, string(data), s.sessionTTL+24*time.Hour)
```

**ä¿®å¤æ–¹æ¡ˆ**:
1. æ·»åŠ å®šæ—¶æ¸…ç†ä»»åŠ¡ï¼ˆæ¯å°æ—¶æ‰§è¡Œï¼‰
2. æ¸…ç†è¿‡æœŸçš„ç”¨æˆ·ä¼šè¯åˆ—è¡¨
3. è®°å½•æ¸…ç†æ—¥å¿—

---

### ğŸŸ¡ Bug #2: GetUserSessionsæ€§èƒ½é—®é¢˜

**ä¸¥é‡ç¨‹åº¦**: ä¸­  
**å½±å“**: æ¯æ¬¡è°ƒç”¨éƒ½è¦é€ä¸ªæŸ¥è¯¢Redisï¼ŒO(n)å¤æ‚åº¦

**é—®é¢˜æè¿°**:
- ç¬¬186-194è¡Œé€ä¸ªè°ƒç”¨`GetSession`
- å¦‚æœç”¨æˆ·æœ‰10ä¸ªSessionï¼Œéœ€è¦11æ¬¡RedisæŸ¥è¯¢ï¼ˆ1æ¬¡è·å–åˆ—è¡¨ + 10æ¬¡è·å–è¯¦æƒ…ï¼‰
- é«˜å¹¶å‘æ—¶å¯èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆ

**å½“å‰ä»£ç **:
```go
for _, sessionID := range sessionIDs {
    session, err := s.GetSession(ctx, sessionID)
    if err != nil {
        continue
    }
    sessions = append(sessions, session)
    validSessionIDs = append(validSessionIDs, sessionID)
}
```

**ä¿®å¤æ–¹æ¡ˆ**:
1. ä½¿ç”¨Redis Pipelineæ‰¹é‡è·å–Session
2. æˆ–è€…è€ƒè™‘ä½¿ç”¨Redis Hashå­˜å‚¨ç”¨æˆ·æ‰€æœ‰Sessionï¼ˆç»“æ„é‡æ„ï¼‰
3. æœ¬æ¬¡ä¿®å¤ï¼šæš‚ä¸å¤„ç†ï¼Œæ ‡è®°TODO

---

### ğŸŸ¡ Bug #3: ç¼ºå°‘å¹¶å‘æ§åˆ¶

**ä¸¥é‡ç¨‹åº¦**: ä¸­  
**å½±å“**: å¹¶å‘åˆ›å»º/åˆ é™¤Sessionå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

**é—®é¢˜æè¿°**:
- `addSessionToUserList`ï¼ˆç¬¬292-316è¡Œï¼‰å­˜åœ¨è¯»-æ”¹-å†™ç«äº‰
- ä¸¤ä¸ªå¹¶å‘è¯·æ±‚å¯èƒ½éƒ½è¯»å–åˆ°ç›¸åŒçš„åˆ—è¡¨ï¼Œç„¶åå„è‡ªæ·»åŠ Sessionï¼Œæœ€åä¸€ä¸ªå†™å…¥è¦†ç›–å‰ä¸€ä¸ª

**å½“å‰ä»£ç **:
```go
// ç¬¬296-300è¡Œï¼šè¯»å–
value, err := s.cacheClient.Get(ctx, userSessionsKey)
var sessionIDs []string
if err == nil {
    _ = json.Unmarshal([]byte(value), &sessionIDs)
}

// ç¬¬302-315è¡Œï¼šä¿®æ”¹å’Œå†™å…¥
sessionIDs = append(sessionIDs, sessionID)
return s.saveUserSessionList(ctx, userID, sessionIDs)
```

**ä¿®å¤æ–¹æ¡ˆ**:
1. ä½¿ç”¨Redisåˆ†å¸ƒå¼é”ï¼ˆSETNXï¼‰
2. æˆ–è€…ä½¿ç”¨RedisåŸå­æ“ä½œï¼ˆä½†éœ€è¦æ”¹å˜æ•°æ®ç»“æ„ï¼‰
3. æœ¬æ¬¡ä¿®å¤ï¼šæ·»åŠ ç®€å•çš„é‡è¯•æœºåˆ¶

---

### ğŸŸ¢ Bug #4: RefreshSessionæœªæ›´æ–°Redis TTL

**ä¸¥é‡ç¨‹åº¦**: ä½ï¼ˆå®é™…ä¸Šæ˜¯æ­£ç¡®çš„ï¼‰  
**å½±å“**: æ— å®é™…å½±å“ï¼ˆç»è¿‡åˆ†æï¼Œä»£ç æ˜¯æ­£ç¡®çš„ï¼‰

**é—®é¢˜æè¿°**:
- åˆçœ‹ç¬¬151è¡Œçš„`Set`æ“ä½œä½¿ç”¨äº†`s.sessionTTL`
- ä½†è¿™å®é™…ä¸Šæ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›ä»åˆ·æ–°æ—¶é—´ç‚¹å¼€å§‹é‡æ–°è®¡æ—¶

**å½“å‰ä»£ç **:
```go
// ç¬¬146è¡Œï¼šæ­£ç¡®æ›´æ–°è¿‡æœŸæ—¶é—´
session.ExpiresAt = time.Now().Add(s.sessionTTL)

// ç¬¬151è¡Œï¼šæ­£ç¡®è®¾ç½®Redis TTL
if err := s.cacheClient.Set(ctx, key, value, s.sessionTTL); err != nil {
```

**ç»“è®º**: æ— éœ€ä¿®å¤ï¼Œä»£ç é€»è¾‘æ­£ç¡®

---

### ğŸŸ¢ Bug #5: DestroySessioné”™è¯¯å¤„ç†ä¸å½“

**ä¸¥é‡ç¨‹åº¦**: ä½  
**å½±å“**: Sessionå·²è¿‡æœŸæ—¶ï¼Œä»å°è¯•åˆ é™¤ï¼Œä½†ä¸å½±å“æœ€ç»ˆç»“æœ

**é—®é¢˜æè¿°**:
- ç¬¬118-121è¡Œå¿½ç•¥GetSessioné”™è¯¯
- ä½†è¿™å®é™…ä¸Šæ˜¯åˆç†çš„ï¼Œå› ä¸ºSessionå¯èƒ½å·²è¿‡æœŸ

**å½“å‰ä»£ç **:
```go
// ç¬¬118-121è¡Œ
session, err := s.GetSession(ctx, sessionID)
if err != nil {
    // ä¼šè¯å¯èƒ½å·²è¿‡æœŸï¼Œç»§ç»­åˆ é™¤
}
```

**ç»“è®º**: ä»£ç é€»è¾‘åˆç†ï¼Œæ— éœ€ä¿®å¤

---

## äºŒã€ä¿®å¤ä¼˜å…ˆçº§

| Bug | ä¸¥é‡ç¨‹åº¦ | ä¼˜å…ˆçº§ | ä¿®å¤å·¥æœŸ |
|-----|---------|-------|---------|
| #1 å®šæ—¶æ¸…ç†æœºåˆ¶ | ğŸ”´ é«˜ | P0 | 2å°æ—¶ |
| #2 æ€§èƒ½ä¼˜åŒ– | ğŸŸ¡ ä¸­ | P1 | æ ‡è®°TODO |
| #3 å¹¶å‘æ§åˆ¶ | ğŸŸ¡ ä¸­ | P0 | 2å°æ—¶ |
| #4 RefreshSession | ğŸŸ¢ ä½ | - | æ— éœ€ä¿®å¤ |
| #5 DestroySession | ğŸŸ¢ ä½ | - | æ— éœ€ä¿®å¤ |

**ä»Šæ—¥ä¿®å¤**: Bug #1 + Bug #3ï¼ˆå…±4å°æ—¶ï¼‰  
**æ ‡è®°TODO**: Bug #2

---

## ä¸‰ã€ä¿®å¤è®¡åˆ’

### Phase 1: æ·»åŠ å®šæ—¶æ¸…ç†æœºåˆ¶ï¼ˆ2å°æ—¶ï¼‰

#### æ­¥éª¤1: åˆ›å»ºæ¸…ç†æ–¹æ³•
```go
// CleanupExpiredSessions æ¸…ç†è¿‡æœŸä¼šè¯ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
func (s *SessionServiceImpl) CleanupExpiredSessions(ctx context.Context) error {
    // æ‰«ææ‰€æœ‰ç”¨æˆ·ä¼šè¯åˆ—è¡¨
    // æ¸…ç†è¿‡æœŸçš„Session ID
    // è®°å½•æ¸…ç†æ—¥å¿—
}
```

#### æ­¥éª¤2: å¯åŠ¨å®šæ—¶ä»»åŠ¡
- åœ¨`Initialize()`æ–¹æ³•ä¸­å¯åŠ¨goroutine
- æ¯1å°æ—¶æ‰§è¡Œä¸€æ¬¡æ¸…ç†
- ä¼˜é›…å…³é—­æ”¯æŒ

#### æ­¥éª¤3: æµ‹è¯•
- å•å…ƒæµ‹è¯•
- æ¨¡æ‹Ÿè¿‡æœŸSession
- éªŒè¯æ¸…ç†æ•ˆæœ

---

### Phase 2: æ·»åŠ å¹¶å‘æ§åˆ¶ï¼ˆ2å°æ—¶ï¼‰

#### æ­¥éª¤1: å®ç°åˆ†å¸ƒå¼é”
```go
// acquireUserSessionLock è·å–ç”¨æˆ·ä¼šè¯åˆ—è¡¨é”
func (s *SessionServiceImpl) acquireUserSessionLock(
    ctx context.Context, 
    userID string, 
    ttl time.Duration
) (bool, error)

// releaseUserSessionLock é‡Šæ”¾ç”¨æˆ·ä¼šè¯åˆ—è¡¨é”
func (s *SessionServiceImpl) releaseUserSessionLock(
    ctx context.Context, 
    userID string
) error
```

#### æ­¥éª¤2: åœ¨å…³é”®æ“ä½œä¸­ä½¿ç”¨é”
- `addSessionToUserList`
- `removeSessionFromUserList`

#### æ­¥éª¤3: æµ‹è¯•
- å¹¶å‘æµ‹è¯•
- å‹åŠ›æµ‹è¯•

---

### Phase 3: æ ‡è®°æ€§èƒ½ä¼˜åŒ–TODOï¼ˆ5åˆ†é’Ÿï¼‰

#### åœ¨ç›¸å…³æ–¹æ³•æ·»åŠ æ³¨é‡Š
```go
// TODO(performance): ä½¿ç”¨Redis Pipelineæ‰¹é‡è·å–Sessionï¼Œå‡å°‘ç½‘ç»œå¾€è¿”
// å½“å‰å®ç°: O(n)æ¬¡RedisæŸ¥è¯¢
// ä¼˜åŒ–å: 2æ¬¡RedisæŸ¥è¯¢ï¼ˆ1æ¬¡åˆ—è¡¨ + 1æ¬¡Pipelineï¼‰
// ä¼˜å…ˆçº§: P1ï¼ˆPhase 3.5æˆ–Phase 4ï¼‰
```

---

## å››ã€æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•

**æ–°å¢æµ‹è¯•æ–‡ä»¶**: `test/service/shared/session_service_bug_fix_test.go`

**æµ‹è¯•ç”¨ä¾‹**:
1. `TestCleanupExpiredSessions` - æµ‹è¯•æ¸…ç†è¿‡æœŸSession
2. `TestConcurrentAddSession` - æµ‹è¯•å¹¶å‘æ·»åŠ Session
3. `TestConcurrentRemoveSession` - æµ‹è¯•å¹¶å‘ç§»é™¤Session
4. `TestSessionLock` - æµ‹è¯•åˆ†å¸ƒå¼é”

### é›†æˆæµ‹è¯•

**æµ‹è¯•åœºæ™¯**:
1. åˆ›å»ºå¤šä¸ªSessionï¼Œç­‰å¾…è¿‡æœŸï¼ŒéªŒè¯æ¸…ç†
2. å¹¶å‘100ä¸ªè¯·æ±‚åˆ›å»ºSessionï¼ŒéªŒè¯æ•°æ®ä¸€è‡´æ€§
3. å¹¶å‘ç™»å½•å’Œç™»å‡ºï¼ŒéªŒè¯ä¼šè¯åˆ—è¡¨æ­£ç¡®

### æ€§èƒ½æµ‹è¯•

**æµ‹è¯•æŒ‡æ ‡**:
- Sessionåˆ›å»ºå“åº”æ—¶é—´ < 50ms
- SessionæŸ¥è¯¢å“åº”æ—¶é—´ < 20ms
- å¹¶å‘1000 QPSï¼Œæ— æ•°æ®ä¸¢å¤±

---

## äº”ã€é£é™©è¯„ä¼°

### é£é™©1: å®šæ—¶æ¸…ç†ä»»åŠ¡å¤±è´¥

**å½±å“**: ä½  
**æ¦‚ç‡**: ä½  
**åº”å¯¹**: 
- æ·»åŠ panic recovery
- è®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—
- å¤±è´¥ä¸å½±å“ä¸»ä¸šåŠ¡

### é£é™©2: åˆ†å¸ƒå¼é”æ­»é”

**å½±å“**: é«˜  
**æ¦‚ç‡**: æä½  
**åº”å¯¹**: 
- é”è®¾ç½®TTLï¼ˆ10ç§’ï¼‰
- ä½¿ç”¨deferé‡Šæ”¾é”
- æ·»åŠ é”è¶…æ—¶æ£€æµ‹

### é£é™©3: ä¿®å¤å¼•å…¥æ–°Bug

**å½±å“**: é«˜  
**æ¦‚ç‡**: ä¸­  
**åº”å¯¹**: 
- å……åˆ†çš„å•å…ƒæµ‹è¯•
- é›†æˆæµ‹è¯•éªŒè¯
- Code Review
- ç°åº¦å‘å¸ƒ

---

## å…­ã€å®æ–½æ£€æŸ¥æ¸…å•

**Phase 1: å®šæ—¶æ¸…ç†**
- [ ] å®ç°`CleanupExpiredSessions`æ–¹æ³•
- [ ] å¯åŠ¨å®šæ—¶ä»»åŠ¡
- [ ] æ·»åŠ æ—¥å¿—è®°å½•
- [ ] å•å…ƒæµ‹è¯•
- [ ] éªŒè¯æ¸…ç†æ•ˆæœ

**Phase 2: å¹¶å‘æ§åˆ¶**
- [ ] å®ç°åˆ†å¸ƒå¼é”
- [ ] æ›´æ–°`addSessionToUserList`
- [ ] æ›´æ–°`removeSessionFromUserList`
- [ ] å¹¶å‘æµ‹è¯•
- [ ] å‹åŠ›æµ‹è¯•

**Phase 3: æ€§èƒ½TODO**
- [ ] æ·»åŠ TODOæ³¨é‡Š
- [ ] æ–‡æ¡£è®°å½•

**Phase 4: æœ€ç»ˆéªŒè¯**
- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] Code Review
- [ ] æ–‡æ¡£æ›´æ–°

---

## ä¸ƒã€ä¿®å¤åçš„é¢„æœŸæ”¹è¿›

### åŠŸèƒ½æ”¹è¿›
- âœ… è¿‡æœŸSessionè‡ªåŠ¨æ¸…ç†
- âœ… å¹¶å‘æ“ä½œæ•°æ®ä¸€è‡´æ€§
- âœ… æ›´å¥½çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—

### æ€§èƒ½æ”¹è¿›
- âœ… å‡å°‘Rediså†…å­˜ä½¿ç”¨
- âœ… å¹¶å‘æ“ä½œæ›´å®‰å…¨
- ğŸ“ æŸ¥è¯¢æ€§èƒ½ï¼ˆæ ‡è®°TODOï¼‰

### ç¨³å®šæ€§æ”¹è¿›
- âœ… æ— æ•°æ®ä¸¢å¤±
- âœ… æ— ç«æ€æ¡ä»¶
- âœ… ä¼˜é›…å…³é—­

---

**è¯Šæ–­å®Œæˆæ—¶é—´**: 2025-10-29  
**é¢„è®¡ä¿®å¤æ—¶é—´**: 4å°æ—¶  
**é£é™©ç­‰çº§**: ä½

**ä¸‹ä¸€æ­¥**: å¼€å§‹å®æ–½ä¿®å¤

