# Task 4: 自动保存功能实施方案

**日期**: 2025-10-29 深夜  
**状态**: 🔄 进行中  
**预计工期**: 1.5天（压缩到4小时）

---

## 📊 现状分析

### 已有基础

✅ **DocumentContentRepository**（完整）:
- `GetByDocumentID()` - 获取文档内容
- `UpdateWithVersion()` - 乐观锁版本更新
- `Create()` - 创建文档内容

✅ **DocumentService**（部分完成）:
- `AutoSaveDocument()` - 已实现框架，但有TODO
- `GetDocumentContent()` - 已实现框架，但返回空
- `UpdateDocumentContent()` - 已实现框架，但未保存

✅ **DTO和API**:
- `AutoSaveRequest/Response` - 已定义
- `SaveStatusResponse` - 已定义
- `DocumentContentResponse` - 已定义

### 待修复的问题

❌ **DocumentService未注入DocumentContentRepository**:
- 当前只注入了 `documentRepo` 和 `projectRepo`
- 需要注入 `DocumentContentRepository`

❌ **AutoSaveDocument**（606-693行）:
- TODO（668行）：内容未保存到DocumentContent集合
- TODO（642行）：版本冲突检测简化处理
- 缺少真实版本号获取

❌ **GetDocumentContent**（723-767行）:
- TODO（756行）：内容获取返回空字符串

❌ **UpdateDocumentContent**（770-836行）:
- TODO（820行）：内容保存未实现
- TODO（803行）：版本冲突检测未实现

---

## 🎯 实施策略

采用**渐进式修复**策略：

**Phase 1（核心）**: 完成基础自动保存（2小时）
- 注入DocumentContentRepository
- 完善AutoSaveDocument保存逻辑
- 实现GetDocumentContent获取逻辑
- 实现UpdateDocumentContent保存逻辑
- 版本控制（乐观锁）

**Phase 2（可选）**: 高级功能（延后到Phase 4）
- 定时触发（依赖前端）
- 变化检测（依赖前端）
- 版本历史记录
- 冲突解决UI

---

## 📋 详细实施步骤

### Step 1: 注入DocumentContentRepository（30分钟）

**修改文件**: `service/document/document_service.go`

**1.1 添加字段**:
```go
type DocumentService struct {
    documentRepo        writingRepo.DocumentRepository
    documentContentRepo writingRepo.DocumentContentRepository  // 新增
    projectRepo         writingRepo.ProjectRepository
    eventBus            base.EventBus
    serviceName         string
    version             string
}
```

**1.2 修改构造函数**:
```go
func NewDocumentService(
    documentRepo writingRepo.DocumentRepository,
    documentContentRepo writingRepo.DocumentContentRepository,  // 新增参数
    projectRepo writingRepo.ProjectRepository,
    eventBus base.EventBus,
) *DocumentService
```

**1.3 更新服务注册**（稍后处理）

---

### Step 2: 完善AutoSaveDocument（1小时）

**当前问题**（606-693行）:
- 内容未保存到DocumentContent
- 版本控制简化

**实施方案**:

```go
func (s *DocumentService) AutoSaveDocument(ctx context.Context, req *AutoSaveRequest) (*AutoSaveResponse, error) {
    // ... 前置验证（已完成）...

    // 4. 获取或创建DocumentContent
    content, err := s.documentContentRepo.GetByDocumentID(ctx, req.DocumentID)
    if err != nil {
        return nil, err
    }
    
    if content == nil {
        // 首次保存，创建新DocumentContent
        content = &writer.DocumentContent{
            DocumentID: req.DocumentID,
            Content:    req.Content,
            Version:    1,
        }
        err = s.documentContentRepo.Create(ctx, content)
    } else {
        // 更新现有内容（带版本检测）
        expectedVersion := req.CurrentVersion
        if expectedVersion == 0 {
            expectedVersion = content.Version
        }
        
        err = s.documentContentRepo.UpdateWithVersion(
            ctx,
            req.DocumentID,
            req.Content,
            expectedVersion,
        )
        
        if err != nil {
            // 版本冲突
            return &AutoSaveResponse{
                Saved:       false,
                HasConflict: true,
                NewVersion:  content.Version,
            }, nil
        }
        
        // 更新成功后重新获取最新内容
        content, _ = s.documentContentRepo.GetByDocumentID(ctx, req.DocumentID)
    }
    
    // 5. 计算字数并更新Document元数据
    wordCount := len([]rune(req.Content))
    updates := map[string]interface{}{
        "word_count": wordCount,
        "updated_at": time.Now(),
    }
    s.documentRepo.Update(ctx, req.DocumentID, updates)
    
    // 6. 发布事件（已有）
    
    // 7. 返回响应
    return &AutoSaveResponse{
        Saved:       true,
        NewVersion:  content.Version,
        WordCount:   wordCount,
        SavedAt:     time.Now(),
        HasConflict: false,
    }, nil
}
```

**关键改进**:
- ✅ 实际保存内容到DocumentContent
- ✅ 使用UpdateWithVersion实现乐观锁
- ✅ 版本冲突时返回HasConflict=true
- ✅ 首次保存时自动创建DocumentContent

---

### Step 3: 完善GetDocumentContent（30分钟）

**当前问题**（723-767行）:
- 返回空字符串

**实施方案**:

```go
func (s *DocumentService) GetDocumentContent(ctx context.Context, documentID string) (*DocumentContentResponse, error) {
    // ... 前置验证（已完成）...
    
    // 4. 获取内容
    content, err := s.documentContentRepo.GetByDocumentID(ctx, documentID)
    if err != nil {
        return nil, pkgErrors.NewServiceError(s.serviceName, pkgErrors.ServiceErrorInternal, "查询文档内容失败", "", err)
    }
    
    actualContent := ""
    version := 1
    if content != nil {
        actualContent = content.Content
        version = content.Version
    }
    
    // 5. 返回内容响应
    return &DocumentContentResponse{
        DocumentID: documentID,
        Content:    actualContent,
        Version:    version,
        WordCount:  doc.WordCount,
        UpdatedAt:  doc.UpdatedAt,
    }, nil
}
```

**关键改进**:
- ✅ 从DocumentContentRepository实际获取内容
- ✅ 返回真实版本号
- ✅ 处理DocumentContent不存在的情况

---

### Step 4: 完善UpdateDocumentContent（30分钟）

**当前问题**（770-836行）:
- 内容未保存
- 版本冲突检测未实现

**实施方案**:

```go
func (s *DocumentService) UpdateDocumentContent(ctx context.Context, req *UpdateContentRequest) error {
    // ... 前置验证（已完成）...
    
    // 4. 版本冲突检测
    if req.Version > 0 {
        content, err := s.documentContentRepo.GetByDocumentID(ctx, req.DocumentID)
        if err != nil {
            return pkgErrors.NewServiceError(s.serviceName, pkgErrors.ServiceErrorInternal, "查询文档内容失败", "", err)
        }
        
        if content != nil && content.Version != req.Version {
            return pkgErrors.NewServiceError(s.serviceName, pkgErrors.ServiceErrorBusiness, "版本冲突，请刷新后重试", "", nil)
        }
    }
    
    // 5. 保存内容
    err := s.documentContentRepo.UpdateWithVersion(ctx, req.DocumentID, req.Content, req.Version)
    if err != nil {
        if err.Error() == "版本冲突，请重新获取最新内容" {
            return pkgErrors.NewServiceError(s.serviceName, pkgErrors.ServiceErrorBusiness, "版本冲突，请刷新后重试", "", err)
        }
        return pkgErrors.NewServiceError(s.serviceName, pkgErrors.ServiceErrorInternal, "保存内容失败", "", err)
    }
    
    // 6. 计算字数并更新文档元数据
    wordCount := len([]rune(req.Content))
    updates := map[string]interface{}{
        "word_count": wordCount,
        "updated_at": time.Now(),
    }
    s.documentRepo.Update(ctx, req.DocumentID, updates)
    
    // 7. 发布事件（已有）
    
    return nil
}
```

**关键改进**:
- ✅ 实际保存内容到DocumentContentRepository
- ✅ 版本冲突检测和返回
- ✅ 使用UpdateWithVersion保证原子性

---

### Step 5: 更新服务注册（30分钟）

**需要修改的文件**:
- `cmd/server/main.go` 或
- `core/server.go`

**修改内容**:
```go
// 创建DocumentContentRepository
documentContentRepo := factory.CreateDocumentContentRepository()

// 注入到DocumentService
documentService := document.NewDocumentService(
    documentRepo,
    documentContentRepo,  // 新增
    projectRepo,
    eventBus,
)
```

---

## ⏱️ 时间分配

| 步骤 | 预计时间 | 说明 |
|-----|---------|------|
| Step 1: 注入Repository | 30分钟 | 修改结构和构造函数 |
| Step 2: AutoSaveDocument | 1小时 | 核心保存逻辑 |
| Step 3: GetDocumentContent | 30分钟 | 获取内容 |
| Step 4: UpdateDocumentContent | 30分钟 | 更新内容 |
| Step 5: 服务注册 | 30分钟 | 集成到系统 |
| Step 6: 测试修复 | 30分钟 | Lint和基础测试 |
| **总计** | **4小时** | **压缩实施** |

---

## ✅ 验收标准

### 功能验收
- [ ] AutoSaveDocument实际保存内容到DocumentContent
- [ ] GetDocumentContent返回真实内容
- [ ] UpdateDocumentContent实际更新内容
- [ ] 版本冲突检测正常工作
- [ ] 首次保存自动创建DocumentContent

### 质量验收
- [ ] 0 lint错误
- [ ] 0编译错误
- [ ] 服务注册正常
- [ ] 基础功能测试通过

### 延后功能
- ⏸️ 定时触发（前端实现）
- ⏸️ 变化检测（前端实现）
- ⏸️ 版本历史UI（Phase 4）
- ⏸️ 冲突解决UI（Phase 4）

---

## 📝 实施记录

**开始时间**: 2025-10-29 深夜  
**预计完成**: 2025-10-30 凌晨

**下一步**: Step 1 - 注入DocumentContentRepository

