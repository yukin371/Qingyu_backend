# Task 2: 数据统计实际Repository查询实施方案

**日期**: 2025-10-29  
**状态**: 🔄 进行中  
**预计工期**: 2天（压缩到1天）

---

## 📊 现状分析

### 当前问题

**PlatformStatsService** 所有方法都返回Mock数据：
- `GetUserStats()` - Mock ❌
- `GetPlatformUserStats()` - Mock ❌  
- `GetContentStats()` - Mock ❌
- `GetPlatformContentStats()` - Mock ❌
- `GetUserActivityStats()` - Mock ❌
- `GetRevenueStats()` - Mock ❌

**ReadingStatsService** 已实现实际查询 ✅

---

## 🎯 实施策略

### 策略：渐进式实现

考虑到时间和复杂度，采用**分阶段实现**：

**Phase 1 (今日完成)**:
- ✅ 实现核心用户统计（GetUserStats）
- ✅ 实现核心内容统计（GetContentStats）
- ✅ 注入必要的Repository

**Phase 2 (延后到Task 3)**:
- MongoDB聚合查询（GetPlatformUserStats）
- MongoDB聚合查询（GetPlatformContentStats）
- 活跃度和收益统计

**理由**: 
- 核心统计可用基础查询实现
- 平台级统计需要复杂聚合（Task 3）
- 快速验证功能可用性

---

## 📋 详细实施步骤

### Step 1: 注入Repository依赖（30分钟）

修改`PlatformStatsServiceImpl`结构体：

```go
type PlatformStatsServiceImpl struct {
    userRepo    repository.UserRepository
    bookRepo    repository.BookRepository
    projectRepo repository.ProjectRepository
    chapterRepo repository.ChapterRepository
    initialized bool
}

func NewPlatformStatsService(
    userRepo repository.UserRepository,
    bookRepo repository.BookRepository,
    projectRepo repository.ProjectRepository,
    chapterRepo repository.ChapterRepository,
) PlatformStatsService {
    return &PlatformStatsServiceImpl{
        userRepo:    userRepo,
        bookRepo:    bookRepo,
        projectRepo: projectRepo,
        chapterRepo: chapterRepo,
    }
}
```

### Step 2: 实现GetUserStats（1小时）

替换Mock数据为实际查询：

```go
func (s *PlatformStatsServiceImpl) GetUserStats(ctx context.Context, userID string) (*UserStats, error) {
    // 1. 获取用户基本信息
    user, err := s.userRepo.GetByID(ctx, userID)
    if err != nil {
        return nil, err
    }
    
    // 2. 统计项目数
    projectCount, _ := s.projectRepo.CountByUserID(ctx, userID)
    
    // 3. 统计书籍数
    books, _ := s.bookRepo.FindByAuthorID(ctx, userID)
    bookCount := len(books)
    
    // 4. 统计总字数
    totalWords := calculateTotalWords(books)
    
    // 5. 统计阅读数（TODO: 需要阅读记录Repository）
    totalReading := int64(0) // 暂时
    
    // 6. 构建结果
    stats := &UserStats{
        UserID:        userID,
        TotalProjects: int64(projectCount),
        TotalBooks:    int64(bookCount),
        TotalWords:    totalWords,
        TotalReading:  totalReading,
        RegisteredAt:  user.CreatedAt,
        LastActiveAt:  user.UpdatedAt,
        MemberLevel:   user.VIPLevel,
    }
    
    return stats, nil
}
```

### Step 3: 实现GetContentStats（1小时）

类似GetUserStats的实现方式。

### Step 4: 更新服务容器（15分钟）

在`service/container/service_container.go`中注入Repository。

### Step 5: 标记TODO（15分钟）

为复杂统计添加TODO注释，延后到Task 3实现。

---

## ⏱️ 时间分配

| 步骤 | 预计时间 | 说明 |
|-----|---------|------|
| Step 1: 注入Repository | 30分钟 | 修改构造函数 |
| Step 2: GetUserStats | 1小时 | 实现实际查询 |
| Step 3: GetContentStats | 1小时 | 实现实际查询 |
| Step 4: 服务容器更新 | 15分钟 | 注入依赖 |
| Step 5: TODO标记 | 15分钟 | 文档化延后项 |
| **总计** | **3小时** | **压缩实现** |

**说明**: 原计划2天，压缩到3小时（仅核心功能）

---

## ✅ 验收标准

### 功能验收
- [ ] GetUserStats返回实际数据
- [ ] GetContentStats返回实际数据
- [ ] Repository正确注入
- [ ] 服务容器更新完成

### 质量验收
- [ ] 0 lint错误
- [ ] 0编译错误
- [ ] 基础测试通过
- [ ] TODO标记清晰

### 延后标记
- [ ] GetPlatformUserStats - TODO (Task 3)
- [ ] GetPlatformContentStats - TODO (Task 3)
- [ ] GetUserActivityStats - TODO (Task 3)
- [ ] GetRevenueStats - TODO (Task 3)

---

## 📝 实施记录

**开始时间**: 2025-10-29 晚  
**预计完成**: 2025-10-29 深夜

**下一步**: 开始Step 1 - 注入Repository依赖

