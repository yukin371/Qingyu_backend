# Task 5: å¤šç«¯ç™»å½•é™åˆ¶å®æ–½æ–¹æ¡ˆ

**æ—¥æœŸ**: 2025-10-29 æ·±å¤œ  
**çŠ¶æ€**: ğŸ”„ è¿›è¡Œä¸­  
**é¢„è®¡å·¥æœŸ**: 1å¤©ï¼ˆå‹ç¼©åˆ°3å°æ—¶ï¼‰

---

## ğŸ“Š ç°çŠ¶åˆ†æ

### å·²æœ‰åŸºç¡€

âœ… **SessionServiceåŸºç¡€åŠŸèƒ½**ï¼ˆå®Œæ•´ï¼‰:
- `CreateSession()` - åˆ›å»ºä¼šè¯
- `GetSession()` - è·å–ä¼šè¯
- `DestroySession()` - é”€æ¯ä¼šè¯
- `GetUserSessions()` - è·å–ç”¨æˆ·æ‰€æœ‰ä¼šè¯
- `addSessionToUserList()` - æ·»åŠ ä¼šè¯åˆ°ç”¨æˆ·åˆ—è¡¨ï¼ˆå¸¦å¹¶å‘æ§åˆ¶ï¼‰
- `removeSessionFromUserList()` - ä»ç”¨æˆ·åˆ—è¡¨ç§»é™¤ä¼šè¯ï¼ˆå¸¦å¹¶å‘æ§åˆ¶ï¼‰

âœ… **å·²æœ‰è®¾å¤‡é™åˆ¶æ£€æŸ¥**ï¼ˆ287-306è¡Œï¼‰:
- `CheckDeviceLimit()` - æ£€æŸ¥è®¾å¤‡æ•°é‡
- å½“å‰ç­–ç•¥ï¼šè¶…è¿‡é™åˆ¶ç›´æ¥æ‹’ç»ç™»å½• âŒ
- ç¼ºå°‘ï¼šè‡ªåŠ¨è¸¢å‡ºæœ€è€è®¾å¤‡çš„é€»è¾‘

âœ… **åˆ†å¸ƒå¼å¹¶å‘æ§åˆ¶**ï¼ˆå·²åœ¨Task 1å®Œæˆï¼‰:
- `withUserSessionLock()` - åˆ†å¸ƒå¼é”ä¿æŠ¤
- ä¿è¯å¤šç«¯å¹¶å‘ç™»å½•å®‰å…¨

### å¾…å®ç°çš„åŠŸèƒ½

âŒ **è‡ªåŠ¨è¸¢å‡ºæœ€è€è®¾å¤‡**:
- å½“è®¾å¤‡æ•°è¶…é™æ—¶ï¼Œè¸¢å‡ºæœ€è€çš„ä¼šè¯
- ä½¿ç”¨FIFOï¼ˆFirst In First Outï¼‰ç­–ç•¥

âŒ **è®¾å¤‡ç®¡ç†API**:
- æŸ¥çœ‹è®¾å¤‡åˆ—è¡¨
- æ‰‹åŠ¨è¸¢å‡ºæŒ‡å®šè®¾å¤‡
- è®¾å¤‡ä¿¡æ¯ï¼ˆç™»å½•æ—¶é—´ã€IPç­‰ï¼‰

âŒ **å¯é…ç½®çš„è®¾å¤‡é™åˆ¶**:
- ä¸åŒç”¨æˆ·ç­‰çº§ä¸åŒé™åˆ¶
- VIPç”¨æˆ·æ›´å¤šè®¾å¤‡
- æ™®é€šç”¨æˆ·é»˜è®¤é™åˆ¶

---

## ğŸ¯ å®æ–½ç­–ç•¥

é‡‡ç”¨**MVPä¼˜å…ˆ**ç­–ç•¥ï¼š

**Phase 1ï¼ˆæ ¸å¿ƒï¼‰**: è‡ªåŠ¨è¸¢å‡ºæœ€è€è®¾å¤‡ï¼ˆ2å°æ—¶ï¼‰
- ä¿®æ”¹`CheckDeviceLimit`ä¸º`EnforceDeviceLimit`
- å®ç°FIFOè¸¢å‡ºé€»è¾‘
- åœ¨`CreateSession`è°ƒç”¨æ—¶è‡ªåŠ¨æ‰§è¡Œ

**Phase 2ï¼ˆå¯é€‰ï¼‰**: è®¾å¤‡ç®¡ç†APIï¼ˆå»¶ååˆ°Phase 4ï¼‰
- è®¾å¤‡åˆ—è¡¨API
- æ‰‹åŠ¨è¸¢å‡ºAPI
- è®¾å¤‡ä¿¡æ¯å¢å¼º

**Phase 3ï¼ˆå¯é€‰ï¼‰**: é«˜çº§åŠŸèƒ½ï¼ˆå»¶ååˆ°Phase 5ï¼‰
- ä¸åŒç­‰çº§ä¸åŒé™åˆ¶
- è®¾å¤‡ä¿¡ä»»æœºåˆ¶
- å¼‚å¸¸ç™»å½•æ£€æµ‹

---

## ğŸ“‹ è¯¦ç»†å®æ–½æ­¥éª¤

### Step 1: ä¿®æ”¹CheckDeviceLimitä¸ºEnforceDeviceLimitï¼ˆ1å°æ—¶ï¼‰

**å½“å‰é—®é¢˜**ï¼ˆ287-306è¡Œï¼‰:
```go
func (s *SessionServiceImpl) CheckDeviceLimit(ctx context.Context, userID string, maxDevices int) error {
    sessions, err := s.GetUserSessions(ctx, userID)
    if len(sessions) >= maxDevices {
        return fmt.Errorf("ç™»å½•è®¾å¤‡æ•°é‡å·²è¾¾ä¸Šé™...") // ç›´æ¥æ‹’ç» âŒ
    }
    return nil
}
```

**ä¿®æ”¹ä¸º**:
```go
// EnforceDeviceLimit å¼ºåˆ¶æ‰§è¡Œè®¾å¤‡æ•°é‡é™åˆ¶ï¼ˆFIFOç­–ç•¥ï¼‰
// å¦‚æœè®¾å¤‡æ•°è¶…é™ï¼Œè‡ªåŠ¨è¸¢å‡ºæœ€è€çš„è®¾å¤‡ï¼Œå…è®¸æ–°è®¾å¤‡ç™»å½•
func (s *SessionServiceImpl) EnforceDeviceLimit(ctx context.Context, userID string, maxDevices int) error {
    if maxDevices <= 0 {
        maxDevices = 5 // é»˜è®¤æœ€å¤š5å°è®¾å¤‡
    }

    // 1. è·å–å½“å‰ç”¨æˆ·çš„æ‰€æœ‰æ´»è·ƒä¼šè¯
    sessions, err := s.GetUserSessions(ctx, userID)
    if err != nil {
        // æŸ¥è¯¢å¤±è´¥æ—¶é‡‡ç”¨å®½æ¾ç­–ç•¥ï¼Œå…è®¸ç™»å½•
        zap.L().Warn("è·å–ç”¨æˆ·ä¼šè¯å¤±è´¥ï¼Œè·³è¿‡è®¾å¤‡é™åˆ¶æ£€æŸ¥",
            zap.String("user_id", userID),
            zap.Error(err),
        )
        return nil
    }

    // 2. å¦‚æœæœªè¶…é™ï¼Œç›´æ¥è¿”å›
    if len(sessions) < maxDevices {
        return nil
    }

    // 3. è¶…é™æ—¶ï¼Œè®¡ç®—éœ€è¦è¸¢å‡ºçš„è®¾å¤‡æ•°é‡
    numToKick := len(sessions) - maxDevices + 1 // +1 ä¸ºæ–°è®¾å¤‡ç•™ä½ç½®

    // 4. æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼ˆæœ€è€çš„åœ¨å‰ï¼‰
    sort.Slice(sessions, func(i, j int) bool {
        return sessions[i].CreatedAt.Before(sessions[j].CreatedAt)
    })

    // 5. è¸¢å‡ºæœ€è€çš„Nä¸ªè®¾å¤‡
    for i := 0; i < numToKick && i < len(sessions); i++ {
        oldSession := sessions[i]
        if err := s.DestroySession(ctx, oldSession.ID); err != nil {
            zap.L().Warn("è¸¢å‡ºæ—§è®¾å¤‡å¤±è´¥",
                zap.String("session_id", oldSession.ID),
                zap.Error(err),
            )
            // ç»§ç»­å°è¯•è¸¢å‡ºå…¶ä»–è®¾å¤‡
            continue
        }

        zap.L().Info("è‡ªåŠ¨è¸¢å‡ºæ—§è®¾å¤‡",
            zap.String("user_id", userID),
            zap.String("session_id", oldSession.ID),
            zap.Time("created_at", oldSession.CreatedAt),
        )
    }

    return nil
}
```

**å…³é”®æ”¹è¿›**:
- âœ… è‡ªåŠ¨è¸¢å‡ºæœ€è€è®¾å¤‡ï¼ˆFIFOç­–ç•¥ï¼‰
- âœ… è¸¢å‡ºå¤±è´¥æ—¶ç»§ç»­å°è¯•å…¶ä»–è®¾å¤‡ï¼ˆå®¹é”™ï¼‰
- âœ… è¯¦ç»†æ—¥å¿—è®°å½•
- âœ… å…è®¸æ–°è®¾å¤‡ç™»å½•

---

### Step 2: æ›´æ–°AuthServiceè°ƒç”¨ï¼ˆ15åˆ†é’Ÿï¼‰

**ä¿®æ”¹æ–‡ä»¶**: `service/shared/auth/auth_service.go`

**å½“å‰è°ƒç”¨**ï¼ˆ133è¡Œï¼‰:
```go
// 2.5. MVP: æ£€æŸ¥å¤šç«¯ç™»å½•é™åˆ¶ï¼ˆæœ€å¤š5å°è®¾å¤‡ï¼‰
if err := s.sessionService.CheckDeviceLimit(ctx, loginResp.User.ID, 5); err != nil {
    return nil, fmt.Errorf("ç™»å½•å¤±è´¥: %w", err)
}
```

**ä¿®æ”¹ä¸º**:
```go
// 2.5. MVP: å¼ºåˆ¶æ‰§è¡Œå¤šç«¯ç™»å½•é™åˆ¶ï¼ˆæœ€å¤š5å°è®¾å¤‡ï¼Œè¶…é™è¸¢å‡ºæœ€è€è®¾å¤‡ï¼‰
if err := s.sessionService.EnforceDeviceLimit(ctx, loginResp.User.ID, 5); err != nil {
    // è®°å½•é”™è¯¯ä½†ä¸ä¸­æ–­ç™»å½•ï¼ˆå®½æ¾ç­–ç•¥ï¼‰
    zap.L().Warn("è®¾å¤‡é™åˆ¶æ‰§è¡Œå¤±è´¥ï¼Œå…è®¸ç™»å½•",
        zap.String("user_id", loginResp.User.ID),
        zap.Error(err),
    )
}
```

**å…³é”®æ”¹è¿›**:
- âœ… ä½¿ç”¨`EnforceDeviceLimit`æ›¿ä»£`CheckDeviceLimit`
- âœ… å¤±è´¥æ—¶ä¸ä¸­æ–­ç™»å½•ï¼ˆå®½æ¾ç­–ç•¥ï¼‰
- âœ… è¯¦ç»†æ—¥å¿—

---

### Step 3: æ›´æ–°SessionServiceæ¥å£ï¼ˆ15åˆ†é’Ÿï¼‰

**ä¿®æ”¹æ–‡ä»¶**: `service/shared/auth/interfaces.go`

**å½“å‰æ¥å£**ï¼ˆ68-79è¡Œï¼‰:
```go
type SessionService interface {
    CreateSession(ctx context.Context, userID string) (*Session, error)
    GetSession(ctx context.Context, sessionID string) (*Session, error)
    UpdateSession(ctx context.Context, sessionID string, data map[string]interface{}) error
    DestroySession(ctx context.Context, sessionID string) error
    RefreshSession(ctx context.Context, sessionID string) error
    // MVP: å¤šç«¯ç™»å½•é™åˆ¶ç›¸å…³æ–¹æ³•
    CheckDeviceLimit(ctx context.Context, userID string, maxDevices int) error
    GetUserSessions(ctx context.Context, userID string) ([]*Session, error)
    DestroyUserSessions(ctx context.Context, userID string) error
}
```

**ä¿®æ”¹ä¸º**:
```go
type SessionService interface {
    CreateSession(ctx context.Context, userID string) (*Session, error)
    GetSession(ctx context.Context, sessionID string) (*Session, error)
    UpdateSession(ctx context.Context, sessionID string, data map[string]interface{}) error
    DestroySession(ctx context.Context, sessionID string) error
    RefreshSession(ctx context.Context, sessionID string) error
    // MVP: å¤šç«¯ç™»å½•é™åˆ¶ç›¸å…³æ–¹æ³•
    CheckDeviceLimit(ctx context.Context, userID string, maxDevices int) error          // ä¿ç•™å‘åå…¼å®¹
    EnforceDeviceLimit(ctx context.Context, userID string, maxDevices int) error        // æ–°å¢ï¼šè‡ªåŠ¨è¸¢å‡º
    GetUserSessions(ctx context.Context, userID string) ([]*Session, error)
    DestroyUserSessions(ctx context.Context, userID string) error
}
```

**è¯´æ˜**:
- ä¿ç•™`CheckDeviceLimit`ï¼ˆåªæ£€æŸ¥ä¸è¸¢å‡ºï¼‰
- æ–°å¢`EnforceDeviceLimit`ï¼ˆæ£€æŸ¥+è¸¢å‡ºï¼‰
- å‘åå…¼å®¹

---

### Step 4: æ·»åŠ è®¾å¤‡ç®¡ç†APIï¼ˆå»¶ååˆ°Phase 4ï¼‰

**APIè®¾è®¡**ï¼ˆå»¶åå®ç°ï¼‰:

```go
// GET /api/v1/auth/devices - æŸ¥çœ‹è®¾å¤‡åˆ—è¡¨
// DELETE /api/v1/auth/devices/:sessionId - è¸¢å‡ºæŒ‡å®šè®¾å¤‡
// DELETE /api/v1/auth/devices - è¸¢å‡ºæ‰€æœ‰å…¶ä»–è®¾å¤‡
```

**å»¶åç†ç”±**:
- MVPåªéœ€è¦è‡ªåŠ¨è¸¢å‡ºåŠŸèƒ½
- è®¾å¤‡ç®¡ç†UIéœ€è¦å‰ç«¯æ”¯æŒ
- å¯åœ¨Phase 4å®Œå–„ç”¨æˆ·ä½“éªŒæ—¶æ·»åŠ 

---

## â±ï¸ æ—¶é—´åˆ†é…

| æ­¥éª¤ | é¢„è®¡æ—¶é—´ | è¯´æ˜ |
|-----|---------|------|
| Step 1: EnforceDeviceLimitå®ç° | 1å°æ—¶ | æ ¸å¿ƒé€»è¾‘ |
| Step 2: AuthServiceè°ƒç”¨æ›´æ–° | 15åˆ†é’Ÿ | ä¿®æ”¹è°ƒç”¨ |
| Step 3: æ¥å£æ›´æ–° | 15åˆ†é’Ÿ | æ·»åŠ æ–°æ¥å£ |
| Step 4: æµ‹è¯•å’ŒéªŒè¯ | 30åˆ†é’Ÿ | Lintå’Œé€»è¾‘éªŒè¯ |
| Step 5: æ–‡æ¡£ç¼–å†™ | 30åˆ†é’Ÿ | æŠ¥å‘Šç¼–å†™ |
| **æ€»è®¡** | **3å°æ—¶** | **å‹ç¼©å®æ–½** |

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] EnforceDeviceLimitå®ç°å®Œæˆ
- [ ] è‡ªåŠ¨è¸¢å‡ºæœ€è€è®¾å¤‡ï¼ˆFIFOï¼‰
- [ ] AuthServiceæ­£ç¡®è°ƒç”¨EnforceDeviceLimit
- [ ] ä¿ç•™CheckDeviceLimitå‘åå…¼å®¹
- [ ] è¶…é™æ—¶ä¸é˜»æ­¢ç™»å½•

### è´¨é‡éªŒæ”¶
- [ ] 0 linté”™è¯¯
- [ ] 0ç¼–è¯‘é”™è¯¯
- [ ] è¯¦ç»†æ—¥å¿—è®°å½•
- [ ] å®¹é”™å¤„ç†å®Œå–„

### å»¶ååŠŸèƒ½
- â¸ï¸ è®¾å¤‡ç®¡ç†APIï¼ˆPhase 4ï¼‰
- â¸ï¸ ä¸åŒç­‰çº§ä¸åŒé™åˆ¶ï¼ˆPhase 5ï¼‰
- â¸ï¸ è®¾å¤‡ä¿¡ä»»æœºåˆ¶ï¼ˆPhase 5ï¼‰

---

## ğŸ’¡ è®¾è®¡è¦ç‚¹

### 1. FIFOç­–ç•¥

**æ’åºä¾æ®**: `Session.CreatedAt`
**è¸¢å‡ºæ•°é‡**: `len(sessions) - maxDevices + 1`

**ç¤ºä¾‹**:
```
å½“å‰ä¼šè¯: 5ä¸ªï¼ˆåˆ›å»ºæ—¶é—´ä»æ—©åˆ°æ™šï¼šS1, S2, S3, S4, S5ï¼‰
é™åˆ¶: 5å°è®¾å¤‡
æ–°è®¾å¤‡ç™»å½•: éœ€è¦1ä¸ªä½ç½®
è¸¢å‡ºæ•°é‡: 5 - 5 + 1 = 1
è¸¢å‡ºè®¾å¤‡: S1ï¼ˆæœ€è€çš„ï¼‰
ç»“æœ: S2, S3, S4, S5, æ–°è®¾å¤‡
```

### 2. å®½æ¾ç­–ç•¥

**å¤±è´¥åœºæ™¯å¤„ç†**:
- æŸ¥è¯¢å¤±è´¥ â†’ å…è®¸ç™»å½•
- è¸¢å‡ºå¤±è´¥ â†’ ç»§ç»­å°è¯•ï¼Œä¸ä¸­æ–­
- æ¥å£è°ƒç”¨å¤±è´¥ â†’ å…è®¸ç™»å½•

**ç†ç”±**:
- ç”¨æˆ·ä½“éªŒä¼˜å…ˆ
- é¿å…å› é™åˆ¶åŠŸèƒ½æ•…éšœå¯¼è‡´æ— æ³•ç™»å½•
- è¯¦ç»†æ—¥å¿—ä¾¿äºæ’æŸ¥

### 3. å¹¶å‘å®‰å…¨

**ä¿æŠ¤æœºåˆ¶**:
- `withUserSessionLock()` - åˆ†å¸ƒå¼é”
- ä¿è¯åŒä¸€ç”¨æˆ·çš„ä¼šè¯åˆ—è¡¨ä¿®æ”¹åŸå­æ€§
- é¿å…ç«æ€æ¡ä»¶

---

## ğŸ“ å®æ–½è®°å½•

**å¼€å§‹æ—¶é—´**: 2025-10-29 æ·±å¤œ  
**é¢„è®¡å®Œæˆ**: 2025-10-30 å‡Œæ™¨

**ä¸‹ä¸€æ­¥**: Step 1 - å®ç°EnforceDeviceLimit

