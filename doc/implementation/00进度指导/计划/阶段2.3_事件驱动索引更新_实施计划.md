# 阶段 2.3：事件驱动索引更新 - 实施计划

**日期**: 2025-10-28  
**状态**: 🚧 进行中  
**预计时间**: Week 4（2-3小时）

---

## 🎯 目标

实现事件驱动的向量索引自动更新机制，当文档发生变更时自动更新Milvus向量数据库，保持索引与数据源的同步。

---

## 📋 核心任务

### 任务 1: EventBus集成（30分钟）

#### 1.1 创建事件定义
**文件**: `python_ai_service/src/events/document_events.py`（新建）

**事件类型**:
```python
@dataclass
class DocumentEvent:
    """文档事件基类"""
    event_id: str
    event_type: str  # created, updated, deleted
    document_id: str
    timestamp: datetime
    user_id: Optional[str] = None
    metadata: Dict[str, Any] = field(default_factory=dict)

@dataclass
class DocumentCreatedEvent(DocumentEvent):
    """文档创建事件"""
    content: str
    source: str
    
@dataclass
class DocumentUpdatedEvent(DocumentEvent):
    """文档更新事件"""
    content: str
    old_content: Optional[str] = None
    
@dataclass
class DocumentDeletedEvent(DocumentEvent):
    """文档删除事件"""
    pass
```

#### 1.2 创建事件处理器接口
**文件**: `python_ai_service/src/events/handlers.py`（新建）

```python
class EventHandler(ABC):
    """事件处理器基类"""
    
    @abstractmethod
    async def handle(self, event: DocumentEvent) -> None:
        """处理事件"""
        pass
    
    @abstractmethod
    def can_handle(self, event: DocumentEvent) -> bool:
        """是否能处理此事件"""
        pass
```

---

### 任务 2: 向量索引更新器（45分钟）

#### 2.1 创建索引更新器
**文件**: `python_ai_service/src/rag/index_updater.py`（新建）

**核心功能**:
- 监听文档事件
- 自动向量化
- 增量更新Milvus
- 错误重试机制

**核心方法**:
```python
class VectorIndexUpdater:
    """向量索引更新器"""
    
    def __init__(
        self,
        embedding_manager: EmbeddingManager,
        milvus_client: MilvusClient,
        text_splitter: RecursiveCharacterTextSplitter
    ):
        """初始化"""
        
    async def handle_document_created(
        self, 
        event: DocumentCreatedEvent
    ) -> None:
        """处理文档创建"""
        # 1. 文本分块
        # 2. 向量化
        # 3. 插入Milvus
        
    async def handle_document_updated(
        self, 
        event: DocumentUpdatedEvent
    ) -> None:
        """处理文档更新"""
        # 1. 删除旧向量
        # 2. 重新分块和向量化
        # 3. 插入新向量
        
    async def handle_document_deleted(
        self, 
        event: DocumentDeletedEvent
    ) -> None:
        """处理文档删除"""
        # 删除所有相关向量
```

#### 2.2 实现批量更新
**方法**: `batch_update()`

**功能**:
- 批量处理多个事件
- 减少Milvus操作次数
- 提高性能

---

### 任务 3: 索引调度器（40分钟）

#### 3.1 创建调度器
**文件**: `python_ai_service/src/rag/index_scheduler.py`（新建）

**功能**:
- 任务队列管理
- 并发控制
- 优先级排序
- 重试机制

**核心方法**:
```python
class IndexScheduler:
    """索引调度器"""
    
    def __init__(self, max_workers: int = 3):
        self.queue: asyncio.Queue = asyncio.Queue()
        self.workers: List[asyncio.Task] = []
        self.max_workers = max_workers
        
    async def enqueue(
        self, 
        event: DocumentEvent, 
        priority: int = 0
    ) -> None:
        """添加任务到队列"""
        
    async def start(self) -> None:
        """启动调度器"""
        
    async def stop(self) -> None:
        """停止调度器"""
        
    async def _worker(self) -> None:
        """工作协程"""
```

#### 3.2 实现优先级队列
- 创建>更新>删除
- VIP文档优先
- 批量任务延迟处理

---

### 任务 4: 版本控制（30分钟）

#### 4.1 创建版本管理器
**文件**: `python_ai_service/src/rag/version_manager.py`（新建）

**功能**:
- 文档版本追踪
- 向量版本映射
- 一致性校验

**数据结构**:
```python
@dataclass
class DocumentVersion:
    """文档版本信息"""
    document_id: str
    version: int
    content_hash: str
    vector_ids: List[str]
    created_at: datetime
    updated_at: datetime
```

#### 4.2 实现版本一致性检查
**方法**: `check_consistency()`

**检查内容**:
- 文档版本 vs 向量版本
- 缺失的索引
- 孤立的向量

---

### 任务 5: Redis缓存集成（25分钟）

#### 5.1 缓存索引任务
**功能**:
- 缓存待处理事件
- 持久化队列
- 故障恢复

**Redis数据结构**:
```
# 待处理队列
index_queue:pending -> List[event_json]

# 处理中任务
index_queue:processing:{task_id} -> event_json + TTL

# 失败任务
index_queue:failed -> List[event_json + error]

# 版本信息
doc_version:{document_id} -> version_json
```

#### 5.2 实现故障恢复
- 服务重启时恢复未完成任务
- 处理超时任务
- 失败重试机制

---

### 任务 6: 监控和日志（20分钟）

#### 6.1 添加Prometheus指标
**文件**: 更新 `python_ai_service/src/core/metrics.py`

**新增指标**:
```python
# 索引任务计数
index_tasks_total = Counter(
    'index_tasks_total',
    'Total index tasks',
    ['event_type', 'status']
)

# 索引延迟
index_latency_seconds = Histogram(
    'index_latency_seconds',
    'Index task latency',
    ['event_type']
)

# 队列长度
index_queue_length = Gauge(
    'index_queue_length',
    'Index queue length'
)
```

#### 6.2 结构化日志
- 事件处理日志
- 性能指标日志
- 错误日志（含堆栈）

---

### 任务 7: 配置管理（10分钟）

#### 7.1 更新配置
**文件**: `python_ai_service/src/core/config.py`

**新增配置项**:
```python
class Settings(BaseSettings):
    # 索引更新配置
    index_auto_update: bool = True
    index_batch_size: int = 10
    index_batch_interval: int = 60  # 秒
    index_max_workers: int = 3
    index_retry_times: int = 3
    index_retry_delay: int = 5  # 秒
    
    # 队列配置
    index_queue_max_size: int = 1000
    index_queue_timeout: int = 300  # 秒
    
    # 版本控制
    index_version_enabled: bool = True
    index_version_ttl: int = 86400 * 30  # 30天
```

---

### 任务 8: API端点（15分钟）

#### 8.1 创建索引管理API
**文件**: `python_ai_service/src/api/index.py`（新建）

**端点**:
```python
@router.post("/index/reindex")
async def reindex_document(document_id: str):
    """手动重建文档索引"""

@router.get("/index/status")
async def get_index_status():
    """获取索引状态"""
    
@router.get("/index/queue")
async def get_queue_status():
    """获取队列状态"""
    
@router.post("/index/pause")
async def pause_indexing():
    """暂停索引"""
    
@router.post("/index/resume")
async def resume_indexing():
    """恢复索引"""
```

---

### 任务 9: 测试与文档（30分钟）

#### 9.1 单元测试
**文件**: `python_ai_service/tests/test_index_updater.py`（新建）

**测试用例**:
- 测试文档创建事件处理
- 测试文档更新事件处理
- 测试文档删除事件处理
- 测试批量更新
- 测试错误重试

#### 9.2 集成测试
**文件**: `python_ai_service/tests/test_event_flow.py`（新建）

**测试场景**:
- 端到端事件流
- 并发事件处理
- 故障恢复测试

#### 9.3 中文文档
**文件**: `doc/implementation/00进度指导/阶段2.3_事件驱动索引更新_实施报告.md`（新建）

**文档结构**:
```markdown
# 阶段 2.3：事件驱动索引更新实施报告

## 实施概览
## 事件系统设计
## 索引更新器实现
## 调度器设计
## 版本控制
## Redis集成
## 监控和日志
## 使用指南
## 性能测试结果
## 后续规划
```

---

## 🗂️ 文件清单

### 新建文件（11个）
1. `python_ai_service/src/events/document_events.py` - 事件定义
2. `python_ai_service/src/events/handlers.py` - 事件处理器
3. `python_ai_service/src/rag/index_updater.py` - 索引更新器
4. `python_ai_service/src/rag/index_scheduler.py` - 调度器
5. `python_ai_service/src/rag/version_manager.py` - 版本管理
6. `python_ai_service/src/api/index.py` - 索引管理API
7. `python_ai_service/tests/test_index_updater.py` - 单元测试
8. `python_ai_service/tests/test_event_flow.py` - 集成测试
9. `doc/implementation/00进度指导/阶段2.3_事件驱动索引更新_实施报告.md`

### 更新文件（2个）
10. `python_ai_service/src/core/config.py` - 配置更新
11. `python_ai_service/src/core/metrics.py` - 监控指标

---

## ⏱️ 时间分配

| 任务 | 预计时间 | 优先级 |
|------|---------|-------|
| 1. EventBus集成 | 30分钟 | P0 |
| 2. 索引更新器 | 45分钟 | P0 |
| 3. 索引调度器 | 40分钟 | P0 |
| 4. 版本控制 | 30分钟 | P1 |
| 5. Redis缓存 | 25分钟 | P1 |
| 6. 监控和日志 | 20分钟 | P1 |
| 7. 配置管理 | 10分钟 | P0 |
| 8. API端点 | 15分钟 | P1 |
| 9. 测试与文档 | 30分钟 | P0 |
| **总计** | **3小时15分** | |

---

## ✅ 验收标准

- [ ] 文档创建事件自动触发索引
- [ ] 文档更新事件正确更新向量
- [ ] 文档删除事件清理向量
- [ ] 批量操作性能良好（>10条/秒）
- [ ] 并发处理无冲突
- [ ] 失败任务正确重试
- [ ] 版本一致性检查通过
- [ ] 所有单元测试通过
- [ ] API端点正常工作
- [ ] 中文文档完整清晰

---

## 🔧 技术要点

### 事件驱动架构

```
Go Backend (文档变更)
   ↓ 发布事件
EventBus (Redis/内存)
   ↓ 订阅
Python AI Service
   ↓ 处理
IndexUpdater
   ↓ 更新
Milvus
```

### 批量更新策略

```python
# 收集60秒内的事件
events = collect_events(interval=60)

# 按文档ID分组
groups = group_by_document_id(events)

# 批量处理
for doc_id, doc_events in groups:
    # 只处理最新事件（去重）
    latest = get_latest_event(doc_events)
    process(latest)
```

### 版本一致性

```python
# 检查文档版本
doc_version = get_document_version(doc_id)
vector_version = get_vector_version(doc_id)

if doc_version != vector_version:
    # 重建索引
    reindex_document(doc_id)
```

---

## 📊 预期成果

**代码量**: ~1200行
- 事件系统: ~200行
- 索引更新器: ~300行
- 调度器: ~250行
- 版本管理: ~200行
- API端点: ~150行
- 测试: ~100行

**性能指标**:
- 索引延迟: <5秒（P95）
- 吞吐量: >10文档/秒
- 队列积压: <100（正常情况）

**可靠性**:
- 事件不丢失（Redis持久化）
- 失败重试（最多3次）
- 版本一致性（定时检查）

---

## 🚀 实施优先级

### 核心功能（必须）
1. ✅ 事件定义和处理器接口
2. ✅ 索引更新器核心逻辑
3. ✅ 基础调度器
4. ✅ 配置管理

### 扩展功能（可选）
5. ⏳ 版本控制（如果时间允许）
6. ⏳ Redis持久化（如果时间允许）
7. ⏳ 监控指标（如果时间允许）
8. ⏳ API端点（如果时间允许）

---

## 下一步

完成阶段2.3后，Phase3的RAG核心功能将基本完成，可以进入：

**阶段 3.x：Agent和工具层**
- WorkspaceContextTool
- 审核Agent
- LangGraph工作流

或

**性能优化阶段**
- 实施阶段2.2搁置功能
- 性能调优
- 压力测试

---

**创建日期**: 2025-10-28  
**预计完成**: 2025-10-28  
**维护者**: 青羽后端架构团队

