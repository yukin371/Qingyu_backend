# 下一阶段行动计划

**制定日期**: 2025-10-24  
**计划周期**: 2-4周  
**状态**: 待执行

---

## 📊 当前项目状态

### 刚刚完成的工作 ✅

- ✅ **共享服务 BaseService 集成**: AuthService 和 WalletService 已实现
- ✅ **服务容器统一管理**: 废弃 SharedServiceContainer，统一使用 ServiceContainer
- ✅ **监控指标体系**: 服务指标收集、健康检查 API
- ✅ **测试覆盖增强**: 37个单元测试 + 7个集成测试，100%通过
- ✅ **架构优化文档**: 完整的实施报告和迁移指南

### 技术债务识别 ⚠️

基于代码扫描，发现以下待完成项：

1. **服务初始化不完整**:
   - AuthService 需要 Redis 客户端配置
   - MessagingService、StorageService、AdminService 未实现 BaseService
   - CacheService、VIPService 尚未实现

2. **基础设施缺失**:
   - Redis 客户端未统一配置
   - 消息队列（RabbitMQ/Redis）未集成
   - 对象存储（OSS/S3）未配置

3. **AI 模块重构需求**:
   - 当前完成度仅 40%
   - 缺少 Agent 工具调用框架
   - 缺少 RAG 检索增强系统

---

## 🎯 下一阶段目标（优先级排序）

### 阶段一：基础设施完善（1周，P0 🔥）

**目标**: 补齐基础设施，为高级功能打好地基

#### 1.1 Redis 客户端集成

**优先级**: P0 🔥  
**预计工作量**: 2天  
**依赖**: 无

**任务清单**:
- [ ] 创建 Redis 配置结构（`config/redis.go`）
- [ ] 实现 Redis 客户端封装（`pkg/cache/redis_client.go`）
- [ ] 支持连接池、健康检查、重连机制
- [ ] 集成到服务容器
- [ ] 编写单元测试

**预期成果**:
```go
// 使用示例
redisClient := c.GetRedisClient()
err := redisClient.Set(ctx, "key", "value", 5*time.Minute)
```

#### 1.2 AuthService 完整初始化

**优先级**: P0 🔥  
**预计工作量**: 1天  
**依赖**: Redis 客户端

**任务清单**:
- [ ] 在 ServiceContainer.SetupDefaultServices() 中启用 AuthService
- [ ] 注入 Redis 客户端到 JWTService 和 SessionService
- [ ] 配置 JWT 黑名单和会话管理
- [ ] 测试完整认证流程
- [ ] 更新集成测试

**预期成果**:
- AuthService 完全可用
- 支持 Token 黑名单
- 支持多端登录限制

#### 1.3 其他共享服务 BaseService 实现

**优先级**: P1  
**预计工作量**: 2天  
**依赖**: 无

**任务清单**:
- [ ] **AdminService** 实现 BaseService 接口
- [ ] **StorageService** 实现 BaseService 接口  
- [ ] **MessagingService** 实现 BaseService 接口
- [ ] **RecommendationService** 实现 BaseService 接口
- [ ] 更新服务容器注册逻辑
- [ ] 补充单元测试

**预期成果**:
- 所有共享服务统一生命周期管理
- 完整的健康检查覆盖
- 监控指标收集

---

### 阶段二：核心功能完善（1-2周，P0-P1）

#### 2.1 AI 配额管理增强

**优先级**: P0 🔥  
**预计工作量**: 3天  
**依赖**: Redis 客户端

**任务清单**:
- [ ] 实现基于 Redis 的配额缓存
- [ ] 添加配额预警机制
- [ ] 实现配额续费和充值
- [ ] 添加配额使用统计 API
- [ ] 集成到 AI Service

**预期成果**:
- 实时配额查询（<10ms）
- 配额不足自动告警
- 完整的配额管理 API

#### 2.2 CacheService 实现

**优先级**: P1  
**预计工作量**: 2天  
**依赖**: Redis 客户端

**任务清单**:
- [ ] 设计 CacheService 接口
- [ ] 实现 Redis 缓存适配器
- [ ] 实现内存缓存适配器（LRU）
- [ ] 支持多级缓存
- [ ] 添加缓存预热和失效策略
- [ ] 编写单元测试和基准测试

**接口设计**:
```go
type CacheService interface {
    baseservice.BaseService
    Get(ctx context.Context, key string) (interface{}, error)
    Set(ctx context.Context, key string, value interface{}, ttl time.Duration) error
    Delete(ctx context.Context, key string) error
    Clear(ctx context.Context, pattern string) error
    GetMulti(ctx context.Context, keys []string) (map[string]interface{}, error)
}
```

#### 2.3 VIPService 实现

**优先级**: P1  
**预计工作量**: 2天  
**依赖**: 无

**任务清单**:
- [ ] 设计 VIP 等级和权益体系
- [ ] 实现 VIPService
- [ ] 集成到书城和阅读器
- [ ] 添加 VIP 购买和续费 API
- [ ] 实现 VIP 权益验证中间件
- [ ] 编写测试

**核心功能**:
- VIP 等级管理（普通、银卡、金卡、钻石）
- 权益配置（免广告、章节折扣、专属内容）
- 自动到期检测和降级

---

### 阶段三：监控和可观测性增强（3-5天，P1-P2）

#### 3.1 指标持久化

**优先级**: P1  
**预计工作量**: 2天  
**依赖**: 无

**任务清单**:
- [ ] 集成 Prometheus SDK
- [ ] 暴露 `/metrics` 端点
- [ ] 定义核心业务指标
- [ ] 配置 Grafana 仪表板
- [ ] 添加告警规则

**核心指标**:
- 服务级别: QPS、响应时间、错误率
- 业务级别: 用户注册量、订单量、AI 调用量
- 资源级别: CPU、内存、数据库连接数

#### 3.2 健康检查增强

**优先级**: P2  
**预计工作量**: 1天  
**依赖**: 无

**任务清单**:
- [ ] 实现 Liveness Probe（存活探针）
- [ ] 实现 Readiness Probe（就绪探针）
- [ ] 添加依赖服务健康检查（MongoDB、Redis）
- [ ] 实现优雅关闭（Graceful Shutdown）
- [ ] 更新 Kubernetes 配置

**端点设计**:
- `GET /healthz` - 存活探针（服务是否运行）
- `GET /readyz` - 就绪探针（服务是否可接受流量）
- `GET /api/v1/system/health` - 详细健康检查

#### 3.3 日志增强

**优先级**: P2  
**预计工作量**: 2天  
**依赖**: 无

**任务清单**:
- [ ] 统一日志格式（JSON 结构化日志）
- [ ] 添加 TraceID 和 SpanID
- [ ] 实现日志分级输出
- [ ] 配置日志轮转和归档
- [ ] 集成日志聚合（ELK/Loki）

---

### 阶段四：AI 模块重构规划（长期，P0 🔥）

**背景**: AI 模块当前完成度仅 40%，缺少核心差异化功能

#### 4.1 需求分析（2天）

**任务清单**:
- [ ] 梳理 AI Agent 功能需求
- [ ] 设计 RAG 系统架构
- [ ] 评估 Python 微服务方案
- [ ] 制定详细技术方案
- [ ] 评估工作量和排期

#### 4.2 Agent 工具调用框架（1周）

**核心功能**:
- Function Calling 支持
- 工具注册和管理
- 工具执行和结果解析
- 错误处理和重试

#### 4.3 RAG 检索增强系统（1-2周）

**核心功能**:
- 向量数据库集成（Milvus/Qdrant）
- 文档分块和向量化
- 相似度检索
- 上下文组装

**注意**: 此部分可能需要独立规划文档

---

## 📅 实施时间表

### 第1周（2025-10-28 ~ 11-01）

| 日期 | 任务 | 负责人 | 状态 |
|------|------|--------|------|
| 周一-周二 | Redis 客户端集成 | - | 待开始 |
| 周三 | AuthService 完整初始化 | - | 待开始 |
| 周四-周五 | 其他共享服务 BaseService 实现 | - | 待开始 |

**里程碑**: ✅ 基础设施完善完成

### 第2周（2025-11-04 ~ 11-08）

| 日期 | 任务 | 负责人 | 状态 |
|------|------|--------|------|
| 周一-周三 | AI 配额管理增强 | - | 待开始 |
| 周四-周五 | CacheService 实现 | - | 待开始 |

**里程碑**: ✅ 核心功能完善（第一批）

### 第3周（2025-11-11 ~ 11-15）

| 日期 | 任务 | 负责人 | 状态 |
|------|------|--------|------|
| 周一-周二 | VIPService 实现 | - | 待开始 |
| 周三-周四 | 指标持久化（Prometheus） | - | 待开始 |
| 周五 | 健康检查增强 | - | 待开始 |

**里程碑**: ✅ 监控体系完善

### 第4周（2025-11-18 ~ 11-22）

| 日期 | 任务 | 负责人 | 状态 |
|------|------|--------|------|
| 周一-周二 | 日志增强 | - | 待开始 |
| 周三-周五 | AI 模块重构需求分析 | - | 待开始 |

**里程碑**: ✅ 可观测性完善，AI 重构方案确定

---

## 🎯 成功标准

### 阶段一成功标准
- [ ] Redis 客户端可用，覆盖率 >80%
- [ ] AuthService 完全集成，所有测试通过
- [ ] 所有共享服务实现 BaseService，健康检查 100% 覆盖

### 阶段二成功标准
- [ ] AI 配额实时查询响应时间 <10ms
- [ ] CacheService 支持多级缓存，命中率 >90%
- [ ] VIPService 完整实现，权益验证准确

### 阶段三成功标准
- [ ] Prometheus 指标暴露，Grafana 仪表板可用
- [ ] 健康检查端点可用，支持 K8s 探针
- [ ] 结构化日志，TraceID 覆盖 100%

### 阶段四成功标准
- [ ] AI 重构方案评审通过
- [ ] Agent 框架 POC 完成
- [ ] RAG 系统技术选型确定

---

## 🚨 风险识别

### 技术风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|---------|
| Redis 集成复杂度超预期 | 中 | 低 | 采用成熟库（go-redis），参考最佳实践 |
| AI 模块重构工作量巨大 | 高 | 高 | 分阶段实施，先 POC 验证 |
| 监控系统学习成本高 | 中 | 中 | 使用 Docker Compose 快速搭建本地环境 |

### 资源风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|---------|
| 开发资源不足 | 高 | 中 | 优先完成 P0 任务，P1/P2 可延后 |
| 测试环境不稳定 | 中 | 低 | 使用 Docker 容器化测试环境 |

---

## 📚 参考资源

### 技术文档
- [Go Redis 客户端文档](https://redis.uptrace.dev/)
- [Prometheus Go 客户端](https://github.com/prometheus/client_golang)
- [Grafana 仪表板模板](https://grafana.com/grafana/dashboards/)

### 项目文档
- `doc/architecture/优化/共享服务完善实施报告_2025-10-24.md` - 上一阶段成果
- `doc/implementation/计划/功能实施现状与下阶段规划_2025-10-21.md` - 整体规划
- `doc/architecture/架构设计规范.md` - 架构规范

---

## 📝 变更记录

| 日期 | 版本 | 变更内容 | 变更人 |
|------|------|---------|--------|
| 2025-10-24 | v1.0 | 初始版本创建 | AI Assistant |

---

**计划审核**: 待审核  
**计划批准**: 待批准  
**执行状态**: 待开始

