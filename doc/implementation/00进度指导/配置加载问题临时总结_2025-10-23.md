# 配置加载问题临时总结

**日期**：2025-10-23  
**状态**：🔴 待解决  
**优先级**：P1（阻塞MVP部署）

---

## 问题描述

Docker容器启动后无法正确加载配置文件，始终提示：
```
Warning: Config file not found: Config File "config" Not Found in "[/app]"
```

导致后端尝试连接`localhost:27017`而不是`mongodb:27017`，MongoDB连接失败。

---

## 已尝试的解决方案

### 1. ✅ 修复配置文件结构
- **问题**：`config.docker.yaml`使用简化结构（`database.uri`）
- **解决**：修改为嵌套结构（`database.primary.mongodb.uri`）
- **结果**：✅ 配置文件结构正确

### 2. ✅ 设置环境变量
- **修改**：在`docker-compose.prod.yml`中添加`CONFIG_FILE=config/config.docker.yaml`
- **验证**：`docker exec`确认环境变量已设置
- **结果**：✅ 环境变量存在

### 3. ✅ 文件复制策略
- **修改**：Dockerfile将`config.docker.yaml`复制为`config.yaml`
- **验证**：`docker exec ls /app/config/`显示文件存在
- **结果**：✅ 文件已复制

### 4. ✅ Viper配置路径
- **修改**：在`config/config.go`中添加`v.AddConfigPath("./config")`
- **结果**：❌ 仍然找不到配置文件

### 5. ❌ 主函数读取环境变量
- **修改**：`cmd/server/main.go`优先读取`CONFIG_FILE`环境变量
- **问题**：日志中没有看到新增的日志输出，说明代码可能未生效
- **结果**：❌ 无效

---

## 根本原因分析

### 可能的原因

1. **Docker构建缓存问题**
   - 代码修改后，Docker可能使用了旧的缓存层
   - **验证方法**：使用`--no-cache`重新构建

2. **Viper实例化顺序**
   - Viper可能在环境变量设置之前就已经初始化
   - 需要检查初始化顺序

3. **工作目录问题**
   - 容器启动时的工作目录可能不是`/app`
   - Viper查找路径可能不正确

4. **配置加载逻辑冲突**
   - 存在多个配置加载函数（`LoadConfig`, `LoadFromFile`）
   - 可能调用了错误的函数或逻辑分支

---

## 建议的解决方案

### 方案A：使用绝对路径（最简单）

**修改 `cmd/server/main.go`**:
```go
configPath := "/app/config/config.yaml"  // 硬编码绝对路径
_, err := config.LoadConfig(configPath)
```

**优点**：
- 简单直接
- 不依赖环境变量
- 绝对可靠

**缺点**：
- 硬编码，灵活性差

### 方案B：清理Docker缓存重新构建

**命令**:
```bash
docker build --no-cache -t qingyu-backend:mvp -f docker/Dockerfile.prod .
```

**优点**：
- 确保最新代码生效
- 彻底解决缓存问题

**缺点**：
- 构建时间长（~5分钟）

### 方案C：简化配置加载逻辑

**思路**：
1. 移除所有Viper路径配置
2. 直接使用`v.SetConfigFile("/app/config/config.yaml")`
3. 确保只有一个配置加载入口

---

## 当前状态

- ✅ Go版本问题已解决（go 1.24 + golang:1.25-alpine）
- ✅ Docker镜像构建成功
- ✅ 所有容器正常启动
- ✅ MongoDB和Redis健康检查通过
- ❌ 后端服务配置加载失败
- ❌ 后端服务无法连接MongoDB

---

## 下一步行动

### 立即行动（优先）
1. ✅ 采用**方案A（绝对路径）**快速修复
2. 验证后端服务启动成功
3. 继续完成MVP任务（测试账号、冒烟测试）

### 后续优化（可选）
1. 深入调试Viper配置加载逻辑
2. 统一配置管理机制
3. 添加配置加载日志和错误提示
4. 编写配置加载单元测试

---

## 相关文件

- `config/config.go` - 配置加载主逻辑
- `config/viper_integration.go` - Viper集成
- `cmd/server/main.go` - 程序入口
- `docker/Dockerfile.prod` - 生产环境Dockerfile
- `docker/docker-compose.prod.yml` - Docker Compose配置
- `config/config.docker.yaml` - Docker环境配置文件

---

**创建时间**：2025-10-23 22:30  
**预计解决时间**：15分钟（使用方案A）  
**维护者**：青羽后端架构团队

