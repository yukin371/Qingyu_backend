# 测试编写详细规划与实施指南

**文档版本**: v1.0  
**制定日期**: 2025-10-23  
**基于**: P0+P1测试完成总结 + 覆盖率报告  
**目标**: Service层80%+, P0核心90%+

---

## 📋 目录

- [1. 测试现状与目标](#1-测试现状与目标)
- [2. 测试提升四阶段计划](#2-测试提升四阶段计划)
- [3. 测试编写规范与模板](#3-测试编写规范与模板)
- [4. 各模块测试详细规划](#4-各模块测试详细规划)
- [5. 测试执行指南](#5-测试执行指南)
- [6. 质量保证与验收](#6-质量保证与验收)

---

## 1. 测试现状与目标

### 1.1 当前测试覆盖率分析

**整体统计** (基于`测试覆盖率报告_2025-10-23.md`):

```
Service层平均覆盖率: 32% (目标: 80%)
P0核心覆盖率: 23% (目标: 90%)
已创建测试用例: 106个
可运行测试: 62个 (100%通过)
TDD待开发: 35个
集成测试待补: 17个
```

**模块分级**:

| 等级 | 覆盖率范围 | 模块数 | 模块列表 |
|------|-----------|--------|---------|
| ⭐⭐⭐⭐⭐ 优秀 | ≥80% | 3 | recommendation(86.4%), admin(84.1%), messaging(79.8%) |
| ⭐⭐⭐⭐ 良好 | 60-80% | 0 | - |
| ⭐⭐⭐ 中等 | 40-60% | 3 | storage(56.1%), wallet(52.7%), auth(48.5%) |
| ⭐⭐ 待提升 | 20-40% | 1 | container(27.4%) |
| ⚠️ 低 | <20% | 3 | ai(10.0%), user(6.8%), adapter(5.2%) |
| ❌ 未覆盖 | 0% | 7 | audit, bookstore, document, project, reading, recommendation(dup), stats |

---

### 1.2 测试覆盖率目标

**阶段性目标**:

| 阶段 | 时间 | Service层 | P0核心 | 关键行动 |
|------|------|----------|--------|---------|
| **当前** | - | 32% | 23% | 基线 |
| **阶段1** | +2天 | 33% | 24% | 修复Bug |
| **阶段2** | +4天 | 52% | 64% | 集成测试 |
| **阶段3** | +14天 | 72% | 90% ✅ | TDD实现 |
| **阶段4** | +5天 | 82% ✅ | 92% ✅ | P2模块 |
| **总计** | **25天** | **82%** | **92%** | **达标** |

---

### 1.3 测试用例分布规划

**测试用例总规划** (当前106个 → 目标200个):

| 模块 | 当前 | 阶段2 | 阶段3 | 阶段4 | 总计 |
|------|------|-------|-------|-------|------|
| **AI服务** | 40 | +4 | +15 | +10 | 69 |
| **认证权限** | 33 | +4 | +8 | 0 | 45 |
| **写作核心** | 18 | +6 | +12 | +10 | 46 |
| **内容审核** | 15 | +3 | +3 | +5 | 26 |
| **其他Service** | 0 | 0 | 0 | +25 | 25 |
| **总计** | **106** | **+17** | **+38** | **+50** | **211** |

---

## 2. 测试提升四阶段计划

### 阶段1: Bug修复与测试解锁 (1-2天)

**目标**: 修复阻塞Bug，让已有测试正常运行

#### 任务清单

| 任务 | 优先级 | 工时 | 负责人 | 输出 |
|------|--------|------|--------|------|
| **修复SessionService Bug** | P0 | 0.5天 | 后端 | session_service.go |
| **修复SessionService测试** | P0 | 0.5天 | 测试 | auth_session_enhanced_test.go |
| **验证会话管理流程** | P0 | 0.5天 | 测试 | 集成测试 |

**Bug详情** (参考`Bug修复报告_2025-10-23.md`):

```go
// Bug: SessionService.GetSession解析错误
// 位置: service/shared/auth/session_service.go:68
// 原因: fmt.Sscanf的%s不止于|分隔符
// 影响: 11个会话测试Skip

// 修复方案（已提供）:
parts := strings.Split(value, "|")
if len(parts) != 3 {
    return nil, fmt.Errorf("会话数据格式无效")
}
userID := parts[0]
createdAt, _ := strconv.ParseInt(parts[1], 10, 64)
expiresAt, _ := strconv.ParseInt(parts[2], 10, 64)
```

**验收标准**:
- ✅ SessionService Bug修复
- ✅ 11个会话测试从Skip→Pass
- ✅ Service/shared/auth覆盖率: 48.5% → 50%

---

### 阶段2: 补充集成测试 (3-4天)

**目标**: 补充17个集成测试，验证完整流程

#### 2.1 环境准备

**Docker测试环境** (`docker/docker-compose.test.yml`):

```yaml
version: '3.8'
services:
  mongodb-test:
    image: mongo:6.0
    ports:
      - "27018:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: test
      MONGO_INITDB_ROOT_PASSWORD: test123

  redis-test:
    image: redis:7-alpine
    ports:
      - "6380:6379"
```

**启动命令**:
```bash
# 启动测试环境
docker-compose -f docker/docker-compose.test.yml up -d

# 运行集成测试
go test ./test/integration/... -tags=integration -timeout 60s

# 清理环境
docker-compose -f docker/docker-compose.test.yml down -v
```

---

#### 2.2 集成测试任务清单

**service/audit (3个集成测试, 1天)**:

| 测试用例 | 文件 | 当前状态 | 工时 |
|---------|------|---------|------|
| `TestContentAudit_StreamingReceive` | content_audit_service_enhanced_test.go | Skip | 0.3天 |
| `TestContentAudit_StreamingError` | content_audit_service_enhanced_test.go | Skip | 0.3天 |
| `TestContentAudit_MultiRoundContext` | content_audit_service_enhanced_test.go | Skip | 0.4天 |

**预期提升**: 0% → 85%

---

**service/ai (4个集成测试, 1天)**:

| 测试用例 | 文件 | 当前状态 | 工时 |
|---------|------|---------|------|
| `TestAIWriting_StreamingReceive` | writing_service_enhanced_test.go | Skip | 0.3天 |
| `TestAIWriting_StreamingError` | writing_service_enhanced_test.go | Skip | 0.2天 |
| `TestAIWriting_MultiRoundContext` | writing_service_enhanced_test.go | Skip | 0.3天 |
| `TestAIWriting_ConcurrentStreamingRequests` | writing_service_enhanced_test.go | Skip | 0.2天 |

**预期提升**: 10% → 60%

---

**service/project (6个集成测试, 1.5天)**:

| 测试用例 | 文件 | 当前状态 | 工时 |
|---------|------|---------|------|
| `TestVersion_CreateAndIncrementVersion` | version_service_enhanced_test.go | Skip | 0.2天 |
| `TestVersion_OptimisticLockingConflictDetection` | version_service_enhanced_test.go | Skip | 0.3天 |
| `TestVersion_RollbackToHistory` | version_service_enhanced_test.go | Skip | 0.3天 |
| `TestTransaction_BatchCommitAtomicity` | version_service_enhanced_test.go | Skip | 0.3天 |
| `TestConflict_ManualResolutionRequired` | version_service_enhanced_test.go | Skip | 0.2天 |
| `TestVersion_End2EndFlow` | version_service_enhanced_test.go | 新增 | 0.2天 |

**预期提升**: 0% → 40%

---

**service/shared/auth (4个集成测试, 0.5天)**:

| 测试用例 | 文件 | 当前状态 | 工时 |
|---------|------|---------|------|
| `TestAuthService_TokenRefresh` | auth_session_enhanced_test.go | Skip | 0.1天 |
| `TestAuthService_ForceLogout` | auth_session_enhanced_test.go | Skip | 0.1天 |
| `TestSessionService_CreateAndGetSession` | auth_session_enhanced_test.go | Skip | 0.15天 |
| `TestSessionService_CompleteFlow` | auth_session_enhanced_test.go | 新增 | 0.15天 |

**预期提升**: 50% → 90%

---

**验收标准**:
- ✅ 17个集成测试全部通过
- ✅ Service层覆盖率: 33% → 52%
- ✅ P0核心覆盖率: 24% → 64%

---

### 阶段3: 实现TDD功能 (10-14天)

**目标**: 实现35个TDD功能，达到P0核心90%覆盖率

#### 3.1 优先级1 - P0核心功能 (5-7天)

**AI配额预警机制** (2天, 3个功能):

```go
// 文件: service/ai/quota_warning_service.go (新建)

// 1. 配额剩余20%预警
func (s *QuotaService) CheckWarningThreshold(userID string, quotaType QuotaType) (*WarningInfo, error) {
    quota, err := s.repo.GetQuotaByUserID(ctx, userID, quotaType)
    if err != nil {
        return nil, err
    }
    
    usagePercent := float64(quota.Used) / float64(quota.Total) * 100
    if usagePercent >= 80.0 {
        return &WarningInfo{
            Level: "warning",
            Message: fmt.Sprintf("配额已使用%.1f%%", usagePercent),
            Remaining: quota.Available,
        }, nil
    }
    return nil, nil
}

// 2. 配额用尽前1小时预警
func (s *QuotaService) PredictExhaustionTime(userID string) (*time.Time, error) {
    // 基于历史使用速率预测
    // ...
}

// 3. 多次预警防重复
func (s *QuotaService) SendWarningOnce(userID string, warningType string) error {
    // 使用Redis记录已发送的预警，24小时内不重复
    // ...
}
```

**对应测试** (`test/service/ai/quota_service_enhanced_test.go`):
- `TestQuotaWarning_20PercentThreshold` (Skip → Implement)
- `TestQuotaWarning_1HourBeforeExhaustion` (Skip → Implement)
- `TestQuotaWarning_NoDuplicateWithin24Hours` (Skip → Implement)

---

**自动保存功能** (3天, 4个功能):

```go
// 文件: service/project/autosave_service.go (新建)

// 1. 30秒定时保存
func (s *AutoSaveService) StartTimerSave(docID string, interval time.Duration) {
    ticker := time.NewTicker(interval)
    go func() {
        for range ticker.C {
            s.saveDocument(docID)
        }
    }()
}

// 2. 内容变更100字符触发保存
func (s *AutoSaveService) OnContentChange(docID string, delta int) {
    s.changeCounter[docID] += delta
    if s.changeCounter[docID] >= 100 {
        s.saveDocument(docID)
        s.changeCounter[docID] = 0
    }
}

// 3. 离线保存队列
func (s *AutoSaveService) QueueOfflineSave(docID string, content string) {
    s.offlineQueue = append(s.offlineQueue, SaveRequest{
        DocID: docID,
        Content: content,
        Timestamp: time.Now(),
    })
}

// 4. 保存失败重试
func (s *AutoSaveService) SaveWithRetry(docID string, maxRetries int) error {
    for i := 0; i < maxRetries; i++ {
        if err := s.saveDocument(docID); err == nil {
            return nil
        }
        time.Sleep(time.Second * time.Duration(i+1))
    }
    return errors.New("保存失败，已重试3次")
}
```

**对应测试** (`test/service/project/version_service_enhanced_test.go`):
- `TestAutoSave_TimerTrigger30Seconds` (Skip → Implement)
- `TestAutoSave_ContentChangeTrigger100Chars` (Skip → Implement)
- `TestAutoSave_OfflineQueue` (Skip → Implement)
- `TestAutoSave_FailureRetry` (Skip → Implement)

---

**多端登录与密码安全** (2天, 3个功能):

```go
// 文件: service/shared/auth/session_manager.go (增强)

// 1. 多端登录限制（最多5设备）
func (s *SessionManager) EnforceDeviceLimit(userID string, maxDevices int) error {
    sessions, _ := s.GetUserSessions(userID)
    if len(sessions) >= maxDevices {
        // 踢出最旧的会话
        s.DestroySession(sessions[0].ID)
    }
    return nil
}

// 2. 密码强度验证
func (s *AuthService) ValidatePasswordStrength(password string) error {
    if len(password) < 8 {
        return errors.New("密码长度至少8位")
    }
    // 检查大小写、数字、特殊字符
    // ...
}

// 3. 登录失败锁定
func (s *AuthService) RecordLoginFailure(username string) error {
    count, _ := s.redis.Incr("login_fail:" + username)
    if count >= 5 {
        s.redis.SetEx("login_lock:"+username, 30*60, "locked")
        return errors.New("登录失败次数过多，锁定30分钟")
    }
    return nil
}
```

**对应测试** (`test/service/shared/auth/auth_session_enhanced_test.go`):
- `TestAuthService_MultiDeviceLoginLimit` (Skip → Implement)
- `TestAuthService_PasswordStrengthValidation` (Skip → Implement)
- `TestAuthService_LoginFailureLock` (Skip → Implement)

---

#### 3.2 优先级2 - P1重要功能 (5-7天)

**流式响应增强** (2天, 2个功能):

```go
// 文件: service/ai/streaming_manager.go (新建)

// 1. 流式中断恢复
func (s *StreamingManager) HandleInterrupt(streamID string) error {
    // 保存当前进度
    // 释放资源
    // 允许重新开始
}

// 2. 流式错误处理增强
func (s *StreamingManager) HandleStreamError(streamID string, err error) {
    // 错误分类
    // 通过channel传递错误
    // 优雅关闭stream
}
```

**对应测试** (`test/service/ai/writing_service_enhanced_test.go`):
- `TestAIWriting_StreamingInterrupt` (Skip → Implement)
- 增强 `TestAIWriting_StreamingError`

---

**上下文管理** (3天, 3个功能):

```go
// 文件: service/ai/context_manager.go (新建)

// 1. 上下文窗口裁剪
func (s *ContextManager) TrimToTokenLimit(messages []Message, maxTokens int) []Message {
    // 计算Token总数
    // 保留系统提示
    // 裁剪历史对话（保留最近10轮）
}

// 2. 上下文缓存
func (s *ContextManager) GetCachedContext(projectID, chapterID string) ([]Message, bool) {
    // 从Redis获取缓存
    // 验证缓存有效性
}

// 3. 多轮对话上下文保持（已部分实现，需完善）
func (s *ContextManager) BuildMultiRoundContext(sessionID string) []Message {
    // 获取会话历史
    // 构建完整上下文
}
```

**对应测试** (`test/service/ai/writing_service_enhanced_test.go`):
- `TestAIWriting_ContextWindowTrim` (Skip → Implement)
- `TestAIWriting_ContextCache` (Skip → Implement)
- 增强 `TestAIWriting_MultiRoundContext`

---

**协作编辑基础** (2天, 4个功能):

```go
// 文件: service/project/collaboration_service.go (新建)

// 1. 多用户编辑检测
func (s *CollabService) DetectConcurrentEditing(docID string) ([]string, error) {
    // 查询正在编辑的用户
    // 返回用户列表
}

// 2. 编辑锁机制
func (s *CollabService) AcquireEditLock(docID, userID string) error {
    // 尝试获取锁（Redis）
    // 设置30分钟超时
}

// 3. 编辑状态同步
func (s *CollabService) UpdateEditStatus(docID, userID string, status string) {
    // 更新用户编辑状态
    // 通知其他用户
}

// 4. 光标位置追踪
func (s *CollabService) UpdateCursorPosition(docID, userID string, line, col int) {
    // 记录光标位置
    // 广播给其他用户
}
```

**对应测试** (`test/service/project/version_service_enhanced_test.go`):
- `TestCollab_MultiUserEditingDetection` (Skip → Implement)
- `TestCollab_EditLockMechanism` (Skip → Implement)
- `TestCollab_EditingStatusSync` (Skip → Implement)
- `TestCollab_CursorPositionTracking` (Skip → Implement)

---

**其他P1 TDD功能**:
- 版本Diff比较 (1天)
- 模型降级策略 (1天)
- 增量存储 (2天)
- 历史版本清理 (1天)

**验收标准**:
- ✅ 35个TDD功能全部实现
- ✅ 对应测试从Skip→Pass
- ✅ P0核心覆盖率: 64% → 90% ✅
- ✅ Service层覆盖率: 52% → 72%

---

### 阶段4: P2模块测试 (4-5天)

**目标**: 补全P2模块基础测试，达到Service层82%覆盖率

#### 4.1 AI适配器测试 (1.5天, 10个用例)

**文件**: `test/service/ai/adapter/adapter_integration_test.go` (新建)

```go
// Phase 1: 多提供商切换 (3个)
func TestAdapter_OpenAI(t *testing.T) { ... }
func TestAdapter_Wenxin(t *testing.T) { ... }
func TestAdapter_AutoSwitch(t *testing.T) { ... }

// Phase 2: 协议适配 (3个)
func TestAdapter_UnifiedRequest(t *testing.T) { ... }
func TestAdapter_ResponseParsing(t *testing.T) { ... }
func TestAdapter_StreamingProtocol(t *testing.T) { ... }

// Phase 3: 容错与监控 (4个)
func TestAdapter_ProviderFailover(t *testing.T) { ... }
func TestAdapter_HealthCheck(t *testing.T) { ... }
func TestAdapter_PerformanceMetrics(t *testing.T) { ... }
func TestAdapter_CircuitBreaker(t *testing.T) { ... }
```

**预期提升**: adapter 5.2% → 70%

---

#### 4.2 文档Service测试 (1.5天, 10个用例)

**文件**: `test/service/document/document_service_enhanced_test.go` (新建)

```go
// Phase 1: 文档树操作 (4个)
func TestDocument_DragAndDrop(t *testing.T) { ... }
func TestDocument_DepthLimit10(t *testing.T) { ... }
func TestDocument_NodeMove(t *testing.T) { ... }
func TestDocument_TreeIntegrity(t *testing.T) { ... }

// Phase 2: 内容管理 (3个)
func TestDocument_MarkdownConversion(t *testing.T) { ... }
func TestDocument_LargeContentSharding(t *testing.T) { ... }
func TestDocument_SearchIndexUpdate(t *testing.T) { ... }

// Phase 3: 权限与协作 (3个)
func TestDocument_PermissionInheritance(t *testing.T) { ... }
func TestDocument_CollaboratorManagement(t *testing.T) { ... }
func TestDocument_LockUnlock(t *testing.T) { ... }
```

**预期提升**: document 0% → 75%

---

#### 4.3 数据统计测试 (1天, 8个用例)

**文件**: `test/service/stats/stats_service_test.go` (新建)

```go
// Phase 1: 阅读数据统计 (4个)
func TestStats_ReadCount(t *testing.T) { ... }
func TestStats_CompletionRate(t *testing.T) { ... }
func TestStats_SkipRate(t *testing.T) { ... }
func TestStats_TimeGranularity(t *testing.T) { ... }

// Phase 2: 数据聚合 (2个)
func TestStats_MultiDimensionAgg(t *testing.T) { ... }
func TestStats_CacheStrategy(t *testing.T) { ... }

// Phase 3: 性能优化 (2个)
func TestStats_BigDataPerformance(t *testing.T) { ... }
func TestStats_RealtimeVsOffline(t *testing.T) { ... }
```

**预期提升**: stats 0% → 70%

---

#### 4.4 其他P2模块 (1天, 20个用例)

- **bookstore**: 10个用例, 0% → 70%
- **reading**: 10个用例, 0% → 70%

**验收标准**:
- ✅ 48个P2测试用例完成
- ✅ Service层覆盖率: 72% → 82% ✅
- ✅ P0核心覆盖率: 90% → 92% ✅

---

## 3. 测试编写规范与模板

### 3.1 测试文件组织

**目录结构**:
```
test/
├── service/          # Service层单元测试
│   ├── ai/
│   │   ├── quota_service_enhanced_test.go
│   │   ├── writing_service_enhanced_test.go
│   │   └── adapter/
│   │       └── adapter_integration_test.go
│   ├── project/
│   │   └── version_service_enhanced_test.go
│   ├── shared/
│   │   └── auth/
│   │       ├── permission_service_enhanced_test.go
│   │       └── auth_session_enhanced_test.go
│   └── audit/
│       └── content_audit_service_enhanced_test.go
├── integration/      # 集成测试
│   ├── p0_core_integration_test.go
│   └── e2e_writing_flow_test.go
└── testutil/        # 测试工具
    ├── mock_factory.go
    ├── test_data.go
    └── assertions.go
```

---

### 3.2 测试命名规范

**函数命名**:
```go
// 格式: Test<ServiceName>_<MethodName>_<Scenario>
func TestQuotaService_CheckQuota_Success(t *testing.T) { ... }
func TestQuotaService_CheckQuota_InsufficientQuota(t *testing.T) { ... }
func TestQuotaService_ConsumeQuota_ConcurrentSafe(t *testing.T) { ... }
```

**文件命名**:
```
<service_name>_test.go           // 基础测试
<service_name>_enhanced_test.go  // 增强测试（P0/P1）
<service_name>_integration_test.go  // 集成测试
```

---

### 3.3 测试结构模板

**AAA模式** (Arrange-Act-Assert):

```go
func TestQuotaService_CheckQuota_Success(t *testing.T) {
    // ============ Arrange（准备） ============
    // 1. 创建Mock对象
    mockRepo := new(MockQuotaRepository)
    mockEventBus := new(MockEventBus)
    
    // 2. 创建Service实例
    service := ai.NewQuotaService(mockRepo, mockEventBus)
    ctx := context.Background()
    
    // 3. 准备测试数据
    userID := "test_user_123"
    amount := 100
    expectedQuota := &ai.UserQuota{
        UserID:    userID,
        QuotaType: ai.QuotaTypeToken,
        Total:     1000,
        Used:      200,
        Available: 800,
    }
    
    // 4. 设置Mock期望
    mockRepo.On("GetQuotaByUserID", ctx, userID, ai.QuotaTypeToken).
        Return(expectedQuota, nil).
        Once()
    
    // ============ Act（执行） ============
    result, err := service.CheckQuota(ctx, userID, amount)
    
    // ============ Assert（断言） ============
    // 1. 验证错误
    assert.NoError(t, err, "不应返回错误")
    
    // 2. 验证返回值
    assert.NotNil(t, result, "结果不应为nil")
    assert.True(t, result.CanUse, "应该可以使用配额")
    assert.Equal(t, 800, result.Available, "剩余配额应为800")
    
    // 3. 验证Mock调用
    mockRepo.AssertExpectations(t)
    mockRepo.AssertNumberOfCalls(t, "GetQuotaByUserID", 1)
    
    // ============ Cleanup（清理） ============
    // 通常使用t.Cleanup或defer
}
```

---

### 3.4 Mock设计模板

**基础Mock**:

```go
// MockQuotaRepository Mock配额Repository
type MockQuotaRepository struct {
    mock.Mock
    mu sync.Mutex  // 并发安全
}

func (m *MockQuotaRepository) GetQuotaByUserID(ctx context.Context, userID string, quotaType ai.QuotaType) (*ai.UserQuota, error) {
    m.mu.Lock()
    defer m.mu.Unlock()
    
    args := m.Called(ctx, userID, quotaType)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    
    // 返回副本，避免并发修改
    if quota, ok := args.Get(0).(*ai.UserQuota); ok {
        copiedQuota := *quota
        return &copiedQuota, args.Error(1)
    }
    
    return args.Get(0).(*ai.UserQuota), args.Error(1)
}

func (m *MockQuotaRepository) CreateQuota(ctx context.Context, quota *ai.UserQuota) error {
    m.mu.Lock()
    defer m.mu.Unlock()
    
    args := m.Called(ctx, quota)
    return args.Error(0)
}
```

**高级Mock技巧**:

```go
// 1. 使用mock.MatchedBy进行复杂匹配
mockRepo.On("CreateQuota", ctx, mock.MatchedBy(func(q *ai.UserQuota) bool {
    return q.UserID == "test_user" && q.Total > 0
})).Return(nil)

// 2. 使用mock.AnythingOfType匹配类型
mockRepo.On("GetQuotaByUserID", 
    mock.Anything,  // context
    mock.AnythingOfType("string"),  // userID
    ai.QuotaTypeToken,
).Return(expectedQuota, nil)

// 3. 使用mock.Times限定调用次数
mockRepo.On("ConsumeQuota", ctx, userID, 100).
    Return(nil).
    Times(3)  // 恰好调用3次

// 4. 使用Run设置副作用
mockRepo.On("CreateQuota", ctx, mock.Anything).
    Run(func(args mock.Arguments) {
        quota := args.Get(1).(*ai.UserQuota)
        quota.ID = "generated_id"  // 模拟生成ID
    }).
    Return(nil)
```

---

### 3.5 TDD开发模板

**TDD流程**:

```go
// ============ Step 1: Red（测试失败） ============
func TestAutoSave_TimerTrigger30Seconds(t *testing.T) {
    // 编写期望行为的测试
    service := NewAutoSaveService(mockRepo)
    
    // 启动30秒自动保存
    service.StartTimerSave("doc123", 30*time.Second)
    
    // 等待31秒
    time.Sleep(31 * time.Second)
    
    // 验证保存被调用
    mockRepo.AssertCalled(t, "CreateRevision", mock.Anything, mock.MatchedBy(
        func(rev *writer.FileRevision) bool {
            return rev.NodeID == "doc123"
        },
    ))
}

// ============ Step 2: Green（最小实现） ============
// 在service/project/autosave_service.go中实现最小功能
func (s *AutoSaveService) StartTimerSave(docID string, interval time.Duration) {
    ticker := time.NewTicker(interval)
    go func() {
        for range ticker.C {
            s.saveDocument(docID)
        }
    }()
}

func (s *AutoSaveService) saveDocument(docID string) error {
    // 调用VersionService创建版本
    return s.versionService.CreateRevision(docID, "auto_save")
}

// ============ Step 3: Refactor（重构） ============
// 优化实现：添加取消、错误处理、资源管理
func (s *AutoSaveService) StartTimerSave(docID string, interval time.Duration) context.CancelFunc {
    ctx, cancel := context.WithCancel(context.Background())
    ticker := time.NewTicker(interval)
    
    go func() {
        defer ticker.Stop()
        for {
            select {
            case <-ticker.C:
                if err := s.saveDocument(docID); err != nil {
                    s.logger.Warn("自动保存失败", zap.Error(err))
                }
            case <-ctx.Done():
                return
            }
        }
    }()
    
    return cancel
}

// ============ Step 4: Document（文档化） ============
// 更新API文档、使用指南、设计文档
```

---

### 3.6 集成测试模板

**集成测试结构**:

```go
// +build integration

package integration_test

import (
    "context"
    "testing"
    "time"
    
    "github.com/stretchr/testify/assert"
    "github.com/testcontainers/testcontainers-go"
    "go.mongodb.org/mongo-driver/mongo"
)

// TestMain设置集成测试环境
func TestMain(m *testing.M) {
    // 启动MongoDB容器
    mongoContainer, err := startMongoContainer()
    if err != nil {
        panic(err)
    }
    defer mongoContainer.Terminate(context.Background())
    
    // 运行测试
    code := m.Run()
    
    os.Exit(code)
}

func TestVersion_End2EndFlow(t *testing.T) {
    // ============ Arrange ============
    // 1. 连接真实MongoDB
    client, err := connectMongoDB()
    require.NoError(t, err)
    defer client.Disconnect(context.Background())
    
    // 2. 创建真实的Repository
    versionRepo := mongodb.NewVersionRepository(client)
    documentRepo := mongodb.NewDocumentRepository(client)
    
    // 3. 创建Service（无Mock）
    versionService := project.NewVersionService(versionRepo, documentRepo)
    
    // 4. 准备测试数据
    projectID := "test_project_" + uuid.New().String()
    nodeID := "test_node_" + uuid.New().String()
    
    // ============ Act ============
    // 测试完整流程
    
    // 1. 创建第一个版本
    rev1, err := versionService.BumpVersionAndCreateRevision(
        projectID, nodeID, "user1", "Initial version",
    )
    assert.NoError(t, err)
    assert.Equal(t, 1, rev1.Version)
    
    // 2. 创建第二个版本
    rev2, err := versionService.BumpVersionAndCreateRevision(
        projectID, nodeID, "user1", "Second version",
    )
    assert.NoError(t, err)
    assert.Equal(t, 2, rev2.Version)
    
    // 3. 回滚到第一个版本
    rev3, err := versionService.RollbackToVersion(projectID, nodeID, 1, "user1")
    assert.NoError(t, err)
    assert.Equal(t, 3, rev3.Version)
    assert.Equal(t, rev1.Snapshot, rev3.Snapshot) // 内容应一致
    
    // 4. 查询版本历史
    history, err := versionService.GetRevisionHistory(projectID, nodeID, 10)
    assert.NoError(t, err)
    assert.Equal(t, 3, len(history))
    
    // ============ Assert ============
    // 验证数据库状态
    currentVersion, err := versionRepo.GetCurrentVersion(context.Background(), projectID, nodeID)
    assert.NoError(t, err)
    assert.Equal(t, 3, currentVersion)
    
    // ============ Cleanup ============
    // 清理测试数据
    t.Cleanup(func() {
        versionRepo.DeleteByProjectID(context.Background(), projectID)
        documentRepo.DeleteByProjectID(context.Background(), projectID)
    })
}

// Helper: 启动MongoDB容器
func startMongoContainer() (testcontainers.Container, error) {
    req := testcontainers.ContainerRequest{
        Image:        "mongo:6.0",
        ExposedPorts: []string{"27017/tcp"},
        Env: map[string]string{
            "MONGO_INITDB_ROOT_USERNAME": "test",
            "MONGO_INITDB_ROOT_PASSWORD": "test123",
        },
    }
    return testcontainers.GenericContainer(context.Background(), req)
}
```

---

## 4. 各模块测试详细规划

### 4.1 AI服务模块测试规划

**模块**: `service/ai`  
**当前覆盖率**: 10.0%  
**目标覆盖率**: 92%  
**测试文件**: 3个  
**测试用例**: 69个

#### 子模块分解

**1. quota_service (配额管理)**

| 测试场景 | 当前 | 阶段2 | 阶段3 | 总计 |
|---------|------|-------|-------|------|
| 配额计算与扣减 | 5个✅ | 0 | 0 | 5个 |
| 配额恢复 | 2个✅ | 0 | 0 | 2个 |
| 并发安全 | 3个✅ | 0 | 0 | 3个 |
| 角色权限 | 3个✅ | 0 | 0 | 3个 |
| 配额重置 | 2个✅ | 0 | 0 | 2个 |
| 预警机制 | 0个Skip | 0 | 3个TDD | 3个 |
| 付费服务包 | 0个Skip | 0 | 3个TDD | 3个 |
| 边界测试 | 3个✅ | 0 | 0 | 3个 |

**小计**: 18个✅ + 3个Skip → 27个

---

**2. writing_service (AI写作助手)**

| 测试场景 | 当前 | 阶段2 | 阶段3 | 总计 |
|---------|------|-------|-------|------|
| 流式响应 | 0个Skip | 3个集成 | 2个TDD | 5个 |
| 上下文管理 | 0个Skip | 1个集成 | 3个TDD | 4个 |
| 错误重试 | 4个✅ | 0 | 0 | 4个 |
| 模型降级 | 0个Skip | 0 | 1个TDD | 1个 |
| 并发测试 | 1个Skip | 1个集成 | 0 | 1个 |
| 额外测试 | 2个✅ | 0 | 0 | 2个 |

**小计**: 6个✅ + 7个Skip → 17个

---

**3. adapter (AI适配器)**

| 测试场景 | 当前 | 阶段2 | 阶段3 | 阶段4 | 总计 |
|---------|------|-------|-------|-------|------|
| 多提供商切换 | 0 | 0 | 0 | 3个 | 3个 |
| 协议适配 | 0 | 0 | 0 | 3个 | 3个 |
| 容错监控 | 2个✅ | 0 | 0 | 4个 | 6个 |

**小计**: 2个✅ → 12个

---

**4. content_audit (内容审核)**

| 测试场景 | 当前 | 阶段2 | 阶段3 | 总计 |
|---------|------|-------|-------|------|
| 敏感词检测 | 4个✅ | 0 | 0 | 4个 |
| 合规检查 | 4个✅ | 3个集成 | 0 | 7个 |
| 性能优化 | 1个✅ | 0 | 3个TDD | 4个 |
| DFA过滤器 | 2个✅ | 0 | 0 | 2个 |
| 边界测试 | 2个✅ | 0 | 0 | 2个 |

**小计**: 13个✅ + 3个Skip → 19个

---

**AI服务模块总计**: 39个✅ + 13个Skip → 75个（含adapter 12个）

---

### 4.2 认证权限模块测试规划

**模块**: `service/shared/auth`  
**当前覆盖率**: 48.5%  
**目标覆盖率**: 95%  
**测试文件**: 3个  
**测试用例**: 45个

#### 子模块分解

**1. permission_service (权限管理)**

| 测试场景 | 当前 | 阶段2 | 阶段3 | 总计 |
|---------|------|-------|-------|------|
| 角色继承 | 5个✅ | 0 | 0 | 5个 |
| 动态权限 | 4个✅ | 0 | 0 | 4个 |
| 资源权限 | 5个✅ | 0 | 0 | 5个 |
| 性能缓存 | 4个✅ | 0 | 0 | 4个 |
| 边界安全 | 4个✅ | 0 | 0 | 4个 |

**小计**: 22个✅

---

**2. auth_session (认证会话)**

| 测试场景 | 当前 | 阶段1 | 阶段2 | 阶段3 | 总计 |
|---------|------|-------|-------|-------|------|
| 多端登录 | 0个Skip | 0 | 0 | 2个TDD | 2个 |
| Token刷新 | 0个Skip | 0 | 1个集成 | 0 | 1个 |
| 强制登出 | 0个Skip | 0 | 1个集成 | 0 | 1个 |
| 密码安全 | 0个Skip | 0 | 0 | 1个TDD | 1个 |
| 登录锁定 | 0个Skip | 0 | 0 | 2个TDD | 2个 |
| 会话管理 | 0个Skip | 4个解锁 | 2个集成 | 0 | 6个 |

**小计**: 0个✅ + 11个Skip → 13个

---

**3. role_service (角色管理)**

| 测试场景 | 当前 | 总计 |
|---------|------|------|
| 角色CRUD | 已有测试 | ~10个 |

**小计**: ~10个✅

---

**认证权限模块总计**: 32个✅ + 11个Skip → 45个

---

### 4.3 写作核心模块测试规划

**模块**: `service/project`, `service/document`  
**当前覆盖率**: 0%  
**目标覆盖率**: 80%  
**测试文件**: 2个  
**测试用例**: 46个

#### 子模块分解

**1. version_service (版本管理)**

| 测试场景 | 当前 | 阶段2 | 阶段3 | 总计 |
|---------|------|-------|-------|------|
| 版本控制 | 1个✅ + 4个Skip | 6个集成 | 1个TDD | 12个 |
| 自动保存 | 0个Skip | 0 | 4个TDD | 4个 |
| 协作编辑 | 0个Skip | 0 | 4个TDD | 4个 |
| 性能存储 | 0个Skip | 0 | 2个TDD | 2个 |
| 冲突解决 | 0个Skip | 1个集成 | 1个TDD | 2个 |

**小计**: 1个✅ + 17个Skip → 24个

---

**2. document_service (文档管理)**

| 测试场景 | 当前 | 阶段4 | 总计 |
|---------|------|-------|------|
| 文档树操作 | 0 | 4个 | 4个 |
| 内容管理 | 0 | 3个 | 3个 |
| 权限协作 | 0 | 3个 | 3个 |

**小计**: 0 → 10个

---

**3. project_service (项目管理)**

| 测试场景 | 当前 | 总计 |
|---------|------|------|
| 项目CRUD | 已有测试 | ~12个 |

**小计**: ~12个✅

---

**写作核心模块总计**: 13个✅ + 17个Skip → 46个

---

## 5. 测试执行指南

### 5.1 本地测试执行

**运行所有单元测试**:
```bash
# 运行所有Service层测试
go test ./test/service/... -v -timeout 60s

# 运行特定模块测试
go test ./test/service/ai/... -v

# 运行指定测试用例
go test ./test/service/ai -run TestQuotaService_CheckQuota -v
```

**生成覆盖率报告**:
```bash
# 生成覆盖率数据
go test ./service/... -coverprofile=coverage.out -covermode=atomic

# 查看覆盖率
go tool cover -func=coverage.out

# 生成HTML报告
go tool cover -html=coverage.out -o coverage.html
```

---

### 5.2 集成测试执行

**启动测试环境**:
```bash
# 启动MongoDB和Redis
docker-compose -f docker/docker-compose.test.yml up -d

# 等待服务就绪
sleep 5

# 运行集成测试
go test ./test/integration/... -tags=integration -v -timeout 120s

# 清理环境
docker-compose -f docker/docker-compose.test.yml down -v
```

**使用testcontainers** (推荐):
```bash
# 自动管理容器生命周期
go test ./test/integration/... -tags=integration -v
```

---

### 5.3 CI/CD集成

**GitHub Actions配置** (`.github/workflows/test.yml`):

```yaml
name: Tests

on: [push, pull_request]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Run Unit Tests
        run: |
          go test ./service/... -coverprofile=coverage.out -covermode=atomic
          go tool cover -func=coverage.out
      
      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.out
  
  integration-tests:
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_ROOT_USERNAME: test
          MONGO_INITDB_ROOT_PASSWORD: test123
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Run Integration Tests
        run: go test ./test/integration/... -tags=integration -v
        env:
          MONGODB_URI: mongodb://test:test123@localhost:27017
          REDIS_ADDR: localhost:6379
```

---

### 5.4 性能基准测试

**编写Benchmark**:

```go
func BenchmarkQuotaService_CheckQuota(b *testing.B) {
    mockRepo := new(MockQuotaRepository)
    service := ai.NewQuotaService(mockRepo)
    
    mockRepo.On("GetQuotaByUserID", mock.Anything, mock.Anything, mock.Anything).
        Return(&ai.UserQuota{Available: 1000}, nil)
    
    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        service.CheckQuota(context.Background(), "user123", 100)
    }
}
```

**运行Benchmark**:
```bash
# 运行性能测试
go test ./service/ai -bench=. -benchmem

# 比较性能
go test ./service/ai -bench=CheckQuota -count=5 | tee old.txt
# 修改代码后
go test ./service/ai -bench=CheckQuota -count=5 | tee new.txt
benchstat old.txt new.txt
```

---

## 6. 质量保证与验收

### 6.1 测试质量检查清单

**单元测试质量**:
- [ ] 测试独立性（不依赖执行顺序）
- [ ] Mock正确使用（验证调用次数和参数）
- [ ] 覆盖正常、边界、异常场景
- [ ] 断言清晰（使用assert库）
- [ ] 测试命名规范
- [ ] 无硬编码（使用常量或变量）

**集成测试质量**:
- [ ] 使用真实依赖（MongoDB/Redis）
- [ ] 测试数据清理
- [ ] 事务一致性验证
- [ ] 并发安全测试
- [ ] 性能基准验证

**代码质量**:
- [ ] 无Linter错误
- [ ] 测试代码可读性
- [ ] 注释清晰（复杂逻辑）
- [ ] 遵循项目规范

---

### 6.2 覆盖率验收标准

**阶段性目标**:

| 阶段 | Service层 | P0核心 | 验收标准 |
|------|----------|--------|---------|
| **阶段1** | 33% | 24% | SessionService Bug修复，11个测试通过 |
| **阶段2** | 52% | 64% | 17个集成测试全部通过 |
| **阶段3** | 72% | 90% ✅ | 35个TDD功能实现并测试通过 |
| **阶段4** | 82% ✅ | 92% ✅ | 48个P2测试完成 |

**最终验收**:
- ✅ Service层覆盖率 ≥ 80%
- ✅ P0核心覆盖率 ≥ 90%
- ✅ 关键逻辑分支覆盖 ≥ 85%
- ✅ 所有可运行测试通过率 = 100%
- ✅ 集成测试覆盖主要流程
- ✅ 性能测试满足SLA要求

---

### 6.3 持续改进

**每周回顾**:
1. 检查覆盖率趋势
2. 识别新的覆盖盲区
3. 补充遗漏测试
4. 优化测试性能

**测试债务管理**:
1. 记录Skip的测试及原因
2. 定期评估并补充
3. TDD功能优先级排序
4. 删除冗余测试

---

## 附录

### A. 参考文档

1. **测试总结报告**:
   - `doc/implementation/测试/P0测试阶段完成总结报告.md`
   - `doc/implementation/测试/P1功能测试阶段完成总结.md`
   - `doc/implementation/测试/测试覆盖率报告_2025-10-23.md`

2. **实施计划**:
   - `doc/implementation/00进度指导/MVP与后续阶段功能实施规划_2025-10-23.md`
   - `p0----service.plan.md`

3. **技术规范**:
   - `doc/architecture/架构设计规范.md`
   - `doc/engineering/软件工程规范_v2.0.md`
   - `test/README_测试运行指南.md`

---

### B. 快速命令参考

```bash
# 运行所有测试
make test

# 运行Service层测试
go test ./service/... -v

# 生成覆盖率报告
go test ./service/... -coverprofile=coverage.out
go tool cover -html=coverage.out -o coverage.html

# 运行集成测试
docker-compose -f docker/docker-compose.test.yml up -d
go test ./test/integration/... -tags=integration -v
docker-compose -f docker/docker-compose.test.yml down -v

# 运行Benchmark
go test ./service/... -bench=. -benchmem

# 查看特定模块覆盖率
go test ./service/ai -cover -coverprofile=ai_coverage.out
go tool cover -func=ai_coverage.out
```

---

**文档维护**:
- **版本**: v1.0
- **制定**: 2025-10-23
- **更新频率**: 每完成一个阶段更新
- **责任人**: 测试负责人

---

**下一步行动**:
1. ✅ 审阅本规划并确认优先级
2. ✅ 分配测试任务到团队成员
3. ✅ 启动阶段1工作（Bug修复）
4. ✅ 建立每日测试执行报告
5. ✅ 每周五更新覆盖率报告

