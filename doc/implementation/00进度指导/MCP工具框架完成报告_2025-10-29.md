# MCPå·¥å…·æ¡†æ¶å®ŒæˆæŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-29  
**çŠ¶æ€**: âœ… å®Œæˆ  
**ç‰ˆæœ¬**: v1.0

---

## å®Œæˆæ‘˜è¦

æˆåŠŸå®ç°äº†**MCP (Modular, Composable, Portable) å·¥å…·æ¡†æ¶**ï¼Œä¸ºAgentç³»ç»Ÿæä¾›æ ‡å‡†åŒ–ã€å¯æ‰©å±•çš„å·¥å…·è°ƒç”¨åŸºç¡€è®¾æ–½ã€‚

### æ ¸å¿ƒæˆæœ
âœ… å®ç°BaseToolæŠ½è±¡åŸºç±»  
âœ… å®ç°ToolMetadataå…ƒæ•°æ®ç³»ç»Ÿ  
âœ… å®ç°ToolResultç»Ÿä¸€ç»“æœæ ¼å¼  
âœ… å®ç°LangChainé€‚é…å™¨  
âœ… å®ç°ToolRegistryå·¥å…·æ³¨å†Œæœºåˆ¶  
âœ… å®Œæˆ8ä¸ªå•å…ƒæµ‹è¯•ï¼ˆ100%é€šè¿‡ï¼‰

---

## æ¶æ„è®¾è®¡

### 1. æ ¸å¿ƒç»„ä»¶

```
MCPå·¥å…·æ¡†æ¶
â”œâ”€â”€ tools/base/                  # åŸºç¡€æ¨¡å—
â”‚   â”œâ”€â”€ tool_base.py            # BaseToolæŠ½è±¡åŸºç±»
â”‚   â”œâ”€â”€ tool_metadata.py        # ToolMetadataå’ŒToolCategory
â”‚   â”œâ”€â”€ tool_result.py          # ToolResultå’ŒToolStatus
â”‚   â”œâ”€â”€ tool_schema.py          # ToolInputSchemaåŸºç±»
â”‚   â””â”€â”€ __init__.py             # æ¨¡å—å¯¼å‡º
â”‚
â”œâ”€â”€ tools/adapters/              # é€‚é…å™¨
â”‚   â”œâ”€â”€ langchain_adapter.py    # LangChainå·¥å…·é€‚é…å™¨
â”‚   â””â”€â”€ __init__.py
â”‚
â””â”€â”€ tools/registry/              # æ³¨å†Œæœºåˆ¶
    â”œâ”€â”€ tool_registry.py        # ToolRegistryæ³¨å†Œä¸­å¿ƒ
    â””â”€â”€ __init__.py
```

### 2. è®¾è®¡æ¨¡å¼

#### 2.1 æŠ½è±¡å·¥å‚æ¨¡å¼
```python
class BaseTool(ABC):
    @abstractmethod
    async def _execute_impl(self, validated_input) -> ToolResult:
        pass
```

#### 2.2 é€‚é…å™¨æ¨¡å¼
```python
class LangChainToolAdapter(LangChainBaseTool):
    def __init__(self, mcp_tool: BaseTool):
        # é€‚é…MCPå·¥å…·ä¸ºLangChainå·¥å…·
```

#### 2.3 æ³¨å†Œä¸­å¿ƒæ¨¡å¼
```python
registry = ToolRegistry()
registry.register(tool_class, metadata)
tool = registry.create_tool_instance("tool_name")
```

---

## åŠŸèƒ½ç‰¹æ€§

### 1. BaseTool - å·¥å…·åŸºç±»

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… ç»Ÿä¸€çš„å·¥å…·æ‰§è¡Œæ¥å£
- âœ… è‡ªåŠ¨è¾“å…¥éªŒè¯ï¼ˆPydanticï¼‰
- âœ… æƒé™æ£€æŸ¥ï¼ˆè®¤è¯ã€é¡¹ç›®ä¸Šä¸‹æ–‡ï¼‰
- âœ… é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- âœ… æ‰§è¡Œæ—¶é—´ç»Ÿè®¡

**ä½¿ç”¨ç¤ºä¾‹**:
```python
class MyTool(BaseTool):
    @property
    def input_schema(self):
        return MyToolInput
    
    async def _execute_impl(self, validated_input):
        # å®ç°å·¥å…·é€»è¾‘
        return ToolResult.success_result(...)
```

### 2. ToolMetadata - å·¥å…·å…ƒæ•°æ®

**å…ƒæ•°æ®å­—æ®µ**:
- `name`: å·¥å…·åç§°ï¼ˆå”¯ä¸€æ ‡è¯†ç¬¦ï¼‰
- `description`: å·¥å…·æè¿°
- `category`: å·¥å…·ç±»åˆ«ï¼ˆknowledge, creation, analysisç­‰ï¼‰
- `version`: ç‰ˆæœ¬å·
- `requires_auth`: æ˜¯å¦éœ€è¦è®¤è¯
- `requires_project`: æ˜¯å¦éœ€è¦é¡¹ç›®ä¸Šä¸‹æ–‡
- `estimated_tokens`: é¢„ä¼°Tokenæ¶ˆè€—
- `max_retries`: æœ€å¤§é‡è¯•æ¬¡æ•°
- `tags`: å·¥å…·æ ‡ç­¾

**å·¥å…·ç±»åˆ«**:
```python
class ToolCategory(str, Enum):
    KNOWLEDGE = "knowledge"      # çŸ¥è¯†æ£€ç´¢å·¥å…·
    CREATION = "creation"        # å†…å®¹åˆ›ä½œå·¥å…·
    ANALYSIS = "analysis"        # åˆ†æå·¥å…·
    MANAGEMENT = "management"    # é¡¹ç›®ç®¡ç†å·¥å…·
    EXTERNAL = "external"        # å¤–éƒ¨æœåŠ¡å·¥å…·
    SYSTEM = "system"            # ç³»ç»Ÿå·¥å…·
```

### 3. ToolResult - ç»Ÿä¸€ç»“æœæ ¼å¼

**ç»“æœçŠ¶æ€**:
```python
class ToolStatus(str, Enum):
    SUCCESS = "success"
    FAILED = "failed"
    PARTIAL = "partial"
    TIMEOUT = "timeout"
    PERMISSION_DENIED = "permission_denied"
    INVALID_INPUT = "invalid_input"
```

**ä¾¿æ·æ–¹æ³•**:
```python
# æˆåŠŸç»“æœ
ToolResult.success_result(tool_name="my_tool", data={...})

# å¤±è´¥ç»“æœ
ToolResult.failed_result(tool_name="my_tool", error="é”™è¯¯ä¿¡æ¯")

# æƒé™æ‹’ç»
ToolResult.permission_denied_result(tool_name="my_tool")

# è¾“å…¥æ— æ•ˆ
ToolResult.invalid_input_result(tool_name="my_tool", error="éªŒè¯é”™è¯¯")
```

### 4. LangChainToolAdapter - LangChainé›†æˆ

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… å°†MCPå·¥å…·é€‚é…ä¸ºLangChain Tool
- âœ… æ”¯æŒå¼‚æ­¥æ‰§è¡Œ
- âœ… è‡ªåŠ¨ç±»å‹è½¬æ¢
- âœ… é”™è¯¯å¤„ç†

**ä½¿ç”¨ç¤ºä¾‹**:
```python
# åˆ›å»ºMCPå·¥å…·
mcp_tool = MyTool(metadata=metadata)

# é€‚é…ä¸ºLangChainå·¥å…·
langchain_tool = LangChainToolAdapter(mcp_tool=mcp_tool)

# åœ¨LangChainä¸­ä½¿ç”¨
result = await langchain_tool._arun(param1="value1", param2="value2")
```

### 5. ToolRegistry - å·¥å…·æ³¨å†Œæœºåˆ¶

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… å·¥å…·æ³¨å†Œå’Œæ³¨é”€
- âœ… å·¥å…·æŸ¥æ‰¾å’Œè·å–
- âœ… å·¥å…·å®ä¾‹åˆ›å»º
- âœ… æŒ‰ç±»åˆ«/æ ‡ç­¾ç­›é€‰
- âœ… å…¨å±€å•ä¾‹æ³¨å†Œä¸­å¿ƒ

**ä½¿ç”¨ç¤ºä¾‹**:
```python
# è·å–å…¨å±€æ³¨å†Œä¸­å¿ƒ
registry = get_global_tool_registry()

# æ³¨å†Œå·¥å…·
registry.register(MyTool, metadata=tool_metadata)

# åˆ›å»ºå·¥å…·å®ä¾‹
tool = registry.create_tool_instance(
    tool_name="my_tool",
    auth_context={"user_id": "user123"}
)

# æŸ¥è¯¢å·¥å…·
knowledge_tools = registry.get_tools_by_category(ToolCategory.KNOWLEDGE)
all_tools = registry.list_all_tools()
```

---

## æµ‹è¯•ç»“æœ

### æµ‹è¯•è¦†ç›–

| æµ‹è¯•é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|-------|------|------|
| test_tool_metadata | âœ… PASSED | å·¥å…·å…ƒæ•°æ®æµ‹è¯• |
| test_tool_result | âœ… PASSED | å·¥å…·ç»“æœæµ‹è¯• |
| test_base_tool_execute | âœ… PASSED | å·¥å…·æ‰§è¡Œæµ‹è¯•ï¼ˆåŠ æ³•ã€é™¤æ³•ã€é™¤é›¶ï¼‰ |
| test_tool_input_validation | âœ… PASSED | è¾“å…¥éªŒè¯æµ‹è¯• |
| test_tool_registry | âœ… PASSED | å·¥å…·æ³¨å†Œæœºåˆ¶æµ‹è¯• |
| test_global_tool_registry | âœ… PASSED | å…¨å±€æ³¨å†Œä¸­å¿ƒå•ä¾‹æµ‹è¯• |
| test_langchain_adapter | âœ… PASSED | LangChainé€‚é…å™¨æµ‹è¯• |
| test_tool_auth | âœ… PASSED | å·¥å…·æƒé™è®¤è¯æµ‹è¯• |

**æ€»è®¡**: 8/8 é€šè¿‡ âœ…

### æµ‹è¯•è¾“å‡ºæ‘˜è¦

```
======================== 8 passed, 1 warning in 0.25s =========================
```

**æ‰§è¡Œæ—¶é—´**: 0.25ç§’  
**é€šè¿‡ç‡**: 100%

---

## ä½¿ç”¨æŒ‡å—

### 1. åˆ›å»ºè‡ªå®šä¹‰å·¥å…·

#### Step 1: å®šä¹‰è¾“å…¥æ¨¡å¼
```python
from pydantic import Field
from tools.base import ToolInputSchema

class MyToolInput(ToolInputSchema):
    """è‡ªå®šä¹‰å·¥å…·è¾“å…¥"""
    param1: str = Field(..., description="å‚æ•°1")
    param2: int = Field(..., description="å‚æ•°2")
```

#### Step 2: å®ç°å·¥å…·ç±»
```python
from tools.base import BaseTool, ToolResult

class MyTool(BaseTool):
    """è‡ªå®šä¹‰å·¥å…·"""
    
    @property
    def input_schema(self):
        return MyToolInput
    
    async def _execute_impl(self, validated_input: MyToolInput) -> ToolResult:
        """æ‰§è¡Œå·¥å…·é€»è¾‘"""
        try:
            # æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            result = do_something(validated_input.param1, validated_input.param2)
            
            return ToolResult.success_result(
                tool_name=self.metadata.name,
                data={"result": result},
                message="æ‰§è¡ŒæˆåŠŸ",
            )
        except Exception as e:
            return ToolResult.failed_result(
                tool_name=self.metadata.name,
                error=str(e),
            )
```

#### Step 3: æ³¨å†Œå·¥å…·
```python
from tools.base import ToolMetadata, ToolCategory
from tools.registry import get_global_tool_registry

# å®šä¹‰å…ƒæ•°æ®
metadata = ToolMetadata(
    name="my_tool",
    description="æˆ‘çš„è‡ªå®šä¹‰å·¥å…·",
    category=ToolCategory.CREATION,
    version="1.0.0",
    requires_auth=True,
)

# æ³¨å†Œåˆ°å…¨å±€æ³¨å†Œä¸­å¿ƒ
registry = get_global_tool_registry()
registry.register(MyTool, metadata=metadata)
```

#### Step 4: ä½¿ç”¨å·¥å…·
```python
# åˆ›å»ºå·¥å…·å®ä¾‹
tool = registry.create_tool_instance(
    tool_name="my_tool",
    auth_context={"user_id": "user123", "project_id": "proj456"}
)

# æ‰§è¡Œå·¥å…·
result = await tool.execute({
    "param1": "value1",
    "param2": 42
})

if result.success:
    print(f"æˆåŠŸ: {result.data}")
else:
    print(f"å¤±è´¥: {result.error}")
```

### 2. é›†æˆåˆ°LangChain

```python
from tools.adapters import LangChainToolAdapter
from langchain.agents import AgentExecutor, create_openai_functions_agent

# åˆ›å»ºMCPå·¥å…·
mcp_tool = MyTool(metadata=metadata)

# é€‚é…ä¸ºLangChainå·¥å…·
langchain_tool = LangChainToolAdapter(mcp_tool=mcp_tool)

# åœ¨Agentä¸­ä½¿ç”¨
tools = [langchain_tool]
agent = create_openai_functions_agent(llm, tools, prompt)
agent_executor = AgentExecutor(agent=agent, tools=tools)

# æ‰§è¡ŒAgent
result = await agent_executor.ainvoke({"input": "ç”¨æˆ·æŸ¥è¯¢"})
```

### 3. å·¥å…·æƒé™ç®¡ç†

```python
# åˆ›å»ºéœ€è¦è®¤è¯çš„å·¥å…·
metadata = ToolMetadata(
    name="secure_tool",
    description="éœ€è¦è®¤è¯çš„å·¥å…·",
    category=ToolCategory.MANAGEMENT,
    requires_auth=True,
    requires_project=True,
)

# å¸¦è®¤è¯ä¸Šä¸‹æ–‡åˆ›å»ºå®ä¾‹
tool = SecureTool(
    metadata=metadata,
    auth_context={
        "user_id": "user123",
        "project_id": "proj456",
        "role": "admin",
    }
)

# æ‰§è¡Œæ—¶ä¼šè‡ªåŠ¨æ£€æŸ¥æƒé™
result = await tool.execute(input_data)
```

---

## æ ¸å¿ƒä¼˜åŠ¿

### 1. æ¨¡å—åŒ– (Modular)
- æ¯ä¸ªå·¥å…·ç‹¬ç«‹å°è£…ï¼ŒèŒè´£æ¸…æ™°
- æ˜“äºå¼€å‘ã€æµ‹è¯•å’Œç»´æŠ¤
- æ”¯æŒæ¸è¿›å¼å¼€å‘å’Œè¿­ä»£

### 2. å¯ç»„åˆ (Composable)
- å·¥å…·å¯ä»¥çµæ´»ç»„åˆä½¿ç”¨
- LangChainé€‚é…å™¨æ”¯æŒä¸ç°æœ‰ç”Ÿæ€é›†æˆ
- æ³¨å†Œæœºåˆ¶æ”¯æŒåŠ¨æ€å·¥å…·ç®¡ç†

### 3. å¯ç§»æ¤ (Portable)
- ç»Ÿä¸€æ¥å£ï¼Œä¸ä¾èµ–ç‰¹å®šæ¡†æ¶
- å¯é€‚é…åˆ°ä¸åŒçš„Agentç³»ç»Ÿ
- ä¾¿äºå·¥å…·çš„å¤ç”¨å’Œå…±äº«

### 4. ç±»å‹å®‰å…¨
- Pydanticè¾“å…¥éªŒè¯
- ç±»å‹æç¤ºå®Œæ•´
- è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥

### 5. å¯è§‚æµ‹æ€§
- ç»“æ„åŒ–æ—¥å¿—è®°å½•
- æ‰§è¡Œæ—¶é—´ç»Ÿè®¡
- Tokenæ¶ˆè€—è¿½è¸ª
- å®Œæ•´çš„æ‰§è¡Œé“¾è·¯

---

## å®æ–½æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒæ–‡ä»¶
- âœ… `src/tools/base/tool_base.py` - BaseToolæŠ½è±¡åŸºç±»
- âœ… `src/tools/base/tool_metadata.py` - ToolMetadataå’ŒToolCategory
- âœ… `src/tools/base/tool_result.py` - ToolResultå’ŒToolStatus
- âœ… `src/tools/base/tool_schema.py` - ToolInputSchemaåŸºç±»
- âœ… `src/tools/base/__init__.py` - åŸºç¡€æ¨¡å—å¯¼å‡º

### é€‚é…å™¨
- âœ… `src/tools/adapters/langchain_adapter.py` - LangChainé€‚é…å™¨
- âœ… `src/tools/adapters/__init__.py` - é€‚é…å™¨æ¨¡å—å¯¼å‡º

### æ³¨å†Œæœºåˆ¶
- âœ… `src/tools/registry/tool_registry.py` - ToolRegistryæ³¨å†Œä¸­å¿ƒ
- âœ… `src/tools/registry/__init__.py` - æ³¨å†Œæ¨¡å—å¯¼å‡º

### æµ‹è¯•
- âœ… `tests/test_mcp_tool_framework.py` - å®Œæ•´æµ‹è¯•å¥—ä»¶ï¼ˆ8ä¸ªæµ‹è¯•ï¼‰

---

## åç»­å·¥ä½œ

### å·²å®Œæˆ âœ…
1. å®ç°WorkspaceContextTool - ä¸Šä¸‹æ–‡æ„ŸçŸ¥å·¥å…·
2. å‡çº§BaseAgentæ¡†æ¶ - PipelineStateV2å’ŒAgentåŸºç±»
3. **å®ç°MCPå·¥å…·æ¡†æ¶ - æ ‡å‡†åŒ–å·¥å…·æ¥å£** â† å½“å‰

### ä¸‹ä¸€æ­¥ ğŸ“‹
4. å®ç°å¢å¼ºå®¡æ ¸Agent - DiagnosticReportã€æ·±åº¦è¯Šæ–­
5. å®ç°å…ƒè°ƒåº¦å™¨ - è¯Šæ–­æŠ¥å‘Šè§£æã€æ™ºèƒ½å®šä½
6. å®ç°ä¸“ä¸šAgent - OutlineAgentã€CharacterAgentã€PlotAgent
7. å®ç°LangGraphå·¥ä½œæµ - åæ€å¾ªç¯è·¯ç”±
8. é›†æˆæµ‹è¯•å’Œä¼˜åŒ– - ç«¯åˆ°ç«¯æµ‹è¯•

---

## å‚è€ƒæ–‡æ¡£

**è®¾è®¡æ–‡æ¡£**:
- `doc/design/ai/phase3/05.A2Aåˆ›ä½œæµæ°´çº¿Agentè®¾è®¡_v2.0_æ™ºèƒ½åä½œç”Ÿæ€.md`

**å®æ–½æ–‡æ¡£**:
- `doc/implementation/00è¿›åº¦æŒ‡å¯¼/Phase3_Agentç³»ç»Ÿå¼€å‘å®æ–½è®¡åˆ’_2025-10-29.md`
- `doc/implementation/00è¿›åº¦æŒ‡å¯¼/Gemini_APIé…ç½®æˆåŠŸæŠ¥å‘Š_2025-10-29.md`

**ä»£ç ç¤ºä¾‹**:
- `tests/test_mcp_tool_framework.py` - å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

---

## æŠ€æœ¯äº®ç‚¹

### 1. æŠ½è±¡ä¸å…·ä½“åˆ†ç¦»
- BaseToolå®šä¹‰æŠ½è±¡æ¥å£
- å­ç±»å®ç°å…·ä½“é€»è¾‘
- æ¡†æ¶å¤„ç†é€šç”¨é€»è¾‘ï¼ˆéªŒè¯ã€é”™è¯¯å¤„ç†ã€æ—¥å¿—ï¼‰

### 2. Pydanticæ·±åº¦é›†æˆ
- è¾“å…¥æ¨¡å¼éªŒè¯
- ç±»å‹å®‰å…¨
- è‡ªåŠ¨æ–‡æ¡£ç”Ÿæˆï¼ˆLangChainï¼‰

### 3. å¼‚æ­¥ä¼˜å…ˆ
- æ‰€æœ‰å·¥å…·æ‰§è¡Œéƒ½æ˜¯å¼‚æ­¥çš„
- æ”¯æŒé«˜å¹¶å‘åœºæ™¯
- é¿å…é˜»å¡ä¸»çº¿ç¨‹

### 4. é”™è¯¯å¤„ç†å®Œå–„
- ç»Ÿä¸€çš„é”™è¯¯åˆ†ç±»ï¼ˆToolStatusï¼‰
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- æ”¯æŒé‡è¯•æœºåˆ¶

### 5. å¯æ‰©å±•æ€§å¼º
- æ˜“äºæ·»åŠ æ–°å·¥å…·ç±»åˆ«
- æ”¯æŒè‡ªå®šä¹‰é€‚é…å™¨
- æ’ä»¶åŒ–æ¶æ„

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-29  
**æŠ¥å‘Šäºº**: Qingyu AI Team  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª

