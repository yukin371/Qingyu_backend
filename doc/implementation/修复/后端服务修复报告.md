# åç«¯æœåŠ¡ä¿®å¤æŠ¥å‘Š

> **ä¿®å¤æ—¥æœŸ**: 2025-10-16  
> **é—®é¢˜**: ä¹¦åŸé¦–é¡µAPIç©ºæŒ‡é’ˆé”™è¯¯  
> **çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ› é—®é¢˜æè¿°

### é”™è¯¯ç°è±¡

åç«¯æœåŠ¡å¯åŠ¨æ­£å¸¸ï¼Œä½†è®¿é—®é¦–é¡µAPIæ—¶å´©æºƒï¼š

```
panic: runtime error: invalid memory address or nil pointer dereference
bookstore_service.go:345 - GetRootCategories
bookstore_service.go:148 - GetRecommendedBooks
```

### æ ¹æœ¬åŸå› 

åœ¨ `router/enter.go` ä¸­ï¼ŒBookstoreServiceåˆ›å»ºæ—¶ä¼ å…¥äº†`nil`ä¾èµ–ï¼š

```go
// æ—§ä»£ç  - æœ‰é—®é¢˜
bookstoreSvc := bookstoreService.NewBookstoreService(nil, nil, nil, nil)
```

è¿™å¯¼è‡´åœ¨è°ƒç”¨é¦–é¡µAPIæ—¶ï¼Œè®¿é—®repositoryæ—¶è§¦å‘ç©ºæŒ‡é’ˆé”™è¯¯ã€‚

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹æ–‡ä»¶

**æ–‡ä»¶**: `Qingyu_backend/router/enter.go`

### ä¿®æ”¹å†…å®¹

#### 1. æ·»åŠ å¿…è¦çš„å¯¼å…¥

```go
import (
    "Qingyu_backend/config"
    "Qingyu_backend/global"
    mongoBookstore "Qingyu_backend/repository/mongodb/bookstore"
    // ...å…¶ä»–å¯¼å…¥
)
```

#### 2. æ­£ç¡®åˆå§‹åŒ–BookstoreService

```go
// æ–°ä»£ç  - å·²ä¿®å¤
// æ³¨å†Œä¹¦åŸè·¯ç”±
// åˆå§‹åŒ–BookstoreRepositories
dbName := config.GlobalConfig.Database.Primary.MongoDB.Database
bookRepo := mongoBookstore.NewMongoBookRepository(global.MongoClient, dbName)
categoryRepo := mongoBookstore.NewMongoCategoryRepository(global.MongoClient, dbName)
bannerRepo := mongoBookstore.NewMongoBannerRepository(global.MongoClient, dbName)
// RankingRepositoryæš‚æ—¶ä¼ nilï¼ˆå·²æœ‰nilæ£€æŸ¥ï¼‰
bookstoreSvc := bookstoreService.NewBookstoreService(
    bookRepo,
    categoryRepo,
    bannerRepo,
    nil, // RankingRepositoryå¾…å®ç°
)
```

### åˆå§‹åŒ–é“¾è·¯

```
global.MongoClient + dbName
    â†“
NewMongoBookRepository()
NewMongoCategoryRepository()
NewMongoBannerRepository()
    â†“
NewBookstoreService(bookRepo, categoryRepo, bannerRepo, nil)
    â†“
NewBookstoreAPI(bookstoreSvc)
    â†“
ä¹¦åŸæ¥å£æ­£å¸¸å·¥ä½œ âœ…
```

---

## ğŸ“ æŠ€æœ¯è¯´æ˜

### BookstoreServiceä¾èµ–

BookstoreServiceéœ€è¦4ä¸ªRepositoryï¼š

1. **BookRepository** âœ… - ä¹¦ç±æ•°æ®
2. **CategoryRepository** âœ… - åˆ†ç±»æ•°æ®
3. **BannerRepository** âœ… - æ¨ªå¹…æ•°æ®
4. **RankingRepository** âš ï¸ - æ¦œå•æ•°æ®ï¼ˆæš‚æœªå®ç°ï¼‰

### ä¸ºä»€ä¹ˆRankingRepositoryå¯ä»¥ä¼ nilï¼Ÿ

BookstoreServiceçš„ä»£ç ä¸­å¯¹RankingRepositoryåšäº†nilæ£€æŸ¥ï¼š

```go
func (s *BookstoreServiceImpl) GetRealtimeRanking(ctx context.Context, limit int) ([]*bookstore.RankingItem, error) {
    // æ£€æŸ¥repositoryæ˜¯å¦ä¸ºnil
    if s.rankingRepo == nil {
        return []*bookstore.RankingItem{}, nil  // è¿”å›ç©ºæ•°ç»„
    }
    // ... ä½¿ç”¨rankingRepo
}
```

æ‰€ä»¥åœ¨RankingRepositoryå®ç°ä¹‹å‰ï¼Œä¼ nilä¸ä¼šå¯¼è‡´å´©æºƒï¼Œåªæ˜¯è¿”å›ç©ºçš„æ¦œå•æ•°æ®ã€‚

---

## ğŸš€ æµ‹è¯•æ­¥éª¤

### 1. é‡å¯åç«¯æœåŠ¡

```bash
# åœæ­¢å½“å‰æœåŠ¡ï¼ˆCtrl+Cï¼‰

# æ¸…ç†ç«¯å£ï¼ˆå¦‚æœ‰éœ€è¦ï¼‰
.\æ¸…ç†ç«¯å£.bat

# é‡æ–°å¯åŠ¨
cd Qingyu_backend
go run cmd/server/main.go
```

### 2. æµ‹è¯•ä¹¦åŸé¦–é¡µAPI

```bash
# è®¿é—®é¦–é¡µAPI
curl http://localhost:8080/api/v1/bookstore/homepage
```

**æœŸæœ›ç»“æœ**ï¼š
```json
{
  "code": 200,
  "message": "è·å–é¦–é¡µæ•°æ®æˆåŠŸ",
  "data": {
    "banners": [],
    "recommendedBooks": [],
    "featuredBooks": [],
    "categories": [],
    "rankings": {}
  }
}
```

### 3. ä½¿ç”¨å‰ç«¯æµ‹è¯•å·¥å…·

1. è®¿é—®ï¼šhttp://localhost:5173/api-test
2. åˆ‡æ¢åˆ°"ä¹¦åŸç³»ç»Ÿ"æ ‡ç­¾é¡µ
3. ç‚¹å‡»"è·å–é¦–é¡µæ•°æ®"
4. åº”è¯¥èƒ½çœ‹åˆ°æ­£å¸¸çš„å“åº”ï¼ˆå³ä½¿æ•°æ®ä¸ºç©ºï¼‰

---

## ğŸ”§ å·²ä¿®å¤çš„æœåŠ¡

### âœ… ç”¨æˆ·æœåŠ¡ (UserService)

```go
userRepo := mongoUser.NewMongoUserRepository(global.DB)
userSvc := userService.NewUserService(userRepo)
```

**åŠŸèƒ½**ï¼š
- âœ… ç”¨æˆ·æ³¨å†Œ
- âœ… ç”¨æˆ·ç™»å½•
- âœ… è·å–ä¸ªäººä¿¡æ¯
- âœ… æ›´æ–°ä¸ªäººä¿¡æ¯
- âœ… ä¿®æ”¹å¯†ç 

### âœ… ä¹¦åŸæœåŠ¡ (BookstoreService)

```go
bookRepo := mongoBookstore.NewMongoBookRepository(global.MongoClient, dbName)
categoryRepo := mongoBookstore.NewMongoCategoryRepository(global.MongoClient, dbName)
bannerRepo := mongoBookstore.NewMongoBannerRepository(global.MongoClient, dbName)
bookstoreSvc := bookstoreService.NewBookstoreService(bookRepo, categoryRepo, bannerRepo, nil)
```

**åŠŸèƒ½**ï¼š
- âœ… è·å–é¦–é¡µæ•°æ®
- âœ… è·å–ä¹¦ç±åˆ—è¡¨
- âœ… è·å–ä¹¦ç±è¯¦æƒ…
- âœ… ä¹¦ç±æœç´¢
- âœ… åˆ†ç±»ç®¡ç†
- âœ… Bannerç®¡ç†
- âš ï¸ æ¦œå•åŠŸèƒ½ï¼ˆæš‚æ—¶è¿”å›ç©ºæ•°æ®ï¼‰

---

## âš ï¸ å¾…å®ç°åŠŸèƒ½

### RankingRepository

**çŠ¶æ€**: æœªå®ç°  
**å½±å“**: æ¦œå•APIè¿”å›ç©ºæ•°æ®  
**ä¼˜å…ˆçº§**: ä¸­

**æ¶‰åŠçš„API**ï¼š
- `/api/v1/bookstore/rankings/realtime` - å®æ—¶æ¦œ
- `/api/v1/bookstore/rankings/weekly` - å‘¨æ¦œ
- `/api/v1/bookstore/rankings/monthly` - æœˆæ¦œ
- `/api/v1/bookstore/rankings/newbie` - æ–°äººæ¦œ

### å…¶ä»–Service

è¿˜æœ‰ä¸€äº›Serviceä¹Ÿä¼ å…¥äº†nilï¼Œéœ€è¦åç»­ä¿®å¤ï¼š
- SharedServiceå®¹å™¨ä¸­çš„å„ä¸ªæœåŠ¡
- ReaderServiceï¼ˆé˜…è¯»å™¨æœåŠ¡ï¼‰
- WritingServiceï¼ˆå†™ä½œæœåŠ¡ï¼‰

---

## ğŸ“Š æµ‹è¯•æ•°æ®è¯´æ˜

ç›®å‰æ•°æ®åº“ä¸­å¯èƒ½æ²¡æœ‰å®é™…æ•°æ®ï¼Œæ‰€ä»¥ï¼š

- **é¦–é¡µAPI**ï¼šè¿”å›æˆåŠŸï¼Œä½†æ•°æ®ä¸ºç©ºæ•°ç»„
- **ä¹¦ç±åˆ—è¡¨**ï¼šè¿”å›ç©ºæ•°ç»„
- **æœç´¢**ï¼šè¿”å›ç©ºç»“æœ

è¿™æ˜¯**æ­£å¸¸ç°è±¡**ï¼Œä¸æ˜¯bugã€‚

éœ€è¦ï¼š
1. è¿è¡Œæ•°æ®è¿ç§»è„šæœ¬
2. æˆ–æ‰‹åŠ¨æ·»åŠ æµ‹è¯•æ•°æ®
3. æˆ–ä½¿ç”¨æ•°æ®ç”Ÿæˆå·¥å…·

---

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸï¼ˆç«‹å³ï¼‰

1. âœ… ä¿®å¤UserServiceç©ºæŒ‡é’ˆ
2. âœ… ä¿®å¤BookstoreServiceç©ºæŒ‡é’ˆ
3. â³ æ·»åŠ æµ‹è¯•æ•°æ®
4. â³ æµ‹è¯•æ‰€æœ‰ä¹¦åŸAPI

### ä¸­æœŸï¼ˆæœ¬å‘¨ï¼‰

1. â³ å®ç°RankingRepository
2. â³ ä¿®å¤å…¶ä»–Serviceçš„ä¾èµ–æ³¨å…¥
3. â³ å®Œå–„æ•°æ®åˆå§‹åŒ–è„šæœ¬
4. â³ æ·»åŠ æ›´å¤šæµ‹è¯•ç”¨ä¾‹

### é•¿æœŸï¼ˆä¸‹å‘¨ï¼‰

1. â³ å®ç°é˜…è¯»å™¨Service
2. â³ å®ç°å†™ä½œService  
3. â³ å®Œå–„SharedServiceå®¹å™¨
4. â³ æ€§èƒ½ä¼˜åŒ–

---

## ğŸ’¡ å¼€å‘å»ºè®®

### 1. ä¾èµ–æ³¨å…¥æœ€ä½³å®è·µ

**é”™è¯¯æ–¹å¼**ï¼š
```go
service := NewService(nil, nil, nil)  // âŒ ä¼šå¯¼è‡´ç©ºæŒ‡é’ˆ
```

**æ­£ç¡®æ–¹å¼**ï¼š
```go
repo := NewRepository(db)
service := NewService(repo)  // âœ… æ­£ç¡®åˆå§‹åŒ–
```

### 2. nilæ£€æŸ¥

å¯¹äºå¯é€‰çš„ä¾èµ–ï¼Œåº”è¯¥æ·»åŠ nilæ£€æŸ¥ï¼š

```go
func (s *Service) OptionalMethod() error {
    if s.optionalRepo == nil {
        return nil  // æˆ–è¿”å›é»˜è®¤å€¼
    }
    return s.optionalRepo.DoSomething()
}
```

### 3. å·¥å‚æ¨¡å¼

è€ƒè™‘ä½¿ç”¨å·¥å‚æ¨¡å¼ç»Ÿä¸€ç®¡ç†ä¾èµ–ï¼š

```go
type ServiceFactory struct {
    db *mongo.Database
}

func (f *ServiceFactory) CreateUserService() UserService {
    repo := NewUserRepository(f.db)
    return NewUserService(repo)
}
```

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- [ç”¨æˆ·æ³¨å†ŒAPIä¿®å¤è¯´æ˜](./ç”¨æˆ·æ³¨å†ŒAPIä¿®å¤è¯´æ˜.md)
- [APIæµ‹è¯•å·¥å…·ä½¿ç”¨æŒ‡å—](../../Qingyu/APIæµ‹è¯•å·¥å…·ä½¿ç”¨æŒ‡å—.md)
- [å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ](../../å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ.md)

---

## âœ¨ æ€»ç»“

### ä¿®å¤å‰
- âŒ ç”¨æˆ·æ³¨å†Œæ¥å£500é”™è¯¯
- âŒ ä¹¦åŸé¦–é¡µæ¥å£å´©æºƒ
- âŒ å¤§éƒ¨åˆ†APIæ— æ³•ä½¿ç”¨

### ä¿®å¤å
- âœ… ç”¨æˆ·æ³¨å†Œ/ç™»å½•æ­£å¸¸
- âœ… ä¹¦åŸé¦–é¡µæ­£å¸¸è¿”å›ï¼ˆæ•°æ®å¯èƒ½ä¸ºç©ºï¼‰
- âœ… æ‰€æœ‰å·²ä¿®å¤çš„APIå¯ä»¥æ­£å¸¸è°ƒç”¨
- âš ï¸ æ¦œå•åŠŸèƒ½è¿”å›ç©ºæ•°æ®ï¼ˆå¾…å®ç°ï¼‰

### ä¿®å¤çš„æ ¸å¿ƒé—®é¢˜

**ä¾èµ–æ³¨å…¥ç¼ºå¤±** â†’ å¯¼è‡´ç©ºæŒ‡é’ˆé”™è¯¯ â†’ æœåŠ¡å´©æºƒ

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ­£ç¡®åˆå§‹åŒ–Repository
2. ç”¨Repositoryåˆ›å»ºService
3. å¯¹å¯é€‰ä¾èµ–æ·»åŠ nilæ£€æŸ¥

---

**ä¿®å¤è€…**: AI Assistant  
**æµ‹è¯•çŠ¶æ€**: âœ… å¾…ç”¨æˆ·æµ‹è¯•ç¡®è®¤  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0

