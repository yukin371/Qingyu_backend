# Docker 测试环境快速验证指南

## 验证步骤

### 第一步：验证Docker Compose配置

```bash
# 验证配置文件语法
docker-compose -f docker/docker-compose.test.yml config

# 应该看到完整的配置输出，无错误
```

### 第二步：启动测试环境

```bash
# 启动测试环境
docker-compose -f docker/docker-compose.test.yml up -d

# 查看容器状态
docker-compose -f docker/docker-compose.test.yml ps
```

**预期输出：**
```
NAME                    IMAGE           STATUS
qingyu-mongodb-test     mongo:6.0       Up (healthy)
qingyu-redis-test       redis:7-alpine  Up (healthy)
```

### 第三步：验证服务健康状态

**验证MongoDB:**
```bash
# Linux/Mac
docker exec qingyu-mongodb-test mongo --eval "db.adminCommand('ping')" --quiet

# Windows
docker exec qingyu-mongodb-test mongo --eval "db.adminCommand('ping')" --quiet

# 应该输出: { "ok" : 1 }
```

**验证Redis:**
```bash
docker exec qingyu-redis-test redis-cli ping

# 应该输出: PONG
```

### 第四步：连接测试

**连接MongoDB:**
```bash
# 使用mongo shell连接
docker exec -it qingyu-mongodb-test mongo -u admin -p password

# 在mongo shell中执行
show dbs
use qingyu_test
db.test.insertOne({message: "Hello Docker Test"})
db.test.find()
exit
```

**连接Redis:**
```bash
# 使用redis-cli连接
docker exec -it qingyu-redis-test redis-cli

# 在redis-cli中执行
SET test "Hello Redis"
GET test
EXIT
```

### 第五步：运行简单测试

**设置环境变量（Linux/Mac）:**
```bash
export MONGODB_URI="mongodb://admin:password@localhost:27017"
export MONGODB_DATABASE="qingyu_test"
export REDIS_ADDR="localhost:6379"
export ENVIRONMENT="test"
```

**设置环境变量（Windows PowerShell）:**
```powershell
$env:MONGODB_URI="mongodb://admin:password@localhost:27017"
$env:MONGODB_DATABASE="qingyu_test"
$env:REDIS_ADDR="localhost:6379"
$env:ENVIRONMENT="test"
```

**运行测试:**
```bash
# 运行单个测试包
go test -v ./test/integration/... -run TestXXX

# 或运行所有集成测试（如果有的话）
go test -v -short ./test/integration/...
```

### 第六步：清理环境

```bash
# 停止并删除容器、网络、卷
docker-compose -f docker/docker-compose.test.yml down -v

# 验证清理成功
docker ps -a | grep qingyu-test
# 应该没有输出

docker volume ls | grep test
# 应该没有输出（因为使用tmpfs）
```

## 故障排查

### 问题1: MongoDB容器启动失败

**检查:**
```bash
docker-compose -f docker/docker-compose.test.yml logs mongodb-test
```

**常见原因:**
- 端口27017已被占用
- Docker内存不足

**解决方案:**
```bash
# 检查端口占用
netstat -ano | findstr :27017  # Windows
lsof -i :27017                 # Linux/Mac

# 停止占用端口的进程，或修改docker-compose.test.yml中的端口映射
```

### 问题2: Redis容器启动失败

**检查:**
```bash
docker-compose -f docker/docker-compose.test.yml logs redis-test
```

**常见原因:**
- 端口6379已被占用

**解决方案:**
```bash
# 检查端口占用
netstat -ano | findstr :6379  # Windows
lsof -i :6379                 # Linux/Mac
```

### 问题3: 健康检查一直不通过

**等待更长时间:**
```bash
# MongoDB需要10-15秒启动
# 查看启动进度
docker-compose -f docker/docker-compose.test.yml logs -f mongodb-test
```

**手动触发健康检查:**
```bash
docker exec qingyu-mongodb-test mongo --eval "db.adminCommand('ping')"
```

### 问题4: 测试连接数据库失败

**检查网络连接:**
```bash
# 从宿主机测试MongoDB连接
mongosh mongodb://admin:password@localhost:27017/qingyu_test

# 或使用Docker容器测试
docker run --rm --network host mongo:6.0 \
  mongosh mongodb://admin:password@localhost:27017/qingyu_test --eval "db.adminCommand('ping')"
```

## 完整测试流程（一键复制）

**Linux/Mac:**
```bash
#!/bin/bash
echo "=== 启动测试环境 ==="
docker-compose -f docker/docker-compose.test.yml up -d

echo "=== 等待服务启动 ==="
sleep 15

echo "=== 验证MongoDB ==="
docker exec qingyu-mongodb-test mongo --eval "db.adminCommand('ping')" --quiet

echo "=== 验证Redis ==="
docker exec qingyu-redis-test redis-cli ping

echo "=== 设置环境变量 ==="
export MONGODB_URI="mongodb://admin:password@localhost:27017"
export MONGODB_DATABASE="qingyu_test"
export REDIS_ADDR="localhost:6379"
export ENVIRONMENT="test"

echo "=== 运行测试 ==="
go test -v -short ./test/integration/...

echo "=== 清理环境 ==="
docker-compose -f docker/docker-compose.test.yml down -v

echo "=== 测试完成 ==="
```

**Windows PowerShell:**
```powershell
Write-Host "=== 启动测试环境 ===" -ForegroundColor Green
docker-compose -f docker/docker-compose.test.yml up -d

Write-Host "=== 等待服务启动 ===" -ForegroundColor Green
Start-Sleep -Seconds 15

Write-Host "=== 验证MongoDB ===" -ForegroundColor Green
docker exec qingyu-mongodb-test mongo --eval "db.adminCommand('ping')" --quiet

Write-Host "=== 验证Redis ===" -ForegroundColor Green
docker exec qingyu-redis-test redis-cli ping

Write-Host "=== 设置环境变量 ===" -ForegroundColor Green
$env:MONGODB_URI="mongodb://admin:password@localhost:27017"
$env:MONGODB_DATABASE="qingyu_test"
$env:REDIS_ADDR="localhost:6379"
$env:ENVIRONMENT="test"

Write-Host "=== 运行测试 ===" -ForegroundColor Green
go test -v -short ./test/integration/...

Write-Host "=== 清理环境 ===" -ForegroundColor Green
docker-compose -f docker/docker-compose.test.yml down -v

Write-Host "=== 测试完成 ===" -ForegroundColor Green
```

## CI/CD 验证

在推送代码前，可以本地模拟CI环境：

```bash
# 清理旧环境
docker-compose -f docker/docker-compose.test.yml down -v

# 启动
docker-compose -f docker/docker-compose.test.yml up -d

# 等待健康检查
for i in {1..30}; do
  if docker exec qingyu-mongodb-test mongo --eval "db.adminCommand('ping')" --quiet > /dev/null 2>&1; then
    echo "MongoDB ready!"
    break
  fi
  sleep 2
done

# 运行完整测试套件
export MONGODB_URI="mongodb://admin:password@localhost:27017"
export MONGODB_DATABASE="qingyu_test"
export REDIS_ADDR="localhost:6379"
export ENVIRONMENT="test"

go test -v -race -timeout 10m ./test/integration/...
go test -v -race -timeout 10m ./test/api/...

# 清理
docker-compose -f docker/docker-compose.test.yml down -v
```

## 性能基准

预期性能指标：
- **启动时间**: 10-15秒
- **健康检查**: 5-10秒
- **测试执行**: 取决于测试复杂度
- **清理时间**: 2-3秒

如果超过这些时间，可能需要：
1. 检查Docker资源限制
2. 检查系统负载
3. 查看容器日志定位问题

