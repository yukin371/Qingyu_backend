# CI/测试环境 Docker Compose 配置
version: '3.8'

services:
  # MongoDB数据库（测试专用）
  mongodb-test:
    image: mongo:7.0
    container_name: qingyu-mongodb-test
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password
      MONGO_INITDB_DATABASE: qingyu_test
    # 关键：让 MongoDB 绑定到所有网络接口，允许从宿主机访问
    command: ["mongod", "--bind_ip_all"]
    networks:
      - test-network
    healthcheck:
      # MongoDB 7.0使用mongosh而不是mongo
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')", "--quiet"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    tmpfs:
      - /data/db  # 使用内存存储，测试结束自动清理

  # Redis缓存（测试专用）
  redis-test:
    image: redis:7-alpine
    container_name: qingyu-redis-test
    ports:
      - "6379:6379"
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 3s
      timeout: 2s
      retries: 5
    tmpfs:
      - /data  # 使用内存存储

  # gRPC AI服务（测试专用）
  grpc-ai-service:
    build:
      context: ../python_ai_service
      dockerfile: docker/Dockerfile.grpc
    container_name: qingyu-grpc-ai-test
    ports:
      - "50051:50051"
    networks:
      - test-network
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-test-api-key}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY:-test-api-key}
      - PYTHONUNBUFFERED=1
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.socket(); s.connect(('localhost', 50051))"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    tmpfs:
      - /tmp

networks:
  test-network:
    driver: bridge

