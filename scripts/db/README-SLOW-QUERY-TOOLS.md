# MongoDBæ…¢æŸ¥è¯¢åˆ†æå·¥å…·ä½¿ç”¨æŒ‡å—

## ğŸ“‹ å·¥å…·æ¦‚è¿°

æœ¬ç›®å½•åŒ…å«ä¸‰ä¸ªMongoDBæ…¢æŸ¥è¯¢åˆ†æå·¥å…·ï¼Œç”¨äºç›‘æ§ã€åˆ†æå’Œä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ï¼š

1. **enable_profiling.js** - é…ç½®MongoDB Profiler
2. **analyze_slow_queries.js** - åŸºç¡€æ…¢æŸ¥è¯¢åˆ†æå·¥å…·
3. **auto_analyze_slow_queries.js** - è‡ªåŠ¨åŒ–æ…¢æŸ¥è¯¢åˆ†æå’Œä¼˜åŒ–å»ºè®®
4. **test_slow_queries.js** - æµ‹è¯•æ•°æ®ç”Ÿæˆå·¥å…·

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯ç”¨Profiler

```bash
# æ–¹å¼1: ä½¿ç”¨mongosh
mongosh qingyu_dev < scripts/db/enable_profiling.js

# æ–¹å¼2: åœ¨mongoshä¸­ç›´æ¥æ‰§è¡Œ
mongosh qingyu_dev
> load('scripts/db/enable_profiling.js')
```

**é…ç½®è¯´æ˜**ï¼š
- Profilerçº§åˆ«ï¼š1ï¼ˆä»…è®°å½•æ…¢æŸ¥è¯¢ï¼‰
- æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼š100ms
- å­˜å‚¨å¤§å°ï¼š100MBï¼ˆå¾ªç¯è¦†ç›–ï¼‰

### 2. ç”Ÿæˆæµ‹è¯•æ•°æ®ï¼ˆå¯é€‰ï¼‰

```bash
# ç”Ÿæˆæµ‹è¯•æ…¢æŸ¥è¯¢æ•°æ®
mongosh qingyu_dev < scripts/db/test_slow_queries.js
```

### 3. åˆ†ææ…¢æŸ¥è¯¢

#### åŸºç¡€åˆ†æ
```bash
mongosh qingyu_dev < scripts/db/analyze_slow_queries.js
```

**è¾“å‡ºå†…å®¹**ï¼š
- æ€»æ…¢æŸ¥è¯¢æ•°é‡
- æŒ‰é›†åˆåˆ†ç»„ç»Ÿè®¡ï¼ˆæ¬¡æ•°ã€å¹³å‡è€—æ—¶ã€æœ€å¤§è€—æ—¶ï¼‰
- Top 10æœ€æ…¢æŸ¥è¯¢
- æœªä½¿ç”¨ç´¢å¼•çš„æ…¢æŸ¥è¯¢
- æŒ‰æ“ä½œç±»å‹ç»Ÿè®¡
- åŸºç¡€ä¼˜åŒ–å»ºè®®

#### è‡ªåŠ¨åˆ†æå’Œä¼˜åŒ–å»ºè®®
```bash
mongosh qingyu_dev < scripts/db/auto_analyze_slow_queries.js
```

**è¾“å‡ºå†…å®¹**ï¼š
- æŸ¥è¯¢æ¨¡å¼è¯†åˆ«å’Œèšåˆ
- ç´¢å¼•ä½¿ç”¨æƒ…å†µåˆ†æ
- è‡ªåŠ¨ç”Ÿæˆç´¢å¼•å»ºè®®
- ä¼˜å…ˆçº§æ ‡æ³¨ï¼ˆP0-P3ï¼‰
- é›†åˆçº§åˆ«çš„ç»Ÿè®¡
- è¯¦ç»†çš„ä¼˜åŒ–å»ºè®®

## ğŸ“Š è¾“å‡ºç¤ºä¾‹

### analyze_slow_queries.js è¾“å‡º

```
=== æ…¢æŸ¥è¯¢åˆ†ææŠ¥å‘Š ===
ç”Ÿæˆæ—¶é—´: 2026-01-27T10:30:00.000Z

å½“å‰æ…¢æŸ¥è¯¢é˜ˆå€¼: 100ms

æ€»æ…¢æŸ¥è¯¢æ•°: 156

æŒ‰é›†åˆç»Ÿè®¡:
  qingyu_dev.users:
    æ¬¡æ•°: 45
    å¹³å‡è€—æ—¶: 234.56ms
    æœ€å¤§è€—æ—¶: 567ms
    æœ€å°è€—æ—¶: 102ms
    æ€»è€—æ—¶: 10555.20ms

  qingyu_dev.books:
    æ¬¡æ•°: 32
    å¹³å‡è€—æ—¶: 189.45ms
    æœ€å¤§è€—æ—¶: 445ms
    ...

Top 10æœ€æ…¢æŸ¥è¯¢:
1. qingyu_dev.users - 567ms
   æ—¶é—´: 2026-01-27T10:25:30.123Z
   æŸ¥è¯¢: {"username":{"$regex":"test"}}
   ...

æœªä½¿ç”¨ç´¢å¼•çš„æ…¢æŸ¥è¯¢åˆ†æ:
  é›†åˆ: qingyu_dev.users
    æœªä½¿ç”¨ç´¢å¼•æ¬¡æ•°: 12
    å¹³å‡è€—æ—¶: 345.67ms
    æœ€å¤§è€—æ—¶: 567ms
    ç¤ºä¾‹æŸ¥è¯¢:
      - {"status":"active"} (234ms)
      ...
```

### auto_analyze_slow_queries.js è¾“å‡º

```
=== æ…¢æŸ¥è¯¢è‡ªåŠ¨åˆ†æå’Œä¼˜åŒ–å»ºè®® ===
ç”Ÿæˆæ—¶é—´: 2026-01-27T10:30:00.000Z

åˆ†ææŸ¥è¯¢æ€»æ•°: 156
å‘ç°æŸ¥è¯¢æ¨¡å¼: 23

[1] æŸ¥è¯¢æ¨¡å¼ #1
é›†åˆ: qingyu_dev.users
æŸ¥è¯¢: {"status":"active"}
ç»Ÿè®¡ä¿¡æ¯:
  æ¬¡æ•°: 15
  å¹³å‡è€—æ—¶: 234.56ms
  æœ€å¤§è€—æ—¶: 456ms
  æœ€å°è€—æ—¶: 123ms
âš ï¸ ç´¢å¼•ä½¿ç”¨: æœªä½¿ç”¨ç´¢å¼•ï¼ˆæ£€æµ‹åˆ°å…¨è¡¨æ‰«æï¼‰
ğŸ’¡ å»ºè®®: ä¸ºè¯¥æŸ¥è¯¢æ·»åŠ ç´¢å¼•
   æ¨èç´¢å¼•: {"status":1}
   åˆ›å»ºå‘½ä»¤: db.users.createIndex({"status":1})
ğŸ”´ ä¼˜å…ˆçº§: P0 - é«˜é¢‘æ…¢æŸ¥è¯¢

=== åˆ†ææ€»ç»“ ===
ğŸ”´ P0 (é«˜é¢‘æ…¢æŸ¥è¯¢): 3 ä¸ª
ğŸŸ  P1 (ææ…¢æŸ¥è¯¢): 2 ä¸ª
...
```

## ğŸ¯ ä¼˜å…ˆçº§è¯´æ˜

- **P0 (ğŸ”´)**: é«˜é¢‘æ…¢æŸ¥è¯¢ - count>10 && avgTime>200msï¼Œéœ€è¦ç«‹å³ä¼˜åŒ–
- **P1 (ğŸŸ )**: ææ…¢æŸ¥è¯¢ - avgTime>500msï¼Œå»ºè®®å°½å¿«ä¼˜åŒ–
- **P2 (ğŸŸ¡)**: ä¸­ç­‰æ…¢æŸ¥è¯¢ - avgTime>200ms æˆ– count>5ï¼Œå»ºè®®ä¼˜åŒ–
- **P3 (ğŸŸ¢)**: ä¸€èˆ¬æ…¢æŸ¥è¯¢ - å¯ä»¥ä¼˜åŒ–

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### 1. å®šæœŸç›‘æ§

å»ºè®®æ¯å‘¨æˆ–æ¯å¤©è¿è¡Œåˆ†æå·¥å…·ï¼š

```bash
# æ¯å¤©åˆ†æ
0 2 * * * mongosh qingyu_dev < /path/to/analyze_slow_queries.js > /logs/slow_query_$(date +\%Y\%m\%d).log
```

### 2. ä¼˜åŒ–æµç¨‹

1. è¿è¡Œ `auto_analyze_slow_queries.js` è·å–è¯¦ç»†çš„ä¼˜åŒ–å»ºè®®
2. ä¼˜å…ˆå¤„ç†P0çº§åˆ«çš„æŸ¥è¯¢
3. æ ¹æ®å»ºè®®åˆ›å»ºç´¢å¼•
4. ä½¿ç”¨ `explain()` éªŒè¯ç´¢å¼•æ•ˆæœ
5. é‡æ–°è¿è¡Œåˆ†æå·¥å…·éªŒè¯ä¼˜åŒ–æ•ˆæœ

### 3. åˆ›å»ºç´¢å¼•ç¤ºä¾‹

```javascript
// è¿›å…¥æ•°æ®åº“
use qingyu_dev

// åˆ›å»ºå•å­—æ®µç´¢å¼•
db.users.createIndex({ username: 1 })

// åˆ›å»ºå¤åˆç´¢å¼•
db.books.createIndex({ author_id: 1, created_at: -1 })

// åˆ›å»ºå”¯ä¸€ç´¢å¼•
db.users.createIndex({ email: 1 }, { unique: true })

// æŸ¥çœ‹ç´¢å¼•
db.users.getIndexes()
```

### 4. éªŒè¯ç´¢å¼•æ•ˆæœ

```javascript
// ä½¿ç”¨explainæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’
db.users.find({ username: "test" }).explain("executionStats")

// æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†ç´¢å¼•
// stage: "IXSCAN" è¡¨ç¤ºä½¿ç”¨äº†ç´¢å¼•
// stage: "COLLSCAN" è¡¨ç¤ºå…¨è¡¨æ‰«æ
```

## ğŸ”§ å¸¸è§é—®é¢˜

### 1. æ²¡æœ‰æ…¢æŸ¥è¯¢æ•°æ®

**åŸå› **ï¼š
- Profileræœªå¯ç”¨
- æŸ¥è¯¢æ‰§è¡Œé€Ÿåº¦å¤ªå¿«
- system.profileé›†åˆå·²æ»¡è¢«è¦†ç›–

**è§£å†³**ï¼š
```javascript
// æ£€æŸ¥ProfilerçŠ¶æ€
db.getProfilingStatus()

// é‡æ–°å¯ç”¨Profiler
db.setProfilingLevel(1, { slowms: 100 })

// ç”Ÿæˆæµ‹è¯•æ•°æ®
load('scripts/db/test_slow_queries.js')
```

### 2. ä¸­æ–‡æ˜¾ç¤ºä¹±ç 

**è§£å†³**ï¼š
```bash
# Windows
mongosh --encoding UTF-8 qingyu_dev < scripts/db/analyze_slow_queries.js

# Linux/Mac
export LANG=zh_CN.UTF-8
mongosh qingyu_dev < scripts/db/analyze_slow_queries.js
```

### 3. èšåˆæŸ¥è¯¢å¤ªæ…¢

**è§£å†³**ï¼š
- æ·»åŠ æ—¶é—´èŒƒå›´é™åˆ¶
- å‡å°‘åˆ†æçš„æ•°æ®é‡
- è°ƒæ•´profilingçº§åˆ«

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [MongoDB Profilerå®˜æ–¹æ–‡æ¡£](https://www.mongodb.com/docs/manual/reference/method/db.setProfilingLevel/)
- [system.profileé›†åˆè¯´æ˜](https://www.mongodb.com/docs/manual/reference/system-collections/#system.profile)
- [èšåˆç®¡é“ä½¿ç”¨æŒ‡å—](https://www.mongodb.com/docs/manual/core/aggregation-pipeline/)
- [ç´¢å¼•ä¼˜åŒ–æœ€ä½³å®è·µ](https://www.mongodb.com/docs/manual/indexes/)

## ğŸ§¹ æ¸…ç†æµ‹è¯•æ•°æ®

```javascript
// æ¸…ç†æµ‹è¯•é›†åˆ
db.test_slow_query.drop()

// æ¸…ç†system.profileï¼ˆè°¨æ…æ“ä½œï¼‰
db.system.profile.drop()

// é‡æ–°åˆ›å»ºprofileé›†åˆ
db.createCollection("system.profile", { capped: true, size: 104857600 })
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½å½±å“**ï¼šå¯ç”¨Profilerä¼šå¯¹æ•°æ®åº“æ€§èƒ½äº§ç”Ÿè½»å¾®å½±å“ï¼Œå»ºè®®åœ¨ä½å³°æœŸè¿›è¡Œ
2. **å­˜å‚¨ç©ºé—´**ï¼šsystem.profileæ˜¯å›ºå®šå¤§å°é›†åˆï¼Œæ—§æ•°æ®ä¼šè¢«è‡ªåŠ¨è¦†ç›–
3. **ç”Ÿäº§ç¯å¢ƒ**ï¼šå»ºè®®é˜ˆå€¼è®¾ç½®ä¸º200msæˆ–æ›´é«˜ï¼Œé¿å…è®°å½•è¿‡å¤šæ•°æ®
4. **æƒé™è¦æ±‚**ï¼šéœ€è¦æ•°æ®åº“ç®¡ç†å‘˜æƒé™æ‰èƒ½é…ç½®Profiler
5. **ç´¢å¼•åˆ›å»º**ï¼šåœ¨åˆ›å»ºç´¢å¼•æ—¶ï¼Œå»ºè®®ä½¿ç”¨ `background: true` é€‰é¡¹é¿å…é˜»å¡

## ğŸ‰ æ€»ç»“

è¿™äº›å·¥å…·å¯ä»¥å¸®åŠ©ä½ ï¼š
- âœ… å¿«é€Ÿè¯†åˆ«æ…¢æŸ¥è¯¢
- âœ… åˆ†ææŸ¥è¯¢æ¨¡å¼
- âœ… è·å–ç´¢å¼•ä¼˜åŒ–å»ºè®®
- âœ… ç›‘æ§æ•°æ®åº“æ€§èƒ½
- âœ… æå‡åº”ç”¨å“åº”é€Ÿåº¦

å®šæœŸä½¿ç”¨è¿™äº›å·¥å…·è¿›è¡Œæ€§èƒ½åˆ†æå’Œä¼˜åŒ–ï¼Œå¯ä»¥æ˜¾è‘—æå‡MongoDBçš„æŸ¥è¯¢æ€§èƒ½å–µ~
