# A/B测试脚本使用说明

## 概述

本目录包含4个用于Block 3阶段4性能对比测试的脚本工具。

## 脚本列表

### 1. performance_comparison.sh
性能对比测试主脚本，支持有缓存/无缓存的对比测试。

**用法：**
```bash
# 执行完整对比测试（推荐）
./scripts/performance_comparison.sh compare

# 只执行有缓存测试
./scripts/performance_comparison.sh with-cache

# 只执行无缓存测试
./scripts/performance_comparison.sh without-cache
```

**环境变量：**
- `BASE_URL`: 后端服务地址（默认: http://localhost:8080）
- `OUTPUT_DIR`: 测试结果输出目录（默认: test_results）
- `BOOK_ID`: 测试用书籍ID（默认: 507f1f77bcf86cd799439011）

**功能：**
- 清空Redis缓存
- 执行基准测试（调用 cmd/benchmark/main.go）
- 生成对比报告

### 2. parse_ab_result.py
解析Apache Bench测试结果JSON文件。

**用法：**
```bash
python3 scripts/parse_ab_result.py <result_json_file>
```

**示例：**
```bash
python3 scripts/parse_ab_result.py test_results/result_cache_true.json
```

**输出：**
- 场景名称
- 总请求数
- 成功/失败数
- 平均延迟、P95延迟、P99延迟
- 吞吐量

### 3. generate_comparison.py
生成性能对比报告（Markdown格式）。

**用法：**
```bash
python3 scripts/generate_comparison.py \
  --with-cache test_results/result_cache_true.json \
  --without-cache test_results/result_cache_false.json \
  --output test_results/comparison_report.md
```

**报告内容：**
- 测试配置信息
- 响应时间对比（平均、P95、P99）
- 吞吐量对比
- 成功率对比
- 性能改善评估（延迟改善目标：>= 30%）

### 4. collect_metrics.sh
Prometheus指标采集脚本，用于在测试过程中收集性能指标。

**用法：**
```bash
# 后台运行指标采集
./scripts/collect_metrics.sh &

# 或指定自定义参数
PROMETHEUS_URL="http://localhost:9090" \
OUTPUT_FILE="test_results/metrics.log" \
INTERVAL=10 \
./scripts/collect_metrics.sh
```

**环境变量：**
- `PROMETHEUS_URL`: Prometheus服务地址（默认: http://localhost:9090）
- `OUTPUT_FILE`: 输出日志文件（默认: metrics.log）
- `INTERVAL`: 采集间隔秒数（默认: 10）

**采集指标：**
- cache_hits_total: 缓存命中总数
- cache_misses_total: 缓存未命中总数

## 完整测试流程

### 1. 准备环境
```bash
# 确保后端服务运行在 http://localhost:8080
# 确保Redis服务已启动
# 确保 Prometheus 服务已启动（可选）
```

### 2. 执行性能对比测试
```bash
# 在 Qingyu_backend-block3-optimization 目录下执行
./scripts/performance_comparison.sh compare
```

### 3. 查看测试结果
```bash
# 查看生成的报告
cat test_results/comparison_report.md

# 解析单个测试结果
python3 scripts/parse_ab_result.py test_results/result_cache_true.json
```

### 4. （可选）采集Prometheus指标
```bash
# 终端1: 启动指标采集
./scripts/collect_metrics.sh &

# 终端2: 执行性能测试
./scripts/performance_comparison.sh compare

# 终端1: 测试结束后停止采集（Ctrl+C）
```

## 测试结果文件说明

执行 `performance_comparison.sh compare` 后，会生成以下文件：

```
test_results/
├── result_cache_false.json      # 无缓存测试结果
├── result_cache_true.json       # 有缓存测试结果
└── comparison_report.md         # 对比报告
```

## 故障排查

### 问题1: Redis FLUSHDB 失败
**现象：** 警告 "Redis未启动或FLUSHDB失败"
**解决：** 检查Redis服务是否运行
```bash
redis-cli ping
```

### 问题2: benchmark执行失败
**现象：** 警告 "测试执行失败"
**解决：** 检查后端服务是否运行
```bash
curl http://localhost:8080/health
```

### 问题3: Python脚本编码错误
**现象：** UnicodeEncodeError
**解决：** 脚本已使用UTF-8编码，确保终端支持UTF-8

## 性能基准

根据Block 3优化目标，缓存应达到：

- **响应时间改善**: >= 30%
- **吞吐量提升**: 预期显著提升
- **成功率**: 保持 >= 99%

## 注意事项

1. 确保测试环境隔离，避免其他请求干扰
2. 多次运行测试取平均值，提高结果可靠性
3. 关注P95/P99延迟，而不仅仅是平均延迟
4. 监控系统资源（CPU、内存、网络）使用情况
5. 测试完成后清理测试数据

---
Generated by Block 3 Stage 4 - Task 4.2
