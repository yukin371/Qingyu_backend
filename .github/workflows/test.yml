name: Test

on:
  push:
    branches: [ master, main, develop, dev, test ]
  pull_request:
    branches: [ master, main, develop, dev, test ]
  workflow_dispatch:

env:
  GO_VERSION: '1.24'
  MONGODB_VERSION: '7.0'
  REDIS_VERSION: '7-alpine'

jobs:
  # 单元测试和覆盖率
  test:
    name: Unit Tests
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh 'mongodb://admin:password@localhost:27017' --eval 'db.stats().ok'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download Go dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Run go vet
        run: go vet $(go list ./... | grep -v '^Qingyu_backend/cmd/')

      - name: Run go fmt check
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch --no-tags --depth=1 origin "${{ github.base_ref }}"
            changed_go_files=$(git diff --name-only "origin/${{ github.base_ref }}...HEAD" -- '*.go')
          else
            changed_go_files=$(git diff --name-only HEAD~1..HEAD -- '*.go' || true)
          fi

          if [ -z "$changed_go_files" ]; then
            echo "No changed Go files to format-check."
            exit 0
          fi

          unformatted_files=$(echo "$changed_go_files" | xargs gofmt -s -l)
          if [ -n "$unformatted_files" ]; then
            echo "The following changed files are not formatted:"
            echo "$unformatted_files"
            exit 1
          fi

      - name: Run staticcheck
        uses: dominikh/staticcheck-action@v1.3.0
        with:
          version: "2025.1.1"
          install-go: false
          checks: "-U1000,-SA1029"

      - name: Run unit tests
        env:
          MONGODB_URI: mongodb://admin:password@localhost:27017
          REDIS_ADDR: localhost:6379
          REDIS_PASSWORD: ""
        run: |
          go test -v -race -count=1 \
            -coverprofile=coverage.out \
            -covermode=atomic \
            ./...

      - name: Generate coverage report
        run: go tool cover -html=coverage.out -o coverage.html

      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.out
            coverage.html

      - name: Display coverage summary
        run: |
          echo "=== Coverage Summary ==="
          go tool cover -func=coverage.out | tail -1

      # 上传覆盖率到 codecov（可选）
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # 集成测试
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test

    services:
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh 'mongodb://admin:password@localhost:27017' --eval 'db.stats().ok'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download Go dependencies
        run: go mod download

      - name: Run integration tests
        env:
          MONGODB_URI: mongodb://admin:password@localhost:27017/qingyu?authSource=admin
          REDIS_ADDR: localhost:6379
          REDIS_PASSWORD: ""
        run: |
          go test -v -race -count=1 \
            -tags=integration \
            -coverprofile=integration_coverage.out \
            -covermode=atomic \
            ./test/integration/...

      - name: Generate integration coverage report
        run: go tool cover -html=integration_coverage.out -o integration_coverage.html

      - name: Upload integration coverage to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: integration-coverage-report
          path: |
            integration_coverage.out
            integration_coverage.html

  # API 测试
  api-test:
    name: API Tests
    runs-on: ubuntu-latest
    needs: test

    services:
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh 'mongodb://admin:password@localhost:27017' --eval 'db.stats().ok'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download Go dependencies
        run: go mod download

      - name: Build application
        run: go build -o server cmd/server/main.go

      - name: Run application in background
        env:
          MONGODB_URI: mongodb://admin:password@localhost:27017/qingyu?authSource=admin
          REDIS_ADDR: localhost:6379
        run: |
          ./server &
          sleep 5

      - name: Run API tests
        env:
          MONGODB_URI: mongodb://admin:password@localhost:27017/qingyu?authSource=admin
          REDIS_ADDR: localhost:6379
        run: |
          go test -v -race -count=1 \
            ./test/api/...

      - name: Cleanup
        if: always()
        run: pkill -f server || true

  # E2E 测试
  e2e-test:
    name: E2E Tests
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 15

    services:
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh 'mongodb://admin:password@localhost:27017' --eval 'db.stats().ok'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download Go dependencies
        run: go mod download

      - name: Run E2E Layer 1 - Basic Flows
        env:
          MONGODB_URI: mongodb://admin:password@localhost:27017
          MONGODB_DATABASE: qingyu_test
          ENVIRONMENT: test
        run: |
          echo "=========================================="
          echo "E2E Layer 1: Basic Flow Tests (2-3 min)"
          echo "=========================================="
          go test -v -race -count=1 -tags=e2e -timeout 5m ./test/e2e/layer1_basic/...

      - name: Run E2E Layer 2 - Data Consistency
        env:
          MONGODB_URI: mongodb://admin:password@localhost:27017
          MONGODB_DATABASE: qingyu_test
          ENVIRONMENT: test
        run: |
          echo "=========================================="
          echo "E2E Layer 2: Data Consistency Tests (3-5 min)"
          echo "=========================================="
          go test -v -race -count=1 -tags=e2e -timeout 8m ./test/e2e/layer2_consistency/...

      - name: Run E2E Layer 3 - Boundary Scenarios
        env:
          MONGODB_URI: mongodb://admin:password@localhost:27017
          MONGODB_DATABASE: qingyu_test
          ENVIRONMENT: test
        run: |
          echo "=========================================="
          echo "E2E Layer 3: Boundary Scenario Tests (5-8 min)"
          echo "=========================================="
          go test -v -race -count=1 -tags=e2e -timeout 10m ./test/e2e/layer3_boundary/...

  # 代码质量检查
  lint:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          args: --timeout=5m

  # 安全扫描
  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: ./...

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # 性能基准测试
  benchmark:
    name: Benchmark Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    services:
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh 'mongodb://admin:password@localhost:27017' --eval 'db.stats().ok'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download Go dependencies
        run: go mod download

      - name: Run benchmark tests
        env:
          MONGODB_URI: mongodb://admin:password@localhost:27017
          REDIS_ADDR: localhost:6379
        run: |
          go test -bench=. -benchmem -count=5 \
            -run=^$ \
            ./... | tee benchmark.txt

      - name: Store benchmark result
        uses: benchmark-action/github-action-benchmark@v1
        with:
          tool: 'go'
          output-file-path: benchmark.txt
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          alert-threshold: '200%'
          comment-on-alert: true
          fail-on-alert: true
          alert-comment-cc-users: '@maintainers'

  # 生成测试报告摘要
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test, integration-test, api-test, e2e-test, lint, security]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate test summary
        run: |
          echo "# Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Unit Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.integration-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## API Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.api-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## E2E Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.e2e-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Code Quality" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY

      - name: Check test results
        if: |
          needs.test.result != 'success' ||
          needs.integration-test.result != 'success' ||
          needs.api-test.result != 'success' ||
          needs.e2e-test.result != 'success'
        run: |
          echo "One or more test jobs failed!"
          exit 1
