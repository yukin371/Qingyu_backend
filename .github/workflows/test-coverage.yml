name: Test Coverage Report

on:
  push:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests with Coverage
    runs-on: ubuntu-latest

    steps:
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Check out code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        go mod download

    - name: Run tests with coverage
      run: |
        TEST_PACKAGES=$(go list ./... | \
          grep -v '^Qingyu_backend/cmd/' | \
          grep -v '^Qingyu_backend/test/' | \
          grep -v '^Qingyu_backend/tests/' | \
          grep -v '^Qingyu_backend/.archive/')
        go test -v -short -coverprofile=coverage.out -covermode=atomic $TEST_PACKAGES

    - name: Generate coverage report
      run: |
        go tool cover -html=coverage.out -o coverage.html

    - name: Upload coverage to artifacts
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          coverage.out
          coverage.html

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage.out
        flags: unittests
        name: codecov-umbrella

    - name: Comment coverage on PR
      if: github.event_name == 'pull_request'
      uses: codacy/codacy-coverage-reporter-action@v1
      with:
        project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
        coverage-reports: coverage.out

    - name: Check coverage threshold
      run: |
        COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
        echo "Current coverage: $COVERAGE%"
        THRESHOLD=50
        if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
          echo "⚠️ Coverage $COVERAGE% is below threshold $THRESHOLD% (warning only)"
          exit 0
        fi
        echo "Coverage $COVERAGE% meets threshold $THRESHOLD%"

  coverage-detail:
    name: Detailed Coverage by Module
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Check out code
      uses: actions/checkout@v4

    - name: Generate coverage by module
      run: |
        echo "# Module Coverage Report" > coverage_report.md
        echo "" >> coverage_report.md
        echo "| Module | Coverage |" >> coverage_report.md
        echo "|--------|----------|" >> coverage_report.md

        for dir in ./service/... ./api/... ./pkg/... ./repository/...; do
          echo "Testing $dir..."
          if go test -short -coverprofile=temp_coverage.out -covermode=atomic "$dir" > /dev/null 2>&1; then
            COVERAGE=$(go tool cover -func=temp_coverage.out | grep total | awk '{print $3}' | sed 's/%//')
            MODULE=$(echo $dir | sed 's|./||')
            echo "| $MODULE | $COVERAGE% |" >> coverage_report.md
          fi
        done

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: module-coverage-report
        path: coverage_report.md

  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-latest

    steps:
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Check out code
      uses: actions/checkout@v4

    - name: Run benchmarks
      run: |
        BENCH_PACKAGES=$(go list ./... | \
          grep -E '^Qingyu_backend/(service|pkg|repository)/' | \
          grep -v '^Qingyu_backend/repository/mongodb/' | \
          grep -v '^Qingyu_backend/service/ai/' )
        go test -bench=. -benchmem -run=^$ $BENCH_PACKAGES > benchmark_results.txt

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: benchmark_results.txt

    - name: Store benchmark result
      uses: benchmark-action/github-action-benchmark@v1
      with:
        tool: 'go'
        output-file-path: benchmark_results.txt
        github-token: ${{ secrets.GITHUB_TOKEN }}
        auto-push: false
