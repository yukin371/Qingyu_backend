# 青羽项目开发工作流程指南

**快速参考** | **更新日期**: 2025-10-22

## 🚀 日常开发流程（最常用）

```bash
# 1. 从 dev 创建功能分支
git checkout dev
git pull origin dev
git checkout -b feature/your-feature-name

# 2. 开发功能
# ... 编写代码、本地测试 ...

# 3. 提交代码
git add .
git commit -m "feat: add your feature"

# 4. 推送到远程
git push origin feature/your-feature-name

# 5. 创建 PR 到 dev
gh pr create --base dev --title "feat: add your feature"
# 或在 GitHub 网页创建 PR

# 6. 等待 CI 通过 ✅
# 7. 合并到 dev
# 8. 删除功能分支
git branch -d feature/your-feature-name
```

## 📊 分支策略总览

| 分支 | 用途 | 基于 | 合并到 | CI 覆盖 |
|------|------|------|--------|--------|
| `main` | 生产环境 | - | - | ✅ Push + PR |
| `dev` | 开发环境（默认） | - | `main` | ✅ Push + PR |
| `feature/*` | 新功能 | `dev` | `dev` | ⚠️ 仅 PR 时 |
| `bugfix/*` | Bug 修复 | `dev` | `dev` | ⚠️ 仅 PR 时 |
| `hotfix/*` | 紧急修复 | `main` | `main`+`dev` | ⚠️ 仅 PR 时 |

## 💡 常见场景

### 场景 1：开发新功能
```bash
基于：dev
目标：dev
命名：feature/功能名

示例：feature/user-authentication
```

### 场景 2：修复 Bug
```bash
基于：dev
目标：dev
命名：bugfix/问题描述 或 fix/问题描述

示例：bugfix/login-timeout
```

### 场景 3：紧急修复生产问题
```bash
基于：main
目标：main + dev
命名：hotfix/问题描述

示例：hotfix/payment-critical-bug

流程：
1. 从 main 创建
2. 修复问题
3. 合并到 main（打标签）
4. 同时合并到 dev
```

### 场景 4：发布新版本
```bash
方式1（简单）：
dev → main (直接 PR)

方式2（标准）：
dev → release/v1.0.0 → main

流程：
1. 确保 dev 稳定
2. 创建 PR: dev → main
3. 审查和测试
4. 合并后打标签
5. 自动部署
```

## 📋 提交信息规范

```bash
格式：<type>: <description>

类型（type）：
  feat     - 新功能
  fix      - Bug 修复
  docs     - 文档更新
  style    - 代码格式（不影响功能）
  refactor - 重构
  perf     - 性能优化
  test     - 测试相关
  build    - 构建系统
  ci       - CI 配置
  chore    - 其他杂项

示例：
  feat: add user profile page
  fix: resolve login timeout issue
  docs: update API documentation
  ci: optimize test workflow
```

## 🎯 分支命名规范

```bash
功能分支：
  feature/user-login
  feature/document-upload
  feature/ai-integration

Bug 修复：
  bugfix/form-validation
  fix/api-error

热修复：
  hotfix/security-patch
  hotfix/data-loss

文档：
  docs/api-guide
  docs/deployment

实验性：
  experiment/new-ui
```

## ⚠️ 重要注意事项

### ❌ 不要做的事情

```bash
# 不要直接在 main 上开发
git checkout main
vim some_file.go  # ❌ 错误

# 不要 force push 到共享分支
git push -f origin dev  # ❌ 危险

# 不要从错误的分支创建
git checkout main
git checkout -b feature/xxx  # ❌ 应该从 dev

# 不要忘记更新本地 dev
git checkout -b feature/xxx  # ❌ 没有先 pull
```

### ✅ 应该做的事情

```bash
# 开发前总是更新 dev
git checkout dev
git pull origin dev

# 定期同步 dev 的更新到功能分支
git checkout feature/xxx
git merge dev  # 或 git rebase dev

# 提交前本地测试
go test ./...
golangci-lint run

# 有意义的提交信息
git commit -m "feat: add user authentication with JWT"
```

## 🔄 同步和更新

### 更新本地 dev
```bash
git checkout dev
git pull origin dev
```

### 更新功能分支（合并 dev 的最新改动）
```bash
git checkout feature/your-feature
git merge dev
# 或使用 rebase（保持线性历史）
git rebase dev
```

### 解决冲突
```bash
# 1. 拉取最新 dev
git checkout dev
git pull

# 2. 切回功能分支
git checkout feature/your-feature

# 3. 合并 dev
git merge dev

# 4. 如有冲突，解决后
git add .
git commit -m "merge: resolve conflicts with dev"
```

## 📊 CI/CD 流程

### CI 何时运行？

```
Push 到 main → ✅ 运行完整 CI
Push 到 dev → ✅ 运行完整 CI
Push 到 feature/* → ❌ 不运行

PR 到 main → ✅ 必须通过 CI 才能合并
PR 到 dev → ✅ 必须通过 CI 才能合并
```

### CI 检查内容

```
1. Linting（代码规范）
2. Security Scan（安全扫描）
3. Unit Tests（单元测试）
4. Integration Tests（集成测试）
5. API Tests（API 测试）
6. Dependency Check（依赖检查，仅主分支）
```

### 如果 CI 失败怎么办？

```bash
# 1. 查看 GitHub Actions 日志
# 2. 在本地复现问题
# 3. 修复问题
# 4. 提交并推送
git commit -am "fix: resolve CI issues"
git push

# CI 会自动重新运行
```

## 🎓 最佳实践

### 1. 小而频繁的提交
```bash
✅ 推荐：每个小功能一个提交
❌ 避免：一个巨大的提交包含多个功能
```

### 2. 有意义的 PR
```bash
✅ 推荐：每个 PR 解决一个问题
❌ 避免：一个 PR 混合多个不相关的改动
```

### 3. PR 描述清晰
```markdown
## 改动内容
- 添加了用户认证功能
- 实现了 JWT 令牌生成

## 测试
- ✅ 单元测试通过
- ✅ 手动测试登录流程

## 相关 Issue
Closes #123
```

### 4. 及时清理分支
```bash
# PR 合并后立即删除
git branch -d feature/old-feature
git push origin --delete feature/old-feature
```

## 🆘 常见问题

### Q: 我应该从哪个分支开始开发？
**A**: 99% 的情况从 `dev` 分支创建新分支。

### Q: feature 分支是否需要运行 CI？
**A**: Push 时不运行，创建 PR 时会运行。这样节省 CI 资源。

### Q: 如何发布到生产环境？
**A**: 创建 PR: `dev` → `main`，通过 CI 和审查后合并，然后打标签。

### Q: 紧急修复生产问题怎么办？
**A**: 从 `main` 创建 `hotfix/*` 分支，修复后合并回 `main` 和 `dev`。

### Q: 多人协作时如何避免冲突？
**A**: 
- 及时同步 dev 的更新
- 功能分支保持小而聚焦
- 频繁沟通协调

## 📚 相关文档

- [完整分支策略](.github/GIT_BRANCH_STRATEGY.md)
- [CI 优化文档](../CI_OPTIMIZATION_COMPLETE.md)
- [提交规范](https://www.conventionalcommits.org/)

---

**记住**: 
- 📍 默认分支：`dev`
- 🌱 新功能：从 `dev` 创建
- 🚀 发布：`dev` → `main`
- 🔥 紧急修复：从 `main` 创建

**最后更新**: 2025-10-22

